<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.2.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha256-XOqroi11tY4EFQMR9ZYwZWKj5ZXiftSx36RRuC3anlA=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"yoursite.com","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.20.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"always","padding":18,"offset":12},"copycode":{"enable":true,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="一、背景与挑战1.1 多品类价格差异在数字电商&#x2F;本地生活平台中，不同品类的定价逻辑差异极大：    品类 价格特点 定价维度 费用组成 典型示例    酒店 (Hotel) 时间维度定价，每日价格独立 日期 × 房型 × 早餐 房价 + DP Fee + Hub Fee 曼谷万豪豪华房   电影票 (Movie) 场次 × 座位 × 票种定价 场次 × 座位区 × 票种 票价 + D">
<meta property="og:type" content="article">
<meta property="og:title" content="多品类统一价格管理与计价系统设计：电商·虚拟商品·本地生活">
<meta property="og:url" content="http://yoursite.com/2026/01/15/system-design/21-pricing/index.html">
<meta property="og:site_name" content="wxquare&#39;s Blogs">
<meta property="og:description" content="一、背景与挑战1.1 多品类价格差异在数字电商&#x2F;本地生活平台中，不同品类的定价逻辑差异极大：    品类 价格特点 定价维度 费用组成 典型示例    酒店 (Hotel) 时间维度定价，每日价格独立 日期 × 房型 × 早餐 房价 + DP Fee + Hub Fee 曼谷万豪豪华房   电影票 (Movie) 场次 × 座位 × 票种定价 场次 × 座位区 × 票种 票价 + D">
<meta property="og:locale">
<meta property="article:published_time" content="2026-01-14T16:00:00.000Z">
<meta property="article:modified_time" content="2026-02-12T15:26:31.638Z">
<meta property="article:author" content="wxquare">
<meta property="article:tag" content="系统设计">
<meta property="article:tag" content="高并发">
<meta property="article:tag" content="电商">
<meta property="article:tag" content="价格系统">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://yoursite.com/2026/01/15/system-design/21-pricing/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-Hans","comments":true,"permalink":"http://yoursite.com/2026/01/15/system-design/21-pricing/","path":"2026/01/15/system-design/21-pricing/","title":"多品类统一价格管理与计价系统设计：电商·虚拟商品·本地生活"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>多品类统一价格管理与计价系统设计：电商·虚拟商品·本地生活 | wxquare's Blogs</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">wxquare's Blogs</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li><li class="menu-item menu-item-friends"><a href="/friends" rel="section"><i class="fa fa-user fa-fw"></i>Friends</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%80%E3%80%81%E8%83%8C%E6%99%AF%E4%B8%8E%E6%8C%91%E6%88%98"><span class="nav-number">1.</span> <span class="nav-text">一、背景与挑战</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-1-%E5%A4%9A%E5%93%81%E7%B1%BB%E4%BB%B7%E6%A0%BC%E5%B7%AE%E5%BC%82"><span class="nav-number">1.1.</span> <span class="nav-text">1.1 多品类价格差异</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-%E6%A0%B8%E5%BF%83%E7%97%9B%E7%82%B9"><span class="nav-number">1.2.</span> <span class="nav-text">1.2 核心痛点</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-3-%E8%AE%BE%E8%AE%A1%E7%9B%AE%E6%A0%87"><span class="nav-number">1.3.</span> <span class="nav-text">1.3 设计目标</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%8C%E3%80%81%E6%95%B4%E4%BD%93%E6%9E%B6%E6%9E%84"><span class="nav-number">2.</span> <span class="nav-text">二、整体架构</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-%E5%9B%9B%E5%B1%82%E4%BB%B7%E6%A0%BC%E6%9E%B6%E6%9E%84"><span class="nav-number">2.1.</span> <span class="nav-text">2.1 四层价格架构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-%E5%88%86%E5%B1%82%E6%9C%8D%E5%8A%A1%E6%9E%B6%E6%9E%84"><span class="nav-number">2.2.</span> <span class="nav-text">2.2 分层服务架构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-3-%E4%BB%B7%E6%A0%BC%E7%BB%84%E4%BB%B6%E5%AE%9A%E4%B9%89"><span class="nav-number">2.3.</span> <span class="nav-text">2.3 价格组件定义</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%89%E3%80%81%E6%95%B0%E6%8D%AE%E6%A8%A1%E5%9E%8B"><span class="nav-number">3.</span> <span class="nav-text">三、数据模型</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-%E5%9F%BA%E7%A1%80%E4%BB%B7%E6%A0%BC%E8%A1%A8%EF%BC%88%E7%BB%A7%E6%89%BF%E5%95%86%E5%93%81%E6%A8%A1%E5%9E%8B%EF%BC%89"><span class="nav-number">3.1.</span> <span class="nav-text">3.1 基础价格表（继承商品模型）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-%E8%90%A5%E9%94%80%E6%B4%BB%E5%8A%A8%E8%A1%A8"><span class="nav-number">3.2.</span> <span class="nav-text">3.2 营销活动表</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-3-%E8%B4%B9%E7%94%A8%E9%85%8D%E7%BD%AE%E8%A1%A8"><span class="nav-number">3.3.</span> <span class="nav-text">3.3 费用配置表</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-4-%E4%BC%98%E6%83%A0%E5%88%B8%E8%A1%A8"><span class="nav-number">3.4.</span> <span class="nav-text">3.4 优惠券表</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-5-%E4%BB%B7%E6%A0%BC%E5%BF%AB%E7%85%A7%E8%A1%A8"><span class="nav-number">3.5.</span> <span class="nav-text">3.5 价格快照表</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-6-%E4%BB%B7%E6%A0%BC%E5%8F%98%E6%9B%B4%E6%97%A5%E5%BF%97"><span class="nav-number">3.6.</span> <span class="nav-text">3.6 价格变更日志</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9B%9B%E3%80%81%E4%BB%B7%E6%A0%BC%E8%AE%A1%E7%AE%97%E5%BC%95%E6%93%8E"><span class="nav-number">4.</span> <span class="nav-text">四、价格计算引擎</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#4-1-%E6%A0%B8%E5%BF%83%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84"><span class="nav-number">4.1.</span> <span class="nav-text">4.1 核心数据结构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-2-%E4%BB%B7%E6%A0%BC%E8%AE%A1%E7%AE%97%E6%A0%B8%E5%BF%83%E6%B5%81%E7%A8%8B"><span class="nav-number">4.2.</span> <span class="nav-text">4.2 价格计算核心流程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-3-%E5%B8%81%E7%A7%8D%E7%B2%BE%E5%BA%A6%E5%A4%84%E7%90%86"><span class="nav-number">4.3.</span> <span class="nav-text">4.3 币种精度处理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-4-%E8%90%A5%E9%94%80%E6%B4%BB%E5%8A%A8%E5%8C%B9%E9%85%8D%E5%99%A8"><span class="nav-number">4.4.</span> <span class="nav-text">4.4 营销活动匹配器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-5-%E8%B4%B9%E7%94%A8%E8%AE%A1%E7%AE%97%E5%99%A8"><span class="nav-number">4.5.</span> <span class="nav-text">4.5 费用计算器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-6-%E4%BB%B7%E6%A0%BC%E5%85%AC%E5%BC%8F%E7%94%9F%E6%88%90"><span class="nav-number">4.6.</span> <span class="nav-text">4.6 价格公式生成</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%94%E3%80%81%E6%A0%B8%E5%BF%83%E6%B5%81%E7%A8%8B%E8%AE%BE%E8%AE%A1"><span class="nav-number">5.</span> <span class="nav-text">五、核心流程设计</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#5-1-%E4%BB%B7%E6%A0%BC%E8%AE%A1%E7%AE%97%E5%85%A8%E6%B5%81%E7%A8%8B"><span class="nav-number">5.1.</span> <span class="nav-text">5.1 价格计算全流程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-2-%E4%BB%B7%E6%A0%BC%E4%B8%80%E8%87%B4%E6%80%A7%E4%BF%9D%E9%9A%9C"><span class="nav-number">5.2.</span> <span class="nav-text">5.2 价格一致性保障</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-3-%E8%90%A5%E9%94%80%E6%B4%BB%E5%8A%A8%E4%BC%98%E5%85%88%E7%BA%A7%E4%B8%8E%E4%BA%92%E6%96%A5"><span class="nav-number">5.3.</span> <span class="nav-text">5.3 营销活动优先级与互斥</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-4-Fee-%E5%8F%AF%E6%8A%98%E6%89%A3%E6%80%A7%E8%AE%BE%E8%AE%A1"><span class="nav-number">5.4.</span> <span class="nav-text">5.4 Fee 可折扣性设计</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%85%AD%E3%80%81%E9%85%8D%E9%A2%9D%E5%B9%B6%E5%8F%91%E5%AE%89%E5%85%A8"><span class="nav-number">6.</span> <span class="nav-text">六、配额并发安全</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#6-1-%E8%90%A5%E9%94%80%E6%B4%BB%E5%8A%A8%E9%85%8D%E9%A2%9D%E7%AE%A1%E7%90%86"><span class="nav-number">6.1.</span> <span class="nav-text">6.1 营销活动配额管理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-2-%E4%BC%98%E6%83%A0%E5%88%B8%E6%A0%B8%E9%94%80%E5%B9%B6%E5%8F%91%E5%AE%89%E5%85%A8"><span class="nav-number">6.2.</span> <span class="nav-text">6.2 优惠券核销并发安全</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-3-%E9%80%80%E6%AC%BE%E6%97%B6%E4%BC%98%E6%83%A0%E5%88%B8-%E9%85%8D%E9%A2%9D%E5%9B%9E%E9%80%80"><span class="nav-number">6.3.</span> <span class="nav-text">6.3 退款时优惠券&#x2F;配额回退</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%83%E3%80%81%E6%A0%B7%E4%BE%8B%E6%95%B0%E6%8D%AE%E4%B8%8E%E8%AE%A1%E7%AE%97%E5%9C%BA%E6%99%AF"><span class="nav-number">7.</span> <span class="nav-text">七、样例数据与计算场景</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#7-1-%E5%9C%BA%E6%99%AF%E4%B8%80%EF%BC%9A%E7%94%B5%E5%BD%B1%E7%A5%A8%E8%B4%AD%E4%B9%B0%EF%BC%88%E4%BF%83%E9%94%80-Fee-Voucher%EF%BC%89"><span class="nav-number">7.1.</span> <span class="nav-text">7.1 场景一：电影票购买（促销 + Fee + Voucher）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-2-%E5%9C%BA%E6%99%AF%E4%BA%8C%EF%BC%9A%E9%85%92%E5%BA%97%E9%A2%84%E8%AE%A2%EF%BC%88%E5%8A%A8%E6%80%81%E5%AE%9A%E4%BB%B7-%E6%BB%A1%E5%87%8F-%E9%98%B6%E6%A2%AF-Fee%EF%BC%89"><span class="nav-number">7.2.</span> <span class="nav-text">7.2 场景二：酒店预订（动态定价 + 满减 + 阶梯 Fee）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-3-%E5%9C%BA%E6%99%AF%E4%B8%89%EF%BC%9ATopUp-%E5%85%85%E5%80%BC%EF%BC%88%E9%98%B6%E6%A2%AF%E4%BC%98%E6%83%A0-%E5%B9%B3%E5%8F%B0%E8%A1%A5%E8%B4%B4%EF%BC%89"><span class="nav-number">7.3.</span> <span class="nav-text">7.3 场景三：TopUp 充值（阶梯优惠 + 平台补贴）</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%85%AB%E3%80%81%E9%99%8D%E7%BA%A7%E7%AD%96%E7%95%A5"><span class="nav-number">8.</span> <span class="nav-text">八、降级策略</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#8-1-%E5%A4%9A%E7%BA%A7%E9%99%8D%E7%BA%A7%E6%96%B9%E6%A1%88"><span class="nav-number">8.1.</span> <span class="nav-text">8.1 多级降级方案</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-2-%E9%99%8D%E7%BA%A7%E5%AE%9E%E7%8E%B0"><span class="nav-number">8.2.</span> <span class="nav-text">8.2 降级实现</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-3-%E9%99%8D%E7%BA%A7%E5%BC%80%E5%85%B3%E9%85%8D%E7%BD%AE"><span class="nav-number">8.3.</span> <span class="nav-text">8.3 降级开关配置</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B9%9D%E3%80%81%E7%BC%93%E5%AD%98%E7%AD%96%E7%95%A5"><span class="nav-number">9.</span> <span class="nav-text">九、缓存策略</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#9-1-%E5%A4%9A%E7%BA%A7%E7%BC%93%E5%AD%98%E6%9E%B6%E6%9E%84"><span class="nav-number">9.1.</span> <span class="nav-text">9.1 多级缓存架构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#9-2-%E7%BC%93%E5%AD%98-Key-%E8%AE%BE%E8%AE%A1"><span class="nav-number">9.2.</span> <span class="nav-text">9.2 缓存 Key 设计</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#9-3-%E7%BC%93%E5%AD%98%E6%9B%B4%E6%96%B0%E7%AD%96%E7%95%A5"><span class="nav-number">9.3.</span> <span class="nav-text">9.3 缓存更新策略</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8D%81%E3%80%81Kafka-%E4%BA%8B%E4%BB%B6%E8%AE%BE%E8%AE%A1"><span class="nav-number">10.</span> <span class="nav-text">十、Kafka 事件设计</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#10-1-%E4%BA%8B%E4%BB%B6%E7%B1%BB%E5%9E%8B"><span class="nav-number">10.1.</span> <span class="nav-text">10.1 事件类型</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#10-2-%E4%BA%8B%E4%BB%B6-Schema"><span class="nav-number">10.2.</span> <span class="nav-text">10.2 事件 Schema</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#10-3-%E5%B9%82%E7%AD%89%E6%B6%88%E8%B4%B9"><span class="nav-number">10.3.</span> <span class="nav-text">10.3 幂等消费</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8D%81%E4%B8%80%E3%80%81%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96"><span class="nav-number">11.</span> <span class="nav-text">十一、性能优化</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#11-1-%E5%B9%B6%E8%A1%8C%E8%AE%A1%E7%AE%97"><span class="nav-number">11.1.</span> <span class="nav-text">11.1 并行计算</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#11-2-%E6%89%B9%E9%87%8F%E4%BB%B7%E6%A0%BC%E8%AE%A1%E7%AE%97"><span class="nav-number">11.2.</span> <span class="nav-text">11.2 批量价格计算</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#11-3-%E6%80%A7%E8%83%BD%E6%8C%87%E6%A0%87"><span class="nav-number">11.3.</span> <span class="nav-text">11.3 性能指标</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8D%81%E4%BA%8C%E3%80%81%E7%9B%91%E6%8E%A7%E4%B8%8E%E5%91%8A%E8%AD%A6"><span class="nav-number">12.</span> <span class="nav-text">十二、监控与告警</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#12-1-%E6%A0%B8%E5%BF%83%E7%9B%91%E6%8E%A7%E6%8C%87%E6%A0%87"><span class="nav-number">12.1.</span> <span class="nav-text">12.1 核心监控指标</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#12-2-%E5%91%8A%E8%AD%A6%E8%A7%84%E5%88%99"><span class="nav-number">12.2.</span> <span class="nav-text">12.2 告警规则</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#12-3-%E4%BB%B7%E6%A0%BC%E5%AE%A1%E8%AE%A1"><span class="nav-number">12.3.</span> <span class="nav-text">12.3 价格审计</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8D%81%E4%B8%89%E3%80%81%E6%96%B0%E5%93%81%E7%B1%BB%E6%8E%A5%E5%85%A5%E6%8C%87%E5%8D%97"><span class="nav-number">13.</span> <span class="nav-text">十三、新品类接入指南</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8D%81%E5%9B%9B%E3%80%81%E4%B8%9A%E7%95%8C%E4%BB%B7%E6%A0%BC%E6%A8%A1%E5%9E%8B%E6%BC%94%E8%BF%9B%E4%B8%8E%E5%AF%B9%E6%AF%94"><span class="nav-number">14.</span> <span class="nav-text">十四、业界价格模型演进与对比</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#14-1-%E4%BB%B7%E6%A0%BC%E6%A8%A1%E5%9E%8B%E6%BC%94%E8%BF%9B%E5%8F%B2"><span class="nav-number">14.1.</span> <span class="nav-text">14.1 价格模型演进史</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#14-2-%E5%90%84%E9%98%B6%E6%AE%B5%E5%AF%B9%E6%AF%94"><span class="nav-number">14.2.</span> <span class="nav-text">14.2 各阶段对比</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#14-3-%E4%B8%BB%E6%B5%81%E7%94%B5%E5%95%86%E5%B9%B3%E5%8F%B0%E5%AF%B9%E6%AF%94"><span class="nav-number">14.3.</span> <span class="nav-text">14.3 主流电商平台对比</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%B7%98%E5%AE%9D-%E5%A4%A9%E7%8C%AB"><span class="nav-number">14.3.1.</span> <span class="nav-text">淘宝&#x2F;天猫</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BA%AC%E4%B8%9C"><span class="nav-number">14.3.2.</span> <span class="nav-text">京东</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Amazon"><span class="nav-number">14.3.3.</span> <span class="nav-text">Amazon</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Uber-%E5%8A%A8%E6%80%81%E5%AE%9A%E4%BB%B7"><span class="nav-number">14.3.4.</span> <span class="nav-text">Uber (动态定价)</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#14-4-%E6%88%91%E4%BB%AC%E7%9A%84%E5%AE%9A%E4%BD%8D%E4%B8%8E%E5%AF%B9%E6%AF%94"><span class="nav-number">14.4.</span> <span class="nav-text">14.4 我们的定位与对比</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8D%81%E4%BA%94%E3%80%81%E8%AE%BE%E8%AE%A1%E6%80%BB%E7%BB%93"><span class="nav-number">15.</span> <span class="nav-text">十五、设计总结</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#15-1-%E6%A0%B8%E5%BF%83%E8%AE%BE%E8%AE%A1%E5%86%B3%E7%AD%96"><span class="nav-number">15.1.</span> <span class="nav-text">15.1 核心设计决策</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#15-2-%E5%85%B3%E9%94%AE%E6%8A%80%E6%9C%AF%E6%A0%88"><span class="nav-number">15.2.</span> <span class="nav-text">15.2 关键技术栈</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#15-3-%E5%AE%9E%E6%96%BD%E8%B7%AF%E7%BA%BF"><span class="nav-number">15.3.</span> <span class="nav-text">15.3 实施路线</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#15-4-%E6%94%B9%E8%BF%9B%E8%B7%AF%E7%BA%BF%E5%9B%BE"><span class="nav-number">15.4.</span> <span class="nav-text">15.4 改进路线图</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#15-5-%E9%A3%8E%E9%99%A9%E4%B8%8E%E7%BC%93%E8%A7%A3"><span class="nav-number">15.5.</span> <span class="nav-text">15.5 风险与缓解</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="wxquare"
      src="/images/avatar.jpeg">
  <p class="site-author-name" itemprop="name">wxquare</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">38</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">3</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">18</span>
        <span class="site-state-item-name">tags</span>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/yourname" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;yourname" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="/xianguiwang0316@gmail.com" title="E-Mail → xianguiwang0316@gmail.com" rel="noopener me"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2026/01/15/system-design/21-pricing/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpeg">
      <meta itemprop="name" content="wxquare">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="wxquare's Blogs">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="多品类统一价格管理与计价系统设计：电商·虚拟商品·本地生活 | wxquare's Blogs">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          多品类统一价格管理与计价系统设计：电商·虚拟商品·本地生活
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2026-01-15 00:00:00" itemprop="dateCreated datePublished" datetime="2026-01-15T00:00:00+08:00">2026-01-15</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2026-02-12 23:26:31" itemprop="dateModified" datetime="2026-02-12T23:26:31+08:00">2026-02-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/" itemprop="url" rel="index"><span itemprop="name">系统设计</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><!-- toc -->

<h2 id="一、背景与挑战"><a href="#一、背景与挑战" class="headerlink" title="一、背景与挑战"></a>一、背景与挑战</h2><h3 id="1-1-多品类价格差异"><a href="#1-1-多品类价格差异" class="headerlink" title="1.1 多品类价格差异"></a>1.1 多品类价格差异</h3><p>在数字电商&#x2F;本地生活平台中，不同品类的定价逻辑差异极大：</p>
<table>
<thead>
<tr>
<th>品类</th>
<th>价格特点</th>
<th>定价维度</th>
<th>费用组成</th>
<th>典型示例</th>
</tr>
</thead>
<tbody><tr>
<td><strong>酒店 (Hotel)</strong></td>
<td>时间维度定价，每日价格独立</td>
<td>日期 × 房型 × 早餐</td>
<td>房价 + DP Fee + Hub Fee</td>
<td>曼谷万豪豪华房</td>
</tr>
<tr>
<td><strong>电影票 (Movie)</strong></td>
<td>场次 × 座位 × 票种定价</td>
<td>场次 × 座位区 × 票种</td>
<td>票价 + DP Fee + 选座费</td>
<td>阿凡达3 IMAX 成人票</td>
</tr>
<tr>
<td><strong>话费充值 (TopUp)</strong></td>
<td>面额定价，无 SKU 变体</td>
<td>运营商 × 面额</td>
<td>面额 + 手续费 - 补贴</td>
<td>AIS 100฿ 充值</td>
</tr>
<tr>
<td><strong>电子券 (E-voucher)</strong></td>
<td>面值 vs 售价差异</td>
<td>品牌 × 面值</td>
<td>面值 - 平台折扣 + DP Fee</td>
<td>星巴克 500฿ 电子券</td>
</tr>
<tr>
<td><strong>礼品卡 (Giftcard)</strong></td>
<td>面值定价 + 平台折扣</td>
<td>品牌 × 面值</td>
<td>面值 - 折扣 + DP Fee</td>
<td>Google Play 充值卡</td>
</tr>
<tr>
<td><strong>本地生活套餐</strong></td>
<td>组合定价，子项加总</td>
<td>套餐 × 子项 × 份数</td>
<td>套餐价 + 服务费</td>
<td>海底捞双人套餐</td>
</tr>
</tbody></table>
<h3 id="1-2-核心痛点"><a href="#1-2-核心痛点" class="headerlink" title="1.2 核心痛点"></a>1.2 核心痛点</h3><ol>
<li><strong>价格散落多表</strong>：基础价、营销价、费用、优惠券分散在不同模块，缺乏统一视图。</li>
<li><strong>计算逻辑分散</strong>：各品类各自实现价格计算，重复代码多，难以维护。</li>
<li><strong>营销活动隔离</strong>：促销规则硬编码在业务逻辑中，扩展性差。</li>
<li><strong>Fee 管理混乱</strong>：DP Fee、Hub Fee、Carrier Fee 等多种费用缺乏统一配置。</li>
<li><strong>优惠券叠加复杂</strong>：Voucher、Promo Code、积分抵扣等多种优惠方式叠加规则不清晰。</li>
<li><strong>审计困难</strong>：价格变更历史难以追溯，用户投诉时无法准确还原计算过程。</li>
<li><strong>精度与币种问题</strong>：多币种场景下精度不一致，浮点运算导致分摊误差。</li>
</ol>
<h3 id="1-3-设计目标"><a href="#1-3-设计目标" class="headerlink" title="1.3 设计目标"></a>1.3 设计目标</h3><table>
<thead>
<tr>
<th>目标</th>
<th>说明</th>
<th>优先级</th>
</tr>
</thead>
<tbody><tr>
<td><strong>统一价格中心</strong></td>
<td>所有价格计算通过统一的 Pricing Engine 进行</td>
<td>P0</td>
</tr>
<tr>
<td><strong>分层价格模型</strong></td>
<td>基础价 → 营销价 → 费用 → 优惠券 → 最终价，层次清晰</td>
<td>P0</td>
</tr>
<tr>
<td><strong>规则引擎化</strong></td>
<td>营销活动、费用规则可配置，支持动态调整</td>
<td>P0</td>
</tr>
<tr>
<td><strong>价格快照</strong></td>
<td>每笔订单保留完整价格计算明细，支持审计和追溯</td>
<td>P0</td>
</tr>
<tr>
<td><strong>高性能</strong></td>
<td>P99 &lt; 100ms，支持万级 QPS 并发价格计算</td>
<td>P1</td>
</tr>
<tr>
<td><strong>多级降级</strong></td>
<td>促销&#x2F;优惠券服务不可用时，仍能返回基础价格</td>
<td>P1</td>
</tr>
<tr>
<td><strong>可扩展</strong></td>
<td>新增营销活动类型、费用类型、优惠券类型无需改动核心架构</td>
<td>P1</td>
</tr>
</tbody></table>
<hr>
<h2 id="二、整体架构"><a href="#二、整体架构" class="headerlink" title="二、整体架构"></a>二、整体架构</h2><h3 id="2-1-四层价格架构"><a href="#2-1-四层价格架构" class="headerlink" title="2.1 四层价格架构"></a>2.1 四层价格架构</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────────────────────────────────┐</span><br><span class="line">│                     统一价格计算架构                                  │</span><br><span class="line">├─────────────────────────────────────────────────────────────────────┤</span><br><span class="line">│                                                                      │</span><br><span class="line">│  Layer 1: 基础价格层 (Base Price Layer)                              │</span><br><span class="line">│  ┌──────────────────────────────────────────────────┐               │</span><br><span class="line">│  │  • sku_tab.price             (SKU 基础价)         │               │</span><br><span class="line">│  │  • hotel_price_calendar_tab  (酒店价格日历)       │               │</span><br><span class="line">│  │  • dynamic_pricing_rule_tab  (动态定价规则)       │               │</span><br><span class="line">│  └──────────────────────────────────────────────────┘               │</span><br><span class="line">│                          ↓                                           │</span><br><span class="line">│  Layer 2: 营销价格层 (Promotion Price Layer)                         │</span><br><span class="line">│  ┌──────────────────────────────────────────────────┐               │</span><br><span class="line">│  │  • promotion_activity_tab    (营销活动主表)       │               │</span><br><span class="line">│  │  • promotion_rule_tab        (规则配置)           │               │</span><br><span class="line">│  │  • promotion_priority_tab    (优先级 &amp; 互斥)      │               │</span><br><span class="line">│  └──────────────────────────────────────────────────┘               │</span><br><span class="line">│                          ↓                                           │</span><br><span class="line">│  Layer 3: 费用层 (Fee Layer)                                         │</span><br><span class="line">│  ┌──────────────────────────────────────────────────┐               │</span><br><span class="line">│  │  • fee_config_tab            (费用配置表)         │               │</span><br><span class="line">│  │  • fee_type: dp_fee, hub_fee, service_fee, tax   │               │</span><br><span class="line">│  └──────────────────────────────────────────────────┘               │</span><br><span class="line">│                          ↓                                           │</span><br><span class="line">│  Layer 4: 优惠券层 (Voucher Layer)                                   │</span><br><span class="line">│  ┌──────────────────────────────────────────────────┐               │</span><br><span class="line">│  │  • voucher_tab               (优惠券主表)         │               │</span><br><span class="line">│  │  • user_voucher_tab          (用户持有)           │               │</span><br><span class="line">│  │  • voucher_usage_log         (使用记录)           │               │</span><br><span class="line">│  └──────────────────────────────────────────────────┘               │</span><br><span class="line">│                          ↓                                           │</span><br><span class="line">│  ═══════════════════════════════════════════════════                 │</span><br><span class="line">│  最终价格 = Base - Promotion + Fee - Voucher                         │</span><br><span class="line">│  ═══════════════════════════════════════════════════                 │</span><br><span class="line">│                                                                      │</span><br><span class="line">└─────────────────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure>

<h3 id="2-2-分层服务架构"><a href="#2-2-分层服务架构" class="headerlink" title="2.2 分层服务架构"></a>2.2 分层服务架构</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">┌──────────────────────────────────────────────────────────────────┐</span><br><span class="line">│                        API Gateway                                │</span><br><span class="line">├──────────────────────────────────────────────────────────────────┤</span><br><span class="line">│                                                                    │</span><br><span class="line">│  ┌──────────────────────────────────────────────────────────┐    │</span><br><span class="line">│  │                   Pricing Engine Service                   │    │</span><br><span class="line">│  │  ┌────────────┐ ┌─────────────┐ ┌──────────────────┐    │    │</span><br><span class="line">│  │  │ Price API   │ │ Snapshot API│ │  Audit API        │    │    │</span><br><span class="line">│  │  └────────────┘ └─────────────┘ └──────────────────┘    │    │</span><br><span class="line">│  │                                                            │    │</span><br><span class="line">│  │  ┌────────────────────────────────────────────────────┐  │    │</span><br><span class="line">│  │  │              Price Calculator Pipeline              │  │    │</span><br><span class="line">│  │  │  Base → Promotion → Fee → Voucher → Final          │  │    │</span><br><span class="line">│  │  └────────────────────────────────────────────────────┘  │    │</span><br><span class="line">│  └──────────────────────────────────────────────────────────┘    │</span><br><span class="line">│                                                                    │</span><br><span class="line">│  ┌────────────┐ ┌────────────┐ ┌────────────┐ ┌────────────┐  │</span><br><span class="line">│  │  Promotion  │ │    Fee     │ │  Voucher   │ │  Snapshot  │  │</span><br><span class="line">│  │  Service    │ │  Service   │ │  Service   │ │  Service   │  │</span><br><span class="line">│  └────────────┘ └────────────┘ └────────────┘ └────────────┘  │</span><br><span class="line">│                                                                    │</span><br><span class="line">│  ┌──────────────────────────────────────────────────────────┐    │</span><br><span class="line">│  │  Infrastructure: Redis | MySQL | Kafka | Prometheus       │    │</span><br><span class="line">│  └──────────────────────────────────────────────────────────┘    │</span><br><span class="line">└──────────────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure>

<h3 id="2-3-价格组件定义"><a href="#2-3-价格组件定义" class="headerlink" title="2.3 价格组件定义"></a>2.3 价格组件定义</h3><table>
<thead>
<tr>
<th>组件</th>
<th>说明</th>
<th>计算方式</th>
<th>示例</th>
</tr>
</thead>
<tbody><tr>
<td><strong>Base Price</strong></td>
<td>SKU 基础售价</td>
<td>固定 &#x2F; 时间动态</td>
<td>480฿（电影票）</td>
</tr>
<tr>
<td><strong>Promotion Discount</strong></td>
<td>营销活动折扣</td>
<td>百分比 &#x2F; 固定金额 &#x2F; 满减</td>
<td>-50฿（新用户立减）</td>
</tr>
<tr>
<td><strong>DP Fee</strong></td>
<td>DP 平台手续费</td>
<td>固定 &#x2F; 百分比</td>
<td>+10฿</td>
</tr>
<tr>
<td><strong>Hub Fee</strong></td>
<td>Hub 商户服务费</td>
<td>固定 &#x2F; 百分比 &#x2F; 阶梯</td>
<td>+5฿</td>
</tr>
<tr>
<td><strong>Service Fee</strong></td>
<td>附加服务费</td>
<td>固定</td>
<td>+20฿（选座费）</td>
</tr>
<tr>
<td><strong>Tax</strong></td>
<td>税费</td>
<td>百分比</td>
<td>+7%（VAT）</td>
</tr>
<tr>
<td><strong>Voucher Discount</strong></td>
<td>优惠券抵扣</td>
<td>固定 &#x2F; 百分比 &#x2F; 封顶</td>
<td>-30฿</td>
</tr>
<tr>
<td><strong>Final Price</strong></td>
<td>最终支付价格</td>
<td>Base - Promo + Fee - Voucher</td>
<td>435฿</td>
</tr>
</tbody></table>
<hr>
<h2 id="三、数据模型"><a href="#三、数据模型" class="headerlink" title="三、数据模型"></a>三、数据模型</h2><h3 id="3-1-基础价格表（继承商品模型）"><a href="#3-1-基础价格表（继承商品模型）" class="headerlink" title="3.1 基础价格表（继承商品模型）"></a>3.1 基础价格表（继承商品模型）</h3><p><strong>sku_tab</strong>（SKU 基础价格，已在商品模型中定义）：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 核心价格字段:</span></span><br><span class="line"><span class="comment">--   price          DECIMAL(20,2)  -- SKU 基础价格</span></span><br><span class="line"><span class="comment">--   original_price DECIMAL(20,2)  -- 原价（划线价）</span></span><br><span class="line"><span class="comment">--   cost_price     DECIMAL(20,2)  -- 成本价</span></span><br><span class="line"><span class="comment">--   currency       VARCHAR(3)     -- 币种 (THB, VND, IDR, MYR, SGD, PHP)</span></span><br></pre></td></tr></table></figure>

<p><strong>dynamic_pricing_rule_tab</strong>（动态定价规则）：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `dynamic_pricing_rule_tab` (</span><br><span class="line">    `id` <span class="type">BIGINT</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="string">&#x27;规则ID&#x27;</span>,</span><br><span class="line">    `rule_code` <span class="type">VARCHAR</span>(<span class="number">64</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;规则编码&#x27;</span>,</span><br><span class="line">    `rule_name` <span class="type">VARCHAR</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;规则名称&#x27;</span>,</span><br><span class="line">    `category_id` <span class="type">BIGINT</span> COMMENT <span class="string">&#x27;类目ID (NULL表示全品类)&#x27;</span>,</span><br><span class="line">    `rule_type` <span class="type">VARCHAR</span>(<span class="number">50</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;规则类型: demand_based, inventory_based, time_based, competitor_based&#x27;</span>,</span><br><span class="line">    `trigger_condition` JSON <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;触发条件: &#123;&quot;inventory_threshold&quot;: 10, &quot;time_window&quot;: &quot;18:00-22:00&quot;&#125;&#x27;</span>,</span><br><span class="line">    `adjustment_type` <span class="type">VARCHAR</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;调整类型: percentage, fixed_amount&#x27;</span>,</span><br><span class="line">    `adjustment_value` <span class="type">DECIMAL</span>(<span class="number">10</span>,<span class="number">2</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;调整值: 10表示加价10%或加价10元&#x27;</span>,</span><br><span class="line">    `min_price` <span class="type">DECIMAL</span>(<span class="number">20</span>,<span class="number">2</span>) COMMENT <span class="string">&#x27;最低价格限制（价格地板）&#x27;</span>,</span><br><span class="line">    `max_price` <span class="type">DECIMAL</span>(<span class="number">20</span>,<span class="number">2</span>) COMMENT <span class="string">&#x27;最高价格限制（价格天花板）&#x27;</span>,</span><br><span class="line">    `priority` <span class="type">INT</span> <span class="keyword">DEFAULT</span> <span class="number">0</span> COMMENT <span class="string">&#x27;优先级（数字越大越优先）&#x27;</span>,</span><br><span class="line">    `status` TINYINT <span class="keyword">DEFAULT</span> <span class="number">1</span> COMMENT <span class="string">&#x27;状态: 1=启用, 0=禁用&#x27;</span>,</span><br><span class="line">    `effective_start` DATETIME COMMENT <span class="string">&#x27;生效开始时间&#x27;</span>,</span><br><span class="line">    `effective_end` DATETIME COMMENT <span class="string">&#x27;生效结束时间&#x27;</span>,</span><br><span class="line">    `created_at` <span class="type">TIMESTAMP</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span>,</span><br><span class="line">    `updated_at` <span class="type">TIMESTAMP</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span> <span class="keyword">ON</span> <span class="keyword">UPDATE</span> <span class="built_in">CURRENT_TIMESTAMP</span>,</span><br><span class="line">    <span class="keyword">PRIMARY</span> KEY (`id`),</span><br><span class="line">    <span class="keyword">UNIQUE</span> KEY `uk_rule_code` (`rule_code`),</span><br><span class="line">    KEY `idx_category` (`category_id`),</span><br><span class="line">    KEY `idx_status_time` (`status`, `effective_start`, `effective_end`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4 COMMENT<span class="operator">=</span><span class="string">&#x27;动态定价规则表&#x27;</span>;</span><br></pre></td></tr></table></figure>

<h3 id="3-2-营销活动表"><a href="#3-2-营销活动表" class="headerlink" title="3.2 营销活动表"></a>3.2 营销活动表</h3><p><strong>promotion_activity_tab</strong>（营销活动主表）：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `promotion_activity_tab` (</span><br><span class="line">    `id` <span class="type">BIGINT</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="string">&#x27;活动ID&#x27;</span>,</span><br><span class="line">    `activity_code` <span class="type">VARCHAR</span>(<span class="number">64</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;活动编码&#x27;</span>,</span><br><span class="line">    `activity_name` <span class="type">VARCHAR</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;活动名称&#x27;</span>,</span><br><span class="line">    `activity_type` <span class="type">VARCHAR</span>(<span class="number">50</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;活动类型: discount, full_reduction, bundle, flash_sale, first_order, new_user&#x27;</span>,</span><br><span class="line">    `category_ids` JSON COMMENT <span class="string">&#x27;适用类目: [10001, 30001] (NULL表示全品类)&#x27;</span>,</span><br><span class="line">    `item_ids` JSON COMMENT <span class="string">&#x27;指定商品ID: [100001, 200001] (NULL表示不限)&#x27;</span>,</span><br><span class="line">    `sku_ids` JSON COMMENT <span class="string">&#x27;指定SKU ID: [1000001, 2000001]&#x27;</span>,</span><br><span class="line">    `user_type` <span class="type">VARCHAR</span>(<span class="number">50</span>) <span class="keyword">DEFAULT</span> <span class="string">&#x27;all&#x27;</span> COMMENT <span class="string">&#x27;用户类型: all, new, vip, specific&#x27;</span>,</span><br><span class="line">    `user_ids` JSON COMMENT <span class="string">&#x27;指定用户ID (user_type=specific时)&#x27;</span>,</span><br><span class="line">    `discount_type` <span class="type">VARCHAR</span>(<span class="number">50</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;折扣类型: percentage, fixed_amount, full_reduction, buy_n_get_m, tiered_discount&#x27;</span>,</span><br><span class="line">    `discount_value` JSON <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;折扣配置（见下方说明）&#x27;</span>,</span><br><span class="line">    `max_discount_amount` <span class="type">DECIMAL</span>(<span class="number">20</span>,<span class="number">2</span>) COMMENT <span class="string">&#x27;最大折扣金额上限&#x27;</span>,</span><br><span class="line">    `min_purchase_amount` <span class="type">DECIMAL</span>(<span class="number">20</span>,<span class="number">2</span>) COMMENT <span class="string">&#x27;最低购买金额&#x27;</span>,</span><br><span class="line">    `min_purchase_quantity` <span class="type">INT</span> COMMENT <span class="string">&#x27;最低购买数量&#x27;</span>,</span><br><span class="line">    `priority` <span class="type">INT</span> <span class="keyword">DEFAULT</span> <span class="number">0</span> COMMENT <span class="string">&#x27;优先级（数字越大越优先）&#x27;</span>,</span><br><span class="line">    `exclusivity` TINYINT <span class="keyword">DEFAULT</span> <span class="number">0</span> COMMENT <span class="string">&#x27;互斥性: 0=可叠加, 1=与其他活动互斥&#x27;</span>,</span><br><span class="line">    `voucher_compatible` TINYINT <span class="keyword">DEFAULT</span> <span class="number">1</span> COMMENT <span class="string">&#x27;优惠券兼容: 0=与优惠券互斥, 1=可叠加&#x27;</span>,</span><br><span class="line">    `status` TINYINT <span class="keyword">DEFAULT</span> <span class="number">1</span> COMMENT <span class="string">&#x27;状态: 1=启用, 0=禁用&#x27;</span>,</span><br><span class="line">    `start_time` DATETIME <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;开始时间&#x27;</span>,</span><br><span class="line">    `end_time` DATETIME <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;结束时间&#x27;</span>,</span><br><span class="line">    `daily_quota` <span class="type">INT</span> COMMENT <span class="string">&#x27;每日配额&#x27;</span>,</span><br><span class="line">    `total_quota` <span class="type">INT</span> COMMENT <span class="string">&#x27;总配额&#x27;</span>,</span><br><span class="line">    `used_quota` <span class="type">INT</span> <span class="keyword">DEFAULT</span> <span class="number">0</span> COMMENT <span class="string">&#x27;已使用配额&#x27;</span>,</span><br><span class="line">    `per_user_limit` <span class="type">INT</span> <span class="keyword">DEFAULT</span> <span class="number">0</span> COMMENT <span class="string">&#x27;每用户限享次数 (0=不限)&#x27;</span>,</span><br><span class="line">    `description` TEXT COMMENT <span class="string">&#x27;活动描述&#x27;</span>,</span><br><span class="line">    `created_by` <span class="type">BIGINT</span> COMMENT <span class="string">&#x27;创建人&#x27;</span>,</span><br><span class="line">    `created_at` <span class="type">TIMESTAMP</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span>,</span><br><span class="line">    `updated_at` <span class="type">TIMESTAMP</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span> <span class="keyword">ON</span> <span class="keyword">UPDATE</span> <span class="built_in">CURRENT_TIMESTAMP</span>,</span><br><span class="line">    <span class="keyword">PRIMARY</span> KEY (`id`),</span><br><span class="line">    <span class="keyword">UNIQUE</span> KEY `uk_activity_code` (`activity_code`),</span><br><span class="line">    KEY `idx_type_status` (`activity_type`, `status`),</span><br><span class="line">    KEY `idx_time` (`start_time`, `end_time`),</span><br><span class="line">    KEY `idx_priority` (`priority`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4 COMMENT<span class="operator">=</span><span class="string">&#x27;营销活动主表&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p><strong>discount_value</strong> JSON 配置说明：</p>
<table>
<thead>
<tr>
<th>折扣类型</th>
<th>JSON 配置示例</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>percentage</td>
<td><code>&#123;&quot;percentage&quot;: 20&#125;</code></td>
<td>打8折（减20%）</td>
</tr>
<tr>
<td>fixed_amount</td>
<td><code>&#123;&quot;amount&quot;: 50&#125;</code></td>
<td>立减50฿</td>
</tr>
<tr>
<td>full_reduction</td>
<td><code>&#123;&quot;threshold&quot;: 3000, &quot;discount&quot;: 200&#125;</code></td>
<td>满3000减200</td>
</tr>
<tr>
<td>buy_n_get_m</td>
<td><code>&#123;&quot;buy&quot;: 3, &quot;free&quot;: 1&#125;</code></td>
<td>买3送1</td>
</tr>
<tr>
<td>tiered_discount</td>
<td><code>&#123;&quot;tiers&quot;: [&#123;&quot;threshold&quot;: 500, &quot;percentage&quot;: 5&#125;, &#123;&quot;threshold&quot;: 200, &quot;percentage&quot;: 3&#125;]&#125;</code></td>
<td>阶梯折扣</td>
</tr>
</tbody></table>
<p><strong>promotion_usage_log_tab</strong>（活动使用记录）：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `promotion_usage_log_tab` (</span><br><span class="line">    `id` <span class="type">BIGINT</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="string">&#x27;记录ID&#x27;</span>,</span><br><span class="line">    `activity_id` <span class="type">BIGINT</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;活动ID&#x27;</span>,</span><br><span class="line">    `user_id` <span class="type">BIGINT</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;用户ID&#x27;</span>,</span><br><span class="line">    `order_id` <span class="type">BIGINT</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;订单ID&#x27;</span>,</span><br><span class="line">    `item_id` <span class="type">BIGINT</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;商品ID&#x27;</span>,</span><br><span class="line">    `sku_id` <span class="type">BIGINT</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;SKU ID&#x27;</span>,</span><br><span class="line">    `original_price` <span class="type">DECIMAL</span>(<span class="number">20</span>,<span class="number">2</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;原价&#x27;</span>,</span><br><span class="line">    `discount_amount` <span class="type">DECIMAL</span>(<span class="number">20</span>,<span class="number">2</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;折扣金额&#x27;</span>,</span><br><span class="line">    `final_price` <span class="type">DECIMAL</span>(<span class="number">20</span>,<span class="number">2</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;最终价格&#x27;</span>,</span><br><span class="line">    `created_at` <span class="type">TIMESTAMP</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span>,</span><br><span class="line">    <span class="keyword">PRIMARY</span> KEY (`id`),</span><br><span class="line">    KEY `idx_activity` (`activity_id`),</span><br><span class="line">    KEY `idx_user` (`user_id`),</span><br><span class="line">    KEY `idx_order` (`order_id`),</span><br><span class="line">    KEY `idx_created` (`created_at`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4 COMMENT<span class="operator">=</span><span class="string">&#x27;营销活动使用记录表&#x27;</span>;</span><br></pre></td></tr></table></figure>

<h3 id="3-3-费用配置表"><a href="#3-3-费用配置表" class="headerlink" title="3.3 费用配置表"></a>3.3 费用配置表</h3><p><strong>fee_config_tab</strong>（费用配置表）：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `fee_config_tab` (</span><br><span class="line">    `id` <span class="type">BIGINT</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="string">&#x27;费用配置ID&#x27;</span>,</span><br><span class="line">    `fee_code` <span class="type">VARCHAR</span>(<span class="number">64</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;费用编码&#x27;</span>,</span><br><span class="line">    `fee_name` <span class="type">VARCHAR</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;费用名称&#x27;</span>,</span><br><span class="line">    `fee_type` <span class="type">VARCHAR</span>(<span class="number">50</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;费用类型: dp_fee, hub_fee, service_fee, carrier_fee, seat_fee, tax&#x27;</span>,</span><br><span class="line">    `category_id` <span class="type">BIGINT</span> COMMENT <span class="string">&#x27;类目ID (NULL表示全品类)&#x27;</span>,</span><br><span class="line">    `item_id` <span class="type">BIGINT</span> COMMENT <span class="string">&#x27;商品ID (NULL表示不限)&#x27;</span>,</span><br><span class="line">    `sku_id` <span class="type">BIGINT</span> COMMENT <span class="string">&#x27;SKU ID (NULL表示不限)&#x27;</span>,</span><br><span class="line">    `entity_type` <span class="type">VARCHAR</span>(<span class="number">50</span>) COMMENT <span class="string">&#x27;关联实体类型: carrier, cinema, merchant&#x27;</span>,</span><br><span class="line">    `entity_id` <span class="type">BIGINT</span> COMMENT <span class="string">&#x27;关联实体ID&#x27;</span>,</span><br><span class="line">    `region` <span class="type">VARCHAR</span>(<span class="number">10</span>) COMMENT <span class="string">&#x27;国家/地区: TH, VN, ID, MY, SG, PH (NULL表示全地区)&#x27;</span>,</span><br><span class="line">    `calculation_type` <span class="type">VARCHAR</span>(<span class="number">50</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;计算方式: fixed, percentage, tiered&#x27;</span>,</span><br><span class="line">    `calculation_config` JSON <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;计算配置（见下方说明）&#x27;</span>,</span><br><span class="line">    `min_fee` <span class="type">DECIMAL</span>(<span class="number">20</span>,<span class="number">2</span>) COMMENT <span class="string">&#x27;最小费用&#x27;</span>,</span><br><span class="line">    `max_fee` <span class="type">DECIMAL</span>(<span class="number">20</span>,<span class="number">2</span>) COMMENT <span class="string">&#x27;最大费用&#x27;</span>,</span><br><span class="line">    `display_type` <span class="type">VARCHAR</span>(<span class="number">50</span>) <span class="keyword">DEFAULT</span> <span class="string">&#x27;separate&#x27;</span> COMMENT <span class="string">&#x27;展示方式: separate(单独展示), included(包含在总价)&#x27;</span>,</span><br><span class="line">    `can_be_discounted` TINYINT <span class="keyword">DEFAULT</span> <span class="number">0</span> COMMENT <span class="string">&#x27;是否可被优惠券抵扣: 0=否, 1=是&#x27;</span>,</span><br><span class="line">    `priority` <span class="type">INT</span> <span class="keyword">DEFAULT</span> <span class="number">0</span> COMMENT <span class="string">&#x27;计算优先级&#x27;</span>,</span><br><span class="line">    `status` TINYINT <span class="keyword">DEFAULT</span> <span class="number">1</span> COMMENT <span class="string">&#x27;状态: 1=启用, 0=禁用&#x27;</span>,</span><br><span class="line">    `effective_start` DATETIME COMMENT <span class="string">&#x27;生效开始时间&#x27;</span>,</span><br><span class="line">    `effective_end` DATETIME COMMENT <span class="string">&#x27;生效结束时间&#x27;</span>,</span><br><span class="line">    `created_at` <span class="type">TIMESTAMP</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span>,</span><br><span class="line">    `updated_at` <span class="type">TIMESTAMP</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span> <span class="keyword">ON</span> <span class="keyword">UPDATE</span> <span class="built_in">CURRENT_TIMESTAMP</span>,</span><br><span class="line">    <span class="keyword">PRIMARY</span> KEY (`id`),</span><br><span class="line">    <span class="keyword">UNIQUE</span> KEY `uk_fee_code` (`fee_code`),</span><br><span class="line">    KEY `idx_type_category` (`fee_type`, `category_id`),</span><br><span class="line">    KEY `idx_entity` (`entity_type`, `entity_id`),</span><br><span class="line">    KEY `idx_region` (`region`),</span><br><span class="line">    KEY `idx_status_time` (`status`, `effective_start`, `effective_end`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4 COMMENT<span class="operator">=</span><span class="string">&#x27;费用配置表&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p><strong>calculation_config</strong> JSON 配置说明：</p>
<table>
<thead>
<tr>
<th>计算方式</th>
<th>JSON 配置示例</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>fixed</td>
<td><code>&#123;&quot;amount&quot;: 10&#125;</code></td>
<td>固定10฿</td>
</tr>
<tr>
<td>percentage</td>
<td><code>&#123;&quot;percentage&quot;: 2.5&#125;</code></td>
<td>按基础价的2.5%</td>
</tr>
<tr>
<td>tiered</td>
<td><code>&#123;&quot;tiers&quot;: [&#123;&quot;threshold&quot;: 5000, &quot;fee&quot;: 150&#125;, &#123;&quot;threshold&quot;: 3000, &quot;fee&quot;: 100&#125;, &#123;&quot;threshold&quot;: 0, &quot;fee&quot;: 50&#125;]&#125;</code></td>
<td>金额阶梯</td>
</tr>
</tbody></table>
<h3 id="3-4-优惠券表"><a href="#3-4-优惠券表" class="headerlink" title="3.4 优惠券表"></a>3.4 优惠券表</h3><p><strong>voucher_tab</strong>（优惠券主表）：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `voucher_tab` (</span><br><span class="line">    `id` <span class="type">BIGINT</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="string">&#x27;优惠券ID&#x27;</span>,</span><br><span class="line">    `voucher_code` <span class="type">VARCHAR</span>(<span class="number">64</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;优惠券编码&#x27;</span>,</span><br><span class="line">    `voucher_name` <span class="type">VARCHAR</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;优惠券名称&#x27;</span>,</span><br><span class="line">    `voucher_type` <span class="type">VARCHAR</span>(<span class="number">50</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;券类型: discount, cashback, gift, shipping_free&#x27;</span>,</span><br><span class="line">    `discount_type` <span class="type">VARCHAR</span>(<span class="number">50</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;折扣类型: percentage, fixed_amount, full_reduction&#x27;</span>,</span><br><span class="line">    `discount_value` JSON <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;折扣配置&#x27;</span>,</span><br><span class="line">    `max_discount_amount` <span class="type">DECIMAL</span>(<span class="number">20</span>,<span class="number">2</span>) COMMENT <span class="string">&#x27;最大折扣金额&#x27;</span>,</span><br><span class="line">    `min_purchase_amount` <span class="type">DECIMAL</span>(<span class="number">20</span>,<span class="number">2</span>) COMMENT <span class="string">&#x27;最低消费金额&#x27;</span>,</span><br><span class="line">    `category_ids` JSON COMMENT <span class="string">&#x27;适用类目&#x27;</span>,</span><br><span class="line">    `item_ids` JSON COMMENT <span class="string">&#x27;适用商品&#x27;</span>,</span><br><span class="line">    `exclude_item_ids` JSON COMMENT <span class="string">&#x27;排除商品&#x27;</span>,</span><br><span class="line">    `stackable_with_promotion` TINYINT <span class="keyword">DEFAULT</span> <span class="number">0</span> COMMENT <span class="string">&#x27;是否与促销叠加: 0=互斥, 1=可叠加&#x27;</span>,</span><br><span class="line">    `stackable_with_voucher` TINYINT <span class="keyword">DEFAULT</span> <span class="number">0</span> COMMENT <span class="string">&#x27;是否与其他券叠加: 0=互斥, 1=可叠加&#x27;</span>,</span><br><span class="line">    `total_quantity` <span class="type">INT</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;发行总量&#x27;</span>,</span><br><span class="line">    `claimed_quantity` <span class="type">INT</span> <span class="keyword">DEFAULT</span> <span class="number">0</span> COMMENT <span class="string">&#x27;已领取数量&#x27;</span>,</span><br><span class="line">    `used_quantity` <span class="type">INT</span> <span class="keyword">DEFAULT</span> <span class="number">0</span> COMMENT <span class="string">&#x27;已使用数量&#x27;</span>,</span><br><span class="line">    `per_user_limit` <span class="type">INT</span> <span class="keyword">DEFAULT</span> <span class="number">1</span> COMMENT <span class="string">&#x27;每用户限领数量&#x27;</span>,</span><br><span class="line">    `valid_days` <span class="type">INT</span> COMMENT <span class="string">&#x27;领取后有效天数 (NULL表示固定有效期)&#x27;</span>,</span><br><span class="line">    `valid_start` DATETIME COMMENT <span class="string">&#x27;固定有效期开始&#x27;</span>,</span><br><span class="line">    `valid_end` DATETIME COMMENT <span class="string">&#x27;固定有效期结束&#x27;</span>,</span><br><span class="line">    `status` TINYINT <span class="keyword">DEFAULT</span> <span class="number">1</span> COMMENT <span class="string">&#x27;状态: 1=可用, 0=禁用&#x27;</span>,</span><br><span class="line">    `created_at` <span class="type">TIMESTAMP</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span>,</span><br><span class="line">    `updated_at` <span class="type">TIMESTAMP</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span> <span class="keyword">ON</span> <span class="keyword">UPDATE</span> <span class="built_in">CURRENT_TIMESTAMP</span>,</span><br><span class="line">    <span class="keyword">PRIMARY</span> KEY (`id`),</span><br><span class="line">    <span class="keyword">UNIQUE</span> KEY `uk_voucher_code` (`voucher_code`),</span><br><span class="line">    KEY `idx_type_status` (`voucher_type`, `status`),</span><br><span class="line">    KEY `idx_valid_time` (`valid_start`, `valid_end`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4 COMMENT<span class="operator">=</span><span class="string">&#x27;优惠券主表&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p><strong>user_voucher_tab</strong>（用户优惠券表）：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `user_voucher_tab` (</span><br><span class="line">    `id` <span class="type">BIGINT</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="string">&#x27;用户券ID&#x27;</span>,</span><br><span class="line">    `voucher_id` <span class="type">BIGINT</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;优惠券ID&#x27;</span>,</span><br><span class="line">    `user_id` <span class="type">BIGINT</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;用户ID&#x27;</span>,</span><br><span class="line">    `voucher_code` <span class="type">VARCHAR</span>(<span class="number">64</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;券码&#x27;</span>,</span><br><span class="line">    `status` TINYINT <span class="keyword">DEFAULT</span> <span class="number">1</span> COMMENT <span class="string">&#x27;状态: 1=未使用, 2=已使用, 3=已过期, 4=已退还&#x27;</span>,</span><br><span class="line">    `claimed_at` <span class="type">TIMESTAMP</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span> COMMENT <span class="string">&#x27;领取时间&#x27;</span>,</span><br><span class="line">    `valid_start` DATETIME <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;有效期开始&#x27;</span>,</span><br><span class="line">    `valid_end` DATETIME <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;有效期结束&#x27;</span>,</span><br><span class="line">    `used_at` <span class="type">TIMESTAMP</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;使用时间&#x27;</span>,</span><br><span class="line">    `order_id` <span class="type">BIGINT</span> COMMENT <span class="string">&#x27;关联订单ID&#x27;</span>,</span><br><span class="line">    <span class="keyword">PRIMARY</span> KEY (`id`),</span><br><span class="line">    <span class="keyword">UNIQUE</span> KEY `uk_user_voucher_code` (`user_id`, `voucher_code`),</span><br><span class="line">    KEY `idx_voucher` (`voucher_id`),</span><br><span class="line">    KEY `idx_user_status` (`user_id`, `status`),</span><br><span class="line">    KEY `idx_valid_time` (`valid_start`, `valid_end`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4 COMMENT<span class="operator">=</span><span class="string">&#x27;用户优惠券表&#x27;</span>;</span><br></pre></td></tr></table></figure>

<h3 id="3-5-价格快照表"><a href="#3-5-价格快照表" class="headerlink" title="3.5 价格快照表"></a>3.5 价格快照表</h3><p><strong>price_snapshot_tab</strong>（价格快照表）：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `price_snapshot_tab` (</span><br><span class="line">    `id` <span class="type">BIGINT</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="string">&#x27;快照ID&#x27;</span>,</span><br><span class="line">    `snapshot_code` <span class="type">VARCHAR</span>(<span class="number">64</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;快照编码&#x27;</span>,</span><br><span class="line">    `order_id` <span class="type">BIGINT</span> COMMENT <span class="string">&#x27;订单ID (下单后关联)&#x27;</span>,</span><br><span class="line">    `user_id` <span class="type">BIGINT</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;用户ID&#x27;</span>,</span><br><span class="line">    `item_id` <span class="type">BIGINT</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;商品ID&#x27;</span>,</span><br><span class="line">    `sku_id` <span class="type">BIGINT</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;SKU ID&#x27;</span>,</span><br><span class="line">    `quantity` <span class="type">INT</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="number">1</span> COMMENT <span class="string">&#x27;购买数量&#x27;</span>,</span><br><span class="line">    `currency` <span class="type">VARCHAR</span>(<span class="number">3</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;币种&#x27;</span>,</span><br><span class="line">    </span><br><span class="line">    <span class="comment">-- 基础价格</span></span><br><span class="line">    `base_price` <span class="type">DECIMAL</span>(<span class="number">20</span>,<span class="number">2</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;基础价格（单价）&#x27;</span>,</span><br><span class="line">    `original_price` <span class="type">DECIMAL</span>(<span class="number">20</span>,<span class="number">2</span>) COMMENT <span class="string">&#x27;原价（划线价）&#x27;</span>,</span><br><span class="line">    `subtotal` <span class="type">DECIMAL</span>(<span class="number">20</span>,<span class="number">2</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;小计 (base_price * quantity)&#x27;</span>,</span><br><span class="line">    </span><br><span class="line">    <span class="comment">-- 营销折扣</span></span><br><span class="line">    `promotion_discount` <span class="type">DECIMAL</span>(<span class="number">20</span>,<span class="number">2</span>) <span class="keyword">DEFAULT</span> <span class="number">0</span> COMMENT <span class="string">&#x27;营销折扣总额&#x27;</span>,</span><br><span class="line">    `promotion_details` JSON COMMENT <span class="string">&#x27;促销明细: [&#123;&quot;activity_id&quot;: 123, &quot;name&quot;: &quot;...&quot;, &quot;discount&quot;: 50&#125;]&#x27;</span>,</span><br><span class="line">    </span><br><span class="line">    <span class="comment">-- 费用</span></span><br><span class="line">    `total_fee` <span class="type">DECIMAL</span>(<span class="number">20</span>,<span class="number">2</span>) <span class="keyword">DEFAULT</span> <span class="number">0</span> COMMENT <span class="string">&#x27;费用总额&#x27;</span>,</span><br><span class="line">    `fee_details` JSON COMMENT <span class="string">&#x27;费用明细: [&#123;&quot;fee_type&quot;: &quot;dp_fee&quot;, &quot;amount&quot;: 10&#125;]&#x27;</span>,</span><br><span class="line">    </span><br><span class="line">    <span class="comment">-- 优惠券</span></span><br><span class="line">    `voucher_discount` <span class="type">DECIMAL</span>(<span class="number">20</span>,<span class="number">2</span>) <span class="keyword">DEFAULT</span> <span class="number">0</span> COMMENT <span class="string">&#x27;优惠券抵扣&#x27;</span>,</span><br><span class="line">    `voucher_details` JSON COMMENT <span class="string">&#x27;优惠券明细: [&#123;&quot;voucher_id&quot;: 456, &quot;discount&quot;: 30&#125;]&#x27;</span>,</span><br><span class="line">    </span><br><span class="line">    <span class="comment">-- 最终价格</span></span><br><span class="line">    `final_price` <span class="type">DECIMAL</span>(<span class="number">20</span>,<span class="number">2</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;最终价格&#x27;</span>,</span><br><span class="line">    `price_formula` TEXT COMMENT <span class="string">&#x27;价格计算公式（人类可读）&#x27;</span>,</span><br><span class="line">    </span><br><span class="line">    <span class="comment">-- 计算上下文</span></span><br><span class="line">    `calculation_context` JSON COMMENT <span class="string">&#x27;计算上下文: &#123;&quot;engine_version&quot;: &quot;v1.0&quot;, &quot;region&quot;: &quot;TH&quot;&#125;&#x27;</span>,</span><br><span class="line">    `expired_at` DATETIME COMMENT <span class="string">&#x27;快照过期时间（加购场景30分钟有效）&#x27;</span>,</span><br><span class="line">    </span><br><span class="line">    `created_at` <span class="type">TIMESTAMP</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span>,</span><br><span class="line">    <span class="keyword">PRIMARY</span> KEY (`id`),</span><br><span class="line">    <span class="keyword">UNIQUE</span> KEY `uk_snapshot_code` (`snapshot_code`),</span><br><span class="line">    KEY `idx_order` (`order_id`),</span><br><span class="line">    KEY `idx_user_item` (`user_id`, `item_id`),</span><br><span class="line">    KEY `idx_expired` (`expired_at`),</span><br><span class="line">    KEY `idx_created` (`created_at`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4 COMMENT<span class="operator">=</span><span class="string">&#x27;价格快照表&#x27;</span>;</span><br></pre></td></tr></table></figure>

<h3 id="3-6-价格变更日志"><a href="#3-6-价格变更日志" class="headerlink" title="3.6 价格变更日志"></a>3.6 价格变更日志</h3><p><strong>price_change_log_tab</strong>：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `price_change_log_tab` (</span><br><span class="line">    `id` <span class="type">BIGINT</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">    `sku_id` <span class="type">BIGINT</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;SKU ID&#x27;</span>,</span><br><span class="line">    `change_type` <span class="type">VARCHAR</span>(<span class="number">50</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;变更类型: base_price, promotion, fee_config, dynamic_rule&#x27;</span>,</span><br><span class="line">    `old_value` JSON COMMENT <span class="string">&#x27;旧值&#x27;</span>,</span><br><span class="line">    `new_value` JSON <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;新值&#x27;</span>,</span><br><span class="line">    `change_reason` <span class="type">VARCHAR</span>(<span class="number">255</span>) COMMENT <span class="string">&#x27;变更原因&#x27;</span>,</span><br><span class="line">    `changed_by` <span class="type">BIGINT</span> COMMENT <span class="string">&#x27;变更人 (0=系统自动)&#x27;</span>,</span><br><span class="line">    `changed_at` <span class="type">TIMESTAMP</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span>,</span><br><span class="line">    <span class="keyword">PRIMARY</span> KEY (`id`),</span><br><span class="line">    KEY `idx_sku_time` (`sku_id`, `changed_at`),</span><br><span class="line">    KEY `idx_type` (`change_type`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4 COMMENT<span class="operator">=</span><span class="string">&#x27;价格变更日志&#x27;</span>;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="四、价格计算引擎"><a href="#四、价格计算引擎" class="headerlink" title="四、价格计算引擎"></a>四、价格计算引擎</h2><h3 id="4-1-核心数据结构"><a href="#4-1-核心数据结构" class="headerlink" title="4.1 核心数据结构"></a>4.1 核心数据结构</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// PricingEngine 价格计算引擎</span></span><br><span class="line"><span class="keyword">type</span> PricingEngine <span class="keyword">struct</span> &#123;</span><br><span class="line">    basePriceCalculator BasePriceCalculator</span><br><span class="line">    promotionMatcher    PromotionMatcher</span><br><span class="line">    feeCalculator       FeeCalculator</span><br><span class="line">    voucherApplier      VoucherApplier</span><br><span class="line">    snapshotGenerator   SnapshotGenerator</span><br><span class="line">    priceCache          cache.Cache</span><br><span class="line">    degradeConfig       *DegradeConfig <span class="comment">// 降级配置</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// PriceRequest 价格计算请求</span></span><br><span class="line"><span class="keyword">type</span> PriceRequest <span class="keyword">struct</span> &#123;</span><br><span class="line">    UserID       <span class="type">int64</span>                  <span class="string">`json:&quot;user_id&quot;`</span></span><br><span class="line">    ItemID       <span class="type">int64</span>                  <span class="string">`json:&quot;item_id&quot;`</span></span><br><span class="line">    SKUID        <span class="type">int64</span>                  <span class="string">`json:&quot;sku_id&quot;`</span></span><br><span class="line">    Quantity     <span class="type">int</span>                    <span class="string">`json:&quot;quantity&quot;`</span></span><br><span class="line">    CategoryID   <span class="type">int64</span>                  <span class="string">`json:&quot;category_id&quot;`</span></span><br><span class="line">    Region       <span class="type">string</span>                 <span class="string">`json:&quot;region&quot;`</span>       <span class="comment">// 国家/地区: TH, VN, ID...</span></span><br><span class="line">    Currency     <span class="type">string</span>                 <span class="string">`json:&quot;currency&quot;`</span>     <span class="comment">// 币种: THB, VND, IDR...</span></span><br><span class="line">    VoucherCodes []<span class="type">string</span>               <span class="string">`json:&quot;voucher_codes&quot;`</span></span><br><span class="line">    Context      <span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125; <span class="string">`json:&quot;context&quot;`</span>      <span class="comment">// 额外上下文（日期、场次等）</span></span><br><span class="line">    Scene        <span class="type">string</span>                 <span class="string">`json:&quot;scene&quot;`</span>        <span class="comment">// 场景: list, detail, cart, checkout</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// PriceResponse 价格计算响应</span></span><br><span class="line"><span class="keyword">type</span> PriceResponse <span class="keyword">struct</span> &#123;</span><br><span class="line">    <span class="comment">// 基础价格</span></span><br><span class="line">    BasePrice     decimal.Decimal <span class="string">`json:&quot;base_price&quot;`</span></span><br><span class="line">    OriginalPrice decimal.Decimal <span class="string">`json:&quot;original_price&quot;`</span></span><br><span class="line">    Subtotal      decimal.Decimal <span class="string">`json:&quot;subtotal&quot;`</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 营销折扣</span></span><br><span class="line">    PromotionDiscount decimal.Decimal   <span class="string">`json:&quot;promotion_discount&quot;`</span></span><br><span class="line">    PromotionDetails  []PromotionDetail <span class="string">`json:&quot;promotion_details&quot;`</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 费用</span></span><br><span class="line">    TotalFee   decimal.Decimal <span class="string">`json:&quot;total_fee&quot;`</span></span><br><span class="line">    FeeDetails []FeeDetail     <span class="string">`json:&quot;fee_details&quot;`</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 优惠券</span></span><br><span class="line">    VoucherDiscount decimal.Decimal   <span class="string">`json:&quot;voucher_discount&quot;`</span></span><br><span class="line">    VoucherDetails  []VoucherDetail   <span class="string">`json:&quot;voucher_details&quot;`</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 最终价格</span></span><br><span class="line">    FinalPrice   decimal.Decimal <span class="string">`json:&quot;final_price&quot;`</span></span><br><span class="line">    Currency     <span class="type">string</span>          <span class="string">`json:&quot;currency&quot;`</span></span><br><span class="line">    PriceFormula <span class="type">string</span>          <span class="string">`json:&quot;price_formula&quot;`</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 快照</span></span><br><span class="line">    SnapshotCode <span class="type">string</span> <span class="string">`json:&quot;snapshot_code&quot;`</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 降级标记</span></span><br><span class="line">    Degraded     <span class="type">bool</span>   <span class="string">`json:&quot;degraded&quot;`</span>      <span class="comment">// 是否降级</span></span><br><span class="line">    DegradeLevel <span class="type">string</span> <span class="string">`json:&quot;degrade_level&quot;`</span> <span class="comment">// 降级级别: none, promotion, voucher, fee</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// PromotionDetail 促销明细</span></span><br><span class="line"><span class="keyword">type</span> PromotionDetail <span class="keyword">struct</span> &#123;</span><br><span class="line">    ActivityID   <span class="type">int64</span>           <span class="string">`json:&quot;activity_id&quot;`</span></span><br><span class="line">    ActivityName <span class="type">string</span>          <span class="string">`json:&quot;activity_name&quot;`</span></span><br><span class="line">    ActivityType <span class="type">string</span>          <span class="string">`json:&quot;activity_type&quot;`</span></span><br><span class="line">    Discount     decimal.Decimal <span class="string">`json:&quot;discount&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// FeeDetail 费用明细</span></span><br><span class="line"><span class="keyword">type</span> FeeDetail <span class="keyword">struct</span> &#123;</span><br><span class="line">    FeeType     <span class="type">string</span>          <span class="string">`json:&quot;fee_type&quot;`</span></span><br><span class="line">    FeeName     <span class="type">string</span>          <span class="string">`json:&quot;fee_name&quot;`</span></span><br><span class="line">    Amount      decimal.Decimal <span class="string">`json:&quot;amount&quot;`</span></span><br><span class="line">    CanDiscount <span class="type">bool</span>            <span class="string">`json:&quot;can_discount&quot;`</span> <span class="comment">// 是否可被优惠券抵扣</span></span><br><span class="line">    DisplayType <span class="type">string</span>          <span class="string">`json:&quot;display_type&quot;`</span> <span class="comment">// separate / included</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// VoucherDetail 优惠券明细</span></span><br><span class="line"><span class="keyword">type</span> VoucherDetail <span class="keyword">struct</span> &#123;</span><br><span class="line">    VoucherID   <span class="type">int64</span>           <span class="string">`json:&quot;voucher_id&quot;`</span></span><br><span class="line">    VoucherCode <span class="type">string</span>          <span class="string">`json:&quot;voucher_code&quot;`</span></span><br><span class="line">    VoucherName <span class="type">string</span>          <span class="string">`json:&quot;voucher_name&quot;`</span></span><br><span class="line">    Discount    decimal.Decimal <span class="string">`json:&quot;discount&quot;`</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-2-价格计算核心流程"><a href="#4-2-价格计算核心流程" class="headerlink" title="4.2 价格计算核心流程"></a>4.2 价格计算核心流程</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Calculate 计算价格（核心入口）</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(e *PricingEngine)</span></span> Calculate(ctx context.Context, req *PriceRequest) (*PriceResponse, <span class="type">error</span>) &#123;</span><br><span class="line">    resp := &amp;PriceResponse&#123;Currency: req.Currency&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Step 1: 计算基础价格</span></span><br><span class="line">    basePrice, err := e.basePriceCalculator.Calculate(ctx, req)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>, errors.Wrap(err, <span class="string">&quot;calculate base price failed&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    resp.BasePrice = basePrice.Price</span><br><span class="line">    resp.OriginalPrice = basePrice.OriginalPrice</span><br><span class="line">    resp.Subtotal = basePrice.Price.Mul(decimal.NewFromInt(<span class="type">int64</span>(req.Quantity)))</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Step 2: 匹配并应用营销活动（支持降级）</span></span><br><span class="line">    promotions, err := e.matchPromotionsWithDegrade(ctx, req, basePrice.Price)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="comment">// 促销服务故障时降级，不影响核心流程</span></span><br><span class="line">        log.Warnf(<span class="string">&quot;promotion match degraded: %v&quot;</span>, err)</span><br><span class="line">        resp.Degraded = <span class="literal">true</span></span><br><span class="line">        resp.DegradeLevel = <span class="string">&quot;promotion&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    totalDiscount := decimal.Zero</span><br><span class="line">    <span class="keyword">for</span> _, promo := <span class="keyword">range</span> promotions &#123;</span><br><span class="line">        discount := e.calculatePromotionDiscount(promo, resp.Subtotal)</span><br><span class="line">        totalDiscount = totalDiscount.Add(discount)</span><br><span class="line">        resp.PromotionDetails = <span class="built_in">append</span>(resp.PromotionDetails, PromotionDetail&#123;</span><br><span class="line">            ActivityID:   promo.ActivityID,</span><br><span class="line">            ActivityName: promo.ActivityName,</span><br><span class="line">            ActivityType: promo.ActivityType,</span><br><span class="line">            Discount:     discount,</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    resp.PromotionDiscount = totalDiscount</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Step 3: 计算费用（支持降级）</span></span><br><span class="line">    fees, err := e.calculateFeesWithDegrade(ctx, req, basePrice.Price)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        log.Warnf(<span class="string">&quot;fee calculation degraded: %v&quot;</span>, err)</span><br><span class="line">        resp.Degraded = <span class="literal">true</span></span><br><span class="line">        resp.DegradeLevel = <span class="string">&quot;fee&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    totalFee := decimal.Zero</span><br><span class="line">    <span class="keyword">for</span> _, fee := <span class="keyword">range</span> fees &#123;</span><br><span class="line">        totalFee = totalFee.Add(fee.Amount)</span><br><span class="line">        resp.FeeDetails = <span class="built_in">append</span>(resp.FeeDetails, FeeDetail&#123;</span><br><span class="line">            FeeType:     fee.FeeType,</span><br><span class="line">            FeeName:     fee.FeeName,</span><br><span class="line">            Amount:      fee.Amount,</span><br><span class="line">            CanDiscount: fee.CanDiscount,</span><br><span class="line">            DisplayType: fee.DisplayType,</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    resp.TotalFee = totalFee</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Step 4: 应用优惠券（支持降级）</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(req.VoucherCodes) &gt; <span class="number">0</span> &#123;</span><br><span class="line">        voucherResult, err := e.applyVouchersWithDegrade(ctx, req, resp)</span><br><span class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">            log.Warnf(<span class="string">&quot;voucher apply degraded: %v&quot;</span>, err)</span><br><span class="line">            resp.Degraded = <span class="literal">true</span></span><br><span class="line">            resp.DegradeLevel = <span class="string">&quot;voucher&quot;</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            resp.VoucherDiscount = voucherResult.TotalDiscount</span><br><span class="line">            resp.VoucherDetails = voucherResult.Details</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Step 5: 计算最终价格</span></span><br><span class="line">    resp.FinalPrice = resp.Subtotal.</span><br><span class="line">        Sub(resp.PromotionDiscount).</span><br><span class="line">        Add(resp.TotalFee).</span><br><span class="line">        Sub(resp.VoucherDiscount)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 确保价格不为负</span></span><br><span class="line">    <span class="keyword">if</span> resp.FinalPrice.LessThan(decimal.Zero) &#123;</span><br><span class="line">        resp.FinalPrice = decimal.Zero</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Step 6: 币种精度对齐（不同币种小数位不同）</span></span><br><span class="line">    resp.FinalPrice = e.roundByCurrency(resp.FinalPrice, req.Currency)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Step 7: 生成价格公式（人类可读）</span></span><br><span class="line">    resp.PriceFormula = e.buildPriceFormula(resp)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Step 8: 生成价格快照（异步写入，不阻塞主流程）</span></span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">        snapshot, err := e.snapshotGenerator.Generate(context.Background(), req, resp)</span><br><span class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">            log.Errorf(<span class="string">&quot;generate snapshot failed: %v&quot;</span>, err)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            resp.SnapshotCode = snapshot.SnapshotCode</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> resp, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-3-币种精度处理"><a href="#4-3-币种精度处理" class="headerlink" title="4.3 币种精度处理"></a>4.3 币种精度处理</h3><p>不同东南亚国家的币种精度差异很大，这是必须处理的核心问题：</p>
<table>
<thead>
<tr>
<th>币种</th>
<th>代码</th>
<th>小数位</th>
<th>最小单位</th>
<th>示例</th>
</tr>
</thead>
<tbody><tr>
<td>泰铢</td>
<td>THB</td>
<td>2</td>
<td>0.01</td>
<td>480.50฿</td>
</tr>
<tr>
<td>越南盾</td>
<td>VND</td>
<td>0</td>
<td>1</td>
<td>120000₫</td>
</tr>
<tr>
<td>印尼盾</td>
<td>IDR</td>
<td>0</td>
<td>1</td>
<td>85000Rp</td>
</tr>
<tr>
<td>马来西亚林吉特</td>
<td>MYR</td>
<td>2</td>
<td>0.01</td>
<td>RM 25.90</td>
</tr>
<tr>
<td>新加坡元</td>
<td>SGD</td>
<td>2</td>
<td>0.01</td>
<td>S$12.50</td>
</tr>
<tr>
<td>菲律宾比索</td>
<td>PHP</td>
<td>2</td>
<td>0.01</td>
<td>₱350.00</td>
</tr>
</tbody></table>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// roundByCurrency 按币种精度四舍五入</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(e *PricingEngine)</span></span> roundByCurrency(amount decimal.Decimal, currency <span class="type">string</span>) decimal.Decimal &#123;</span><br><span class="line">    <span class="keyword">switch</span> currency &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&quot;VND&quot;</span>, <span class="string">&quot;IDR&quot;</span>:</span><br><span class="line">        <span class="comment">// 越南盾、印尼盾无小数位，向上取整到最小货币单位</span></span><br><span class="line">        <span class="keyword">return</span> amount.Ceil()</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&quot;THB&quot;</span>, <span class="string">&quot;MYR&quot;</span>, <span class="string">&quot;SGD&quot;</span>, <span class="string">&quot;PHP&quot;</span>:</span><br><span class="line">        <span class="comment">// 2位小数，Banker&#x27;s Rounding（银行家舍入）</span></span><br><span class="line">        <span class="keyword">return</span> amount.Round(<span class="number">2</span>)</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        <span class="keyword">return</span> amount.Round(<span class="number">2</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 多商品分摊时的精度处理（确保分摊总和 = 原始金额）</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">spreadDiscount</span><span class="params">(totalDiscount decimal.Decimal, items []OrderItem)</span></span> []decimal.Decimal &#123;</span><br><span class="line">    total := decimal.Zero</span><br><span class="line">    <span class="keyword">for</span> _, item := <span class="keyword">range</span> items &#123;</span><br><span class="line">        total = total.Add(item.Subtotal)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    results := <span class="built_in">make</span>([]decimal.Decimal, <span class="built_in">len</span>(items))</span><br><span class="line">    allocated := decimal.Zero</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i, item := <span class="keyword">range</span> items &#123;</span><br><span class="line">        <span class="keyword">if</span> i == <span class="built_in">len</span>(items)<span class="number">-1</span> &#123;</span><br><span class="line">            <span class="comment">// 最后一个商品承担所有剩余（消除分摊误差）</span></span><br><span class="line">            results[i] = totalDiscount.Sub(allocated)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 按比例分摊</span></span><br><span class="line">            ratio := item.Subtotal.Div(total)</span><br><span class="line">            results[i] = totalDiscount.Mul(ratio).Round(<span class="number">2</span>)</span><br><span class="line">            allocated = allocated.Add(results[i])</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> results</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-4-营销活动匹配器"><a href="#4-4-营销活动匹配器" class="headerlink" title="4.4 营销活动匹配器"></a>4.4 营销活动匹配器</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// PromotionMatcher 营销活动匹配器</span></span><br><span class="line"><span class="keyword">type</span> PromotionMatcher <span class="keyword">struct</span> &#123;</span><br><span class="line">    promotionRepo repository.PromotionRepository</span><br><span class="line">    userService   UserService   <span class="comment">// 查询用户类型（新用户/VIP等）</span></span><br><span class="line">    quotaService  QuotaService  <span class="comment">// 配额管理（Redis 原子操作）</span></span><br><span class="line">    cache         cache.Cache</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Match 匹配营销活动</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *PromotionMatcher)</span></span> Match(ctx context.Context, req *PromotionMatchRequest) ([]*MatchedPromotion, <span class="type">error</span>) &#123;</span><br><span class="line">    <span class="comment">// 1. 获取所有生效的营销活动（优先从缓存）</span></span><br><span class="line">    activities, err := m.loadActivePromotions(ctx, req.CategoryID)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2. 按优先级排序（数字越大越优先）</span></span><br><span class="line">    sort.Slice(activities, <span class="function"><span class="keyword">func</span><span class="params">(i, j <span class="type">int</span>)</span></span> <span class="type">bool</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> activities[i].Priority &gt; activities[j].Priority</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> matched []*MatchedPromotion</span><br><span class="line">    hasExclusive := <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> _, activity := <span class="keyword">range</span> activities &#123;</span><br><span class="line">        <span class="comment">// 3. 检查生效条件</span></span><br><span class="line">        <span class="keyword">if</span> !m.checkConditions(ctx, activity, req) &#123;</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4. 互斥规则判断</span></span><br><span class="line">        <span class="keyword">if</span> activity.Exclusivity == <span class="number">1</span> &amp;&amp; <span class="built_in">len</span>(matched) &gt; <span class="number">0</span> &#123;</span><br><span class="line">            <span class="keyword">continue</span> <span class="comment">// 当前活动互斥，且已有其他活动命中</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> hasExclusive &#123;</span><br><span class="line">            <span class="keyword">continue</span> <span class="comment">// 已有互斥活动命中，跳过后续所有活动</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 5. 检查优惠券兼容性</span></span><br><span class="line">        <span class="keyword">if</span> req.HasVoucher &amp;&amp; activity.VoucherCompatible == <span class="number">0</span> &#123;</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 6. 配额检查（Redis 原子操作）</span></span><br><span class="line">        <span class="keyword">if</span> activity.TotalQuota != <span class="literal">nil</span> &#123;</span><br><span class="line">            ok, err := m.quotaService.TryConsume(ctx, activity.ID, req.UserID)</span><br><span class="line">            <span class="keyword">if</span> err != <span class="literal">nil</span> || !ok &#123;</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        matched = <span class="built_in">append</span>(matched, &amp;MatchedPromotion&#123;</span><br><span class="line">            ActivityID:       activity.ID,</span><br><span class="line">            ActivityName:     activity.ActivityName,</span><br><span class="line">            ActivityType:     activity.ActivityType,</span><br><span class="line">            DiscountType:     activity.DiscountType,</span><br><span class="line">            DiscountValue:    activity.DiscountValue,</span><br><span class="line">            MaxDiscountAmount: activity.MaxDiscountAmount,</span><br><span class="line">        &#125;)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 7. 互斥活动命中后，停止遍历</span></span><br><span class="line">        <span class="keyword">if</span> activity.Exclusivity == <span class="number">1</span> &#123;</span><br><span class="line">            hasExclusive = <span class="literal">true</span></span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> matched, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// checkConditions 检查活动生效条件</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *PromotionMatcher)</span></span> checkConditions(ctx context.Context, activity *model.PromotionActivity, req *PromotionMatchRequest) <span class="type">bool</span> &#123;</span><br><span class="line">    now := time.Now()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 时间检查</span></span><br><span class="line">    <span class="keyword">if</span> now.Before(activity.StartTime) || now.After(activity.EndTime) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 类目检查</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(activity.CategoryIDs) &gt; <span class="number">0</span> &amp;&amp; !contains(activity.CategoryIDs, req.CategoryID) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 商品/SKU 检查</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(activity.ItemIDs) &gt; <span class="number">0</span> &amp;&amp; !contains(activity.ItemIDs, req.ItemID) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(activity.SKUIDs) &gt; <span class="number">0</span> &amp;&amp; !contains(activity.SKUIDs, req.SKUID) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 用户类型检查（调用 User Service）</span></span><br><span class="line">    <span class="keyword">if</span> activity.UserType != <span class="string">&quot;all&quot;</span> &#123;</span><br><span class="line">        userType, _ := m.userService.GetUserType(ctx, req.UserID)</span><br><span class="line">        <span class="keyword">if</span> userType != activity.UserType &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 最低金额检查</span></span><br><span class="line">    <span class="keyword">if</span> activity.MinPurchaseAmount != <span class="literal">nil</span> &#123;</span><br><span class="line">        subtotal := req.BasePrice.Mul(decimal.NewFromInt(<span class="type">int64</span>(req.Quantity)))</span><br><span class="line">        <span class="keyword">if</span> subtotal.LessThan(*activity.MinPurchaseAmount) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 最低数量检查</span></span><br><span class="line">    <span class="keyword">if</span> activity.MinPurchaseQuantity != <span class="literal">nil</span> &amp;&amp; req.Quantity &lt; *activity.MinPurchaseQuantity &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-5-费用计算器"><a href="#4-5-费用计算器" class="headerlink" title="4.5 费用计算器"></a>4.5 费用计算器</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// FeeCalculator 费用计算器</span></span><br><span class="line"><span class="keyword">type</span> FeeCalculator <span class="keyword">struct</span> &#123;</span><br><span class="line">    feeRepo repository.FeeRepository</span><br><span class="line">    cache   cache.Cache</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Calculate 计算费用</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *FeeCalculator)</span></span> Calculate(ctx context.Context, req *FeeCalcRequest) ([]*CalculatedFee, <span class="type">error</span>) &#123;</span><br><span class="line">    <span class="comment">// 1. 获取适用的费用配置（按 category → item → sku → entity 多维度匹配）</span></span><br><span class="line">    feeConfigs, err := c.loadApplicableFees(ctx, req)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2. 按优先级排序</span></span><br><span class="line">    sort.Slice(feeConfigs, <span class="function"><span class="keyword">func</span><span class="params">(i, j <span class="type">int</span>)</span></span> <span class="type">bool</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> feeConfigs[i].Priority &gt; feeConfigs[j].Priority</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> result []*CalculatedFee</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3. 逐项计算，同类型费用仅取最高优先级</span></span><br><span class="line">    feeTypeSeen := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="type">string</span>]<span class="type">bool</span>)</span><br><span class="line">    <span class="keyword">for</span> _, config := <span class="keyword">range</span> feeConfigs &#123;</span><br><span class="line">        <span class="keyword">if</span> feeTypeSeen[config.FeeType] &#123;</span><br><span class="line">            <span class="keyword">continue</span> <span class="comment">// 同类型费用只取优先级最高的一条</span></span><br><span class="line">        &#125;</span><br><span class="line">        feeTypeSeen[config.FeeType] = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">        amount, err := c.calculateFeeAmount(config, req)</span><br><span class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">            log.Errorf(<span class="string">&quot;calculate fee %s failed: %v&quot;</span>, config.FeeCode, err)</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        result = <span class="built_in">append</span>(result, &amp;CalculatedFee&#123;</span><br><span class="line">            FeeType:     config.FeeType,</span><br><span class="line">            FeeName:     config.FeeName,</span><br><span class="line">            Amount:      amount,</span><br><span class="line">            CanDiscount: config.CanBeDiscounted == <span class="number">1</span>,</span><br><span class="line">            DisplayType: config.DisplayType,</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// calculateFeeAmount 计算费用金额</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *FeeCalculator)</span></span> calculateFeeAmount(config *model.FeeConfig, req *FeeCalcRequest) (decimal.Decimal, <span class="type">error</span>) &#123;</span><br><span class="line">    baseAmount := req.BasePrice.Mul(decimal.NewFromInt(<span class="type">int64</span>(req.Quantity)))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> amount decimal.Decimal</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> config.CalculationType &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&quot;fixed&quot;</span>:</span><br><span class="line">        val := config.CalculationConfig[<span class="string">&quot;amount&quot;</span>].(<span class="type">float64</span>)</span><br><span class="line">        amount = decimal.NewFromFloat(val).Mul(decimal.NewFromInt(<span class="type">int64</span>(req.Quantity)))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> <span class="string">&quot;percentage&quot;</span>:</span><br><span class="line">        pct := config.CalculationConfig[<span class="string">&quot;percentage&quot;</span>].(<span class="type">float64</span>)</span><br><span class="line">        amount = baseAmount.Mul(decimal.NewFromFloat(pct / <span class="number">100</span>))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> <span class="string">&quot;tiered&quot;</span>:</span><br><span class="line">        tiers := config.CalculationConfig[<span class="string">&quot;tiers&quot;</span>].([]<span class="keyword">interface</span>&#123;&#125;)</span><br><span class="line">        <span class="keyword">for</span> _, tier := <span class="keyword">range</span> tiers &#123;</span><br><span class="line">            t := tier.(<span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;)</span><br><span class="line">            threshold := decimal.NewFromFloat(t[<span class="string">&quot;threshold&quot;</span>].(<span class="type">float64</span>))</span><br><span class="line">            <span class="keyword">if</span> baseAmount.GreaterThanOrEqual(threshold) &#123;</span><br><span class="line">                amount = decimal.NewFromFloat(t[<span class="string">&quot;fee&quot;</span>].(<span class="type">float64</span>))</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        <span class="keyword">return</span> decimal.Zero, fmt.Errorf(<span class="string">&quot;unsupported calculation type: %s&quot;</span>, config.CalculationType)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 应用最小/最大限制</span></span><br><span class="line">    <span class="keyword">if</span> config.MinFee != <span class="literal">nil</span> &amp;&amp; amount.LessThan(*config.MinFee) &#123;</span><br><span class="line">        amount = *config.MinFee</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> config.MaxFee != <span class="literal">nil</span> &amp;&amp; amount.GreaterThan(*config.MaxFee) &#123;</span><br><span class="line">        amount = *config.MaxFee</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> amount, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-6-价格公式生成"><a href="#4-6-价格公式生成" class="headerlink" title="4.6 价格公式生成"></a>4.6 价格公式生成</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// buildPriceFormula 构建人类可读的价格公式</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(e *PricingEngine)</span></span> buildPriceFormula(resp *PriceResponse) <span class="type">string</span> &#123;</span><br><span class="line">    formula := fmt.Sprintf(<span class="string">&quot;%.2f&quot;</span>, resp.Subtotal)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> resp.PromotionDiscount.GreaterThan(decimal.Zero) &#123;</span><br><span class="line">        formula += fmt.Sprintf(<span class="string">&quot; - %.2f (促销)&quot;</span>, resp.PromotionDiscount)</span><br><span class="line">        <span class="keyword">for</span> _, p := <span class="keyword">range</span> resp.PromotionDetails &#123;</span><br><span class="line">            formula += fmt.Sprintf(<span class="string">&quot; [%s: -%.2f]&quot;</span>, p.ActivityName, p.Discount)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> resp.TotalFee.GreaterThan(decimal.Zero) &#123;</span><br><span class="line">        formula += fmt.Sprintf(<span class="string">&quot; + %.2f (费用)&quot;</span>, resp.TotalFee)</span><br><span class="line">        <span class="keyword">for</span> _, f := <span class="keyword">range</span> resp.FeeDetails &#123;</span><br><span class="line">            formula += fmt.Sprintf(<span class="string">&quot; [%s: +%.2f]&quot;</span>, f.FeeName, f.Amount)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> resp.VoucherDiscount.GreaterThan(decimal.Zero) &#123;</span><br><span class="line">        formula += fmt.Sprintf(<span class="string">&quot; - %.2f (优惠券)&quot;</span>, resp.VoucherDiscount)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    formula += fmt.Sprintf(<span class="string">&quot; = %.2f %s&quot;</span>, resp.FinalPrice, resp.Currency)</span><br><span class="line">    <span class="keyword">return</span> formula</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="五、核心流程设计"><a href="#五、核心流程设计" class="headerlink" title="五、核心流程设计"></a>五、核心流程设计</h2><h3 id="5-1-价格计算全流程"><a href="#5-1-价格计算全流程" class="headerlink" title="5.1 价格计算全流程"></a>5.1 价格计算全流程</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">用户请求价格计算</span><br><span class="line">        │</span><br><span class="line">        ▼</span><br><span class="line">┌─────────────────────────────────┐</span><br><span class="line">│  1. 获取基础价格 (Base Price)    │</span><br><span class="line">│     - SKU 基础价                │</span><br><span class="line">│     - 时间维度价格（酒店/场次）  │</span><br><span class="line">│     - 动态定价调整              │</span><br><span class="line">└─────────────────────────────────┘</span><br><span class="line">        │</span><br><span class="line">        ▼</span><br><span class="line">┌─────────────────────────────────┐</span><br><span class="line">│  2. 匹配营销活动 (Promotion)     │</span><br><span class="line">│     - 按优先级遍历活动          │</span><br><span class="line">│     - 检查生效条件              │</span><br><span class="line">│     - 互斥/叠加规则判断         │</span><br><span class="line">│     - 配额原子扣减              │</span><br><span class="line">└─────────────────────────────────┘</span><br><span class="line">        │</span><br><span class="line">        ▼</span><br><span class="line">┌─────────────────────────────────┐</span><br><span class="line">│  3. 计算费用 (Fee)              │</span><br><span class="line">│     - DP Fee / Hub Fee          │</span><br><span class="line">│     - Service Fee / Tax         │</span><br><span class="line">│     - 同类型取最高优先级        │</span><br><span class="line">└─────────────────────────────────┘</span><br><span class="line">        │</span><br><span class="line">        ▼</span><br><span class="line">┌─────────────────────────────────┐</span><br><span class="line">│  4. 应用优惠券 (Voucher)         │</span><br><span class="line">│     - 检查持有 &amp; 有效期         │</span><br><span class="line">│     - 验证使用条件              │</span><br><span class="line">│     - 计算可抵扣金额            │</span><br><span class="line">│     - 与促销互斥规则            │</span><br><span class="line">└─────────────────────────────────┘</span><br><span class="line">        │</span><br><span class="line">        ▼</span><br><span class="line">┌─────────────────────────────────┐</span><br><span class="line">│  5. 最终价格 &amp; 精度处理          │</span><br><span class="line">│     - FinalPrice = Subtotal     │</span><br><span class="line">│       - Promotion + Fee         │</span><br><span class="line">│       - Voucher                 │</span><br><span class="line">│     - 币种精度对齐              │</span><br><span class="line">│     - 确保价格 &gt;= 0             │</span><br><span class="line">└─────────────────────────────────┘</span><br><span class="line">        │</span><br><span class="line">        ▼</span><br><span class="line">┌─────────────────────────────────┐</span><br><span class="line">│  6. 生成快照 (异步)             │</span><br><span class="line">│     - 记录完整计算明细          │</span><br><span class="line">│     - 关联订单（下单后）        │</span><br><span class="line">│     - 价格公式人类可读          │</span><br><span class="line">└─────────────────────────────────┘</span><br><span class="line">        │</span><br><span class="line">        ▼</span><br><span class="line">返回最终价格（含明细 &amp; 快照码）</span><br></pre></td></tr></table></figure>

<h3 id="5-2-价格一致性保障"><a href="#5-2-价格一致性保障" class="headerlink" title="5.2 价格一致性保障"></a>5.2 价格一致性保障</h3><p><strong>问题</strong>：用户在商品列表、详情页、购物车、订单确认页看到的价格不一致。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">┌──────────┐   ┌──────────┐   ┌──────────┐   ┌──────────┐</span><br><span class="line">│ 列表页    │   │ 详情页    │   │ 购物车    │   │ 下单页    │</span><br><span class="line">│ 实时计算  │   │ 实时计算  │   │ 生成快照  │   │ 验证快照  │</span><br><span class="line">│ (可缓存)  │   │ (实时)    │   │ (30min)   │   │ (锁定)    │</span><br><span class="line">└──────────┘   └──────────┘   └──────────┘   └──────────┘</span><br><span class="line">      │              │              │               │</span><br><span class="line">      └──────────────┴──────────────┴───────────────┘</span><br><span class="line">                           │</span><br><span class="line">                  统一 Pricing Engine API</span><br></pre></td></tr></table></figure>

<p><strong>方案</strong>：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 加入购物车 → 生成价格快照</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *CartService)</span></span> AddToCart(ctx context.Context, req *AddToCartRequest) <span class="type">error</span> &#123;</span><br><span class="line">    <span class="comment">// 1. 实时计算价格</span></span><br><span class="line">    priceResp, err := s.pricingEngine.Calculate(ctx, &amp;PriceRequest&#123;</span><br><span class="line">        UserID: req.UserID, SKUID: req.SKUID, Quantity: req.Quantity,</span><br><span class="line">        Scene: <span class="string">&quot;cart&quot;</span>,</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> err</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2. 生成价格快照（有效期30分钟）</span></span><br><span class="line">    snapshot := &amp;model.PriceSnapshot&#123;</span><br><span class="line">        SnapshotCode: generateSnapshotCode(),</span><br><span class="line">        UserID:       req.UserID,</span><br><span class="line">        SKUID:        req.SKUID,</span><br><span class="line">        FinalPrice:   priceResp.FinalPrice,</span><br><span class="line">        ExpiredAt:    time.Now().Add(<span class="number">30</span> * time.Minute),</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> err := s.snapshotRepo.Create(ctx, snapshot); err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> err</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3. 购物车关联快照</span></span><br><span class="line">    <span class="keyword">return</span> s.cartRepo.Add(ctx, &amp;model.CartItem&#123;</span><br><span class="line">        UserID: req.UserID, SKUID: req.SKUID,</span><br><span class="line">        SnapshotCode: snapshot.SnapshotCode,</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 下单 → 验证快照价格</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *OrderService)</span></span> CreateOrder(ctx context.Context, req *CreateOrderRequest) (*model.Order, <span class="type">error</span>) &#123;</span><br><span class="line">    <span class="comment">// 1. 获取快照</span></span><br><span class="line">    snapshot, err := s.snapshotRepo.GetByCode(ctx, req.SnapshotCode)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2. 检查快照是否过期</span></span><br><span class="line">    <span class="keyword">if</span> snapshot.ExpiredAt.Before(time.Now()) &#123;</span><br><span class="line">        <span class="comment">// 重新计算价格</span></span><br><span class="line">        newPrice, _ := s.pricingEngine.Calculate(ctx, &amp;PriceRequest&#123;</span><br><span class="line">            UserID: req.UserID, SKUID: req.SKUID, Scene: <span class="string">&quot;checkout&quot;</span>,</span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="comment">// 价格变动 → 要求用户重新确认</span></span><br><span class="line">        <span class="keyword">if</span> !newPrice.FinalPrice.Equal(snapshot.FinalPrice) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">nil</span>, &amp;PriceChangedError&#123;</span><br><span class="line">                OldPrice: snapshot.FinalPrice,</span><br><span class="line">                NewPrice: newPrice.FinalPrice,</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3. 使用快照价格创建订单</span></span><br><span class="line">    order := &amp;model.Order&#123;</span><br><span class="line">        FinalPrice:   snapshot.FinalPrice,</span><br><span class="line">        SnapshotCode: snapshot.SnapshotCode,</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> order, s.orderRepo.Create(ctx, order)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="5-3-营销活动优先级与互斥"><a href="#5-3-营销活动优先级与互斥" class="headerlink" title="5.3 营销活动优先级与互斥"></a>5.3 营销活动优先级与互斥</h3><p><strong>规则矩阵</strong>：</p>
<table>
<thead>
<tr>
<th>活动</th>
<th>Priority</th>
<th>Exclusivity</th>
<th>Voucher Compatible</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>秒杀特价</td>
<td>15</td>
<td>1（互斥）</td>
<td>0（与券互斥）</td>
<td>独占，与券互斥</td>
</tr>
<tr>
<td>新用户立减50฿</td>
<td>10</td>
<td>0（可叠加）</td>
<td>1（可与券叠加）</td>
<td>可叠加，可与券叠加</td>
</tr>
<tr>
<td>满3000减200</td>
<td>5</td>
<td>0（可叠加）</td>
<td>1（可与券叠加）</td>
<td>可叠加，可与券叠加</td>
</tr>
<tr>
<td>周末特惠</td>
<td>3</td>
<td>0（可叠加）</td>
<td>1（可与券叠加）</td>
<td>可叠加，可与券叠加</td>
</tr>
</tbody></table>
<p><strong>匹配流程</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">活动列表（按 Priority DESC 排序）</span><br><span class="line">        │</span><br><span class="line">        ▼</span><br><span class="line">    秒杀特价 (P=15, 互斥)</span><br><span class="line">    ├── 条件匹配 ✓ → 命中！exclusivity=1 → 停止遍历（独占）</span><br><span class="line">    │   结果: 仅秒杀生效</span><br><span class="line">    │</span><br><span class="line">    └── 条件不匹配 ✗ → 继续</span><br><span class="line">        │</span><br><span class="line">        ▼</span><br><span class="line">    新用户立减 (P=10, 可叠加)</span><br><span class="line">    ├── 条件匹配 ✓ → 加入匹配列表</span><br><span class="line">    │</span><br><span class="line">    └── 条件不匹配 ✗ → 继续</span><br><span class="line">        │</span><br><span class="line">        ▼</span><br><span class="line">    满3000减200 (P=5, 可叠加)</span><br><span class="line">    ├── 条件匹配 ✓ → 加入匹配列表</span><br><span class="line">    │</span><br><span class="line">    └── 条件不匹配 ✗ → 继续</span><br></pre></td></tr></table></figure>

<p><strong>计算示例</strong>：</p>
<ul>
<li><strong>场景A</strong>：新用户 + 满减 → 叠加生效（-50 + -200 &#x3D; -250）</li>
<li><strong>场景B</strong>：秒杀 + 新用户 → 仅秒杀生效（秒杀优先级高且独占）</li>
<li><strong>场景C</strong>：新用户 + 优惠券 → 叠加生效</li>
<li><strong>场景D</strong>：秒杀 + 优惠券 → 仅秒杀生效（秒杀与券互斥）</li>
</ul>
<h3 id="5-4-Fee-可折扣性设计"><a href="#5-4-Fee-可折扣性设计" class="headerlink" title="5.4 Fee 可折扣性设计"></a>5.4 Fee 可折扣性设计</h3><p><strong>问题</strong>：哪些费用可以被优惠券抵扣？</p>
<table>
<thead>
<tr>
<th>费用类型</th>
<th>can_be_discounted</th>
<th>原因</th>
</tr>
</thead>
<tbody><tr>
<td>DP Fee</td>
<td>0（不可抵扣）</td>
<td>平台收入，不参与优惠</td>
</tr>
<tr>
<td>Hub Fee</td>
<td>按协议配置</td>
<td>商户协议决定</td>
</tr>
<tr>
<td>Service Fee（选座费）</td>
<td>1（可抵扣）</td>
<td>增值服务，可参与优惠</td>
</tr>
<tr>
<td>Tax</td>
<td>0（不可抵扣）</td>
<td>税费不可被优惠</td>
</tr>
</tbody></table>
<p><strong>抵扣逻辑</strong>：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// calculateDiscountableAmount 计算优惠券可抵扣金额</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(a *VoucherApplier)</span></span> calculateDiscountableAmount(req *VoucherApplyRequest) decimal.Decimal &#123;</span><br><span class="line">    <span class="comment">// 基础金额 = 小计 - 促销折扣</span></span><br><span class="line">    discountableAmount := req.Subtotal.Sub(req.PromotionDiscount)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 加上可被抵扣的费用</span></span><br><span class="line">    <span class="keyword">for</span> _, fee := <span class="keyword">range</span> req.FeeDetails &#123;</span><br><span class="line">        <span class="keyword">if</span> fee.CanDiscount &#123;</span><br><span class="line">            discountableAmount = discountableAmount.Add(fee.Amount)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> discountableAmount</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>示例</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">商品小计:      1000฿</span><br><span class="line">促销折扣:      -100฿</span><br><span class="line">DP Fee:        +10฿  (不可抵扣)</span><br><span class="line">Hub Fee:       +20฿  (可抵扣)</span><br><span class="line">Service Fee:   +5฿   (可抵扣)</span><br><span class="line">──────────────────────────────</span><br><span class="line">优惠券可抵扣金额 = (1000 - 100) + 20 + 5 = 925฿</span><br><span class="line">优惠券面额 50฿ → 实际抵扣 50฿</span><br><span class="line">最终价格 = 1000 - 100 + 10 + 20 + 5 - 50 = 885฿</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="六、配额并发安全"><a href="#六、配额并发安全" class="headerlink" title="六、配额并发安全"></a>六、配额并发安全</h2><h3 id="6-1-营销活动配额管理"><a href="#6-1-营销活动配额管理" class="headerlink" title="6.1 营销活动配额管理"></a>6.1 营销活动配额管理</h3><p>秒杀&#x2F;限量活动场景下，配额扣减必须保证原子性。使用 Redis Lua 脚本实现：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- promotion_quota_consume.lua</span></span><br><span class="line"><span class="comment">-- 营销活动配额原子扣减</span></span><br><span class="line"><span class="comment">-- KEYS[1]: promotion:&#123;activity_id&#125;:quota</span></span><br><span class="line"><span class="comment">-- KEYS[2]: promotion:&#123;activity_id&#125;:user:&#123;user_id&#125;</span></span><br><span class="line"><span class="comment">-- ARGV[1]: total_quota (总配额)</span></span><br><span class="line"><span class="comment">-- ARGV[2]: per_user_limit (每用户限制, 0=不限)</span></span><br><span class="line"><span class="comment">-- ARGV[3]: activity_id</span></span><br><span class="line"><span class="comment">-- 返回: 1=成功, 0=配额不足, -1=用户已达上限</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> total_key = KEYS[<span class="number">1</span>]</span><br><span class="line"><span class="keyword">local</span> user_key = KEYS[<span class="number">2</span>]</span><br><span class="line"><span class="keyword">local</span> total_quota = <span class="built_in">tonumber</span>(ARGV[<span class="number">1</span>])</span><br><span class="line"><span class="keyword">local</span> per_user_limit = <span class="built_in">tonumber</span>(ARGV[<span class="number">2</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 1. 检查用户限制</span></span><br><span class="line"><span class="keyword">if</span> per_user_limit &gt; <span class="number">0</span> <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">local</span> user_count = <span class="built_in">tonumber</span>(redis.call(<span class="string">&#x27;GET&#x27;</span>, user_key) <span class="keyword">or</span> <span class="string">&#x27;0&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> user_count &gt;= per_user_limit <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>  <span class="comment">-- 用户已达上限</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 2. 原子扣减总配额</span></span><br><span class="line"><span class="keyword">local</span> used = <span class="built_in">tonumber</span>(redis.call(<span class="string">&#x27;GET&#x27;</span>, total_key) <span class="keyword">or</span> <span class="string">&#x27;0&#x27;</span>)</span><br><span class="line"><span class="keyword">if</span> used &gt;= total_quota <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>  <span class="comment">-- 配额不足</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">redis.call(<span class="string">&#x27;INCR&#x27;</span>, total_key)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 3. 增加用户使用次数</span></span><br><span class="line"><span class="keyword">if</span> per_user_limit &gt; <span class="number">0</span> <span class="keyword">then</span></span><br><span class="line">    redis.call(<span class="string">&#x27;INCR&#x27;</span>, user_key)</span><br><span class="line">    redis.call(<span class="string">&#x27;EXPIRE&#x27;</span>, user_key, <span class="number">86400</span> * <span class="number">30</span>)  <span class="comment">-- 30天过期</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="number">1</span>  <span class="comment">-- 成功</span></span><br></pre></td></tr></table></figure>

<h3 id="6-2-优惠券核销并发安全"><a href="#6-2-优惠券核销并发安全" class="headerlink" title="6.2 优惠券核销并发安全"></a>6.2 优惠券核销并发安全</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 优惠券核销：Redis + MySQL 双写</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(a *VoucherApplier)</span></span> consumeVoucher(ctx context.Context, userID <span class="type">int64</span>, voucherCode <span class="type">string</span>, orderID <span class="type">int64</span>) <span class="type">error</span> &#123;</span><br><span class="line">    lockKey := fmt.Sprintf(<span class="string">&quot;voucher:lock:%d:%s&quot;</span>, userID, voucherCode)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 1. Redis 分布式锁（防止并发核销）</span></span><br><span class="line">    acquired, err := a.redis.SetNX(ctx, lockKey, <span class="string">&quot;1&quot;</span>, <span class="number">10</span>*time.Second).Result()</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> || !acquired &#123;</span><br><span class="line">        <span class="keyword">return</span> errors.New(<span class="string">&quot;voucher is being used by another request&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">defer</span> a.redis.Del(ctx, lockKey)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2. 检查优惠券状态</span></span><br><span class="line">    userVoucher, err := a.userVoucherRepo.GetByUserAndCode(ctx, userID, voucherCode)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> err</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> userVoucher.Status != StatusUnused &#123;</span><br><span class="line">        <span class="keyword">return</span> errors.New(<span class="string">&quot;voucher already used or expired&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3. 更新状态（乐观锁）</span></span><br><span class="line">    affected, err := a.userVoucherRepo.UpdateStatus(ctx, userVoucher.ID, StatusUnused, StatusUsed, orderID)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> err</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> affected == <span class="number">0</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> errors.New(<span class="string">&quot;voucher status changed, retry&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 4. 更新优惠券使用数量</span></span><br><span class="line">    a.voucherRepo.IncrUsedQuantity(ctx, userVoucher.VoucherID)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="6-3-退款时优惠券-配额回退"><a href="#6-3-退款时优惠券-配额回退" class="headerlink" title="6.3 退款时优惠券&#x2F;配额回退"></a>6.3 退款时优惠券&#x2F;配额回退</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 订单取消/退款 → 回退优惠券和配额</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *RefundService)</span></span> rollbackPriceComponents(ctx context.Context, order *model.Order) <span class="type">error</span> &#123;</span><br><span class="line">    snapshot, err := s.snapshotRepo.GetByOrderID(ctx, order.ID)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> err</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 1. 回退优惠券</span></span><br><span class="line">    <span class="keyword">for</span> _, v := <span class="keyword">range</span> snapshot.VoucherDetails &#123;</span><br><span class="line">        <span class="keyword">if</span> err := s.voucherApplier.RollbackVoucher(ctx, order.UserID, v.VoucherCode); err != <span class="literal">nil</span> &#123;</span><br><span class="line">            log.Errorf(<span class="string">&quot;rollback voucher %s failed: %v&quot;</span>, v.VoucherCode, err)</span><br><span class="line">            <span class="comment">// 不中断，继续回退其他组件</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2. 回退营销活动配额</span></span><br><span class="line">    <span class="keyword">for</span> _, p := <span class="keyword">range</span> snapshot.PromotionDetails &#123;</span><br><span class="line">        <span class="keyword">if</span> err := s.quotaService.Rollback(ctx, p.ActivityID, order.UserID); err != <span class="literal">nil</span> &#123;</span><br><span class="line">            log.Errorf(<span class="string">&quot;rollback promotion %d quota failed: %v&quot;</span>, p.ActivityID, err)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3. 发送退款事件（Kafka）</span></span><br><span class="line">    s.eventPublisher.Publish(ctx, &amp;PriceRefundEvent&#123;</span><br><span class="line">        OrderID:    order.ID,</span><br><span class="line">        SnapshotCode: snapshot.SnapshotCode,</span><br><span class="line">        RefundAmount: snapshot.FinalPrice,</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="七、样例数据与计算场景"><a href="#七、样例数据与计算场景" class="headerlink" title="七、样例数据与计算场景"></a>七、样例数据与计算场景</h2><h3 id="7-1-场景一：电影票购买（促销-Fee-Voucher）"><a href="#7-1-场景一：电影票购买（促销-Fee-Voucher）" class="headerlink" title="7.1 场景一：电影票购买（促销 + Fee + Voucher）"></a>7.1 场景一：电影票购买（促销 + Fee + Voucher）</h3><p><strong>基础数据</strong>：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- SKU: 阿凡达3 IMAX 成人票</span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `sku_tab` (id, sku_code, item_id, sku_name, price, original_price, cost_price)</span><br><span class="line"><span class="keyword">VALUES</span> (<span class="number">2000001</span>, <span class="string">&#x27;SKU_MOVIE_AVATAR3_ADULT&#x27;</span>, <span class="number">200001</span>, <span class="string">&#x27;IMAX 3D 成人票&#x27;</span>, <span class="number">480.00</span>, <span class="number">550.00</span>, <span class="number">380.00</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 营销活动: 新用户立减50฿</span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `promotion_activity_tab` (id, activity_code, activity_name, activity_type, category_ids, user_type,</span><br><span class="line">    discount_type, discount_value, priority, exclusivity, voucher_compatible, status, start_time, end_time)</span><br><span class="line"><span class="keyword">VALUES</span> (<span class="number">1001</span>, <span class="string">&#x27;PROMO_NEW_USER_50&#x27;</span>, <span class="string">&#x27;新用户立减50฿&#x27;</span>, <span class="string">&#x27;new_user&#x27;</span>, <span class="string">&#x27;[30001]&#x27;</span>, <span class="string">&#x27;new&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;fixed_amount&#x27;</span>, <span class="string">&#x27;&#123;&quot;amount&quot;: 50&#125;&#x27;</span>, <span class="number">10</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="string">&#x27;2026-01-01&#x27;</span>, <span class="string">&#x27;2026-12-31&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 费用: DP Fee 10฿</span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `fee_config_tab` (id, fee_code, fee_name, fee_type, category_id, calculation_type, calculation_config, can_be_discounted)</span><br><span class="line"><span class="keyword">VALUES</span> (<span class="number">101</span>, <span class="string">&#x27;FEE_DP_MOVIE&#x27;</span>, <span class="string">&#x27;DP 平台服务费&#x27;</span>, <span class="string">&#x27;dp_fee&#x27;</span>, <span class="number">30001</span>, <span class="string">&#x27;fixed&#x27;</span>, <span class="string">&#x27;&#123;&quot;amount&quot;: 10&#125;&#x27;</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 费用: 选座费 5฿</span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `fee_config_tab` (id, fee_code, fee_name, fee_type, category_id, calculation_type, calculation_config, can_be_discounted)</span><br><span class="line"><span class="keyword">VALUES</span> (<span class="number">102</span>, <span class="string">&#x27;FEE_SEAT_SELECT&#x27;</span>, <span class="string">&#x27;选座服务费&#x27;</span>, <span class="string">&#x27;service_fee&#x27;</span>, <span class="number">30001</span>, <span class="string">&#x27;fixed&#x27;</span>, <span class="string">&#x27;&#123;&quot;amount&quot;: 5&#125;&#x27;</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 优惠券: 电影通用券30฿</span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `voucher_tab` (id, voucher_code, voucher_name, voucher_type, discount_type, discount_value, min_purchase_amount, category_ids)</span><br><span class="line"><span class="keyword">VALUES</span> (<span class="number">5001</span>, <span class="string">&#x27;VOUCHER_MOVIE_30&#x27;</span>, <span class="string">&#x27;电影通用券30฿&#x27;</span>, <span class="string">&#x27;discount&#x27;</span>, <span class="string">&#x27;fixed_amount&#x27;</span>, <span class="string">&#x27;&#123;&quot;amount&quot;: 30&#125;&#x27;</span>, <span class="number">10.00</span>, <span class="string">&#x27;[30001]&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p><strong>计算过程</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">请求: user_id=100001, sku_id=2000001, quantity=2, voucher=VOUCHER_MOVIE_30</span><br><span class="line"></span><br><span class="line">Step 1: 基础价格</span><br><span class="line">  单价: 480.00฿ × 2张 = 960.00฿</span><br><span class="line"></span><br><span class="line">Step 2: 营销活动</span><br><span class="line">  命中: 新用户立减50฿ (per unit)</span><br><span class="line">  折扣: 50.00 × 2 = 100.00฿</span><br><span class="line">  促销后: 860.00฿</span><br><span class="line"></span><br><span class="line">Step 3: 费用</span><br><span class="line">  DP Fee:  10.00 × 2 = 20.00฿  (不可抵扣)</span><br><span class="line">  选座费:   5.00 × 2 = 10.00฿  (不可抵扣)</span><br><span class="line">  费用合计: 30.00฿</span><br><span class="line">  加费后: 890.00฿</span><br><span class="line"></span><br><span class="line">Step 4: 优惠券</span><br><span class="line">  电影通用券: -30.00฿</span><br><span class="line">  券后: 860.00฿</span><br><span class="line"></span><br><span class="line">Step 5: 最终价格</span><br><span class="line">  公式: 960.00 - 100.00 (促销) + 30.00 (费用) - 30.00 (优惠券) = 860.00 THB</span><br></pre></td></tr></table></figure>

<h3 id="7-2-场景二：酒店预订（动态定价-满减-阶梯-Fee）"><a href="#7-2-场景二：酒店预订（动态定价-满减-阶梯-Fee）" class="headerlink" title="7.2 场景二：酒店预订（动态定价 + 满减 + 阶梯 Fee）"></a>7.2 场景二：酒店预订（动态定价 + 满减 + 阶梯 Fee）</h3><p><strong>基础数据</strong>：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 动态定价: 库存紧张加价15%</span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `dynamic_pricing_rule_tab` (id, rule_code, rule_name, category_id, rule_type,</span><br><span class="line">    trigger_condition, adjustment_type, adjustment_value, priority, status, effective_start, effective_end)</span><br><span class="line"><span class="keyword">VALUES</span> (<span class="number">201</span>, <span class="string">&#x27;RULE_HOTEL_INVENTORY&#x27;</span>, <span class="string">&#x27;库存紧张加价&#x27;</span>, <span class="number">10001</span>, <span class="string">&#x27;inventory_based&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;&#123;&quot;inventory_threshold&quot;: 5&#125;&#x27;</span>, <span class="string">&#x27;percentage&#x27;</span>, <span class="number">15.00</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="string">&#x27;2026-01-01&#x27;</span>, <span class="string">&#x27;2026-12-31&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 营销活动: 满3000减200</span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `promotion_activity_tab` (id, activity_code, activity_name, activity_type, category_ids,</span><br><span class="line">    discount_type, discount_value, priority, status, start_time, end_time)</span><br><span class="line"><span class="keyword">VALUES</span> (<span class="number">1002</span>, <span class="string">&#x27;PROMO_HOTEL_FULL_RED&#x27;</span>, <span class="string">&#x27;满3000减200&#x27;</span>, <span class="string">&#x27;full_reduction&#x27;</span>, <span class="string">&#x27;[10001]&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;full_reduction&#x27;</span>, <span class="string">&#x27;&#123;&quot;threshold&quot;: 3000, &quot;discount&quot;: 200&#125;&#x27;</span>, <span class="number">5</span>, <span class="number">1</span>, <span class="string">&#x27;2026-01-01&#x27;</span>, <span class="string">&#x27;2026-03-31&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 费用: 阶梯式 Hub Fee</span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `fee_config_tab` (id, fee_code, fee_name, fee_type, category_id, calculation_type, calculation_config, min_fee, max_fee)</span><br><span class="line"><span class="keyword">VALUES</span> (<span class="number">201</span>, <span class="string">&#x27;FEE_HUB_HOTEL_TIERED&#x27;</span>, <span class="string">&#x27;Hub 服务费（阶梯）&#x27;</span>, <span class="string">&#x27;hub_fee&#x27;</span>, <span class="number">10001</span>, <span class="string">&#x27;tiered&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;&#123;&quot;tiers&quot;: [&#123;&quot;threshold&quot;: 5000, &quot;fee&quot;: 150&#125;, &#123;&quot;threshold&quot;: 3000, &quot;fee&quot;: 100&#125;, &#123;&quot;threshold&quot;: 0, &quot;fee&quot;: 50&#125;]&#125;&#x27;</span>, <span class="number">50.00</span>, <span class="number">150.00</span>);</span><br></pre></td></tr></table></figure>

<p><strong>计算过程</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">请求: user_id=100002, sku_id=1000002(豪华房), quantity=1, context.nights=2, context.available_rooms=3</span><br><span class="line"></span><br><span class="line">Step 1: 基础价格</span><br><span class="line">  基础房价: 4200.00฿/晚 × 2晚 = 8400.00฿</span><br><span class="line">  动态定价: 库存=3间 &lt;= 阈值5间 → 加价15%</span><br><span class="line">  加价金额: 8400.00 × 15% = 1260.00฿</span><br><span class="line">  小计: 9660.00฿</span><br><span class="line"></span><br><span class="line">Step 2: 营销活动</span><br><span class="line">  命中: 满3000减200 (9660 &gt;= 3000 ✓)</span><br><span class="line">  折扣: 200.00฿</span><br><span class="line">  促销后: 9460.00฿</span><br><span class="line"></span><br><span class="line">Step 3: 费用</span><br><span class="line">  Hub Fee: 9460.00 &gt;= 5000 → 阶梯费 150.00฿</span><br><span class="line">  加费后: 9610.00฿</span><br><span class="line"></span><br><span class="line">Step 4: 优惠券</span><br><span class="line">  未使用</span><br><span class="line"></span><br><span class="line">Step 5: 最终价格</span><br><span class="line">  公式: 9660.00 - 200.00 (促销) + 150.00 (费用) = 9610.00 THB</span><br></pre></td></tr></table></figure>

<h3 id="7-3-场景三：TopUp-充值（阶梯优惠-平台补贴）"><a href="#7-3-场景三：TopUp-充值（阶梯优惠-平台补贴）" class="headerlink" title="7.3 场景三：TopUp 充值（阶梯优惠 + 平台补贴）"></a>7.3 场景三：TopUp 充值（阶梯优惠 + 平台补贴）</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">请求: user_id=100003, item=AIS 500฿充值, sku_id=3000001, quantity=1</span><br><span class="line"></span><br><span class="line">Step 1: 基础价格</span><br><span class="line">  面额: 500.00฿</span><br><span class="line"></span><br><span class="line">Step 2: 营销活动</span><br><span class="line">  命中: 充值阶梯优惠 (500 &gt;= 阈值500 → 5%折扣)</span><br><span class="line">  折扣: 500.00 × 5% = 25.00฿</span><br><span class="line">  封顶: min(25.00, 50.00) = 25.00฿</span><br><span class="line">  促销后: 475.00฿</span><br><span class="line"></span><br><span class="line">Step 3: 费用</span><br><span class="line">  无额外费用</span><br><span class="line"></span><br><span class="line">Step 4: 优惠券</span><br><span class="line">  未使用</span><br><span class="line"></span><br><span class="line">Step 5: 最终价格</span><br><span class="line">  公式: 500.00 - 25.00 (促销) = 475.00 THB</span><br><span class="line">  用户支付 475฿ 获得 500฿ 话费</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="八、降级策略"><a href="#八、降级策略" class="headerlink" title="八、降级策略"></a>八、降级策略</h2><h3 id="8-1-多级降级方案"><a href="#8-1-多级降级方案" class="headerlink" title="8.1 多级降级方案"></a>8.1 多级降级方案</h3><p>价格服务是核心链路，任何组件故障不能导致整个计算失败。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────────────────────────┐</span><br><span class="line">│                    降级策略分级                               │</span><br><span class="line">├──────────┬──────────────────┬───────────────────────────────┤</span><br><span class="line">│ 降级级别  │ 触发条件          │ 降级行为                      │</span><br><span class="line">├──────────┼──────────────────┼───────────────────────────────┤</span><br><span class="line">│ Level 0  │ 全部正常          │ 完整计算（Base+Promo+Fee+Voucher）│</span><br><span class="line">│ Level 1  │ 优惠券服务不可用   │ 跳过优惠券，提示用户稍后重试    │</span><br><span class="line">│ Level 2  │ 促销服务不可用     │ 仅 Base + Fee，无促销折扣      │</span><br><span class="line">│ Level 3  │ 费用服务不可用     │ 仅 Base，无额外费用            │</span><br><span class="line">│ Level 4  │ 缓存全部失效       │ 直接查询 MySQL 基础价格        │</span><br><span class="line">│ Level 5  │ MySQL 也不可用     │ 返回上一次缓存的价格快照       │</span><br><span class="line">└──────────┴──────────────────┴───────────────────────────────┘</span><br></pre></td></tr></table></figure>

<h3 id="8-2-降级实现"><a href="#8-2-降级实现" class="headerlink" title="8.2 降级实现"></a>8.2 降级实现</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// DegradeConfig 降级配置</span></span><br><span class="line"><span class="keyword">type</span> DegradeConfig <span class="keyword">struct</span> &#123;</span><br><span class="line">    PromotionTimeout   time.Duration <span class="string">`json:&quot;promotion_timeout&quot;`</span>   <span class="comment">// 促销匹配超时: 50ms</span></span><br><span class="line">    FeeTimeout         time.Duration <span class="string">`json:&quot;fee_timeout&quot;`</span>         <span class="comment">// 费用计算超时: 30ms</span></span><br><span class="line">    VoucherTimeout     time.Duration <span class="string">`json:&quot;voucher_timeout&quot;`</span>     <span class="comment">// 优惠券应用超时: 50ms</span></span><br><span class="line">    PromotionDegrade   <span class="type">bool</span>          <span class="string">`json:&quot;promotion_degrade&quot;`</span>   <span class="comment">// 促销服务强制降级开关</span></span><br><span class="line">    VoucherDegrade     <span class="type">bool</span>          <span class="string">`json:&quot;voucher_degrade&quot;`</span>     <span class="comment">// 优惠券服务强制降级开关</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// matchPromotionsWithDegrade 带降级的促销匹配</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(e *PricingEngine)</span></span> matchPromotionsWithDegrade(ctx context.Context, req *PriceRequest, basePrice decimal.Decimal) ([]*MatchedPromotion, <span class="type">error</span>) &#123;</span><br><span class="line">    <span class="comment">// 强制降级开关</span></span><br><span class="line">    <span class="keyword">if</span> e.degradeConfig.PromotionDegrade &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">nil</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 超时控制</span></span><br><span class="line">    ctx, cancel := context.WithTimeout(ctx, e.degradeConfig.PromotionTimeout)</span><br><span class="line">    <span class="keyword">defer</span> cancel()</span><br><span class="line"></span><br><span class="line">    promotions, err := e.promotionMatcher.Match(ctx, &amp;PromotionMatchRequest&#123;</span><br><span class="line">        UserID: req.UserID, ItemID: req.ItemID, SKUID: req.SKUID,</span><br><span class="line">        CategoryID: req.CategoryID, Quantity: req.Quantity, BasePrice: basePrice,</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="comment">// 促销匹配失败 → 降级，不影响核心流程</span></span><br><span class="line">        metrics.PromotionDegradeCounter.Inc()</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> promotions, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="8-3-降级开关配置"><a href="#8-3-降级开关配置" class="headerlink" title="8.3 降级开关配置"></a>8.3 降级开关配置</h3><p>通过配置中心（Apollo &#x2F; Nacos）动态控制降级开关，无需重启服务：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;pricing_degrade&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;promotion_degrade&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;voucher_degrade&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;fee_degrade&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;promotion_timeout_ms&quot;</span><span class="punctuation">:</span> <span class="number">50</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;fee_timeout_ms&quot;</span><span class="punctuation">:</span> <span class="number">30</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;voucher_timeout_ms&quot;</span><span class="punctuation">:</span> <span class="number">50</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="九、缓存策略"><a href="#九、缓存策略" class="headerlink" title="九、缓存策略"></a>九、缓存策略</h2><h3 id="9-1-多级缓存架构"><a href="#9-1-多级缓存架构" class="headerlink" title="9.1 多级缓存架构"></a>9.1 多级缓存架构</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">┌──────────────┐    ┌──────────────┐    ┌──────────────┐</span><br><span class="line">│  L1: 本地缓存  │───▶│  L2: Redis    │───▶│  L3: MySQL    │</span><br><span class="line">│  (sync.Map)   │    │  (Cluster)    │    │  (主从)       │</span><br><span class="line">│  TTL: 10s     │    │  TTL: 5min    │    │  持久存储      │</span><br><span class="line">│  大小: 10000   │    │  大小: 不限     │    │               │</span><br><span class="line">└──────────────┘    └──────────────┘    └──────────────┘</span><br></pre></td></tr></table></figure>

<h3 id="9-2-缓存-Key-设计"><a href="#9-2-缓存-Key-设计" class="headerlink" title="9.2 缓存 Key 设计"></a>9.2 缓存 Key 设计</h3><table>
<thead>
<tr>
<th>数据类型</th>
<th>Redis Key</th>
<th>TTL</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>SKU 基础价格</td>
<td><code>price:base:&#123;sku_id&#125;</code></td>
<td>5min</td>
<td>基础价格变化不频繁</td>
</tr>
<tr>
<td>品类活动列表</td>
<td><code>promo:active:cat:&#123;category_id&#125;</code></td>
<td>5min</td>
<td>缓存生效活动</td>
</tr>
<tr>
<td>费用配置</td>
<td><code>fee:config:cat:&#123;category_id&#125;</code></td>
<td>10min</td>
<td>费用配置变化少</td>
</tr>
<tr>
<td>优惠券信息</td>
<td><code>voucher:info:&#123;voucher_code&#125;</code></td>
<td>5min</td>
<td>券信息</td>
</tr>
<tr>
<td>活动配额</td>
<td><code>promo:quota:&#123;activity_id&#125;</code></td>
<td>无过期</td>
<td>配额计数器</td>
</tr>
<tr>
<td>价格计算结果</td>
<td><code>price:calc:&#123;sku_id&#125;:&#123;user_hash&#125;</code></td>
<td>60s</td>
<td>短缓存，防穿透</td>
</tr>
</tbody></table>
<h3 id="9-3-缓存更新策略"><a href="#9-3-缓存更新策略" class="headerlink" title="9.3 缓存更新策略"></a>9.3 缓存更新策略</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 价格变更时主动失效缓存（通过 Kafka 消息驱动）</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(h *PriceCacheInvalidHandler)</span></span> HandlePriceChange(ctx context.Context, event *PriceChangeEvent) <span class="type">error</span> &#123;</span><br><span class="line">    keys := []<span class="type">string</span>&#123;</span><br><span class="line">        fmt.Sprintf(<span class="string">&quot;price:base:%d&quot;</span>, event.SKUID),</span><br><span class="line">        fmt.Sprintf(<span class="string">&quot;price:calc:%d:*&quot;</span>, event.SKUID), <span class="comment">// 模式匹配删除</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> _, key := <span class="keyword">range</span> keys &#123;</span><br><span class="line">        <span class="keyword">if</span> strings.Contains(key, <span class="string">&quot;*&quot;</span>) &#123;</span><br><span class="line">            <span class="comment">// Scan + Delete 模式匹配</span></span><br><span class="line">            h.redis.ScanAndDelete(ctx, key)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            h.redis.Del(ctx, key)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 同时清除本地缓存</span></span><br><span class="line">    h.localCache.Delete(fmt.Sprintf(<span class="string">&quot;price:base:%d&quot;</span>, event.SKUID))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="十、Kafka-事件设计"><a href="#十、Kafka-事件设计" class="headerlink" title="十、Kafka 事件设计"></a>十、Kafka 事件设计</h2><h3 id="10-1-事件类型"><a href="#10-1-事件类型" class="headerlink" title="10.1 事件类型"></a>10.1 事件类型</h3><table>
<thead>
<tr>
<th>事件</th>
<th>Topic</th>
<th>生产者</th>
<th>消费者</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>价格变更</td>
<td><code>dp.pricing.price_changed</code></td>
<td>价格管理后台</td>
<td>Pricing Engine、搜索服务</td>
<td>SKU 基础价格变更</td>
</tr>
<tr>
<td>活动创建&#x2F;更新</td>
<td><code>dp.pricing.promotion_changed</code></td>
<td>营销管理后台</td>
<td>Pricing Engine</td>
<td>营销活动变更</td>
</tr>
<tr>
<td>费用配置变更</td>
<td><code>dp.pricing.fee_changed</code></td>
<td>费用管理后台</td>
<td>Pricing Engine</td>
<td>费用配置变更</td>
</tr>
<tr>
<td>价格快照生成</td>
<td><code>dp.pricing.snapshot_created</code></td>
<td>Pricing Engine</td>
<td>数据仓库</td>
<td>快照异步落库</td>
</tr>
<tr>
<td>优惠券核销</td>
<td><code>dp.pricing.voucher_consumed</code></td>
<td>Pricing Engine</td>
<td>优惠券服务</td>
<td>优惠券使用</td>
</tr>
<tr>
<td>退款回退</td>
<td><code>dp.pricing.refund_rollback</code></td>
<td>订单服务</td>
<td>Pricing Engine</td>
<td>退款时回退配额&#x2F;券</td>
</tr>
</tbody></table>
<h3 id="10-2-事件-Schema"><a href="#10-2-事件-Schema" class="headerlink" title="10.2 事件 Schema"></a>10.2 事件 Schema</h3><figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// PriceChangeEvent 价格变更事件</span></span><br><span class="line"><span class="keyword">message </span><span class="title class_">PriceChangeEvent</span> &#123;</span><br><span class="line">    <span class="type">int64</span>  sku_id       = <span class="number">1</span>;</span><br><span class="line">    <span class="type">string</span> change_type  = <span class="number">2</span>;  <span class="comment">// base_price, promotion, fee, dynamic_rule</span></span><br><span class="line">    <span class="type">string</span> old_value    = <span class="number">3</span>;  <span class="comment">// JSON</span></span><br><span class="line">    <span class="type">string</span> new_value    = <span class="number">4</span>;  <span class="comment">// JSON</span></span><br><span class="line">    <span class="type">string</span> reason       = <span class="number">5</span>;</span><br><span class="line">    <span class="type">int64</span>  operator_id  = <span class="number">6</span>;</span><br><span class="line">    <span class="type">int64</span>  timestamp_ms = <span class="number">7</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// SnapshotCreatedEvent 快照生成事件</span></span><br><span class="line"><span class="keyword">message </span><span class="title class_">SnapshotCreatedEvent</span> &#123;</span><br><span class="line">    <span class="type">string</span> snapshot_code     = <span class="number">1</span>;</span><br><span class="line">    <span class="type">int64</span>  user_id           = <span class="number">2</span>;</span><br><span class="line">    <span class="type">int64</span>  sku_id            = <span class="number">3</span>;</span><br><span class="line">    <span class="type">string</span> final_price       = <span class="number">4</span>;</span><br><span class="line">    <span class="type">string</span> price_formula     = <span class="number">5</span>;</span><br><span class="line">    <span class="type">string</span> promotion_details = <span class="number">6</span>;  <span class="comment">// JSON</span></span><br><span class="line">    <span class="type">string</span> fee_details       = <span class="number">7</span>;  <span class="comment">// JSON</span></span><br><span class="line">    <span class="type">string</span> voucher_details   = <span class="number">8</span>;  <span class="comment">// JSON</span></span><br><span class="line">    <span class="type">int64</span>  timestamp_ms      = <span class="number">9</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="10-3-幂等消费"><a href="#10-3-幂等消费" class="headerlink" title="10.3 幂等消费"></a>10.3 幂等消费</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 幂等处理：避免重复消费导致配额多次扣减</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(h *PromotionChangeHandler)</span></span> Handle(ctx context.Context, msg *kafka.Message) <span class="type">error</span> &#123;</span><br><span class="line">    eventID := <span class="type">string</span>(msg.Key)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Redis 幂等键（24小时过期）</span></span><br><span class="line">    idempotentKey := fmt.Sprintf(<span class="string">&quot;pricing:event:idempotent:%s&quot;</span>, eventID)</span><br><span class="line">    set, err := h.redis.SetNX(ctx, idempotentKey, <span class="string">&quot;1&quot;</span>, <span class="number">24</span>*time.Hour).Result()</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> || !set &#123;</span><br><span class="line">        log.Infof(<span class="string">&quot;duplicate event %s, skip&quot;</span>, eventID)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span> <span class="comment">// 重复消息，跳过</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 处理消息</span></span><br><span class="line">    event := &amp;PriceChangeEvent&#123;&#125;</span><br><span class="line">    <span class="keyword">if</span> err := proto.Unmarshal(msg.Value, event); err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> err</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 失效缓存</span></span><br><span class="line">    <span class="keyword">return</span> h.cacheInvalidator.Invalidate(ctx, event)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="十一、性能优化"><a href="#十一、性能优化" class="headerlink" title="十一、性能优化"></a>十一、性能优化</h2><h3 id="11-1-并行计算"><a href="#11-1-并行计算" class="headerlink" title="11.1 并行计算"></a>11.1 并行计算</h3><p>基础价格、促销匹配、费用计算三者互相独立，可并行执行：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(e *PricingEngine)</span></span> parallelCalculate(ctx context.Context, req *PriceRequest) (</span><br><span class="line">    *BasePriceResult, []*MatchedPromotion, []*CalculatedFee, <span class="type">error</span>) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> (</span><br><span class="line">        basePrice  *BasePriceResult</span><br><span class="line">        promotions []*MatchedPromotion</span><br><span class="line">        fees       []*CalculatedFee</span><br><span class="line">        baseErr, promoErr, feeErr <span class="type">error</span></span><br><span class="line">        wg sync.WaitGroup</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    wg.Add(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">defer</span> wg.Done()</span><br><span class="line">        basePrice, baseErr = e.basePriceCalculator.Calculate(ctx, req)</span><br><span class="line">    &#125;()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">defer</span> wg.Done()</span><br><span class="line">        promotions, promoErr = e.promotionMatcher.Match(ctx, &amp;PromotionMatchRequest&#123;...&#125;)</span><br><span class="line">    &#125;()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">defer</span> wg.Done()</span><br><span class="line">        fees, feeErr = e.feeCalculator.Calculate(ctx, &amp;FeeCalcRequest&#123;...&#125;)</span><br><span class="line">    &#125;()</span><br><span class="line"></span><br><span class="line">    wg.Wait()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 基础价格是必须的，其他可降级</span></span><br><span class="line">    <span class="keyword">if</span> baseErr != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">nil</span>, <span class="literal">nil</span>, baseErr</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> basePrice, promotions, fees, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="11-2-批量价格计算"><a href="#11-2-批量价格计算" class="headerlink" title="11.2 批量价格计算"></a>11.2 批量价格计算</h3><p>列表页需要同时计算多个商品的价格，使用批量接口减少 RPC 和 DB 调用：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// BatchCalculate 批量价格计算（列表页场景）</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(e *PricingEngine)</span></span> BatchCalculate(ctx context.Context, reqs []*PriceRequest) ([]*PriceResponse, <span class="type">error</span>) &#123;</span><br><span class="line">    <span class="comment">// 1. 批量获取 SKU 基础价格（一次 DB 查询）</span></span><br><span class="line">    skuIDs := extractSKUIDs(reqs)</span><br><span class="line">    basePrices, err := e.basePriceCalculator.BatchGet(ctx, skuIDs)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2. 批量获取品类活动（按 category 分组，减少缓存查询）</span></span><br><span class="line">    categoryIDs := extractCategoryIDs(reqs)</span><br><span class="line">    promotionsByCategory, err := e.promotionMatcher.BatchLoadActive(ctx, categoryIDs)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        log.Warnf(<span class="string">&quot;batch load promotions failed, degrade: %v&quot;</span>, err)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3. 并行计算每个商品的价格</span></span><br><span class="line">    results := <span class="built_in">make</span>([]*PriceResponse, <span class="built_in">len</span>(reqs))</span><br><span class="line">    <span class="keyword">var</span> wg sync.WaitGroup</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 控制并发数</span></span><br><span class="line">    sem := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;, <span class="number">20</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i, req := <span class="keyword">range</span> reqs &#123;</span><br><span class="line">        wg.Add(<span class="number">1</span>)</span><br><span class="line">        sem &lt;- <span class="keyword">struct</span>&#123;&#125;&#123;&#125;</span><br><span class="line">        <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">(idx <span class="type">int</span>, r *PriceRequest)</span></span> &#123;</span><br><span class="line">            <span class="keyword">defer</span> wg.Done()</span><br><span class="line">            <span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123; &lt;-sem &#125;()</span><br><span class="line">            results[idx], _ = e.calculateSingle(ctx, r, basePrices, promotionsByCategory)</span><br><span class="line">        &#125;(i, req)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    wg.Wait()</span><br><span class="line">    <span class="keyword">return</span> results, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="11-3-性能指标"><a href="#11-3-性能指标" class="headerlink" title="11.3 性能指标"></a>11.3 性能指标</h3><table>
<thead>
<tr>
<th>指标</th>
<th>目标值</th>
<th>监控方式</th>
</tr>
</thead>
<tbody><tr>
<td><strong>单价计算 P50</strong></td>
<td>&lt; 20ms</td>
<td>Prometheus</td>
</tr>
<tr>
<td><strong>单价计算 P99</strong></td>
<td>&lt; 100ms</td>
<td>Prometheus</td>
</tr>
<tr>
<td><strong>批量计算 P99</strong>（20个）</td>
<td>&lt; 200ms</td>
<td>Prometheus</td>
</tr>
<tr>
<td><strong>缓存命中率</strong></td>
<td>&gt; 85%</td>
<td>Redis Monitor</td>
</tr>
<tr>
<td><strong>QPS</strong></td>
<td>&gt; 10,000</td>
<td>Load Test</td>
</tr>
<tr>
<td><strong>CPU 使用率</strong></td>
<td>&lt; 60%</td>
<td>Grafana</td>
</tr>
</tbody></table>
<hr>
<h2 id="十二、监控与告警"><a href="#十二、监控与告警" class="headerlink" title="十二、监控与告警"></a>十二、监控与告警</h2><h3 id="12-1-核心监控指标"><a href="#12-1-核心监控指标" class="headerlink" title="12.1 核心监控指标"></a>12.1 核心监控指标</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"># 价格计算 QPS 和延迟</span><br><span class="line">pricing_calculate_total&#123;scene=&quot;list|detail|cart|checkout&quot;, status=&quot;success|fail|degrade&quot;&#125;</span><br><span class="line">pricing_calculate_duration_seconds&#123;scene, quantile=&quot;0.5|0.9|0.99&quot;&#125;</span><br><span class="line"></span><br><span class="line"># 营销活动命中</span><br><span class="line">pricing_promotion_match_total&#123;activity_type, result=&quot;hit|miss&quot;&#125;</span><br><span class="line">pricing_promotion_quota_remaining&#123;activity_id&#125;</span><br><span class="line"></span><br><span class="line"># 费用计算</span><br><span class="line">pricing_fee_calculate_total&#123;fee_type, status=&quot;success|fail&quot;&#125;</span><br><span class="line">pricing_fee_amount_sum&#123;fee_type&#125;</span><br><span class="line"></span><br><span class="line"># 优惠券</span><br><span class="line">pricing_voucher_apply_total&#123;voucher_type, status=&quot;success|fail|expired|conflict&quot;&#125;</span><br><span class="line"></span><br><span class="line"># 缓存</span><br><span class="line">pricing_cache_hit_total&#123;cache_level=&quot;l1|l2&quot;, data_type=&quot;base_price|promotion|fee&quot;&#125;</span><br><span class="line">pricing_cache_miss_total&#123;cache_level, data_type&#125;</span><br><span class="line"></span><br><span class="line"># 降级</span><br><span class="line">pricing_degrade_total&#123;level=&quot;promotion|fee|voucher|full&quot;&#125;</span><br><span class="line"></span><br><span class="line"># 价格快照</span><br><span class="line">pricing_snapshot_create_total&#123;status=&quot;success|fail&quot;&#125;</span><br><span class="line">pricing_snapshot_expired_total</span><br></pre></td></tr></table></figure>

<h3 id="12-2-告警规则"><a href="#12-2-告警规则" class="headerlink" title="12.2 告警规则"></a>12.2 告警规则</h3><table>
<thead>
<tr>
<th>告警名称</th>
<th>条件</th>
<th>级别</th>
<th>处理</th>
</tr>
</thead>
<tbody><tr>
<td><strong>价格计算超时</strong></td>
<td>P99 &gt; 200ms 持续5分钟</td>
<td>P1</td>
<td>检查缓存、DB、下游服务</td>
</tr>
<tr>
<td><strong>降级率过高</strong></td>
<td>降级率 &gt; 5% 持续3分钟</td>
<td>P1</td>
<td>检查促销&#x2F;优惠券服务可用性</td>
</tr>
<tr>
<td><strong>价格计算失败率</strong></td>
<td>失败率 &gt; 1% 持续3分钟</td>
<td>P0</td>
<td>紧急排查，可能影响下单</td>
</tr>
<tr>
<td><strong>缓存命中率下降</strong></td>
<td>命中率 &lt; 70% 持续5分钟</td>
<td>P2</td>
<td>检查 Redis 集群状态</td>
</tr>
<tr>
<td><strong>配额即将耗尽</strong></td>
<td>剩余配额 &lt; 10%</td>
<td>P3</td>
<td>通知运营补充配额</td>
</tr>
<tr>
<td><strong>价格异常波动</strong></td>
<td>同 SKU 价格波动 &gt; 30%</td>
<td>P2</td>
<td>检查动态定价规则</td>
</tr>
</tbody></table>
<h3 id="12-3-价格审计"><a href="#12-3-价格审计" class="headerlink" title="12.3 价格审计"></a>12.3 价格审计</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ReconstructPriceCalculation 根据订单还原价格计算（客服工具）</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *AuditService)</span></span> ReconstructPriceCalculation(ctx context.Context, orderID <span class="type">int64</span>) (*PriceAuditResult, <span class="type">error</span>) &#123;</span><br><span class="line">    <span class="comment">// 1. 获取价格快照</span></span><br><span class="line">    snapshot, err := s.snapshotRepo.GetByOrderID(ctx, orderID)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2. 解析计算明细</span></span><br><span class="line">    promotionDetails := parseJSON[[]PromotionDetail](snapshot.PromotionDetails)</span><br><span class="line">    feeDetails := parseJSON[[]FeeDetail](snapshot.FeeDetails)</span><br><span class="line">    voucherDetails := parseJSON[[]VoucherDetail](snapshot.VoucherDetails)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3. 验证计算正确性</span></span><br><span class="line">    calculatedFinalPrice := snapshot.Subtotal.</span><br><span class="line">        Sub(snapshot.PromotionDiscount).</span><br><span class="line">        Add(snapshot.TotalFee).</span><br><span class="line">        Sub(snapshot.VoucherDiscount)</span><br><span class="line"></span><br><span class="line">    isValid := calculatedFinalPrice.Equal(snapshot.FinalPrice)</span><br><span class="line">    <span class="keyword">if</span> !isValid &#123;</span><br><span class="line">        log.Errorf(<span class="string">&quot;price snapshot %s inconsistency: calculated=%s, recorded=%s&quot;</span>,</span><br><span class="line">            snapshot.SnapshotCode, calculatedFinalPrice, snapshot.FinalPrice)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 4. 返回审计结果</span></span><br><span class="line">    <span class="keyword">return</span> &amp;PriceAuditResult&#123;</span><br><span class="line">        SnapshotCode:     snapshot.SnapshotCode,</span><br><span class="line">        BasePrice:        snapshot.BasePrice,</span><br><span class="line">        Subtotal:         snapshot.Subtotal,</span><br><span class="line">        PromotionDetails: promotionDetails,</span><br><span class="line">        FeeDetails:       feeDetails,</span><br><span class="line">        VoucherDetails:   voucherDetails,</span><br><span class="line">        FinalPrice:       snapshot.FinalPrice,</span><br><span class="line">        PriceFormula:     snapshot.PriceFormula,</span><br><span class="line">        CalculationTime:  snapshot.CreatedAt,</span><br><span class="line">        IsValid:          isValid,</span><br><span class="line">    &#125;, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="十三、新品类接入指南"><a href="#十三、新品类接入指南" class="headerlink" title="十三、新品类接入指南"></a>十三、新品类接入指南</h2><p><strong>四步接入</strong>：</p>
<ol>
<li><strong>配置基础价格策略</strong>：确定价格来源（SKU 固定价 &#x2F; 日历价 &#x2F; 动态定价规则）。</li>
<li><strong>配置费用规则</strong>：确定该品类涉及哪些费用类型，INSERT <code>fee_config_tab</code>。</li>
<li><strong>关联营销活动</strong>：在 <code>promotion_activity_tab</code> 中 <code>category_ids</code> 加入新品类 ID。</li>
<li><strong>注册品类策略</strong>（可选）：如有特殊计价逻辑，实现 <code>BasePriceCalculator</code> 接口。</li>
</ol>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 示例：接入新品类 &quot;演唱会门票&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 1. 注册品类基础价格计算器（如有特殊逻辑）</span></span><br><span class="line">engine.RegisterBasePriceCalculator(<span class="string">&quot;concert&quot;</span>, &amp;ConcertBasePriceCalculator&#123;</span><br><span class="line">    <span class="comment">// 按场次 × 区域 × 票种计算基础价</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. 配置费用（SQL）</span></span><br><span class="line"><span class="comment">// INSERT INTO fee_config_tab (fee_code, fee_name, fee_type, category_id, calculation_type, calculation_config)</span></span><br><span class="line"><span class="comment">// VALUES (&#x27;FEE_DP_CONCERT&#x27;, &#x27;DP平台费&#x27;, &#x27;dp_fee&#x27;, 50001, &#x27;percentage&#x27;, &#x27;&#123;&quot;percentage&quot;: 3&#125;&#x27;);</span></span><br><span class="line"><span class="comment">// VALUES (&#x27;FEE_TICKET_SERVICE&#x27;, &#x27;票务服务费&#x27;, &#x27;service_fee&#x27;, 50001, &#x27;fixed&#x27;, &#x27;&#123;&quot;amount&quot;: 15&#125;&#x27;);</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. 营销活动自动关联（在活动 category_ids 中加入 50001 即可）</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 4. 无需修改 Pricing Engine 核心代码</span></span><br></pre></td></tr></table></figure>

<p><strong>品类接入检查清单</strong>：</p>
<table>
<thead>
<tr>
<th>检查项</th>
<th>说明</th>
<th>必须</th>
</tr>
</thead>
<tbody><tr>
<td>基础价格来源</td>
<td>SKU 固定价 &#x2F; 日历价 &#x2F; 动态定价</td>
<td>✅</td>
</tr>
<tr>
<td>费用配置</td>
<td>确定涉及哪些费用类型</td>
<td>✅</td>
</tr>
<tr>
<td>币种精度</td>
<td>确认该品类对应的币种和精度</td>
<td>✅</td>
</tr>
<tr>
<td>营销活动兼容</td>
<td>验证现有活动对新品类是否生效</td>
<td>✅</td>
</tr>
<tr>
<td>价格快照字段</td>
<td>确认 context 中是否需要额外字段</td>
<td>⬜</td>
</tr>
<tr>
<td>自定义计算器</td>
<td>是否需要特殊基础价格计算逻辑</td>
<td>⬜</td>
</tr>
</tbody></table>
<hr>
<h2 id="十四、业界价格模型演进与对比"><a href="#十四、业界价格模型演进与对比" class="headerlink" title="十四、业界价格模型演进与对比"></a>十四、业界价格模型演进与对比</h2><h3 id="14-1-价格模型演进史"><a href="#14-1-价格模型演进史" class="headerlink" title="14.1 价格模型演进史"></a>14.1 价格模型演进史</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────────────────────────────┐</span><br><span class="line">│                  价格引擎技术演进路径                              │</span><br><span class="line">├─────────────────────────────────────────────────────────────────┤</span><br><span class="line">│                                                                  │</span><br><span class="line">│  Phase 1: 单一价格时代（2000年前）                               │</span><br><span class="line">│  ┌─────────────────────────────┐                               │</span><br><span class="line">│  │ 商品一口价，总价 = 单价 × 数量 │                               │</span><br><span class="line">│  │ 代表: 早期零售 ERP            │                               │</span><br><span class="line">│  └─────────────────────────────┘                               │</span><br><span class="line">│               ↓                                                  │</span><br><span class="line">│  Phase 2: 促销价格分离（2000-2010）                              │</span><br><span class="line">│  ┌─────────────────────────────┐                               │</span><br><span class="line">│  │ original_price + sale_price │                               │</span><br><span class="line">│  │ 简单时间段促销              │                               │</span><br><span class="line">│  │ 代表: 早期淘宝、eBay        │                               │</span><br><span class="line">│  └─────────────────────────────┘                               │</span><br><span class="line">│               ↓                                                  │</span><br><span class="line">│  Phase 3: 规则引擎化（2010-2015）                                │</span><br><span class="line">│  ┌─────────────────────────────┐                               │</span><br><span class="line">│  │ 促销规则独立成表            │                               │</span><br><span class="line">│  │ 优先级 &amp; 互斥机制          │                               │</span><br><span class="line">│  │ 独立优惠券系统              │                               │</span><br><span class="line">│  │ 代表: 淘宝天猫、京东        │                               │</span><br><span class="line">│  └─────────────────────────────┘                               │</span><br><span class="line">│               ↓                                                  │</span><br><span class="line">│  Phase 4: 智能定价（2015-2020）                                  │</span><br><span class="line">│  ┌─────────────────────────────┐                               │</span><br><span class="line">│  │ 动态定价（供需、库存、竞品）│                               │</span><br><span class="line">│  │ 个性化定价（用户画像）      │                               │</span><br><span class="line">│  │ 价格快照 &amp; 审计             │                               │</span><br><span class="line">│  │ 代表: Uber、Airbnb、Amazon  │                               │</span><br><span class="line">│  └─────────────────────────────┘                               │</span><br><span class="line">│               ↓                                                  │</span><br><span class="line">│  Phase 5: AI 赋能（2020至今）                                    │</span><br><span class="line">│  ┌─────────────────────────────┐                               │</span><br><span class="line">│  │ ML 定价模型（需求预测）     │                               │</span><br><span class="line">│  │ 实时竞品监控                │                               │</span><br><span class="line">│  │ A/B 测试自动化              │                               │</span><br><span class="line">│  │ 代表: Amazon ML、阿里智能   │                               │</span><br><span class="line">│  └─────────────────────────────┘                               │</span><br><span class="line">│                                                                  │</span><br><span class="line">└─────────────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure>

<h3 id="14-2-各阶段对比"><a href="#14-2-各阶段对比" class="headerlink" title="14.2 各阶段对比"></a>14.2 各阶段对比</h3><table>
<thead>
<tr>
<th>维度</th>
<th>Phase 1</th>
<th>Phase 2</th>
<th>Phase 3</th>
<th>Phase 4</th>
<th>Phase 5</th>
</tr>
</thead>
<tbody><tr>
<td><strong>计算方式</strong></td>
<td>硬编码</td>
<td>配置化</td>
<td>规则引擎</td>
<td>ML 模型</td>
<td>在线学习</td>
</tr>
<tr>
<td><strong>响应时间</strong></td>
<td>&lt;10ms</td>
<td>&lt;50ms</td>
<td>&lt;100ms</td>
<td>&lt;200ms</td>
<td>&lt;100ms</td>
</tr>
<tr>
<td><strong>扩展性</strong></td>
<td>差</td>
<td>中</td>
<td>好</td>
<td>好</td>
<td>优秀</td>
</tr>
<tr>
<td><strong>维护成本</strong></td>
<td>高</td>
<td>中</td>
<td>中</td>
<td>中</td>
<td>低</td>
</tr>
<tr>
<td><strong>智能程度</strong></td>
<td>无</td>
<td>低</td>
<td>中</td>
<td>高</td>
<td>极高</td>
</tr>
<tr>
<td><strong>代表企业</strong></td>
<td>早期电商</td>
<td>淘宝&#x2F;京东</td>
<td>天猫&#x2F;Amazon</td>
<td>Uber&#x2F;Airbnb</td>
<td>Amazon&#x2F;阿里</td>
</tr>
</tbody></table>
<h3 id="14-3-主流电商平台对比"><a href="#14-3-主流电商平台对比" class="headerlink" title="14.3 主流电商平台对比"></a>14.3 主流电商平台对比</h3><h4 id="淘宝-天猫"><a href="#淘宝-天猫" class="headerlink" title="淘宝&#x2F;天猫"></a>淘宝&#x2F;天猫</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">价格计算链路: 商品价格 → 营销活动 → 优惠券 → 积分 → 红包</span><br><span class="line">技术栈: Drools 规则引擎 + Tair 分布式缓存 + HSF/Dubbo RPC</span><br><span class="line">性能: P99 &lt; 50ms</span><br><span class="line">特色: 双11 大促复杂叠加规则（店铺券 + 品类券 + 跨店券 + 红包 + 津贴）</span><br></pre></td></tr></table></figure>

<h4 id="京东"><a href="#京东" class="headerlink" title="京东"></a>京东</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">价格计算链路: 基础价 → 会员价(Plus) → 活动 → 优惠券 → 京豆 → 运费</span><br><span class="line">技术栈: 自研规则引擎 + Redis 集群</span><br><span class="line">性能: P99 &lt; 80ms</span><br><span class="line">特色: Plus 会员价体系 + 京豆积分深度融合</span><br></pre></td></tr></table></figure>

<h4 id="Amazon"><a href="#Amazon" class="headerlink" title="Amazon"></a>Amazon</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">价格计算链路: 基础价 → ML 动态定价 → Prime 折扣 → Lightning Deal → Subscribe &amp; Save</span><br><span class="line">技术栈: 自研 ML Pipeline + ElastiCache</span><br><span class="line">性能: P99 &lt; 100ms</span><br><span class="line">特色: ML 驱动定价（需求弹性 × 竞品价格 × 库存水平）</span><br></pre></td></tr></table></figure>

<h4 id="Uber-动态定价"><a href="#Uber-动态定价" class="headerlink" title="Uber (动态定价)"></a>Uber (动态定价)</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">定价逻辑: base_price = distance × rate + duration × rate → surge_multiplier</span><br><span class="line">技术栈: 实时供需计算 + ML 预测 + 平滑处理</span><br><span class="line">特色: 供需比驱动 Surge Pricing，平滑处理避免价格突变</span><br></pre></td></tr></table></figure>

<h3 id="14-4-我们的定位与对比"><a href="#14-4-我们的定位与对比" class="headerlink" title="14.4 我们的定位与对比"></a>14.4 我们的定位与对比</h3><table>
<thead>
<tr>
<th>特性</th>
<th>我们的设计</th>
<th>淘宝天猫</th>
<th>京东</th>
<th>Amazon</th>
</tr>
</thead>
<tbody><tr>
<td><strong>分层架构</strong></td>
<td>4层（Base&#x2F;Promo&#x2F;Fee&#x2F;Voucher）</td>
<td>5层（含积分&#x2F;红包）</td>
<td>5层（含京豆）</td>
<td>3层（简化）</td>
</tr>
<tr>
<td><strong>规则引擎</strong></td>
<td>DB 配置 + JSON</td>
<td>Drools + 自研</td>
<td>自研</td>
<td>自研</td>
</tr>
<tr>
<td><strong>动态定价</strong></td>
<td>规则驱动</td>
<td>ML 驱动</td>
<td>规则驱动</td>
<td>ML 驱动</td>
</tr>
<tr>
<td><strong>价格快照</strong></td>
<td>✅ 完整支持</td>
<td>✅ 支持</td>
<td>✅ 支持</td>
<td>✅ 支持</td>
</tr>
<tr>
<td><strong>费用拆分</strong></td>
<td>✅ 详细（DP&#x2F;Hub&#x2F;Service&#x2F;Tax）</td>
<td>✅ 详细</td>
<td>✅ 详细</td>
<td>✅ 详细</td>
</tr>
<tr>
<td><strong>多币种</strong></td>
<td>✅ 6种东南亚货币</td>
<td>单一（CNY）</td>
<td>单一（CNY）</td>
<td>全球多币种</td>
</tr>
<tr>
<td><strong>降级策略</strong></td>
<td>✅ 5级降级</td>
<td>✅ 完善</td>
<td>✅ 完善</td>
<td>✅ 完善</td>
</tr>
<tr>
<td><strong>ML 定价</strong></td>
<td>❌ 待规划</td>
<td>✅ 深度应用</td>
<td>⚠️ 部分</td>
<td>✅ 核心能力</td>
</tr>
</tbody></table>
<p><strong>我们的差异化优势</strong>：</p>
<ol>
<li><strong>专注虚拟商品</strong>：无物流成本，关注时间维度定价（酒店日历、电影场次）。</li>
<li><strong>费用透明化</strong>：DP Fee、Hub Fee 独立管理，可配置是否可被优惠券抵扣。</li>
<li><strong>多币种原生支持</strong>：东南亚6国币种精度处理内置。</li>
<li><strong>审计合规</strong>：完整价格快照 + 人类可读公式，满足监管要求。</li>
</ol>
<hr>
<h2 id="十五、设计总结"><a href="#十五、设计总结" class="headerlink" title="十五、设计总结"></a>十五、设计总结</h2><h3 id="15-1-核心设计决策"><a href="#15-1-核心设计决策" class="headerlink" title="15.1 核心设计决策"></a>15.1 核心设计决策</h3><table>
<thead>
<tr>
<th>决策</th>
<th>选择</th>
<th>原因</th>
</tr>
</thead>
<tbody><tr>
<td><strong>统一 vs 独立</strong></td>
<td>统一 Pricing Engine + 策略模式</td>
<td>复用计算逻辑，新品类零代码接入</td>
</tr>
<tr>
<td><strong>同步 vs 异步</strong></td>
<td>价格计算同步，快照异步写入</td>
<td>热路径极速，冷路径可靠</td>
</tr>
<tr>
<td><strong>缓存策略</strong></td>
<td>L1 本地 + L2 Redis + L3 MySQL</td>
<td>多级缓存，高性能 + 可靠</td>
</tr>
<tr>
<td><strong>精度处理</strong></td>
<td>decimal.Decimal + 币种精度表</td>
<td>避免浮点误差</td>
</tr>
<tr>
<td><strong>降级策略</strong></td>
<td>5级降级，促销&#x2F;券可降级，基础价不可降级</td>
<td>保证核心链路可用</td>
</tr>
<tr>
<td><strong>互斥规则</strong></td>
<td>Priority + Exclusivity 字段</td>
<td>灵活配置，无需改代码</td>
</tr>
<tr>
<td><strong>配额管理</strong></td>
<td>Redis Lua 原子操作</td>
<td>高并发场景不超卖</td>
</tr>
<tr>
<td><strong>审计追溯</strong></td>
<td>价格快照 + 变更日志</td>
<td>完整记录，客诉可还原</td>
</tr>
</tbody></table>
<h3 id="15-2-关键技术栈"><a href="#15-2-关键技术栈" class="headerlink" title="15.2 关键技术栈"></a>15.2 关键技术栈</h3><table>
<thead>
<tr>
<th>组件</th>
<th>技术选型</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>Pricing Engine</td>
<td>Go 微服务</td>
<td>价格计算核心引擎</td>
</tr>
<tr>
<td>缓存层</td>
<td>Redis Cluster + sync.Map</td>
<td>多级缓存</td>
</tr>
<tr>
<td>规则引擎</td>
<td>MySQL + JSON 配置</td>
<td>灵活配置营销规则</td>
</tr>
<tr>
<td>价格快照</td>
<td>MySQL</td>
<td>持久化价格明细</td>
</tr>
<tr>
<td>消息队列</td>
<td>Kafka</td>
<td>价格变动事件、快照异步写入</td>
</tr>
<tr>
<td>配额管理</td>
<td>Redis Lua</td>
<td>原子扣减</td>
</tr>
<tr>
<td>监控</td>
<td>Prometheus + Grafana</td>
<td>性能监控与告警</td>
</tr>
<tr>
<td>配置中心</td>
<td>Apollo &#x2F; Nacos</td>
<td>降级开关、超时配置</td>
</tr>
</tbody></table>
<h3 id="15-3-实施路线"><a href="#15-3-实施路线" class="headerlink" title="15.3 实施路线"></a>15.3 实施路线</h3><table>
<thead>
<tr>
<th>阶段</th>
<th>时间</th>
<th>内容</th>
<th>交付物</th>
</tr>
</thead>
<tbody><tr>
<td><strong>P1: 基础架构</strong></td>
<td>2周</td>
<td>数据库表、Pricing Engine 框架、基础价格层</td>
<td>可运行的计算引擎</td>
</tr>
<tr>
<td><strong>P2: 营销活动</strong></td>
<td>3周</td>
<td>促销规则引擎、匹配器、配额管理、管理后台</td>
<td>支持折扣&#x2F;满减&#x2F;秒杀</td>
</tr>
<tr>
<td><strong>P3: 费用与优惠券</strong></td>
<td>2周</td>
<td>Fee 计算器、Voucher 系统、叠加规则</td>
<td>完整4层计算</td>
</tr>
<tr>
<td><strong>P4: 性能与审计</strong></td>
<td>2周</td>
<td>多级缓存、并行计算、价格快照、审计工具</td>
<td>P99 &lt; 100ms</td>
</tr>
<tr>
<td><strong>P5: 全量上线</strong></td>
<td>1周</td>
<td>全品类覆盖、监控告警、文档培训</td>
<td>生产环境稳定运行</td>
</tr>
</tbody></table>
<h3 id="15-4-改进路线图"><a href="#15-4-改进路线图" class="headerlink" title="15.4 改进路线图"></a>15.4 改进路线图</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────────────────────────────┐</span><br><span class="line">│                  价格引擎改进路线图                                │</span><br><span class="line">├─────────────────────────────────────────────────────────────────┤</span><br><span class="line">│                                                                  │</span><br><span class="line">│  Q1 2026: 基础完善                                               │</span><br><span class="line">│  ✅ 统一价格中心上线                                             │</span><br><span class="line">│  ✅ 价格快照机制                                                 │</span><br><span class="line">│  ✅ 多级缓存策略                                                 │</span><br><span class="line">│  ✅ 多级降级方案                                                 │</span><br><span class="line">│                                                                  │</span><br><span class="line">│  Q2 2026: 智能化初步                                             │</span><br><span class="line">│  🔲 动态定价规则增强                                             │</span><br><span class="line">│  🔲 A/B 测试平台集成                                             │</span><br><span class="line">│  🔲 用户分层定价（新用户/VIP/高净值）                             │</span><br><span class="line">│                                                                  │</span><br><span class="line">│  Q3 2026: ML 模型引入                                            │</span><br><span class="line">│  🔲 需求预测模型（LSTM）                                         │</span><br><span class="line">│  🔲 价格弹性分析                                                 │</span><br><span class="line">│  🔲 竞品价格监控                                                 │</span><br><span class="line">│                                                                  │</span><br><span class="line">│  Q4 2026: 实时智能                                               │</span><br><span class="line">│  🔲 实时特征平台（Flink）                                        │</span><br><span class="line">│  🔲 在线模型更新                                                 │</span><br><span class="line">│  🔲 多目标优化（收入/转化/毛利）                                  │</span><br><span class="line">│                                                                  │</span><br><span class="line">└─────────────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure>

<h3 id="15-5-风险与缓解"><a href="#15-5-风险与缓解" class="headerlink" title="15.5 风险与缓解"></a>15.5 风险与缓解</h3><table>
<thead>
<tr>
<th>风险</th>
<th>影响</th>
<th>缓解措施</th>
</tr>
</thead>
<tbody><tr>
<td><strong>规则配置错误</strong></td>
<td>价格异常</td>
<td>配置审批流程 + 灰度发布 + 回滚机制</td>
</tr>
<tr>
<td><strong>性能瓶颈</strong></td>
<td>响应超时</td>
<td>缓存预热 + 限流降级 + 水平扩展</td>
</tr>
<tr>
<td><strong>价格不一致</strong></td>
<td>用户投诉</td>
<td>统一 API + 快照机制 + 实时校验</td>
</tr>
<tr>
<td><strong>促销超卖</strong></td>
<td>成本损失</td>
<td>Redis Lua 原子扣减 + 异步对账</td>
</tr>
<tr>
<td><strong>多币种精度</strong></td>
<td>金额误差</td>
<td>decimal.Decimal + 币种精度表 + 分摊尾差处理</td>
</tr>
<tr>
<td><strong>缓存穿透</strong></td>
<td>DB 压力</td>
<td>布隆过滤器 + 空值缓存 + 限流</td>
</tr>
</tbody></table>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/" rel="tag"># 系统设计</a>
              <a href="/tags/%E9%AB%98%E5%B9%B6%E5%8F%91/" rel="tag"># 高并发</a>
              <a href="/tags/%E7%94%B5%E5%95%86/" rel="tag"># 电商</a>
              <a href="/tags/%E4%BB%B7%E6%A0%BC%E7%B3%BB%E7%BB%9F/" rel="tag"># 价格系统</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2025/06/28/system-design/19-listing-upload-system-design/" rel="prev" title="多品类统一商品上架系统设计：电商·虚拟商品·本地生活">
                  <i class="fa fa-angle-left"></i> 多品类统一商品上架系统设计：电商·虚拟商品·本地生活
                </a>
            </div>
            <div class="post-nav-item">
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2026</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">wxquare</span>
  </div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/sidebar.js"></script><script src="/js/next-boot.js"></script>

  

  <script class="next-config" data-name="mermaid" type="application/json">{"enable":true,"theme":{"light":"default","dark":"dark"},"js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mermaid/10.9.0/mermaid.min.js","integrity":"sha256-stuqcu2FrjYCXDOytWFA5SoUE/r3nkp6gTglzNSlavU="}}</script>
  <script src="/js/third-party/tags/mermaid.js"></script>





  





</body>
</html>
