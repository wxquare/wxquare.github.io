---
title: ä¸­é—´ä»¶ - Redis åŸç†ä¸å®è·µ
date: 2024-03-06
updated: 2026-01-08
categories:
- ç³»ç»Ÿè®¾è®¡
tags:
- Redis
- ç¼“å­˜
- æ•°æ®ç»“æ„
- åˆ†å¸ƒå¼ç³»ç»Ÿ
---

> æœ¬æ–‡æ·±å…¥å‰–æ Redis çš„æ ¸å¿ƒåŸç†ã€æ•°æ®ç»“æ„åº•å±‚å®ç°ã€ç”µå•†åœºæ™¯æœ€ä½³å®è·µã€‚åŒ…å« Hash ziplist å­—èŠ‚çº§å†…å­˜åˆ†æã€æ¸è¿›å¼ rehash æœºåˆ¶ã€ç¼“å­˜ä¸€è‡´æ€§æ–¹æ¡ˆç­‰ã€‚

## ğŸ“‹ ç›®å½•å¯¼èˆª

### ä¸€ã€åŸºç¡€ç¯‡
1. [Redis æ ¸å¿ƒç‰¹æ€§ä¸ä½¿ç”¨åœºæ™¯](#redis-æ ¸å¿ƒç‰¹æ€§ä¸ä½¿ç”¨åœºæ™¯)
2. [äº”ç§æ•°æ®ç±»å‹ä¸åº•å±‚å®ç°](#redis-5ç§æ•°æ®ç±»å‹å’Œåº•å±‚æ•°æ®ç»“æ„)
3. [å¸¸ç”¨å‘½ä»¤ä¸æ—¶é—´å¤æ‚åº¦](#redis-å¸¸ç”¨å‘½ä»¤)

### äºŒã€æ•°æ®ç»“æ„æ·±åº¦å‰–æ
1. [Hash åº•å±‚å®ç°è¯¦è§£](#hash-åº•å±‚å®ç°åŸç†è¯¦è§£)ï¼ˆâ­ æ ¸å¿ƒé‡ç‚¹ï¼‰
   - ziplist å‹ç¼©åˆ—è¡¨ï¼ˆå­—èŠ‚çº§åˆ†æï¼‰
   - hashtable å“ˆå¸Œè¡¨ï¼ˆæ¸è¿›å¼ rehashï¼‰
   - å®æˆ˜æ¡ˆä¾‹ï¼š`{name: "iPhone", price: 5999}`
2. [String/SDS å®ç°](#string-åº•å±‚å®ç°)
3. [List å®ç°ï¼ˆziplist/linkedlist/quicklistï¼‰](#list-åº•å±‚å®ç°)
4. [Set å®ç°ï¼ˆintset/hashtableï¼‰](#set-åº•å±‚å®ç°)
5. [ZSet å®ç°ï¼ˆziplist/skiplistï¼‰](#zset-åº•å±‚å®ç°)

### ä¸‰ã€ç¼“å­˜è®¾è®¡ä¸å®è·µ
1. [ç¼“å­˜ä½¿ç”¨åœºæ™¯](#redis-ä½¿ç”¨åœºæ™¯)ï¼ˆè®¡æ•°å™¨ã€é™æµã€é˜Ÿåˆ—ï¼‰
2. [ç¼“å­˜ä¸DBä¸€è‡´æ€§](#æ€ä¹ˆè€ƒè™‘ç¼“å­˜å’Œdbæ•°æ®ä¸€è‡´æ€§çš„é—®é¢˜)
3. [ç¼“å­˜å¼‚å¸¸å¤„ç†](#ç¼“å­˜å¼‚å¸¸ä¸å¯¹åº”çš„è§£å†³åŠæ³•)ï¼ˆé›ªå´©ã€ç©¿é€ã€å‡»ç©¿ï¼‰
4. [æœ¬åœ°ç¼“å­˜ vs è¿œç¨‹ç¼“å­˜](#é€‰æ‹©local-remote-multilevel-cache)

### å››ã€é«˜çº§ç‰¹æ€§
1. [å†…å­˜ç®¡ç†](#è®¡ç®—æ‰€éœ€çš„ç¼“å­˜çš„å®¹é‡å½“å®¹é‡è¶…è¿‡é™åˆ¶æ—¶çš„æ·˜æ±°ç­–ç•¥)ï¼ˆæ·˜æ±°ç­–ç•¥ã€è¿‡æœŸé”®åˆ é™¤ï¼‰
2. [æŒä¹…åŒ–æœºåˆ¶](#redis-ä¸¤ç§æ•°æ®æŒä¹…åŒ–çš„åŸç†ä»¥åŠä¼˜ç¼ºç‚¹)ï¼ˆRDBã€AOFï¼‰
3. [åˆ†å¸ƒå¼æ–¹æ¡ˆ](#redisåˆ†å¸ƒå¼æ–¹æ¡ˆ)ï¼ˆä¸»ä»ã€å“¨å…µã€é›†ç¾¤ï¼‰
4. [Lua è„šæœ¬](#redis--lua)

### äº”ã€æ€§èƒ½ä¼˜åŒ–
1. [ä¸ºä»€ä¹ˆ Redis è¿™ä¹ˆå¿«](#redis-ä¸ºä»€ä¹ˆè¿™ä¹ˆå¿«)
2. [å•çº¿ç¨‹æ¨¡å‹](#redis-ä¸ºä»€ä¹ˆä½¿ç”¨å•çº¿ç¨‹æ¨¡å‹)
3. [æ€§èƒ½è°ƒä¼˜å®è·µ](#æ€§èƒ½è°ƒä¼˜ä¸ç›‘æ§)
4. [å¤§ Keyã€çƒ­ Key é—®é¢˜](#å¤§keyå’Œçƒ­keyé—®é¢˜)

### å…­ã€å®æˆ˜æ¡ˆä¾‹
1. [åˆ†å¸ƒå¼é”å®ç°](#rediså®ç°åˆ†å¸ƒå¼é”)
2. [BloomFilter åº”ç”¨](#bloomfilter-å®è·µ)
3. [ç§’æ€ç³»ç»Ÿè®¾è®¡](#ç§’æ€ç³»ç»Ÿè®¾è®¡)
4. [æ’è¡Œæ¦œå®ç°](#æ’è¡Œæ¦œå®ç°)

---

## Redis æ ¸å¿ƒç‰¹æ€§ä¸ä½¿ç”¨åœºæ™¯

### æ ¸å¿ƒç‰¹æ€§æ€»è§ˆ

| ç‰¹æ€§ | è¯´æ˜ | ä¼˜åŠ¿ |
|------|------|------|
| **å†…å­˜å­˜å‚¨** | æ•°æ®å…¨éƒ¨åœ¨å†…å­˜ä¸­ | æå¿«çš„è¯»å†™é€Ÿåº¦ï¼ˆ10w+ QPSï¼‰ |
| **å•çº¿ç¨‹æ¨¡å‹** | å‘½ä»¤ä¸²è¡Œæ‰§è¡Œ | é¿å…é”ç«äº‰ï¼Œç®€åŒ–å¹¶å‘ |
| **å¤šç§æ•°æ®ç»“æ„** | String/Hash/List/Set/ZSet | è¦†ç›–å¤šç§ä¸šåŠ¡åœºæ™¯ |
| **æŒä¹…åŒ–æ”¯æŒ** | RDB + AOF | æ•°æ®ä¸ä¸¢å¤± |
| **ä¸»ä»å¤åˆ¶** | è¯»å†™åˆ†ç¦» | é«˜å¯ç”¨ã€é«˜å¹¶å‘ |
| **é›†ç¾¤æ¨¡å¼** | åˆ†ç‰‡å­˜å‚¨ | æ¨ªå‘æ‰©å±•èƒ½åŠ› |

### å…¸å‹åº”ç”¨åœºæ™¯

#### ç¼“å­˜åŠ é€Ÿï¼ˆä¸Šæ¸¸æ•°æ®/æ•°æ®åº“/å¤–éƒ¨èšåˆæ•°æ®ï¼‰

```go
// æŸ¥è¯¢å•†å“è¯¦æƒ…
func GetProduct(productID string) (*Product, error) {
    // 1. å…ˆæŸ¥ç¼“å­˜
    key := "product:" + productID
    data, err := rdb.Get(ctx, key).Result()
    if err == nil {
        return json.Unmarshal(data)  // ç¼“å­˜å‘½ä¸­
    }
    
    // 2. ç¼“å­˜æœªå‘½ä¸­ï¼ŒæŸ¥è¯¢ DB
    product, err := db.QueryProduct(productID)
    if err != nil {
        return nil, err
    }
    
    // 3. å›å†™ç¼“å­˜ï¼ˆè®¾ç½®è¿‡æœŸæ—¶é—´ï¼‰
    rdb.Set(ctx, key, json.Marshal(product), 1*time.Hour)
    return product, nil
}
// å­˜å‚¨ JSON å¯¹è±¡
rdb.Set(ctx, "user:123", `{"name":"alice","age":25}`, 0)

// å­˜å‚¨è®¡æ•°å™¨
rdb.Set(ctx, "visit:count", 0, 0)

```

**æ€§èƒ½æå‡**ï¼šDB æŸ¥è¯¢ 100ms â†’ Redis æŸ¥è¯¢ 1msï¼ˆæå‡ 100 å€ï¼‰


### è®¡æ•°å™¨åœºæ™¯ï¼ˆincr + intï¼‰
1. åº“å­˜æ‰£å‡ï¼ˆæœ€æ ¸å¿ƒåœºæ™¯ï¼‰è¿™æ˜¯è®¡æ•°å™¨æœ€å¹¿æ³›çš„åº”ç”¨ã€‚åœ¨ç§’æ€æˆ–å¤§ä¿ƒæœŸé—´ï¼Œç›´æ¥æ“ä½œæ•°æ®åº“åº“å­˜ä¼šç¬é—´æ‹–å®ç£ç›˜ I/Oã€‚
 - é€»è¾‘ï¼š 
  1. æ´»åŠ¨å¼€å§‹å‰ï¼Œå°†å•†å“åº“å­˜åŒæ­¥åˆ° Redisï¼šSET stock:sku:1001 50ã€‚ 
  2. ç”¨æˆ·ä¸‹å•æ—¶ï¼Œæ‰§è¡Œï¼šDECR stock:sku:1001ã€‚ 
  3. å¦‚æœè¿”å›å€¼ >= 0ï¼Œæ”¾è¡Œå»å†™è®¢å•ï¼›å¦‚æœè¿”å›å€¼ < 0ï¼Œç«‹å³è¿”å›â€œå·²å”®ç½„â€ã€‚
  4. ä¼˜åŠ¿ï¼š å†…å­˜çº§æ“ä½œï¼Œå•æœºå¯æ”¯æ’‘ 10w+ TPSï¼Œå½»åº•æœç»è¶…å–ã€‚

2. é«˜é¢‘é™æµï¼ˆé˜²åˆ·ä¸é£æ§ï¼‰
- é€»è¾‘ï¼š 
  1. Key ä¸º limit:user:{uid}:api:{api_name}ã€‚ 
  2. æ¯æ¬¡è¯·æ±‚æ‰§è¡Œ INCRã€‚ 
  3. å¦‚æœæ˜¯é¦–æ¬¡è°ƒç”¨ï¼ˆè¿”å› 1ï¼‰ï¼Œè®¾ç½®è¿‡æœŸæ—¶é—´ EXPIRE 60ï¼ˆå³ 1 åˆ†é’Ÿé™æµï¼‰ã€‚ 
  4. å¦‚æœè¿”å›å€¼è¶…è¿‡é˜ˆå€¼ï¼ˆå¦‚ 100ï¼‰ï¼Œç›´æ¥æ‹’ç»è¯·æ±‚ã€‚

### ZSet ä½¿ç”¨åœºæ™¯

### List ä½¿ç”¨åœºæ™¯
1. åœ¨ç§’æ€ç¬é—´ï¼Œç”±äºæµé‡è¿œè¶…æ•°æ®åº“æ‰¿å—èƒ½åŠ›ï¼Œå…ˆå°†è¯·æ±‚â€œé˜Ÿåˆ—åŒ–â€ã€‚
  - æ“ä½œï¼š ç”¨æˆ·çš„è¯·æ±‚åˆ°è¾¾åï¼Œé€šè¿‡ LPUSH å‹å…¥ä¸€ä¸ªæ’é˜Ÿåˆ— seckill:queue:product_idã€‚
  - å¤„ç†ï¼š åå°å¼€å¯å›ºå®šæ•°é‡çš„ Worker è¿›ç¨‹ï¼Œé€šè¿‡ RPOP æˆ– BRPOP è·å–è¯·æ±‚è¿›è¡Œåç»­å‡åº“å­˜æ“ä½œã€‚
  - ä¼˜åŠ¿ï¼š å‰Šå³°å¡«è°·ï¼Œä¿æŠ¤åç«¯æ ¸å¿ƒç³»ç»Ÿ

2. æµè§ˆæœ€è¿‘æŸ¥çœ‹çš„å•†å“ï¼ˆTop 10ï¼‰ å¦‚æœä½ åœ¨å•†åŸè¯¦æƒ…é¡µä¸‹æ–¹å±•ç¤ºâ€œæœ€è¿‘æŸ¥çœ‹â€ï¼Œä½ å¯èƒ½éœ€è¦å…ˆè¯»å–å‰ 10 ä¸ªæ˜¾ç¤ºç»™ç”¨æˆ·
```
  // 1. å…ˆè¯»å–å‰ 10 ä¸ªç»™å‰ç«¯å±•ç¤ºï¼Œä¸åˆ é™¤
  products, _ := rdb.LRange(ctx, "user:history:123", 0, 9).Result()

  // 2. å¦‚æœç”¨æˆ·ç‚¹å¼€äº†æŸä¸ªå•†å“ï¼Œä½ å†å¾€é‡ŒåŠ ï¼Œå¹¶è£å‰ª
  pipe := rdb.Pipeline()
  pipe.LPush(ctx, "user:history:123", "new_product_id")
  pipe.LTrim(ctx, "user:history:123", 0, 9) // åªä¿ç•™æœ€æ–°çš„10ä¸ª
  pipe.Exec(ctx)
```

1. ç¼“å­˜æ•°æ®ï¼ˆdbï¼Œservice) çš„æ•°æ®ï¼Œæé«˜è®¿é—®æ•ˆç‡
     - ç¼“å­˜å®¹é‡è¯„ä¼°
     - ç¼“å­˜è¿‡æœŸæœºåˆ¶ï¼Œæ—¶é—´
     - ç¼“å­˜missï¼Œæº¯æºå’Œç›‘æ§
     - ç¼“å­˜é›ªå´©,å¤§é¢ç§¯keyå¤±æ•ˆDBä¿æŠ¤ã€‚
     - ç¼“å­˜å‡»ç©¿ï¼šçƒ­keyå‡»ç©¿ä¿æŠ¤
     - ç¼“å­˜ç©¿é€ï¼šæ— æ•ˆkeyå‡»ç©¿DBä¿æŠ¤
     - ç¼“å­˜æ›´æ–°å’Œä¸€è‡´æ€§é—®é¢˜
     - ç¼“å­˜çƒ­keyå’Œå¤§keyé—®é¢˜
2. é™æµå’Œè®¡æ•°ã€‚luaè„šæœ¬ã€‚ï¼ˆint,incr,luaï¼‰
     - è®¡æ•°å™¨ ï¼ˆä¸´ç•Œå€¼å’Œfrozen)
     - token ï¼ˆå¸¸ç”¨ï¼‰
     - æ¼æ¡¶ï¼ˆå¹³æ»‘ï¼‰
     - åŸºäºredisçš„åˆ†å¸ƒå¼é™æµï¼šhttps://pandaychen.github.io/2020/09/21/A-DISTRIBUTE-GOREDIS-RATELIMITER-ANALYSIS/
     - https://blog.csdn.net/crazymakercircle/article/details/130035504
3. å»¶æ—¶é˜Ÿåˆ—
   - ä½¿ç”¨ ZSET+ å®šæ—¶è½®è¯¢çš„æ–¹å¼å®ç°å»¶æ—¶é˜Ÿåˆ—æœºåˆ¶ï¼Œä»»åŠ¡é›†åˆè®°ä¸º taskGroupKey
   - ç”Ÿæˆä»»åŠ¡ä»¥ å½“å‰æ—¶é—´æˆ³ ä¸ å»¶æ—¶æ—¶é—´ ç›¸åŠ åå¾—åˆ°ä»»åŠ¡çœŸæ­£çš„è§¦å‘æ—¶é—´ï¼Œè®°ä¸º time1ï¼Œä»»åŠ¡çš„ uuid å³ä¸º taskidï¼Œå½“å‰æ—¶é—´æˆ³è®°ä¸º curTime
   - ä½¿ç”¨ ZADD taskGroupKey time1 taskid å°†ä»»åŠ¡å†™å…¥ ZSET
   - ä¸»é€»è¾‘ä¸æ–­ä»¥è½®è¯¢æ–¹å¼ ZRANGE taskGroupKey curTime MAXTIME withscores è·å– [curTime,MAXTIME) ä¹‹é—´çš„ä»»åŠ¡ï¼Œè®°ä¸ºå·²ç»åˆ°æœŸçš„å»¶æ—¶ä»»åŠ¡ï¼ˆé›†ï¼‰
   - å¤„ç†å»¶æ—¶ä»»åŠ¡ï¼Œå¤„ç†å®Œæˆååˆ é™¤å³å¯
   - ä¿å­˜å½“å‰æ—¶é—´æˆ³ curTimeï¼Œä½œä¸ºä¸‹ä¸€æ¬¡è½®è¯¢æ—¶çš„ ZRANGE æŒ‡ä»¤çš„èŒƒå›´èµ·ç‚¹
   - https://github.com/bitleak/lmstfy
4. æ¶ˆæ¯é˜Ÿåˆ—
   - redis æ”¯æŒ List æ•°æ®ç»“æ„ï¼Œæœ‰æ—¶ä¹Ÿä¼šå……å½“æ¶ˆæ¯é˜Ÿåˆ—ã€‚ä½¿ç”¨ç”Ÿäº§è€…ï¼šLPUSHï¼›æ¶ˆè´¹è€…ï¼šRBPOP æˆ– RPOP æ¨¡æ‹Ÿé˜Ÿåˆ—
5. åˆ†å¸ƒå¼é”ï¼šhttps://juejin.cn/post/6936956908007850014
6. bloomfilter: https://juejin.cn/post/6844903862072000526
   
      $m = -\frac{nln(p)}{(ln2)^2}$

      $k=\frac{m}{n}ln(2)$
   ```
   n æ˜¯é¢„æœŸæ’å…¥çš„å…ƒç´ æ•°é‡ï¼ˆæ•°æ®è§„æ¨¡ï¼‰ï¼Œä¾‹å¦‚ 20,000,000ã€‚
   p æ˜¯é¢„æœŸçš„è¯¯åˆ¤ç‡ï¼Œä¾‹å¦‚ 0.001ã€‚
   m æ˜¯ä½æ•°ç»„çš„å¤§å°ã€‚
   k æ˜¯å“ˆå¸Œå‡½æ•°çš„æ•°é‡ã€‚
   ```


---

## äºŒã€æ•°æ®ç»“æ„æ·±åº¦å‰–æ

> æ·±å…¥ç†è§£ Redis äº”ç§æ•°æ®ç±»å‹çš„åº•å±‚å®ç°åŸç†ï¼ŒæŒæ¡å†…å­˜ä¼˜åŒ–æŠ€å·§ã€‚

**å‚è€ƒèµ„æ–™**ï¼š
- [Redis äº”ç§æ•°æ®ç±»å‹åº•å±‚ç»“æ„è¯¦è§£](https://juejin.cn/post/6844904192042074126)
- [Redis è®¾è®¡ä¸å®ç°](http://redisbook.com/)

---

### Hash åº•å±‚å®ç°åŸç†è¯¦è§£

Redis Hash é‡‡ç”¨**ä¸¤ç§ç¼–ç æ–¹å¼**ï¼Œæ ¹æ®æ•°æ®ç‰¹å¾è‡ªåŠ¨é€‰æ‹©ï¼š

#### 1. ç¼–ç é€‰æ‹©ç­–ç•¥

```mermaid
graph LR
    A[åˆ›å»ºHash] --> B{å…ƒç´ æ•°<=512 ä¸” å€¼é•¿åº¦<=64B?}
    B -->|æ˜¯| C[ziplist å‹ç¼©åˆ—è¡¨]
    B -->|å¦| D[hashtable å“ˆå¸Œè¡¨]
    C -->|è¶…è¿‡é˜ˆå€¼| D
    
    style C fill:#e8f5e9
    style D fill:#e1f5fe
```

**é…ç½®å‚æ•°ï¼ˆredis.confï¼‰ï¼š**
```conf
hash-max-ziplist-entries 512   # æœ€å¤§å…ƒç´ ä¸ªæ•°
hash-max-ziplist-value 64       # å•ä¸ªvalueæœ€å¤§é•¿åº¦ï¼ˆå­—èŠ‚ï¼‰
```

#### 2. ziplistï¼ˆå‹ç¼©åˆ—è¡¨ï¼‰- å†…å­˜ä¼˜åŒ–

**é€‚ç”¨åœºæ™¯**ï¼šå°å¯¹è±¡å­˜å‚¨ï¼ˆå¦‚å•†å“è¯¦æƒ…ã€Sessionã€å°å‹ Listï¼‰

ziplist æ˜¯ Redis ä¸ºèŠ‚çœå†…å­˜è®¾è®¡çš„**ç´§å‡‘å‹æ•°æ®ç»“æ„**ï¼Œæ‰€æœ‰æ•°æ®å­˜å‚¨åœ¨**ä¸€å—è¿ç»­çš„å†…å­˜**ä¸­ã€‚

##### 2.1 æ•´ä½“ç»“æ„

```
+----------+----------+--------+---------+---------+-----+---------+--------+
| zlbytes  | zltail   | zllen  | entry1  | entry2  | ... | entryN  | zlend  |
+----------+----------+--------+---------+---------+-----+---------+--------+
  4å­—èŠ‚      4å­—èŠ‚      2å­—èŠ‚    å˜é•¿      å˜é•¿            å˜é•¿      1å­—èŠ‚
```

| å­—æ®µ | é•¿åº¦ | è¯´æ˜ |
|------|------|------|
| **zlbytes** | 4 å­—èŠ‚ | æ•´ä¸ª ziplist å ç”¨çš„æ€»å­—èŠ‚æ•°ï¼ˆåŒ…æ‹¬ zlbytes è‡ªèº«ï¼‰ |
| **zltail** | 4 å­—èŠ‚ | åˆ°å°¾èŠ‚ç‚¹çš„åç§»é‡ï¼ˆç”¨äºå¿«é€Ÿå®šä½å°¾éƒ¨ï¼Œæ”¯æŒåå‘éå†ï¼‰ |
| **zllen** | 2 å­—èŠ‚ | èŠ‚ç‚¹æ•°é‡ï¼Œæœ€å¤§ 65535ï¼›è¶…è¿‡åˆ™éœ€éå†æ•´ä¸ªåˆ—è¡¨è®¡æ•° |
| **entry** | å˜é•¿ | å®é™…æ•°æ®èŠ‚ç‚¹ï¼Œæ¯ä¸ªèŠ‚ç‚¹é•¿åº¦ä¸å›ºå®š |
| **zlend** | 1 å­—èŠ‚ | å›ºå®šä¸º `0xFF`ï¼Œæ ‡è®° ziplist ç»“æŸ |

##### 2.2 Entry èŠ‚ç‚¹è¯¦ç»†ç»“æ„ï¼ˆä¸‰éƒ¨åˆ†ï¼‰

æ¯ä¸ª entry ç”±ä¸‰éƒ¨åˆ†ç»„æˆï¼š

```
+----------+----------+----------+
| prevlen  | encoding | content  |
+----------+----------+----------+
  1æˆ–5å­—èŠ‚   1-5å­—èŠ‚    å˜é•¿
```

###### **Part 1: prevlenï¼ˆå‰ä¸€èŠ‚ç‚¹é•¿åº¦ï¼‰**

è®°å½•**å‰ä¸€ä¸ªèŠ‚ç‚¹çš„é•¿åº¦**ï¼Œç”¨äº**ä»åå‘å‰éå†**ã€‚

```c
// ç¼–ç è§„åˆ™
if (å‰ä¸€èŠ‚ç‚¹é•¿åº¦ < 254 å­—èŠ‚) {
    prevlen = 1 å­—èŠ‚      // ç›´æ¥å­˜å‚¨é•¿åº¦å€¼
} else {
    prevlen = 5 å­—èŠ‚      // ç¬¬1å­—èŠ‚=0xFEï¼Œå4å­—èŠ‚å­˜å®é™…é•¿åº¦
}
```

**ç¤ºä¾‹**ï¼š
- å‰ä¸€èŠ‚ç‚¹ 10 å­—èŠ‚ â†’ `prevlen = 0x0A`ï¼ˆ1å­—èŠ‚ï¼‰
- å‰ä¸€èŠ‚ç‚¹ 300 å­—èŠ‚ â†’ `prevlen = 0xFE 0x00 0x00 0x01 0x2C`ï¼ˆ5å­—èŠ‚ï¼‰

###### **Part 2: encodingï¼ˆç¼–ç ç±»å‹ï¼‰**

è®°å½• **content çš„æ•°æ®ç±»å‹å’Œé•¿åº¦**ï¼ŒRedis ä½¿ç”¨å˜é•¿ç¼–ç èŠ‚çœç©ºé—´ã€‚

**å­—ç¬¦ä¸²ç¼–ç **ï¼ˆå‰ 2 ä½æ ‡è¯†ï¼‰ï¼š

| ç¼–ç æ ¼å¼ | è¯´æ˜ | é•¿åº¦èŒƒå›´ |
|----------|------|----------|
| `00pppppp` | 1å­—èŠ‚ï¼Œå6ä½å­˜é•¿åº¦ | 0 - 63 å­—èŠ‚ |
| `01pppppp qqqqqqqq` | 2å­—èŠ‚ï¼Œ14ä½å­˜é•¿åº¦ | 64 - 16383 å­—èŠ‚ |
| `10______ [4å­—èŠ‚]` | 5å­—èŠ‚ï¼Œåç»­4å­—èŠ‚å­˜é•¿åº¦ | > 16383 å­—èŠ‚ |

**æ•´æ•°ç¼–ç **ï¼ˆå‰ 2 ä½ä¸º `11`ï¼‰ï¼š

| ç¼–ç å€¼ | è¯´æ˜ | æ•°æ®é•¿åº¦ |
|--------|------|----------|
| `11000000` | int16_t | 2 å­—èŠ‚ |
| `11010000` | int32_t | 4 å­—èŠ‚ |
| `11100000` | int64_t | 8 å­—èŠ‚ |
| `11110000` | 24 ä½æ•´æ•° | 3 å­—èŠ‚ |
| `11111110` | 8 ä½æ•´æ•° | 1 å­—èŠ‚ |
| `1111xxxx` | 0-12 çš„æ•´æ•°ç›´æ¥ç¼–ç åœ¨å4ä½ | **0 å­—èŠ‚**ï¼ˆæ—  contentï¼‰ |

###### **Part 3: contentï¼ˆå®é™…æ•°æ®ï¼‰**

å­˜å‚¨å®é™…çš„æ•°æ®å†…å®¹ï¼Œæ ¹æ® `encoding` å­—æ®µè§£æï¼š
- **å­—ç¬¦ä¸²**ï¼šåŸå§‹å­—èŠ‚æ•°ç»„
- **æ•´æ•°**ï¼šäºŒè¿›åˆ¶æ•´æ•°ï¼ˆå°ç«¯åºï¼‰

##### 2.3 å®é™…å†…å­˜å¸ƒå±€ç¤ºä¾‹

å­˜å‚¨ Hashï¼š`{name: "iPhone", price: 5999}`

```
åç§» | å­—æ®µ        | å€¼                  | è¯´æ˜
-----|------------|---------------------|------------------
0-3  | zlbytes    | 0x0000003F (63)     | æ€»å¤§å° 63 å­—èŠ‚
4-7  | zltail     | 0x00000035 (53)     | å°¾èŠ‚ç‚¹åç§» 53
8-9  | zllen      | 0x0004 (4)          | 4ä¸ªèŠ‚ç‚¹ï¼ˆ2 field + 2 valueï¼‰

10   | prevlen    | 0x00                | ç¬¬ä¸€ä¸ªèŠ‚ç‚¹
11   | encoding   | 0x04                | å­—ç¬¦ä¸²é•¿åº¦ 4
12-15| content    | "name"              | field
     | (å…± 6 å­—èŠ‚)

16   | prevlen    | 0x06                | å‰ä¸€èŠ‚ç‚¹ 6 å­—èŠ‚
17   | encoding   | 0x06                | å­—ç¬¦ä¸²é•¿åº¦ 6
18-23| content    | "iPhone"            | value
     | (å…± 8 å­—èŠ‚)

24   | prevlen    | 0x08                | å‰ä¸€èŠ‚ç‚¹ 8 å­—èŠ‚
25   | encoding   | 0x05                | å­—ç¬¦ä¸²é•¿åº¦ 5
26-30| content    | "price"             | field
     | (å…± 7 å­—èŠ‚)

31   | prevlen    | 0x07                | å‰ä¸€èŠ‚ç‚¹ 7 å­—èŠ‚
32   | encoding   | 0xC0                | int16_t
33-34| content    | 0x176F (5999)       | valueï¼ˆæ•´æ•°ä¼˜åŒ–ï¼‰
     | (å…± 4 å­—èŠ‚)

35   | zlend      | 0xFF                | ç»“æŸæ ‡è®°
```

**å†…å­˜è®¡ç®—**ï¼š10ï¼ˆå¤´ï¼‰+ 6 + 8 + 7 + 4 + 1ï¼ˆå°¾ï¼‰= **36 å­—èŠ‚**

##### 2.4 éå†æœºåˆ¶

**æ­£å‘éå†ï¼ˆä»å¤´åˆ°å°¾ï¼‰**ï¼š
```c
ptr = ziplist + 10;  // è·³è¿‡å¤´éƒ¨
while (*ptr != 0xFF) {
    // è§£æ encodingï¼Œè®¡ç®—èŠ‚ç‚¹é•¿åº¦
    node_len = prevlen_size + encoding_size + content_size;
    ptr += node_len;  // è·³åˆ°ä¸‹ä¸€ä¸ªèŠ‚ç‚¹
}
```

**åå‘éå†ï¼ˆä»å°¾åˆ°å¤´ï¼‰**ï¼š
```c
ptr = ziplist + zltail;  // ç›´æ¥å®šä½å°¾èŠ‚ç‚¹
while (ptr > ziplist + 10) {
    prevlen = parse_prevlen(ptr);  // è¯»å– prevlen
    ptr -= prevlen;  // è·³åˆ°å‰ä¸€ä¸ªèŠ‚ç‚¹
}
```

##### 2.5 è¿é”æ›´æ–°é—®é¢˜ï¼ˆCascade Updateï¼‰

**é—®é¢˜**ï¼šæ’å…¥/åˆ é™¤èŠ‚ç‚¹å¯èƒ½å¯¼è‡´åç»­èŠ‚ç‚¹çš„ `prevlen` å­—æ®µé•¿åº¦å˜åŒ–ã€‚

**åœºæ™¯ç¤ºä¾‹**ï¼š
```
åˆå§‹çŠ¶æ€ï¼š[253B] [253B] [253B]
          æ¯ä¸ªèŠ‚ç‚¹çš„ prevlen å  1 å­—èŠ‚

æ’å…¥å¤§èŠ‚ç‚¹ï¼š[253B] [260B] [???] [???]
                     â†‘
          å‰ä¸€èŠ‚ç‚¹å˜ä¸º 260 å­—èŠ‚ (>254)
          å½“å‰èŠ‚ç‚¹çš„ prevlen éœ€ä» 1 å­—èŠ‚æ‰©å±•ä¸º 5 å­—èŠ‚
          å½“å‰èŠ‚ç‚¹é•¿åº¦ä» 253 â†’ 257 å­—èŠ‚
          ä¸‹ä¸€ä¸ªèŠ‚ç‚¹çš„ prevlen ä¹Ÿéœ€æ‰©å±•...
```

**å½±å“**ï¼š
- **æœ€åæ—¶é—´å¤æ‚åº¦**ï¼šO(nÂ²)ï¼ˆæ‰€æœ‰èŠ‚ç‚¹è¿é”æ›´æ–°ï¼‰
- **å†…å­˜é‡åˆ†é…**ï¼šè¿ç»­çš„ `realloc` æ“ä½œ
- **å®é™…æ¦‚ç‡**ï¼šæä½ï¼ˆéœ€è¦å¤§é‡èŠ‚ç‚¹åˆšå¥½åœ¨ 254 å­—èŠ‚è¾¹ç•Œï¼‰

**Redis ä¼˜åŒ–**ï¼š
- é¢„å…ˆæ£€æŸ¥æ˜¯å¦ä¼šè§¦å‘è¿é”æ›´æ–°
- ä¸€æ¬¡æ€§åˆ†é…è¶³å¤Ÿå†…å­˜ï¼Œå‡å°‘ `realloc` æ¬¡æ•°

##### 2.6 ç¼–ç ç¤ºä¾‹ï¼ˆGo ä»£ç ï¼‰

```go
// ç¤ºä¾‹ï¼šå­—ç¬¦ä¸² "hello" çš„ encoding
// é•¿åº¦ 5 < 63ï¼Œä½¿ç”¨ 00pppppp æ ¼å¼
encoding := 0b00000101  // 0x05

// ç¤ºä¾‹ï¼šæ•´æ•° 100 çš„ encoding
// èŒƒå›´åœ¨ int16 å†…ï¼Œä½¿ç”¨ 11000000
encoding := 0b11000000  // 0xC0
content := []byte{0x64, 0x00}  // å°ç«¯åº 100

// ç¤ºä¾‹ï¼šæ•´æ•° 12 çš„ encoding
// 0-12 ç›´æ¥ç¼–ç åœ¨ encoding ä¸­
encoding := 0b11111100  // 0xFCï¼Œå4ä½ 1100 = 12
// æ— éœ€ content å­—æ®µï¼
```

##### 2.7 ä¼˜åŠ¿ä¸é™åˆ¶

**âœ… ä¼˜åŠ¿**ï¼š
- **å†…å­˜é«˜æ•ˆ**ï¼šæ— æŒ‡é’ˆå¼€é”€ï¼Œç´§å‡‘å­˜å‚¨
  - å¯¹æ¯”é“¾è¡¨ï¼šæ¯ä¸ªèŠ‚ç‚¹çœ 16 å­—èŠ‚ï¼ˆprev + next æŒ‡é’ˆï¼‰
- **CPU ç¼“å­˜å‹å¥½**ï¼šè¿ç»­å†…å­˜ï¼Œé¢„è¯»ä¼˜åŒ–
- **æ™ºèƒ½ç¼–ç **ï¼šæ•´æ•°å‹ç¼©ã€å˜é•¿å­˜å‚¨
- **åŒå‘éå†**ï¼šé€šè¿‡ `zltail` å’Œ `prevlen` å®ç°

**âŒ é™åˆ¶**ï¼š
- **æŸ¥æ‰¾æ…¢**ï¼šO(n) é¡ºåºéå†ï¼Œä¸é€‚åˆå¤§æ•°æ®
- **è¿é”æ›´æ–°**ï¼šæœ€å O(nÂ²)ï¼ˆå®é™…å¾ˆå°‘å‘ç”Ÿï¼‰
- **å†…å­˜é‡åˆ†é…**ï¼šæ’å…¥/åˆ é™¤éœ€ `realloc`
- **é»˜è®¤é˜ˆå€¼**ï¼š
  - Hash: 512 entries
  - List: 512 entries
  - ZSet: 128 entries

##### 2.8 åº”ç”¨åœºæ™¯æ€»ç»“

| æ•°æ®ç±»å‹ | ä½¿ç”¨ ziplist æ¡ä»¶ | å…¸å‹åœºæ™¯ |
|----------|-------------------|----------|
| **Hash** | entries â‰¤ 512, value â‰¤ 64B | å•†å“åŸºç¡€ä¿¡æ¯ã€ç”¨æˆ· Session |
| **List** | entries â‰¤ 512 | æ¶ˆæ¯é˜Ÿåˆ—ã€æµè§ˆå†å² |
| **ZSet** | entries â‰¤ 128, member â‰¤ 64B | å°å‹æ’è¡Œæ¦œã€ä¼˜å…ˆé˜Ÿåˆ— |

**ç›‘æ§å‘½ä»¤**ï¼š
```bash
# æŸ¥çœ‹ç¼–ç ç±»å‹
redis> OBJECT ENCODING mykey
"ziplist"

# æŸ¥çœ‹å†…å­˜å ç”¨
redis> MEMORY USAGE mykey
(integer) 184

# æŸ¥çœ‹ ziplist è¯¦ç»†ä¿¡æ¯ï¼ˆDEBUG å‘½ä»¤ï¼‰
redis> DEBUG OBJECT mykey
Value at:0x7f8a9c0a0a00 refcount:1 encoding:ziplist serializedlength:48
```

#### 3. hashtableï¼ˆå“ˆå¸Œè¡¨ï¼‰- æ€§èƒ½ä¼˜åŒ–

**é€‚ç”¨åœºæ™¯**ï¼šå¤§é‡å­—æ®µæˆ–éœ€è¦å¿«é€ŸæŸ¥æ‰¾

**æ ¸å¿ƒç»“æ„**ï¼šç»å…¸æ‹‰é“¾æ³•å“ˆå¸Œè¡¨

```c
// Redis å­—å…¸ç»“æ„ï¼ˆdictï¼‰
typedef struct dict {
    dictht ht[2];        // ä¸¤ä¸ªå“ˆå¸Œè¡¨ï¼Œht[1] ç”¨äº rehash
    long rehashidx;      // rehash è¿›åº¦ï¼Œ-1 è¡¨ç¤ºæœªè¿›è¡Œ
} dict;

// å“ˆå¸Œè¡¨ç»“æ„ï¼ˆdicthtï¼‰
typedef struct dictht {
    dictEntry **table;   // å“ˆå¸Œè¡¨æ•°ç»„ï¼ˆæŒ‡é’ˆæ•°ç»„ï¼‰
    unsigned long size;  // å¤§å°ï¼ˆ2çš„å¹‚æ¬¡æ–¹ï¼‰
    unsigned long used;  // å·²æœ‰èŠ‚ç‚¹æ•°
} dictht;

// å“ˆå¸ŒèŠ‚ç‚¹ï¼ˆdictEntryï¼‰
typedef struct dictEntry {
    void *key;           // é”®
    void *value;         // å€¼
    struct dictEntry *next;  // é“¾è¡¨æŒ‡é’ˆï¼ˆè§£å†³å†²çªï¼‰
} dictEntry;
```

**å¯è§†åŒ–ç»“æ„**ï¼šè¯¦è§ [redis-hashtable.mmd](/diagrams/mermaid/redis-hashtable.mmd)

```
dict
â”œâ”€â”€ ht[0] (ä¸»å“ˆå¸Œè¡¨)
â”‚   â”œâ”€â”€ table[0] â†’ NULL
â”‚   â”œâ”€â”€ table[1] â†’ entry(name:iPhone) â†’ NULL
â”‚   â”œâ”€â”€ table[2] â†’ entry(price:5999) â†’ entry(stock:100) â†’ NULL  (æ‹‰é“¾æ³•)
â”‚   â””â”€â”€ ...
â””â”€â”€ ht[1] (rehashç”¨)
    â””â”€â”€ NULL (æœªä½¿ç”¨)
```

#### 4. æ¸è¿›å¼ Rehash æœºåˆ¶ï¼ˆæ ¸å¿ƒï¼‰

**è§¦å‘æ¡ä»¶**ï¼š
```c
// æ‰©å®¹
1. è´Ÿè½½å› å­ = used/size >= 1 (æ— BGSAVE/BGREWRITEAOFæ—¶)
2. è´Ÿè½½å› å­ >= 5 (å¼ºåˆ¶æ‰©å®¹)

// ç¼©å®¹
è´Ÿè½½å› å­ < 0.1
```

**æ¸è¿›å¼ Rehash æµç¨‹**ï¼š
1. ä¸º `ht[1]` åˆ†é…ç©ºé—´ï¼ˆæ‰©å®¹ä¸º `used * 2` çš„æœ€å° 2^nï¼‰
2. `rehashidx = 0` å¼€å§‹è¿ç§»
3. **æ¯æ¬¡å¢åˆ æ”¹æŸ¥æ“ä½œæ—¶**ï¼Œé¡ºå¸¦è¿ç§» `ht[0].table[rehashidx]` çš„æ‰€æœ‰æ•°æ®åˆ° `ht[1]`
4. å…¨éƒ¨è¿ç§»å®Œæˆåï¼Œé‡Šæ”¾ `ht[0]`ï¼Œå°† `ht[1]` è®¾ä¸º `ht[0]`

**å¯è§†åŒ–æµç¨‹**ï¼šè¯¦è§ [redis-rehash-process.mmd](/diagrams/mermaid/redis-rehash-process.mmd)

**Rehash æœŸé—´çš„æ“ä½œ**ï¼š
```c
æŸ¥æ‰¾ï¼šå…ˆæŸ¥ ht[0]ï¼Œæœªæ‰¾åˆ°å†æŸ¥ ht[1]
æ–°å¢ï¼šç›´æ¥å†™å…¥ ht[1]ï¼ˆæ–°æ•°æ®ä¸è¿›æ—§è¡¨ï¼‰
åˆ é™¤/æ›´æ–°ï¼šåœ¨ ht[0] æˆ– ht[1] ä¸­æ‰¾åˆ°åæ“ä½œ
```

**ä¸ºä»€ä¹ˆç”¨æ¸è¿›å¼ï¼Ÿ**
- é¿å…ä¸€æ¬¡æ€§ rehash å¤§é‡æ•°æ®å¯¼è‡´ Redis é˜»å¡ï¼ˆæ¯«ç§’çº§â†’å¾®ç§’çº§ï¼‰
- åˆ†æ‘Šåˆ°æ¯æ¬¡æ“ä½œä¸­ï¼Œå¯¹å•æ¬¡è¯·æ±‚å½±å“æå°

#### 5. å“ˆå¸Œå‡½æ•°

```c
// Redis ä½¿ç”¨ MurmurHash2ï¼ˆé€Ÿåº¦å¿«ã€åˆ†å¸ƒå‡åŒ€ï¼‰
hash = MurmurHash2(key, len);
index = hash & dict->ht[x].sizemask;  // ä½è¿ç®—ä»£æ›¿å–æ¨¡ï¼Œæ€§èƒ½ä¼˜
```

#### 6. æ€§èƒ½å¯¹æ¯”

| æ“ä½œ | ziplist | hashtable |
|------|---------|-----------|
| HSET | O(n) | O(1) å¹³å‡ |
| HGET | O(n) | O(1) å¹³å‡ |
| HDEL | O(n) | O(1) å¹³å‡ |
| HGETALL | O(n) | O(n) |
| å†…å­˜å ç”¨ | **ä½**ï¼ˆæ— æŒ‡é’ˆï¼‰ | **é«˜**ï¼ˆæŒ‡é’ˆ+ç©ºé—´æ¢æ—¶é—´ï¼‰ |
| CPUç¼“å­˜ | **å‹å¥½**ï¼ˆè¿ç»­ï¼‰ | ä¸€èˆ¬ï¼ˆéšæœºè®¿é—®ï¼‰ |
| é€‚ç”¨åœºæ™¯ | < 512å­—æ®µå°å¯¹è±¡ | å¤§é‡å­—æ®µå¿«é€ŸæŸ¥æ‰¾ |

#### 7. ç”µå•†åœºæ™¯æœ€ä½³å®è·µ

```go
// âœ… æ¨èï¼šå•†å“è¯¦æƒ…ç¼“å­˜ï¼ˆå­—æ®µé€‚ä¸­ï¼Œé¢‘ç¹éƒ¨åˆ†æ›´æ–°ï¼‰
rdb.HSet(ctx, "product:1001", map[string]interface{}{
    "name":      "iPhone 15",
    "price":     "5999",
    "stock":     "100",
    "seller_id": "10086",
})

// åªæ›´æ–°åº“å­˜ï¼Œæ— éœ€è¯»å–æ•´ä¸ªå¯¹è±¡
rdb.HIncrBy(ctx, "product:1001", "stock", -1)

// âœ… æ¨èï¼šç”¨æˆ· Session å­˜å‚¨
rdb.HSet(ctx, "session:abc123", "uid", "88888")
rdb.HSet(ctx, "session:abc123", "role", "buyer")
rdb.Expire(ctx, "session:abc123", 30*time.Minute)

// âŒ é¿å…ï¼šå¤§ Hashï¼ˆ> 10000 å­—æ®µï¼‰
// é—®é¢˜ï¼šHGETALL é˜»å¡ã€é›†ç¾¤æ•°æ®å€¾æ–œã€æŒä¹…åŒ–æ…¢
// è§£å†³ï¼šæ‹†åˆ†ä¸ºå¤šä¸ªå° Hashï¼Œå¦‚ product:1001:baseã€product:1001:detail
```

#### 8. Hash vs String(JSON)

| ç»´åº¦ | Hash | String (JSON) |
|------|------|---------------|
| å†…å­˜ | ziplist æ¨¡å¼æ›´çœ | JSON åºåˆ—åŒ–å¼€é”€å¤§ |
| éƒ¨åˆ†æ›´æ–° | âœ… `HSET field` | âŒ éœ€æ•´ä½“ GETâ†’æ”¹â†’SET |
| åºåˆ—åŒ– | æ— éœ€åºåˆ—åŒ– | éœ€ JSON ç¼–è§£ç ï¼ˆCPUå¼€é”€ï¼‰ |
| æŸ¥è¯¢çµæ´»æ€§ | `HMGET` ç²¾ç¡®å–å­—æ®µ | `GET` æ•´ä½“å–å‡º |
| é€‚ç”¨åœºæ™¯ | é¢‘ç¹éƒ¨åˆ†å­—æ®µæ›´æ–° | æ•´ä½“è¯»å†™ã€å¤æ‚åµŒå¥—ç»“æ„ |

**é€‰æ‹©å»ºè®®**ï¼š
- **ç”¨ Hash**ï¼šå¯¹è±¡å­—æ®µ < 1000ï¼Œéœ€è¦å•ç‹¬è¯»å†™æŸäº›å­—æ®µï¼ˆå¦‚åº“å­˜ï¼‰
- **ç”¨ String**ï¼šå¯¹è±¡ç»“æ„å¤æ‚åµŒå¥—ï¼ˆJSONï¼‰ï¼Œæ•´ä½“è¯»å†™å±…å¤š

#### 9. ç›‘æ§ä¸è°ƒä¼˜

```bash
# 1. æŸ¥æ‰¾å¤§ key
redis-cli --bigkeys

# 2. æŸ¥çœ‹ Hash ç¼–ç 
redis-cli> OBJECT ENCODING product:1001
"ziplist"  # æˆ– "hashtable"

# 3. æŸ¥çœ‹å†…å­˜å ç”¨
redis-cli> MEMORY USAGE product:1001
(integer) 184

# 4. è°ƒæ•´ç¼–ç é˜ˆå€¼ï¼ˆæ ¹æ®ä¸šåŠ¡è°ƒæ•´ï¼‰
CONFIG SET hash-max-ziplist-entries 1024
CONFIG SET hash-max-ziplist-value 128
```

---

### String åº•å±‚å®ç°

#### String/SDS æ ¸å¿ƒç»“æ„

Redis String å®é™…æ˜¯ **SDSï¼ˆSimple Dynamic Stringï¼‰**ï¼Œè€Œé C å­—ç¬¦ä¸²ã€‚

#### SDS ç»“æ„

```c
struct sdshdr {
    int len;        // å·²ä½¿ç”¨é•¿åº¦
    int free;       // å‰©ä½™å¯ç”¨ç©ºé—´
    char buf[];     // å®é™…æ•°æ®
};
```

#### ä¼˜åŠ¿å¯¹æ¯”

| ç‰¹æ€§ | C å­—ç¬¦ä¸² | SDS |
|------|----------|-----|
| è·å–é•¿åº¦ | O(n) éå† | O(1) ç›´æ¥è¯» len |
| ç¼“å†²åŒºæº¢å‡º | ä¸æ£€æŸ¥ï¼Œæ˜“æº¢å‡º | è‡ªåŠ¨æ‰©å®¹ï¼Œå®‰å…¨ |
| å†…å­˜é‡åˆ†é… | æ¯æ¬¡éƒ½éœ€è¦ | ç©ºé—´é¢„åˆ†é… + æƒ°æ€§é‡Šæ”¾ |
| äºŒè¿›åˆ¶å®‰å…¨ | å¦ï¼ˆé‡ `\0` ç»“æŸï¼‰ | æ˜¯ï¼ˆè®°å½•é•¿åº¦ï¼‰ |

#### ç¼–ç ç±»å‹

String æœ‰ 3 ç§ç¼–ç ï¼š

```bash
# 1. int ç¼–ç ï¼ˆæ•´æ•°ï¼‰
SET count 100
OBJECT ENCODING count  # "int"

# 2. embstr ç¼–ç ï¼ˆçŸ­å­—ç¬¦ä¸² â‰¤ 44 å­—èŠ‚ï¼‰
SET short "hello"
OBJECT ENCODING short  # "embstr"

# 3. raw ç¼–ç ï¼ˆé•¿å­—ç¬¦ä¸² > 44 å­—èŠ‚ï¼‰
SET long "very long string..."
OBJECT ENCODING long  # "raw"
```

**embstr vs raw**ï¼š
- **embstr**ï¼šSDS å’Œ redisObject åœ¨è¿ç»­å†…å­˜ï¼ˆä¸€æ¬¡åˆ†é…ï¼‰
- **raw**ï¼šSDS å’Œ redisObject åˆ†å¼€åˆ†é…ï¼ˆä¸¤æ¬¡åˆ†é…ï¼‰

#### åº”ç”¨åœºæ™¯

```go
// 1. è®¡æ•°å™¨
rdb.Incr(ctx, "page:views")

// 2. åˆ†å¸ƒå¼ ID ç”Ÿæˆ
id := rdb.Incr(ctx, "order:id").Val()

// 3. é™æµï¼ˆå›ºå®šçª—å£ï¼‰
count := rdb.Incr(ctx, "limit:user:123").Val()
if count == 1 {
    rdb.Expire(ctx, "limit:user:123", 60*time.Second)
}
if count > 100 {
    return ErrRateLimited
}

// 4. Session å­˜å‚¨
rdb.Set(ctx, "session:token_abc", userJSON, 30*time.Minute)
```

---

### List åº•å±‚å®ç°

List åœ¨ Redis 3.2 ä¹‹å‰ä½¿ç”¨ **ziplist** æˆ– **linkedlist**ï¼Œ3.2+ ç»Ÿä¸€ä½¿ç”¨ **quicklist**ã€‚

#### quicklist ç»“æ„

```
quicklist = ziplist é“¾è¡¨

[ziplist1] â‡„ [ziplist2] â‡„ [ziplist3] â‡„ [ziplist4]
    â†“             â†“             â†“             â†“
  [a,b,c]      [d,e,f]      [g,h,i]      [j,k,l]
```

**è®¾è®¡æ€æƒ³**ï¼š
- **ziplist**ï¼šå†…å­˜ç´§å‡‘ï¼Œä½†å¤§é‡æ•°æ®æ—¶æ€§èƒ½å·®
- **linkedlist**ï¼šæ’å…¥å¿«ï¼Œä½†å†…å­˜ç¢ç‰‡å¤š
- **quicklist**ï¼šæŠ˜ä¸­æ–¹æ¡ˆï¼Œæ¯ä¸ªèŠ‚ç‚¹æ˜¯ä¸€ä¸ªå° ziplist

#### é…ç½®å‚æ•°

```conf
# æ¯ä¸ª ziplist çš„æœ€å¤§å¤§å°ï¼ˆå­—èŠ‚ï¼‰
list-max-ziplist-size -2  # -2 è¡¨ç¤º 8KB

# ä¸¤ç«¯ä¸å‹ç¼©çš„èŠ‚ç‚¹æ•°ï¼ˆLZF å‹ç¼©ï¼‰
list-compress-depth 0  # 0 è¡¨ç¤ºä¸å‹ç¼©
```

#### åº”ç”¨åœºæ™¯

```go
// 1. æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆFIFOï¼‰
rdb.LPush(ctx, "queue:tasks", task1, task2)  // ç”Ÿäº§è€…
task := rdb.RPop(ctx, "queue:tasks")         // æ¶ˆè´¹è€…

// 2. æœ€è¿‘æµè§ˆè®°å½•ï¼ˆLIFOï¼‰
rdb.LPush(ctx, "user:123:history", productID)
rdb.LTrim(ctx, "user:123:history", 0, 9)  // åªä¿ç•™æœ€æ–° 10 æ¡

// 3. æ—¶é—´çº¿ï¼ˆTimelineï¼‰
rdb.LPush(ctx, "timeline:user:123", postID)
posts := rdb.LRange(ctx, "timeline:user:123", 0, 19)  // æœ€æ–° 20 æ¡

// 4. é˜»å¡é˜Ÿåˆ—ï¼ˆBRPOPï¼‰
task := rdb.BRPop(ctx, 5*time.Second, "queue:tasks")  // é˜»å¡ç­‰å¾…
```

#### æ€§èƒ½å¯¹æ¯”

| æ“ä½œ | æ—¶é—´å¤æ‚åº¦ | è¯´æ˜ |
|------|-----------|------|
| LPUSH/RPUSH | O(1) | å¤´å°¾æ’å…¥ |
| LPOP/RPOP | O(1) | å¤´å°¾å¼¹å‡º |
| LINDEX | O(n) | æŒ‰ç´¢å¼•æŸ¥è¯¢ |
| LRANGE | O(n) | èŒƒå›´æŸ¥è¯¢ |
| LINSERT | O(n) | ä¸­é—´æ’å…¥ |

---

### Set åº•å±‚å®ç°

Set ä½¿ç”¨ **intset** æˆ– **hashtable** ç¼–ç ã€‚

#### intsetï¼ˆæ•´æ•°é›†åˆï¼‰

**é€‚ç”¨æ¡ä»¶**ï¼š
- æ‰€æœ‰å…ƒç´ éƒ½æ˜¯æ•´æ•°
- å…ƒç´ æ•°é‡ â‰¤ 512ï¼ˆ`set-max-intset-entries`ï¼‰

**ç»“æ„**ï¼š
```c
typedef struct intset {
    uint32_t encoding;  // INTSET_ENC_INT16/INT32/INT64
    uint32_t length;    // å…ƒç´ æ•°é‡
    int8_t contents[];  // æœ‰åºæ•°ç»„
};
```

**ç‰¹ç‚¹**ï¼š
- âœ… æœ‰åºå­˜å‚¨ï¼ŒäºŒåˆ†æŸ¥æ‰¾ O(log n)
- âœ… å†…å­˜ç´§å‡‘
- âŒ æ’å…¥/åˆ é™¤éœ€ç§»åŠ¨å…ƒç´  O(n)

#### åº”ç”¨åœºæ™¯

```go
// 1. æ ‡ç­¾ç³»ç»Ÿ
rdb.SAdd(ctx, "user:123:tags", "VIP", "ç”·æ€§", "90å")
tags := rdb.SMembers(ctx, "user:123:tags")

// 2. å…±åŒå¥½å‹
rdb.SAdd(ctx, "user:123:friends", "456", "789")
rdb.SAdd(ctx, "user:456:friends", "123", "789")
common := rdb.SInter(ctx, "user:123:friends", "user:456:friends")  // [789]

// 3. å»é‡ï¼ˆæŠ½å¥–æ± ï¼‰
rdb.SAdd(ctx, "lottery:pool", userIDs...)
winner := rdb.SPop(ctx, "lottery:pool")  // éšæœºæŠ½å–

// 4. ç‚¹èµç”¨æˆ·åˆ—è¡¨
rdb.SAdd(ctx, "post:1001:likes", "user:123")
isLiked := rdb.SIsMember(ctx, "post:1001:likes", "user:123")
likeCount := rdb.SCard(ctx, "post:1001:likes")
```

---

### ZSet åº•å±‚å®ç°

ZSet ä½¿ç”¨ **ziplist** æˆ– **skiplist + hashtable** ç¼–ç ã€‚

#### ziplist ç¼–ç 

**æ¡ä»¶**ï¼š
- å…ƒç´ æ•°é‡ â‰¤ 128ï¼ˆ`zset-max-ziplist-entries`ï¼‰
- å•ä¸ªå…ƒç´  â‰¤ 64 å­—èŠ‚ï¼ˆ`zset-max-ziplist-value`ï¼‰

**å­˜å‚¨æ ¼å¼**ï¼š
```
[member1, score1, member2, score2, ...]
æŒ‰ score æœ‰åºå­˜å‚¨
```

#### skiplist + hashtable ç¼–ç 

**ä¸ºä»€ä¹ˆç”¨ä¸¤ç§ç»“æ„ï¼Ÿ**
- **skiplist**ï¼šæŒ‰ score æœ‰åºï¼ŒèŒƒå›´æŸ¥è¯¢ O(log n)
- **hashtable**ï¼šæŒ‰ member æŸ¥æ‰¾ï¼ŒO(1) è·å– score

**skiplist ç»“æ„**ï¼š
```
Level 3:  1 --------------------------------> 100
Level 2:  1 -------> 50 -------------------> 100
Level 1:  1 --> 25 > 50 --> 75 ------------> 100
Level 0:  1 > 10 > 25 > 50 > 75 > 90 > 100
```

å¹³å‡æŸ¥æ‰¾å¤æ‚åº¦ï¼šO(log n)

#### åº”ç”¨åœºæ™¯

```go
// 1. æ’è¡Œæ¦œ
rdb.ZAdd(ctx, "rank:score", &redis.Z{Score: 5999, Member: "user:123"})
top10 := rdb.ZRevRange(ctx, "rank:score", 0, 9)  // å‰ 10 å

// 2. å»¶æ—¶é˜Ÿåˆ—
rdb.ZAdd(ctx, "delay:queue", &redis.Z{
    Score:  float64(time.Now().Add(5*time.Minute).Unix()),
    Member: taskID,
})
// å®šæ—¶æ‹‰å–åˆ°æœŸä»»åŠ¡
tasks := rdb.ZRangeByScore(ctx, "delay:queue", &redis.ZRangeBy{
    Min: "0",
    Max: strconv.Itoa(int(time.Now().Unix())),
})

// 3. æƒé‡æ¨è
rdb.ZAdd(ctx, "recommend:user:123", &redis.Z{Score: 0.95, Member: "item:1001"})
recommended := rdb.ZRevRangeByScore(ctx, "recommend:user:123", &redis.ZRangeBy{
    Min: "0.8",
    Max: "+inf",
    Count: 10,
})

// 4. å¾®ä¿¡æ­¥æ•°æ’è¡Œæ¦œ
rdb.ZAdd(ctx, "steps:2026-01-08", &redis.Z{Score: 10000, Member: "user:123"})
myRank := rdb.ZRevRank(ctx, "steps:2026-01-08", "user:123")  // æˆ‘çš„æ’å
```

---

## ä¸‰ã€ç¼“å­˜è®¾è®¡ä¸å®è·µ

> æŒæ¡ç¼“å­˜ä½¿ç”¨æ¨¡å¼ã€ä¸€è‡´æ€§æ–¹æ¡ˆã€å¼‚å¸¸å¤„ç†ç­–ç•¥ï¼Œæ„å»ºé«˜å¯ç”¨ç¼“å­˜ç³»ç»Ÿã€‚

---

### ç¼“å­˜å®¹é‡è§„åˆ’ä¸å†…å­˜ç®¡ç†

#### å†…å­˜æ·˜æ±°ç­–ç•¥
```
- noeviction(é»˜è®¤ç­–ç•¥)ï¼šå¯¹äºå†™è¯·æ±‚ä¸å†æä¾›æœåŠ¡ï¼Œç›´æ¥è¿”å›é”™è¯¯ï¼ˆDELè¯·æ±‚å’Œéƒ¨åˆ†ç‰¹æ®Šè¯·æ±‚é™¤å¤–ï¼‰
- allkeys-lruï¼šä»æ‰€æœ‰keyä¸­ä½¿ç”¨LRUç®—æ³•è¿›è¡Œæ·˜æ±°
- volatile-lruï¼šä»è®¾ç½®äº†è¿‡æœŸæ—¶é—´çš„keyä¸­ä½¿ç”¨LRUç®—æ³•è¿›è¡Œæ·˜æ±°
- allkeys-randomï¼šä»æ‰€æœ‰keyä¸­éšæœºæ·˜æ±°æ•°æ®
- volatile-randomï¼šä»è®¾ç½®äº†è¿‡æœŸæ—¶é—´çš„keyä¸­éšæœºæ·˜æ±°
- volatile-ttlï¼šåœ¨è®¾ç½®äº†è¿‡æœŸæ—¶é—´çš„keyä¸­ï¼Œæ ¹æ®keyçš„è¿‡æœŸæ—¶é—´è¿›è¡Œæ·˜æ±°ï¼Œè¶Šæ—©è¿‡æœŸçš„è¶Šä¼˜å…ˆè¢«æ·˜æ±°
LFUç®—æ³•æ˜¯Redis4.0é‡Œé¢æ–°åŠ çš„ä¸€ç§æ·˜æ±°ç­–ç•¥ã€‚å®ƒçš„å…¨ç§°æ˜¯Least Frequently Used

```
[redis å†…å­˜æ·˜æ±°ç­–ç•¥è§£æ](https://juejin.cn/post/6844903927037558792)

### è¿‡æœŸé”®åˆ é™¤ç­–ç•¥

è¿‡æœŸç­–ç•¥é€šå¸¸æœ‰ä»¥ä¸‹ä¸‰ç§ï¼š
- å®šæ—¶è¿‡æœŸï¼šæ¯ä¸ªè®¾ç½®è¿‡æœŸæ—¶é—´çš„keyéƒ½éœ€è¦åˆ›å»ºä¸€ä¸ªå®šæ—¶å™¨ï¼Œåˆ°è¿‡æœŸæ—¶é—´å°±ä¼šç«‹å³æ¸…é™¤ã€‚è¯¥ç­–ç•¥å¯ä»¥ç«‹å³æ¸…é™¤è¿‡æœŸçš„æ•°æ®ï¼Œå¯¹å†…å­˜å¾ˆå‹å¥½ï¼›ä½†æ˜¯ä¼šå ç”¨å¤§é‡çš„CPUèµ„æºå»å¤„ç†è¿‡æœŸçš„æ•°æ®ï¼Œä»è€Œå½±å“ç¼“å­˜çš„å“åº”æ—¶é—´å’Œååé‡ã€‚
- æƒ°æ€§è¿‡æœŸï¼šåªæœ‰å½“è®¿é—®ä¸€ä¸ªkeyæ—¶ï¼Œæ‰ä¼šåˆ¤æ–­è¯¥keyæ˜¯å¦å·²è¿‡æœŸï¼Œè¿‡æœŸåˆ™æ¸…é™¤ã€‚è¯¥ç­–ç•¥å¯ä»¥æœ€å¤§åŒ–åœ°èŠ‚çœCPUèµ„æºï¼Œå´å¯¹å†…å­˜éå¸¸ä¸å‹å¥½ã€‚æç«¯æƒ…å†µå¯èƒ½å‡ºç°å¤§é‡çš„è¿‡æœŸkeyæ²¡æœ‰å†æ¬¡è¢«è®¿é—®ï¼Œä»è€Œä¸ä¼šè¢«æ¸…é™¤ï¼Œå ç”¨å¤§é‡å†…å­˜ã€‚
- å®šæœŸè¿‡æœŸï¼šæ¯éš”ä¸€å®šçš„æ—¶é—´ï¼Œä¼šæ‰«æä¸€å®šæ•°é‡çš„æ•°æ®åº“çš„expireså­—å…¸ä¸­ä¸€å®šæ•°é‡çš„keyï¼Œå¹¶æ¸…é™¤å…¶ä¸­å·²è¿‡æœŸçš„keyã€‚è¯¥ç­–ç•¥æ˜¯å‰ä¸¤è€…çš„ä¸€ä¸ªæŠ˜ä¸­æ–¹æ¡ˆã€‚é€šè¿‡è°ƒæ•´å®šæ—¶æ‰«æçš„æ—¶é—´é—´éš”å’Œæ¯æ¬¡æ‰«æçš„é™å®šè€—æ—¶ï¼Œå¯ä»¥åœ¨ä¸åŒæƒ…å†µä¸‹ä½¿å¾—CPUå’Œå†…å­˜èµ„æºè¾¾åˆ°æœ€ä¼˜çš„å¹³è¡¡æ•ˆæœã€‚
(expireså­—å…¸ä¼šä¿å­˜æ‰€æœ‰è®¾ç½®äº†è¿‡æœŸæ—¶é—´çš„keyçš„è¿‡æœŸæ—¶é—´æ•°æ®ï¼Œå…¶ä¸­ï¼Œkeyæ˜¯æŒ‡å‘é”®ç©ºé—´ä¸­çš„æŸä¸ªé”®çš„æŒ‡é’ˆï¼Œvalueæ˜¯è¯¥é”®çš„æ¯«ç§’ç²¾åº¦çš„UNIXæ—¶é—´æˆ³è¡¨ç¤ºçš„è¿‡æœŸæ—¶é—´ã€‚é”®ç©ºé—´æ˜¯æŒ‡è¯¥Redisé›†ç¾¤ä¸­ä¿å­˜çš„æ‰€æœ‰é”®ã€‚)


---

## å››ã€é«˜çº§ç‰¹æ€§

> æŒæ¡æŒä¹…åŒ–ã€åˆ†å¸ƒå¼æ¶æ„ã€Lua è„šæœ¬ç­‰é«˜çº§ç‰¹æ€§ï¼Œæ„å»ºç”Ÿäº§çº§ Redis ç³»ç»Ÿã€‚

---

### æŒä¹…åŒ–æœºåˆ¶ï¼ˆRDBã€AOFï¼‰

Redis æä¾›ä¸¤ç§æŒä¹…åŒ–æ–¹æ¡ˆï¼š

- **RDB (Redis DataBase)**ï¼šå¿«ç…§æ–¹å¼ï¼Œç´§å‡‘çš„äºŒè¿›åˆ¶æ•°æ®
- **AOF (Append Only File)**ï¼šè¿½åŠ æ—¥å¿—æ–¹å¼ï¼Œè®°å½•æ‰€æœ‰å†™æ“ä½œ

**è¯¦ç»†å¯¹æ¯”**ï¼š[RedisæŒä¹…åŒ–åŸç†](http://kaito-kidd.com/2020/06/29/redis-persistence-rdb-aof/)


---

### æœ¬åœ°ç¼“å­˜ vs è¿œç¨‹ç¼“å­˜

<p align="center">
  <img src="/images/cache-remote-local-multilevel.png" width=600 height=360>
</p>

#### åŒbuffer vs LRU/LFU
<p align="center">
  <img src="/images/double-buffer-lru.png" width=550 height=600>
</p>

<p align="center">
  <img src="/images/cache-double-buffer-lru.png" width=600 height=400>
</p>

æœ¬åœ°ç¼“å­˜çš„åŒç¼“å†²æœºåˆ¶å’Œæœ¬åœ°LRUï¼ˆLeast Recently Usedï¼‰ç®—æ³•éƒ½æ˜¯å¸¸è§çš„ç¼“å­˜ä¼˜åŒ–æŠ€æœ¯ï¼Œå®ƒä»¬å…·æœ‰ä¸åŒçš„ä¼˜ç‚¹å’Œç¼ºç‚¹ã€‚

1. åŒç¼“å†²æœºåˆ¶ï¼š
   - ä¼˜ç‚¹ï¼š
     - æé«˜å¹¶å‘æ€§èƒ½ï¼šåŒç¼“å†²æœºåˆ¶ä½¿ç”¨ä¸¤ä¸ªç¼“å†²åŒºï¼Œä¸€ä¸ªç”¨äºè¯»å–æ•°æ®ï¼Œå¦ä¸€ä¸ªç”¨äºå†™å…¥æ•°æ®ã€‚è¿™æ ·å¯ä»¥é¿å…è¯»å†™å†²çªï¼Œæé«˜äº†å¹¶å‘æ€§èƒ½ã€‚
     - æé«˜æ•°æ®è®¿é—®æ•ˆç‡ï¼šç”±äºè¯»å–æ“ä½œä¸ä¼šç›´æ¥è®¿é—®ä¸»ç¼“å­˜ï¼Œè€Œæ˜¯è¯»å–ç¼“å†²åŒºçš„æ•°æ®ï¼Œå› æ­¤å¯ä»¥æ›´å¿«åœ°è·å–æ•°æ®ã€‚
   - ç¼ºç‚¹ï¼š
     - å†…å­˜å¼€é”€å¢åŠ ï¼šåŒç¼“å†²æœºåˆ¶éœ€è¦ç»´æŠ¤ä¸¤ä¸ªç¼“å†²åŒºï¼Œè¿™ä¼šå¢åŠ å†…å­˜å¼€é”€ã€‚
     - æ•°æ®å»¶è¿Ÿï¼šæ•°æ®æ›´æ–°å®šæ—¶åŒæ­¥ï¼Œæœ‰ä¸€å®šå»¶æ—¶ã€‚

2. æœ¬åœ°LRUç®—æ³•ï¼š
   - ä¼˜ç‚¹ï¼š
     - æ•°æ®è®¿é—®æ•ˆç‡é«˜ï¼šLRUç®—æ³•æ ¹æ®æ•°æ®çš„è®¿é—®é¡ºåºè¿›è¡Œç¼“å­˜æ›¿æ¢ï¼Œå°†æœ€è¿‘æœ€å°‘ä½¿ç”¨çš„æ•°æ®æ·˜æ±°å‡ºç¼“å­˜ã€‚è¿™æ ·å¯ä»¥ä¿ç•™æœ€å¸¸ç”¨çš„æ•°æ®ï¼Œæé«˜æ•°æ®çš„è®¿é—®æ•ˆç‡ã€‚
     - ç®€å•æœ‰æ•ˆï¼šLRUç®—æ³•çš„å®ç°ç›¸å¯¹ç®€å•ï¼Œåªéœ€è¦ç»´æŠ¤ä¸€ä¸ªè®¿é—®é¡ºåºé“¾è¡¨å’Œä¸€ä¸ªå“ˆå¸Œè¡¨å³å¯ã€‚
   - ç¼ºç‚¹ï¼š
     - ç¼“å­˜å‘½ä¸­ç‡ä¸‹é™ï¼šå¦‚æœæ•°æ®çš„è®¿é—®æ¨¡å¼ä¸ç¬¦åˆLRUç®—æ³•çš„å‡è®¾ï¼Œå³æœ€è¿‘è®¿é—®çš„æ•°æ®åœ¨æœªæ¥ä¹Ÿæ˜¯æœ€æœ‰å¯èƒ½è¢«è®¿é—®çš„ï¼Œé‚£ä¹ˆLRUç®—æ³•çš„æ•ˆæœå¯èƒ½ä¸ç†æƒ³ï¼Œç¼“å­˜å‘½ä¸­ç‡ä¼šä¸‹é™ã€‚
     - å¯¹äºçƒ­ç‚¹æ•°æ®ä¸æ•æ„Ÿï¼šLRUç®—æ³•åªè€ƒè™‘äº†æœ€è¿‘çš„è®¿é—®æƒ…å†µï¼Œå¯¹äºçƒ­ç‚¹æ•°æ®ï¼ˆé¢‘ç¹è®¿é—®çš„æ•°æ®ï¼‰å¯èƒ½æ— æ³•æœ‰æ•ˆåœ°ä¿ç•™åœ¨ç¼“å­˜ä¸­ã€‚

ç»¼åˆæ¥çœ‹ï¼ŒåŒç¼“å†²æœºåˆ¶é€‚ç”¨äºéœ€è¦æé«˜å¹¶å‘æ€§èƒ½ã€æ‰¹é‡æ›´æ–°ç­‰åœºæ™¯ï¼Œä½†ä¼šå¢åŠ å†…å­˜å¼€é”€ã€‚æœ¬åœ°LRUç®—æ³•é€‚ç”¨äºéœ€è¦æé«˜æ•°æ®è®¿é—®æ•ˆç‡çš„åœºæ™¯ï¼Œä½†å¯¹äºè®¿é—®æ¨¡å¼ä¸ç¬¦åˆLRUå‡è®¾çš„æƒ…å†µä¸‹ï¼Œç¼“å­˜å‘½ä¸­ç‡å¯èƒ½ä¸‹é™ã€‚åœ¨å®é™…åº”ç”¨ä¸­ï¼Œå¯ä»¥æ ¹æ®å…·ä½“éœ€æ±‚å’Œåœºæ™¯é€‰æ‹©é€‚åˆçš„ç¼“å­˜ä¼˜åŒ–æŠ€æœ¯ã€‚


### ç¼“å­˜ä¸DBä¸€è‡´æ€§æ–¹æ¡ˆ

#### ä¸€è‡´æ€§é—®é¢˜åˆ†æ

å½“ä½¿ç”¨ Redis ç¼“å­˜ DB æ•°æ®æ—¶ï¼ŒDB æ•°æ®ä¼šå‘ç”Ÿ UPDATEï¼Œå¦‚ä½•è€ƒè™‘ Redis å’Œ DB æ•°æ®çš„ä¸€è‡´æ€§é—®é¢˜å‘¢ï¼Ÿ
- é€šå¸¸æ¥è¯´ï¼Œå¯¹äºæµé‡è¾ƒå°çš„ä¸šåŠ¡æ¥è¯´ï¼Œå¯ä»¥è®¾ç½®è¾ƒå°çš„expire time,å¯ä»¥å°†rediså’Œdbçš„ä¸ä¸€è‡´çš„æ—¶é—´æ§åˆ¶åœ¨ä¸€å®šçš„èŒƒå›´å†…éƒ¨
- å¯¹äºç¼“å­˜å’Œdbä¸€è‡´æ€§è¦æ±‚è¾ƒé«˜çš„åœºåˆï¼Œé€šå¸¸é‡‡ç”¨çš„æ˜¯å…ˆæ›´æ–°dbï¼Œå†åˆ é™¤æˆ–è€…æ›´æ–°redisï¼Œè€ƒè™‘åˆ°å¹¶å‘æ€§å’Œä¸¤ä¸ªæ“ä½œçš„åŸå­æ€§ï¼ˆåˆ é™¤æˆ–è€…æ›´æ–°å¯èƒ½ä¼šå¤±è´¥ï¼‰ï¼Œå¯ä»¥å¢åŠ é‡è¯•æœºåˆ¶ï¼ˆåŒåˆ é™¤ï¼‰ï¼Œå¦‚æœè€ƒè™‘ä¸»ä»å»¶æ—¶ï¼Œå¯ä»¥å¼•å…¥mqåšå»¶æ—¶åŒåˆ 
- http://kaito-kidd.com/2021/09/08/how-to-keep-cache-and-consistency-of-db/
<p align="center">
  <img src="/images/cache-refesh.png" width=600 height=800>
</p>


<p align="center">
  <img src="/images/cache-read-write-mode.png" width=600 height=400>
</p>


|  ç¼“å­˜æ›´æ–°æ–¹å¼  |  ä¼˜ç¼ºç‚¹  | 
| -- | -- |
| ç¼“å­˜æ¨¡å¼+TTL | ä¸šåŠ¡ä»£ç åªæ›´æ–°DBï¼Œä¸æ›´æ–°cacheï¼Œè®¾ç½®è¾ƒçŸ­çš„TTL(é€šå¸¸åˆ†é’Ÿçº§ï¼‰ï¼Œä¾é cacheè¿‡æœŸæ— æ³•æ‰¾åˆ°keyæ—¶å›æºDBï¼Œçƒ­keyè¿‡æœŸå¯èƒ½å›å¯¼è‡´è¯·æ±‚å¤§é‡è¯·æ±‚å‡»ç©¿åˆ°DBï¼Œéœ€è¦ä½¿ç”¨åˆ†å¸ƒå¼é”æˆ–è€…singleflightç­‰æ–¹å¼é¿å…è¿™ç§é—®é¢˜ |
| å®šæ—¶åˆ·æ–°æ¨¡å¼ | å®šæ—¶ä»»åŠ¡å¼‚æ­¥è·å–DBæ•°æ®åˆ·æ–°åˆ°cacheï¼Œè¯»è¯·æ±‚å¯ä¸å›æºï¼Œéœ€è¦è€ƒè™‘åˆ·æ–°æ—¶é—´å’Œæ‰¹é‡è¯»å†™ |
| å†™DB,å†™cache | åœ¨å¹¶å‘æ¡ä»¶ä¸‹ï¼ŒDBå†™æ“ä½œé¡ºåºå’Œcacheæ“ä½œä¸åŒä¿è¯é¡ºåºä¸€è‡´æ€§ï¼Œéœ€è¦å¢åŠ åˆ†å¸ƒå¼é”ç­‰æ“ä½œ |
| å†™DBï¼Œåˆ é™¤cache| åˆ é™¤cacheå¯èƒ½å¤±è´¥ï¼Œéœ€è¦å¢åŠ é‡è¯•ï¼Œé‡è¯•ä¹Ÿå¯èƒ½å¤±è´¥ï¼Œæ¯”è¾ƒå¤æ‚çš„åŠ ä¸ªMQè¡¥å¿é‡è¯• |


### æ€è€ƒï¼š
- å¯¹ä¸€è‡´æ€§è¦æ±‚æœ‰å¤šå¼ºï¼Ÿ
- TTL è®¾ç½®çš„æ—¶é•¿
- å¹¶å‘å†²çªå¯èƒ½æ€§
- çƒ­keyç¼“å­˜å‡»ç©¿ä¿æŠ¤


### ç¼“å­˜å¼‚å¸¸å¤„ç†ï¼ˆé›ªå´©ã€ç©¿é€ã€å‡»ç©¿ï¼‰

#### ä¸‰å¤§ç¼“å­˜é—®é¢˜

1. **ç¼“å­˜é›ªå´©**ï¼šå¤§é¢ç§¯ Key åŒæ—¶å¤±æ•ˆæˆ–åˆ é™¤ï¼Œå¯¼è‡´è¯·æ±‚å…¨éƒ¨æ‰“åˆ° DB
2. **ç¼“å­˜ç©¿é€**ï¼šæŸ¥è¯¢ä¸å­˜åœ¨çš„ Keyï¼ˆæ¶æ„æ”»å‡»ï¼‰ï¼Œç»•è¿‡ç¼“å­˜ç›´å‡» DB
3. **ç¼“å­˜å‡»ç©¿**ï¼šçƒ­ç‚¹ Key å¤±æ•ˆç¬é—´ï¼Œé«˜å¹¶å‘è¯·æ±‚å‡»ç©¿åˆ° DB

**è¯¦ç»†æ–¹æ¡ˆ**ï¼š[ç¼“å­˜å¼‚å¸¸è§£å†³æ–¹æ¡ˆ](https://juejin.im/post/6844903651182542856)

---

## äº”ã€æ€§èƒ½ä¼˜åŒ–

> ç†è§£ Redis é«˜æ€§èƒ½åŸç†ï¼ŒæŒæ¡æ€§èƒ½è°ƒä¼˜æŠ€å·§ï¼Œè§£å†³å¤§Key/çƒ­Keyé—®é¢˜ã€‚

---

### ä¸ºä»€ä¹ˆ Redis è¿™ä¹ˆå¿«ï¼Ÿ

#### æ ¸å¿ƒåŸå› 

1. **å®Œå…¨åŸºäºå†…å­˜**ï¼šç»å¤§éƒ¨åˆ†è¯·æ±‚æ˜¯çº¯ç²¹çš„å†…å­˜æ“ä½œï¼Œéå¸¸å¿«é€Ÿã€‚æ•°æ®å­˜åœ¨å†…å­˜ä¸­ï¼Œç±»ä¼¼äº HashMapï¼ŒHashMap çš„ä¼˜åŠ¿å°±æ˜¯æŸ¥æ‰¾å’Œæ“ä½œçš„æ—¶é—´å¤æ‚åº¦éƒ½æ˜¯ O(1)ï¼›
- 2ã€æ•°æ®ç»“æ„ç®€å•ï¼Œå¯¹æ•°æ®æ“ä½œä¹Ÿç®€å•ï¼ŒRedis ä¸­çš„æ•°æ®ç»“æ„æ˜¯ä¸“é—¨è¿›è¡Œè®¾è®¡çš„ï¼›
- 3ã€é‡‡ç”¨å•çº¿ç¨‹ï¼Œé¿å…äº†ä¸å¿…è¦çš„ä¸Šä¸‹æ–‡åˆ‡æ¢å’Œç«äº‰æ¡ä»¶ï¼Œä¹Ÿä¸å­˜åœ¨å¤šè¿›ç¨‹æˆ–è€…å¤šçº¿ç¨‹å¯¼è‡´çš„åˆ‡æ¢è€Œæ¶ˆè€— CPUï¼Œä¸ç”¨å»è€ƒè™‘å„ç§é”çš„é—®é¢˜ï¼Œä¸å­˜åœ¨åŠ é”é‡Šæ”¾é”æ“ä½œï¼Œæ²¡æœ‰å› ä¸ºå¯èƒ½å‡ºç°æ­»é”è€Œå¯¼è‡´çš„æ€§èƒ½æ¶ˆè€—ï¼›
- 4ã€ä½¿ç”¨å¤šè·¯ I/O å¤ç”¨æ¨¡å‹ï¼Œéé˜»å¡ IOï¼›
- 5ã€**è‡ªå»º VM æœºåˆ¶**ï¼šä½¿ç”¨åº•å±‚æ¨¡å‹ä¸åŒï¼Œå®ƒä»¬ä¹‹é—´åº•å±‚å®ç°æ–¹å¼ä»¥åŠä¸å®¢æˆ·ç«¯ä¹‹é—´é€šä¿¡çš„åº”ç”¨åè®®ä¸ä¸€æ ·ï¼ŒRedis ç›´æ¥è‡ªå·±æ„å»ºäº† VM æœºåˆ¶ï¼Œå› ä¸ºä¸€èˆ¬çš„ç³»ç»Ÿè°ƒç”¨ç³»ç»Ÿå‡½æ•°çš„è¯ï¼Œä¼šæµªè´¹ä¸€å®šçš„æ—¶é—´å»ç§»åŠ¨å’Œè¯·æ±‚ã€‚

**è¯¦ç»†åˆ†æ**ï¼š[å•çº¿ç¨‹ Redis ä¸ºä»€ä¹ˆå¿«ï¼Ÿ](http://kaito-kidd.com/2020/06/28/why-redis-so-fast/)

---

### å•çº¿ç¨‹æ¨¡å‹

#### ä¸ºä»€ä¹ˆä½¿ç”¨å•çº¿ç¨‹ï¼Ÿ

**å‚è€ƒ**ï¼š[Redis å•çº¿ç¨‹è®¾è®¡](https://draveness.me/whys-the-design-redis-single-thread/)

**ä¼˜åŠ¿**ï¼š
- é¿å…ä¸Šä¸‹æ–‡åˆ‡æ¢
- æ— éœ€è€ƒè™‘é”é—®é¢˜
- å®ç°ç®€å•æ¸…æ™°

**åŠ£åŠ¿**ï¼š
- æ— æ³•åˆ©ç”¨å¤šæ ¸ CPU
- é•¿è€—æ—¶å‘½ä»¤ä¼šé˜»å¡

---

### å¤§Keyå’Œçƒ­Keyé—®é¢˜

#### ä»€ä¹ˆæ˜¯å¤§Keyï¼Ÿ

```bash
# ä»€ä¹ˆæ˜¯å¤§ Keyï¼Ÿ
- String: value > 10KB
- Hash/List/Set/ZSet: å…ƒç´ æ•°é‡ > 10000
```

---

### åˆ†å¸ƒå¼æ–¹æ¡ˆï¼ˆä¸»ä»ã€å“¨å…µã€é›†ç¾¤ï¼‰

#### æ¶æ„æ¼”è¿›è·¯çº¿

| é˜¶æ®µ | æ–¹æ¡ˆ | ç‰¹ç‚¹ | å±€é™æ€§ |
|------|------|------|--------|
| 1 | **å•æœºç‰ˆ** | ç®€å•ç›´æ¥ | å•ç‚¹æ•…éšœã€å®¹é‡æœ‰é™ã€å¹¶å‘æœ‰é™ |
| 2 | **ä¸»ä»å¤åˆ¶** | è¯»å†™åˆ†ç¦»ã€é«˜å¯ç”¨ | ä¸»ä»å»¶è¿Ÿã€æ— è‡ªåŠ¨æ•…éšœè½¬ç§» |
| 3 | **å“¨å…µæ¨¡å¼ (Sentinel)** | è‡ªåŠ¨æ•…éšœè½¬ç§» | éš¾ä»¥æ‰©å®¹ã€ä¸»åº“å†™å…¥ç“¶é¢ˆ |
| 4 | **é›†ç¾¤æ¨¡å¼ (Cluster)** | æ¨ªå‘æ‰©å±•ã€é«˜å¯ç”¨ | å¤æ‚åº¦é«˜ã€è·¨slotæ“ä½œå—é™ |
| 5 | **Codis** | ä¸­å¿ƒåŒ–ç®¡ç†ã€æ˜“è¿ç»´ | éœ€è¦é¢å¤–ç»„ä»¶ï¼ˆZookeeperï¼‰ |

#### ä¸»ä»å¤åˆ¶

**ç‰¹ç‚¹**ï¼š
- ä¸»åº“ï¼ˆMasterï¼‰è´Ÿè´£å†™æ“ä½œ
- ä»åº“ï¼ˆSlaveï¼‰è´Ÿè´£è¯»æ“ä½œ
- ä¸»åº“æ•°æ®è‡ªåŠ¨åŒæ­¥åˆ°ä»åº“

**é—®é¢˜**ï¼š
- ä¸»ä»å»¶è¿Ÿå¯¼è‡´æ•°æ®ä¸ä¸€è‡´
- æ— è‡ªåŠ¨æ•…éšœæ¢å¤ï¼Œéœ€äººå·¥ä»‹å…¥

#### å“¨å…µæ¨¡å¼ (Sentinel)

**ç›®æ ‡**ï¼šè§£å†³ä¸»ä»å¤åˆ¶çš„è‡ªåŠ¨æ•…éšœæ¢å¤é—®é¢˜

**å·¥ä½œæœºåˆ¶**ï¼š
- ç›‘æ§ä¸»ä»è¿è¡ŒçŠ¶æ€
- å½“ Master æ•…éšœæ—¶ï¼Œé€šè¿‡ Raft é€‰ä¸¾
- Leader å“¨å…µé€‰æ‹©ä¼˜å…ˆçº§æœ€é«˜çš„ Slave ä½œä¸ºæ–° Master
- å…¶ä»– Slave ä»æ–° Master åŒæ­¥æ•°æ®

**å±€é™æ€§**ï¼š
- éš¾ä»¥æ‰©å®¹
- å•æœºå­˜å‚¨ã€è¯»å†™èƒ½åŠ›å—é™
- æ‰€æœ‰ Redis èŠ‚ç‚¹éƒ½æœ‰å…¨é‡æ•°æ®ï¼Œå†…å­˜å†—ä½™

#### Redis Cluster é›†ç¾¤æ¨¡å¼

**ç‰¹ç‚¹**ï¼š
- æ— ä¸­å¿ƒæ¶æ„ï¼Œå»ä¸­å¿ƒåŒ–
- æ•°æ®åˆ†ç‰‡ï¼Œæ¯ä¸ªèŠ‚ç‚¹å­˜å‚¨éƒ¨åˆ†æ•°æ®ï¼ˆ16384 ä¸ªæ§½ï¼‰
- é€šè¿‡è·¯ç”±æ‰¾åˆ°å¯¹åº”èŠ‚ç‚¹
- æ”¯æŒæ¨ªå‘å’Œçºµå‘æ‰©å±•
- è‡ªåŠ¨æ•…éšœè½¬ç§»

**ä¼˜åŠ¿**ï¼š
- å“¨å…µçš„æ‰€æœ‰ä¼˜ç‚¹
- å¯åŠ¨æ€æ‰©å®¹/ç¼©å®¹
- æ•°æ®åˆ†å¸ƒå¼å­˜å‚¨

#### Codis

**ç‰¹ç‚¹**ï¼š
- è±Œè±†èšå¼€æºæ–¹æ¡ˆ
- ä¸­å¿ƒåŒ–ç®¡ç†ï¼ˆZookeeper/Etcdï¼‰
- Proxy å±‚è·¯ç”±
- Dashboard å¯è§†åŒ–ç®¡ç†

**GitHub**ï¼šhttps://github.com/CodisLabs/codis

**å‚è€ƒèµ„æ–™**ï¼š
- [Redis åˆ†å¸ƒå¼æ¶æ„æ¼”è¿›](https://blog.csdn.net/QQ1006207580/article/details/103243281)
- [Redis é›†ç¾¤åŒ–æ–¹æ¡ˆå¯¹æ¯”ï¼šCodisã€Twemproxyã€Redis Cluster](http://kaito-kidd.com/2020/07/07/redis-cluster-codis-twemproxy/)

---

### Lua è„šæœ¬

#### ä¸ºä»€ä¹ˆä½¿ç”¨ Luaï¼Ÿ

Redis æ‰§è¡Œ Lua è„šæœ¬å…·æœ‰ä»¥ä¸‹ç‰¹æ€§ï¼š

1. **åŸå­æ€§**ï¼šè„šæœ¬æ‰§è¡ŒæœŸé—´ä¸ä¼šæ‰§è¡Œå…¶ä»–è„šæœ¬æˆ–å‘½ä»¤
2. **ç‹¬å æ€§**ï¼šRedis ä¸€æ—¦å¼€å§‹æ‰§è¡Œ Lua è„šæœ¬ï¼Œå°±ä¼šä¸€ç›´æ‰§è¡Œå®Œè¯¥è„šæœ¬
3. **åº”ç”¨å¹¿æ³›**ï¼šåˆ†å¸ƒå¼é”ã€é™æµã€ç§’æ€ç­‰åœºæ™¯

#### ä½¿ç”¨æ³¨æ„äº‹é¡¹
- ä½¿ç”¨ Lua è„šæœ¬å®ç°åŸå­æ€§æ“ä½œçš„ CASï¼Œé¿å…ä¸åŒå®¢æˆ·ç«¯å…ˆè¯» Redis æ•°æ®ï¼Œç»è¿‡è®¡ç®—åå†å†™æ•°æ®é€ æˆçš„å¹¶å‘é—®é¢˜
- å‰åå¤šæ¬¡è¯·æ±‚çš„ç»“æœæœ‰ä¾èµ–å…³ç³»æ—¶ï¼Œæœ€å¥½ä½¿ç”¨ Lua è„šæœ¬å°†å¤šä¸ªè¯·æ±‚æ•´åˆä¸ºä¸€ä¸ªï¼›ä½†è¯·æ±‚å‰åæ— ä¾èµ–æ—¶ï¼Œä½¿ç”¨ pipeline æ–¹å¼ï¼Œæ¯” Lua è„šæœ¬æ–¹ä¾¿
- ä¸ºäº†ä¿è¯å®‰å…¨æ€§ï¼Œåœ¨ Lua è„šæœ¬ä¸­ä¸è¦å®šä¹‰è‡ªå·±çš„å…¨å±€å˜é‡ï¼Œä»¥å…æ±¡æŸ“ Redis å†…åµŒçš„ Lua ç¯å¢ƒã€‚å› ä¸º Lua è„šæœ¬ä¸­ä½ ä¼šä½¿ç”¨ä¸€äº›é¢„åˆ¶çš„å…¨å±€å˜é‡ï¼Œæ¯”å¦‚è¯´ redis.call()
- æ³¨æ„ Lua è„šæœ¬çš„æ—¶é—´å¤æ‚åº¦ï¼ŒRedis çš„å•çº¿ç¨‹åŒæ ·ä¼šé˜»å¡åœ¨ Lua è„šæœ¬çš„æ‰§è¡Œä¸­ï¼ŒLua è„šæœ¬ä¸è¦è¿›è¡Œé«˜è€—æ—¶æ“ä½œ
- Redis è¦æ±‚å•ä¸ª Lua è„šæœ¬æ“ä½œçš„ key å¿…é¡»åœ¨åŒä¸€ä¸ª Redis èŠ‚ç‚¹ä¸Šï¼Œå› æ­¤ Redis Cluster æ–¹å¼éœ€è¦è®¾ç½® HashTagï¼ˆå®é™…ä¸­ä¸å¤ªå»ºè®®è¿™æ ·æ“ä½œï¼‰


---

## Redis å¸¸ç”¨å‘½ä»¤

### è¿æ¥å‘½ä»¤

```bash
# è¿æ¥ Redis
redis-cli -h host -p port -a password

# åˆ‡æ¢æ•°æ®åº“
SELECT 0

# æµ‹è¯•è¿æ¥
PING  # è¿”å› PONG
```

### åŸºç¡€å‘½ä»¤

| å‘½ä»¤ | è¯´æ˜ | æ—¶é—´å¤æ‚åº¦ |
|------|------|-----------|
| `SET key value [NX\|XX] [EX seconds]` | è®¾ç½®é”®å€¼ | O(1) |
| `GET key` | è·å–å€¼ | O(1) |
| `DEL key [key ...]` | åˆ é™¤é”® | O(N) |
| `EXISTS key [key ...]` | æ£€æŸ¥é”®æ˜¯å¦å­˜åœ¨ | O(N) |
| `TTL key` | æŸ¥è¯¢è¿‡æœŸæ—¶é—´ï¼ˆç§’ï¼‰ | O(1) |
| `EXPIRE key seconds` | è®¾ç½®è¿‡æœŸæ—¶é—´ | O(1) |
| `SCAN cursor [MATCH pattern]` | æ‰«æé”®ï¼ˆæ¨èï¼‰ | O(1) |
| `KEYS pattern` | æ¨¡å¼åŒ¹é…é”®ï¼ˆâš ï¸ ç”Ÿäº§ç¯å¢ƒç¦ç”¨ï¼‰ | O(N) |

**âš ï¸ ç”Ÿäº§ç¯å¢ƒæ³¨æ„**ï¼š
- **ç¦ç”¨ `KEYS *`**ï¼šéå†æ‰€æœ‰é”®ï¼Œæ—¶é—´å¤æ‚åº¦ O(N)ï¼Œä¼šé˜»å¡ Redis
- **æ¨èä½¿ç”¨ `SCAN`**ï¼šæ¸è¿›å¼éå†ï¼Œä¸é˜»å¡æœåŠ¡å™¨


## æ€§èƒ½è°ƒä¼˜ä¸ç›‘æ§

### å¤§Keyå’Œçƒ­Keyé—®é¢˜

#### ä»€ä¹ˆæ˜¯å¤§Keyï¼Ÿ

#### å¤§ Key å±å®³

```bash
# ä»€ä¹ˆæ˜¯å¤§ Keyï¼Ÿ
- String: value > 10KB
- Hash/List/Set/ZSet: å…ƒç´ æ•°é‡ > 10000

# å±å®³
1. å†…å­˜å ç”¨è¿‡å¤§ï¼Œå¯èƒ½ OOM
2. å•ä¸ªæ“ä½œè€—æ—¶é•¿ï¼Œé˜»å¡å…¶ä»–è¯·æ±‚
3. ä¸»ä»åŒæ­¥æ…¢ï¼Œå¯¼è‡´ä»åº“å»¶è¿Ÿ
4. æŒä¹…åŒ–æ…¢ï¼ˆRDB/AOFï¼‰
5. é›†ç¾¤æ•°æ®å€¾æ–œ
```

#### å‘ç°å¤§ Key

```bash
# 1. æ‰«ææ•´ä¸ªå®ä¾‹
redis-cli --bigkeys

# 2. æ‰«ææŒ‡å®šæ•°æ®åº“
redis-cli -n 0 --bigkeys

# 3. åˆ†æ RDB æ–‡ä»¶
redis-rdb-tools dump.rdb --command memory --bytes 10240

# 4. ä½¿ç”¨ MEMORY USAGE å‘½ä»¤
redis> MEMORY USAGE mykey
(integer) 1048576
```

#### è§£å†³æ–¹æ¡ˆ

```go
// 1. æ‹†åˆ†å¤§ Key
// é”™è¯¯ï¼šå•ä¸ª Hash å­˜å‚¨æ‰€æœ‰å•†å“
HSET products 1001 "{...}" 1002 "{...}" ... 10000 "{...}"

// æ­£ç¡®ï¼šæŒ‰åˆ†ç‰‡æ‹†åˆ†
for i := 0; i < 10; i++ {
    rdb.HSet(ctx, fmt.Sprintf("products:shard:%d", i), productID, data)
}

// 2. å‹ç¼©æ•°æ®
data := compress(largeJSON)
rdb.Set(ctx, key, data)

// 3. è®¾ç½®åˆç†è¿‡æœŸæ—¶é—´
rdb.Set(ctx, key, value, 1*time.Hour)

// 4. å¼‚æ­¥åˆ é™¤å¤§ Key
rdb.Unlink(ctx, largeKey)  // éé˜»å¡åˆ é™¤
```

#### çƒ­ Key å±å®³

```bash
# ä»€ä¹ˆæ˜¯çƒ­ Keyï¼Ÿ
QPS > 10000 çš„ Keyï¼ˆå¦‚ç§’æ€å•†å“ï¼‰

# å±å®³
1. å•ä¸ª Redis èŠ‚ç‚¹æµé‡è¿‡å¤§
2. CPU å ç”¨è¿‡é«˜
3. ç½‘ç»œå¸¦å®½æ‰“æ»¡
4. é›†ç¾¤èŠ‚ç‚¹è´Ÿè½½ä¸å‡
```

#### è§£å†³æ–¹æ¡ˆ

```go
// 1. æœ¬åœ°ç¼“å­˜ + Redis äºŒçº§ç¼“å­˜
localCache := cache.New(5*time.Minute, 10*time.Minute)

func GetHotKey(key string) (string, error) {
    // å…ˆæŸ¥æœ¬åœ°ç¼“å­˜
    if val, found := localCache.Get(key); found {
        return val.(string), nil
    }
    
    // å†æŸ¥ Redis
    val, err := rdb.Get(ctx, key).Result()
    if err == nil {
        localCache.Set(key, val, cache.DefaultExpiration)
    }
    return val, err
}

// 2. å¤šå‰¯æœ¬åˆ†æ•£è¯·æ±‚
func GetHotKeyWithReplica(key string) (string, error) {
    // éšæœºé€‰æ‹©å‰¯æœ¬
    replica := rand.Intn(10)
    replicaKey := fmt.Sprintf("%s:replica:%d", key, replica)
    return rdb.Get(ctx, replicaKey).Result()
}

// 3. é™æµä¿æŠ¤
limiter := rate.NewLimiter(10000, 20000)  // 10000 QPS, burst 20000
if !limiter.Allow() {
    return ErrTooManyRequests
}
```

---

### ç›‘æ§æŒ‡æ ‡

#### å…³é”®æŒ‡æ ‡

```bash
# 1. å†…å­˜ä½¿ç”¨
redis> INFO memory
used_memory:1073741824             # å·²ä½¿ç”¨å†…å­˜
used_memory_peak:2147483648        # å³°å€¼å†…å­˜
used_memory_rss:1610612736         # ç‰©ç†å†…å­˜
mem_fragmentation_ratio:1.5        # ç¢ç‰‡ç‡

# 2. æ€§èƒ½æŒ‡æ ‡
redis> INFO stats
instantaneous_ops_per_sec:10000    # å½“å‰ QPS
total_commands_processed:1000000   # æ€»å‘½ä»¤æ•°
rejected_connections:0             # æ‹’ç»è¿æ¥æ•°
expired_keys:1000                  # è¿‡æœŸé”®æ•°é‡
evicted_keys:0                     # æ·˜æ±°é”®æ•°é‡

# 3. æŒä¹…åŒ–
redis> INFO persistence
rdb_last_save_time:1641024000      # æœ€å RDB æ—¶é—´
rdb_changes_since_last_save:1000   # è‡ªä¸Šæ¬¡ RDB å˜æ›´æ•°
aof_enabled:1                      # AOF æ˜¯å¦å¼€å¯
aof_last_rewrite_time_sec:2        # æœ€å AOF é‡å†™è€—æ—¶

# 4. å¤åˆ¶
redis> INFO replication
role:master                        # è§’è‰²
connected_slaves:2                 # ä»åº“æ•°é‡
master_repl_offset:1000000         # ä¸»åº“åç§»é‡
repl_backlog_size:1048576          # ç§¯å‹ç¼“å†²åŒºå¤§å°

# 5. æ…¢æŸ¥è¯¢
redis> SLOWLOG GET 10
1) 1) (integer) 1
   2) (integer) 1641024000
   3) (integer) 50000              # è€—æ—¶ 50ms
   4) 1) "KEYS"
      2) "*"
```

#### ç›‘æ§å‘Šè­¦

```yaml
# Prometheus ç›‘æ§è§„åˆ™
groups:
  - name: redis_alerts
    rules:
      # å†…å­˜ä½¿ç”¨ç‡ > 80%
      - alert: RedisMemoryHigh
        expr: redis_memory_used_bytes / redis_memory_max_bytes > 0.8
        for: 5m
        
      # QPS > 50000
      - alert: RedisQPSHigh
        expr: rate(redis_commands_processed_total[1m]) > 50000
        for: 5m
        
      # æ…¢æŸ¥è¯¢ > 10ms
      - alert: RedisSlowLog
        expr: redis_slowlog_length > 100
        for: 10m
        
      # ä¸»ä»å»¶è¿Ÿ > 10s
      - alert: RedisReplLag
        expr: redis_master_repl_offset - redis_slave_repl_offset > 10000000
        for: 5m
```

---

## å…­ã€å®æˆ˜æ¡ˆä¾‹

> åŸºäºçœŸå®ä¸šåŠ¡åœºæ™¯ï¼ŒæŒæ¡åˆ†å¸ƒå¼é”ã€BloomFilterã€ç§’æ€ã€æ’è¡Œæ¦œç­‰é«˜çº§åº”ç”¨ã€‚

---

### åˆ†å¸ƒå¼é”å®ç°

Redis ä¸ºå•è¿›ç¨‹å•çº¿ç¨‹æ¨¡å¼ï¼Œé‡‡ç”¨é˜Ÿåˆ—æ¨¡å¼å°†å¹¶å‘è®¿é—®å˜æˆä¸²è¡Œè®¿é—®ï¼Œä¸”å¤šå®¢æˆ·ç«¯å¯¹ Redis çš„è¿æ¥å¹¶ä¸å­˜åœ¨ç«äº‰å…³ç³»ã€‚

#### åŸºæœ¬å®ç°

```go
// SETNX + EXPIRE å®ç°
func Lock(key string, value string, expiration time.Duration) bool {
    return rdb.SetNX(ctx, key, value, expiration).Val()
}

func Unlock(key string, value string) error {
    // ä½¿ç”¨ Lua ä¿è¯åŸå­æ€§
    script := `
        if redis.call("get", KEYS[1]) == ARGV[1] then
            return redis.call("del", KEYS[1])
        else
            return 0
        end
    `
    return rdb.Eval(ctx, script, []string{key}, value).Err()
}
```

**è¯¦ç»†å®ç°**ï¼š[Redis åˆ†å¸ƒå¼é”](https://juejin.cn/post/6936956908007850014)

---

### BloomFilter å®è·µ

#### åŸç†

BloomFilter ç”¨äºå¿«é€Ÿåˆ¤æ–­å…ƒç´ æ˜¯å¦å­˜åœ¨ï¼Œ**å…è®¸è¯¯åˆ¤ï¼ˆFalse Positiveï¼‰**ï¼Œä½†**ä¸ä¼šæ¼åˆ¤ï¼ˆNo False Negativeï¼‰**ã€‚

```
åˆ¤æ–­ç»“æœ = ä¸€å®šä¸å­˜åœ¨ or å¯èƒ½å­˜åœ¨
```

### å…¬å¼

```
m = -n*ln(p) / (ln2)Â²    # ä½æ•°ç»„å¤§å°
k = m/n * ln2            # å“ˆå¸Œå‡½æ•°æ•°é‡

n = é¢„æœŸå…ƒç´ æ•°é‡
p = è¯¯åˆ¤ç‡
```

**ç¤ºä¾‹**ï¼š
```
n = 1,000,000ï¼ˆç™¾ä¸‡æ•°æ®ï¼‰
p = 0.01ï¼ˆ1% è¯¯åˆ¤ç‡ï¼‰

m = 9,585,059 bits â‰ˆ 1.15 MB
k = 7 ä¸ªå“ˆå¸Œå‡½æ•°
```

### Redis å®ç°

```go
import "github.com/bits-and-blooms/bloom/v3"

// 1. åˆ›å»º BloomFilter
bf := bloom.NewWithEstimates(1000000, 0.01)

// 2. æ·»åŠ å…ƒç´ 
bf.Add([]byte("user:123"))
bf.Add([]byte("user:456"))

// 3. æŸ¥è¯¢å…ƒç´ 
exists := bf.Test([]byte("user:123"))  // true
exists = bf.Test([]byte("user:999"))   // false æˆ– trueï¼ˆè¯¯åˆ¤ï¼‰

// 4. åºåˆ—åŒ–åˆ° Redis
data, _ := bf.GobEncode()
rdb.Set(ctx, "bloomfilter:users", data, 0)

// 5. ä» Redis åŠ è½½
data, _ := rdb.Get(ctx, "bloomfilter:users").Bytes()
bf := bloom.New(1, 1)
bf.GobDecode(data)
```

### åº”ç”¨åœºæ™¯

```go
// 1. é˜²æ­¢ç¼“å­˜ç©¿é€
func GetUser(uid string) (*User, error) {
    // å…ˆæŸ¥ BloomFilter
    if !bloomFilter.Test([]byte(uid)) {
        return nil, ErrUserNotFound  // ä¸€å®šä¸å­˜åœ¨
    }
    
    // å†æŸ¥ç¼“å­˜å’Œ DB
    return getUserFromCacheOrDB(uid)
}

// 2. å»é‡ï¼ˆçˆ¬è™« URLï¼‰
func ShouldCrawl(url string) bool {
    if bloomFilter.Test([]byte(url)) {
        return false  // å¯èƒ½å·²çˆ¬å–
    }
    bloomFilter.Add([]byte(url))
    return true
}

// 3. æ¨èç³»ç»Ÿå»é‡
func FilterRecommendations(userID string, items []string) []string {
    var result []string
    for _, item := range items {
        key := userID + ":" + item
        if !viewedBF.Test([]byte(key)) {
            result = append(result, item)  // æœªçœ‹è¿‡
        }
    }
    return result
}
```

---

## ç§’æ€ç³»ç»Ÿè®¾è®¡

### æ ¸å¿ƒé—®é¢˜

1. **è¶…å–é—®é¢˜**ï¼šåº“å­˜ä¸º 10ï¼Œå–å‡º 100 å•
2. **é«˜å¹¶å‘é—®é¢˜**ï¼šç¬æ—¶ 10w+ QPS
3. **æ¶æ„åˆ·å•**ï¼šæœºå™¨äººåˆ·å•

### æ–¹æ¡ˆè®¾è®¡

```go
// 1. é¢„çƒ­åº“å­˜åˆ° Redis
func PreloadStock(productID string, stock int) error {
    key := fmt.Sprintf("seckill:stock:%s", productID)
    return rdb.Set(ctx, key, stock, 0).Err()
}

// 2. Lua è„šæœ¬ä¿è¯åŸå­æ€§æ‰£åº“å­˜
var decrStockScript = redis.NewScript(`
    local key = KEYS[1]
    local stock = tonumber(redis.call('GET', key))
    if stock <= 0 then
        return -1  -- åº“å­˜ä¸è¶³
    end
    redis.call('DECR', key)
    return stock - 1
`)

func DecrStock(productID string) (int, error) {
    key := fmt.Sprintf("seckill:stock:%s", productID)
    result, err := decrStockScript.Run(ctx, rdb, []string{key}).Int()
    if err != nil {
        return 0, err
    }
    if result < 0 {
        return 0, ErrStockNotEnough
    }
    return result, nil
}

// 3. é™æµ + é˜Ÿåˆ—å‰Šå³°
func HandleSeckill(userID, productID string) error {
    // 3.1 ç”¨æˆ·çº§é™æµ
    limitKey := fmt.Sprintf("limit:user:%s", userID)
    count := rdb.Incr(ctx, limitKey).Val()
    if count == 1 {
        rdb.Expire(ctx, limitKey, 60*time.Second)
    }
    if count > 5 {
        return ErrTooManyRequests  // 1åˆ†é’Ÿæœ€å¤š5æ¬¡
    }
    
    // 3.2 æ‰£åº“å­˜
    stock, err := DecrStock(productID)
    if err != nil {
        return err
    }
    
    // 3.3 å¼‚æ­¥åˆ›å»ºè®¢å•ï¼ˆæ”¾å…¥é˜Ÿåˆ—ï¼‰
    order := Order{
        UserID:    userID,
        ProductID: productID,
        CreatedAt: time.Now(),
    }
    rdb.LPush(ctx, "queue:orders", json.Marshal(order))
    
    return nil
}

// 4. æ¶ˆè´¹è®¢å•é˜Ÿåˆ—
func ProcessOrders() {
    for {
        data, err := rdb.BRPop(ctx, 5*time.Second, "queue:orders").Result()
        if err != nil {
            continue
        }
        
        var order Order
        json.Unmarshal([]byte(data[1]), &order)
        
        // å†™å…¥ MySQL
        db.CreateOrder(&order)
    }
}
```

---

## æ’è¡Œæ¦œå®ç°

### å®æ—¶æ’è¡Œæ¦œ

```go
// 1. æ›´æ–°åˆ†æ•°
func UpdateScore(userID string, score int64) error {
    return rdb.ZAdd(ctx, "rank:realtime", &redis.Z{
        Score:  float64(score),
        Member: userID,
    }).Err()
}

// 2. è·å–æ’è¡Œæ¦œ
func GetTopN(n int) ([]User, error) {
    // è·å–å‰ N åï¼ˆåˆ†æ•°ä»é«˜åˆ°ä½ï¼‰
    result, err := rdb.ZRevRangeWithScores(ctx, "rank:realtime", 0, int64(n-1)).Result()
    if err != nil {
        return nil, err
    }
    
    var users []User
    for _, z := range result {
        users = append(users, User{
            ID:    z.Member.(string),
            Score: int64(z.Score),
        })
    }
    return users, nil
}

// 3. è·å–ç”¨æˆ·æ’å
func GetUserRank(userID string) (int64, error) {
    rank, err := rdb.ZRevRank(ctx, "rank:realtime", userID).Result()
    if err != nil {
        return 0, err
    }
    return rank + 1, nil  // æ’åä» 1 å¼€å§‹
}

// 4. è·å–ç”¨æˆ·åˆ†æ•°
func GetUserScore(userID string) (int64, error) {
    score, err := rdb.ZScore(ctx, "rank:realtime", userID).Result()
    return int64(score), err
}

// 5. è·å–æˆ‘çš„é™„è¿‘æ’åï¼ˆå‰åå„5åï¼‰
func GetNearbyRank(userID string) ([]User, error) {
    rank, err := rdb.ZRevRank(ctx, "rank:realtime", userID).Result()
    if err != nil {
        return nil, err
    }
    
    start := rank - 5
    if start < 0 {
        start = 0
    }
    end := rank + 5
    
    return rdb.ZRevRangeWithScores(ctx, "rank:realtime", start, end).Result()
}
```

### æ¯æ—¥æ’è¡Œæ¦œï¼ˆè‡ªåŠ¨è¿‡æœŸï¼‰

```go
func UpdateDailyScore(userID string, score int64, date time.Time) error {
    key := fmt.Sprintf("rank:daily:%s", date.Format("2006-01-02"))
    
    // æ›´æ–°åˆ†æ•°
    pipe := rdb.Pipeline()
    pipe.ZAdd(ctx, key, &redis.Z{Score: float64(score), Member: userID})
    pipe.Expire(ctx, key, 7*24*time.Hour)  // 7å¤©åè¿‡æœŸ
    _, err := pipe.Exec(ctx)
    return err
}
```

---

## SDK æ¨è

### Go Client

```go
// 1. go-redisï¼ˆæ¨èï¼‰
import "github.com/redis/go-redis/v9"

rdb := redis.NewClient(&redis.Options{
    Addr:     "localhost:6379",
    Password: "",
    DB:       0,
    PoolSize: 100,
})

// 2. redigo
import "github.com/gomodule/redigo/redis"

pool := &redis.Pool{
    MaxIdle:     10,
    MaxActive:   100,
    IdleTimeout: 300 * time.Second,
    Dial: func() (redis.Conn, error) {
        return redis.Dial("tcp", "localhost:6379")
    },
}
```

---

## æ ¸å¿ƒçŸ¥è¯†ç‚¹æ€»ç»“

### å…³é”®æ•°å­—è®°å¿†

| æŒ‡æ ‡ | æ•°å€¼ | è¯´æ˜ |
|------|------|------|
| **æ€§èƒ½** | 10w+ QPS | å•æœº Redis æ€§èƒ½ |
| **å»¶è¿Ÿ** | 1ms | å†…å­˜æ“ä½œå¹³å‡å»¶è¿Ÿ |
| **ziplist é˜ˆå€¼** | 512 entries, 64B | Hash/List é»˜è®¤é˜ˆå€¼ |
| **zset ziplist** | 128 entries, 64B | ZSet é»˜è®¤é˜ˆå€¼ |
| **å¤§ Key** | > 10KB or > 10000 | éœ€è¦æ‹†åˆ† |
| **æ…¢æŸ¥è¯¢** | > 10ms | éœ€è¦ä¼˜åŒ– |
| **å†…å­˜ç¢ç‰‡ç‡** | 1.0 - 1.5 | æ­£å¸¸èŒƒå›´ |
| **ä¸»ä»å»¶è¿Ÿ** | < 1s | å¥åº·çŠ¶æ€ |

### æ•°æ®ç»“æ„é€‰æ‹©å†³ç­–æ ‘

```
éœ€æ±‚ï¼šå­˜å‚¨ç”¨æˆ·ä¿¡æ¯
â”œâ”€ åªéœ€è¦ç®€å•çš„ key-valueï¼Ÿ
â”‚  â””â”€ æ˜¯ â†’ Stringï¼ˆJSONï¼‰
â”œâ”€ éœ€è¦éƒ¨åˆ†å­—æ®µæ›´æ–°ï¼Ÿ
â”‚  â”œâ”€ å­—æ®µæ•° < 500 â†’ Hashï¼ˆziplistï¼‰
â”‚  â””â”€ å­—æ®µæ•° > 500 â†’ Hashï¼ˆhashtableï¼‰
â”œâ”€ éœ€è¦æŒ‰é¡ºåºå­˜å‚¨ï¼Ÿ
â”‚  â”œâ”€ æ¶ˆæ¯é˜Ÿåˆ— â†’ Listï¼ˆquicklistï¼‰
â”‚  â”œâ”€ å»é‡é›†åˆ â†’ Setï¼ˆintset/hashtableï¼‰
â”‚  â””â”€ æœ‰åºé›†åˆ â†’ ZSetï¼ˆziplist/skiplistï¼‰
```

### ç¼“å­˜è®¾è®¡æ£€æŸ¥æ¸…å•

- [ ] æ˜¯å¦è®¾ç½®äº†è¿‡æœŸæ—¶é—´ï¼ˆTTLï¼‰ï¼Ÿ
- [ ] æ˜¯å¦æœ‰ç¼“å­˜æ›´æ–°ç­–ç•¥ï¼ˆå†™ç©¿/å†™å›/æ—è·¯ï¼‰ï¼Ÿ
- [ ] æ˜¯å¦å¤„ç†äº†ç¼“å­˜ç©¿é€ï¼ˆBloomFilterï¼‰ï¼Ÿ
- [ ] æ˜¯å¦å¤„ç†äº†ç¼“å­˜å‡»ç©¿ï¼ˆåˆ†å¸ƒå¼é”/singleflightï¼‰ï¼Ÿ
- [ ] æ˜¯å¦å¤„ç†äº†ç¼“å­˜é›ªå´©ï¼ˆéšæœºTTLï¼‰ï¼Ÿ
- [ ] æ˜¯å¦ç›‘æ§äº†å¤§ Key å’Œçƒ­ Keyï¼Ÿ
- [ ] æ˜¯å¦è®¾ç½®äº†å†…å­˜æ·˜æ±°ç­–ç•¥ï¼Ÿ
- [ ] æ˜¯å¦é…ç½®äº†æŒä¹…åŒ–ï¼ˆRDB/AOFï¼‰ï¼Ÿ
- [ ] æ˜¯å¦è€ƒè™‘äº†ä¸»ä»/é›†ç¾¤é«˜å¯ç”¨ï¼Ÿ

### æœ€ä½³å®è·µé€ŸæŸ¥

```go
// âœ… æ¨èåšæ³•
1. è®¾ç½®è¿‡æœŸæ—¶é—´ï¼šrdb.Set(ctx, key, val, 1*time.Hour)
2. ä½¿ç”¨ Pipeline æ‰¹é‡æ“ä½œï¼špipe.HSet(ctx, key, field, val)
3. é¿å… KEYS å‘½ä»¤ï¼šä½¿ç”¨ SCAN æ›¿ä»£
4. ä½¿ç”¨ Lua ä¿è¯åŸå­æ€§ï¼šscript.Run(ctx, rdb, keys, args)
5. å¤§ Key æ‹†åˆ†ï¼šæŒ‰å“ˆå¸Œåˆ†ç‰‡æˆ–æŒ‰æ—¶é—´åˆ†æ®µ
6. çƒ­ Key æœ¬åœ°ç¼“å­˜ï¼šlocalCache + Redis äºŒçº§ç¼“å­˜
7. ä½¿ç”¨è¿æ¥æ± ï¼šPoolSize: 100
8. è®¾ç½®è¶…æ—¶ï¼šDialTimeout/ReadTimeout/WriteTimeout

// âŒ é¿å…åšæ³•
1. ä¸è®¾ç½®è¿‡æœŸæ—¶é—´ï¼ˆå†…å­˜æ³„æ¼ï¼‰
2. å•æ¬¡æ“ä½œå¤§é‡æ•°æ®ï¼ˆé˜»å¡ï¼‰
3. åœ¨å¾ªç¯ä¸­å‘é€å‘½ä»¤ï¼ˆç½‘ç»œ RTTï¼‰
4. ä½¿ç”¨ KEYS * å‘½ä»¤ï¼ˆé˜»å¡ï¼‰
5. å•ä¸ª Key è¿‡å¤§ï¼ˆ> 10MBï¼‰
6. é¢‘ç¹åˆ›å»ºè¿æ¥ï¼ˆæ€§èƒ½å·®ï¼‰
7. æ— ç›‘æ§å‘Šè­¦ï¼ˆé—®é¢˜å‘ç°æ…¢ï¼‰
8. ä¸åšæŒä¹…åŒ–ï¼ˆæ•°æ®ä¸¢å¤±ï¼‰
```

---

## å¯è§†åŒ–å›¾è¡¨ç´¢å¼•

æœ¬æ–‡åŒ…å«è¯¦ç»†çš„æ•°æ®ç»“æ„å¯è§†åŒ–å›¾è¡¨ï¼Œè¯¦è§ï¼š

### Hash ç›¸å…³
- [redis-hashtable.mmd](/diagrams/mermaid/redis-hashtable.mmd) - Dict å’Œ Hashtable ç»“æ„
- [redis-rehash-process.mmd](/diagrams/mermaid/redis-rehash-process.mmd) - æ¸è¿›å¼ Rehash æµç¨‹
- [redis-hash-encoding.mmd](/diagrams/mermaid/redis-hash-encoding.mmd) - ziplist vs hashtable å¯¹æ¯”
- [redis-hashtable-preview.md](/diagrams/mermaid/redis-hashtable-preview.md) - å®Œæ•´é¢„è§ˆ

### Ziplist ç›¸å…³
- [redis-ziplist-detail.mmd](/diagrams/mermaid/redis-ziplist-detail.mmd) - Ziplist è¯¦ç»†ç»“æ„
- [redis-ziplist-memory.mmd](/diagrams/mermaid/redis-ziplist-memory.mmd) - å†…å­˜å¸ƒå±€å®ä¾‹
- [redis-ziplist-hash-visual.mmd](/diagrams/mermaid/redis-ziplist-hash-visual.mmd) - Hash å®æˆ˜å¯è§†åŒ–
- [redis-ziplist-hash-preview.md](/diagrams/mermaid/redis-ziplist-hash-preview.md) - å®æˆ˜é¢„è§ˆ â­

### å®æˆ˜æ¡ˆä¾‹
- [redis-ziplist-hash-example.md](/diagrams/mermaid/redis-ziplist-hash-example.md) - Hash `{name:"iPhone", price:5999}` å®Œæ•´åˆ†æï¼ˆå­—èŠ‚çº§ï¼‰

### æ•°æ®ç»“æ„å¯¹æ¯”
- [redis-datastructure-comparison.mmd](/diagrams/mermaid/redis-datastructure-comparison.mmd) - ziplist vs linkedlist vs hashtable

---

## æ¨èé˜…è¯»

### å®˜æ–¹æ–‡æ¡£
1. [Redis å®˜æ–¹æ–‡æ¡£](https://redis.io/docs/)
2. [Redis å‘½ä»¤å‚è€ƒ](https://redis.io/commands/)
3. [Redis æ•°æ®ç±»å‹](https://redis.io/docs/data-types/)

### æ·±åº¦æ–‡ç« 
1. [Redis è®¾è®¡ä¸å®ç°ï¼ˆé»„å¥å®ï¼‰](http://redisbook.com/) - æ·±å…¥æºç çº§åˆ«
2. [Redis æ·±åº¦å†é™©ï¼ˆé’±æ–‡å“ï¼‰](https://juejin.cn/book/6844733724618129422) - å®æˆ˜è¿›é˜¶
3. [ç¾å›¢æŠ€æœ¯å›¢é˜Ÿ - ç¼“å­˜é‚£äº›äº‹](https://tech.meituan.com/2017/03/17/cache-about.html)
4. [Kaito's Blog - Redis ç³»åˆ—](http://kaito-kidd.com/categories/#Redis)
   - [RedisæŒä¹…åŒ–æ˜¯å¦‚ä½•åšçš„ï¼Ÿ](http://kaito-kidd.com/2020/06/29/redis-persistence-rdb-aof/)
   - [å•çº¿ç¨‹Redisä¸ºä»€ä¹ˆå¿«ï¼Ÿ](http://kaito-kidd.com/2020/06/28/why-redis-so-fast/)
   - [Redisé›†ç¾¤åŒ–æ–¹æ¡ˆå¯¹æ¯”](http://kaito-kidd.com/2020/07/07/redis-cluster-codis-twemproxy/)
   - [å¦‚ä½•ä¿æŒç¼“å­˜ä¸æ•°æ®åº“çš„ä¸€è‡´æ€§ï¼Ÿ](http://kaito-kidd.com/2021/09/08/how-to-keep-cache-and-consistency-of-db/)
   - [Redisæœ€ä½³å®è·µï¼š7ä¸ªç»´åº¦+43æ¡è§„èŒƒ](http://kaito-kidd.com/2021/03/04/redis-best-practice-optimization-road/)
   - [Redisçš„15ä¸ªå‘](http://kaito-kidd.com/2021/03/14/redis-trap/)

### å®æˆ˜æ¡ˆä¾‹
1. [ç§’æ€ç³»ç»Ÿè®¾è®¡](https://gongfukangee.github.io/2019/06/09/SecondsKill/)
2. [å¾®ä¿¡æ­¥æ•°æ’è¡Œæ¦œå®ç°](https://www.cnblogs.com/zwwhnly/p/13041641.html)
3. [åˆ†å¸ƒå¼é”å®ç°](https://juejin.cn/post/6936956908007850014)
4. [BloomFilteråº”ç”¨](https://juejin.cn/post/6844903862072000526)

### æ€§èƒ½ä¼˜åŒ–
1. [ä½ çš„ Redis ä¸ºä»€ä¹ˆå˜æ…¢äº†ï¼Ÿ](https://cloud.tencent.com/developer/article/1724076)
2. [é˜¿é‡Œäº‘ Redis å»¶è¿Ÿäº‹ä»¶å¤„ç†å»ºè®®](https://help.aliyun.com/zh/redis/user-guide/suggestions-for-handling-common-latency-events)
3. [Redis å¸¸ç”¨å‘½ä»¤æ—¶é—´å¤æ‚åº¦](http://blog.caoxl.com/2018/11/28/Redis-Time-Complexity/)

### é¢è¯•é¢˜åº“
1. [Redis é¢è¯•é¢˜æ±‡æ€»](https://blog.csdn.net/ThinkWon/article/details/103522351)
2. [ä¸€ä¸å°å¿ƒè‚å‡ºäº†4Wå­—çš„Redisé¢è¯•æ•™ç¨‹](https://juejin.cn/post/6868409018151337991)

---

## æ›´æ–°æ—¥å¿—

- **2026-01-08**: é‡å¤§æ›´æ–°
  - âœ… æ–°å¢ Hash åº•å±‚å®ç°è¯¦è§£ï¼ˆziplist å­—èŠ‚çº§åˆ†æ + hashtable æ¸è¿›å¼ rehashï¼‰
  - âœ… æ–°å¢ String/List/Set/ZSet åº•å±‚å®ç°è¯´æ˜
  - âœ… æ–°å¢æ€§èƒ½ä¼˜åŒ–ç« èŠ‚ï¼ˆå¤§Key/çƒ­Key å¤„ç†ï¼‰
  - âœ… æ–°å¢ç›‘æ§å‘Šè­¦æ–¹æ¡ˆ
  - âœ… æ–°å¢å®æˆ˜æ¡ˆä¾‹ï¼ˆç§’æ€ã€æ’è¡Œæ¦œã€BloomFilterï¼‰
  - âœ… æ–°å¢å¯è§†åŒ–å›¾è¡¨ç´¢å¼•
  - âœ… ä¼˜åŒ–æ–‡ç« ç»“æ„ï¼Œå¢åŠ ç›®å½•å¯¼èˆª
  
- **2024-03-06**: åˆå§‹ç‰ˆæœ¬
  - åŸºç¡€å†…å®¹ï¼šæ•°æ®ç±»å‹ã€ç¼“å­˜ç­–ç•¥ã€æŒä¹…åŒ–ã€åˆ†å¸ƒå¼æ–¹æ¡ˆ

---

**æŒç»­æ›´æ–°ä¸­ï¼Œæ¬¢è¿æ”¶è—ï¼** ğŸš€
