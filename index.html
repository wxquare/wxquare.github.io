<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.2.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha256-XOqroi11tY4EFQMR9ZYwZWKj5ZXiftSx36RRuC3anlA=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"yoursite.com","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.20.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"always","padding":18,"offset":12},"copycode":{"enable":true,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script>

    <meta property="og:type" content="website">
<meta property="og:title" content="wxquare&#39;s Blogs">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="wxquare&#39;s Blogs">
<meta property="og:locale">
<meta property="article:author" content="wxquare">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://yoursite.com/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-Hans","comments":"","permalink":"","path":"index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>wxquare's Blogs</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">wxquare's Blogs</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li><li class="menu-item menu-item-friends"><a href="/friends" rel="section"><i class="fa fa-user fa-fw"></i>Friends</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="wxquare"
      src="/images/avatar.jpeg">
  <p class="site-author-name" itemprop="name">wxquare</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">32</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">3</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/yourname" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;yourname" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="/xianguiwang0316@gmail.com" title="E-Mail → xianguiwang0316@gmail.com" rel="noopener me"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2025/08/26/other/%E5%9F%BA%E4%BA%8EGithub%E5%8F%8C%E5%88%86%E6%94%AF%E5%92%8CHexo%E6%90%AD%E5%BB%BA%E5%8D%9A%E5%AE%A2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpeg">
      <meta itemprop="name" content="wxquare">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="wxquare's Blogs">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | wxquare's Blogs">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/08/26/other/%E5%9F%BA%E4%BA%8EGithub%E5%8F%8C%E5%88%86%E6%94%AF%E5%92%8CHexo%E6%90%AD%E5%BB%BA%E5%8D%9A%E5%AE%A2/" class="post-title-link" itemprop="url">基于Github双分支和Hexo搭建博客</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2025-08-26 12:10:31" itemprop="dateCreated datePublished" datetime="2025-08-26T12:10:31+08:00">2025-08-26</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/other/" itemprop="url" rel="index"><span itemprop="name">other</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="基本步骤"><a href="#基本步骤" class="headerlink" title="基本步骤"></a>基本步骤</h2><ul>
<li>hexo 文档：<a href="https://hexo.io/zh-cn/docs/">https://hexo.io/zh-cn/docs/</a></li>
<li>安装git、node、npm、hexo、next主题</li>
<li>在github建立wxquare.github.io仓库，两个branch，分别为master和hexo</li>
<li>使用markdown在hexo branch 写文章，hexo generate生成静态文件，并通过hexo deploy 部署到远端</li>
<li>申请域名wxquare.top，绑定wxquare.github.io</li>
<li><a href="https://wxquare.github.io/">https://wxquare.github.io/</a></li>
</ul>
<h2 id="写文章发布blog的流程"><a href="#写文章发布blog的流程" class="headerlink" title="写文章发布blog的流程"></a>写文章发布blog的流程</h2><ul>
<li>在hexo branch &#x2F;source&#x2F;_posts 下使用markdown写文章</li>
<li>使用hexo genergate 生成静态文件</li>
<li>hexo server 查看本地效果</li>
<li>hexo deploy 到远端</li>
<li>提交修改文件到hexo</li>
</ul>
   <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">npm i -g hexo  安装hexo</span><br><span class="line">hexo init  初始化  </span><br><span class="line">hexo generate  生成静态网页</span><br><span class="line">hexo server 启动服务器 （浏览器输入http://localhost:4000/验证是否正确。）</span><br><span class="line">hexo deploy 部署到远端 （wxquare.github.io）</span><br></pre></td></tr></table></figure>

<h2 id="hexo-配置"><a href="#hexo-配置" class="headerlink" title="hexo 配置"></a>hexo 配置</h2><ol>
<li>修改站点配置文件_config.yml，使得能将本地博客部署到github上 <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">deploy:</span><br><span class="line">  type: git</span><br><span class="line">  repo: https://github.com/wxquare/wxquare.github.io.git</span><br><span class="line">  branch: master</span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="next主题-配置"><a href="#next主题-配置" class="headerlink" title="next主题 配置"></a>next主题 配置</h2><ol>
<li>主题设置和修改。hexo初始化默认的主题是landscape，<a href="https://hexo.io/themes/">https://hexo.io/themes/</a>提供了许多的主题，根据喜好为博客的主题，主题的文档提供了使用方法，设置相应的参数，调整为自己喜欢的格式。我这里选择的Next主题</li>
<li>安装next主题：<a href="https://theme-next.js.org/docs/getting-started/">https://theme-next.js.org/docs/getting-started/</a></li>
<li>主题设置：<a href="https://theme-next.js.org/docs/theme-settings/">https://theme-next.js.org/docs/theme-settings/</a></li>
</ol>
<h2 id="其它"><a href="#其它" class="headerlink" title="其它"></a>其它</h2><ol>
<li>增加分类</li>
<li>hexo 增加支持markdown公式：<a href="http://stevenshi.me/2017/06/26/hexo-insert-formula/">http://stevenshi.me/2017/06/26/hexo-insert-formula/</a></li>
<li>博客中的图片，将图片放在hexo分支的source&#x2F;images目录下面，markdown和blog中均可以看到</li>
<li>Hexo博客Next主题添加统计文章阅读量功能：<a href="https://bjtu-hxs.github.io/2018/06/12/leancloud-config/">https://bjtu-hxs.github.io/2018/06/12/leancloud-config/</a></li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2025/08/26/other/%E5%9C%A8%E8%85%BE%E8%AE%AF%E7%9A%84%E5%85%AB%E5%B9%B4%EF%BC%8C%E6%88%91%E7%9A%84%E8%81%8C%E4%B8%9A%E6%80%9D%E8%80%83/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpeg">
      <meta itemprop="name" content="wxquare">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="wxquare's Blogs">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | wxquare's Blogs">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/08/26/other/%E5%9C%A8%E8%85%BE%E8%AE%AF%E7%9A%84%E5%85%AB%E5%B9%B4%EF%BC%8C%E6%88%91%E7%9A%84%E8%81%8C%E4%B8%9A%E6%80%9D%E8%80%83/" class="post-title-link" itemprop="url">【转】在腾讯的八年，我的职业思考</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2025-08-26 12:10:31" itemprop="dateCreated datePublished" datetime="2025-08-26T12:10:31+08:00">2025-08-26</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/other/" itemprop="url" rel="index"><span itemprop="name">other</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="一、"><a href="#一、" class="headerlink" title="一、"></a>一、</h2><p>今年是2018年，腾讯20周年。我30周岁，刚好在腾讯工作满8年。</p>
<p>我从来没有想过自己会在同一家公司工作8年。因为4年足以读完大学，6年能让小孩读完小学，8年漫长得不可思议。</p>
<p>2010年，我刚大学毕业，加入腾讯。那一天，学生思维的我，不免以学生的尺度定计划：三年的时间，我应该足够从这一所“社会大学”毕业吧。</p>
<p>因此，我追赶时间，以这个截止日为目标，第一年学习高效地完成工作，第二年学习带新人，第三年学习影响力，翻译了一本前端书，和一本设计书。</p>
<p>我一步步从助理UI工程师晋级到高级UI工程师，先是积极响应需求，后来主动找事情做。我低着头，做事情非常“用力”，自信能把交给我的事情都做得很好。</p>
<p>我的博客文章80%都是头三年写的，现在回头看有很多幼稚的想法，但持续想和写才能提高。反过来说，要是现在还觉得好，那才糟糕。</p>
<h2 id="二、"><a href="#二、" class="headerlink" title="二、"></a>二、</h2><p>2013年，三年之痒。我开始觉得日常工作毫无挑战，考评时连续“优秀”跟“超出预期”拿到手软，但与此同时，也迎来新的工作挑战。</p>
<p>那时，我的领导问我以后的发展意向，是想继续研究技术深度，还是管理团队。我说如果有机会，尽量管理团队吧。</p>
<p>因为以我的理解，并不存在两种选项。这个问题就像“给你加工资，好不好啊”一样没有意义。学而优则仕，骨干不去领导团队，可能有点不负责任（现在想来很自恋，呵呵）。</p>
<p>虽然给了领导这样的答复，也开始进行正式的管理培训，但我内心还恋恋不舍想保留一点匠人心态。</p>
<p>个人能力要继续提高，我就开辟新的赛道：影响力。</p>
<p>2014年我认真地投入到写作练习中，在“26岁总结”中写下这段文字：</p>
<p>“在很多场景下我们都需要写作，我们要写短小的RTX，长一点的邮件，以及更长一点的分享文章、博客和专栏。关于写作，我觉得最有趣的一个事实是，优秀的写作者跟平庸的写作者所能达到的效果相差百倍以上，比优秀程序员和平庸程序员之间的差别还大。”</p>
<p>“优秀的写作者的RTX就是能让对方明白他的目的，并且像施了魔咒一样去合作。优秀的写作者的邮件能让接受者感兴趣，清晰地知道信息。优秀的写作者写的博客能用一段话击中读者心理，情不自禁点右上角的“分享到朋友圈”……这种效果100个平庸的写作者都达不到。”</p>
<p>“写作者需要的除了文笔，还有逻辑思维、数据分析、麦肯锡金字塔理论、心理学等等几乎所有的知识……”</p>
<p>每个人每天都要阅读微信、朋友圈、新闻、读书、知乎、小视频……关于写作对个人能力的的重要性，我认为怎么强调都不为过。因为广义的写作、演讲和设计，它们有一个共同的关键内核，就是搞清楚你的听众是谁，他们已有哪些信息，缺乏哪些信息，你要以怎么样的顺序来传达你想让对方做的事情。讲得邪乎点，它们都是一种“心理操纵术”。</p>
<p>那怎么才能学好写作（或者演讲，或者设计）呢？</p>
<p>答案无趣但有效：持续写。</p>
<p>反复阅读写出来的文字，毫不吝啬地删除无用的信息，重新再写。</p>
<p>达芬奇说过一句话：“Simplicity is the ultimate form of sophistication（简洁是终极的复杂）”。海明威每天写作之前都会把前一天的稿再改一次。</p>
<p>我也这样做，一开始在自己博客上写水文、在豆瓣写书评，感觉不够。2014年2月，我加入豆瓣专栏计划，需要每周写一篇超过3000字的专栏文章，结束后能获得200元鼓励金。我就像一个缺乏运动的人，强行把自己推入马拉松赛道。</p>
<p>我的前几篇写的很业余，错别字、口水话、病句、缺主语、串主语、一逗到底、唠唠叨叨、层级和顺序不对……那也还是要写。几个月后，20篇文章的专栏完结了，我的文字水平稳定从30分提升到50分，接近及格。</p>
<p>因为专栏内容相对新颖（可能是国内首批系统写“全栈工程师”的思考的专栏），慢慢积累一些读者并每周追看。读者宽容并热情地在评论区给我纠错。</p>
<p>后来，人民邮电出版社的责编在豆瓣上看到了我，就约我写稿。他说我写的东西已经很多，也有一些脉络，可以再整理一下出书。又是一个新的挑战。</p>
<p>先答应再说吧。</p>
<p>写书的过程只能说勉力支撑，因为只有50分的文字水平，却要输出80分的质量。把第一章整理好之后发过去，收到返回的修正稿，变成了另一篇文章。责编很专业，没有吐槽，只是做客观订正。</p>
<p>我羞愧难当，因为痛恨给人添麻烦。我记住修改过的问题种类，文法上字斟句酌，保证同类的不再犯。</p>
<p>因为责编会看出文字上的问题，然后给我修剪枝丫，但保持大树根基稳定就是我自己的责任，对读者的责任。我还买来《麦肯锡教我的写作武器》，更系统地学习写作。</p>
<p>经过好多轮的校对，我终于可以坦然说出，差不多达到基本的标准了。后面的事情我在“我出书了”中也都写了。2015年8月，我的书出版了。我在豆瓣上也慎重给《Web全栈工程师的自我修养》打了4星。</p>
<h2 id="三、"><a href="#三、" class="headerlink" title="三、"></a>三、</h2><p>写作成长磕磕碰碰的同时，管理之路也迂回曲折。试着带一段时间团队之后，我在2014年正式成为团队管理者。</p>
<p>当时对于团队管理的职责抱有几个不成熟心态：</p>
<p>管理比写代码更容易掌握，践行起来也更轻松<br>管理者门槛较低，相较于工程师缺乏核心竞争力，以后跳槽我还是要以工程师身份来定位<br>我喜欢专注做事情，不适合做管理<br>在工程师团队中，我要以最强的技术和努力来赢得尊重，我要有能力解决他们都解决不了的问题<br>因此，从2014-2016虽然也通过努力收获了一些个人成长，但对团队领导来讲其实我是不称职的。</p>
<p>有一个明显不称职的表现就是，每到员工考核期间，我就很纠结痛苦。我不希望有员工拿低于预期的考评，也害怕面对下属沟通面谈，当面对着他说你的绩效低于预期。</p>
<p>我能自律勤奋，但我很难改变自己的观念。最难的是，我甚至不知道自己是否应该改变自己的观念（瞧，这就是为什么改变观念是最难的），还是说退回去做一个还不错的工程师好了。</p>
<p>我在这个观念段位大概停留了两年多，经过断断续续的实践、阅读、观察和自省，我终于升级了。期间纠结和思考过程可以从2014到2016的博客文章中可见一斑。</p>
<p>总之，升级后的我认为：</p>
<p>管理比写代码（或任何一门硬技能）更难于掌握，这是我跟一些技术专家沟通得到的共识。硬技能的学习可以通过读书、培训班，甚至网络视频来学习，然后持续练习，越来越熟练，直到产生一个输出物。这非常简单，只要掌握了学习的方法，几个月就能学习一门硬技能。而管理的学习需要真实观念的转变，这个观念改变可能需要几年时间。<br>管理的核心观念是“管理者必须善于做有效的决策”。<br>管理者要注重组织对外的贡献。基于贡献来衡量每个人的绩效。<br>我开始积极与团队沟通，日常中看到不符合要求的输出，我就会直截了当地说“这不行，达不到基本水准”。</p>
<p>虽然比较严格，但也没有看到团队氛围下降的情况。因为从员工角度来讲，虽然乐于处在一个人际关系融洽的团队中，但更大的述求是加入一个充满专业人士的团队。每人都能从其他人身上学到特定知识，每人表现都是专业的。</p>
<p>我不再担心员工考核，因为它是一个有效的管理工具。有些无法用言语传达到的信息，可以通过绩效考核来传达。而且平时对于低绩效的员工就要做好预期管理，言行一致员工就不会困惑。</p>
<h2 id="四、"><a href="#四、" class="headerlink" title="四、"></a>四、</h2><p>2017年，我慢慢成为一个资深的管理者。又一次对工作驾轻就熟时，再次迎来新的挑战——转换岗位，领导腾讯微云UX设计团队。</p>
<p>我喜欢这个挑战，一方面它确实是一个“很大挑战”，受虐症的我无法拒绝。另一方面我一直处于产品流程中偏后的位置，但也对前置的思考很感兴趣。</p>
<p>因此，我梳理了自己面临的挑战：</p>
<p>之前领导的团队都是工程师，而现在的团队由交互设计师和视觉设计师组成。虽然管理的基本法是相通的，但新团队的成员还需要更多熟悉<br>自己的设计专业能力不够，尤其是在视觉上，无法给到“怎么做”的建议<br>新的UX设计团队面临比以前更复杂的外部关系<br>如何帮助下属专业晋升<br>但我也有我的优势：</p>
<p>能轻松地理解版本管理、多平台特性、开发挑战等“工程”难题，然后管理好风险<br>参加了三年多设计部的管理会，对设计的“味道”有感觉。或者说品味远远高出实现能力<br>在UI方案上，我有用户同理心，不只是从“好看”来评判设计<br>我的演讲呈现能力和写作能力可以提升团队<br>唔，也不全是坏消息嘛。那就开始做吧！</p>
<p>前半年仍然是勉力支撑（哭），但因为团队都在看着自己，不自信也要自信起来。</p>
<p>工作之余多体验各种APP，收集UI、运营、营收、品牌等方面的案例，进一步提升“产品力”。老婆平时在使用新的APP，或者被活动吸引付费时，我就会在边上观察她的行为。看到精彩处，我还会请求暂停，截图发给我。</p>
<p>总之，我希望自己的专业成长能快速补上权限扩大带来的差距。</p>
<p>慢慢地，有一些“腾讯微云用户体验不错”的口碑了，在自己能影响的范围内，使用我能调用的资源，慢慢地补齐漏洞，提升体验。</p>
<p>但仍然能力有限，有时候会出现仓促出的方案不合理的情况。这时更加如履薄冰，不是怕外部批评我，而是怕连累授权给我的上司，和被我能力所限的团队。加上腾讯微云也是一个有历史包袱的产品，所以仍然离自己心中的理想产品差很多。</p>
<p>团队成长上的挑战同样很大。</p>
<p>我仔细观察每一个人的优缺点，用人所长。于此同时我还要横向去看部门其他设计师的输出，不希望相对独立的产品导致了封闭的专业氛围。这将是接下来花半年到一年重点要解决的。</p>
<p>我对现在这个挑战，还远远没到驾轻就熟的状态，可能还需要两年以上时间来消化，所以有时工作会觉得比前几年加起来还累。</p>
<p>我时常以山本耀司的话给自己打鸡血：</p>
<p>我从不相信什么懒洋洋的自由，我向往的自由是通过勤奋和努力实现更广阔的人生，那样的自由才是珍贵的、有价值的。我相信一万小时定律，我从来不相信天上掉馅饼的灵感和坐等的成就。做一个自由又自律的人，靠势必实现的决心认真地活着。</p>
<p>勤奋和努力只是基础，以大多数人的努力程度之低，还根本谈不上拼天赋。</p>
<p>疲劳和兴奋交替，成就和挫折并存，曲折前行，比轻松混日子更有趣。</p>
<h2 id="五、"><a href="#五、" class="headerlink" title="五、"></a>五、</h2><p>回头看，这八年来，我从来都只是“短暂地胜任”自己的工作。每当我觉得能够驾轻就熟地处理目前的日常，就会迎来新的挑战。</p>
<p>想到这一点，我突然悟到一种“佛性”的工作哲学：</p>
<p>每当你能胜任当前的工作，就会迎来更高难度的挑战。</p>
<p>每一个能胜任当前工作岗位的人，都会被提拔。继续胜任，那就继续提拔，直到不能胜任。</p>
<p>因此，不用特别在意自己的头衔、权限和职级，外部的认可是你能力的反馈。你没有被提拔，大概率是因为还不胜任当前工作。如果完全胜任还没有被安排更有挑战的工作，要么自己找事情做，要么跳槽转岗。</p>
<p>反过来说，自知自己能力还达不到岗位要求也不用担心，不胜任是常态，以胜任为目标就好啦。</p>
<p>对于职场马拉松来说，心态放松，保持作息，持续养成好的习惯，学习好的方法和观念，这才是最重要的。</p>
<p>我写字的地方迁移到公众号啦~欢迎关注我的公众号：余果专栏</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2025/08/26/AI/%E5%88%9D%E5%A7%8BOpenCL%E5%8F%8A%E5%9C%A8%E7%9A%84%E7%A7%BB%E5%8A%A8%E7%AB%AF%E7%9A%84%E4%B8%80%E4%BA%9B%E6%B5%8B%E8%AF%95%E6%95%B0%E6%8D%AE/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpeg">
      <meta itemprop="name" content="wxquare">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="wxquare's Blogs">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | wxquare's Blogs">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/08/26/AI/%E5%88%9D%E5%A7%8BOpenCL%E5%8F%8A%E5%9C%A8%E7%9A%84%E7%A7%BB%E5%8A%A8%E7%AB%AF%E7%9A%84%E4%B8%80%E4%BA%9B%E6%B5%8B%E8%AF%95%E6%95%B0%E6%8D%AE/" class="post-title-link" itemprop="url">初识OpenCL及在移动端的一些测试数据</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2025-08-26 12:10:31" itemprop="dateCreated datePublished" datetime="2025-08-26T12:10:31+08:00">2025-08-26</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/AI/" itemprop="url" rel="index"><span itemprop="name">AI</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>　　最近在做kcf算法在移动端优化的相关工作，由于kcf算法计算量太大，而移动端计算性能有限，因此打算将kcf部分耗时操作通过GPU计算进行提升算法的性能。由于接触GPU和OpenCL的时间比较短，原理性的东西理解得也不深刻，本文主要在移动端测试了一些GPU和OpenCL的数据，无法分析内在原因，方便后续移动端算法优化。主要工作如下：</p>
<ol>
<li>编译了OpenCL的opencv版本sdk，测试了mat到umat相互内存拷贝和cvtcolor函数的性能。</li>
<li>测试了OpenCL核心API的性能</li>
<li>以内存拷贝核函数为例，测试OpenCL work_item数量与效率的关系。</li>
<li>测试OpenCL多commandqueue的性能</li>
</ol>
<h2 id="一、opencv-OpenCL"><a href="#一、opencv-OpenCL" class="headerlink" title="一、opencv+OpenCL"></a>一、opencv+OpenCL</h2><h3 id="1-1-编译opencv-OpenCL的sdk"><a href="#1-1-编译opencv-OpenCL的sdk" class="headerlink" title="1.1 编译opencv+OpenCL的sdk"></a>1.1 编译opencv+OpenCL的sdk</h3><p>　　KCF算法总使用了不少的opencv函数，开始想的是编译一个包含OpenCL的opencv的sdk，然后通过调用该sdk从而实现使用GPU加速算法的目的。编译opencv+OpenCL的sdk当时踩了不少坑，多番尝试之后，使用下面的命令是可以成功编译。分别下载opencv-3.4.6、android-ndk-r16b、opencv_contrib-3.4.6,在opencv中建build目录，运行下面命令，命令中使用一些路径相关的参数要根据环境适当修改。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cmake -DCMAKE_BUILD_WITH_INSTALL_RPATH=ON -DCMAKE_TOOLCHAIN_FILE=&quot;/home/xxx/code/mobile/third_party/ opencv-3.4.6/platforms/android/android.toolchain.cmake&quot; -DANDROID_NDK=&quot;/home/xxx/code/mobile/tools/android-ndk-r16b&quot; -DANDROID_SDK=&quot;/home/xxx/code/mobile/tools/android_sdk/tools&quot; -DANDROID_NATIVE_API_LEVEL=19 -DANDROID_ABI=&quot;arm64-v8a&quot; -DANDROID_ARM_NEON=TRUE -DANDROID_STL=gnustl_static -DCMAKE_BUILD_TYPE=Release -DOPENCV_EXTRA_MODULES_PATH=&quot;/home/xxx/code/mobile/third_party/opencv_contrib-3.4.6/modules&quot; -DCMAKE_INSTALL_PREFIX=&quot;/home/xxx/code/mobile/third_party/opencv-3.4.6/install_20190623_OpenCL&quot; -DBUILD_opencv_java=ON -DBUILD_ANDROID_PROJECTS=OFF -DBUILD_ANDROID_EXAMPLES=OFF -DBUILD_DOCS=OFF -DBUILD_PERF_TESTS=OFF -DBUILD_TESTS=OFF -DBUILD_FAT_JAVA_LIB=OFF -DWITH_OpenCL=ON -DWITH_CUDA=OFF -DWITH_MATLAB=OFF -DBUILD_opencv_aruco=OFF -DBUILD_opencv_calib3d=OFF -DBUILD_opencv_features2d=OFF .. </span><br></pre></td></tr></table></figure>
<h3 id="1-2-测试mat到umat的相互转换的性能"><a href="#1-2-测试mat到umat的相互转换的性能" class="headerlink" title="1.2 测试mat到umat的相互转换的性能"></a>1.2 测试mat到umat的相互转换的性能</h3><p>　　在编译好opencv sdk之后，首先简单测试了一下sdk是否使用到了GPU资源。测试图片从CPU拷贝到GPU的的性能，opencv提供两组API。UMat::copyTo(OutputArray dst)和Mat::getMat(int access_flags)，实际测试中发现copyto那组性能比get的性能更好些，mat.getUmat函数会报错，还不知道什么原因。  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">void testMatCopyToUmat(const char* img, int times) &#123;</span><br><span class="line">    cv::Mat image = cv::imread(img, cv::IMREAD_UNCHANGED);</span><br><span class="line">    cv::Mat out;</span><br><span class="line">    cv::UMat u_img;</span><br><span class="line">    if (u_img.empty())&#123;</span><br><span class="line">        //</span><br><span class="line">    &#125;</span><br><span class="line">    struct timeval start, end;</span><br><span class="line">    struct timeval last_time;</span><br><span class="line">    gettimeofday(&amp;start, NULL);</span><br><span class="line">    last_time = start;</span><br><span class="line">    for (int i = 0; i &lt; times; i++) &#123;</span><br><span class="line">        image.copyTo(u_img);</span><br><span class="line">        //cv::cvtColor(image, out, cv::COLOR_BGR2GRAY);</span><br><span class="line">        gettimeofday(&amp;end, NULL);</span><br><span class="line">        P(&quot;mat.copyToUmat:%d,run times:%d, spend:%d us&quot;, i,times, (end.tv_sec - last_time.tv_sec) * 1000000 + </span><br><span class="line">                                       (end.tv_usec - last_time.tv_usec));</span><br><span class="line">        last_time = end;</span><br><span class="line">    &#125;</span><br><span class="line">    gettimeofday(&amp;end, NULL);</span><br><span class="line">    P(&quot;mat.copyToUmat: run times:%d, spend:%d ms&quot;, times, (end.tv_sec - start.tv_sec) * 1000 + </span><br><span class="line">                                       (end.tv_usec - start.tv_usec)/1000);</span><br><span class="line">&#125;</span><br><span class="line">void testUMatCopyToMat(const char* img, int times) &#123;</span><br><span class="line">    cv::Mat image = cv::imread(img, cv::IMREAD_UNCHANGED);</span><br><span class="line">    cv::Mat out;</span><br><span class="line">    struct timeval start, end,last_time;</span><br><span class="line">    cv::UMat u_img;</span><br><span class="line">    image.copyTo(u_img);</span><br><span class="line"></span><br><span class="line">    gettimeofday(&amp;start, NULL);</span><br><span class="line">    last_time = start;</span><br><span class="line">    for (int i = 0; i &lt; times; i++) &#123;</span><br><span class="line">        u_img.copyTo(out);</span><br><span class="line">        gettimeofday(&amp;end, NULL);</span><br><span class="line">        P(&quot;mat.copyToUmat:%d,run times:%d, spend:%d us&quot;, i,times, (end.tv_sec - last_time.tv_sec) * 1000000 + </span><br><span class="line">                                       (end.tv_usec - last_time.tv_usec));</span><br><span class="line">        last_time = end;</span><br><span class="line">    &#125;</span><br><span class="line">    gettimeofday(&amp;end, NULL);</span><br><span class="line">    P(&quot;mat.copyToUmat: run times:%d, spend:%d ms&quot;, times, (end.tv_sec - start.tv_sec) * 1000 + </span><br><span class="line">                                       (end.tv_usec - start.tv_usec)/1000);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>| 手机型号 | CPU型号 | GPU型号 | OpenCL版本 | 首次mat拷贝umat | mat拷贝umat | 首次umat拷贝mat | umat拷贝mat | 图片格式 | 上行带宽 | 下行带宽 |<br>| —— | —— | —— | —— | —— | —— | —— | —— | —— | —— | —— | —— | —— | —— | —— |<br>|三星GALAXY On7|高通 骁龙410 MSM8916|	Adreno306|	2|	25.2ms|	0.8ms|	1.5ms|	0.8ms|	720<em>480 159KB|	运行1000次，221M&#x2F;s|	运行1000次，258M&#x2F;s|<br>|三星GALAXY On7|高通 骁龙410 MSM8916|	Adreno306|	2|	30.18ms|	2.88ms|	5.5ms|	2.9ms|	1920</em>1080 6MB|	运行1000次，2.14G&#x2F;s|	运行1000次，2.14G&#x2F;s|<br>|小米6 MI6|	骁龙 835|	高通 Adreno540|	2|16.602ms|	0.754ms|	2.85ms|	0.795ms|	1920<em>1080 6MB|	运行1000次，7.9G&#x2F;s|	运行1000次，8.06G&#x2F;s|<br>|小米6 MI6|	骁龙 835|	高通 Adreno540|	2|17.010ms|	0.332ms|	1ms|0.265ms|	720</em>480 159KB|	运行1000次，632M&#x2F;S|	运行1000次，898.2M&#x2F;s|	<br>|小米mix2s|	骁龙 845|	高通 Adreno630|	2|8.7ms|	2.1ms|	6.1ms|0.9ms|	1920<em>1080 6MB|	运行1000次，6.6G&#x2F;S|	运行1000次，6.62G&#x2F;s|	<br>|小米mix2s|	骁龙 845|	高通 Adreno630|	2|3.3ms|	0.5ms|	2.2ms|0.4ms|	720</em>480 1579KB|	运行1000次，654M&#x2F;S|	运行1000次，682M&#x2F;s|																</p>
<h3 id="1-3-测试OpenCL-cvtcolor函数性能"><a href="#1-3-测试OpenCL-cvtcolor函数性能" class="headerlink" title="1.3 测试OpenCL cvtcolor函数性能"></a>1.3 测试OpenCL cvtcolor函数性能</h3><p>　　在测试完CPU和GPU内存拷贝的性能之外，之后测试了cvtcolor函数的性能，由于动态加载，OpenCL函数首次加载时特别耗时，大概需要200ms。除此之外，在不同规格的图片上，OpenCL的计算性能大概是cpu的2到3倍。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">void cpu(const char* img, int times) &#123;</span><br><span class="line">    cv::Mat image; </span><br><span class="line">    cv::Mat out;</span><br><span class="line">    struct timeval start, end,last;</span><br><span class="line">    for (int i = 0; i &lt; times; i++) &#123;</span><br><span class="line">        image = cv::imread(img, cv::IMREAD_UNCHANGED);</span><br><span class="line">        gettimeofday(&amp;start, NULL);</span><br><span class="line">        cv::cvtColor(image, out, cv::COLOR_BGR2GRAY);</span><br><span class="line">        gettimeofday(&amp;end, NULL);</span><br><span class="line">        P(&quot;run times:%d, spend:%d us&quot;, i, (end.tv_sec - start.tv_sec) * 1000000 +</span><br><span class="line">                                       (end.tv_usec - start.tv_usec));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">void OpenCL(const char* img, int times) &#123;</span><br><span class="line">    cv::UMat u_img;</span><br><span class="line">    cv::Mat image; </span><br><span class="line">    cv::UMat out;</span><br><span class="line">    cv::Mat out1;</span><br><span class="line"></span><br><span class="line">    std::vector&lt;cv::UMat&gt; v;</span><br><span class="line">    for(int i=0;i&lt;times;i++)&#123;</span><br><span class="line">      image = cv::imread(img, cv::IMREAD_UNCHANGED);</span><br><span class="line">      cv::UMat u_img;</span><br><span class="line">      image.copyTo(u_img);</span><br><span class="line">      v.push_back(u_img);</span><br><span class="line">    &#125;</span><br><span class="line">    struct timeval start, end,last;</span><br><span class="line">    for (int i = 0; i &lt; times; i++) &#123;</span><br><span class="line">        gettimeofday(&amp;start, NULL);</span><br><span class="line">        cv::cvtColor(v[i], out, cv::COLOR_BGR2GRAY);</span><br><span class="line">        gettimeofday(&amp;end, NULL);</span><br><span class="line">        P(&quot;run times:%d, spend:%d us&quot;, i, (end.tv_sec - start.tv_sec) * 1000000 +</span><br><span class="line">                                       (end.tv_usec - start.tv_usec));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>测试数据：</p>
<table>
<thead>
<tr>
<th>手机型号</th>
<th>cpu&#x2F;gpu</th>
<th>图片格式</th>
<th>首次运行时间</th>
<th>平均时间</th>
</tr>
</thead>
<tbody><tr>
<td>三星GALAXY On7</td>
<td>cpu</td>
<td>1920x1080</td>
<td>3.2ms</td>
<td>1.8ms</td>
</tr>
<tr>
<td>三星GALAXY On7</td>
<td>OpenCL</td>
<td>1920x1080</td>
<td>273ms</td>
<td>0.6ms</td>
</tr>
<tr>
<td>三星GALAXY On7</td>
<td>cpu</td>
<td>720x480</td>
<td>1.2ms</td>
<td>0.62ms</td>
</tr>
<tr>
<td>三星GALAXY On7</td>
<td>OpenCL</td>
<td>720x480</td>
<td>274ms</td>
<td>0.25ms</td>
</tr>
<tr>
<td>小米mix2s</td>
<td>cpu</td>
<td>1920x1080</td>
<td>3ms</td>
<td>1.3ms</td>
</tr>
<tr>
<td>小米mix2s</td>
<td>OpenCL</td>
<td>1920x1080</td>
<td>154ms</td>
<td>0.36ms</td>
</tr>
<tr>
<td>小米mix2s</td>
<td>cpu</td>
<td>720x480</td>
<td>0.5ms</td>
<td>0.21ms</td>
</tr>
<tr>
<td>小米mix2s</td>
<td>OpenCL</td>
<td>720x480</td>
<td>80.5ms</td>
<td>0.09ms</td>
</tr>
</tbody></table>
<h2 id="二、OpenCL核心API性能测试"><a href="#二、OpenCL核心API性能测试" class="headerlink" title="二、OpenCL核心API性能测试"></a>二、OpenCL核心API性能测试</h2><table>
<thead>
<tr>
<th>手机型号</th>
<th>cpux型号</th>
<th>GPU型号</th>
<th>OpenCL版本</th>
<th>API</th>
<th>测试数据</th>
</tr>
</thead>
<tbody><tr>
<td>小米6 MI6</td>
<td>骁龙 835</td>
<td>高通 Adreno540</td>
<td>2</td>
<td>gpu内存分配(clCreateBuffer)</td>
<td>1M 430us,5M 1000us,10M 2000us</td>
</tr>
<tr>
<td>小米6 MI6</td>
<td>骁龙 835</td>
<td>高通 Adreno540</td>
<td>2</td>
<td>cpu到gpu内存拷贝(writeBuffer)</td>
<td>1M 105us,5M 400us,10M 700us</td>
</tr>
<tr>
<td>小米6 MI6</td>
<td>骁龙 835</td>
<td>高通 Adreno540</td>
<td>2</td>
<td>gpu到cpu内存拷贝(ReadBuffer)</td>
<td>1M 60us,5M 400us,10M 600us</td>
</tr>
<tr>
<td>小米6 MI6</td>
<td>骁龙 835</td>
<td>高通 Adreno540</td>
<td>2</td>
<td>核函数编译clBuildProgram</td>
<td>69682 us</td>
</tr>
<tr>
<td>小米6 MI6</td>
<td>骁龙 835</td>
<td>高通 Adreno540</td>
<td>2</td>
<td>创建核对象clCreateKernel</td>
<td>50us</td>
</tr>
<tr>
<td>小米6 MI6</td>
<td>骁龙 835</td>
<td>高通 Adreno540</td>
<td>2</td>
<td>核函数clEnqueueNDRangeKernel</td>
<td>首次运行5000us，之后大概800us</td>
</tr>
</tbody></table>
<h2 id="三、-测试OpenCL-work-item数量与效率的关系"><a href="#三、-测试OpenCL-work-item数量与效率的关系" class="headerlink" title="三、 测试OpenCL work_item数量与效率的关系"></a>三、 测试OpenCL work_item数量与效率的关系</h2><p>　　在OpenCL编程中，work_item和work_group的设置对程序的性能有较大的影响。这里以内存拷贝为例测试OpenCL中work_item数量与效率的关系。通过一张3840x2160的图片拷贝，分别测试了CPU和GPU内存拷贝的性能，测试了在不同work_item条件下GPU内存拷贝性能的性能。从测试结果来看，不同work_item对opencl的性能有较大的影响。测试结果显示，最开始时work_item数量曾倍数关系，之后会在100ms抖动，最好的情况是work_item数量与bmpsize大小相同。测试机器为小米mix2s。</p>
<h3 id="3-1循环拷贝"><a href="#3-1循环拷贝" class="headerlink" title="3.1循环拷贝"></a>3.1循环拷贝</h3><p>bmpsize &#x3D; 3840x2160x3,运行时间13ms</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">char* out = new char[bmp_size];</span><br><span class="line"> for(int i=0;i&lt;bmp_size;i++)&#123;</span><br><span class="line">   // P(&quot;%d&quot;,i);</span><br><span class="line">   out[i] = bmp_data[i];</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-2memcpy拷贝"><a href="#3-2memcpy拷贝" class="headerlink" title="3.2memcpy拷贝"></a>3.2memcpy拷贝</h3><p>bmpsize &#x3D; 3840x2160x3,运行时间3ms</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">memcpy(out,bmp_data,bmp_size);</span><br></pre></td></tr></table></figure>

<h3 id="3-3-opencl拷贝"><a href="#3-3-opencl拷贝" class="headerlink" title="3.3 opencl拷贝"></a>3.3 opencl拷贝</h3><p>核函数：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">__kernel void convert_image(__global const uchar* in, </span><br><span class="line">            __global uchar* out，const int channel,</span><br><span class="line">            const int width, const int height)&#123;</span><br><span class="line">    int thread_count = get_global_size(0);</span><br><span class="line">    int size = width * height * channel;</span><br><span class="line">    int each_thread = size / thread_count;</span><br><span class="line">    int tid = get_global_id(0);</span><br><span class="line">    ; out[tid] = in[tid];</span><br><span class="line">    for(int i=tid*each_thread;i&lt;(tid+1)*each_thread;i++)&#123;</span><br><span class="line">        out[i] = in[i];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>关键代码与work_item的设置：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">P(&quot;thread_count=%d&quot;, thread_count);</span><br><span class="line">gettimeofday(&amp;start,NULL);</span><br><span class="line">err = queue.enqueueNDRangeKernel(kernel, cl::NullRange, cl::NDRange(thread_count, 1),</span><br><span class="line">                           cl::NullRange, NULL, &amp;event);</span><br><span class="line">event.wait();</span><br><span class="line">gettimeofday(&amp;end,NULL);</span><br><span class="line">P(&quot;opecl wait:%d ms&quot;, (end.tv_sec - start.tv_sec) * 1000 + (end.tv_usec - start.tv_usec)/1000);</span><br></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th>work_item数量</th>
<th>运行时间</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>2972ms</td>
</tr>
<tr>
<td>2</td>
<td>1526ms</td>
</tr>
<tr>
<td>4</td>
<td>792ms</td>
</tr>
<tr>
<td>8</td>
<td>418ms</td>
</tr>
<tr>
<td>16</td>
<td>252ms</td>
</tr>
<tr>
<td>32</td>
<td>166ms</td>
</tr>
<tr>
<td>64</td>
<td>122ms</td>
</tr>
<tr>
<td>128</td>
<td>104ms</td>
</tr>
<tr>
<td>256</td>
<td>64ms</td>
</tr>
<tr>
<td>512</td>
<td>60ms</td>
</tr>
<tr>
<td>1024</td>
<td>92ms</td>
</tr>
<tr>
<td>2048</td>
<td>662ms</td>
</tr>
<tr>
<td>4096</td>
<td>237ms</td>
</tr>
<tr>
<td>10240</td>
<td>180ms</td>
</tr>
<tr>
<td>102400</td>
<td>171ms</td>
</tr>
<tr>
<td>248832</td>
<td>167ms</td>
</tr>
<tr>
<td>2488320</td>
<td>16ms</td>
</tr>
<tr>
<td>24883200</td>
<td>15ms</td>
</tr>
</tbody></table>
<p><strong>疑问:当work_item为256或者512是个较好的值，但是不明白为什么2488320和24883200值效果会更好。</strong></p>
<h2 id="四、多commandqueue性能测试"><a href="#四、多commandqueue性能测试" class="headerlink" title="四、多commandqueue性能测试"></a>四、多commandqueue性能测试</h2><p>　　在学习和测试OpenCL的过程中，有一个疑问能否使用多个commandqueue来做任务的并行。假设有n个任务，每个任务包含CPU到GPU内存拷贝，核函数执行，和GPU到CPU的内存拷贝。分别测试了使用一个commandqueue和n个commandqueue的性能，测试结果显示多个commandqueue会比使用单个commandqueue性能略好一些，但是差别不大。除此之外，与work_item的设置有关，多个commandqueue可能比单个commandqueue性能性能提升15%。从GPU利用率来说，单个commandqueuGPU曲线呈锯齿形状，而多个commandque呈梯形。部分代码如下：<br>单个commandqueue：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line">void test(const char* cl_file, const char* name, </span><br><span class="line">      const char* bmp_data, const int bmp_size, </span><br><span class="line">      const int width, const int height, const int channels,</span><br><span class="line">      const int line_size, const int thread_count,</span><br><span class="line">      const int run_times) </span><br><span class="line">&#123;</span><br><span class="line">  cl::Platform platforms = cl::Platform::getDefault();</span><br><span class="line">  //P(&quot;platform count:%d&quot;, platforms.size());</span><br><span class="line">  cl::Context context(CL_DEVICE_TYPE_GPU, NULL);</span><br><span class="line">  std::vector&lt;cl::Device&gt; devices = context.getInfo&lt;CL_CONTEXT_DEVICES&gt;();</span><br><span class="line">  P(&quot;Device count:%d&quot;, devices.size());</span><br><span class="line">  std::ifstream in(cl_file, std::ios::in);</span><br><span class="line">  std::stringstream buffer;</span><br><span class="line">  buffer &lt;&lt; in.rdbuf();</span><br><span class="line">  cl_int err = CL_SUCCESS;</span><br><span class="line">  cl::Program program_ = cl::Program(context, buffer.str());</span><br><span class="line">  err = program_.build(devices);</span><br><span class="line">  if (err != CL_SUCCESS) &#123;</span><br><span class="line">    P(&quot;build error&quot;);</span><br><span class="line">    return;</span><br><span class="line">  &#125;  </span><br><span class="line">  cl::Kernel kernel(program_, name, &amp;err);</span><br><span class="line">  if (err != CL_SUCCESS) &#123;</span><br><span class="line">    P(&quot;build error&quot;);</span><br><span class="line">    return;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  cl::CommandQueue queue(context, devices[0], 0, &amp;err);</span><br><span class="line">  if (err != CL_SUCCESS) &#123;</span><br><span class="line">    P(&quot;CommandQueue create error&quot;);</span><br><span class="line">    return;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  struct timeval start, end;</span><br><span class="line">  cl::Event event;</span><br><span class="line">  err = CL_SUCCESS;</span><br><span class="line">  for(int i = 0;i&lt;run_times;i++)&#123;</span><br><span class="line">  &#123;</span><br><span class="line">   </span><br><span class="line">    //see: https://github.khronos.org/OpenCL-CLHPP/classcl_1_1_buffer.html</span><br><span class="line">    cl::Buffer in_buf(context, CL_MEM_WRITE_ONLY, bmp_size);</span><br><span class="line">    cl::Buffer out_buf(context, CL_MEM_READ_ONLY, bmp_size);</span><br><span class="line">    err = queue.enqueueWriteBuffer(in_buf, true, 0, bmp_size, bmp_data, NULL, &amp;event);</span><br><span class="line"></span><br><span class="line">    kernel.setArg(0, in_buf);</span><br><span class="line">    kernel.setArg(1, out_buf);</span><br><span class="line">    kernel.setArg(2, line_size);</span><br><span class="line">    kernel.setArg(3, channels);</span><br><span class="line">    kernel.setArg(4, width);</span><br><span class="line">    kernel.setArg(5, height);</span><br><span class="line"></span><br><span class="line">    P(&quot;thread_count=%d&quot;, thread_count);</span><br><span class="line">    gettimeofday(&amp;start,NULL);</span><br><span class="line">    err = queue.enqueueNDRangeKernel(kernel, cl::NullRange, cl::NDRange(thread_count, 1),</span><br><span class="line">                               cl::NullRange, NULL, &amp;event);</span><br><span class="line">    event.wait();</span><br><span class="line">    gettimeofday(&amp;end,NULL);</span><br><span class="line">    P(&quot;opecl wait:%d ms&quot;, (end.tv_sec - start.tv_sec) * 1000 + </span><br><span class="line">                                         (end.tv_usec - start.tv_usec)/1000);</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line">    char* h_out_buf = new char[bmp_size];</span><br><span class="line">    err = queue.enqueueReadBuffer(out_buf, true, 0, bmp_size, h_out_buf, NULL, &amp;event);</span><br><span class="line">    if(0!=memcmp(h_out_buf, bmp_data, bmp_size))&#123;</span><br><span class="line">      P(&quot;data not same&quot;);</span><br><span class="line">      return;</span><br><span class="line">    &#125;else&#123;</span><br><span class="line">      P(&quot;data same&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>多个commandqueue：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line">void test_mutil_command_queue(const char* cl_file, const char* name, </span><br><span class="line">      const char* bmp_data, int bmp_size, </span><br><span class="line">      const int width, const int height, const int channels,</span><br><span class="line">      const int line_size, const int thread_count,</span><br><span class="line">      const int run_times) </span><br><span class="line">&#123;</span><br><span class="line">  cl::Platform platforms = cl::Platform::getDefault();</span><br><span class="line">  //P(&quot;platform count:%d&quot;, platforms.size());</span><br><span class="line">  cl::Context context(CL_DEVICE_TYPE_GPU, NULL);</span><br><span class="line">  std::vector&lt;cl::Device&gt; devices = context.getInfo&lt;CL_CONTEXT_DEVICES&gt;();</span><br><span class="line">  P(&quot;Device count:%d&quot;, devices.size());</span><br><span class="line">  // cl::CommandQueue queue(context, devices[0], 0);</span><br><span class="line">  //</span><br><span class="line">  std::ifstream in(cl_file, std::ios::in);</span><br><span class="line">  std::stringstream buffer;</span><br><span class="line">  buffer &lt;&lt; in.rdbuf();</span><br><span class="line">  //</span><br><span class="line">  //cl::Program::Sources source&#123;</span><br><span class="line">  //    std::make_pair(buffer.str().c_str(), buffer.str().size()) &#125;;</span><br><span class="line">  cl_int err = CL_SUCCESS;</span><br><span class="line">  cl::Program program_ = cl::Program(context, buffer.str());</span><br><span class="line">  err = program_.build(devices);</span><br><span class="line">  if (err != CL_SUCCESS) &#123;</span><br><span class="line">    P(&quot;build error %d&quot;,err);</span><br><span class="line">    return;</span><br><span class="line">  &#125;  </span><br><span class="line"></span><br><span class="line">  struct timeval start, end,end2;</span><br><span class="line">  cl::Event event;</span><br><span class="line">  err = CL_SUCCESS;</span><br><span class="line">  gettimeofday(&amp;start, NULL);</span><br><span class="line">  std::vector&lt;cl::CommandQueue&gt; vQueue;</span><br><span class="line">  std::vector&lt;cl::Event&gt; vEvents;</span><br><span class="line">  std::vector&lt;cl::Buffer&gt; vInBuffers;</span><br><span class="line">  std::vector&lt;cl::Buffer&gt; vOutBuffers;</span><br><span class="line">  std::vector&lt;char*&gt; vHostOutBuf;</span><br><span class="line">  std::vector&lt;cl::Kernel&gt; vKernels;</span><br><span class="line">  std::vector&lt;char*&gt; vBmpdatas;</span><br><span class="line"></span><br><span class="line">  for(int i=0;i&lt;run_times;i++)&#123;</span><br><span class="line">    cl::Event event;</span><br><span class="line">    cl::CommandQueue queue(context, devices[0], 0, &amp;err);</span><br><span class="line">      if (err != CL_SUCCESS) &#123;</span><br><span class="line">      P(&quot;CommandQueue create error&quot;);</span><br><span class="line">      return;</span><br><span class="line">    &#125;</span><br><span class="line">    vQueue.push_back(queue);</span><br><span class="line">    vEvents.push_back(event);</span><br><span class="line">    cl::Buffer in_buf(context, CL_MEM_WRITE_ONLY, bmp_size);</span><br><span class="line">    cl::Buffer out_buf(context, CL_MEM_READ_ONLY, bmp_size);</span><br><span class="line">    vInBuffers.push_back(in_buf);</span><br><span class="line">    vOutBuffers.push_back(out_buf);</span><br><span class="line">    char* h_out_buf = new char[bmp_size];</span><br><span class="line">    vHostOutBuf.push_back(h_out_buf);</span><br><span class="line"></span><br><span class="line">    cl::Kernel kernel(program_, name, &amp;err);</span><br><span class="line">    if (err != CL_SUCCESS) &#123;</span><br><span class="line">      P(&quot;build error&quot;);</span><br><span class="line">      return;</span><br><span class="line">    &#125;</span><br><span class="line">    kernel.setArg(0, vInBuffers[i]);</span><br><span class="line">    kernel.setArg(1, vOutBuffers[i]);</span><br><span class="line">    kernel.setArg(2, line_size);</span><br><span class="line">    kernel.setArg(3, channels);</span><br><span class="line">    kernel.setArg(4, width);</span><br><span class="line">    kernel.setArg(5, height);</span><br><span class="line">    vKernels.push_back(kernel);</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line">  gettimeofday(&amp;end, NULL);</span><br><span class="line">  P(&quot;opecl create queue: spend:%d ms&quot;, (end.tv_sec - start.tv_sec) * 1000 + </span><br><span class="line">                                       (end.tv_usec - start.tv_usec)/1000);</span><br><span class="line"></span><br><span class="line">  for(int i=0;i&lt;run_times;i++)&#123;</span><br><span class="line">    err = vQueue[i].enqueueWriteBuffer(vInBuffers[i], false, 0, bmp_size, bmp_data, NULL, &amp;vEvents[i]);</span><br><span class="line">  &#125;</span><br><span class="line">  for(int i=0;i&lt;run_times;i++)&#123;</span><br><span class="line">    vEvents[i].wait();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  for(int i=0;i&lt;run_times;i++)&#123;</span><br><span class="line">    err = vQueue[i].enqueueNDRangeKernel(vKernels[i], cl::NullRange, cl::NDRange(thread_count, 1),</span><br><span class="line">                                 cl::NullRange, NULL, &amp;vEvents[i]);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  for (int i = 0; i &lt; run_times; ++i)&#123; </span><br><span class="line">    vEvents[i].wait();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  for(int i=0;i&lt;run_times;i++)&#123;</span><br><span class="line">    err = vQueue[i].enqueueReadBuffer(vOutBuffers[i], false, 0, bmp_size, vHostOutBuf[i], NULL, &amp;vEvents[i]);</span><br><span class="line">  &#125;</span><br><span class="line">  for(int i=0;i&lt;run_times;i++)&#123;</span><br><span class="line">    vEvents[i].wait();</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  for(int i=0;i&lt;run_times;i++)&#123;</span><br><span class="line">    if (0!=memcmp(vHostOutBuf[i], bmp_data, bmp_size))&#123;</span><br><span class="line">      P(&quot;data not same&quot;);</span><br><span class="line">    &#125;else&#123;</span><br><span class="line">      P(&quot;data same&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2025/08/26/AI/tensorflow-model-quantization/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpeg">
      <meta itemprop="name" content="wxquare">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="wxquare's Blogs">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | wxquare's Blogs">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/08/26/AI/tensorflow-model-quantization/" class="post-title-link" itemprop="url">tensorflow模型权重量化(weight quantization)实战</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2025-08-26 12:10:31" itemprop="dateCreated datePublished" datetime="2025-08-26T12:10:31+08:00">2025-08-26</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/AI/" itemprop="url" rel="index"><span itemprop="name">AI</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>　　<br>　　最近在尝试深度学习模型加速的工作，查了一些资料，发现模型推理加速的研究还挺多的，主要从四个方面进行，从头开始构建轻量高效的模型，例如mobileNets、squeezenet等；通过量化(quantization)、裁剪(pruning)和压缩(compression)来降低模型的尺寸；通过高效的计算平台加速推理(inference)的效率，例如Nvidia TensorRT、GEMMLOWP、Intel MKL-DNN等以及硬件定制。考虑到自身的能力，遵循从简单到复杂、通用到专用的原则，选择从模型量化(model quantization)入手，之后会陆续尝试其他优化手段。在一番尝试之后，挺遗憾的，因为tensorflow模型量化并没有使模型预测(inference)加速，根据tf成员在issue的回复，tf的模型量化主要针对移动端的优化，目前还没有针对x86和gpu环境的优化。<strong>有成功通过模型量化加速推理过程的同学欢迎打脸留言</strong>。</p>
<h2 id="一、为什么要模型量化"><a href="#一、为什么要模型量化" class="headerlink" title="一、为什么要模型量化"></a>一、为什么要模型量化</h2><p>　　为了尽可能保证深度学习模型的准确度(precision)，在训练和推理时候通常使用float32格式的数据。然而在实际商用中，有些模型由于层数和参数都比较多，推理预测需要很大计算量，导致推理(inference)的效率很低。模型量化(model quantization)是通用的深度学习优化的手段之一，它通过将float32格式的数据转变为int8格式，一方面降低内存和存储的开销，同时在一定的条件下(8-bit低精度运算 low-precision)也能提升预测的效率。目前还不太理解8-bit低精度运算，猜测这是模型量化没有实现推理加速的原因。模型量化适用于绝大数模型和使用场景，对于训练后的量化，不需要重新训练模型，可以很快将其量化为定点模型，而且几乎不会有精度损失，因此模型量化追求更小的模型和更快的推理速度。<strong>实验中量化确实时模型下降为原来的1&#x2F;4，但在推理效率并没有提升，甚至略有下降</strong>。</p>
<h2 id="二、什么是量化"><a href="#二、什么是量化" class="headerlink" title="二、什么是量化"></a>二、什么是量化</h2><h3 id="2-1-实数量化"><a href="#2-1-实数量化" class="headerlink" title="2.1 实数量化"></a>2.1 实数量化</h3><p>　　网络上关于模型量化的内容挺多的，量化本质上是一种仿射图(affine map)，它以表达式(1)将实数值表示映射为量化的uint8，当然也可以等效为表示式(2): </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">real_value = A * quantized_value + B             (1) </span><br><span class="line">real_value = C * (quantized_value + D)           (2) </span><br></pre></td></tr></table></figure>

<p>　　除此之外，深度学习模型量化中有一个<strong>约束条件，0必须准确的表示，不能有误差</strong>。因为对于某些神经网络层，实数0精确表示对于优化实现非常有用，例如在具有填充的卷积层或池化层中，长度对输入数组进行零填充(zero-padding)来实现填充是有用的。实数值0对应的量化值称之为零点(zero-point)。实际上，如果0不能完全表示，当我们用0对应的量化值进行填充时，因为这与实际值0不完全对应，会导致结果不准确，引入偏差。因此有：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">　　0=A∗zero_point+B</span><br><span class="line">　　zero_point=−B/A</span><br><span class="line">　　0=C∗(zero_point+D)</span><br><span class="line">　　0=zero_point+D</span><br><span class="line">　　D=−zero_point</span><br></pre></td></tr></table></figure>



<p>　　结合上述条件，可以得出量化的最终表达式为(3)，它能做到0值的准确表示，zero_point是0对应的量化值。表示式(3)中有两个常量，zero_point是量化值，通常是uint8值，scale是一个正实数，通常为float32。<br>$$real\_value &#x3D; scale * (quantized\_value - zero\_point)　　(3)$$</p>
<h3 id="2-2-矩阵乘法量化"><a href="#2-2-矩阵乘法量化" class="headerlink" title="2.2 矩阵乘法量化"></a>2.2 矩阵乘法量化</h3><p>　　根据表达式(3)，我们可以将实数值(通常为float32)用量化值(通常为uint8)表示，下面将介绍怎么把它应用到矩阵乘法当中。假设有两个实数矩阵$lhs\_real\_matrix, rhs\_real\_matrix$，量化之后就会有对应的$lhs\_scale, rhs\_scale, lhs\_zero\_point, rhs\_zero\_point$，矩阵中的实数值可以用其量化值表示为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">lhs_real_value[i] = lhs_scale * (lhs_quantized_value[i] - lhs_zero_point)</span><br><span class="line">rhs_real_value[i] = rhs_scale * (rhs_quantized_value[i] - rhs_zero_point)</span><br></pre></td></tr></table></figure>
<p>　　在矩阵乘法中，每个值($result\_real\_value$)都由对应的ｉ个值相乘累加得到，根据表达式(4)和(5)很容易得到表示式(6),它表示$result\_quantized\_value$可由$lhs\_quantized\_value、rhs\_quantized\_value$计算得出。注意这里面有几个问题需要解决，如何减小式(6)中与zero_point减法的开销(overhead)？如何将(lhs_scale * rhs_scale &#x2F; result_scale)实数运算用整数运算处理？这部分的内容参考gemmlowp的实现。<br>　　<a href="https://github.com/google/gemmlowp/blob/master/doc/quantization.md">https://github.com/google/gemmlowp/blob/master/doc/quantization.md</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">result_real_value</span><br><span class="line">  = Sum_over_i(lhs_real_value[i] * rhs_real_value[i])</span><br><span class="line">  = Sum_over_i(</span><br><span class="line">        lhs_scale * (lhs_quantized_value[i] - lhs_zero_point) *</span><br><span class="line">        rhs_scale * (rhs_quantized_value[i] - rhs_zero_point)</span><br><span class="line">    )</span><br><span class="line">  = lhs_scale * rhs_scale * Sum_over_i(</span><br><span class="line">        (lhs_quantized_value[i] - lhs_zero_point) *</span><br><span class="line">        (rhs_quantized_value[i] - rhs_zero_point)</span><br><span class="line">    )                    (4)</span><br><span class="line"></span><br><span class="line">result_real_value = result_scale * (result_quantized_value - result_zero_point)</span><br><span class="line">result_quantized_value = result_zero_point + result_real_value / result_scale  (5)</span><br><span class="line"></span><br><span class="line">result_quantized_value = result_zero_point +</span><br><span class="line">    (lhs_scale * rhs_scale / result_scale) *</span><br><span class="line">        Sum_over_i(</span><br><span class="line">            (lhs_quantized_value[i] - lhs_zero_point) *</span><br><span class="line">            (rhs_quantized_value[i] - rhs_zero_point)</span><br><span class="line">        )          (6)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="三、tensorflow模型量化方案"><a href="#三、tensorflow模型量化方案" class="headerlink" title="三、tensorflow模型量化方案"></a>三、tensorflow模型量化方案</h2><p>　　**训练后量化(post training Quantization)**。在许多情况下，我们希望在不重新训练模型的前提下，只是通过压缩权重或量化权重和激活输出来缩减模型大小，从而加快预测速度。“训练后量化”就是这种使用简单，而且在有限的数据条件下就可以完成量化的技术。训练后量化操作简单，只需要使用量化工具将训练好的模型执行量化类型，即可实现模型的量化。训练后量化包括“只对权重量化”和“对权重和激活输出都量化”，对于很多网络而言，都可以产生和浮点型很接近的精度。</p>
<p>　　**只对权重量化(weight only quantization)**。一个简单的方法是只将权重的精度从浮点型减低为8bit整型。由于只有权重进行量化，所以无需验证数据集就可以实现。一个简单的命令行工具就可以将权重从浮点型转换为8bit整型。如果只是想为了方便传输和存储而减小模型大小，而不考虑在预测时浮点型计算的性能开销的话，这种量化方法是很有用的。</p>
<p>　　<strong>量化权重和激活输出（Quantizing weights and activations）</strong>。我们可以通过计算所有将要被量化的数据的量化参数，来将一个浮点型模型量化为一个8bit精度的整型模型。由于激活输出需要量化，这时我们就得需要标定数据了，并且需要计算激活输出的动态范围，一般使用100个小批量数据就足够估算出激活输出的动态范围了。</p>
<p>　　**训练时量化（Quantization Aware Training)**。训练时量化方法相比于训练后量化，能够得到更高的精度。训练时量化方案可以利用Tensorflow的量化库，在训练和预测时在模型图中自动插入模拟量化操作来实现。由于训练时量化相对麻烦，加上权重量化没有实现加速的期望，所以没有尝试训练时量化，根据文档显示，其大概包括以下几个步骤：</p>
<ol>
<li>可以在预训练好的模型基础上继续训练或者重新训练，建议在保存好的浮点型模型的基础上精调</li>
<li>修改估计器，添加量化运算，利用tf.contrib.quantize中的量化rewriter向模型中添加假的量化运算</li>
<li>训练模型，输出对于权重和激活输出都带有各自量化信息（尺度、零点）的模型</li>
<li>转换模型，利用tf.contrib.lite.toco convert定义的转换器，将带有量化参数的模型被转化成flatbuffer文件，该文件会将权重转换成int整型，同时包含了激活输出用于量化计算的信息</li>
<li>执行模型，转换后的带有整型权重的模型可以利用TFLite interpreter来执行，也可以在CPU上运行模型</li>
</ol>
<h2 id="四、tensorflow模型权重量化实验"><a href="#四、tensorflow模型权重量化实验" class="headerlink" title="四、tensorflow模型权重量化实验"></a>四、tensorflow模型权重量化实验</h2><p>　　一开始尝试模型量化是因为有个复杂的视频分割模型推理效率很低，期望通过模型量化实现加速，在复杂模型上尝试失败之后，我用label_image的例子再次验证，结果显示也没有加速的效果。这里主要试验了训练后量化，尝试了只对权重量化和权重和激活量化，发现后者比前者性能更差，这里描述权重量化的过程。整个过程是比较简单的，tensorflow有两种量化方式，推荐使用第二种，编译命令行工具进行量化。</p>
<ol>
<li><p>在tensorflow r1.0的版本中有个量化的脚本可以提供量化的功能：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$wget &quot;https://storage.googleapis.com/download.tensorflow.org/models/inception_v3_2016_08_28_frozen.pb.tar.gz&quot;</span><br><span class="line">$tar -xzf tensorflow/examples/label_image/data</span><br><span class="line">$ work_dir=/home/terse/code/programming/tensorflow/quantization</span><br><span class="line">$ python tensorflow/tools/quantization/quantize_graph.py \</span><br><span class="line">--input=$work_dir/inception_v3_2016_08_28_frozen.pb \</span><br><span class="line">--output=$work_dir/inception_quantized0.pb \</span><br><span class="line">--output_node_names=InceptionV3/Predictions/Reshape_1 \</span><br><span class="line">--mode=weights </span><br></pre></td></tr></table></figure>
</li>
<li><p>在较新版本的tf中，quantize_graph.py量化的脚本已经废弃了需要编译tensorflow的源码生成</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">tensorflow-1.14.0编译transform_graph工具</span><br><span class="line">$ bazel build tensorflow/tools/graph_transforms:transform_graph</span><br><span class="line">$ bazel-bin/tensorflow/tools/graph_transforms/transform_graph \</span><br><span class="line">--in_graph=$work_dir/inception_v3_2016_08_28_frozen.pb \</span><br><span class="line">--out_graph=$work_dir/inception_quantized1.pb \</span><br><span class="line">--outputs=InceptionV3/Predictions/Reshape_1 \</span><br><span class="line">--transforms=&#x27;quantize_weights&#x27;</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用summarize_graph分析量化前后的模型区别，权重量化、模型减小、增加了一些和量化和反量化的节点。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">tensorflow-1.14.0编译transform_graph工具</span><br><span class="line">$ bazel build tensorflow/tools/graph_transforms:summarize_graph</span><br><span class="line">$ bazel-bin/tensorflow/tools/graph_transforms/summarize_graph \</span><br><span class="line">--in_graph=$work_dir/inception_quantized1.pb \</span><br><span class="line">--print_structure=true</span><br></pre></td></tr></table></figure></li>
<li><p>使用权重量化的模型做推理验证</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ bazel build tensorflow/examples/label_image：label_image</span><br><span class="line">$ bazel-bin/tensorflow/examples/label_image/label_image \</span><br><span class="line">--image=$work_dir/grace_hopper.jpg \</span><br><span class="line">--labels=$work_dir/imagenet_slim_labels.txt \</span><br><span class="line">--graph=$work_dir/inception_quantized1.pb</span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="五、-为什么模型量化没有使推理加速"><a href="#五、-为什么模型量化没有使推理加速" class="headerlink" title="五、 为什么模型量化没有使推理加速"></a>五、 为什么模型量化没有使推理加速</h2><p>　　关于tensorflow模型量化没有实现模型加速的，我查了一些资料，发现出现类似的问题不在少数。根据tensorflow团队成员的回复，截了几个member的答复，大意是目前量化目前针对移动端的优化，当然也有一些移动端的人说速度下降了。tensorflow未来有可能针对intel x86，gpu量化优化，但不知道什么时候支持。</p>
<p>　　The quantization is aimed at mobile performance, so most of the optimizations are for ARM not x86. We’re hoping to get good quantization on Intel eventually, but we don’t have anyone actively working on it yet.</p>
<p>　　Quantized ops currently only work on the CPU, because most GPUs don’t support eight-bit matrix multiplications natively. I have just seen that the latest TitanX Pascal cards offer eight-bit support though, so I’m hoping we will be able to use that in the future.</p>
<p>参考：</p>
<ol>
<li><a href="https://zhuanlan.zhihu.com/p/33535898">https://zhuanlan.zhihu.com/p/33535898</a></li>
<li><a href="https://arxiv.org/abs/1806.08342">https://arxiv.org/abs/1806.08342</a></li>
<li><a href="https://github.com/google/gemmlowp/blob/master/doc/quantization.md">https://github.com/google/gemmlowp/blob/master/doc/quantization.md</a></li>
<li><a href="https://github.com/tensorflow/tensorflow/issues/2807">https://github.com/tensorflow/tensorflow/issues/2807</a></li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2025/08/26/AI/visp-template-tracker/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpeg">
      <meta itemprop="name" content="wxquare">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="wxquare's Blogs">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | wxquare's Blogs">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/08/26/AI/visp-template-tracker/" class="post-title-link" itemprop="url">了解模板追踪算法和高斯牛顿迭代法</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2025-08-26 12:10:31" itemprop="dateCreated datePublished" datetime="2025-08-26T12:10:31+08:00">2025-08-26</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/AI/" itemprop="url" rel="index"><span itemprop="name">AI</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>　　最近在项目中使用到visp库的模板追踪算法(template tracker)，由于接触算法的时间比较短，这里简单记录对算法的理解和认识。模板追踪算法原理比较简单，当代价函数为SSD时，抽象为数学中的非线性最优化问题，这里采用高斯牛顿法求解。高斯牛顿法应该是通用的一种求最优化问题的算法，高斯牛顿法核心是迭代公式，不断迭代更新出新的参数值。visp模板算法效率本身不高，因此在实现的时候提供了一些可调的优化的参数，例如金字塔、采样率、迭代次数、误差等。在项目中，visp模板追踪算法在参考模板没有遮挡的情况下，效果基本满足要求，但是在有遮挡的情况，会存在比较大的问题，因此我们针对遮挡情况，进行了特别的优化。除此之外，我们优化了一个并行版本的模板追踪算法，提升追踪效率。</p>
<h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>　　在了解visp模板追踪算法之前，可通过官网上的<a href="https://visp.inria.fr/template-tracking/">视频</a>了解追踪算法的能力。它和kcf之类的追踪算法还不太一样，在kcf追踪算法中，我们需要告诉追踪器的追踪目标，通常情况下，我们不要求像素级别的进度的要求。而template tracker参考模板（reference template）计算视频中两帧之间的单应矩阵Homography，通过单应矩阵计算目标区域在当前帧的位置，从而实现追踪的效果。</p>
<h2 id="数学描述"><a href="#数学描述" class="headerlink" title="数学描述"></a>数学描述</h2><p>　　visp库中为模板追踪算法提供了SSD、ZNNC和在VISP 3.0.0时引入的MI(mutual information) 代价函数。这里以SSD代价函数描述模板追踪算法。模板追踪算法在数学描述为一个最优化问题，通过SSD代价函数，缩小误差，寻找最优的标记帧到当前帧的单应矩阵。模板追踪算法的数学描述如下：<br>$$ H_t &#x3D; \arg \min \limits_{H}\sum_{x∈ROI}((I^*(x)-I_t(w(x,H)))^2 $$</p>
<ul>
<li>$I^*$表示标记帧(参考帧），$I_t$表示当前帧</li>
<li>ROI表示参考区域（参考模板，reference template)</li>
<li>$H$ 表示参考帧$I^*$到当前帧的的单应矩阵Homography</li>
<li>$x$ 表示图像中的一个像素点</li>
<li>$w(x,H)$ 表示标记帧上像素点$x$根据单应矩阵$H$到当前帧的映射关系</li>
</ul>
<p>　　这里使用经典的<strong>高斯牛顿法(Gauss–Newton algorithm)迭代法</strong>求解，关于高斯牛顿法这里就不赘述了，最关键的是其迭代公式，感兴趣可以参考下面两篇文章：</p>
<ul>
<li><a href="https://en.wikipedia.org/wiki/Gauss%E2%80%93Newton_algorithm">https://en.wikipedia.org/wiki/Gauss%E2%80%93Newton_algorithm</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/42383070">https://zhuanlan.zhihu.com/p/42383070</a></li>
</ul>
<p>　　其迭代公式如下，$J$表示雅克比矩阵，$J^T$表示$J$的转置，$H_t$表示迭代的初始值，$H_k$表示上一次迭代的结果，$r(H_k)$表示上一次迭代的残差residual。</p>
<p>$$ H_{t+1} &#x3D; H_t + (J^TJ)^{-1}J^Tr(H_k)  $$</p>
<h2 id="关键实现步骤"><a href="#关键实现步骤" class="headerlink" title="关键实现步骤"></a>关键实现步骤</h2><p>　　了解了模板追踪算法的数学描述和高斯牛顿迭代算法，其基本实现应该是不难的，它本质上是一个迭代算法主要分为以下几步：<br>step1. 设定初始的$H$矩阵，第一帧为单一矩阵，之后上一帧的结果.<br>step2. 对于第$k$次迭代计算雅克比$J$, 残差$r(H_k)$，得到$\triangledown H&#x3D;-(J^TJ)^{-1}J^Tr(H_k)$.<br>step3. 如果$\triangledown H$ 足够小或者达到最大循环次数就停止迭代<br>step4. 如果不满足迭代停止条件$H_{k+1}&#x3D;H_{k} +\triangledown H$<br>step5. 迭代结束时，$H_{t+1}&#x3D;H_{k}$</p>
<h3 id="1-计算关键帧中的参考区域中-reference-template）中每个像素点的雅克比"><a href="#1-计算关键帧中的参考区域中-reference-template）中每个像素点的雅克比" class="headerlink" title="1.计算关键帧中的参考区域中(reference template）中每个像素点的雅克比:"></a>1.计算关键帧中的参考区域中(reference template）中每个像素点的雅克比:</h3><ul>
<li>计算关于x方向的梯度</li>
<li>计算关于y方向的梯度</li>
<li>对ROI中的每个点uv计算$J&#x3D;[d_xu,d_xv,d_x,d_yu,d_yv,d_y,-d_xu^2-d_yuv,-d_xuv-d_yv^2]$<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># img0 表示标记帧</span><br><span class="line">   dx = cv2.Sobel(img0, cv2.CV_64F, 1, 0, ksize)</span><br><span class="line">   dy = cv2.Sobel(img0, cv2.CV_64F, 0, 1, ksize)</span><br><span class="line">   img0 = cv2.GaussianBlur(img0, (ksize, ksize), 1)</span><br><span class="line"></span><br><span class="line"># uv表示标记帧参考区域的每个像素点</span><br><span class="line">   juv = [dx[uv] * u, dx[uv] * v, dx[uv], dy[uv] * u, dy[uv] * v, dx[uv],</span><br><span class="line">          -dx[uv] * u * u - dy[uv] * u * v, -dx[uv] * u * v - dy[uv] * v * v]</span><br><span class="line">J = np.array(juv).T</span><br><span class="line"></span><br><span class="line"># MJ=-(JT*J)^-1 *JT</span><br><span class="line">   MJ = -np.dot(np.linalg.pinv(np.dot(J.T, J)), J.T)</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="2-迭代计算当前帧的H的矩阵"><a href="#2-迭代计算当前帧的H的矩阵" class="headerlink" title="2.迭代计算当前帧的H的矩阵"></a>2.迭代计算当前帧的H的矩阵</h3><ul>
<li>迭代条件停止的条件，两次迭代误差小于一个指定值，例如$10^{-8}$</li>
<li>第一次为单位矩阵，之后为上一帧的追踪结果</li>
<li>根据H矩阵将关键帧上上参考区域的点映射到当前帧: uv1 &#x3D; np.dot(H, uv)</li>
<li>计算关键帧上参考区域到当前帧的误差e：E &#x3D; img0[uv] - img1[uv1] </li>
<li>计算$\triangledown H &#x3D; -(J^TJ)^{-1}J_ne_n$</li>
<li>计算新的$H$<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># for deltaH</span><br><span class="line">MJ = -np.dot(np.linalg.pinv(np.dot(J.T, J)*lambdaJTJ), J2.T)</span><br><span class="line">#MJ = -np.dot(np.linalg.pinv(np.dot(J2.T, J2)*lambdaJTJ), J2.T)</span><br><span class="line">deltaH =alpha* np.dot(MJ, E2)</span><br><span class="line"></span><br><span class="line"># for newH</span><br><span class="line">dh = np.insert(deltaH, 8, np.zeros(1), 0).reshape((3, 3))</span><br><span class="line">dhinv = np.linalg.pinv(np.identity(3) + dh)</span><br><span class="line">newH = np.dot(H, dhinv)</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="实际实现考虑点及其存在的问题"><a href="#实际实现考虑点及其存在的问题" class="headerlink" title="实际实现考虑点及其存在的问题"></a>实际实现考虑点及其存在的问题</h2><p>为提高模板追踪算法的效率，visp库在实现模板追踪算法的时候设置了一些可调的参数：</p>
<ul>
<li>对参考模板中的像素点进行采样处理setSampling</li>
<li>迭代时设置学习率，setLambda默认为0.001</li>
<li>设置最大迭代次数，setIterationMax(200)</li>
<li>设置金字塔的层数，tracker.setPyramidal(2, 1)</li>
</ul>
<p>　　实际使用visp模板追踪算法中，发现当参考模板处有物体遮挡时，效果不好，因此需要做进一步的处理。另外，我们在工程实践时，为了提高追踪的效率，升级了一个并行版本的追踪，能提高数倍的追踪效率。</p>
<p>参考链接：</p>
<ul>
<li><a href="https://visp.inria.fr/template-tracking/">https://visp.inria.fr/template-tracking/</a></li>
<li><a href="https://visp-doc.inria.fr/doxygen/visp-daily/tutorial-tracking-tt.html">https://visp-doc.inria.fr/doxygen/visp-daily/tutorial-tracking-tt.html</a></li>
<li><a href="https://en.wikipedia.org/wiki/Gauss%E2%80%93Newton_algorithm">https://en.wikipedia.org/wiki/Gauss%E2%80%93Newton_algorithm</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/42383070">https://zhuanlan.zhihu.com/p/42383070</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2025/08/26/AI/tensorflow-model-channel-pruning/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpeg">
      <meta itemprop="name" content="wxquare">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="wxquare's Blogs">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | wxquare's Blogs">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/08/26/AI/tensorflow-model-channel-pruning/" class="post-title-link" itemprop="url">tensorflow模型通道剪枝(channel pruning)实战</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2025-08-26 12:10:31" itemprop="dateCreated datePublished" datetime="2025-08-26T12:10:31+08:00">2025-08-26</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/AI/" itemprop="url" rel="index"><span itemprop="name">AI</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="一、概述"><a href="#一、概述" class="headerlink" title="一、概述"></a>一、概述</h2><p>　　最近在做模型压缩(model compress)相关工作，之前分别尝试了权重量化(weight quantization)【1】和权重稀疏(weight sparsification)【2】，遗憾的是它们都需要推理引擎和硬件的特定优化才能实现推理加速，而tensorflow在x86架构的CPU下并没有没有针对量化和稀疏矩阵的优化，因此效果一般。吸取前两次的经验，这次尝试了结构化压缩通道剪枝(channel pruning)，它通过删减模型中冗余通道channel，减少的模型前向计算所需的FLOPs。通道剪枝来自论文ICCV2017论文 Channel Pruning for Accelerating Very Deep Neural Networks。 这里会首先简单介绍channel pruning的原理，然后通过PocketFlow压缩工具对ResNet56进行通道剪枝，结果显示channel pruning在精度不怎么损失的基础上，减小接近50%的FLOPs。由于剪枝后模型中增加了许多的conv2d 1x1卷积，实际提升推理效率大概20%。</p>
<h2 id="二、channel-pruning-基本原理"><a href="#二、channel-pruning-基本原理" class="headerlink" title="二、channel pruning 基本原理"></a>二、channel pruning 基本原理</h2><h3 id="1-什么是通道剪枝"><a href="#1-什么是通道剪枝" class="headerlink" title="1. 什么是通道剪枝"></a>1. 什么是通道剪枝</h3><p>　　虽然论文末尾谈到channel pruning可以应用到模型训练中，但是文章的核心内容还是对训练好的模型进行channel pruning，也就是文章中说的inference time。通道剪枝正如其名字channel pruning核心思想是移除一些冗余的channel简化模型。下图是从论文中截取的通道剪枝的示意图，它表示的网络模型中某一层的channel pruning。<strong>B</strong>表示输入feature map，<strong>C</strong>表示输出的feature map；c表示输入B的通道数量，n表示输出C的通道数量；<strong>W</strong>表示卷积核，卷积核的数量是n，每个卷积核的维度是c<em>kh</em>kw，kh和kw表示卷积核的size。通道剪枝的目的就是要把<strong>B</strong>中的某些通道剪掉，但是剪掉后的<strong>B</strong>和<strong>W</strong>的卷积结果能尽可能和<strong>C</strong>接近。当删减<strong>B</strong>中的某些通道时，同时也裁剪了<strong>W</strong>中与这些通道的对应的卷积核，因此通过通过剪枝能减小卷积的运算量。  </p>
<p><img src="/images/channel_pruning.jpg" alt="channel-pruning示意图"></p>
<h3 id="2-通道剪枝数学描述"><a href="#2-通道剪枝数学描述" class="headerlink" title="2. 通道剪枝数学描述"></a>2. 通道剪枝数学描述</h3><p>　　通道剪枝的思想是简单的，难点是怎么选择要裁剪的通道，同时要保证输出feature map误差尽可能得小，这也是文章的主要内容。channel pruning总体分为两个步骤，首先是channel selection，它是采用LASSO regression来做的，通过添加L1范数来约束权重，因为L1范数可以使得权重中大部分值为0，所以能使权重更加稀疏，这样就可以把那些稀疏的channel剪掉；第二步是reconstruction，这一步是基于linear least优化，使输出特征图变化尽可能的小。  </p>
<p>　　接下来通过数学表达式描述了通道剪枝。Ｘ($N*c* k_h*k_w$)表示输入feature map，W($n * c * k_h * k_w$)表示卷积核，Y($N*n$)表示输出feature map。$\beta_i$表示通道系数，如果等于0，表示该通道可以被删除。我们期望将输入feature map的channel从c压缩为c’($0&lt;&#x3D;c’&lt;&#x3D; c$)，同时要使得构造误差(reconstruction error)尽可能的小。通过下面的优化表达式，就可以选择哪些通道被删除。文章中详细介绍了怎么用算法解决下面的数据问题，这里就不赘述了。另外文章还考虑分支情况下的通道剪枝，例如ResNet和GoogleNet，感兴趣的可以仔细研读该论文【3】。</p>
<p><img src="/images/channel_pruning2.jpg" alt="channel-pruning示意图"></p>
<h2 id="三、PocketFlow"><a href="#三、PocketFlow" class="headerlink" title="三、PocketFlow"></a>三、PocketFlow</h2><p>　　PocketFlow是腾讯AI Lab开源的自动化深度学习模型压缩框架，它集成了腾讯自己研发的和来自其他同行的主流的模型压缩与训练算法，还引入了自研的超参数优化组件，实现了自动托管式模型压缩与加速。PocketFlow能够自动选择模型压缩的超参，极大的方便了算法人员的调参。这里主要使用里面的channel pruning算法（learner）进行通道剪枝。【4】</p>
<h3 id="1-实验准备"><a href="#1-实验准备" class="headerlink" title="1.实验准备:"></a>1.实验准备:</h3><p>1.cifar10数据集： <a href="https://www.cs.toronto.edu/~kriz/cifar-10-python.tar.gz">https://www.cs.toronto.edu/~kriz/cifar-10-python.tar.gz</a><br>2.ResNet56预训练模型：<a href="https://share.weiyun.com/5610f11d61dfb733db1f2c77a9f34531">https://share.weiyun.com/5610f11d61dfb733db1f2c77a9f34531</a><br>3.下载Pocketflow: <a href="https://github.com/wxquare/PocketFlow.git">https://github.com/wxquare/PocketFlow.git</a></p>
<h3 id="2-准备配置文件path-conf"><a href="#2-准备配置文件path-conf" class="headerlink" title="2.准备配置文件path.conf"></a>2.准备配置文件path.conf</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># data files</span><br><span class="line">data_dir_local_cifar10 = ./cifar-10-binary/cifar-10-batches-bin #cifar10数据集解压的位置</span><br><span class="line"></span><br><span class="line"># model files </span><br><span class="line"># 这里模型文件用wget下载不下来，要登录下载，解压到PocketFlow根目录的model目录下面</span><br><span class="line">model_http_url = https://share.weiyun.com/5610f11d61dfb733db1f2c77a9f34531</span><br><span class="line">   </span><br></pre></td></tr></table></figure>
<h3 id="3-在本地运行通道剪枝的learner"><a href="#3-在本地运行通道剪枝的learner" class="headerlink" title="3.在本地运行通道剪枝的learner"></a>3.在本地运行通道剪枝的learner</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ ./scripts/run_local.sh nets/resnet_at_cifar10_run.py \</span><br><span class="line">--learner=channel \</span><br><span class="line">--cp_uniform_preserve_ratio=0.5 \</span><br><span class="line">--cp_prune_option=uniform \</span><br><span class="line">--resnet_size=56</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="4-模型转换"><a href="#4-模型转换" class="headerlink" title="4. 模型转换"></a>4. 模型转换</h3><p>步骤3之后会在models产生ckpt文件，需要通过进行模型转化,最终会生成model_original.pb，model_transformed.pb，同时也会生成移动端对应的tflite文件。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ python tools/conversion/export_chn_pruned_tflite_model.py \</span><br><span class="line">--model_dir=models/pruned_model </span><br><span class="line">--input_coll=train_images</span><br><span class="line">--output_coll=logits</span><br></pre></td></tr></table></figure>

<h2 id="四、剪枝前后模型分析"><a href="#四、剪枝前后模型分析" class="headerlink" title="四、剪枝前后模型分析"></a>四、剪枝前后模型分析</h2><p>　　我们可以通过之前介绍的模型基准测试工具benchmark_model分别测试剪枝前后的模型。可以很清楚看到通道剪枝大大减少了模型前向计算的FLOPs的变化，以及各阶段、算子的耗时和内存消耗情况。可以发现模型下降为原来的1&#x2F;2，卷积耗时下降接近50%。除此之外通过netron工具可以直观的看到模型通道剪枝前后结构发生的变化，通道剪枝之后的模型中明显增加了许多conv1*1的卷积。这里主要利用1x1卷积先降维，然后升维度，达到减少计算量的目的。1x1卷积还有多种用途，可以参考【5】。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ bazel-bin/tensorflow/tools/benchmark/benchmark_model \ </span><br><span class="line">--graph=model_original.pb \</span><br><span class="line">--input_layer=&quot;net_input&quot; \</span><br><span class="line">--input_layer_shape=&quot;1,32,32,3&quot; \</span><br><span class="line">--input_layer_type=&quot;float&quot; \</span><br><span class="line">--output_layer=&quot;net_output&quot; \</span><br><span class="line">--show_flops=true \</span><br><span class="line">--show_run_order=false \</span><br><span class="line">--show_time=true \</span><br><span class="line">--num_threads=1</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><img src="/images/channel_pruning3.jpg" alt="channel-pruning 1x1 convolution"></p>
<p>参考：<br>[1]. <a href="https://wxquare.github.io/2019/09/16/other/tensorflow-model-quantization/">tensorflow模型权重量化(weight quantization)实战</a><br>[2]. <a href="https://wxquare.github.io/2019/09/27/other/tensorflow-model-no-structural-pruning">tensorflow模型权重稀疏(weight sparsification)实战</a><br>[3].<a href="https://arxiv.org/abs/1707.06168">Channel Pruning for Accelerating Very Deep Neural Networks</a><br>[4].<a href="https://github.com/wxquare/PocketFlow">PocketFLow</a><br>[5].1x1卷积：<a href="https://www.zhihu.com/question/56024942">https://www.zhihu.com/question/56024942</a> </p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2025/08/26/AI/tensorflow-model-no-structural-pruning/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpeg">
      <meta itemprop="name" content="wxquare">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="wxquare's Blogs">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | wxquare's Blogs">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/08/26/AI/tensorflow-model-no-structural-pruning/" class="post-title-link" itemprop="url">tensorflow模型权重稀疏(weight sparsification)实战</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2025-08-26 12:10:31" itemprop="dateCreated datePublished" datetime="2025-08-26T12:10:31+08:00">2025-08-26</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/AI/" itemprop="url" rel="index"><span itemprop="name">AI</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="一、概述"><a href="#一、概述" class="headerlink" title="一、概述"></a>一、概述</h2><p>　　深度模型通常会有更好的预测精度，但是它面临计算开销过大的问题。模型压缩(model compress)是提高深度模型推理效率的一种解决方案，它期望在不损失精度或者精度损失可控的范围内，加速推理效率，减低内存开销。目前，模型压缩算法主要包括权<strong>重量化(quantization)、剪枝(pruning)、低秩分解等</strong>。上周尝试了<a href="https://wxquare.github.io/2019/09/16/other/tensorflow-model-quantization/">tensorflow中的模型量化</a>，发现量化需要硬件或者推理引擎的对低精度8-bit计算支持，目前tensorflow在x86和gpu环境下还没有很好的支持，因此量化只帮助实现了模型大小下降，没有实现推理的加速。model pruning学习的材料是tensorflow repo中的tensorflow&#x2F;contrib&#x2F;model_pruning，实际了解后发现它属于pruning中no-structural pruning，其加速效果依赖具体的硬件实现，加速效果一般，tensorflow 中对稀疏矩阵运算没有特别好的优化（依赖于底层的 SparseBLAS 实现，目前还没有特别好的）。model pruning中还有一种structural pruning 则不改变计算方式，可以直接使用，加速效果相对较好，之后也会继续尝试。</p>
<h2 id="二、tensorflow-contrib-model-pruning原理"><a href="#二、tensorflow-contrib-model-pruning原理" class="headerlink" title="二、tensorflow&#x2F;contrib&#x2F;model_pruning原理"></a>二、tensorflow&#x2F;contrib&#x2F;model_pruning原理</h2><p>　　<a href="https://arxiv.org/pdf/1710.01878.pdf">Michael Zhu and Suyog Gupta, “To prune, or not to prune: exploring the efficacy of pruning for model compression”, 2017 NIPS </a><br>　　tensorflow中model_pruning理论来自上面这篇文章。文章中指出目前有些深度学习网络模型是过度设计（over-parameterized）。为了使其在资源受限的环境下高效的进行推理预测，要么减少网络的隐藏单元（hidden unit）同时保持模型密集连接结构，要么采用针对大模型进行模型剪枝（model pruning）。文章中的模型行剪枝是一种非结构化的剪枝（no-structural pruning），它在深度神经网络的各种连接矩阵中引入稀疏性（sparsity），从而减少模型中非零值参数的数量。文章比较了大而稀疏（large-sparse）和较小密集（small-dense）这两种模型，认为前者是优于后者的。除此之外，文章提出了一种新的渐进剪枝技术（gradual pruning technique），它能比较方便的融入到模型训练的过程中，使其调整比较小。</p>
<p>　　tensorflow中的模型剪枝是一种训练时剪枝。对于需要被剪枝的网络模型，对于网络中每个需要被剪枝的层（layer)添加一个二进制掩码变量（binary mask variable ），该变量的大小和形状和改层的权重张量（weight tensor）相同。在训练图中加入一些ops，它负责对该层的权重值（weights）的绝对值进行排序，通过mask将最小的权重值屏蔽为0。在前向传播时该掩模的对应位与选中权重进行相与输出feature map，如果该掩模对应位为0则对应的权重相与后则为0，在反向传播时掩模对应位为0的权重参数则不参与更新。除此之外，文章提出了一种新的自动逐步修剪算法（automated gradual pruning），它实际上是定义了一种稀疏度变化的规则，初始时刻，稀疏度提升较快，而越到后面，稀疏度提升速度会逐渐放缓，这个主要是基于冗余度的考虑。因为初始时有大量冗余的权值，而越到后面保留的权值数量越少，不能再“大刀阔斧”地修剪，而需要更谨慎些，避免“误伤无辜”。其表达式如下，官方文档中列出了一些的剪枝超参数，主要的有下面几个。<br>$$s_{t}&#x3D;s_{f}+\left(s_{i}-s_{f}\right)\left(1-\frac{t-t_{0}}{n\Delta t}\right)^{3}  $$</p>
<ul>
<li>initial_sparsity：初始稀疏值$s_i$</li>
<li>target_sparsity：目标稀疏值$s_f$</li>
<li>sparsity_function_begin_step：开始剪枝的step $t_0$</li>
<li>sparsity_function_end_step: 剪枝停止的step</li>
<li>pruning_frequency：剪枝的频率$\Delta t$，文章提出在100到1000之间通常比较好</li>
<li>sparsity_function_exponent: 剪枝函数的指数，表示式中已描述为默认的3，表示由快到慢，为1时表示线性剪枝</li>
</ul>
<h2 id="三、tensorflow中的model-pruning实践"><a href="#三、tensorflow中的model-pruning实践" class="headerlink" title="三、tensorflow中的model_pruning实践"></a>三、tensorflow中的model_pruning实践</h2><p>　　tensorflow中model_pruning的源码位于tensorflow&#x2F;contrib&#x2F;model_pruning。</p>
<ol>
<li><p>准备tensorflow-1.14.0源码</p>
</li>
<li><p>编译model_pruning</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$bazel build -c opt tensorflow/contrib/model_pruning/examples/cifar10:cifar10_train</span><br></pre></td></tr></table></figure></li>
<li><p>通过设置一些参数，开始针对cifar10剪枝</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$bazel-out/k8-py2-opt/bin/tensorflow/contrib/model_pruning/examples/cifar10/cifar10_train \</span><br><span class="line">--train_dir=/home/terse/code/programming/tensorflow/model_pruning/train \</span><br><span class="line">--pruning_hparams=name=cifar10_pruning,\</span><br><span class="line">initial_sparsity=0.3,\</span><br><span class="line">target_sparsity=0.9,\</span><br><span class="line">sparsity_function_begin_step=100,\</span><br><span class="line">sparsity_function_end_step=10000</span><br></pre></td></tr></table></figure>
</li>
<li><p>可通过tensorboard查看剪枝过程。可以清楚的看出随着训练步骤的增加，conv1和conv2的sparsity在不断的增长。 在GRAPHS 页面，双击conv节点，可以看到在原有计算图基础上新增了mask和threshold节点用来做 model pruning</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$tensorboard --logdir=/home/terse/code/programming/tensorflow/model_pruning/train</span><br></pre></td></tr></table></figure>
</li>
<li><p>模型剪枝之后将剪枝的ops从训练图中删除。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$bazel build -c opt tensorflow/contrib/model_pruning:strip_pruning_vars</span><br><span class="line">$bazel-out/k8-py2-opt/bin/tensorflow/contrib/model_pruning/strip_pruning_vars \</span><br><span class="line">--checkpoint_dir=/home/terse/code/programming/tensorflow/model_pruning/train \</span><br><span class="line">--output_node_names=softmax_linear/softmax_linear_2 \</span><br><span class="line">--output_dir=/home/terse/code/programming/tensorflow/model_pruning \</span><br><span class="line">--filename=pruning_stripped.pb</span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="四、model-pruning源码简单分析"><a href="#四、model-pruning源码简单分析" class="headerlink" title="四、model_pruning源码简单分析"></a>四、model_pruning源码简单分析</h2><p>　　使用tensorflow的model_pruning进行模型剪枝，主要包括两方面的工作，一是apply_mask，二是在训练图中增加剪枝的节点（pruning ops）。这里分别截取了其中的两段代码。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># cifar10_pruning.py  apply_mask to the graph</span><br><span class="line">with tf.variable_scope(&#x27;conv1&#x27;) as scope:</span><br><span class="line">  kernel = _variable_with_weight_decay(</span><br><span class="line">      &#x27;weights&#x27;, shape=[5, 5, 3, 64], stddev=5e-2, wd=0.0)</span><br><span class="line"></span><br><span class="line">  conv = tf.nn.conv2d(</span><br><span class="line">      images, pruning.apply_mask(kernel, scope), [1, 1, 1, 1], padding=&#x27;SAME&#x27;)</span><br><span class="line">  </span><br><span class="line">  biases = _variable_on_cpu(&#x27;biases&#x27;, [64], tf.constant_initializer(0.0))</span><br><span class="line">  pre_activation = tf.nn.bias_add(conv, biases)</span><br><span class="line">  conv1 = tf.nn.relu(pre_activation, name=scope.name)</span><br><span class="line">  _activation_summary(conv1)</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"> #Adding pruning ops to the training graph</span><br><span class="line">with tf.graph.as_default():</span><br><span class="line"></span><br><span class="line">  # Create global step variable</span><br><span class="line">  global_step = tf.train.get_or_create_global_step()</span><br><span class="line"></span><br><span class="line">  # Parse pruning hyperparameters</span><br><span class="line">  pruning_hparams = pruning.get_pruning_hparams().parse(FLAGS.pruning_hparams)</span><br><span class="line"></span><br><span class="line">  # Create a pruning object using the pruning specification</span><br><span class="line">  p = pruning.Pruning(pruning_hparams, global_step=global_step)</span><br><span class="line"></span><br><span class="line">  # Add conditional mask update op. Executing this op will update all</span><br><span class="line">  # the masks in the graph if the current global step is in the range</span><br><span class="line">  # [begin_pruning_step, end_pruning_step] as specified by the pruning spec</span><br><span class="line">  mask_update_op = p.conditional_mask_update_op()</span><br><span class="line"></span><br><span class="line">  # Add summaries to keep track of the sparsity in different layers during training</span><br><span class="line">  p.add_pruning_summaries()</span><br><span class="line"></span><br><span class="line">  with tf.train.MonitoredTrainingSession(...) as mon_sess:</span><br><span class="line">    # Run the usual training op in the tf session</span><br><span class="line">    mon_sess.run(train_op)</span><br><span class="line"></span><br><span class="line">    # Update the masks by running the mask_update_op</span><br><span class="line">    mon_sess.run(mask_update_op)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="五、总结和未解决的问题"><a href="#五、总结和未解决的问题" class="headerlink" title="五、总结和未解决的问题"></a>五、总结和未解决的问题</h2><ol>
<li>tensorflow中的模型剪枝属于no-structral，本质上是使权重稀疏化(weight sparsification),实践中发现它没有使推理加速，据其加速效果依赖具体的硬件实现，加速效果一般，tensorflow 中对稀疏矩阵运算没有特别好的优化（依赖于底层的 SparseBLAS 实现，目前还没有特别好的）</li>
<li>实践中发现不管稀疏度为多少，其剪枝后的模型大小都是相同的，是不是tensorflow对稀疏的模型也是按照非稀疏格式存储的？</li>
<li>issue:<a href="https://github.com/tensorflow/tensorflow/issues/32805">model_pruning: Why 50% and 90% zeros of the stripped models are the same size? #32805</a></li>
<li>issue: [CNN.Model pruning: no gain in speeding up of inference #22732](CNN.Model pruning: no gain in speeding up of inference #22732)</li>
</ol>
<p>参考：</p>
<ol>
<li><a href="https://github.com/tensorflow/tensorflow/tree/r2.0/tensorflow/contrib/model_pruning">https://github.com/tensorflow/tensorflow/tree/r2.0/tensorflow/contrib/model_pruning</a></li>
<li><a href="https://arxiv.org/pdf/1710.01878.pdf">Michael Zhu and Suyog Gupta, “To prune, or not to prune: exploring the efficacy of pruning for model compression”, 2017 NIPS </a></li>
<li><a href="https://zhuanlan.zhihu.com/p/48069799">https://zhuanlan.zhihu.com/p/48069799</a></li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2025/08/26/AI/tensorflow-benchmark-model/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpeg">
      <meta itemprop="name" content="wxquare">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="wxquare's Blogs">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | wxquare's Blogs">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/08/26/AI/tensorflow-benchmark-model/" class="post-title-link" itemprop="url">了解tensorflow中的模型基准测试工具</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2025-08-26 12:10:31" itemprop="dateCreated datePublished" datetime="2025-08-26T12:10:31+08:00">2025-08-26</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/AI/" itemprop="url" rel="index"><span itemprop="name">AI</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>　　深度学习模型落地需要考虑决定推理（inference）过程所需的计算资源（成本）和效率（系统的吞吐量和延时），有时甚至需要进行适当的模型裁剪和压缩工作。理论上说，模型结构一旦确定是可以计算它的复杂度和计算量，但这有些繁琐。实际中可以借助一些工具帮助预估模型实际的性能，比较模型优化前后的差别，主要使用到的是benchmark_model和summarize_graph。</p>
<h2 id="一、benchmark-model模型推理速度分析"><a href="#一、benchmark-model模型推理速度分析" class="headerlink" title="一、benchmark_model模型推理速度分析"></a>一、benchmark_model模型推理速度分析</h2><p>　　在深度学习模型工程落地时，我们追求在成本可控的前提下提高良好的用户体验，因此模型的推理效率和计算代价是重要的衡量指标。通常用FLOPs（floating point operations）描述模型的计算力消耗，它表示浮点运算计算量，用来衡量算法&#x2F;模型的复杂度。我们是可以从原理上计算出模型需要的FLOPs，参考：<a href="https://www.zhihu.com/question/65305385%E3%80%82">https://www.zhihu.com/question/65305385。</a> 除了从理论计算之外，还可以使用tensorflow中的 benchmark_model 工具来进行粗略估计，它可以帮助估算出模型所需的浮点操作数(FLOPS)，然后你就可以使用这些信息来确定你的模型在你的目标设备上运行的可行性。除此之外，比较容易混淆的概念是FLOPS（floating point operations per second），意指每秒浮点运算次数，理解为计算速度，它是衡量硬件性能的指标对于来说TESLA P40可以每秒处理12T个FLOP，普通单核CPU每秒大概处理100亿次的FLOP。当有了计算操作消耗的估计之后，它就对你计划的目标设备上有所帮助，如果模型的计算操作太多，那么就需要优化模型减小FLOP数量。</p>
<p>　　例如下面的例子中，我们通过benchmark_model分析resetNet20-cifar10，大概有82.15M的FLOPs，该机器每秒执行21.89B，因此该模型大概需要4ms的计算时间。在使用benchmark_model之前，需要使用tensorflow源码进行编译。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">编译benchmark_model</span><br><span class="line">$ bazel build -c opt tensorflow/tools/benchmark:benchmark_model</span><br><span class="line">$ bazel-bin/tensorflow/tools/benchmark/benchmark_model \</span><br><span class="line">--graph=model_original.pb \</span><br><span class="line">--input_layer=&quot;net_input&quot; \</span><br><span class="line">--input_layer_shape=&quot;1,32,32,3&quot; \</span><br><span class="line">--input_layer_type=&quot;float&quot; \</span><br><span class="line">--output_layer=&quot;net_output&quot; \</span><br><span class="line">--show_flops=true \</span><br><span class="line">--show_run_order=false \</span><br><span class="line">--show_time=false \</span><br><span class="line">--num_threads=1</span><br></pre></td></tr></table></figure>


<h4 id="预估FLOPs"><a href="#预估FLOPs" class="headerlink" title="预估FLOPs"></a>预估FLOPs</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">2019-10-11 21:30:31.288678: I tensorflow/tools/benchmark/benchmark_model.cc:636] FLOPs estimate: 82.15M</span><br><span class="line">2019-10-11 21:30:31.288744: I tensorflow/tools/benchmark/benchmark_model.cc:638] FLOPs/second: 21.89B</span><br></pre></td></tr></table></figure>


<h4 id="查看不同类型节点消耗的时间："><a href="#查看不同类型节点消耗的时间：" class="headerlink" title="查看不同类型节点消耗的时间："></a>查看不同类型节点消耗的时间：</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">========================= Summary by node type ==========================================</span><br><span class="line"> [Node type]	  [count]	  [avg ms]	    [avg %]	    [cdf %]	  [mem KB]	[times called]</span><br><span class="line">          &lt;&gt;	       65	     4.110	    47.269%	    47.269%	     0.000	       65</span><br><span class="line">FusedBatchNorm	       19	     2.028	    23.324%	    70.592%	   240.384	       19</span><br><span class="line">      Conv2D	       22	     2.003	    23.036%	    93.629%	   868.352	       22</span><br><span class="line">         Pad	        2	     0.239	     2.749%	    96.377%	   115.456	        2</span><br><span class="line">        Relu	       19	     0.082	     0.943%	    97.320%	     0.000	       19</span><br><span class="line">       Const	       65	     0.071	     0.817%	    98.137%	     0.000	       65</span><br><span class="line">        NoOp	        1	     0.066	     0.759%	    98.896%	     0.000	        1</span><br><span class="line">         Add	        9	     0.059	     0.679%	    99.574%	     0.000	        9</span><br><span class="line">        Mean	        1	     0.010	     0.115%	    99.689%	     0.256	        1</span><br><span class="line">     Softmax	        1	     0.008	     0.092%	    99.781%	     0.000	        1</span><br><span class="line">_FusedMatMul	        1	     0.007	     0.081%	    99.862%	     0.040	        1</span><br><span class="line">     _Retval	        1	     0.005	     0.058%	    99.919%	     0.000	        1</span><br><span class="line">     Squeeze	        1	     0.005	     0.058%	    99.977%	     0.000	        1</span><br><span class="line">        _Arg	        1	     0.002	     0.023%	   100.000%	     0.000	        1</span><br><span class="line"></span><br><span class="line">Timings (microseconds): count=1000 first=7287 curr=7567 min=7198 max=18864 avg=8794.03 std=1249</span><br><span class="line">Memory (bytes): count=1000 curr=1224488(all same)</span><br></pre></td></tr></table></figure>

<ul>
<li>node type：进行操作的节点类型。</li>
<li>start：运算符的启动时间，展示了其在操作顺序中的位置。</li>
<li>first: 以毫秒为单位。默认情况下 TensorFlow 会执行 20 次运行结果来获得统计数据，这个字段则表示第一次运行基准测试所需的操作时间。</li>
<li>avg ms：以毫秒为单位。表示整个运行的平均操作时间。</li>
<li>%：一次运行占总运行时间的百分比。这对理解密集计算区域非常有用。</li>
<li>cdf%：整个过程中表格中当前运算符及上方全部运算符的累积计算时间。这对理解神经网络不同层之间的性能分布非常重要，有助于查看是否只有少数节点占用大部分时间。</li>
<li>mem KB：当前层消耗的内存大小。</li>
<li>Name：节点名称。</li>
</ul>
<h2 id="二、summarize-graph-模型大小分析"><a href="#二、summarize-graph-模型大小分析" class="headerlink" title="二、summarize_graph 模型大小分析"></a>二、summarize_graph 模型大小分析</h2><p>　　服务端深度模型落地时主要关注模型的预测效率，移动端模型落地需要考虑模型的大小。通过summarize_graph工具可以帮助我们简要分析模型的参数量和包含哪些op。设置–print_structure&#x3D;true可以观察到模型的结构，这也可以通过tensorboard来可视化实现。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">tensorflow-1.14.0编译summarize_graph工具</span><br><span class="line">$ bazel build -c opt tensorflow/tools/graph_transforms:summarize_graph</span><br><span class="line">$ bazel-bin/tensorflow/tools/graph_transforms/summarize_graph \</span><br><span class="line">--in_graph=reset20_cifar10_original.pb \</span><br><span class="line">--print_structure=true</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Found 1 possible inputs: (name=net_input, type=float(1), shape=[?,32,32,3]) </span><br><span class="line">No variables spotted.</span><br><span class="line">Found 1 possible outputs: (name=net_output, op=Softmax) </span><br><span class="line">Found 272572 (272.57k) const parameters, 0 (0) variable parameters, and 0 control_edges</span><br><span class="line">Op types used: 194 Const, 77 Identity, 22 Conv2D, 19 Relu, 19 FusedBatchNorm, 11 Add, 6 Slice, 5 Pad, 5 Reshape, 4 Sub, 4 MatchingFiles, 3 Switch, 2 Squeeze, 2 ShuffleDataset, 2 ShuffleAndRepeatDataset, 2 StridedSlice, 2 Shape, 2 TensorSliceDataset, 2 RealDiv, 2 PrefetchDataset, 2 ParallelMapDataset, 2 ParallelInterleaveDataset, 2 Transpose, 2 OneHot, 2 BatchDatasetV2, 2 Cast, 2 Maximum, 2 DecodeRaw, 1 GreaterEqual, 1 All, 1 Assert, 1 BiasAdd, 1 Softmax, 1 ExpandDims, 1 FixedLengthRecordDataset, 1 FloorMod, 1 Mul, 1 ReverseV2, 1 Less, 1 MatMul, 1 RandomUniformInt, 1 RandomUniform, 1 Mean, 1 Placeholder, 1 Merge</span><br></pre></td></tr></table></figure>


<p><a href="https://tensorflow.juejin.im/mobile/optimizing.html">https://tensorflow.juejin.im/mobile/optimizing.html</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2025/08/26/AI/tensorflow-how-to-freeze-model/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpeg">
      <meta itemprop="name" content="wxquare">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="wxquare's Blogs">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | wxquare's Blogs">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/08/26/AI/tensorflow-how-to-freeze-model/" class="post-title-link" itemprop="url">了解tensorflow不同格式的模型及其转换方法</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2025-08-26 12:10:31" itemprop="dateCreated datePublished" datetime="2025-08-26T12:10:31+08:00">2025-08-26</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/AI/" itemprop="url" rel="index"><span itemprop="name">AI</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>　　tensorflow针对训练、预测、服务端和移动端等环境支持多种模型格式，这对于初学者来说可能比较疑惑。目前，tf中主要包括.ckpt格式、.pb格式SavedModel和tflite四种格式的模型文件。SavedModel用于tensorflow serving环境中，tflite格式模型文件用在移动端，后续遇到相关格式模型文件会继续补充。这里主要介绍常见的ckpt和pb格式的模型文件，以及它们之间的转换方法。</p>
<h2 id="CheckPoint-ckpt"><a href="#CheckPoint-ckpt" class="headerlink" title="CheckPoint(*.ckpt)"></a>CheckPoint(*.ckpt)</h2><p>　　在使用tensorflow训练模型时，我们常常使用tf.train.Saver类保存和还原，使用该类保存和模型格式称为checkpoint格式。Saver类的save函数将图结构和变量值存在指定路径的三个文件中，restore方法从指定路径下恢复模型。当数据量和迭代次数很多时，训练常常需要数天才能完成，为了防止中间出现异常情况，checkpoint方式能帮助保存训练中间结果，避免重头开始训练的尴尬局面。有些地方说ckpt文件不包括图结构不能重建图是不对的，使用saver类可以保存模型中的全部信息。尽管ckpt模型格式对于训练时非常方便，但是对于预测却不是很好，主要有下面这几个缺点：</p>
<ol>
<li>ckpt格式的模型文件依赖于tensorflow，只能在该框架下使用;</li>
<li>ckpt模型文件保存了模型的全部信息，但是在使用模型预测时，有些信息可能是不需要的。模型预测时，只需要模型的结构和参数变量的取值，因为预测和训练不同，预测不需要变量初始化、反向传播或者模型保存等辅助节点;</li>
<li>ckpt将模型的变量值和计算图分开存储，变量值存在index和data文件中，计算图信息存储在meta文件中,这给模型存储会有一定的不方便。</li>
</ol>
<h2 id="frozen-model-pb"><a href="#frozen-model-pb" class="headerlink" title="frozen model(*.pb)"></a>frozen model(*.pb)</h2><p>　　Google推荐将模型保存为pb格式。PB文件本身就具有语言独立性，而且能被其它语言和深度学习框架读取和继续训练，所以PB文件是最佳的格式选择。另外相比ckpt格式的文件，pb格式可以去掉与预测无关的节点，单个模型文件也方便部署，因此实践中我们常常使用pb格式的模型文件。那么如何将ckpt格式的模型文件转化为pb的格式文件呢？主要包含下面几个步骤，结合这几个步骤写了个通用的脚本，使用该脚本只需指定ckpt模型路径、pb模型路径和模型的输出节点，多个输出节点时使用逗号隔开。</p>
<ul>
<li>通过传入的ckpt模型的路径得到模型的图和变量数据</li>
<li>通过 import_meta_graph 导入模型中的图</li>
<li>通过 saver.restore 从模型中恢复图中各个变量的数据</li>
<li>通过 graph_util.convert_variables_to_constants 将模型持久化</li>
<li>在frozen model的时候可以删除训练节点</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"># -*-coding: utf-8 -*-</span><br><span class="line">import tensorflow as tf</span><br><span class="line">from tensorflow.python.framework import graph_util</span><br><span class="line">import argparse</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def freeze_graph(input_checkpoint,output_pb_path,output_nodes_name):</span><br><span class="line">    &#x27;&#x27;&#x27;</span><br><span class="line">    :param input_checkpoint:</span><br><span class="line">    :param output_pb_path: PB模型保存路径</span><br><span class="line">    &#x27;&#x27;&#x27;</span><br><span class="line">    saver = tf.train.import_meta_graph(input_checkpoint + &#x27;.meta&#x27;, clear_devices=True)</span><br><span class="line">    with tf.Session() as sess:</span><br><span class="line">        saver.restore(sess, input_checkpoint) #恢复图并得到数据</span><br><span class="line">        graph = tf.get_default_graph()</span><br><span class="line">        # 模型持久化，将变量值固定</span><br><span class="line">        output_graph_def = graph_util.convert_variables_to_constants(  </span><br><span class="line">            sess=sess,</span><br><span class="line">            input_graph_def=sess.graph_def,</span><br><span class="line">            output_node_names=output_nodes_name.split(&quot;,&quot;))# 如果有多个输出节点，以逗号隔开</span><br><span class="line"></span><br><span class="line">        print(&quot;++++++++++++++%d ops in the freeze graph.&quot; % len(output_graph_def.node)) #得到当前图有几个操作节点</span><br><span class="line">        output_graph_def = graph_util.remove_training_nodes(output_graph_def)</span><br><span class="line">        print(&quot;++++++++++++++%d ops after remove training nodes.&quot; % len(output_graph_def.node)) #得到当前图有几个操作节点</span><br><span class="line"></span><br><span class="line">        # serialize and write pb model to Specified path</span><br><span class="line">        with tf.gfile.GFile(output_pb_path, &quot;wb&quot;) as f: </span><br><span class="line">            f.write(output_graph_def.SerializeToString()) </span><br><span class="line"></span><br><span class="line">if __name__ == &#x27;__main__&#x27;:</span><br><span class="line">    parser = argparse.ArgumentParser()</span><br><span class="line">    parser.add_argument(&#x27;--ckpt_path&#x27;, type=str, required=True,help=&#x27;checkpoint file path&#x27;)</span><br><span class="line">    parser.add_argument(&#x27;--pb_path&#x27;, type=str, required=True,help=&#x27;pb model file path&#x27;)</span><br><span class="line">    parser.add_argument(&#x27;--output_nodes_name&#x27;, type=str, required=True,help=&#x27;name of output nodes separated by comma&#x27;)</span><br><span class="line"></span><br><span class="line">    args = parser.parse_args()</span><br><span class="line">    freeze_graph(args.ckpt_path,args.pb_path,args.output_nodes_name)</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>参考：<br><a href="https://blog.metaflow.fr/tensorflow-how-to-freeze-a-model-and-serve-it-with-a-python-api-d4f3596b3adc">https://blog.metaflow.fr/tensorflow-how-to-freeze-a-model-and-serve-it-with-a-python-api-d4f3596b3adc</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2025/08/26/AI/TVM-hello/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpeg">
      <meta itemprop="name" content="wxquare">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="wxquare's Blogs">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | wxquare's Blogs">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/08/26/AI/TVM-hello/" class="post-title-link" itemprop="url">初识TVM，相比于tensorflow的2倍性能提升</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2025-08-26 12:10:31" itemprop="dateCreated datePublished" datetime="2025-08-26T12:10:31+08:00">2025-08-26</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/AI/" itemprop="url" rel="index"><span itemprop="name">AI</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>　　<br>　　最近在做深度学习模型加速的工作，先后尝试了模型权重量化(quantization)、模型权重稀疏（sparsification）和模型通道剪枝(channel pruning)等压缩方法，但效果都不明显。权重量化和稀疏属于非结构化的压缩，需要推理引擎和硬件的优化才能实现推理加速，通道剪枝能直接减少FLOPs，确实能卷积网络的效率，在ResNet56网络中能大概提升卷积50%的速度。在工程实践中，除了通过模型压缩提升推理性能，还可以通过优化推理引擎提高推理效率。目前存在多种开源的推理引擎，我首先尝试了TVM。</p>
<h3 id="为什么选择TVM"><a href="#为什么选择TVM" class="headerlink" title="为什么选择TVM"></a>为什么选择TVM</h3><p>　　为提升深度学习模型的推理效率，设备平台制造商针对自己的平台推出优化的推理引擎，例如NAVIDA的tensorRT，Intel的OpenVINO，Tencent针对移动端应用推出NCNN等。目前，深度学习模型应用广泛，在服务端和移动端都有应用，甚至于特殊的嵌入式场景想，它们都有加速模型推理的需求。个人感觉针对不同平台选择不同的推理引擎，学习成本太高。我这里选择尝试TVM，主要有以下几个原因：</p>
<ul>
<li>尝试了过一些模型压缩方法，效率提升有限</li>
<li>有些是模型压缩方法需要推理引擎和硬件的支持的，例如量化</li>
<li>tensorflow推理效率有限，需要更好的推理引擎</li>
<li>针对平台选择不同推理引擎，学习成本太高</li>
<li>需要能支持跨平台的推理引擎，未来可能在定制的嵌入式芯片上运行深度学习模型</li>
<li>除了TVM之外，还存在XLA之类方案，选择TVM也是因为tianqi等大佬主导的项目，相信大佬！</li>
</ul>
<h3 id="初次体验TVM，相比于tensorflow2倍的性能提升"><a href="#初次体验TVM，相比于tensorflow2倍的性能提升" class="headerlink" title="初次体验TVM，相比于tensorflow2倍的性能提升"></a>初次体验TVM，相比于tensorflow2倍的性能提升</h3><p>　　看了几篇TVM介绍文章后，了解到它是从深度学习编译器的角度来做推理引擎，目前技术领域还比较新，具体技术细节以后有机会会深入学习，这里主要想体验一下使用TVM做深度模型推理，重点是推理效率的提升，因为是骡子还是马得拉出来遛遛。参考官方文档进行编译安装，整个过程还是比较简单的，结果显示相比于tensorflow大概100%的性能提升。实验环境是ubuntu 19.04，x86_64架构。</p>
<ol>
<li>安装llvm,也可源码编译<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt-get install llvm</span><br></pre></td></tr></table></figure></li>
<li>编译TVM<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ git clone --recursive https://github.com/dmlc/tvm.git</span><br><span class="line">$ cd tvm $$ mkdir build</span><br><span class="line">$ cp cmake/config.cmake build</span><br><span class="line"># 编辑config.cmake 然后将USE_LLVM OFF 改为 set(USE_LLVM /usr/bin/llvm-config)</span><br><span class="line">$ cd build</span><br><span class="line">$ cmake ..</span><br><span class="line">$ cmake -j4</span><br></pre></td></tr></table></figure></li>
<li>编辑.bashrc配置Python环境<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">export TVM_HOME=/home/xxxx/code/tvm</span><br><span class="line">export PYTHONPATH=$TVM_HOME/python:$TVM_HOME/topi/python:$TVM_HOME/nnvm/python</span><br></pre></td></tr></table></figure></li>
<li>官方<a href="https://docs.tvm.ai/tutorials/frontend/from_tensorflow.html#sphx-glr-tutorials-frontend-from-tensorflow-py">Compile Tensorflow Models</a><br>直接运行出现了两个问题，下载文件时和SSL相关，另外一个是缺少antlr<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># install antlr</span><br><span class="line">$ pip install antlr4-python3-runtime</span><br><span class="line"># debug ssl</span><br><span class="line">import ssl</span><br><span class="line">ssl._create_default_https_context = ssl._create_unverified_context</span><br><span class="line"># run demo</span><br><span class="line">$ python from_tensorflow.py</span><br></pre></td></tr></table></figure></li>
<li>在代码中加入时间测试，实验测试结果。TVM与测试时间为0.277s，tensorflow为0.586s。<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">============ TVM ============ 0.2770531177520752</span><br><span class="line">African elephant, Loxodonta africana (score = 0.58335)</span><br><span class="line">tusker (score = 0.33901)</span><br><span class="line">Indian elephant, Elephas maximus (score = 0.02391)</span><br><span class="line">banana (score = 0.00025)</span><br><span class="line">vault (score = 0.00021)</span><br><span class="line">============= Tensorflow ===== 0.58619508743286133</span><br><span class="line">===== TENSORFLOW RESULTS =======</span><br><span class="line">African elephant, Loxodonta africana (score = 0.58394)</span><br><span class="line">tusker (score = 0.33909)</span><br><span class="line">Indian elephant, Elephas maximus (score = 0.03186)</span><br><span class="line">banana (score = 0.00022)</span><br><span class="line">desk (score = 0.00019)</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="未填的坑"><a href="#未填的坑" class="headerlink" title="未填的坑"></a>未填的坑</h2><p>　　过程遇到一个坑，查了TVM社区，没有很好的解答，看起来好像会和性能有关，希望路过的大佬能帮忙解决。<a href="https://discuss.tvm.ai/t/cannot-find-config-for-target-llvm-when-using-autotvm-in-tensorflow-example-for-cpu/1544">https://discuss.tvm.ai/t/cannot-find-config-for-target-llvm-when-using-autotvm-in-tensorflow-example-for-cpu/1544</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">WARNING:autotvm:Cannot find config for target=llvm, workload=(&#x27;conv2d&#x27;, (1, 8, 8, 2048, &#x27;float32&#x27;), (1, 1, 2048, 384, &#x27;float32&#x27;), (1, 1), (0, 0), (1, 1), &#x27;NHWC&#x27;, &#x27;float32&#x27;). A fallback configuration is used, which may bring great performance regression.</span><br><span class="line">WARNING:autotvm:Cannot find config for target=llvm, workload=(&#x27;conv2d&#x27;, (1, 8, 8, 2048, &#x27;float32&#x27;), (1, 1, 2048, 448, &#x27;float32&#x27;), (1, 1), (0, 0), (1, 1), &#x27;NHWC&#x27;, &#x27;float32&#x27;). A fallback configuration is used, which may bring great performance regression.</span><br><span class="line">WARNING:autotvm:Cannot find config for target=llvm, workload=(&#x27;conv2d&#x27;, (1, 8, 8, 2048, &#x27;float32&#x27;), (1, 1, 2048, 192, &#x27;float32&#x27;), (1, 1), (0, 0), (1, 1), &#x27;NHWC&#x27;, &#x27;float32&#x27;). A fallback configuration is used, which may bring great performance regression.</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>参考：</p>
<ol>
<li>tvm install: <a href="https://docs.tvm.ai/install/from_source.html">https://docs.tvm.ai/install/from_source.html</a></li>
<li>tvm tutorial: <a href="https://docs.tvm.ai/tutorials/frontend/from_tensorflow.html#sphx-glr-tutorials-frontend-from-tensorflow-py">Compile Tensorflow Models</a></li>
<li>未填的坑：<a href="https://discuss.tvm.ai/t/cannot-find-config-for-target-llvm-when-using-autotvm-in-tensorflow-example-for-cpu/1544">https://discuss.tvm.ai/t/cannot-find-config-for-target-llvm-when-using-autotvm-in-tensorflow-example-for-cpu/1544</a></li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2025/08/26/AI/TVM-quantization/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpeg">
      <meta itemprop="name" content="wxquare">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="wxquare's Blogs">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | wxquare's Blogs">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/08/26/AI/TVM-quantization/" class="post-title-link" itemprop="url">TVM学习笔记--模型量化(int8)及其测试数据</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2025-08-26 12:10:31" itemprop="dateCreated datePublished" datetime="2025-08-26T12:10:31+08:00">2025-08-26</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/AI/" itemprop="url" rel="index"><span itemprop="name">AI</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>　　坚持了接近一年的视频算法相关的项目，老板最终还是喊停了。并没有感到特别意外，只是在对一个东西突然有些兴趣或者说入门的时候，戛然而止，多少有些不甘心和遗憾，但是以后会在业余继续学习的，也希望自己在2020年能把工作逐渐聚焦到这块吧。</p>
<p>　　接触TVM到有两个原因。一是需要支持多种优化手段的推理引擎，例如量化、图优化、稀疏优化、模型压缩剪枝等。尝试过在tensorflow的quantization和非结构性剪枝(no-structural pruning)，加速效果非常一般，因为这些优化手段需要推理引擎的支持，但是当时我们都是纯后台出身，也没人掌握这个内容。再之后尝试channel pruning，终于取得了一些进展，但是30%的提升leader并不满意。二是需要支持多种平台的推理引擎，例如NV GPU&#x2F;x86&#x2F;ARM GPU等。由于组内业务迟迟没有好的落地场景，尝试了多种手段，需要的把深度模型部署在不同的平台上。记得有次，花了两周的时间把DaSiamRPN模型移植到终端上。从零开始pytorch、onnx、tflite、android，期间踩了许多的坑，结果在移动端运行需要4秒时间来处理一帧图像。。。期间同事也曾通过tensorRT部署模型，效率反而下降。一次偶然的机会了解到TVM，当时感觉它可能是比较适合我们团队的需求的。</p>
<p>　　由于我之前学习信号处理的，比较容易理解量化。模型量化quantization也在深度学习在部署落地时提高效率的常用的方法。之前有写过关于<a href="https://zhuanlan.zhihu.com/p/86440423">tensorflow模型量化</a>的方法，写得不好，对于想学习模型量化知识的可以参考下面链接进行学习：</p>
<p><strong>模型量化相关：</strong><br>【1】<a href="https://jackwish.net/2019/neural-network-quantization-introduction-chn.html">神经网络量化简介</a><br>【2】<a href="http://on-demand.gputechconf.com/gtc/2017/presentation/s7310-8-bit-inference-with-tensorrt.pdf">Tensort量化:8-bit-inference-with-tensort</a><br>【3】<a href="http://www.ruanyifeng.com/blog/2010/06/ieee_floating-point_representation.html">阮一峰：浮点数的二进制表示</a><br>【4】<a href="https://arxiv.org/pdf/1806.08342.pdf">Quantizing deep convolutional networks for efficient inference</a></p>
<p><strong>TVM量化相关RFC</strong><br>【INT8 quantization proposal】：<a href="https://discuss.tvm.ai/t/int8-quantization-proposal/516%EF%BC%882018.02.02%EF%BC%89">https://discuss.tvm.ai/t/int8-quantization-proposal/516（2018.02.02）</a><br>【TVM quantizationRFC】 <a href="https://github.com/apache/incubator-tvm/issues/2259(2018.12.09)">https://github.com/apache/incubator-tvm/issues/2259(2018.12.09)</a></p>
<p>　　目前，官网上还没有关于模型量化的教程和文档，对于刚接触新手来说可能有些麻烦，这里提供提供一个参考代码，方便新手学习。除此之外，也测试了TVM的int8量化性能，结果显示TVM的量化加速效果不是很好，甚至略有下降，需要配合autotvm一起使用。<a href="https://github.com/wxquare/programming/tree/master/blog/TVM_quantization">测试代码地址</a>。测试结果如下，希望对大家了解TVM有帮助。</p>
<table>
<thead>
<tr>
<th>模型</th>
<th>原始框架</th>
<th>原始框架运行时间</th>
<th>TVM FP32</th>
<th>TVM int8</th>
<th>TVM int8+AutoTVM</th>
</tr>
</thead>
<tbody><tr>
<td>resnet18v1</td>
<td>mxnet 1.5.1</td>
<td>27.8ms</td>
<td>46.9ms</td>
<td>51.10ms</td>
<td>25.83ms</td>
</tr>
<tr>
<td>Inceptionv1</td>
<td>tensorflow 1.13</td>
<td>560ms</td>
<td>164ms</td>
<td>185ms</td>
<td>116ms</td>
</tr>
</tbody></table>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2025/08/26/AI/TVM-tutorial/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpeg">
      <meta itemprop="name" content="wxquare">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="wxquare's Blogs">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | wxquare's Blogs">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/08/26/AI/TVM-tutorial/" class="post-title-link" itemprop="url">TVM 学习资料整理（持续更新）</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2025-08-26 12:10:31" itemprop="dateCreated datePublished" datetime="2025-08-26T12:10:31+08:00">2025-08-26</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/AI/" itemprop="url" rel="index"><span itemprop="name">AI</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><strong>这周没什么产出，在TVM社区闲逛。。。</strong></p>
<h3 id="1-TVM编译和安装"><a href="#1-TVM编译和安装" class="headerlink" title="1.TVM编译和安装"></a>1.TVM编译和安装</h3><ul>
<li><a href="https://wxquare.github.io/2019/10/24/other/TVM-hello/">https://wxquare.github.io/2019/10/24/other/TVM-hello/</a></li>
</ul>
<h3 id="2-TVM中向量相加"><a href="#2-TVM中向量相加" class="headerlink" title="2.TVM中向量相加"></a>2.TVM中向量相加</h3><ul>
<li><a href="http://tvm.d2l.ai/chapter_getting_started/vector_add.html">http://tvm.d2l.ai/chapter_getting_started/vector_add.html</a></li>
</ul>
<h3 id="3-TVM编译tensorflow模型"><a href="#3-TVM编译tensorflow模型" class="headerlink" title="3.TVM编译tensorflow模型"></a>3.TVM编译tensorflow模型</h3><ul>
<li><a href="https://wxquare.github.io/2019/10/24/other/TVM-hello/">https://wxquare.github.io/2019/10/24/other/TVM-hello/</a></li>
<li><a href="https://docs.tvm.ai/tutorials/frontend/from_tensorflow.html#sphx-glr-tutorials-frontend-from-tensorflow-py">https://docs.tvm.ai/tutorials/frontend/from_tensorflow.html#sphx-glr-tutorials-frontend-from-tensorflow-py</a></li>
</ul>
<h3 id="4-TVM怎么做模型量化？-doing"><a href="#4-TVM怎么做模型量化？-doing" class="headerlink" title="4.TVM怎么做模型量化？(doing)"></a>4.TVM怎么做模型量化？(doing)</h3><ul>
<li><a href="https://discuss.tvm.ai/t/int8-quantization-proposal/516">https://discuss.tvm.ai/t/int8-quantization-proposal/516</a></li>
<li><a href="https://discuss.tvm.ai/t/quantization-story/3920">https://discuss.tvm.ai/t/quantization-story/3920</a></li>
</ul>
<p>参考：<br>【1】 [Dive into Deep Learning Compiler](Dive into Deep Learning Compiler “<a href="http://tvm.d2l.ai/">http://tvm.d2l.ai/</a>“)<br>【2】 <a href="https://tvm.ai/">https://tvm.ai/</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2025/08/26/AI/TVM-GEMM-CPU/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpeg">
      <meta itemprop="name" content="wxquare">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="wxquare's Blogs">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | wxquare's Blogs">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/08/26/AI/TVM-GEMM-CPU/" class="post-title-link" itemprop="url">TVM学习笔记--GEMM优化及测试数据</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2025-08-26 12:10:31" itemprop="dateCreated datePublished" datetime="2025-08-26T12:10:31+08:00">2025-08-26</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/AI/" itemprop="url" rel="index"><span itemprop="name">AI</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>　　在<a href="https://zhuanlan.zhihu.com/p/88369758">《初识TVM，相比于tensorflow的2倍性能提升》</a>之后，最近花了一点业余时间了解TVM及其周边，并进行相应的性能测试。整体感受是计算优化(GEMM)是非常繁杂的工程工作，需要花费大量的时间和精力才能有比较好的效果。numpy非常优秀，大矩阵乘法硬件利用率在90%以上。TVM在GEMM优化上能实现和numpy相当的效果，重要的是它能大大简化工作量。参考了一些文章，这里简单罗列了几个知识点和测试数据。</p>
<ol>
<li>怎么评估硬件的理论性能？浮点峰值？</li>
<li>简单测试一下numpy的性能数据，硬件利用率</li>
<li>怎么做GEMM优化？</li>
<li>TVM怎么做GEMM的优化？及其与numpy性能的比较</li>
</ol>
<h3 id="怎么评估硬件的计算性能"><a href="#怎么评估硬件的计算性能" class="headerlink" title="怎么评估硬件的计算性能"></a>怎么评估硬件的计算性能</h3><p>　　对于性能优化来说，了解硬件的性能指标是非常有必要的。在Linux系统上可以通过&#x2F;proc&#x2F;cpuinfo文件看看机器的配置。比如CPU主频、CPU核数core、cache大小、是否支持向量指令SSE、AVX2、AVX512等，这些对于计算性能有非常大的影响。<a href="https://zhuanlan.zhihu.com/p/28226956">浮点峰值那些事儿</a>。通常我们使用浮点计算能力来衡量硬件的性能，对于多核服务器来说，频率为2.4G，支持AVX2，FMA向量指令，单核性能如下：<br>    对于float32理论峰值为2.4G * （8+8） * 2  &#x3D; 76.8 GFLOPS<br>    对于float64理论峰值为2.4G * （4+4） * 2  &#x3D; 38.4 GFLOPS</p>
<h3 id="测试numpy-GEMM硬件利用率"><a href="#测试numpy-GEMM硬件利用率" class="headerlink" title="测试numpy GEMM硬件利用率"></a>测试numpy GEMM硬件利用率</h3><p>　　numpy非常优秀，我们通过矩阵乘法了解其性能数据。测试机器为一台多核的服务器，主频是2.4G，支持FMA和AVX2向量指令。测试了不同size矩阵相乘的性能数据。分别测试了单核和四核状态下对float32和float64的不同size(32,128,1024,2048等）矩阵相乘的性能数据。测试结果显示numpy在大矩阵相乘中，硬件利用率大概在90%左右。</p>
<p>name | 32 | 128|1024|2048|4096|10240|硬件利用率|<br>-|-|-|<br>单核float32|1.82|36.16|67.99|67.94|68.88|69.88|91.0%<br>单核float64|1.67|19.49|35.56|35.40|36.11|36.90|96.1%<br>四核float32|6.6|52.2|225.42|246.2|244.2|256.0|83.8%<br>四核float64|5.56|37.62|116.42|120.39|127.03|141.15|91.9%<br><a href="https://github.com/wxquare/programming/blob/master/blog/TVM_CPU_schedule/test_numpy_gemm_performance.py">测试代码</a></p>
<h3 id="怎么优化GEMM？"><a href="#怎么优化GEMM？" class="headerlink" title="怎么优化GEMM？"></a>怎么优化GEMM？</h3><p>　　通用矩阵乘(GEMM)是计算领域非常基础且核心的工作，目前已有大量的工作，这里就不赘述了。大体上通过<strong>分块来减少访存次数、存储顺序、提高cache命中率、利用寄存器提高效率、利用SSE等向量指令提高计算效率</strong>等方法。<a href="https://github.com/flame/how-to-optimize-gemm/wiki">https://github.com/flame/how-to-optimize-gemm/wiki</a> 一步一步详细介绍了GEMM优化的过程，这里在此基础上增加FMA指令的使用，测试了其在1024*1204矩阵相乘的硬件利用率：</p>
<p>name | 64 | 256 |512|1024|硬件利用率|主要优化点|<br>-|-|-|<br>MMult0|1.51|0.79|0.66|0.65|1.69%|base<br>MMult_1x4_5|2.15|1.08|0.72|0.716|2.6%|一次计算1x4个数<br>MMult_1x4_9|4.90|3.15|3.10|3.14|8.18%|1x4，寄存器<br>MMult_4x4_5|2.76|1.53|1.26|1.26|3.28%|一次计算4x4个数<br>MMult_4x4_9|5.19|2.92|2.88|2.87|7.47%|4x4，寄存器<br>MMult_4x4_10|5.95|4.16|4.04|4.01|10.4%|4x4，寄存器，SSE<br>MMult_4x4_10_1|10.0|6.6|6.35|6.4|16.7%|4x4，寄存器，FMA<br>MMult_4x4_11_1|14.5|8.95|7.16|7.08|18.4%|4x4，寄存器，FMA，分块(缓存)<br>MMult_4x4_15_1|11.3|11.6|11.7|11.7|30.4%|4x4，寄存器，FMA，分块，内存顺序</p>
<p><a href="https://github.com/wxquare/programming/tree/master/blog/TVM_CPU_schedule/HowToOptimizeGemm">测试代码</a></p>
<h3 id="TVM-GEMM优化与numpy性能比较"><a href="#TVM-GEMM优化与numpy性能比较" class="headerlink" title="TVM GEMM优化与numpy性能比较"></a>TVM GEMM优化与numpy性能比较</h3><p>　　TVM官网上有关于其针对GEMM的优化的schedule，这里也不赘述了，感兴趣的可以参考后面的参考文章进一步学习，这里测试了在1024*1024矩阵乘法的效率以及其和numpy的比较，可以看出TVM在简单编码的基础上能达到和numpy相当的性能。</p>
<p>  | TVM运行时间 | numpy运行时间 |<br>-|-|-|<br>baseline|2.49s|0.0135s<br>blocking|1.73s|0.012s<br>vectorization|0.411s|0.0117s<br>loop permutaion|0.104s|0.0116s<br>packing|0.0987s|0.0103s<br>write_cache|0.0926s|0.01158s<br>parallel|0.018s|0.012s<br>auto-tvm|0.014s|0.0112s<br><a href="https://github.com/wxquare/programming/tree/master/blog/TVM_CPU_schedule/TVM_GEMM">每个阶段测试代码</a></p>
<p>参考学习链接：<br>1、浮点峰值那些事儿<a href="https://zhuanlan.zhihu.com/p/28226956">https://zhuanlan.zhihu.com/p/28226956</a><br>2、通用矩阵乘（GEMM）优化算法，<a href="https://jackwish.net/gemm-optimization.html">https://jackwish.net/gemm-optimization.html</a><br>3、如何利用TVM快速实现超越Numpy(MKL)的GEMM。<a href="https://zhuanlan.zhihu.com/p/75203171">https://zhuanlan.zhihu.com/p/75203171</a><br>4、tutorial：<a href="https://docs.tvm.ai/tutorials/optimize/opt_gemm.html">https://docs.tvm.ai/tutorials/optimize/opt_gemm.html</a><br>5、d2ltvm:<a href="http://tvm.d2l.ai/chapter_cpu_schedules/index.html">http://tvm.d2l.ai/chapter_cpu_schedules/index.html</a><br>6、<a href="https://github.com/flame/how-to-optimize-gemm">https://github.com/flame/how-to-optimize-gemm</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2025/08/26/AI/TVM-Graph-optimization/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpeg">
      <meta itemprop="name" content="wxquare">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="wxquare's Blogs">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | wxquare's Blogs">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/08/26/AI/TVM-Graph-optimization/" class="post-title-link" itemprop="url">TVM学习笔记--了解Relay和图优化</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2025-08-26 12:10:31" itemprop="dateCreated datePublished" datetime="2025-08-26T12:10:31+08:00">2025-08-26</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/AI/" itemprop="url" rel="index"><span itemprop="name">AI</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>　　TVM主要包括两个部分，一个是Relay和图优化(graph-level)，另一个就是算子（operator）级别优化，这里简单写最近了解到的关于relay和图优化方面的东西。我们都知道深度学习网络通常都是通过计算图来描述的，计算图中的节点表示各种同的算子(opertor),边表示算子之间的依赖关系。Relay可以理解为一种可以描述深度学习网络的函数式编程语言，通过relay可以描述复杂的深度网络，文中提到了control flow。最近一段时间的时间学习直观的感受的Relay编写网络模型和其它框架没什么太多的区别，但是提供的文本形式的中间表示，对开发和调试有很大的帮助。另外，它提供了许多用于图优化的pass，供大家学习和参考。测试代码都在0.6版本上调试通过。<br>    代码地址：<a href="https://github.com/wxquare/programming/tree/master/blog/TVM_graph_optimization">https://github.com/wxquare/programming/tree/master/blog/TVM_graph_optimization</a></p>
<h2 id="一、Hello-Relay"><a href="#一、Hello-Relay" class="headerlink" title="一、Hello Relay"></a>一、Hello Relay</h2><p>既然Relay是一种可以描述计算的函数式语言，逛社区的发现一段代码，可以当作Relay的第一个程序。<br>API参考:<a href="https://docs.tvm.ai/api/python/relay/index.html">https://docs.tvm.ai/api/python/relay/index.html</a></p>
<pre><code><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">from tvm import relay</span><br><span class="line">import tvm.relay.op</span><br><span class="line"></span><br><span class="line">x = relay.expr.var(&#x27;x&#x27;, relay.scalar_type(&#x27;int64&#x27;), dtype = &#x27;int64&#x27;)</span><br><span class="line">one = relay.expr.const(1, dtype = &#x27;int64&#x27;)</span><br><span class="line">add = relay.op.tensor.add(x, one)    </span><br><span class="line">func = relay.expr.Function([x], add, relay.scalar_type(&#x27;int64&#x27;))</span><br><span class="line"></span><br><span class="line">mod = relay.Module.from_expr(func)  # note this API</span><br><span class="line">print(&quot;Relay module function:\n&quot;, mod.astext(show_meta_data=False))</span><br><span class="line">graph, lib, params = tvm.relay.build(mod, &#x27;llvm&#x27;, params=&#123;&#125;)</span><br><span class="line">print(&quot;TVM graph:\n&quot;, graph)</span><br><span class="line">print(&quot;TVM parameters:\n&quot;, params)</span><br><span class="line">print(&quot;TVM compiled target function:\n&quot;, lib.get_source())</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</code></pre>
<h2 id="二、使用Relay定义卷积单元"><a href="#二、使用Relay定义卷积单元" class="headerlink" title="二、使用Relay定义卷积单元"></a>二、使用Relay定义卷积单元</h2><p>在学习Relay的时候参考了<a href="https://zhuanlan.zhihu.com/p/91283238">https://zhuanlan.zhihu.com/p/91283238</a> 这篇文章。但是可能因为版本的问题，很多API多不兼容了，因此修改了一些地方，建议读者也可以去看一下。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line">import tvm</span><br><span class="line">from tvm.relay import transform</span><br><span class="line">import tvm.relay as relay</span><br><span class="line">import numpy as np</span><br><span class="line">from tvm.contrib import graph_runtime</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def batch_norm_infer(data,</span><br><span class="line">                    gamma=None,</span><br><span class="line">                    beta=None,</span><br><span class="line">                    moving_mean=None,</span><br><span class="line">                    moving_var=None,</span><br><span class="line">                    **kwargs):</span><br><span class="line">    name = kwargs.get(&quot;name&quot;)</span><br><span class="line">    kwargs.pop(&quot;name&quot;)</span><br><span class="line">    if not gamma:</span><br><span class="line">        gamma = relay.var(name + &quot;_gamma&quot;)</span><br><span class="line">    if not beta:</span><br><span class="line">        beta = relay.var(name + &quot;_beta&quot;)</span><br><span class="line">    if not moving_mean:</span><br><span class="line">        moving_mean = relay.var(name + &quot;_moving_mean&quot;)</span><br><span class="line">    if not moving_var:</span><br><span class="line">        moving_var = relay.var(name + &quot;_moving_var&quot;)</span><br><span class="line">    return relay.nn.batch_norm(data,</span><br><span class="line">                            gamma=gamma,</span><br><span class="line">                            beta=beta,</span><br><span class="line">                            moving_mean=moving_mean,</span><br><span class="line">                            moving_var=moving_var,</span><br><span class="line">                            **kwargs)[0]</span><br><span class="line"></span><br><span class="line">def conv2d(data, weight=None, **kwargs):</span><br><span class="line">    name = kwargs.get(&quot;name&quot;)</span><br><span class="line">    kwargs.pop(&quot;name&quot;)</span><br><span class="line">    if not weight:</span><br><span class="line">        weight = relay.var(name + &quot;_weight&quot;)</span><br><span class="line">    return relay.nn.conv2d(data, weight, **kwargs)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def conv_block(data, name, channels, kernel_size=(3, 3), strides=(1, 1),</span><br><span class="line">            padding=(1, 1), epsilon=1e-5):</span><br><span class="line">    conv = conv2d(</span><br><span class="line">        data=data,</span><br><span class="line">        channels=channels,</span><br><span class="line">        kernel_size=kernel_size,</span><br><span class="line">        strides=strides,</span><br><span class="line">        padding=padding,</span><br><span class="line">        data_layout=&#x27;NCHW&#x27;,</span><br><span class="line">        name=name+&#x27;_conv&#x27;)</span><br><span class="line">    bn = batch_norm_infer(data=conv, epsilon=epsilon, name=name + &#x27;_bn&#x27;)</span><br><span class="line">    act = relay.nn.relu(data=bn)</span><br><span class="line">    return act</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">data_shape = (1, 3, 224, 224)</span><br><span class="line">kernel_shape = (32, 3, 3, 3)</span><br><span class="line">dtype = &quot;float32&quot;</span><br><span class="line">data = relay.var(&quot;data&quot;, shape=data_shape, dtype=dtype)</span><br><span class="line">act = conv_block(data, &quot;graph&quot;, 32, strides=(2, 2))</span><br><span class="line">func = relay.Function(relay.analysis.free_vars(act),act)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">mod = relay.Module.from_expr(func)</span><br><span class="line">mod = relay.transform.InferType()(mod)</span><br><span class="line">shape_dict = &#123;</span><br><span class="line">    v.name_hint : v.checked_type for v in mod[&quot;main&quot;].params&#125;</span><br><span class="line">np.random.seed(0)</span><br><span class="line">params = &#123;&#125;</span><br><span class="line">for k, v in shape_dict.items():</span><br><span class="line">    if k == &quot;data&quot;:</span><br><span class="line">        continue</span><br><span class="line">    init_value = np.random.uniform(-1, 1, v.concrete_shape).astype(v.dtype)</span><br><span class="line">    params[k] = tvm.nd.array(init_value, ctx=tvm.cpu(0))</span><br><span class="line"></span><br><span class="line">target = &quot;llvm&quot;</span><br><span class="line">ctx = tvm.context(target, 0)</span><br><span class="line">print(&quot;Relay module function:\n&quot;, mod.astext(show_meta_data=False))</span><br><span class="line">print(&quot;TVM parameters:\n&quot;, params.keys())</span><br><span class="line"></span><br><span class="line">with relay.build_config(opt_level=3):</span><br><span class="line">    graph, lib, params = relay.build(mod, target, params=params)</span><br><span class="line"></span><br><span class="line">print(&quot;TVM graph:\n&quot;, graph)</span><br><span class="line">print(&quot;TVM parameters:\n&quot;, params.keys())</span><br><span class="line"># print(&quot;TVM compiled target function:\n&quot;, lib.get_source())</span><br><span class="line">module = graph_runtime.create(graph, lib, ctx)</span><br><span class="line">data_tvm = tvm.nd.array((np.random.uniform(-1, 1, size=data_shape)).astype(dtype))</span><br><span class="line">module.set_input(&#x27;data&#x27;, data_tvm)</span><br><span class="line">module.set_input(**params)</span><br><span class="line">module.run()</span><br><span class="line">output = module.get_output(0)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="三、Relay-Graph-Optimization"><a href="#三、Relay-Graph-Optimization" class="headerlink" title="三、Relay Graph Optimization"></a>三、Relay Graph Optimization</h2><p>前面两个例子介绍了怎么使用relay构建网络，这个部分介绍怎么使用relay做图优化。上面例子代码中没有直接图优化的代码，而是包含在relay.build中。通过追踪代码，我们这部分的逻辑集中在 <a href="https://github.com/apache/incubator-tvm/blob/v0.6/src/relay/backend/build_module.cc">https://github.com/apache/incubator-tvm/blob/v0.6/src/relay/backend/build_module.cc</a> 这个文件的optimize函数中。这里罗列了代码用到的pass，relay提供了方便的的文本形式中间描述，感兴趣的可以自己试一下每个pass之后，发生了哪些变化。</p>
<ul>
<li>relay::qnn::transform::Legalize())，这个pass和qnn有关</li>
<li>transform::Legalize()，我理解的这个是和目标有关的优化，一个表达式虽然在语义上等效于另一个，但可以在目标上具有更好的性能。这个在需要在异构环境下生效。</li>
<li>transform::SimplifyInference() 。<br>简化推理阶段的数据流图。在语义上等于输入表达式的简化表达式将被返回。例如将BatchNorm展开以及去掉 dropout。</li>
<li>transform::EliminateCommonSubexpr(fskip))，去除公共子表达式。</li>
<li>transform::CombineParallelConv2D(3)，将多个conv2d运算符合并为一个，这部分优化会将具有相同输入的卷积合并成一个大的卷积运算。</li>
<li>transform::CombineParallelDense(3))，将多个dense运算符组合为一个</li>
<li>transform::FoldConstant()，常量传播优化。</li>
<li>transform::FoldScaleAxis()</li>
<li>transform::CanonicalizeCast()，<br>将特殊运算符规范化为基本运算符。这样可以简化后续分析，例如将bias_add扩展为expand_dims和broadcast_add</li>
<li>transform::CanonicalizeOps()</li>
<li>transform::AlterOpLayout()，layout 变换</li>
<li>transform::FuseOps()，算子融合，根据一些规则，将expr中的运算符融合为较大的运算符。</li>
</ul>
<h2 id="四、使用Python-API-Relay-图优化"><a href="#四、使用Python-API-Relay-图优化" class="headerlink" title="四、使用Python API Relay 图优化"></a>四、使用Python API Relay 图优化</h2><p> TVM核心代码是采用C++编写的，但是也提供了Python接口，这方面初学者体验的使用。Relay图优化核心功能都提供了对应的API，因此可以尝试一下，非常简单。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">def my_optimize(func,params=None):</span><br><span class="line"></span><br><span class="line">    if params:</span><br><span class="line">        graph = _bind_params(func, params)</span><br><span class="line"></span><br><span class="line">    # https://docs.tvm.ai/api/python/relay/transform.html</span><br><span class="line">    optimize = relay.transform.Sequential([relay.transform.SimplifyInference(),</span><br><span class="line">                                      relay.transform.FoldConstant(),</span><br><span class="line">                                      relay.transform.FoldScaleAxis(),</span><br><span class="line">                                      relay.transform.CanonicalizeOps(),</span><br><span class="line">                                      relay.transform.FoldConstant()])</span><br><span class="line"></span><br><span class="line">    mod = relay.Module.from_expr(graph)</span><br><span class="line">    mod = optimize(mod)</span><br><span class="line">    return mod[&quot;main&quot;]</span><br><span class="line"></span><br><span class="line">mod[&#x27;main&#x27;] = my_optimize(mod[&#x27;main&#x27;], params)</span><br><span class="line">print(&quot;Relay module function:\n&quot;, mod.astext(show_meta_data=False))</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>这里可以对比优化前后的IR.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">Relay module function:</span><br><span class="line"> v0.0.4</span><br><span class="line">def @main(%data: Tensor[(1, 3, 224, 224), float32], %graph_conv_weight: Tensor[(32, 3, 3, 3), float32], %graph_bn_gamma: Tensor[(32), float32], %graph_bn_beta: Tensor[(32), float32], %graph_bn_moving_mean: Tensor[(32), float32], %graph_bn_moving_var: Tensor[(32), float32]) -&gt; Tensor[(1, 32, 112, 112), float32] &#123;</span><br><span class="line">  %0 = nn.conv2d(%data, %graph_conv_weight, strides=[2, 2], padding=[1, 1], channels=32, kernel_size=[3, 3]) /* ty=Tensor[(1, 32, 112, 112), float32] */;</span><br><span class="line">  %1 = nn.batch_norm(%0, %graph_bn_gamma, %graph_bn_beta, %graph_bn_moving_mean, %graph_bn_moving_var) /* ty=(Tensor[(1, 32, 112, 112), float32], Tensor[(32), float32], Tensor[(32), float32]) */;</span><br><span class="line">  %2 = %1.0;</span><br><span class="line">  nn.relu(%2) /* ty=Tensor[(1, 32, 112, 112), float32] */</span><br><span class="line">&#125;</span><br><span class="line"># =====================================</span><br><span class="line">Relay module function:</span><br><span class="line"> v0.0.4</span><br><span class="line">def @main(%data: Tensor[(1, 3, 224, 224), float32]) -&gt; Tensor[(1, 32, 112, 112), float32] &#123;</span><br><span class="line">  %0 = nn.conv2d(%data, meta[relay.Constant][0] /* ty=Tensor[(32, 3, 3, 3), float32] */ /* ty=Tensor[(32, 3, 3, 3), float32] */, strides=[2, 2], padding=[1, 1], channels=32, kernel_size=[3, 3]) /* ty=Tensor[(1, 32, 112, 112), float32] */;</span><br><span class="line">  %1 = multiply(%0, meta[relay.Constant][1] /* ty=Tensor[(32, 1, 1), float32] */ /* ty=Tensor[(32, 1, 1), float32] */) /* ty=Tensor[(1, 32, 112, 112), float32] */;</span><br><span class="line">  %2 = add(%1, meta[relay.Constant][2] /* ty=Tensor[(32, 1, 1), float32] */ /* ty=Tensor[(32, 1, 1), float32] */) /* ty=Tensor[(1, 32, 112, 112), float32] */;</span><br><span class="line">  nn.relu(%2) /* ty=Tensor[(1, 32, 112, 112), float32] */</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// meta data omitted. you can use show_meta_data=True to include meta data</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>参考与进阶学习：<br>[1]. <a href="https://www.zhihu.com/question/331611341/answer/875630325">https://www.zhihu.com/question/331611341/answer/875630325</a><br>[2]. <a href="https://zhuanlan.zhihu.com/p/91283238">https://zhuanlan.zhihu.com/p/91283238</a><br>[3]. <a href="https://docs.tvm.ai/dev/relay_intro.html">https://docs.tvm.ai/dev/relay_intro.html</a><br>[4]. <a href="https://docs.tvm.ai/dev/relay_add_op.html">https://docs.tvm.ai/dev/relay_add_op.html</a><br>[5]. <a href="https://docs.tvm.ai/dev/relay_add_pass.html">https://docs.tvm.ai/dev/relay_add_pass.html</a><br>[6]. <a href="https://arxiv.org/pdf/1810.00952.pdf">https://arxiv.org/pdf/1810.00952.pdf</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2025/08/26/AI/TVM-code-generation/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpeg">
      <meta itemprop="name" content="wxquare">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="wxquare's Blogs">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | wxquare's Blogs">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/08/26/AI/TVM-code-generation/" class="post-title-link" itemprop="url">TVM学习笔记--代码生成</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2025-08-26 12:10:31" itemprop="dateCreated datePublished" datetime="2025-08-26T12:10:31+08:00">2025-08-26</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/AI/" itemprop="url" rel="index"><span itemprop="name">AI</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="代码生成的接口"><a href="#代码生成的接口" class="headerlink" title="代码生成的接口"></a>代码生成的接口</h2><p>　　TVM代码生成的接口和主要类型，可以总结为两个build，两个module，两个function。它提供了两个代码生成的接口，tvm.build和tvm.relay.build，前者是针对算子的代码生成，后者是针对relay计算图的代码生成。在0.7版本中，tvm进行了IR的统一，使得两个build的输入参数类型都可以是IRModule，输出类型都是运行时Module。尽管两个build接口统一了输入类型，但是内部包含的函数类型是不一样的，算子编译时是tvm.tir.function.PrimFunc，而relay图编译时函数类型是tvm.relay.function.Function。TVM在设计时提供了方便的调试功能，通过IRModule的astext函数可以查看ir中间描述，通过运行时module的get_source查看生成的代码。下面通过两个简单的例子查看算子和relay图的ir中间描述和以及对应生成的源代码。</p>
<ul>
<li><a href="https://tvm.apache.org/docs/api/python/driver.html?highlight=build#tvm.build">tvm.build</a></li>
<li><a href="https://tvm.apache.org/docs/api/python/relay/index.html?highlight=build#tvm.relay.build">tvm.relay.build</a></li>
<li><a href="https://tvm.apache.org/docs/api/python/ir.html?highlight=irmodule#tvm.ir.IRModule">tvm.ir.module.IRModule</a></li>
<li><a href="https://tvm.apache.org/docs/api/python/runtime.html?highlight=module#tvm.runtime.Module">tvm.runtime.module.Module</a></li>
<li><a href="https://tvm.apache.org/docs/api/python/tir.html?highlight=primfunc#tvm.tir.PrimFunc">tvm.tir.function.PrimFunc</a></li>
<li><a href="https://tvm.apache.org/docs/api/python/relay/index.html?highlight=function#tvm.relay.Function">tvm.relay.function.Function</a></li>
</ul>
<h3 id="算子编译"><a href="#算子编译" class="headerlink" title="算子编译"></a>算子编译</h3><pre><code>import tvm
from tvm import te

M = 1024
K = 1024
N = 1024

# Algorithm
k = te.reduce_axis((0, K), &#39;k&#39;)
A = te.placeholder((M, K), name=&#39;A&#39;)
B = te.placeholder((K, N), name=&#39;B&#39;)
C = te.compute(
           (M, N),
           lambda x, y: te.sum(A[x, k] * B[k, y], axis=k),
           name=&#39;C&#39;)

# Default schedule
s = te.create_schedule(C.op)
ir_m = tvm.lower(s, [A, B, C], simple_mode=True,name=&#39;mmult&#39;)
rt_m = tvm.build(ir_m, [A, B, C], target=&#39;c&#39;, name=&#39;mmult&#39;)

# print tir
print(&quot;tir:\n&quot;, ir_m.astext(show_meta_data=False))
# print source code
print(&quot;source code:\n&quot;,rt_m.get_source())
</code></pre>
<h3 id="relay图编译"><a href="#relay图编译" class="headerlink" title="relay图编译"></a>relay图编译</h3><pre><code>import ssl
ssl._create_default_https_context = ssl._create_unverified_context

from tvm import relay
from tvm.relay import testing
from tvm.contrib import util
import tvm

# Resnet18 workload
resnet18_mod, resnet18_params = relay.testing.resnet.get_workload(num_layers=18)

with relay.build_config(opt_level=0):
    _, resnet18_lib, _ = relay.build_module.build(resnet18_mod, &quot;llvm&quot;, params=resnet18_params)

# print relay ir
print(resnet18_mod.astext(show_meta_data=False))

# print source code
print(resnet18_lib.get_source())
</code></pre>
<h2 id="代码生成的流程"><a href="#代码生成的流程" class="headerlink" title="代码生成的流程"></a>代码生成的流程</h2><p>　　通过上面两个例子我们知道tvm代码生成接口上是IRModule到运行时module的转换，它完成tir或者relay ir到目标target代码的编译，例如c或者llvm IR等。下面的流程图描述整个代码的编译流程，深色表示C++代码，浅色表示python代码。算子编译时会首先进行tir的优化，分离出host和device部分，之后会调用注册的target.build.target函数进行编译。relay图编译相比算子稍微复杂一点，核心代码采用C++开发。它会通过relayBuildModule.Optimize进行relay图优化，之后针对module中的每个lower_funcs进行编译之前，合成最终的运行时module，其后部分的编译流程和算子编译相似。</p>
<p><img src="/images/tvm_code_generation.jpg" alt="TVM代码生成流程"></p>
<h2 id="Codegen的实现"><a href="#Codegen的实现" class="headerlink" title="Codegen的实现"></a>Codegen的实现</h2><p> TVM针对不同的target实现了许多的codgen，它完成了tir到目标代码的翻译工作，例如c,llvm ir等。我们也可以根据需求实现自己的codegen，官网提供了一个<a href="https://tvm.apache.org/docs/dev/relay_bring_your_own_codegen.html">教程</a>。</p>
<ul>
<li>target.build.c</li>
<li>target.build.llvm</li>
<li>target.build.cuda</li>
<li>target.build.opencl</li>
<li>target.build.opengl</li>
<li>target.build.metal</li>
<li>target.build.vulkan</li>
</ul>
<h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><p>[1]. Unified IR RFC,<a href="https://github.com/apache/incubator-tvm/issues/4617">https://github.com/apache/incubator-tvm/issues/4617</a><br>[2]. Codegen的实现：<a href="https://tvm.apache.org/docs/dev/relay_bring_your_own_codegen.html">https://tvm.apache.org/docs/dev/relay_bring_your_own_codegen.html</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2025/08/26/AI/DaSiamRPN/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpeg">
      <meta itemprop="name" content="wxquare">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="wxquare's Blogs">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | wxquare's Blogs">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/08/26/AI/DaSiamRPN/" class="post-title-link" itemprop="url">了解DaSiamRPN追踪算法的运行过程</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2025-08-26 12:10:31" itemprop="dateCreated datePublished" datetime="2025-08-26T12:10:31+08:00">2025-08-26</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/AI/" itemprop="url" rel="index"><span itemprop="name">AI</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>　　在2018年的CVPR上SiameseRPN模型被提出，它宣称在单目标跟踪问题上做到了state-of-the-art，能同时兼顾精度(accuracy)和速度(efficiency)。在这之后，很快又在ECCV上发表了DaSiamRPN模型，它在SiameseRPN基础进一步提升了追踪的性能。SiameseRPN不是一簇而就的，它的设计思想来源于SiameseFc，并引入物体检测领域的区域推荐网络(RPN),通过网络回归避免了多尺度测试，同时得到更加精准的目标框和目标的位置。实际使用中发现DaSiamRPN相比传统的KCF效果直观感受确实精度有较大提升，在普通pc无GPU环境上大概是10.6fps。这里主要结合<a href="http://openaccess.thecvf.com/content_cvpr_2018/papers/Li_High_Performance_Visual_CVPR_2018_paper.pdf">SimeseRPN的论文</a>和<a href="https://github.com/foolwood/DaSiamRPN">DaSiamRPN的代码</a>帮助了解SimeseRPN的模型结构以及DaSiamRPN的运行过程。</p>
<h2 id="SiameseRPN模型"><a href="#SiameseRPN模型" class="headerlink" title="SiameseRPN模型"></a>SiameseRPN模型</h2><p>　　Siamese-RPN本质上是组合网络模型，它包括用于特征提取的Siamese网络和生成候选区域的RPN网络。<br>　　<strong>Siamese特征提取网络</strong>：它目前在追踪领域使用比较多，包括模板分支(template branch)和检测分支(detection branch)，它们都是经过裁剪的AlexNet卷积网络，用于提取图像的特征。两个分支网络参数和权重值完全相同，只是输入不同，模板分支输入模板帧中的目标部分(target patch)，检测分支输入当前需要追踪的帧的区域(target patch)。<br>　　<strong>RPN(region proposal subnetwork)候选区域生成网络</strong>：它包括的分类(classification)和回归(regression)两个分支。这里有个重要的锚点(anchor),就是通过RPN对每个锚点上的k个不同宽度和高度的矩形分类和回归，得到感兴趣区域。每个anhcor box要分前景和背景，所以cls&#x3D;2k；而每个anchor box都有[x, y, w, h]对应4个偏移量，所以reg&#x3D;4k。</p>
<p><img src="/images/Siamese-RPN.jpg" alt="SiameseRPN模型"></p>
<p>　　因此设模板分支输入为$z$维度为(127,127,3)，首先通过Siamese网络特征提取得到$ψ(z)$维度为(6,6,256)，然后再经历卷积分别的到$[ψ(z)]<em>{cls}$和$[ψ(z)]</em>{res}$。检测分支输入为$x$，$ψ(x)$为Siamese特征提取网路的输出，以$[ψ(z)]<em>{cls}$和$[ψ(z)]</em>{res}$为核卷积得到最终的SiameseRPN的输出，$*$表示卷积运算。<br>$$A_{w×h×2k}^{cls} &#x3D; [ψ(x)]<em>{cls} * [ψ(z)]</em>{cls}$$</p>
<p>$$A_{w×h×4k}^{res} &#x3D; [ψ(x)]<em>{res} * [ψ(z)]</em>{res}$$</p>
<h2 id="DaSiamRPN视频追踪的过程"><a href="#DaSiamRPN视频追踪的过程" class="headerlink" title="DaSiamRPN视频追踪的过程"></a>DaSiamRPN视频追踪的过程</h2><p>　　DaSiamRPN做视频目标追踪，DaSiamRPN相比SiameseRPN做了进一步的优化，例如训练时引入采样策略控制不平衡的样本分布，设计了一种distractor-aware模块执行增量学习等。结合官方的<a href="https://github.com/foolwood/DaSiamRPN">https://github.com/foolwood/DaSiamRPN</a> 中的例子，很容易将demo运行起来。需要注意的是github上的代码需要gpu运行环境，如果要在无gpu机器上运行DaSiamRPN的demo需要将有关cuda代码去掉。例如将将net.eval().cuda()换成net.eval()。DaSiamRPN的运行包含两个步骤：</p>
<ol>
<li>初始化。输入模板帧，得到$[ψ(z)]<em>{cls}$和$[ψ(z)]</em>{res}$两个用于卷积的核。</li>
<li>追踪。将待追踪帧输入到模型，得到每个候选区域的score和偏移delta。从候选区域中选出分数最高的候选区域proposal。</li>
</ol>
<h3 id="初始化"><a href="#初始化" class="headerlink" title="初始化"></a>初始化</h3><ol>
<li>输出模板图片im，模板图片中目标位置target_pos，目标大小target_size，使用get_subwindow_tracking函数裁剪目标区域临近部分(target patch),并将裁剪得到图片resize到宽和高为127的图片。</li>
<li>将模板目标区域裁剪好的视频输入网络模型的模板分支(template branch)，得到$[ψ(z)]<em>{cls}$和$[ψ(z)]</em>{res}$</li>
<li>使用generate_anchor函数产生anchers，其大小为$(271-127)&#x2F;8+1&#x3D;19,19*19*5&#x3D;1805$，anchor的维度为(4,1805)，这表示会有1805个候选区域，偏移量$d_x,d_y,d_w,d_h$</li>
</ol>
<h3 id="追踪"><a href="#追踪" class="headerlink" title="追踪"></a>追踪</h3><ol>
<li>输入追踪的图片im，基于上一帧的target_pos和目标的大小位置target_size，在图片中裁剪部分区域并将该区域resize到271*271得到x_crop。</li>
<li>将x_crop输入网络的检测分支(detection branch)得到对所有anchor进行分类和回归得到delta和score。</li>
<li>根据delta获取细化后的候选区域(refinement coordinates)<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># generate the refined top K proposals</span><br><span class="line">delta[0, :] = delta[0, :] * p.anchor[:, 2] + p.anchor[:, 0]  #x</span><br><span class="line">delta[1, :] = delta[1, :] * p.anchor[:, 3] + p.anchor[:, 1]  #y</span><br><span class="line">delta[2, :] = np.exp(delta[2, :]) * p.anchor[:, 2]           #w</span><br><span class="line">delta[3, :] = np.exp(delta[3, :]) * p.anchor[:, 3]           #h</span><br></pre></td></tr></table></figure></li>
<li>结合scale penalty、ration penalty、cosine window调整每个候选区域score中每个候选区域的分数,选出分数最大的候选区域best_pscore_id.<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># size penalty</span><br><span class="line">s_c = change(sz(delta[2, :], delta[3, :]) / sz_wh(target_sz))  # scale penalty</span><br><span class="line">r_c = change((target_sz[0] / target_sz[1]) / (delta[2, :] / delta[3, :]))  # ratio penalty</span><br><span class="line">penalty = np.exp(-(r_c * s_c - 1.) * p.penalty_k)</span><br><span class="line">pscore = penalty * score</span><br><span class="line"># window float</span><br><span class="line">pscore = pscore * (1 - p.window_influence) + window * p.window_influence</span><br><span class="line">best_pscore_id = np.argmax(pscore)</span><br></pre></td></tr></table></figure></li>
<li>计算出当前帧目标的位置target_pos和target_size。<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">target = delta[:, best_pscore_id] / scale_z</span><br><span class="line">target_sz = target_sz / scale_z</span><br><span class="line"></span><br><span class="line">lr = penalty[best_pscore_id] * score[best_pscore_id] * p.lr</span><br><span class="line"></span><br><span class="line">res_x = target_pos[0] + target[0]</span><br><span class="line">res_y = target_pos[1] + target[1]</span><br><span class="line">res_w = target_sz[0] * (1 - lr) + target[2] * lr</span><br><span class="line">res_h = target_sz[1] * (1 - lr) + target[3] * lr</span><br><span class="line"></span><br><span class="line">target_pos = np.array([res_x, res_y])</span><br><span class="line">target_sz = np.array([res_w, res_h])</span><br></pre></td></tr></table></figure></li>
</ol>
<p>参考：</p>
<ol>
<li><a href="https://zhuanlan.zhihu.com/p/37856765">https://zhuanlan.zhihu.com/p/37856765</a></li>
<li><a href="https://github.com/foolwood/DaSiamRPN">https://github.com/foolwood/DaSiamRPN</a></li>
<li><a href="http://openaccess.thecvf.com/content_cvpr_2018/papers/Li_High_Performance_Visual_CVPR_2018_paper.pdf">http://openaccess.thecvf.com/content_cvpr_2018/papers/Li_High_Performance_Visual_CVPR_2018_paper.pdf</a></li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2025/08/26/AI/READEME/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpeg">
      <meta itemprop="name" content="wxquare">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="wxquare's Blogs">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | wxquare's Blogs">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/08/26/AI/READEME/" class="post-title-link" itemprop="url">Untitled</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2025-08-26 12:10:31" itemprop="dateCreated datePublished" datetime="2025-08-26T12:10:31+08:00">2025-08-26</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="基础模型能力i"><a href="#基础模型能力i" class="headerlink" title="基础模型能力i"></a>基础模型能力i</h2><ul>
<li>deepseek</li>
</ul>
<h2 id="AI-应用"><a href="#AI-应用" class="headerlink" title="AI 应用"></a>AI 应用</h2><ul>
<li>Thinkpal AI + 教育</li>
<li>具身智能</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2025/05/01/system-design/2-e-commerce/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpeg">
      <meta itemprop="name" content="wxquare">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="wxquare's Blogs">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | wxquare's Blogs">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/05/01/system-design/2-e-commerce/" class="post-title-link" itemprop="url">互联网业务系统 - 电商系统设计</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2025-05-01 00:00:00" itemprop="dateCreated datePublished" datetime="2025-05-01T00:00:00+08:00">2025-05-01</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-08-26 12:10:31" itemprop="dateModified" datetime="2025-08-26T12:10:31+08:00">2025-08-26</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/" itemprop="url" rel="index"><span itemprop="name">系统设计</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="电商系统整体架构设计"><a href="#电商系统整体架构设计" class="headerlink" title="电商系统整体架构设计"></a>电商系统整体架构设计</h2><h3 id="业务流-business-process"><a href="#业务流-business-process" class="headerlink" title="业务流 (business process)"></a>业务流 (business process)</h3><p align="center">
  <img src="/images/E-commerce-whole-business-process.webp" width=800 height=500>
  <br/>
  <strong><a href="https://axureboutique.com/blogs/product-design/understanding-the-structure-of-e-commerce-products">E-commerce process</a></strong>
</p>

<h3 id="系统流-system-process"><a href="#系统流-system-process" class="headerlink" title="系统流 (system process)"></a>系统流 (system process)</h3><p align="center">
  <img src="/images/E-commerce-whole-system-process.webp" width=800 height=500>
  <br/>
  <strong><a href="https://axureboutique.com/blogs/product-design/understanding-the-structure-of-e-commerce-products">E-commerce whole process of system</a></strong>
</p>

<h3 id="产品架构-Product-Structure-组织架构"><a href="#产品架构-Product-Structure-组织架构" class="headerlink" title="产品架构 (Product Structure&#x2F;组织架构)"></a>产品架构 (Product Structure&#x2F;组织架构)</h3><p align="center">
  <img src="/images/E-commerce-product-structure.webp" width=800 height=600>
  <br/>
  <strong><a href="https://axureboutique.com/blogs/product-design/understanding-the-structure-of-e-commerce-products">E-commerce product structure</a></strong>
</p>

<h3 id="应用架构"><a href="#应用架构" class="headerlink" title="应用架构"></a>应用架构</h3><p align="center">
  <img src="/images/application-architecture.png" width=700 height=550>
</p>

<h3 id="技术架构"><a href="#技术架构" class="headerlink" title="技术架构"></a>技术架构</h3><p align="center">
  <img src="/images/14-e-commerce-tech-architecture-mindmap.png" width=700 height=1400>
</p>

<h3 id="数据架构"><a href="#数据架构" class="headerlink" title="数据架构"></a>数据架构</h3><h2 id="商品管理-Product-Center"><a href="#商品管理-Product-Center" class="headerlink" title="商品管理 Product Center"></a>商品管理 Product Center</h2><h3 id="商品信息包括哪些内容"><a href="#商品信息包括哪些内容" class="headerlink" title="商品信息包括哪些内容"></a>商品信息包括哪些内容</h3><p align="center">
  <img src="/images/item-info.png" width=700 height=600>
</p>

<h3 id="商品系统的演进"><a href="#商品系统的演进" class="headerlink" title="商品系统的演进"></a>商品系统的演进</h3><table>
<thead>
<tr>
<th>阶段</th>
<th>主要特征&#x2F;能力</th>
<th>技术架构&#x2F;数据模型</th>
<th>适用场景&#x2F;目标</th>
<th>实现方式简单说明</th>
</tr>
</thead>
<tbody><tr>
<td>初始阶段</td>
<td>- 商品信息简单，字段少<br>- SKU&#x2F;SPU未严格区分<br>- 价格库存直接在商品表<br>- 仅支持基本的增删改查</td>
<td>单表&#x2F;简单表结构</td>
<td>小型电商、业务初期，SKU数量少</td>
<td>单体应用，单表存储，简单业务逻辑，直接数据库操作</td>
</tr>
<tr>
<td>成长阶段</td>
<td>- 引入SPU&#x2F;SKU模型<br>- 属性、类目、品牌等实体独立<br>- 支持多规格商品<br>- 价格库存可拆分为独立表</td>
<td>关系型数据库，ER模型优化</td>
<td>SKU多样化，品类扩展，业务快速增长</td>
<td>关系型数据库，ER模型优化，多表存储，业务逻辑复杂</td>
</tr>
<tr>
<td>成熟阶段</td>
<td>- 商品中台化，支持多业务线&#x2F;多渠道<br>- 属性体系灵活可扩展<br>- 多级类目、标签、图片、描述等丰富<br>- 商品快照、操作日志、版本控制</td>
<td>中台架构，微服务&#x2F;多表&#x2F;NoSQL</td>
<td>大型平台，业务复杂，需支撑多业务场景</td>
<td>分布式服务，插件化&#x2F;配置化流程，状态机驱动，异步消息，灵活数据模型</td>
</tr>
<tr>
<td>未来演进</td>
<td>- 多语言多币种支持<br>- 商品内容多媒体化（视频、3D等）<br>- AI智能标签&#x2F;推荐<br>- 商品数据实时分析与洞察</td>
<td>分布式&#x2F;云原生&#x2F;大数据平台</td>
<td>国际化、智能化、数据驱动的电商生态</td>
<td>云原生架构，AI&#x2F;大数据分析，自动化运维，弹性伸缩，智能路由与风控</td>
</tr>
</tbody></table>
<h3 id="什么是SPU、SKU"><a href="#什么是SPU、SKU" class="headerlink" title="什么是SPU、SKU"></a>什么是SPU、SKU</h3><p>方案一：同时创建多个SKU，并同步生成关联的SPU。整体方案是直接创建SKU，并维护多个不同的属性；该方案适用于大多数C2C综合电商平台（例如，阿里巴巴就是采用这种方式创建商品）。<br>方案二：先创建SPU，再根据SPU创建SKU。整体方案是由平台的主数据团队负责维护SPU，商家（包括自营和POP）根据SPU维护SKU。在创建SKU时，首先选择SPU（SPU中的基本属性由数据团队维护），然后基于SPU维护销售属性和物流属性，最后生成SKU；该方案适用于高度专业化的垂直B2B行业，如汽车、医药等。<br>这两种方案的原因是：垂直B2B平台上的业务（传统行业、年长的商家）操作能力有限，维护产品属性的错误率远高于C2C平台，同时平台对产品结构控制的要求较高。为了避免同一产品被不同商家维护成多个不同的属性（例如，汽车轮胎的胎面宽度、尺寸等属性），平台通常选择专门的数据团队来维护产品的基本属性，即维护SPU。<br>此外，B2B垂直电商的品类较少，SKU数量相对较小，品类标准化程度高，平台统一维护的可行性较高。<br>对于拥有成千上万品类的综合电商平台，依靠平台数据团队的统一维护是不现实的，或者像服装这样非标准化的品类对商品结构化管理的要求较低。因此，综合平台（阿里巴巴和亚马逊）的设计方向与垂直平台有所不同。<br>实际上，即使对于综合平台，不同的品类也会有不同的设计方法。一些品类具有垂直深度，因此也采用平台维护SPU和商家创建SKU的方式</p>
<h3 id="数据库模型"><a href="#数据库模型" class="headerlink" title="数据库模型"></a>数据库模型</h3><ul>
<li>类目category</li>
<li>品牌brand</li>
<li>属性attribute</li>
<li>标签tag</li>
<li>商品主表&#x2F;spu表&#x2F;item表、item_stat 统计表、item属性值表</li>
<li>商品变体表&#x2F;variant表&#x2F;sku表、sku attribute表</li>
<li>其它实体表、其它实体和商品表的关联表</li>
</ul>
<p align="center">
  <img src="/images/product_ER.png" width=700 height=700>
  <br/>
  <strong><a href="https://axureboutique.com/blogs/product-design/build-an-e-commerce-product-center-from-scratch">E-commerce product center</a></strong>
</p>

<h4 id="模型说明："><a href="#模型说明：" class="headerlink" title="模型说明："></a>模型说明：</h4><ul>
<li>商品（item&#x2F;SPU）与商品变体（sku）分离，便于管理不同规格、价格、库存的商品。</li>
<li>属性（attribute）、类目（category）、品牌（brand）等实体独立，便于扩展和维护</li>
<li>商品分类体系如何设计？采用多级分类？分类的动态扩展只需插入新分类，指定其 parent_id，即可动态扩展任意层级</li>
<li>灵活的属性体系。通过 category_attribute 和 spu_attr_value 支持不同类目下的不同属性，适应多样化商品需求。属性值与商品解耦，支持动态扩展</li>
<li>item_stat 单独存储统计信息，便于高并发下的读写优化。</li>
<li>可以方便地增加标签（tag）、图片、描述、规格等字段，适应业务变化</li>
</ul>
<h4 id="商品信息录入JSON示例"><a href="#商品信息录入JSON示例" class="headerlink" title="商品信息录入JSON示例"></a>商品信息录入JSON示例</h4><h5 id="实体商品"><a href="#实体商品" class="headerlink" title="实体商品"></a>实体商品</h5><details>
<summary>1、实体商品男士T恤 JSON 数据</summary>
<pre><code class="json">
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;categoryId&quot;</span><span class="punctuation">:</span> <span class="number">1003001</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;spu&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;经典圆领男士T恤&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;brandId&quot;</span><span class="punctuation">:</span> <span class="number">2001</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;柔软舒适，100%纯棉&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;basicAttributes&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;attributeId&quot;</span><span class="punctuation">:</span> <span class="number">101</span><span class="punctuation">,</span>         <span class="comment">// 品牌</span></span><br><span class="line">      <span class="attr">&quot;attributeName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;品牌&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="string">&quot;NIKE&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;attributeId&quot;</span><span class="punctuation">:</span> <span class="number">102</span><span class="punctuation">,</span>         <span class="comment">// 材质</span></span><br><span class="line">      <span class="attr">&quot;attributeName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;材质&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="string">&quot;棉&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;attributeId&quot;</span><span class="punctuation">:</span> <span class="number">103</span><span class="punctuation">,</span>         <span class="comment">// 产地</span></span><br><span class="line">      <span class="attr">&quot;attributeName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;产地&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="string">&quot;中国&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;attributeId&quot;</span><span class="punctuation">:</span> <span class="number">104</span><span class="punctuation">,</span>         <span class="comment">// 袖型</span></span><br><span class="line">      <span class="attr">&quot;attributeName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;袖型&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="string">&quot;短袖&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;skus&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;skuName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;黑色 L&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;price&quot;</span><span class="punctuation">:</span> <span class="number">79.00</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;stock&quot;</span><span class="punctuation">:</span> <span class="number">100</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;salesAttributes&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;attributeId&quot;</span><span class="punctuation">:</span> <span class="number">201</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;attributeName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;颜色&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="string">&quot;黑色&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;attributeId&quot;</span><span class="punctuation">:</span> <span class="number">202</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;attributeName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;尺码&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="string">&quot;L&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;skuName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;白色 M&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;price&quot;</span><span class="punctuation">:</span> <span class="number">79.00</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;stock&quot;</span><span class="punctuation">:</span> <span class="number">150</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;salesAttributes&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;attributeId&quot;</span><span class="punctuation">:</span> <span class="number">201</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;attributeName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;颜色&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="string">&quot;白色&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;attributeId&quot;</span><span class="punctuation">:</span> <span class="number">202</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;attributeName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;尺码&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="string">&quot;M&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
</code></pre>
</details> 

<h5 id="虚拟商品"><a href="#虚拟商品" class="headerlink" title="虚拟商品"></a>虚拟商品</h5><details>
<summary>2、虚拟商品流量充值 JSON 数据</summary>
<pre><code class="json">
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;categoryId&quot;</span><span class="punctuation">:</span> <span class="number">1005002</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;spu&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;中国移动流量包充值&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;brandId&quot;</span><span class="punctuation">:</span> <span class="number">3001</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;全国通用流量包充值，按需选择，自动到账&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;basicAttributes&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;attributeId&quot;</span><span class="punctuation">:</span> <span class="number">301</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;attributeName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;运营商&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="string">&quot;中国移动&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;attributeId&quot;</span><span class="punctuation">:</span> <span class="number">302</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;attributeName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;适用网络&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="string">&quot;4G/5G&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;skus&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;skuName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;中国移动1GB全国流量包（7天）&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;price&quot;</span><span class="punctuation">:</span> <span class="number">5.00</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;stock&quot;</span><span class="punctuation">:</span> <span class="number">9999</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;salesAttributes&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;attributeId&quot;</span><span class="punctuation">:</span> <span class="number">401</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;attributeName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;流量容量&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1GB&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;attributeId&quot;</span><span class="punctuation">:</span> <span class="number">402</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;attributeName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;有效期&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="string">&quot;7天&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;attributeId&quot;</span><span class="punctuation">:</span> <span class="number">403</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;attributeName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;流量类型&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="string">&quot;全国通用&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;skuName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;中国移动5GB全国流量包（30天）&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;price&quot;</span><span class="punctuation">:</span> <span class="number">20.00</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;stock&quot;</span><span class="punctuation">:</span> <span class="number">9999</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;salesAttributes&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;attributeId&quot;</span><span class="punctuation">:</span> <span class="number">401</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;attributeName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;流量容量&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="string">&quot;5GB&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;attributeId&quot;</span><span class="punctuation">:</span> <span class="number">402</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;attributeName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;有效期&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="string">&quot;30天&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;attributeId&quot;</span><span class="punctuation">:</span> <span class="number">403</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;attributeName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;流量类型&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="string">&quot;全国通用&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;skuName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;中国移动10GB全国流量包（90天）&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;price&quot;</span><span class="punctuation">:</span> <span class="number">38.00</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;stock&quot;</span><span class="punctuation">:</span> <span class="number">9999</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;salesAttributes&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;attributeId&quot;</span><span class="punctuation">:</span> <span class="number">401</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;attributeName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;流量容量&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="string">&quot;10GB&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;attributeId&quot;</span><span class="punctuation">:</span> <span class="number">402</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;attributeName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;有效期&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="string">&quot;90天&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;attributeId&quot;</span><span class="punctuation">:</span> <span class="number">403</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;attributeName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;流量类型&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="string">&quot;全国通用&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
</code></pre>
</details> 

<h4 id="商品的价格和库存"><a href="#商品的价格和库存" class="headerlink" title="商品的价格和库存"></a>商品的价格和库存</h4><h5 id="方案1-价格和库存直接放在sku表中-（变化小）"><a href="#方案1-价格和库存直接放在sku表中-（变化小）" class="headerlink" title="方案1. 价格和库存直接放在sku表中 （变化小）"></a>方案1. 价格和库存直接放在sku表中 （变化小）</h5><p>在这种方案中，SKU（Stock Keeping Unit） 表包含商品的所有信息，包括价格和库存数量。每个 SKU 记录一个独立的商品实例，它有唯一的标识符，直接关联价格和库存。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> sku_tab (</span><br><span class="line">    sku_id <span class="type">INT</span> <span class="keyword">PRIMARY</span> KEY,             <span class="comment">-- SKU ID</span></span><br><span class="line">    product_id <span class="type">INT</span>,                     <span class="comment">-- 商品ID (外键，指向商品表)</span></span><br><span class="line">    sku_name <span class="type">VARCHAR</span>(<span class="number">255</span>),              <span class="comment">-- SKU 名称</span></span><br><span class="line">    original_price <span class="type">DECIMAL</span>(<span class="number">10</span>, <span class="number">2</span>),      <span class="comment">-- 原始价格</span></span><br><span class="line">    price <span class="type">DECIMAL</span>(<span class="number">10</span>, <span class="number">2</span>),               <span class="comment">-- 销售价格</span></span><br><span class="line">    discount_price <span class="type">DECIMAL</span>(<span class="number">10</span>, <span class="number">2</span>),      <span class="comment">-- 折扣价格（如果有）</span></span><br><span class="line">    stock_quantity <span class="type">INT</span>,                 <span class="comment">-- 库存数量</span></span><br><span class="line">    warehouse_id <span class="type">INT</span>,                   <span class="comment">-- 仓库ID（如果有多个仓库）</span></span><br><span class="line">    created_at <span class="type">TIMESTAMP</span>,               <span class="comment">-- 创建时间</span></span><br><span class="line">    updated_at <span class="type">TIMESTAMP</span>                <span class="comment">-- 更新时间</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>优点：</p>
<ul>
<li>简单：所有信息都集中在一个表中，查询和管理都很方便。</li>
<li>查询效率：查询某个商品的价格和库存不需要多表联接，减少了数据库查询的复杂度。</li>
<li>维护方便：商品的所有信息（包括价格和库存）都在一个地方，减少了冗余数据和数据不一致的可能性。</li>
</ul>
<p>缺点：</p>
<ul>
<li>灵活性差：如果价格和库存的管理策略较复杂（如促销、库存管理、动态定价等），这种方式可能不太适用。修改价格或库存时需要直接更新 SKU 表。</li>
<li>扩展性差：对于一些复杂的定价和库存管理需求（如多层次的定价结构、分仓库管理等），直接放在 SKU 表中可能不够灵活。</li>
</ul>
<p>适用场景：</p>
<ul>
<li>商品种类较少，SKU 数量相对固定且不复杂的场景。</li>
<li>价格和库存变动较少，不涉及复杂的促销或动态定价的场景</li>
</ul>
<h5 id="方案2-价格和库存单独管理（变化大）"><a href="#方案2-价格和库存单独管理（变化大）" class="headerlink" title="方案2. 价格和库存单独管理（变化大）"></a>方案2. 价格和库存单独管理（变化大）</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> price_tab (</span><br><span class="line">    price_id <span class="type">INT</span> <span class="keyword">PRIMARY</span> KEY,         <span class="comment">-- 价格ID</span></span><br><span class="line">    sku_id <span class="type">INT</span>,                       <span class="comment">-- SKU ID (外键)</span></span><br><span class="line">    price <span class="type">DECIMAL</span>(<span class="number">10</span>, <span class="number">2</span>),             <span class="comment">-- 商品价格</span></span><br><span class="line">    discount_price <span class="type">DECIMAL</span>(<span class="number">10</span>, <span class="number">2</span>),    <span class="comment">-- 折扣价格</span></span><br><span class="line">    effective_date <span class="type">TIMESTAMP</span>,         <span class="comment">-- 价格生效时间</span></span><br><span class="line">    expiry_date <span class="type">TIMESTAMP</span>,            <span class="comment">-- 价格失效时间</span></span><br><span class="line">    price_type <span class="type">VARCHAR</span>(<span class="number">50</span>),           <span class="comment">-- 价格类型（如标准价、促销价等）</span></span><br><span class="line">    <span class="keyword">FOREIGN</span> KEY (sku_id) <span class="keyword">REFERENCES</span> ProductSKUs(sku_id)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> inventory_tab (</span><br><span class="line">    inventory_id <span class="type">INT</span> <span class="keyword">PRIMARY</span> KEY,     <span class="comment">-- 库存ID</span></span><br><span class="line">    sku_id <span class="type">INT</span>,                        <span class="comment">-- SKU ID (外键)</span></span><br><span class="line">    quantity <span class="type">INT</span>,                      <span class="comment">-- 库存数量</span></span><br><span class="line">    warehouse_id <span class="type">INT</span>,                  <span class="comment">-- 仓库ID（如果有多个仓库）</span></span><br><span class="line">    updated_at <span class="type">TIMESTAMP</span>,              <span class="comment">-- 库存更新时间</span></span><br><span class="line">    <span class="keyword">FOREIGN</span> KEY (sku_id) <span class="keyword">REFERENCES</span> ProductSKUs(sku_id)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p>优点：</p>
<ul>
<li>灵活性高：价格和库存信息可以独立管理，更容易支持多样化的定价策略、促销活动、库存管理等。</li>
<li>可扩展性强：对于需要频繁更新价格、库存、促销等信息的商品，这种方案更容易扩展和适应变化。例如，可以灵活地增加新的价格策略或库存仓库。</li>
<li>数据结构清晰：避免了价格和库存在 SKU 表中的冗余存储，使得数据结构更清晰。</li>
</ul>
<p>缺点：</p>
<ul>
<li>查询复杂：获取某个商品的价格和库存信息时，需要联接多个表，查询效率可能会降低，尤其是在数据量大时。</li>
<li>管理复杂：需要更多的表和关系，增加了维护成本和系统复杂度。</li>
</ul>
<p>适用场景：</p>
<ul>
<li>商品种类繁多，SKU 数量较大，且需要支持动态定价、促销、库存管理等复杂需求的场景。</li>
<li>需要频繁变动价格或库存的商品，且这些信息与 SKU 无法紧密绑定的场景</li>
</ul>
<h4 id="商品快照-item-snapshots"><a href="#商品快照-item-snapshots" class="headerlink" title="商品快照 item_snapshots"></a>商品快照 item_snapshots</h4><ol>
<li>商品编辑时生成快照:</li>
</ol>
<ul>
<li>每次商品信息（如价格、描述、属性等）发生编辑时，生成一个新的商品快照。</li>
<li>将快照信息存储在 item_snapshots 表中，并生成一个唯一的 snapshot_id。</li>
</ul>
<ol start="2">
<li>订单创建时使用快照:<br>在用户下单时，查找当前商品的最新 snapshot_id。<br>在 order_items 表中记录该 snapshot_id，以确保订单项反映下单时的商品状态<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `snapshot_tab` (</span><br><span class="line">  `snapshot_id` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  `snapshot_type` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>, </span><br><span class="line">  `create_time` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span>,</span><br><span class="line">  `data` text <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `entity_id` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`snapshot_id`),</span><br><span class="line">  KEY `idx_entity_id` (`entity_id`)</span><br><span class="line">) </span><br></pre></td></tr></table></figure></li>
</ol>
<h4 id="用户操作日志"><a href="#用户操作日志" class="headerlink" title="用户操作日志"></a>用户操作日志</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> user_operation_logs (</span><br><span class="line">  log_id <span class="type">INT</span> <span class="keyword">PRIMARY</span> KEY AUTO_INCREMENT,  <span class="comment">-- Unique identifier for each log entry</span></span><br><span class="line">  user_id <span class="type">INT</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>,                   <span class="comment">-- ID of the user who made the edit</span></span><br><span class="line">  entity_id <span class="type">INT</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>,                 <span class="comment">-- ID of the entity being edited</span></span><br><span class="line">  entity_type <span class="type">VARCHAR</span>(<span class="number">50</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,       <span class="comment">-- Type of entity (e.g., SPU, SKU, Price, Stock)</span></span><br><span class="line">  operation_type <span class="type">VARCHAR</span>(<span class="number">50</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,    <span class="comment">-- Type of operation (e.g., CREATE, UPDATE, DELETE)</span></span><br><span class="line">  <span class="type">timestamp</span> <span class="type">TIMESTAMP</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span>,  <span class="comment">-- Time of the operation</span></span><br><span class="line">  details TEXT,                           <span class="comment">-- Additional details about the operation</span></span><br><span class="line">  <span class="keyword">FOREIGN</span> KEY (user_id) <span class="keyword">REFERENCES</span> users(id)  <span class="comment">-- Assuming a users table exists</span></span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4;</span><br></pre></td></tr></table></figure>
<h4 id="商品的统计信息"><a href="#商品的统计信息" class="headerlink" title="商品的统计信息"></a>商品的统计信息</h4><h3 id="缓存的使用"><a href="#缓存的使用" class="headerlink" title="缓存的使用"></a>缓存的使用</h3><h3 id="核心流程"><a href="#核心流程" class="headerlink" title="核心流程"></a>核心流程</h3><h4 id="B端：商品创建和发布的流程"><a href="#B端：商品创建和发布的流程" class="headerlink" title="B端：商品创建和发布的流程"></a>B端：商品创建和发布的流程</h4><ul>
<li>批量上传、批量编辑</li>
<li>单个上传、编辑</li>
<li>审核、发布</li>
<li>OpenAPI，支持外部同步API push 商品</li>
<li>auto-sync，自动同步外部商品</li>
</ul>
<h4 id="C端：商品搜索、商品详情"><a href="#C端：商品搜索、商品详情" class="headerlink" title="C端：商品搜索、商品详情"></a>C端：商品搜索、商品详情</h4><ul>
<li>商品搜索<ul>
<li>elastic search 索引构建。获取商品列表(首页索引)</li>
<li>如何处理商品的SEO优化？<details>
<summary>1、item index</summary>
<pre><code class="json">
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">POST /products/_doc/<span class="number">1</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;product_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;123456&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Wireless Bluetooth Headphones&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;High-quality wireless headphones with noise-cancellation.&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;price&quot;</span><span class="punctuation">:</span> <span class="number">99.99</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;stock&quot;</span><span class="punctuation">:</span> <span class="number">50</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;category&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Electronics&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;brand&quot;</span><span class="punctuation">:</span> <span class="string">&quot;SoundMax&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;sku&quot;</span><span class="punctuation">:</span> <span class="string">&quot;SM-123&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;spu&quot;</span><span class="punctuation">:</span> <span class="string">&quot;SPU-456&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;image_urls&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="string">&quot;http://example.com/images/headphones1.jpg&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="string">&quot;http://example.com/images/headphones2.jpg&quot;</span></span><br><span class="line">  <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;ratings&quot;</span><span class="punctuation">:</span> <span class="number">4.5</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;seller_info&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;seller_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;78910&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;seller_name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;BestSeller&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;attributes&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;color&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Black&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Standard&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;material&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Plastic&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;release_date&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2023-01-15&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;location&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;lat&quot;</span><span class="punctuation">:</span> <span class="number">40.7128</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;lon&quot;</span><span class="punctuation">:</span> <span class="number">-74.0060</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;tags&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;headphones&quot;</span><span class="punctuation">,</span> <span class="string">&quot;bluetooth&quot;</span><span class="punctuation">,</span> <span class="string">&quot;wireless&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;promotional_info&quot;</span><span class="punctuation">:</span> <span class="string">&quot;20% off for a limited time&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
</code></pre>
</details></li>
</ul>
</li>
<li>商品推荐<ul>
<li>商品的A&#x2F;B测试如何设计？</li>
<li>如何设计商品的推荐算法？</li>
<li>商品的个性化定制如何实现？</li>
</ul>
</li>
<li>获取商品详情</li>
</ul>
<h2 id="订单管理-Order-Center"><a href="#订单管理-Order-Center" class="headerlink" title="订单管理 Order Center"></a>订单管理 Order Center</h2><p><a href="https://www.woshipm.com/pd/753646.html">订单系统，平台的”生命中轴线”</a></p>
<h3 id="订单中需要包含哪些信息"><a href="#订单中需要包含哪些信息" class="headerlink" title="订单中需要包含哪些信息"></a>订单中需要包含哪些信息</h3><p align="center">
  <img src="/images/order_content.webp" width=800 height=500>
</p>

<h3 id="常见的订单类型"><a href="#常见的订单类型" class="headerlink" title="常见的订单类型"></a>常见的订单类型</h3><ol>
<li><p>实物订单<br>典型场景：电商平台购物（如买衣服、家电）<br>核心特征：<br>需要物流配送，涉及收货地址、运费、物流跟踪<br>需要库存校验与扣减<br>售后流程（退货、换货、退款）复杂<br>订单状态多（待发货、已发货、已收货等）</p>
</li>
<li><p>虚拟订单<br>典型场景：会员卡、电子券、游戏点卡、电影票等<br>核心特征：<br>无物流配送，不需要收货地址和运费<br>通常无需库存（或库存为虚拟库存）<br>订单完成后直接发放虚拟物品或凭证<br>售后流程简单或无售后</p>
</li>
<li><p>预售订单<br>典型场景：新品预售、定金膨胀、众筹等<br>核心特征：<br>订单分为定金和尾款两阶段<br>需校验定金支付、尾款支付的时效<br>可能涉及定金不退、尾款未付订单自动关闭等规则<br>发货时间通常在尾款支付后</p>
</li>
<li><p>O2O订单，外卖订单<br>典型场景：酒店预订<br>核心特征：<br>需选择入住&#x2F;离店日期、房型、入住人信息<br>需对接第三方酒店系统实时查房、锁房<br>取消、变更政策复杂，可能涉及违约金<br>无物流，但有电子凭证或入住确认</p>
</li>
</ol>
<h3 id="订单系统的演进"><a href="#订单系统的演进" class="headerlink" title="订单系统的演进"></a>订单系统的演进</h3><table>
<thead>
<tr>
<th>阶段</th>
<th>主要特征&#x2F;能力</th>
<th>技术架构&#x2F;数据模型</th>
<th>适用场景&#x2F;目标</th>
<th>实现方式简单说明</th>
</tr>
</thead>
<tbody><tr>
<td>初始阶段</td>
<td>- 实现订单基本流转（下单、支付、发货、收货、取消）<br>- 单一订单类型（实物订单）<br>- 订单与商品、用户简单关联</td>
<td>单体应用&#x2F;单表或少量表结构</td>
<td>业务初期，订单量小，流程简单，SKU&#x2F;商家数量有限</td>
<td>单体应用，单表存储，简单业务逻辑，直接数据库操作</td>
</tr>
<tr>
<td>成长阶段（订单中心）</td>
<td>- 支持订单拆单、合单（如多仓发货、合并支付）<br>- 支持多品类订单（如实物+虚拟）<br>- 订单中心化，订单与支付、配送、售后等子系统解耦<br>- 订单与商品快照、操作日志关联</td>
<td>微服务&#x2F;多表&#x2F;订单中心架构</td>
<td>平台型电商，业务扩展，需支持多商家、多类型订单，订单量大幅增长</td>
<td>订单中心服务，微服务拆分，多表关联，服务间接口调用，快照与日志表设计</td>
</tr>
<tr>
<td>成熟期（平台化）</td>
<td>- 支持多样化订单类型（预售、虚拟、O2O、定制、JIT等）<br>- 订单流程可配置&#x2F;插件化&#x2F;工作流引擎&#x2F;状态机框架&#x2F;规则引擎等<br>- 订单状态机、履约、支付、退款等子流程解耦<br>- 支持复杂的促销、分账、履约模式</td>
<td>分布式&#x2F;服务化&#x2F;灵活数据模型</td>
<td>大型&#x2F;综合电商，业务复杂，需快速适应新业务模式和高并发场景</td>
<td>分布式服务，插件化&#x2F;配置化流程，状态机驱动，异步消息，灵活数据模型</td>
</tr>
<tr>
<td>未来智能化</td>
<td>- 订单智能路由与分配（如智能分仓、智能客服）<br>- 实时风控与反欺诈<br>- 订单数据实时分析与洞察<br>- 高可用、弹性伸缩、自动化运维</td>
<td>云原生&#x2F;大数据&#x2F;AI驱动架构</td>
<td>超大规模平台，国际化、智能化、数据驱动，需极致稳定与创新能力</td>
<td>云原生架构，AI&#x2F;大数据分析，自动化运维，弹性伸缩，智能路由与风控</td>
</tr>
</tbody></table>
<h3 id="常见的订单模型设计"><a href="#常见的订单模型设计" class="headerlink" title="常见的订单模型设计"></a>常见的订单模型设计</h3><p align="center">
  <img src="/images/order_er.png" width=800 height=600>
</p>

<h4 id="订单表（order-tab）：记录用户的购买订单信息。主键为-order-id。"><a href="#订单表（order-tab）：记录用户的购买订单信息。主键为-order-id。" class="headerlink" title="订单表（order_tab）：记录用户的购买订单信息。主键为 order_id。"></a>订单表（order_tab）：记录用户的购买订单信息。主键为 order_id。</h4><ul>
<li>pay_order_id：支付订单ID，作为外键关联支付订单。</li>
<li>user_id：用户ID，标识购买订单的用户。</li>
<li>total_amount：订单的总金额。</li>
<li>order_status：订单状态，如已完成、已取消等。</li>
<li>payment_status：支付状态，与支付订单相关。</li>
<li>fulfillment_status：履约状态，表示订单的配送或服务状态。</li>
<li>refund_status：退款状态，用于标识订单是否有退款</li>
</ul>
<h4 id="订单商品表（order-item-tab：记录订单中具体商品的信息。主键为-order-item-id。"><a href="#订单商品表（order-item-tab：记录订单中具体商品的信息。主键为-order-item-id。" class="headerlink" title="订单商品表（order_item_tab：记录订单中具体商品的信息。主键为 order_item_id。"></a>订单商品表（order_item_tab：记录订单中具体商品的信息。主键为 order_item_id。</h4><ul>
<li>order_id：订单ID，作为外键关联订单。</li>
<li>item_id：商品ID，表示订单中的商品。</li>
<li>item_snapshot_id：商品快照ID，记录当时购买时的商品信息快照。</li>
<li>item_status：商品状态，如已发货、退货等。</li>
<li>quantity：购买数量。</li>
<li>price：商品单价。</li>
<li>discount：商品折扣金额</li>
</ul>
<h4 id="订单支付表（pay-order-tab）：主要用于记录用户的支付信息。主键为-pay-order-id，标识唯一的支付订单。"><a href="#订单支付表（pay-order-tab）：主要用于记录用户的支付信息。主键为-pay-order-id，标识唯一的支付订单。" class="headerlink" title="订单支付表（pay_order_tab）：主要用于记录用户的支付信息。主键为 pay_order_id，标识唯一的支付订单。"></a>订单支付表（pay_order_tab）：主要用于记录用户的支付信息。主键为 pay_order_id，标识唯一的支付订单。</h4><ul>
<li>user_id：用户ID，标识支付的用户。</li>
<li>payment_method：支付方式，如信用卡、支付宝等。</li>
<li>payment_status：支付状态，如已支付、未支付等。</li>
<li>pay_amount、cash_amount、coin_amount、voucher_amount：支付金额、现金支付金额、代币支付金额、优惠券使用金额。</li>
<li>时间戳字段包括创建时间、初始化时间和更新时间</li>
</ul>
<h4 id="退款表（refund-tab）：记录订单或订单项的退款信息。主键为-refund-id。"><a href="#退款表（refund-tab）：记录订单或订单项的退款信息。主键为-refund-id。" class="headerlink" title="退款表（refund_tab）：记录订单或订单项的退款信息。主键为 refund_id。"></a>退款表（refund_tab）：记录订单或订单项的退款信息。主键为 refund_id。</h4><ul>
<li>order_id：订单ID，作为外键关联订单。</li>
<li>order_item_id：订单项ID，标识具体商品的退款。</li>
<li>refund_amount：退款金额。</li>
<li>reason：退款原因。</li>
<li>quantity：退款的商品数量。</li>
<li>refund_status：退款状态。</li>
<li>refund_time：退款操作时间。</li>
</ul>
<h4 id="实体间关系："><a href="#实体间关系：" class="headerlink" title="实体间关系："></a>实体间关系：</h4><ul>
<li>支付订单与订单：</li>
<li>一个支付订单可能关联多个购买订单，形成 一对多 关系。<br>例如，用户可以通过一次支付购买多个不同的订单。</li>
<li>订单与订单商品：<br>一个订单可以包含多个订单项，形成 一对多 关系。<br>订单项代表订单中所购买的每个商品的详细信息。</li>
<li>订单与退款：<ul>
<li>一个订单可能包含多个退款，形成 一对多 关系。</li>
<li>退款可以是针对订单整体，也可以针对订单中的某个商品</li>
</ul>
</li>
</ul>
<h3 id="订单状态机设计"><a href="#订单状态机设计" class="headerlink" title="订单状态机设计"></a>订单状态机设计</h3><h4 id="Order-主状态机"><a href="#Order-主状态机" class="headerlink" title="Order 主状态机"></a>Order 主状态机</h4><p align="center">
  <img src="/images/order_status.png" width=500 height=450>
</p>


<h4 id="支付状态机"><a href="#支付状态机" class="headerlink" title="支付状态机"></a>支付状态机</h4><p align="center">
  <img src="/images/pay_status.png" width=700 height=400>
</p>


<h4 id="履约状态机"><a href="#履约状态机" class="headerlink" title="履约状态机"></a>履约状态机</h4><p align="center">
  <img src="/images/fulfillment_status.png" width=500 height=400>
</p>

<h4 id="退货退款状体机"><a href="#退货退款状体机" class="headerlink" title="退货退款状体机"></a>退货退款状体机</h4><p align="center">
  <img src="/images/refund_status.png" width=700 height=1100>
</p>


<h4 id="异常单人工介入"><a href="#异常单人工介入" class="headerlink" title="异常单人工介入"></a>异常单人工介入</h4><ul>
<li>用户发起退款单拒绝</li>
<li>退货失败，订单状态无法流转</li>
<li>退款失败</li>
<li>退营销失败</li>
</ul>
<h3 id="订单ID-生成策略"><a href="#订单ID-生成策略" class="headerlink" title="订单ID 生成策略"></a>订单ID 生成策略</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line">  <span class="comment"># 时间戳 + 机器id + uid % 1000 + 自增序号</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Union</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">OrderNoGenerator</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, machine_id: <span class="built_in">int</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        初始化订单号生成器</span></span><br><span class="line"><span class="string">        :param machine_id: 机器ID (0-999)</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="number">0</span> &lt;= machine_id &lt;= <span class="number">999</span>:</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">&quot;机器ID必须在0-999之间&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        self.machine_id = machine_id</span><br><span class="line">        self.sequence = <span class="number">0</span></span><br><span class="line">        self.last_timestamp = -<span class="number">1</span></span><br><span class="line">        self.lock = threading.Lock()  <span class="comment"># 线程锁，保证线程安全</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_wait_next_second</span>(<span class="params">self, last_timestamp: <span class="built_in">int</span></span>) -&gt; <span class="built_in">int</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        等待下一秒</span></span><br><span class="line"><span class="string">        :param last_timestamp: 上次时间戳</span></span><br><span class="line"><span class="string">        :return: 新的时间戳</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        timestamp = <span class="built_in">int</span>(time.time())</span><br><span class="line">        <span class="keyword">while</span> timestamp &lt;= last_timestamp:</span><br><span class="line">            timestamp = <span class="built_in">int</span>(time.time())</span><br><span class="line">        <span class="keyword">return</span> timestamp</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">generate_order_no</span>(<span class="params">self, user_id: <span class="built_in">int</span></span>) -&gt; <span class="type">Union</span>[<span class="built_in">int</span>, <span class="built_in">str</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        生成订单号</span></span><br><span class="line"><span class="string">        :param user_id: 用户ID</span></span><br><span class="line"><span class="string">        :return: 订单号（整数或字符串形式）</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">with</span> self.lock:  <span class="comment"># 使用线程锁保证线程安全</span></span><br><span class="line">            <span class="comment"># 获取当前时间戳（秒级）</span></span><br><span class="line">            timestamp = <span class="built_in">int</span>(time.time())</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 处理时间回拨</span></span><br><span class="line">            <span class="keyword">if</span> timestamp &lt; self.last_timestamp:</span><br><span class="line">                <span class="keyword">raise</span> RuntimeError(<span class="string">&quot;系统时间回拨，拒绝生成订单号&quot;</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 如果是同一秒，序列号自增</span></span><br><span class="line">            <span class="keyword">if</span> timestamp == self.last_timestamp:</span><br><span class="line">                self.sequence = (self.sequence + <span class="number">1</span>) % <span class="number">1000</span></span><br><span class="line">                <span class="comment"># 如果序列号用完了，等待下一秒</span></span><br><span class="line">                <span class="keyword">if</span> self.sequence == <span class="number">0</span>:</span><br><span class="line">                    timestamp = self._wait_next_second(self.last_timestamp)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="comment"># 不同秒，序列号重置</span></span><br><span class="line">                self.sequence = <span class="number">0</span></span><br><span class="line">            </span><br><span class="line">            self.last_timestamp = timestamp</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 获取用户ID的后3位</span></span><br><span class="line">            user_id_suffix = user_id % <span class="number">1000</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 组装订单号</span></span><br><span class="line">            order_no = (timestamp * <span class="number">1000000000</span> +  <span class="comment"># 时间戳左移9位</span></span><br><span class="line">                       self.machine_id * <span class="number">1000000</span> +  <span class="comment"># 机器ID左移6位</span></span><br><span class="line">                       user_id_suffix * <span class="number">1000</span> +      <span class="comment"># 用户ID左移3位</span></span><br><span class="line">                       self.sequence)               <span class="comment"># 序列号</span></span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> order_no</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">generate_order_no_str</span>(<span class="params">self, user_id: <span class="built_in">int</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        生成字符串形式的订单号</span></span><br><span class="line"><span class="string">        :param user_id: 用户ID</span></span><br><span class="line"><span class="string">        :return: 字符串形式的订单号</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        order_no = self.generate_order_no(user_id)</span><br><span class="line">        <span class="keyword">return</span> <span class="string">f&quot;<span class="subst">&#123;order_no:019d&#125;</span>&quot;</span>  <span class="comment"># 补零到19位</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用示例</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    <span class="comment"># 创建订单号生成器实例</span></span><br><span class="line">    generator = OrderNoGenerator(machine_id=<span class="number">1</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 生成订单号</span></span><br><span class="line">    user_id = <span class="number">12345</span></span><br><span class="line">    order_no = generator.generate_order_no(user_id)</span><br><span class="line">    order_no_str = generator.generate_order_no_str(user_id)</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;整数形式订单号: <span class="subst">&#123;order_no&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;字符串形式订单号: <span class="subst">&#123;order_no_str&#125;</span>&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 测试并发</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">test_concurrent</span>():</span><br><span class="line">        <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>):</span><br><span class="line">            order_no = generator.generate_order_no(user_id)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;并发生成的订单号: <span class="subst">&#123;order_no&#125;</span>&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 创建多个线程测试并发</span></span><br><span class="line">    threads = []</span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):</span><br><span class="line">        t = threading.Thread(target=test_concurrent)</span><br><span class="line">        threads.append(t)</span><br><span class="line">        t.start()</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 等待所有线程完成</span></span><br><span class="line">    <span class="keyword">for</span> t <span class="keyword">in</span> threads:</span><br><span class="line">        t.join()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>

<h3 id="订单商品快照"><a href="#订单商品快照" class="headerlink" title="订单商品快照"></a>订单商品快照</h3><h4 id="方案1-直接使用商品系统的item-snapshot。（由商品系统维护快照）"><a href="#方案1-直接使用商品系统的item-snapshot。（由商品系统维护快照）" class="headerlink" title="方案1. 直接使用商品系统的item snapshot。（由商品系统维护快照）"></a>方案1. 直接使用商品系统的item snapshot。（由商品系统维护快照）</h4><ul>
<li>商品系统负责维护商品快照</li>
<li>订单系统通过引用商品快照ID来关联商品信息</li>
<li>商品信息变更时，商品系统生成新的快照版本<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 商品系统维护的快照表</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> item_snapshot_tab (</span><br><span class="line">    snapshot_id <span class="type">BIGINT</span> <span class="keyword">PRIMARY</span> KEY,</span><br><span class="line">    item_id <span class="type">BIGINT</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    version <span class="type">INT</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    data JSON <span class="keyword">NOT</span> <span class="keyword">NULL</span>,  <span class="comment">-- 存储商品完整信息</span></span><br><span class="line">    created_at <span class="type">TIMESTAMP</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    INDEX idx_item_version (item_id, version)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 订单系统引用快照</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> order_item_tab (</span><br><span class="line">    order_id <span class="type">BIGINT</span>,</span><br><span class="line">    item_id <span class="type">BIGINT</span>,</span><br><span class="line">    snapshot_id <span class="type">BIGINT</span>,  <span class="comment">-- 引用商品快照</span></span><br><span class="line">    quantity <span class="type">INT</span>,</span><br><span class="line">    price <span class="type">DECIMAL</span>(<span class="number">10</span>,<span class="number">2</span>),</span><br><span class="line">    <span class="keyword">FOREIGN</span> KEY (snapshot_id) <span class="keyword">REFERENCES</span> item_snapshot(snapshot_id)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
优点</li>
<li>数据一致性高：商品系统统一管理快照，避免数据不一致</li>
<li>存储效率高：多个订单可以共享同一个快照版本</li>
<li>维护成本低：订单系统不需要关心快照的生成和管理</li>
<li>查询性能好：可以直接通过快照ID获取完整商品信息</li>
</ul>
<p>缺点</p>
<ul>
<li>系统耦合度高：订单系统强依赖商品系统的快照服务</li>
<li>扩展性受限：商品系统需要支持所有订单系统可能需要的商品信息</li>
<li>版本管理复杂：需要处理快照的版本控制和清理</li>
<li>跨系统调用：订单系统需要调用商品系统获取快照信息</li>
</ul>
<h4 id="方案2-创单时提供商品详情信息。（由订单维护商品快照"><a href="#方案2-创单时提供商品详情信息。（由订单维护商品快照" class="headerlink" title="方案2. 创单时提供商品详情信息。（由订单维护商品快照)"></a>方案2. 创单时提供商品详情信息。（由订单维护商品快照)</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> order_item (</span><br><span class="line">    order_id <span class="type">BIGINT</span>,</span><br><span class="line">    item_id <span class="type">BIGINT</span>,</span><br><span class="line">    quantity <span class="type">INT</span>,</span><br><span class="line">    price <span class="type">DECIMAL</span>(<span class="number">10</span>,<span class="number">2</span>),</span><br><span class="line">    snapshot_data JSON <span class="keyword">NOT</span> <span class="keyword">NULL</span>,  <span class="comment">-- 存储下单时的商品信息</span></span><br><span class="line">    <span class="keyword">FOREIGN</span> KEY (order_id, item_id) <span class="keyword">REFERENCES</span> order_item_snapshot(order_id, item_id)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<h4 id="方案3-创单时提供商品详情信息。（由订单维护商品快照）-快照复用"><a href="#方案3-创单时提供商品详情信息。（由订单维护商品快照）-快照复用" class="headerlink" title="方案3. 创单时提供商品详情信息。（由订单维护商品快照）+ 快照复用"></a>方案3. 创单时提供商品详情信息。（由订单维护商品快照）+ 快照复用</h4><p>设计思路：</p>
<ul>
<li>订单系统维护自己的快照表，但增加快照复用机制</li>
<li>使用商品信息的摘要(摘要算法如MD5)作为快照的唯一标识</li>
<li>相同摘要的商品信息共享同一个快照记录</li>
<li>创单时先检查摘要是否存在，存在则复用，不存在则创建新快照</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 订单系统维护的快照表</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> order_item_snapshot (</span><br><span class="line">    snapshot_id <span class="type">BIGINT</span> <span class="keyword">PRIMARY</span> KEY,</span><br><span class="line">    item_id <span class="type">BIGINT</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    item_hash <span class="type">VARCHAR</span>(<span class="number">32</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;商品信息摘要&#x27;</span>,</span><br><span class="line">    snapshot_data JSON <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;存储下单时的商品信息&#x27;</span>,</span><br><span class="line">    created_at <span class="type">TIMESTAMP</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    INDEX idx_item_hash (item_hash),</span><br><span class="line">    INDEX idx_item_id (item_id)</span><br><span class="line">);</span><br><span class="line"><span class="comment">-- 订单商品表</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> order_item (</span><br><span class="line">    order_id <span class="type">BIGINT</span>,</span><br><span class="line">    item_id <span class="type">BIGINT</span>,</span><br><span class="line">    snapshot_id <span class="type">BIGINT</span>,</span><br><span class="line">    quantity <span class="type">INT</span>,</span><br><span class="line">    price <span class="type">DECIMAL</span>(<span class="number">10</span>,<span class="number">2</span>),</span><br><span class="line">    <span class="keyword">FOREIGN</span> KEY (snapshot_id) <span class="keyword">REFERENCES</span> order_item_snapshot(snapshot_id)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p>适用场景：</p>
<ul>
<li>商品模型比较固定，项目初期，团队比较小，能接受系统之间的耦合，可以考虑用1</li>
<li>不同商品差异比较大，商品信息结构复杂，考虑用2</li>
<li>订单量太大，考虑复用快照</li>
</ul>
<h3 id="核心流程-1"><a href="#核心流程-1" class="headerlink" title="核心流程"></a>核心流程</h3><h4 id="正常流程和逆向流程"><a href="#正常流程和逆向流程" class="headerlink" title="正常流程和逆向流程"></a>正常流程和逆向流程</h4><h4 id="创单"><a href="#创单" class="headerlink" title="创单"></a>创单</h4><h5 id="核心步骤"><a href="#核心步骤" class="headerlink" title="核心步骤"></a>核心步骤</h5><ol>
<li>参数校验。用户校验，是否异常用户。</li>
<li>商品与价格校验。校验商品是否存在、是否上架、价格是否有效</li>
<li>库存校验与预占。检查库存是否充足，部分场景下进行库存预占（锁库存）。</li>
<li>营销信息校验。校验优惠券、积分等是否可用，计算优惠金额。</li>
<li>订单金额计算。计算订单总金额、应付金额、各项明细。</li>
<li>生成订单号。生成全局唯一订单号，保证幂等性。</li>
<li>订单数据落库。写入订单主表、订单明细表、扩展表等。</li>
<li>扣减库存、扣减实际库存（有的系统在支付后扣减）。</li>
<li>发送消息&#x2F;异步处理。发送订单创建成功消息，通知库存、物流、营销等系统。</li>
<li>返回下单结果。返回订单号、支付信息等给前端。</li>
</ol>
<h5 id="实现思路"><a href="#实现思路" class="headerlink" title="实现思路"></a>实现思路</h5><ul>
<li>接口定义：通过OrderCreationStep接口定义了每个步骤必须实现的方法</li>
<li>上下文共享：使用OrderCreationContext在步骤间共享数据</li>
<li>步骤独立：每个步骤都是独立的，便于维护和测试</li>
<li>回滚机制：每个步骤都实现了回滚方法</li>
<li>流程管理：通过OrderCreationManager统一管理步骤的执行和回滚</li>
<li>错误处理：统一的错误处理和回滚机制</li>
<li>可扩展性：易于添加新的步骤或修改现有步骤</li>
<li>如何解决不同category 创单差异较大的问题？<ul>
<li>插件化&#x2F;策略模式。将订单处理流程拆分为多个步骤（如校验、支付、通知等）。不同订单类型实现各自的处理逻辑，通过策略模式动态选择。</li>
</ul>
<ol start="2">
<li>订单类型标识。在订单主表中增加订单类型字段，根据类型选择不同的处理流程。</li>
<li>扩展字段。使用JSON或扩展表存储特定订单类型的特殊字段（如酒店的入住日期、机票的航班信息）。</li>
<li>流程引擎。使用流程引擎（如BPMN）定义和管理复杂的订单处理流程，支持动态调整。</li>
</ol>
</li>
</ul>
<details>
<summary>点击查看创单核心逻辑代码实现</summary>
<pre><code class="go">

<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> order</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;context&quot;</span></span><br><span class="line">	<span class="string">&quot;encoding/json&quot;</span></span><br><span class="line">	<span class="string">&quot;errors&quot;</span></span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">	<span class="string">&quot;log&quot;</span></span><br><span class="line">	<span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// OrderType 订单类型</span></span><br><span class="line"><span class="keyword">type</span> OrderType <span class="type">string</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> (</span><br><span class="line">	OrderTypePhysical OrderType = <span class="string">&quot;physical&quot;</span> <span class="comment">// 实物订单</span></span><br><span class="line">	OrderTypeVirtual  OrderType = <span class="string">&quot;virtual&quot;</span>  <span class="comment">// 虚拟订单</span></span><br><span class="line">	OrderTypePresale  OrderType = <span class="string">&quot;presale&quot;</span>  <span class="comment">// 预售订单</span></span><br><span class="line">	OrderTypeHotel    OrderType = <span class="string">&quot;hotel&quot;</span>    <span class="comment">// 酒店订单</span></span><br><span class="line">	OrderTypeTopUp    OrderType = <span class="string">&quot;topup&quot;</span>    <span class="comment">// 充值订单</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// OrderStatus 订单状态</span></span><br><span class="line"><span class="keyword">type</span> OrderStatus <span class="type">string</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> (</span><br><span class="line">	OrderStatusInit     OrderStatus = <span class="string">&quot;init&quot;</span>     <span class="comment">// 初始化</span></span><br><span class="line">	OrderStatusPending  OrderStatus = <span class="string">&quot;pending&quot;</span>  <span class="comment">// 待支付</span></span><br><span class="line">	OrderStatusPaid     OrderStatus = <span class="string">&quot;paid&quot;</span>     <span class="comment">// 已支付</span></span><br><span class="line">	OrderStatusShipping OrderStatus = <span class="string">&quot;shipping&quot;</span> <span class="comment">// 发货中</span></span><br><span class="line">	OrderStatusSuccess  OrderStatus = <span class="string">&quot;success&quot;</span>  <span class="comment">// 成功</span></span><br><span class="line">	OrderStatusFailed   OrderStatus = <span class="string">&quot;failed&quot;</span>   <span class="comment">// 失败</span></span><br><span class="line">	OrderStatusCanceled OrderStatus = <span class="string">&quot;canceled&quot;</span> <span class="comment">// 已取消</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Order 订单基础信息</span></span><br><span class="line"><span class="keyword">type</span> Order <span class="keyword">struct</span> &#123;</span><br><span class="line">	ID        <span class="type">string</span>          <span class="string">`json:&quot;id&quot;`</span></span><br><span class="line">	UserID    <span class="type">string</span>          <span class="string">`json:&quot;user_id&quot;`</span></span><br><span class="line">	Type      OrderType       <span class="string">`json:&quot;type&quot;`</span></span><br><span class="line">	Status    OrderStatus     <span class="string">`json:&quot;status&quot;`</span></span><br><span class="line">	Amount    <span class="type">float64</span>         <span class="string">`json:&quot;amount&quot;`</span></span><br><span class="line">	Detail    json.RawMessage <span class="string">`json:&quot;detail&quot;`</span> <span class="comment">// 不同类型订单的特殊字段</span></span><br><span class="line">	CreatedAt time.Time       <span class="string">`json:&quot;created_at&quot;`</span></span><br><span class="line">	UpdatedAt time.Time       <span class="string">`json:&quot;updated_at&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// OrderCreationContext 创单上下文</span></span><br><span class="line"><span class="keyword">type</span> OrderCreationContext <span class="keyword">struct</span> &#123;</span><br><span class="line">	Ctx                 context.Context</span><br><span class="line">	Order               *Order</span><br><span class="line">	Params              <span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125; <span class="comment">// 创单参数</span></span><br><span class="line">	Cache               <span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125; <span class="comment">// 步骤间共享数据</span></span><br><span class="line">	Errors              []<span class="type">error</span>                <span class="comment">// 错误记录</span></span><br><span class="line">	StepResults         <span class="keyword">map</span>[<span class="type">string</span>]StepResult  <span class="comment">// 每个步骤的执行结果</span></span><br><span class="line">	RollbackFailedSteps []<span class="type">string</span>               <span class="comment">// 记录回滚失败的步骤</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// StepResult 步骤执行结果</span></span><br><span class="line"><span class="keyword">type</span> StepResult <span class="keyword">struct</span> &#123;</span><br><span class="line">	Success        <span class="type">bool</span></span><br><span class="line">	Error          <span class="type">error</span></span><br><span class="line">	Data           <span class="keyword">interface</span>&#123;&#125;</span><br><span class="line">	CompensateData <span class="keyword">interface</span>&#123;&#125; <span class="comment">// 用于补偿的数据</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// OrderCreationStep 创单步骤接口</span></span><br><span class="line"><span class="keyword">type</span> OrderCreationStep <span class="keyword">interface</span> &#123;</span><br><span class="line">	Execute(ctx *OrderCreationContext) <span class="type">error</span></span><br><span class="line">	Rollback(ctx *OrderCreationContext) <span class="type">error</span></span><br><span class="line">	Compensate(ctx *OrderCreationContext) <span class="type">error</span> <span class="comment">// 异步补偿</span></span><br><span class="line">	Name() <span class="type">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 错误定义</span></span><br><span class="line"><span class="keyword">var</span> (</span><br><span class="line">	ErrInvalidParams     = errors.New(<span class="string">&quot;invalid parameters&quot;</span>)</span><br><span class="line">	ErrProductNotFound   = errors.New(<span class="string">&quot;product not found&quot;</span>)</span><br><span class="line">	ErrProductOffline    = errors.New(<span class="string">&quot;product is offline&quot;</span>)</span><br><span class="line">	ErrStockInsufficient = errors.New(<span class="string">&quot;stock insufficient&quot;</span>)</span><br><span class="line">	ErrUserBlocked       = errors.New(<span class="string">&quot;user is blocked&quot;</span>)</span><br><span class="line">	ErrSystemBusy        = errors.New(<span class="string">&quot;system is busy&quot;</span>)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// OrderError 订单错误</span></span><br><span class="line"><span class="keyword">type</span> OrderError <span class="keyword">struct</span> &#123;</span><br><span class="line">	Step    <span class="type">string</span></span><br><span class="line">	Message <span class="type">string</span></span><br><span class="line">	Err     <span class="type">error</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(e *OrderError)</span></span> Error() <span class="type">string</span> &#123;</span><br><span class="line">	<span class="keyword">return</span> fmt.Sprintf(<span class="string">&quot;step: %s, message: %s, error: %v&quot;</span>, e.Step, e.Message, e.Err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 参数校验步骤</span></span><br><span class="line"><span class="keyword">type</span> ParamValidationStep <span class="keyword">struct</span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *ParamValidationStep)</span></span> Execute(ctx *OrderCreationContext) <span class="type">error</span> &#123;</span><br><span class="line">	<span class="comment">// 通用参数校验</span></span><br><span class="line">	<span class="keyword">if</span> ctx.Order.UserID == <span class="string">&quot;&quot;</span> || ctx.Order.Type == <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> &amp;OrderError&#123;Step: s.Name(), Message: <span class="string">&quot;missing required fields&quot;</span>, Err: ErrInvalidParams&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 订单类型特殊参数校验</span></span><br><span class="line">	<span class="keyword">switch</span> ctx.Order.Type &#123;</span><br><span class="line">	<span class="keyword">case</span> OrderTypePhysical:</span><br><span class="line">		<span class="keyword">if</span> addr, ok := ctx.Params[<span class="string">&quot;address&quot;</span>].(<span class="type">string</span>); !ok || addr == <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> &amp;OrderError&#123;Step: s.Name(), Message: <span class="string">&quot;missing address for physical order&quot;</span>, Err: ErrInvalidParams&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	<span class="keyword">case</span> OrderTypeHotel:</span><br><span class="line">		<span class="keyword">if</span> _, ok := ctx.Params[<span class="string">&quot;check_in_date&quot;</span>].(time.Time); !ok &#123;</span><br><span class="line">			<span class="keyword">return</span> &amp;OrderError&#123;Step: s.Name(), Message: <span class="string">&quot;missing check-in date for hotel order&quot;</span>, Err: ErrInvalidParams&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *ParamValidationStep)</span></span> Rollback(ctx *OrderCreationContext) <span class="type">error</span> &#123;</span><br><span class="line">	<span class="comment">// 参数校验步骤无需回滚</span></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *ParamValidationStep)</span></span> Compensate(ctx *OrderCreationContext) <span class="type">error</span> &#123;</span><br><span class="line">	<span class="comment">// 参数校验步骤无需补偿</span></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *ParamValidationStep)</span></span> Name() <span class="type">string</span> &#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="string">&quot;param_validation&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Product 商品信息</span></span><br><span class="line"><span class="keyword">type</span> Product <span class="keyword">struct</span> &#123;</span><br><span class="line">	ID       <span class="type">string</span></span><br><span class="line">	Name     <span class="type">string</span></span><br><span class="line">	Price    <span class="type">float64</span></span><br><span class="line">	IsOnSale <span class="type">bool</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ProductService 商品服务接口</span></span><br><span class="line"><span class="keyword">type</span> ProductService <span class="keyword">interface</span> &#123;</span><br><span class="line">	GetProduct(ctx context.Context, productID <span class="type">string</span>) (*Product, <span class="type">error</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// StockService 库存服务接口</span></span><br><span class="line"><span class="keyword">type</span> StockService <span class="keyword">interface</span> &#123;</span><br><span class="line">	LockStock(ctx context.Context, productID <span class="type">string</span>, quantity <span class="type">int</span>) (<span class="type">string</span>, <span class="type">error</span>)</span><br><span class="line">	UnlockStock(ctx context.Context, lockID <span class="type">string</span>) <span class="type">error</span></span><br><span class="line">	DeductStock(ctx context.Context, productID <span class="type">string</span>, quantity <span class="type">int</span>) <span class="type">error</span></span><br><span class="line">	RevertDeductStock(ctx context.Context, productID <span class="type">string</span>, quantity <span class="type">int</span>) <span class="type">error</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// PromotionService 营销服务接口</span></span><br><span class="line"><span class="keyword">type</span> PromotionService <span class="keyword">interface</span> &#123;</span><br><span class="line">	ValidateCoupon(ctx context.Context, couponCode <span class="type">string</span>, userID <span class="type">string</span>, orderAmount <span class="type">float64</span>) (*Coupon, <span class="type">error</span>)</span><br><span class="line">	UseCoupon(ctx context.Context, couponCode <span class="type">string</span>, userID <span class="type">string</span>, orderID <span class="type">string</span>) <span class="type">error</span></span><br><span class="line">	RevertCouponUsage(ctx context.Context, couponCode <span class="type">string</span>, userID <span class="type">string</span>, orderID <span class="type">string</span>) <span class="type">error</span></span><br><span class="line">	DeductPoints(ctx context.Context, userID <span class="type">string</span>, points <span class="type">int</span>) <span class="type">error</span></span><br><span class="line">	RevertPointsDeduction(ctx context.Context, userID <span class="type">string</span>, points <span class="type">int</span>) <span class="type">error</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Coupon 优惠券信息</span></span><br><span class="line"><span class="keyword">type</span> Coupon <span class="keyword">struct</span> &#123;</span><br><span class="line">	Code       <span class="type">string</span></span><br><span class="line">	Type       <span class="type">string</span></span><br><span class="line">	Amount     <span class="type">float64</span></span><br><span class="line">	Threshold  <span class="type">float64</span></span><br><span class="line">	ExpireTime time.Time</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 商品校验步骤</span></span><br><span class="line"><span class="keyword">type</span> ProductValidationStep <span class="keyword">struct</span> &#123;</span><br><span class="line">	productService ProductService</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *ProductValidationStep)</span></span> Execute(ctx *OrderCreationContext) <span class="type">error</span> &#123;</span><br><span class="line">	productID := ctx.Params[<span class="string">&quot;product_id&quot;</span>].(<span class="type">string</span>)</span><br><span class="line">	product, err := s.productService.GetProduct(ctx.Ctx, productID)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> &amp;OrderError&#123;Step: s.Name(), Message: <span class="string">&quot;failed to get product&quot;</span>, Err: err&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> !product.IsOnSale &#123;</span><br><span class="line">		<span class="keyword">return</span> &amp;OrderError&#123;Step: s.Name(), Message: <span class="string">&quot;product is offline&quot;</span>, Err: ErrProductOffline&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	ctx.Cache[<span class="string">&quot;product&quot;</span>] = product</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *ProductValidationStep)</span></span> Rollback(ctx *OrderCreationContext) <span class="type">error</span> &#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *ProductValidationStep)</span></span> Compensate(ctx *OrderCreationContext) <span class="type">error</span> &#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *ProductValidationStep)</span></span> Name() <span class="type">string</span> &#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="string">&quot;product_validation&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 库存校验步骤</span></span><br><span class="line"><span class="keyword">type</span> StockValidationStep <span class="keyword">struct</span> &#123;</span><br><span class="line">	stockService StockService</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *StockValidationStep)</span></span> Execute(ctx *OrderCreationContext) <span class="type">error</span> &#123;</span><br><span class="line">	<span class="keyword">if</span> ctx.Order.Type == OrderTypeVirtual || ctx.Order.Type == OrderTypeTopUp &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	productID := ctx.Params[<span class="string">&quot;product_id&quot;</span>].(<span class="type">string</span>)</span><br><span class="line">	quantity := ctx.Params[<span class="string">&quot;quantity&quot;</span>].(<span class="type">int</span>)</span><br><span class="line"></span><br><span class="line">	lockID, err := s.stockService.LockStock(ctx.Ctx, productID, quantity)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> &amp;OrderError&#123;Step: s.Name(), Message: <span class="string">&quot;failed to lock stock&quot;</span>, Err: err&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	ctx.Cache[<span class="string">&quot;stock_lock_id&quot;</span>] = lockID</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *StockValidationStep)</span></span> Rollback(ctx *OrderCreationContext) <span class="type">error</span> &#123;</span><br><span class="line">	<span class="keyword">if</span> lockID, ok := ctx.Cache[<span class="string">&quot;stock_lock_id&quot;</span>].(<span class="type">string</span>); ok &#123;</span><br><span class="line">		<span class="keyword">return</span> s.stockService.UnlockStock(ctx.Ctx, lockID)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *StockValidationStep)</span></span> Compensate(ctx *OrderCreationContext) <span class="type">error</span> &#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *StockValidationStep)</span></span> Name() <span class="type">string</span> &#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="string">&quot;stock_validation&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 库存扣减步骤</span></span><br><span class="line"><span class="keyword">type</span> StockDeductionStep <span class="keyword">struct</span> &#123;</span><br><span class="line">	stockService StockService</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *StockDeductionStep)</span></span> Execute(ctx *OrderCreationContext) <span class="type">error</span> &#123;</span><br><span class="line">	<span class="comment">// 虚拟商品和充值订单跳过库存扣减</span></span><br><span class="line">	<span class="keyword">if</span> ctx.Order.Type == OrderTypeVirtual || ctx.Order.Type == OrderTypeTopUp &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	productID := ctx.Params[<span class="string">&quot;product_id&quot;</span>].(<span class="type">string</span>)</span><br><span class="line">	quantity := ctx.Params[<span class="string">&quot;quantity&quot;</span>].(<span class="type">int</span>)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 执行库存扣减</span></span><br><span class="line">	<span class="keyword">if</span> err := s.stockService.DeductStock(ctx.Ctx, productID, quantity); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> &amp;OrderError&#123;</span><br><span class="line">			Step:    s.Name(),</span><br><span class="line">			Message: <span class="string">&quot;failed to deduct stock&quot;</span>,</span><br><span class="line">			Err:     err,</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 记录扣减信息，用于回滚</span></span><br><span class="line">	ctx.Cache[<span class="string">&quot;stock_deducted&quot;</span>] = <span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;&#123;</span><br><span class="line">		<span class="string">&quot;product_id&quot;</span>: productID,</span><br><span class="line">		<span class="string">&quot;quantity&quot;</span>:   quantity,</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *StockDeductionStep)</span></span> Rollback(ctx *OrderCreationContext) <span class="type">error</span> &#123;</span><br><span class="line">	deducted, ok := ctx.Cache[<span class="string">&quot;stock_deducted&quot;</span>].(<span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;)</span><br><span class="line">	<span class="keyword">if</span> !ok &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	productID := deducted[<span class="string">&quot;product_id&quot;</span>].(<span class="type">string</span>)</span><br><span class="line">	quantity := deducted[<span class="string">&quot;quantity&quot;</span>].(<span class="type">int</span>)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> s.stockService.RevertDeductStock(ctx.Ctx, productID, quantity)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *StockDeductionStep)</span></span> Compensate(ctx *OrderCreationContext) <span class="type">error</span> &#123;</span><br><span class="line">	deducted, ok := ctx.Cache[<span class="string">&quot;stock_deducted&quot;</span>].(<span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;)</span><br><span class="line">	<span class="keyword">if</span> !ok &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	productID := deducted[<span class="string">&quot;product_id&quot;</span>].(<span class="type">string</span>)</span><br><span class="line">	quantity := deducted[<span class="string">&quot;quantity&quot;</span>].(<span class="type">int</span>)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 创建补偿消息</span></span><br><span class="line">	compensationMsg := StockCompensationMessage&#123;</span><br><span class="line">		OrderID:   ctx.Order.ID,</span><br><span class="line">		ProductID: productID,</span><br><span class="line">		Quantity:  quantity,</span><br><span class="line">		Timestamp: time.Now(),</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// <span class="doctag">TODO:</span> 实现发送到补偿队列的逻辑</span></span><br><span class="line">	<span class="comment">// return sendToCompensationQueue(&quot;stock_compensation&quot;, compensationMsg)</span></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *StockDeductionStep)</span></span> Name() <span class="type">string</span> &#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="string">&quot;stock_deduction&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 营销活动扣减步骤</span></span><br><span class="line"><span class="keyword">type</span> PromotionDeductionStep <span class="keyword">struct</span> &#123;</span><br><span class="line">	promotionService PromotionService</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *PromotionDeductionStep)</span></span> Execute(ctx *OrderCreationContext) <span class="type">error</span> &#123;</span><br><span class="line">	<span class="comment">// 处理优惠券</span></span><br><span class="line">	<span class="keyword">if</span> couponCode, ok := ctx.Params[<span class="string">&quot;coupon_code&quot;</span>].(<span class="type">string</span>); ok &#123;</span><br><span class="line">		<span class="comment">// 验证优惠券</span></span><br><span class="line">		coupon, err := s.promotionService.ValidateCoupon(</span><br><span class="line">			ctx.Ctx,</span><br><span class="line">			couponCode,</span><br><span class="line">			ctx.Order.UserID,</span><br><span class="line">			ctx.Order.Amount,</span><br><span class="line">		)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> &amp;OrderError&#123;</span><br><span class="line">				Step:    s.Name(),</span><br><span class="line">				Message: <span class="string">&quot;invalid coupon&quot;</span>,</span><br><span class="line">				Err:     err,</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 使用优惠券</span></span><br><span class="line">		<span class="keyword">if</span> err := s.promotionService.UseCoupon(ctx.Ctx, couponCode, ctx.Order.UserID, ctx.Order.ID); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> &amp;OrderError&#123;</span><br><span class="line">				Step:    s.Name(),</span><br><span class="line">				Message: <span class="string">&quot;failed to use coupon&quot;</span>,</span><br><span class="line">				Err:     err,</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 记录优惠券使用信息，用于回滚</span></span><br><span class="line">		ctx.Cache[<span class="string">&quot;used_coupon&quot;</span>] = couponCode</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 更新订单金额</span></span><br><span class="line">		ctx.Order.Amount -= coupon.Amount</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 处理积分抵扣</span></span><br><span class="line">	<span class="keyword">if</span> points, ok := ctx.Params[<span class="string">&quot;use_points&quot;</span>].(<span class="type">int</span>); ok &amp;&amp; points &gt; <span class="number">0</span> &#123;</span><br><span class="line">		<span class="comment">// 扣减积分</span></span><br><span class="line">		<span class="keyword">if</span> err := s.promotionService.DeductPoints(ctx.Ctx, ctx.Order.UserID, points); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> &amp;OrderError&#123;</span><br><span class="line">				Step:    s.Name(),</span><br><span class="line">				Message: <span class="string">&quot;failed to deduct points&quot;</span>,</span><br><span class="line">				Err:     err,</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 记录积分扣减信息，用于回滚</span></span><br><span class="line">		ctx.Cache[<span class="string">&quot;deducted_points&quot;</span>] = points</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 更新订单金额（假设1积分=0.01元）</span></span><br><span class="line">		ctx.Order.Amount -= <span class="type">float64</span>(points) * <span class="number">0.01</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *PromotionDeductionStep)</span></span> Rollback(ctx *OrderCreationContext) <span class="type">error</span> &#123;</span><br><span class="line">	<span class="comment">// 回滚优惠券使用</span></span><br><span class="line">	<span class="keyword">if</span> couponCode, ok := ctx.Cache[<span class="string">&quot;used_coupon&quot;</span>].(<span class="type">string</span>); ok &#123;</span><br><span class="line">		<span class="keyword">if</span> err := s.promotionService.RevertCouponUsage(ctx.Ctx, couponCode, ctx.Order.UserID, ctx.Order.ID); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> err</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 回滚积分扣减</span></span><br><span class="line">	<span class="keyword">if</span> points, ok := ctx.Cache[<span class="string">&quot;deducted_points&quot;</span>].(<span class="type">int</span>); ok &#123;</span><br><span class="line">		<span class="keyword">if</span> err := s.promotionService.RevertPointsDeduction(ctx.Ctx, ctx.Order.UserID, points); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> err</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *PromotionDeductionStep)</span></span> Compensate(ctx *OrderCreationContext) <span class="type">error</span> &#123;</span><br><span class="line">	<span class="comment">// 优惠券补偿</span></span><br><span class="line">	<span class="keyword">if</span> couponCode, ok := ctx.Cache[<span class="string">&quot;used_coupon&quot;</span>].(<span class="type">string</span>); ok &#123;</span><br><span class="line">		<span class="comment">// <span class="doctag">TODO:</span> 实现优惠券补偿逻辑</span></span><br><span class="line">		<span class="comment">// 1. 发送到补偿队列</span></span><br><span class="line">		<span class="comment">// 2. 记录补偿日志</span></span><br><span class="line">		<span class="comment">// 3. 通知运营人员</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 积分补偿</span></span><br><span class="line">	<span class="keyword">if</span> points, ok := ctx.Cache[<span class="string">&quot;deducted_points&quot;</span>].(<span class="type">int</span>); ok &#123;</span><br><span class="line">		<span class="comment">// <span class="doctag">TODO:</span> 实现积分补偿逻辑</span></span><br><span class="line">		<span class="comment">// 1. 发送到补偿队列</span></span><br><span class="line">		<span class="comment">// 2. 记录补偿日志</span></span><br><span class="line">		<span class="comment">// 3. 通知运营人员</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *PromotionDeductionStep)</span></span> Name() <span class="type">string</span> &#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="string">&quot;promotion_deduction&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// OrderFactory 订单工厂</span></span><br><span class="line"><span class="keyword">type</span> OrderFactory <span class="keyword">struct</span> &#123;</span><br><span class="line">	commonSteps []OrderCreationStep</span><br><span class="line">	typeSteps   <span class="keyword">map</span>[OrderType][]OrderCreationStep</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewOrderFactory</span><span class="params">()</span></span> *OrderFactory &#123;</span><br><span class="line">	f := &amp;OrderFactory&#123;</span><br><span class="line">		commonSteps: []OrderCreationStep&#123;</span><br><span class="line">			&amp;ParamValidationStep&#123;&#125;,</span><br><span class="line">			&amp;ProductValidationStep&#123;&#125;,</span><br><span class="line">			&amp;PromotionDeductionStep&#123;&#125;,</span><br><span class="line">		&#125;,</span><br><span class="line">		typeSteps: <span class="built_in">make</span>(<span class="keyword">map</span>[OrderType][]OrderCreationStep),</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 实物订单特有步骤</span></span><br><span class="line">	f.typeSteps[OrderTypePhysical] = []OrderCreationStep&#123;</span><br><span class="line">		&amp;StockValidationStep&#123;&#125;,</span><br><span class="line">		&amp;StockDeductionStep&#123;&#125;,</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 虚拟订单特有步骤</span></span><br><span class="line">	f.typeSteps[OrderTypeVirtual] = []OrderCreationStep&#123;&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 预售订单特有步骤</span></span><br><span class="line">	f.typeSteps[OrderTypePresale] = []OrderCreationStep&#123;</span><br><span class="line">		&amp;StockValidationStep&#123;&#125;,</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 酒店订单特有步骤</span></span><br><span class="line">	f.typeSteps[OrderTypeHotel] = []OrderCreationStep&#123;&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> f</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(f *OrderFactory)</span></span> GetSteps(orderType OrderType) []OrderCreationStep &#123;</span><br><span class="line">	steps := <span class="built_in">make</span>([]OrderCreationStep, <span class="number">0</span>)</span><br><span class="line">	steps = <span class="built_in">append</span>(steps, f.commonSteps...)</span><br><span class="line">	<span class="keyword">if</span> typeSteps, ok := f.typeSteps[orderType]; ok &#123;</span><br><span class="line">		steps = <span class="built_in">append</span>(steps, typeSteps...)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> steps</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Logger 日志接口</span></span><br><span class="line"><span class="keyword">type</span> Logger <span class="keyword">interface</span> &#123;</span><br><span class="line">	Info(msg <span class="type">string</span>, args ...<span class="keyword">interface</span>&#123;&#125;)</span><br><span class="line">	Error(msg <span class="type">string</span>, args ...<span class="keyword">interface</span>&#123;&#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// OrderCreationManager 订单创建管理器</span></span><br><span class="line"><span class="keyword">type</span> OrderCreationManager <span class="keyword">struct</span> &#123;</span><br><span class="line">	factory *OrderFactory</span><br><span class="line">	logger  Logger</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *OrderCreationManager)</span></span> CreateOrder(ctx context.Context, params <span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;) (*Order, <span class="type">error</span>) &#123;</span><br><span class="line">	orderCtx := &amp;OrderCreationContext&#123;</span><br><span class="line">		Ctx:                 ctx,</span><br><span class="line">		Params:              params,</span><br><span class="line">		Cache:               <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;),</span><br><span class="line">		StepResults:         <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="type">string</span>]StepResult),</span><br><span class="line">		RollbackFailedSteps: <span class="built_in">make</span>([]<span class="type">string</span>, <span class="number">0</span>),</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 初始化订单</span></span><br><span class="line">	order := &amp;Order&#123;</span><br><span class="line">		ID:        generateOrderID(),</span><br><span class="line">		UserID:    params[<span class="string">&quot;user_id&quot;</span>].(<span class="type">string</span>),</span><br><span class="line">		Type:      OrderType(params[<span class="string">&quot;type&quot;</span>].(<span class="type">string</span>)),</span><br><span class="line">		Status:    OrderStatusInit,</span><br><span class="line">		CreatedAt: time.Now(),</span><br><span class="line">		UpdatedAt: time.Now(),</span><br><span class="line">	&#125;</span><br><span class="line">	orderCtx.Order = order</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 获取订单类型对应的处理步骤</span></span><br><span class="line">	steps := m.factory.GetSteps(order.Type)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 执行步骤</span></span><br><span class="line">	executedSteps := <span class="built_in">make</span>([]OrderCreationStep, <span class="number">0</span>)</span><br><span class="line">	<span class="keyword">for</span> _, step := <span class="keyword">range</span> steps &#123;</span><br><span class="line">		stepName := step.Name()</span><br><span class="line">		m.logger.Info(<span class="string">&quot;executing step&quot;</span>, <span class="string">&quot;step&quot;</span>, stepName)</span><br><span class="line"></span><br><span class="line">		err := step.Execute(orderCtx)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			m.logger.Error(<span class="string">&quot;step execution failed&quot;</span>, <span class="string">&quot;step&quot;</span>, stepName, <span class="string">&quot;error&quot;</span>, err)</span><br><span class="line"></span><br><span class="line">			orderCtx.Errors = <span class="built_in">append</span>(orderCtx.Errors, err)</span><br><span class="line"></span><br><span class="line">			<span class="comment">// 执行回滚，并记录回滚失败的步骤</span></span><br><span class="line">			m.rollbackSteps(orderCtx, executedSteps)</span><br><span class="line"></span><br><span class="line">			<span class="comment">// 只对回滚失败的步骤进行补偿</span></span><br><span class="line">			<span class="keyword">if</span> <span class="built_in">len</span>(orderCtx.RollbackFailedSteps) &gt; <span class="number">0</span> &#123;</span><br><span class="line">				<span class="keyword">go</span> m.compensateFailedRollbacks(orderCtx)</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		executedSteps = <span class="built_in">append</span>(executedSteps, step)</span><br><span class="line">		m.logger.Info(<span class="string">&quot;step executed successfully&quot;</span>, <span class="string">&quot;step&quot;</span>, stepName)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> order, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 修改回滚逻辑，记录回滚失败的步骤</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *OrderCreationManager)</span></span> rollbackSteps(ctx *OrderCreationContext, steps []OrderCreationStep) &#123;</span><br><span class="line">	<span class="keyword">for</span> i := <span class="built_in">len</span>(steps) - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i-- &#123;</span><br><span class="line">		step := steps[i]</span><br><span class="line">		stepName := step.Name()</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> err := step.Rollback(ctx); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			m.logger.Error(<span class="string">&quot;step rollback failed&quot;</span>, <span class="string">&quot;step&quot;</span>, stepName, <span class="string">&quot;error&quot;</span>, err)</span><br><span class="line">			<span class="comment">// 记录回滚失败的步骤</span></span><br><span class="line">			ctx.RollbackFailedSteps = <span class="built_in">append</span>(ctx.RollbackFailedSteps, stepName)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 新的补偿方法，只处理回滚失败的步骤</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *OrderCreationManager)</span></span> compensateFailedRollbacks(ctx *OrderCreationContext) &#123;</span><br><span class="line">	m.logger.Info(<span class="string">&quot;starting compensation for failed rollbacks&quot;</span>,</span><br><span class="line">		<span class="string">&quot;failed_steps&quot;</span>, ctx.RollbackFailedSteps)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 获取所有步骤的映射</span></span><br><span class="line">	allSteps := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="type">string</span>]OrderCreationStep)</span><br><span class="line">	<span class="keyword">for</span> _, step := <span class="keyword">range</span> m.factory.GetSteps(ctx.Order.Type) &#123;</span><br><span class="line">		allSteps[step.Name()] = step</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 只对回滚失败的步骤进行补偿</span></span><br><span class="line">	<span class="keyword">for</span> _, failedStepName := <span class="keyword">range</span> ctx.RollbackFailedSteps &#123;</span><br><span class="line">		<span class="keyword">if</span> step, ok := allSteps[failedStepName]; ok &#123;</span><br><span class="line">			<span class="keyword">if</span> err := step.Compensate(ctx); err != <span class="literal">nil</span> &#123;</span><br><span class="line">				m.logger.Error(<span class="string">&quot;step compensation failed&quot;</span>,</span><br><span class="line">					<span class="string">&quot;step&quot;</span>, failedStepName,</span><br><span class="line">					<span class="string">&quot;error&quot;</span>, err)</span><br><span class="line"></span><br><span class="line">				<span class="comment">// 补偿失败处理</span></span><br><span class="line">				m.handleCompensationFailure(ctx, failedStepName, err)</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 处理补偿失败的情况</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *OrderCreationManager)</span></span> handleCompensationFailure(ctx *OrderCreationContext, stepName <span class="type">string</span>, err <span class="type">error</span>) &#123;</span><br><span class="line">	<span class="comment">// 创建补偿任务</span></span><br><span class="line">	compensationTask := CompensationTask&#123;</span><br><span class="line">		OrderID:    ctx.Order.ID,</span><br><span class="line">		StepName:   stepName,</span><br><span class="line">		Params:     ctx.Params,</span><br><span class="line">		Cache:      ctx.Cache,</span><br><span class="line">		RetryCount: <span class="number">0</span>,</span><br><span class="line">		MaxRetries: <span class="number">3</span>,</span><br><span class="line">		CreatedAt:  time.Now(),</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 记录错误日志</span></span><br><span class="line">	m.logger.Error(<span class="string">&quot;compensation task created for failed step&quot;</span>,</span><br><span class="line">		<span class="string">&quot;order_id&quot;</span>, compensationTask.OrderID,</span><br><span class="line">		<span class="string">&quot;step&quot;</span>, compensationTask.StepName,</span><br><span class="line">		<span class="string">&quot;error&quot;</span>, err)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// <span class="doctag">TODO:</span> 实现具体的补偿任务处理逻辑</span></span><br><span class="line">	<span class="comment">// 1. 将任务保存到数据库</span></span><br><span class="line">	<span class="comment">// 2. 发送到消息队列</span></span><br><span class="line">	<span class="comment">// 3. 触发告警</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// DefaultLogger 默认日志实现</span></span><br><span class="line"><span class="keyword">type</span> DefaultLogger <span class="keyword">struct</span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewDefaultLogger</span><span class="params">()</span></span> Logger &#123;</span><br><span class="line">	<span class="keyword">return</span> &amp;DefaultLogger&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *DefaultLogger)</span></span> Info(msg <span class="type">string</span>, args ...<span class="keyword">interface</span>&#123;&#125;) &#123;</span><br><span class="line">	log.Printf(<span class="string">&quot;INFO: &quot;</span>+msg, args...)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *DefaultLogger)</span></span> Error(msg <span class="type">string</span>, args ...<span class="keyword">interface</span>&#123;&#125;) &#123;</span><br><span class="line">	log.Printf(<span class="string">&quot;ERROR: &quot;</span>+msg, args...)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 辅助函数</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">generateOrderID</span><span class="params">()</span></span> <span class="type">string</span> &#123;</span><br><span class="line">	<span class="keyword">return</span> fmt.Sprintf(<span class="string">&quot;ORDER_%d&quot;</span>, time.Now().UnixNano())</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// CompensationTask 补偿任务结构</span></span><br><span class="line"><span class="keyword">type</span> CompensationTask <span class="keyword">struct</span> &#123;</span><br><span class="line">	OrderID    <span class="type">string</span></span><br><span class="line">	StepName   <span class="type">string</span></span><br><span class="line">	Params     <span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;</span><br><span class="line">	Cache      <span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;</span><br><span class="line">	RetryCount <span class="type">int</span></span><br><span class="line">	MaxRetries <span class="type">int</span></span><br><span class="line">	CreatedAt  time.Time</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// StockCompensationMessage 库存补偿消息</span></span><br><span class="line"><span class="keyword">type</span> StockCompensationMessage <span class="keyword">struct</span> &#123;</span><br><span class="line">	OrderID   <span class="type">string</span></span><br><span class="line">	ProductID <span class="type">string</span></span><br><span class="line">	Quantity  <span class="type">int</span></span><br><span class="line">	Timestamp time.Time</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p></code></pre></p>
</details>


<h4 id="支付"><a href="#支付" class="headerlink" title="支付"></a>支付</h4><h5 id="支付流程"><a href="#支付流程" class="headerlink" title="支付流程"></a>支付流程</h5><p align="center">
  <img src="/images/order_pay.png" width=800 height=1800>
</p>
1. 支付校验。用户校验，订单状态校验等
2. 营销活动扣减deduction、回滚rollback、补偿compensation.
3. 支付初始化
4. 支付回调
5. 补偿队列
6. OrderBus 订单事件

<h5 id="支付状态的设计"><a href="#支付状态的设计" class="headerlink" title="支付状态的设计"></a>支付状态的设计</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">P0: PAYMENT_NOT_STARTED - 未开始</span><br><span class="line">P1: PAYMENT_PENDING - 支付中,用户点击了pay按钮，等待支付）</span><br><span class="line"></span><br><span class="line">P2: MARKETING_Init - 营销初始化</span><br><span class="line">P3: MARKETING_FAILED - 营销扣减失败</span><br><span class="line">P4: MARKETING_SUCCESS - 营销扣减成功</span><br><span class="line"></span><br><span class="line">P5: PAYMENT_INITIALIZED - 支付初始化</span><br><span class="line">P6: PAYMENT_INITIALIZED_FAILED - 支付初始化失败</span><br><span class="line">P7: PAYMENT_PROCESSING - 支付处理中。（支付系统正在处理支付请求）</span><br><span class="line">P8: PAYMENT_SUCCESS - 支付成功</span><br><span class="line">P9: PAYMENT_FAILED - 支付失败</span><br><span class="line">P10: PAYMENT_CANCELLED - 支付取消</span><br><span class="line">P11: PAYMENT_TIMEOUT - 支付超时</span><br></pre></td></tr></table></figure>
<h5 id="异常和补偿设计"><a href="#异常和补偿设计" class="headerlink" title="异常和补偿设计"></a>异常和补偿设计</h5><p>常见的异常：<br>营销部分：</p>
<ol>
<li>营销扣减补偿操作重复。（营销接口幂等设计）</li>
<li>营销已经扣减了，但是后续步骤失败，需要回滚扣减的操作。（业务代码中需要有rollback操作）</li>
<li>营销已经扣减了，回滚扣减失败。延时队列任务补偿。（回滚失败发送延时队列，任务补偿）</li>
<li>营销已经扣减了，写延时队列失败，任务没有补偿成功。（补偿任务通过扫描异常单进行补偿）</li>
<li>营销已经扣减了，延时队列消息重复，重复回滚。（依赖营销系统的幂等操作）</li>
<li>营销已经扣减了，请求已经发给了营销服务，营销服务已经扣减了，但是回包失败。（请求营销接口之前更新订单状态为P2,针对P2的订单进行补偿）</li>
</ol>
<p>支付部分：</p>
<ol>
<li>重复支付。（支付接口幂等设计）</li>
<li>支付初始化请求支付成功，但是回包失败（重续针对P5的订单进行补偿，查询支付系统是否收单，已经支付结果查询）</li>
<li>支付回调包重复，更新回调结果幂等。</li>
<li>支付回调包丢失，对于P7支付单需要补偿。</li>
</ol>
<h4 id="履约"><a href="#履约" class="headerlink" title="履约"></a>履约</h4><h5 id="履约核心流程"><a href="#履约核心流程" class="headerlink" title="履约核心流程"></a>履约核心流程</h5><p align="center">
  <img src="/images/order_fulfillment.png" width=700 height=1500>
</p>


<h5 id="履约状态机的设计"><a href="#履约状态机的设计" class="headerlink" title="履约状态机的设计"></a>履约状态机的设计</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">F0: FULFILLMENT_NOT_STARTED - 未开始</span><br><span class="line">F1: FULFILLMENT_PENDING - 履约开始</span><br><span class="line">F2: FULFILLMENT_PROCESSING - 履约处理中</span><br><span class="line">F3: FULFILLMENT_FAILED - 履约失败</span><br><span class="line">F4: FULFILLMENT_SUCCESS - 履约成功</span><br><span class="line">F5: FULFILLMENT_CANCELLED - 履约取消</span><br></pre></td></tr></table></figure>

<h5 id="异常和补偿的设计"><a href="#异常和补偿的设计" class="headerlink" title="异常和补偿的设计"></a>异常和补偿的设计</h5><ol>
<li>订阅支付完成的事件O2</li>
<li>在请求fulfillment&#x2F;init履约初始化之前，更新订单状态为F1</li>
<li>fulfillment&#x2F;init 接口的回包丢了。（针对F1订单进行补偿）</li>
<li>fulfillment&#x2F;init 重复请求（幂等设计）</li>
<li>F2订单补偿。（fulfillment&#x2F;callback 丢包，处理失败等）</li>
</ol>
<h4 id="return-refund"><a href="#return-refund" class="headerlink" title="return &amp; refund"></a>return &amp; refund</h4><p align="center">
  <img src="/images/return-refund.png" width=700 height=2000>
</p>

<h5 id="主要流程"><a href="#主要流程" class="headerlink" title="主要流程"></a>主要流程</h5><ol>
<li>订单服务作为协调者。与履约服务、营销服务、支付服务解耦</li>
<li>用 OrderBus 进行事件传递</li>
<li>状体机设计</li>
<li>异常处理</li>
</ol>
<h5 id="异常和补偿机制"><a href="#异常和补偿机制" class="headerlink" title="异常和补偿机制"></a>异常和补偿机制</h5><ol>
<li>退货环节异常</li>
</ol>
<ul>
<li>退货初始化失败：直接发送退款失败事件</li>
<li>退货回调失败：更新状态为 R7，发送失败事件</li>
</ul>
<ol start="2">
<li>营销退款异常</li>
</ol>
<ul>
<li>营销处理失败：更新状态为 R14，发送失败事件</li>
<li>营销处理成功：更新状态为 R13，继续后续流程</li>
</ul>
<ol start="3">
<li>支付退款异常</li>
</ol>
<ul>
<li>支付退款失败：更新状态为 R11，发送失败事件</li>
<li>支付退款成功：更新状态为 R10，发送成功事件</li>
</ul>
<h5 id="订单详情查询"><a href="#订单详情查询" class="headerlink" title="订单详情查询"></a>订单详情查询</h5><h2 id="系统挑战和解决方案"><a href="#系统挑战和解决方案" class="headerlink" title="系统挑战和解决方案"></a>系统挑战和解决方案</h2><h3 id="如何维护订单状态的最终一致性？"><a href="#如何维护订单状态的最终一致性？" class="headerlink" title="如何维护订单状态的最终一致性？"></a>如何维护订单状态的最终一致性？</h3><p align="center">
  <img src="/images/order_final_consistency_activity.png" width=600 height=600>
</p>

<h4 id="不一致的原因"><a href="#不一致的原因" class="headerlink" title="不一致的原因"></a>不一致的原因</h4><ul>
<li>重复请求</li>
<li>丢包。例如，请求发货，对方收单，回包失败。</li>
<li>资源回滚：营销、库存</li>
<li>并发问题</li>
</ul>
<h4 id="状态机"><a href="#状态机" class="headerlink" title="状态机"></a>状态机</h4><ul>
<li>设计层面，严格的状态转换规则 + 状态转换的触发事件</li>
<li>状态转换的原子性。（事务性）</li>
</ul>
<h4 id="并发更新数据库前，要用乐观锁或者悲观锁，"><a href="#并发更新数据库前，要用乐观锁或者悲观锁，" class="headerlink" title="并发更新数据库前，要用乐观锁或者悲观锁，"></a>并发更新数据库前，要用乐观锁或者悲观锁，</h4><ul>
<li>乐观锁：同时在更新时判断版本号是否是之前取出来的版本号，更新成功就结束</li>
<li>悲观锁：先使用select for update进行锁行记录，然后更新</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">UPDATE</span> orders </span><br><span class="line">  <span class="keyword">SET</span> status <span class="operator">=</span> <span class="string">&#x27;NEW_STATUS&#x27;</span>, </span><br><span class="line">      version <span class="operator">=</span> version <span class="operator">+</span> <span class="number">1</span> </span><br><span class="line">  <span class="keyword">WHERE</span> id <span class="operator">=</span> ? <span class="keyword">AND</span> version <span class="operator">=</span> ?</span><br><span class="line"></span><br><span class="line">  <span class="keyword">BEGIN</span>;</span><br><span class="line">  <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> orders <span class="keyword">WHERE</span> id <span class="operator">=</span> ? <span class="keyword">FOR</span> <span class="keyword">UPDATE</span>;</span><br><span class="line">  <span class="keyword">UPDATE</span> orders <span class="keyword">SET</span> status <span class="operator">=</span> <span class="string">&#x27;NEW_STATUS&#x27;</span> <span class="keyword">WHERE</span> id <span class="operator">=</span> ?;</span><br><span class="line">  <span class="keyword">COMMIT</span>;</span><br></pre></td></tr></table></figure>


<h4 id="幂等设计。比如重复支付、重复扣减营销、重复履约等"><a href="#幂等设计。比如重复支付、重复扣减营销、重复履约等" class="headerlink" title="幂等设计。比如重复支付、重复扣减营销、重复履约等"></a>幂等设计。比如重复支付、重复扣减营销、重复履约等</h4><ul>
<li>支付重复支付，支付回调幂等设计。</li>
<li>重复营销扣减，回滚，</li>
<li>重复履约</li>
<li>重复回调</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 使用支付单号作为幂等键</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handlePaymentCallback</span><span class="params">(String paymentId, String status)</span> &#123;</span><br><span class="line">    <span class="comment">// 检查是否已处理</span></span><br><span class="line">    <span class="keyword">if</span> (isProcessed(paymentId)) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 处理支付回调</span></span><br><span class="line">    processPaymentCallback(paymentId, status);</span><br><span class="line">    <span class="comment">// 记录处理状态</span></span><br><span class="line">    markAsProcessed(paymentId);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">   <span class="comment">// 使用订单号+营销资源ID作为幂等键</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">deductMarketingResource</span><span class="params">(String orderId, String resourceId)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (isDeducted(orderId, resourceId)) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 扣减营销资源</span></span><br><span class="line">    deductResource(orderId, resourceId);</span><br><span class="line">    <span class="comment">// 记录扣减状态</span></span><br><span class="line">    markAsDeducted(orderId, resourceId);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="补偿机制兜底"><a href="#补偿机制兜底" class="headerlink" title="补偿机制兜底"></a>补偿机制兜底</h4><ul>
<li>异常回滚。营销扣减回滚</li>
<li>消息队列补偿：补偿队列，重试。（可能丢消息）</li>
<li>定时任务补偿：扫表补偿</li>
<li>依赖方支付查询和幂等设计</li>
</ul>
<h4 id="分布式事务"><a href="#分布式事务" class="headerlink" title="分布式事务"></a>分布式事务</h4><ul>
<li>营销扣减</li>
<li>库存扣减</li>
<li>支付等业务</li>
<li>实现状态转换和业务操作在同一个事务中完成 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">processOrderWithDistributedTransaction</span><span class="params">(Order order)</span> &#123;</span><br><span class="line">     <span class="keyword">try</span> &#123;</span><br><span class="line">         <span class="comment">// 1. 更新订单状态</span></span><br><span class="line">         updateOrderStatus(order);</span><br><span class="line">         <span class="comment">// 2. 扣减库存</span></span><br><span class="line">         deductInventory(order);</span><br><span class="line">         <span class="comment">// 3. 创建物流单</span></span><br><span class="line">         createLogistics(order);</span><br><span class="line">     &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">         <span class="comment">// 触发补偿机制</span></span><br><span class="line">         triggerCompensation(order);</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="异常单人工介入-1"><a href="#异常单人工介入-1" class="headerlink" title="异常单人工介入"></a>异常单人工介入</h4><h4 id="对账机制"><a href="#对账机制" class="headerlink" title="对账机制"></a>对账机制</h4><h3 id="商品信息缓存和数据一致性"><a href="#商品信息缓存和数据一致性" class="headerlink" title="商品信息缓存和数据一致性"></a>商品信息缓存和数据一致性</h3><p align="center">
  <img src="/images/item-info-cache.png" width=600 height=500>
</p>

<h3 id="主从架构中如何获取最新的数据，避免因为主从延时导致获得脏数据"><a href="#主从架构中如何获取最新的数据，避免因为主从延时导致获得脏数据" class="headerlink" title="主从架构中如何获取最新的数据，避免因为主从延时导致获得脏数据"></a>主从架构中如何获取最新的数据，避免因为主从延时导致获得脏数据</h3><p align="center">
  <img src="/images/master-slave-get-latest-data.png" width=500 height=400>
</p>

<table>
<thead>
<tr>
<th><strong>策略</strong></th>
<th><strong>优点</strong></th>
<th><strong>缺点</strong></th>
</tr>
</thead>
<tbody><tr>
<td><strong>1. 直接读取主库</strong></td>
<td>- <strong>一致性:</strong> 始终获取最新的数据。</td>
<td>- <strong>性能:</strong> 增加主库的负载，可能导致性能瓶颈。</td>
</tr>
<tr>
<td></td>
<td>- <strong>简单性:</strong> 实现简单直接，因为它直接查询可信的源。</td>
<td>- <strong>可扩展性:</strong> 主库可能成为瓶颈，限制系统在高读流量下有效扩展的能力。</td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td><strong>2. 使用VersionCache与从库</strong></td>
<td>- <strong>性能:</strong> 分散读取负载到从库，减少主库的压力。</td>
<td>- <strong>复杂性:</strong> 实现更加复杂，需要进行缓存管理并处理潜在的不一致性问题。</td>
</tr>
<tr>
<td></td>
<td>- <strong>可扩展性:</strong> 通过将大部分读取操作卸载到从库，实现更好的扩展性。</td>
<td>- <strong>缓存管理:</strong> 需要进行适当的缓存失效处理和同步，以确保数据的一致性。</td>
</tr>
<tr>
<td></td>
<td>- <strong>一致性:</strong> 通过比较版本并在必要时回退到主库，提供确保最新数据的机制。</td>
<td>- <strong>潜在延迟:</strong> 从库的数据可能仍然存在不同步的可能性，导致数据更新前有轻微延迟。</td>
</tr>
</tbody></table>
<h3 id="常见问题1-重复下单、支付、履约问题（重复和幂等问题"><a href="#常见问题1-重复下单、支付、履约问题（重复和幂等问题" class="headerlink" title="常见问题1: 重复下单、支付、履约问题（重复和幂等问题)"></a>常见问题1: 重复下单、支付、履约问题（重复和幂等问题)</h3><p>场景：</p>
<ol>
<li>下单、去重、DB唯一键兜底。去重逻辑是约定的</li>
<li>支付、checkoutid，唯一键</li>
<li>履约、先获取reference id，再履约</li>
</ol>
<p>解决方案：</p>
<ol>
<li><p>前端方案<br>前端通过js脚本控制，无法解决用户刷新提交的请求。另外也无法解决恶意提交。<br>不建议采用该方案，如果想用，也只是作为一个补充方案。</p>
</li>
<li><p>中间环节去重。根据请求参数中间去重<br>当用户点击购买按钮时，渲染下单页面，展示商品、收货地址、运费、价格等信息，同时页面会埋上 Token 信息，用户提交订单时，后端业务逻辑会校验token，有且匹配才认为是合理请求。</p>
</li>
<li><p>利用数据库自身特性 “主键唯一约束”，在插入订单记录时，带上主键值，如果订单重复，记录插入会失败。<br>操作过程如下：<br>引入一个服务，用于生成一个”全局唯一的订单号”；<br>进入创建订单页面时，前端请求该服务，预生成订单ID；<br>提交订单时，请求参数除了业务参数外，还要带上这个预生成订单ID</p>
</li>
</ol>
<h3 id="快照和操作日志"><a href="#快照和操作日志" class="headerlink" title="快照和操作日志"></a>快照和操作日志</h3><p>为了保证数据的 完整性、可追溯性，写操作需要关注的问题<br>场景：<br>商品信息是可以修改的，当用户下单后，为了更好解决后面可能存在的买卖纠纷，创建订单时会同步保存一份商品详情信息，称之为订单快照</p>
<p>解决方案：<br>同一件商品，会有很多用户会购买，如果热销商品，短时间就会有上万的订单。如果每个订单都创建一份快照，存储成本太高。另外商品信息虽然支持修改，但毕竟是一个低频动作。我们可以理解成，大部分订单的商品快照信息都是一样的，除非下单时用户修改过。<br>如何实时识别修改动作是解决快照成本的关键所在。我们采用摘要比对的方法‍。创建订单时，先检查商品信息摘要是否已经存在，如果不存在，会创建快照记录。订单明细会关联商品的快照主键。</p>
<p>账户余额更新，保证事务<br>用户支付，我们要从买家账户减掉一定金额，再往卖家增加一定金额，为了保证数据的 完整性、可追溯性， 变更余额时，我们通常会同时插入一条 记录流水。</p>
<p>账户流水核心字段： 流水ID、金额、交易双方账户、交易时间戳、订单号。<br>账户流水只能新增，不能修改和删除。流水号必须是自增的。<br>后续，系统对账时，我们只需要对交易流水明细数据做累计即可，如果出现和余额不一致情况，一般以交易流水为准来修复余额数据。<br>更新余额、记录流水 虽属于两个操作，但是要保证要么都成功，要么都失败。要做到事务。<br>当然，如果涉及多个微服务调用，会用到 分布式事务。<br>分布式事务，细想下也很容易理解，就是 将一个大事务拆分为多个本地事务， 本地事务依然借助于数据库自身事务来解决，难点在于解决这个分布式一致性问题，借助重试机制，保证最终一致是我们常用的方案。</p>
<h3 id="常见问题3-并发更新的ABA问题-（订单表的version"><a href="#常见问题3-并发更新的ABA问题-（订单表的version" class="headerlink" title="常见问题3: 并发更新的ABA问题 （订单表的version)"></a>常见问题3: 并发更新的ABA问题 （订单表的version)</h3><p>场景：<br>商家发货，填写运单号，开始填了 123，后来发现填错了，然后又修改为 456。此时，如果就为某种特殊场景埋下错误伏笔，具体我们来看下，过程如下：<br>开始「请求A」发货，调订单服务接口，更新运单号 123，但是响应有点慢，超时了；<br>此时，商家发现运单号填错了，发起了「请求B」，更新运单号为 456 ，订单服务也响应成功了；<br>这时，「请求A」触发了重试，再次调用订单服务，更新运单号 123，订单服务也响应成功了；订单服务最后保存的 运单号 是 123。</p>
<p>是不是犯错了！！！！，那么有什么好的解决方案吗？<br>数据库表引入一个额外字段 version ，每次更新时，判断表中的版本号与请求参数携带的版本号是否一致。这个版本字段可以是时间戳<br>复制<br>update order<br>set logistics_num &#x3D; #{logistics_num} , version &#x3D; #{version} + 1<br>where order_id&#x3D; 1111 and version &#x3D; #{version}</p>
<h3 id="秒杀系统中的库存管理和订单蓄洪"><a href="#秒杀系统中的库存管理和订单蓄洪" class="headerlink" title="秒杀系统中的库存管理和订单蓄洪"></a>秒杀系统中的库存管理和订单蓄洪</h3><p>常见的库存扣减方式有：<br>下单减库存： 即当买家下单后，在商品的总库存中减去买家购买数量。下单减库存是最简单的减库存方式，也是控制最精确的一种，但是有些人下完单可能并不会付款。<br>付款减库存： 即买家下单后，并不立即减库存，而是等到有用户付款后才真正减库存，否则库存一直保留给其他买家。但因为付款时才减库存，如果并发比较高，有可能出现买家下单后付不了款的情况，因为可能商品已经被其他人买走了。<br>预扣库存： 这种方式相对复杂一些，买家下单后，库存为其保留一定的时间（如 30 分钟），超过这个时间，库存将会自动释放，释放后其他买家就可以继续购买。在买家付款前，系统会校验该订单的库存是否还有保留：如果没有保留，则再次尝试预扣；<br>方案一：数据库乐观锁扣减库存<br>通常在扣减库存的场景下使用行级锁，通过数据库引擎本身对记录加锁的控制，保证数据库的更新的安全性，并且通过where语句的条件，保证库存不会被减到 0 以下，也就是能够有效的控制超卖的场景。<br>先查库存<br>然后乐观锁更新：update … set amount &#x3D; amount - 1 where id &#x3D; $id and amount &#x3D; x<br>设置数据库的字段数据为无符号整数，这样减后库存字段值小于零时 SQL 语句会报错<br>方案二：redis 扣减库存，异步同步到DB<br>redis 原子操作扣减库存<br>异步通过MQ消息同步到DB</p>
<h3 id="购物车模块的实现和优化"><a href="#购物车模块的实现和优化" class="headerlink" title="购物车模块的实现和优化"></a>购物车模块的实现和优化</h3><p>技术设计并不是特别复杂，存储的信息也相对有限（用户id、商品id、sku_id、数量、添加时间）。这里特别拿出来单讲主要是用户体验层面要注意几个问题：<br>添加购物车时，后端校验用户未登录，常规思路，引导用户跳转登录页，待登录成功后，再添加购物车。多了一步操作，给用户一种强迫的感觉，体验会比较差。有没有更好的方式？<br>如果细心体验京东、淘宝等大平台，你会发现即使未登录态也可以添加购物车，这到底是怎么实现的？<br>细细琢磨其实原理并不复杂，服务端这边在用户登录态校验时，做了分支路由，当用户未登录时，会创建一个临时Token，作为用户的唯一标识，购物车数据挂载在该Token下，为了避免购物车数据相互影响以及设计的复杂度，这里会有一个临时购物车表。<br>当然，临时购物车表的数据量并不会太大，why？用户不会一直闲着添加购物车玩，当用户登录后，查看自己的购物车，服务端会从请求的cookie里查找购物车Token标识，并查询临时购物车表是否有数据，然后合并到正式购物车表里。<br>临时购物车是不是一定要在服务端存储？未必。<br>有架构师倾向前置存储，将数据存储在浏览器或者 APP LocalStorage， 这部分数据毕竟不是共享的，但是不太好的增加了设计的复杂度。</p>
<p>客户端需要借助本地数据索引，远程请求查完整信息；<br>如果是登录态，还要增加数据合并逻辑；<br>考虑到这两部分数据只是用户标识的差异性，所以作者还是建议统一存到服务端，日后即使业务逻辑变更，只需要改一处就可以了，毕竟自运营系统，良好的可维护性也需要我们非常关注的。</p>
<p>购物车是电商系统的标配功能，暂存用户想要购买的商品。</p>
<ul>
<li>分为添加商品、列表查看、结算下单三个动作。</li>
<li>用户未登录时，将数据存储在浏览器或者 APP LocalStorage。登录后写入后端</li>
<li>后端使用DB，为了性能考虑可以结合redis和DB联合存储</li>
<li>存redis定期同步到DB</li>
<li>前后端联合存储</li>
</ul>
<h3 id="系统中的分布式ID是怎么生成的"><a href="#系统中的分布式ID是怎么生成的" class="headerlink" title="系统中的分布式ID是怎么生成的"></a>系统中的分布式ID是怎么生成的</h3><p>item ID 自增。（100w级别）<br>order id. 时间戳 + 机器ID + uid % 100 + sequence<br>DP唯一ID生成调研说明<br>request 生成方法：时间戳 + 机器mac地址 + sequence</p>
<h2 id="系统稳定性建设"><a href="#系统稳定性建设" class="headerlink" title="系统稳定性建设"></a>系统稳定性建设</h2><h3 id="Google-理论：怎样的系统算是稳定高可用的"><a href="#Google-理论：怎样的系统算是稳定高可用的" class="headerlink" title="Google 理论：怎样的系统算是稳定高可用的"></a>Google 理论：怎样的系统算是稳定高可用的</h3><p>Google SRE中(SRE三部曲[1])有一个层级模型来描述系统可靠性基础和高层次需求(Dickerson’s Hierarchy of Service Reliability)，如下图：</p>
<p align="center">
  <img src="/images/service-reliability-hierarchy.png" width=600 height=500>
  <br/>
</p>


<p>该模型由Google SRE工程师Mikey Dickerson在2013年提出，将系统稳定性需求按照基础程度进行了不同层次的体系化区分，形成稳定性标准金字塔模型:</p>
<ol>
<li><p>金字塔的底座是监控(Monitoring)，这是一个系统对于稳定性最基础的要求，缺少监控的系统，如同蒙上眼睛狂奔的野马，无从谈及可控性，更遑论稳定性。</p>
</li>
<li><p>更上层是应急响应(Incident Response)，从一个问题被监控发现到最终解决，这期间的耗时直接取决于应急响应机制的成熟度。合理的应急策略能保证当故障发生时，所有问题能得到有序且妥善的处理，而不是慌乱成一锅粥。</p>
</li>
<li><p>研发流程规范</p>
</li>
</ol>
<ul>
<li>测试和发布管控(Testing&amp;Release procedures),大大小小的应用都离不开不断的变更与发布,有效的测试与发布策略能保障系统所有新增变量都处于可控稳定区间内，从而达到整体服务终态稳定</li>
<li>事后总结以及根因分析(Postmortem&amp;Root Caue Analysis)，即我们平时谈到的”复盘”，虽然很多人都不太喜欢这项活动，但是不得不承认这是避免我们下次犯同样错误的最有效手段，只有当摸清故障的根因以及对应的缺陷，我们才能对症下药，合理进行规避</li>
</ul>
<ol start="4">
<li><p>容量规划(Capacity Planning)则是针对于这方面变化进行的保障策略。现有系统体量是否足够支撑新的流量需求，整体链路上是否存在不对等的薄弱节点，都是容量规划需要考虑的问题。</p>
</li>
<li><p>高可用性产品设计(Product)与软件研发(Development)，即通过优秀的产品设计与软件设计使系统具备更高的可靠性，构建高可用产品架构体系，从而提升用户体验</p>
</li>
<li><p>除此之外，还需要系统资损防控等</p>
</li>
</ol>
<p>下面也会从六个个方面分别介绍</p>
<p align="center">
  <img src="/images/13-reliability-mindmap.png" width=600 height=900>
  <br/>
</p>


<h3 id="可观测性设计"><a href="#可观测性设计" class="headerlink" title="可观测性设计"></a>可观测性设计</h3><h4 id="监控指标-完备性"><a href="#监控指标-完备性" class="headerlink" title="监控指标 - 完备性"></a>监控指标 - 完备性</h4><p align="center">
  <img src="/images/monitor-system.png" width=600 height=900>
  <br/>
</p>

<table>
<thead>
<tr>
<th>监控类型</th>
<th>监控指标</th>
</tr>
</thead>
<tbody><tr>
<td>业务监控</td>
<td>- 订单量、GMV、转化率等业务KPI<br>- 用户活跃度、留存率等用户指标<br>- 支付成功率、退款率等交易指标<br>- 下单失败率<br>- 支付超时率<br>- 库存不足率</td>
</tr>
<tr>
<td>应用监控</td>
<td>- 接口响应时间(RT)<br>- 接口调用量(QPS)<br>- 接口成功率<br>- 应用JVM指标<br>- 线程池使用情况<br>- 应用日志监控</td>
</tr>
<tr>
<td>系统监控</td>
<td>- 服务器CPU&#x2F;内存&#x2F;磁盘使用率<br>- 网络带宽使用率<br>- 系统负载<br>- 容器资源使用情况<br>- 网关流量&#x2F;延迟&#x2F;错误率</td>
</tr>
<tr>
<td>外部依赖</td>
<td>- RPC调用成功率&#x2F;延迟<br>- 数据库连接池状态&#x2F;慢查询<br>- 缓存命中率&#x2F;延迟<br>- 消息队列积压量&#x2F;消费延迟<br>- 第三方服务调用成功率&#x2F;超时率<br>- 分布式锁获取成功率<br>- 分布式事务状态<br>- CDN服务质量<br>- 对象存储可用性</td>
</tr>
<tr>
<td>其它</td>
<td>- 安全相关指标(登录失败&#x2F;异常IP等)<br>- 业务告警统计&#x2F;处理率<br>- 系统变更记录&#x2F;回滚率<br>- 运维操作审计<br>- 数据备份状态<br>- 证书过期监控<br>- 配置变更记录<br>- 资源成本监控<br>- 服务SLA达标率</td>
</tr>
</tbody></table>
<h4 id="告警-实时性和有效性"><a href="#告警-实时性和有效性" class="headerlink" title="告警 - 实时性和有效性"></a>告警 - 实时性和有效性</h4><p>是不是每项监控都需要告警？答案当然是否定的。建议优先设置Biz层告警，因为Biz层我们对外服务最直观业务表现，最贴切用户感受。Application&amp;System层指标主要用于监控，部分关键&amp;高风险指标可设置告警，用于问题排查定位以及故障提前发现。对于一项告警，我们一般需要关注级别、阈值、通知人等几个点。</p>
<ol>
<li>级别<br>即当前告警被触发时，问题的严重程度，一般来说有几个衡量点：</li>
</ol>
<ul>
<li>是否关联NOC.影响业务指标，事故级别</li>
<li>是否影响核心链路，应用指标异常</li>
<li>是否产生资损</li>
</ul>
<ol start="2">
<li>阈值</li>
</ol>
<ul>
<li>即一项告警的触发条件&amp;时间，需根据具体场景合理制定。一般遵循以下原则：</li>
<li>不可过于迟钝。一个合理的监控体系中，任何异常发生后都应触发相关告警。</li>
<li>不可过于敏感。过于敏感的阈值会造成频繁告警，从而导致响应人员疲劳应对，无法筛选真实异常。若一个告警频繁出现，一般是两个原因：系统设计不合理 or 阈值设置不合理。</li>
<li>若单一指标无法反馈覆盖整体业务场景，可结合多项指标关联构建。</li>
<li>需符合业务波动曲线，不同时段可设置不同条件&amp;通知策略。</li>
<li>定期review 告警指标合理性</li>
</ul>
<ol start="3">
<li>通知人&amp;方式</li>
</ol>
<ul>
<li>若为业务指标异常(Biz层告警)，通知人应为问题处理人员(开发、运维同学)与业务关注人员(TL、业务同学)的集合，通知方式较为实时，比如电话通知。</li>
<li>若为应用 &amp; 系统层告警，主要用于定位异常原因，通知人设置问题排查处理人员即可，通知方式可考虑钉钉、短信等低干扰方式。</li>
<li>除了关联层次，对于不同级别的告警，通知人范围也可适当扩大，尤其是关联GOC故障的告警指标，应适当放宽范围，通知方式也应更为实时直接</li>
</ul>
<h4 id="日志体系"><a href="#日志体系" class="headerlink" title="日志体系"></a>日志体系</h4><ul>
<li>日志收集</li>
<li>日志分析</li>
<li>日志存储</li>
<li>日志检索</li>
</ul>
<h4 id="追踪体系"><a href="#追踪体系" class="headerlink" title="追踪体系"></a>追踪体系</h4><ul>
<li>分布式追踪</li>
<li>性能分析</li>
<li>异常追踪</li>
<li>依赖分析</li>
</ul>
<h3 id="异常应急策略"><a href="#异常应急策略" class="headerlink" title="异常应急策略"></a>异常应急策略</h3><p>常用的应急策略</p>
<ul>
<li>降级策略</li>
<li>限流策略</li>
<li>熔断策略</li>
<li>超时配置化(context 超时配置和传递)</li>
<li>补偿策略</li>
<li>其它业务策略：<ul>
<li>商品暂停销售</li>
<li>营销券暂停发送等</li>
</ul>
</li>
</ul>
<h4 id="降级策略"><a href="#降级策略" class="headerlink" title="降级策略"></a>降级策略</h4><table>
<thead>
<tr>
<th>策略类型</th>
<th>具体场景</th>
<th>实现方式</th>
<th>应用案例</th>
<th>配置建议</th>
</tr>
</thead>
<tbody><tr>
<td>降级策略</td>
<td>服务降级</td>
<td>降级开关</td>
<td>推荐服务返回本地缓存</td>
<td>开关粒度: 接口级<br>降级时长: 5min</td>
</tr>
<tr>
<td></td>
<td>功能降级</td>
<td>业务降级</td>
<td>搜索服务简化召回逻辑</td>
<td>降级优先级配置<br>降级比例配置</td>
</tr>
</tbody></table>
<h4 id="限流策略"><a href="#限流策略" class="headerlink" title="限流策略"></a>限流策略</h4><table>
<thead>
<tr>
<th>策略类型</th>
<th>具体场景</th>
<th>实现方式</th>
<th>应用案例</th>
<th>配置建议</th>
</tr>
</thead>
<tbody><tr>
<td>限流策略</td>
<td>单机接口限流（粗略）</td>
<td>令牌桶&#x2F;漏桶算法</td>
<td>下单接口限制QPS为1000</td>
<td>QPS: 1000<br>突发流量: 1200</td>
</tr>
<tr>
<td></td>
<td>分布式限流(全局限流)</td>
<td>Redis + Lua脚本</td>
<td>秒杀接口全局限限流 \n 用户维度限流</td>
<td>全局QPS: 5000<br>单机QPS: 1000,时间窗口: 1min<br>最大请求数: 5</td>
</tr>
</tbody></table>
<h4 id="熔断策略"><a href="#熔断策略" class="headerlink" title="熔断策略"></a>熔断策略</h4><table>
<thead>
<tr>
<th>策略类型</th>
<th>具体场景</th>
<th>实现方式</th>
<th>应用案例</th>
<th>配置建议</th>
</tr>
</thead>
<tbody><tr>
<td>熔断策略</td>
<td>服务调用熔断</td>
<td>Hystrix-go</td>
<td>外部支付服务调用保护</td>
<td>错误阈值: 50%<br>最小请求数: 20<br>超时时间: 1s</td>
</tr>
<tr>
<td></td>
<td>中间件数据库、缓存熔断</td>
<td>Circuit Breaker</td>
<td>数据库访问保护,缓存访问保护</td>
<td>错误阈值: 30%<br>恢复时间: 5s</td>
</tr>
</tbody></table>
<h4 id="补偿策略"><a href="#补偿策略" class="headerlink" title="补偿策略"></a>补偿策略</h4><table>
<thead>
<tr>
<th>策略类型</th>
<th>具体场景</th>
<th>实现方式</th>
<th>应用案例</th>
<th>配置建议</th>
</tr>
</thead>
<tbody><tr>
<td>补偿机制</td>
<td>状态机补偿</td>
<td>定时任务</td>
<td>订单状态异常修复</td>
<td>执行间隔: 5min<br>重试次数: 3</td>
</tr>
<tr>
<td></td>
<td>数据补偿</td>
<td>人工触发</td>
<td>库存数据不一致修复</td>
<td>补偿任务可回滚<br>补偿日志记录</td>
</tr>
<tr>
<td></td>
<td>业务补偿</td>
<td>消息队列</td>
<td>支付结果异步通知</td>
<td>重试策略配置<br>补偿通知方式</td>
</tr>
<tr>
<td></td>
<td>降级补偿</td>
<td>降级恢复</td>
<td>服务恢复后数据同步</td>
<td>补偿优先级<br>补偿超时时间</td>
</tr>
</tbody></table>
<h4 id="组合策略"><a href="#组合策略" class="headerlink" title="组合策略"></a>组合策略</h4><p>组合策略应用场景</p>
<table>
<thead>
<tr>
<th>业务场景</th>
<th>组合策略</th>
<th>实现方式</th>
<th>配置建议</th>
</tr>
</thead>
<tbody><tr>
<td>秒杀系统</td>
<td>限流 + 熔断 + 降级</td>
<td>1. 入口限流<br>2. 服务熔断<br>3. 降级返回</td>
<td>- 限流: 5000 QPS<br>- 熔断: 50% 错误率<br>- 降级: 返回售罄</td>
</tr>
<tr>
<td>订单系统</td>
<td>限流 + 补偿 + 熔断</td>
<td>1. 用户限流<br>2. 状态补偿<br>3. DB熔断</td>
<td>- 用户限流: 5次&#x2F;分钟<br>- 补偿间隔: 1分钟<br>- DB超时: 1秒</td>
</tr>
<tr>
<td>支付系统</td>
<td>熔断 + 降级 + 补偿</td>
<td>1. 支付熔断<br>2. 降级支付<br>3. 异步补偿</td>
<td>- 熔断阈值: 30%<br>- 降级通道: 备用<br>- 补偿周期: 实时</td>
</tr>
<tr>
<td>库存系统</td>
<td>限流 + 熔断 + 补偿</td>
<td>1. 接口限流<br>2. 缓存熔断<br>3. 数据补偿</td>
<td>- QPS限制: 1000<br>- 熔断恢复: 5s<br>- 补偿策略: 定时</td>
</tr>
</tbody></table>
<h4 id="其它业务策略："><a href="#其它业务策略：" class="headerlink" title="其它业务策略："></a>其它业务策略：</h4><ol>
<li>商品暂停销售</li>
<li>营销券暂停发送等</li>
</ol>
<h3 id="业务和容量规划"><a href="#业务和容量规划" class="headerlink" title="业务和容量规划"></a>业务和容量规划</h3><h4 id="业务策略"><a href="#业务策略" class="headerlink" title="业务策略"></a>业务策略</h4><p>不同于高可用系统建设体系，大促稳定性保障体系与面向特定业务活动的针对性保障建设，因此，业务策略与数据是我们进行保障前不可或缺的数据。<br>一般大促业务数据可分为两类，全局业务形态评估以及应急策略&amp;玩法。</p>
<h4 id="流量模型评估"><a href="#流量模型评估" class="headerlink" title="流量模型评估"></a>流量模型评估</h4><ol>
<li>入口流量<br>对于一次大促，系统峰值入口流量一般由常规业务流量与非常规增量（比如容灾预案&amp;业务营销策略变化带来的流量模型配比变化）叠加拟合而成。</li>
</ol>
<ul>
<li>常规业务流量一般有两类计算方式：<ul>
<li>历史流量算法：该类算法假设当年大促增幅完全符合历史流量模型，根据当前&amp;历年日常流量，计算整体业务体量同比增量模型；然后根据历年大促-日常对比，计算预估流量环比增量模型；最后二者拟合得到最终评估数据。</li>
<li>由于计算时无需依赖任何业务信息输入，该类算法可用于保障工作初期业务尚未给出业务总量评估时使用，得到初估业务流量。</li>
<li>业务量-流量转化算法(GMV\DAU\订单量)：该类算法一般以业务预估总量（GMV\DAU\订单量）为输入，根据历史大促&amp;日常业务量-流量转化模型（比如经典漏洞模型）换算得到对应子域业务体量评估。- 该种方式强依赖业务总量预估，可在保障工作中后期使用，在初估业务流量基础上纳入业务评估因素考虑。</li>
</ul>
</li>
<li>非常规增量一般指前台业务营销策略变更或系统应急预案执行后流量模型变化造成的增量流量。例如，NA61机房故障时，流量100%切换到NA62后，带来的增量变化.考虑到成本最小化，非常规增量P计算时一般无需与常规业务流量W一起，全量纳入叠加入口流量K，一般会将非常规策略发生概率λ作为权重</li>
</ul>
<ol start="2">
<li>节点流量<br>节点流量由入口流量根据流量分支模型，按比例转化而来。分支流量模型以系统链路为计算基础，遵循以下原则：</li>
</ol>
<ul>
<li>同一入口，不同链路占比流量独立计算。</li>
<li>针对同一链路上同一节点，若存在多次调用，需计算按倍数同比放大（比如DB\Tair等）。</li>
<li>DB写流量重点关注，可能出现热点造成DB HANG死。</li>
</ul>
<h4 id="容量转化"><a href="#容量转化" class="headerlink" title="容量转化"></a>容量转化</h4><p>节点容量是指一个节点在运行过程中，能够<strong>同时处理的最大请求数</strong>。它反映了系统的瞬时负载能力。</p>
<p>1）Little Law衍生法则<br>不同类型资源节点(应用容器、Tair、DB、HBASE等)流量-容量转化比各不相同，但都服从Little Law衍生法则，即：<br>  节点容量&#x3D;节点吞吐率×平均响应时间<br>2）N + X 冗余原则</p>
<p>在满足目标流量所需要的最小容量基础上，冗余保留X单位冗余能力<br>X与目标成本与资源节点故障概率成正相关，不可用概率越高，X越高<br>对于一般应用容器集群，可考虑X &#x3D; 0.2N</p>
<h4 id="全链路压测"><a href="#全链路压测" class="headerlink" title="全链路压测"></a>全链路压测</h4><h4 id="成本优化"><a href="#成本优化" class="headerlink" title="成本优化"></a>成本优化</h4><h3 id="研发流程规范"><a href="#研发流程规范" class="headerlink" title="研发流程规范"></a>研发流程规范</h3><ul>
<li>研发</li>
<li>测试</li>
<li>发布</li>
</ul>
<h3 id="高可用的架构设计"><a href="#高可用的架构设计" class="headerlink" title="高可用的架构设计"></a>高可用的架构设计</h3><h4 id="整体架构"><a href="#整体架构" class="headerlink" title="整体架构"></a>整体架构</h4><table>
<thead>
<tr>
<th>架构层面</th>
<th>设计类型</th>
<th>具体措施</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>整体架构和部署</td>
<td>冗余设计</td>
<td>多机房部署</td>
<td>在不同地理位置部署多个机房,避免单点故障</td>
</tr>
<tr>
<td></td>
<td></td>
<td>服务多副本</td>
<td>每个服务部署多个实例,提供故障转移能力</td>
</tr>
<tr>
<td></td>
<td></td>
<td>数据多副本</td>
<td>数据多副本存储,保证数据可靠性</td>
</tr>
<tr>
<td></td>
<td></td>
<td>无状态服务设计</td>
<td>服务无状态化,便于水平扩展</td>
</tr>
<tr>
<td></td>
<td>容灾设计</td>
<td>同城双活</td>
<td>同一城市两个机房同时对外服务</td>
</tr>
<tr>
<td></td>
<td></td>
<td>异地多活</td>
<td>多地机房同时对外服务,就近访问</td>
</tr>
<tr>
<td></td>
<td></td>
<td>机房级容灾</td>
<td>单机房故障时可切换到其他机房</td>
</tr>
<tr>
<td></td>
<td></td>
<td>数据中心容灾</td>
<td>数据中心级别的容灾能力</td>
</tr>
<tr>
<td></td>
<td>灾备演练</td>
<td>演练计划</td>
<td>定期制定灾备演练计划</td>
</tr>
<tr>
<td></td>
<td></td>
<td>演练流程</td>
<td>标准化的演练流程和checklist</td>
</tr>
<tr>
<td></td>
<td></td>
<td>效果评估</td>
<td>对演练结果进行评估和复盘</td>
</tr>
<tr>
<td></td>
<td></td>
<td>持续改进</td>
<td>根据演练反馈持续优化容灾方案</td>
</tr>
<tr>
<td>安全架构</td>
<td>网络安全</td>
<td>防火墙&#x2F;WAF</td>
<td>防御网络攻击,过滤恶意流量</td>
</tr>
<tr>
<td></td>
<td></td>
<td>VPN&#x2F;专线</td>
<td>安全的网络连接方式</td>
</tr>
<tr>
<td></td>
<td>数据安全</td>
<td>加密存储</td>
<td>敏感数据加密存储</td>
</tr>
<tr>
<td></td>
<td></td>
<td>访问控制</td>
<td>严格的数据访问权限控制</td>
</tr>
<tr>
<td></td>
<td>应用安全</td>
<td>身份认证</td>
<td>多因素认证,防止账号盗用</td>
</tr>
<tr>
<td></td>
<td></td>
<td>操作审计</td>
<td>记录关键操作审计日志</td>
</tr>
</tbody></table>
<h4 id="应用层架构"><a href="#应用层架构" class="headerlink" title="应用层架构"></a>应用层架构</h4><table>
<thead>
<tr>
<th>设计类型</th>
<th>具体措施</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>隔离设计</td>
<td>服务隔离</td>
<td>核心服务独立部署,避免互相影响</td>
</tr>
<tr>
<td></td>
<td>数据隔离</td>
<td>按业务领域划分数据存储</td>
</tr>
<tr>
<td></td>
<td>故障隔离</td>
<td>故障隔离机制,防止故障扩散</td>
</tr>
<tr>
<td></td>
<td>资源隔离</td>
<td>CPU&#x2F;内存等资源隔离管理</td>
</tr>
<tr>
<td>水平扩展设计</td>
<td>服务无状态化</td>
<td>服务设计无状态,便于扩容</td>
</tr>
<tr>
<td></td>
<td>数据分片策略</td>
<td>数据分片存储,支持横向扩展</td>
</tr>
<tr>
<td></td>
<td>弹性伸缩</td>
<td>根据负载自动扩缩容</td>
</tr>
<tr>
<td></td>
<td>负载均衡</td>
<td>多实例间的负载分配策略</td>
</tr>
</tbody></table>
<h4 id="系统链路梳理和维护-System-Biz-Profiling"><a href="#系统链路梳理和维护-System-Biz-Profiling" class="headerlink" title="系统链路梳理和维护 System &amp; Biz Profiling"></a>系统链路梳理和维护 System &amp; Biz Profiling</h4><p>系统链路梳理是所有保障工作的基础，它就像对整个应用系统进行一次全面体检。从流量入口开始，按照链路轨迹，逐级分层节点，最终得到系统全局画像与核心保障点。主要包含以下几个方面:</p>
<ol>
<li>入口梳理盘点<br>系统通常有多个流量入口，包括HTTP、RPC、消息等多种来源。建议优先从以下三类重点入口开始梳理:</li>
</ol>
<ul>
<li>核心重保流量入口<ul>
<li>有明确的服务SLI承诺,对数据准确性、响应时间、可靠度有严格要求</li>
<li>业务核心链路(浏览、下单、支付、履约等)</li>
<li>面向企业级用户的服务</li>
</ul>
</li>
<li>资损风险入口<ul>
<li>涉及公司或客户资金收入的收费服务</li>
<li>可能造成资金损失的关键节点</li>
</ul>
</li>
<li>大流量入口<ul>
<li>系统TPS&#x2F;QPS排名前5-10的入口</li>
<li>虽无高SLI要求但流量大,对系统整体负载影响显著</li>
</ul>
</li>
</ul>
<ol start="2">
<li>节点分层分析<br>按照流量轨迹,对链路上的各类节点(HSF、DB、Tair、HBase等外部依赖)进行分层分析:</li>
</ol>
<ul>
<li><p>强弱依赖判定</p>
<ul>
<li>业务强依赖:节点不可用会导致业务中断或严重受损</li>
<li>系统强依赖:节点不可用会导致系统执行中断</li>
<li>性能强依赖:节点不可用会严重影响系统性能</li>
<li>弱依赖:有降级方案或影响较小</li>
</ul>
</li>
<li><p>可用性风险判定</p>
<ul>
<li>日常超时频发的节点</li>
<li>系统资源紧张的节点</li>
<li>历史故障频发的节点</li>
</ul>
</li>
<li><p>高风险节点识别  </p>
<ul>
<li>近期改造过的节点</li>
<li>首次参与大促的新节点</li>
<li>曾出现过高级别故障的节点</li>
<li>可能造成资损的关键节点</li>
</ul>
</li>
</ul>
<ol start="3">
<li>调用关系分析</li>
</ol>
<ul>
<li>绘制核心接口调用拓扑图或时序图</li>
<li>计算各节点间调用比例</li>
<li>分析调用链路上的资损风险点</li>
<li>识别内外部系统依赖关系</li>
</ul>
<ol start="4">
<li><p>系统调用拓扑图(可借助分布式链路追踪系统)，包含QPS、强弱依赖、高风险节点标注</p>
<p align="center">
  <img src="/images/11-system-biz-profile.png" width=800 height=600>
</p>
</li>
<li><p>接口时序图(以创建订单为例)</p>
<p align="center">
  <img src="/images/12-create-order-sequence.png" width=800 height=800>
</p></li>
</ol>
<h4 id="资损防控架构"><a href="#资损防控架构" class="headerlink" title="资损防控架构"></a>资损防控架构</h4><h5 id="定期review资损风险"><a href="#定期review资损风险" class="headerlink" title="定期review资损风险"></a>定期review资损风险</h5><h5 id="事中及时发现"><a href="#事中及时发现" class="headerlink" title="事中及时发现"></a>事中及时发现</h5><p align="center">
  <img src="/images/realtime-verify.webp" width=800 height=600>
  <br/>
  <strong><a href="https://segmentfault.com/a/1190000040286146">【得物技术】浅谈资损防控</a></strong>
  <br/>
</p>

<h5 id="事后复盘和知识沉淀"><a href="#事后复盘和知识沉淀" class="headerlink" title="事后复盘和知识沉淀"></a>事后复盘和知识沉淀</h5><h3 id="性能优化"><a href="#性能优化" class="headerlink" title="性能优化"></a>性能优化</h3><p align="center">
  <img src="/images/performance.png" width=800 height=1000>
  <br/>
</p>

<ol>
<li><p>应用层优化</p>
<ul>
<li>代码优化</li>
<li>JVM调优</li>
<li>线程池优化</li>
<li>连接池优化</li>
</ul>
</li>
<li><p>数据层优化</p>
<ul>
<li>SQL优化</li>
<li>索引优化</li>
<li>分库分表</li>
<li>读写分离</li>
</ul>
</li>
<li><p>缓存优化</p>
<ul>
<li>多级缓存</li>
<li>热点缓存</li>
<li>缓存预热</li>
<li>缓存穿透&#x2F;击穿防护</li>
</ul>
</li>
</ol>
<h2 id="其它常见问题"><a href="#其它常见问题" class="headerlink" title="其它常见问题"></a>其它常见问题</h2><h3 id="基础概念与架构设计"><a href="#基础概念与架构设计" class="headerlink" title="基础概念与架构设计"></a>基础概念与架构设计</h3><ul>
<li>电商后台系统的核心架构设计原则有哪些？</li>
<li>电商后台系统与前端系统的交互方式有哪些？各自的特点是什么？</li>
<li>如何设计电商后台系统的用户权限管理模块？</li>
<li>电商后台系统中，微服务架构和单体架构的适用场景分别是什么？</li>
<li>简述电商后台系统的分层架构设计，各层的主要职责是什么？</li>
<li>如何实现电商后台系统的接口幂等性？</li>
<li>电商后台系统中，分布式 Session 管理有哪些常见方案？</li>
<li>设计电商后台系统时，如何考虑系统的可扩展性和可维护性？</li>
<li>电商后台系统的 API 设计规范应包含哪些内容？</li>
<li>如何设计电商后台系统的异常处理机制？</li>
</ul>
<h3 id="商品管理"><a href="#商品管理" class="headerlink" title="商品管理"></a>商品管理</h3><ul>
<li><p>什么是SPU和SKU？它们之间的关系是什么？</p>
</li>
<li><p>电商系统中的商品分类体系是如何设计的？ category 父子类目</p>
</li>
<li><p>什么是商品属性？如何区分规格属性（Sales Attributes））和非规格属性？属性，会影响商品SKU的属性直接关系到库存和价格，用户购买时需要选择的属性，例如：颜色、尺码、内存容量等。非规格属性（Basic Attributes）：用于描述商品特征，产地、材质、生产日期</p>
</li>
<li><p>商品的生命周期包含哪些状态？</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">创建阶段</span><br><span class="line">DRAFT(0): 草稿状态</span><br><span class="line">PENDING_AUDIT(1): 待审核</span><br><span class="line">AUDIT_REJECTED(2): 审核拒绝</span><br><span class="line">AUDIT_APPROVED(3): 审核通过</span><br><span class="line">销售阶段</span><br><span class="line">ON_SHELF(10): 在售/上架</span><br><span class="line">OFF_SHELF(11): 下架</span><br><span class="line">SOLD_OUT(12): 售罄</span><br><span class="line">特殊状态</span><br><span class="line">FROZEN(20): 冻结（违规/投诉）</span><br><span class="line">DELETED(99): 删除</span><br></pre></td></tr></table></figure>
<p>什么是商品快照？为什么需要商品快照？</p>
</li>
<li><p>商品的 SKU 和 SPU 概念在后台系统中如何体现？两者的关系是怎样的？</p>
</li>
<li><p>电商后台系统中商品的基础信息包括哪些？如何设计商品表的数据库模型？</p>
</li>
<li><p>商品的库存管理和价格管理在后台系统中是如何关联的？</p>
</li>
<li><p>如何处理商品的多规格（如颜色、尺寸、型号等）信息？数据库表结构如何设计？</p>
</li>
<li><p>商品详情页的信息（如描述、图片、参数）在后台系统中如何存储和管理？</p>
</li>
<li><p>商品上下架的逻辑在后台系统中是如何实现的？需要考虑哪些因素（如库存、审核状态等）？</p>
</li>
<li><p>商品的搜索和筛选功能在后台系统中是如何实现的？涉及哪些技术（如全文搜索、数据库索引等）？</p>
</li>
<li><p>新品发布和商品淘汰在后台系统中的处理流程是怎样的？</p>
</li>
<li><p>如何保证商品信息的唯一性和完整性，避免重复录入和数据错误？</p>
</li>
</ul>
<ol>
<li>唯一性保证：<br>使用唯一索引<br>引入商品编码系统<br>查重机制</li>
<li>完整性保证：<br>必填字段验证<br>数据格式校验<br>关联完整性检查<br>业务规则校验</li>
</ol>
<h3 id="订单管理"><a href="#订单管理" class="headerlink" title="订单管理"></a>订单管理</h3><ul>
<li>电商后台系统中订单的主要状态有哪些？状态流转的触发条件和处理逻辑是怎样的？</li>
<li>订单的创建流程在后台系统中是如何处理的？涉及哪些模块（如库存、价格、用户信息等）的交互？</li>
<li>如何实现订单的分单处理（如不同仓库发货、不同店铺订单拆分）？</li>
<li>订单的支付状态如何与支付系统进行同步？后台系统需要处理哪些异常情况？</li>
<li>订单的取消、修改（如收货地址、商品数量）在后台系统中有哪些限制和处理逻辑？</li>
<li>如何计算订单的总价（包括商品价格、运费、优惠活动等）？优惠分摊的逻辑是怎样的？</li>
<li>订单的物流信息在后台系统中如何获取和更新？与物流服务商的接口如何对接？</li>
<li>历史订单的存储和查询在后台系统中如何优化？涉及大量数据时如何提高查询效率？</li>
<li>如何设计订单的反欺诈机制，识别和防范恶意订单？</li>
<li>订单的售后服务（如退货、换货、退款）在后台系统中的处理流程是怎样的？与库存、财务等模块如何交互？</li>
</ul>
<h3 id="用户与账户管理"><a href="#用户与账户管理" class="headerlink" title="用户与账户管理"></a>用户与账户管理</h3><ul>
<li>电商后台系统中用户信息通常包含哪些字段？如何设计用户表的数据库结构？</li>
<li>如何实现用户的注册、登录（包括第三方登录）功能在后台系统中的处理逻辑？</li>
<li>怎样处理用户密码的加密存储和找回功能？</li>
<li>电商后台如何管理用户的收货地址？地址数据的增删改查逻辑是怎样的？</li>
<li>用户账户余额和积分的管理在后台系统中有哪些注意事项？如何保证数据的一致性？</li>
<li>如何实现用户权限的分级管理（如普通用户、VIP 用户、管理员等）？</li>
<li>当用户账户出现异常登录时，后台系统应如何处理和记录？</li>
<li>电商后台如何统计用户的活跃度、留存率等指标？数据来源和计算逻辑是怎样的？</li>
<li>用户信息修改（如手机号、邮箱）时，后台系统需要进行哪些验证和处理？</li>
<li>如何设计用户操作日志的记录和查询功能，以满足审计和问题排查需求？</li>
</ul>
<h3 id="库存管理"><a href="#库存管理" class="headerlink" title="库存管理"></a>库存管理</h3><ul>
<li>电商后台系统中库存管理的主要目标是什么？常见的库存管理策略有哪些？</li>
<li>如何实现库存的实时更新？在高并发场景下如何保证库存数据的一致性？</li>
<li>库存预警机制如何设计？预警的条件（如安全库存、滞销库存等）和通知方式是怎样的？</li>
<li>多仓库库存管理在后台系统中如何实现？库存的分配和调拨逻辑是怎样的？</li>
<li>库存盘点功能在后台系统中的实现步骤是怎样的？如何处理盘点差异？</li>
<li>预售商品的库存管理与普通商品有何不同？后台系统需要特殊处理哪些方面？</li>
<li>如何防止超卖现象的发生？在库存不足时，订单的处理逻辑是怎样的？</li>
<li>库存数据与订单、采购、物流等模块的交互接口是如何设计的？</li>
<li>对于虚拟商品（如电子卡券），库存管理的方式与实物商品有何区别？</li>
<li>如何统计库存的周转率、缺货率等指标？数据来源和计算方法是怎样的？</li>
</ul>
<h3 id="支付与结算"><a href="#支付与结算" class="headerlink" title="支付与结算"></a>支付与结算</h3><ul>
<li>电商后台系统支持哪些支付方式？每种支付方式的对接流程和注意事项是什么？</li>
<li>支付系统与电商后台系统的交互接口应包含哪些关键信息？如何保证支付数据的安全性？</li>
<li>支付过程中的异步通知机制是如何实现的？后台系统如何处理重复通知和通知失败的情况？</li>
<li>如何实现支付订单与业务订单的关联和对账功能？</li>
<li>结算周期和结算规则在后台系统中如何配置和管理？（如供应商结算、平台佣金结算等）</li>
<li>支付过程中的手续费计算和分摊逻辑是怎样的？如何在后台系统中实现？</li>
<li>对于跨境支付，后台系统需要处理哪些特殊问题（如汇率转换、支付合规性等）？</li>
<li>如何设计支付系统的异常处理和回滚机制？</li>
<li>支付成功后，后台系统如何触发后续的业务流程（如订单发货、积分发放等）？</li>
<li>财务对账在后台系统中的实现方式有哪些？如何保证财务数据与业务数据的一致性？</li>
</ul>
<h3 id="物流与供应链"><a href="#物流与供应链" class="headerlink" title="物流与供应链"></a>物流与供应链</h3><ul>
<li>电商后台系统如何与物流服务商（如快递、仓储）进行接口对接？需要获取哪些物流信息？</li>
<li>物流单号的生成和管理在后台系统中是如何实现的？如何避免重复和错误？</li>
<li>发货流程在后台系统中的处理逻辑是怎样的？涉及哪些部门或系统的协作（如仓库、库存、订单等）？</li>
<li>如何实现物流信息的实时追踪和更新？在后台系统中如何展示给用户和客服？</li>
<li>退换货的物流处理在后台系统中有哪些特殊流程？如何与原订单和库存进行关联？</li>
<li>供应链管理在电商后台系统中包括哪些主要功能？如何实现供应商管理、采购管理和库存管理的协同？</li>
<li>如何根据商品的特性和用户地址选择合适的物流方案（如快递类型、运费模板等）？</li>
<li>物流异常（如包裹丢失、破损）在后台系统中的处理流程是怎样的？如何与用户和物流服务商沟通协调？</li>
<li>如何统计物流成本和物流效率（如发货时效、配送成功率等）？数据来源和分析方法是怎样的？</li>
<li>对于海外仓和跨境物流，后台系统需要处理哪些额外的业务逻辑（如清关、关税计算等）？</li>
</ul>
<h3 id="营销与促销"><a href="#营销与促销" class="headerlink" title="营销与促销"></a>营销与促销</h3><ul>
<li>电商后台系统中常见的促销策略有哪些（如满减、打折、优惠券、秒杀、拼团等）？如何设计支持多种促销策略的模块？</li>
<li>优惠券的生成、发放、使用和核销在后台系统中的处理流程是怎样的？</li>
<li>促销活动的时间管理和范围管理（如针对特定用户群体、特定商品、特定时间段）如何实现？</li>
<li>如何避免促销活动中的超卖和优惠叠加错误？后台系统的校验逻辑是怎样的？</li>
<li>秒杀活动在后台系统中如何应对高并发场景？需要进行哪些技术优化？</li>
<li>营销活动的效果评估指标（如转化率、客单价提升、销售额增长等）在后台系统中如何统计和分析？</li>
<li>如何设计推荐系统与后台营销模块的集成，实现个性化的促销推荐？</li>
<li>会员体系（如 VIP 等级、积分兑换）在后台系统中如何与营销活动结合？</li>
<li>促销活动的库存预留和释放逻辑是怎样的？如何与库存管理模块进行交互？</li>
<li>营销费用的预算管理和成本核算在后台系统中如何实现？</li>
</ul>
<h3 id="数据统计与分析"><a href="#数据统计与分析" class="headerlink" title="数据统计与分析"></a>数据统计与分析</h3><ul>
<li>电商后台系统需要统计哪些核心业务指标（如 GMV、UV、PV、转化率、复购率等）？数据采集的方式和频率是怎样的？</li>
<li>如何设计数据报表功能，支持不同角色（如运营、管理层、客服）的个性化报表需求？</li>
<li>数据统计中的维度和指标如何定义和管理？如何实现多维度的交叉分析？</li>
<li>实时数据统计和离线数据统计在后台系统中的实现方式有何不同？各自的适用场景是什么？</li>
<li>如何保证数据统计的准确性和完整性？数据清洗和校验的流程是怎样的？</li>
<li>数据分析结果如何反馈到业务模块（如库存调整、促销策略优化等）？</li>
<li>数据可视化在后台系统中的实现方式有哪些（如图表、仪表盘、数据大屏等）？</li>
<li>对于海量数据的统计分析，后台系统需要进行哪些性能优化（如分布式计算、缓存、索引等）？</li>
<li>如何设计数据权限管理，确保不同用户只能查看和操作其权限范围内的数据？</li>
<li>数据统计分析模块与其他业务模块（如订单、商品、用户等）的数据接口是如何设计的？</li>
</ul>
<h3 id="其他综合问题"><a href="#其他综合问题" class="headerlink" title="其他综合问题"></a>其他综合问题</h3><ul>
<li>电商后台系统在应对大促（如双 11、618）时，需要进行哪些准备工作和技术优化？</li>
<li>如何保障电商后台系统的高可用性和容灾能力？常见的解决方案有哪些？</li>
<li>后台系统的代码维护和版本管理有哪些最佳实践？如何保证多人协作开发的效率和代码质量？</li>
<li>当电商业务拓展到新的领域或增加新的业务模块时，后台系统如何进行适应性改造？</li>
<li>如何处理不同国家和地区的电商业务在后台系统中的差异化需求（如语言、货币、法规等）？</li>
<li>电商后台系统中的日志管理有哪些重要性？如何设计日志的记录、存储和查询功能？</li>
<li>对于第三方服务（如短信验证码、邮件通知、数据分析工具等）的接入，后台系统需要注意哪些问题？</li>
<li>如何评估电商后台系统的性能瓶颈？常见的性能测试工具和方法有哪些？</li>
<li>简述你在以往项目中参与过的电商后台系统开发经验，遇到过哪些挑战，是如何解决的？</li>
<li>对于电商后台系统的未来发展趋势（如智能化、自动化、区块链应用等），你有哪些了解和思考？</li>
</ul>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考:"></a>参考:</h2><ul>
<li><a href="https://www.cnblogs.com/wanglifeng717/p/16214122.html">订单状态机的设计和实现</a></li>
<li><a href="https://axureboutique.com/blogs/product-design/understanding-the-structure-of-e-commerce-products?srsltid=AfmBOorcMDfLRBbuCUYyKtkpkf5Vf8yQUjJSRKR0FzQSI2lvcvMmIK--">Understanding the Structure of E-Commerce Products</a></li>
<li><a href="https://axureboutique.com/blogs/product-design/build-an-e-commerce-product-center-from-scratch">Build an E-Commerce Product Center from Scratch</a></li>
<li><a href="https://sre.google/books/">SRE三部曲</a></li>
<li><a href="https://tech.dewu.com/article?id=73">得物技术 - 浅谈资损防控</a></li>
<li><a href="https://segmentfault.com/a/1190000040286146">浅谈资损防控</a></li>
<li><a href="https://mp.weixin.qq.com/s/w2tOXR6rcTmUHGsJKJilzg">稳定性保障6步走：高可用系统大促作战指南</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2024/10/16/other/programmer-survival-guide/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpeg">
      <meta itemprop="name" content="wxquare">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="wxquare's Blogs">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | wxquare's Blogs">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/10/16/other/programmer-survival-guide/" class="post-title-link" itemprop="url">程序员生成指南</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-10-16 00:00:00" itemprop="dateCreated datePublished" datetime="2024-10-16T00:00:00+08:00">2024-10-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-08-26 12:10:31" itemprop="dateModified" datetime="2025-08-26T12:10:31+08:00">2025-08-26</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/other/" itemprop="url" rel="index"><span itemprop="name">other</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p align="center">
  <img src="/images/程序员生存指南.jpg" width=400 height=1500>
</p>


      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2024/04/10/system-design/3-system-reliability/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpeg">
      <meta itemprop="name" content="wxquare">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="wxquare's Blogs">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | wxquare's Blogs">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/04/10/system-design/3-system-reliability/" class="post-title-link" itemprop="url">互联网业务系统 - 稳定性建设</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-04-10 00:00:00" itemprop="dateCreated datePublished" datetime="2024-04-10T00:00:00+08:00">2024-04-10</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-08-26 12:10:31" itemprop="dateModified" datetime="2025-08-26T12:10:31+08:00">2025-08-26</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/" itemprop="url" rel="index"><span itemprop="name">系统设计</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="前言：怎样的系统算是稳定高可用的"><a href="#前言：怎样的系统算是稳定高可用的" class="headerlink" title="前言：怎样的系统算是稳定高可用的"></a>前言：怎样的系统算是稳定高可用的</h2><p>首先回答另一个问题，怎样的系统算是稳定的？</p>
<p>Google SRE中(SRE三部曲[1])有一个层级模型来描述系统可靠性基础和高层次需求(Dickerson’s Hierarchy of Service Reliability)，如下图：</p>
<p align="center">
  <img src="/images/service-reliability-hierarchy.png" width=600 height=500>
  <br/>
</p>


<p>该模型由Google SRE工程师Mikey Dickerson在2013年提出，将系统稳定性需求按照基础程度进行了不同层次的体系化区分，形成稳定性标准金字塔模型:</p>
<ul>
<li>金字塔的底座是监控(Monitoring)，这是一个系统对于稳定性最基础的要求，缺少监控的系统，如同蒙上眼睛狂奔的野马，无从谈及可控性，更遑论稳定性。</li>
<li>更上层是应急响应(Incident Response)，从一个问题被监控发现到最终解决，这期间的耗时直接取决于应急响应机制的成熟度。合理的应急策略能保证当故障发生时，所有问题能得到有序且妥善的处理，而不是慌乱成一锅粥。</li>
<li>事后总结以及根因分析(Postmortem&amp;Root Caue Analysis)，即我们平时谈到的“复盘”，虽然很多人都不太喜欢这项活动，但是不得不承认这是避免我们下次犯同样错误的最有效手段，只有当摸清故障的根因以及对应的缺陷，我们才能对症下药，合理进行规避。</li>
<li>测试和发布管控(Testing&amp;Release procedures),大大小小的应用都离不开不断的变更与发布,有效的测试与发布策略能保障系统所有新增变量都处于可控稳定区间内，从而达到整体服务终态稳定</li>
<li>容量规划(Capacity Planning)则是针对于这方面变化进行的保障策略。现有系统体量是否足够支撑新的流量需求，整体链路上是否存在不对等的薄弱节点，都是容量规划需要考虑的问题。</li>
<li>位于金字塔模型最顶端的是产品设计(Product)与软件研发(Development)，即通过优秀的产品设计与软件设计使系统具备更高的可靠性，构建高可用产品架构体系，从而提升用户体验</li>
</ul>
<h2 id="系统稳定性建设概述"><a href="#系统稳定性建设概述" class="headerlink" title="系统稳定性建设概述"></a>系统稳定性建设概述</h2><p align="center">
  <img src="/images/system-stability.png" width=800 height=800>
  <br/>
</p>

<p>从金字塔模型我们可以看到构建维护一个高可用服务所需要做到的几方面工作：</p>
<ul>
<li>产品、技术、架构的设计，高可用的架构体系</li>
<li>系统链路&amp;业务策略梳理和维护（System &amp; Biz Profiling）</li>
<li>容量规划（Capacity Planning）</li>
<li>应急响应（Incident Response）</li>
<li>测试</li>
<li>事后总结（Testing &amp; Postmortem）</li>
<li>监控（Monitoring）</li>
<li>资损体系</li>
<li>风控体系</li>
<li>大促保障</li>
<li>性能优化</li>
</ul>
<p align="center">
  <img src="/images/6-reliability-steps.png" width=600 height=500>
  <br/>
</p>


<h2 id="高可用的架构设计"><a href="#高可用的架构设计" class="headerlink" title="高可用的架构设计"></a>高可用的架构设计</h2><h2 id="系统链路梳理和维护-System-Biz-Profiling"><a href="#系统链路梳理和维护-System-Biz-Profiling" class="headerlink" title="系统链路梳理和维护 System &amp; Biz Profiling"></a>系统链路梳理和维护 System &amp; Biz Profiling</h2><p>系统链路梳理是所有保障工作的基础，如同对整体应用系统进行一次全面体检，从流量入口开始，按照链路轨迹，逐级分层节点，得到系统全局画像与核心保障点。</p>
<h3 id="入口梳理盘点"><a href="#入口梳理盘点" class="headerlink" title="入口梳理盘点"></a>入口梳理盘点</h3><p>一个系统往往存在十几个甚至更多流量入口，包含HTTP、RPC、消息等都多种来源。如果无法覆盖所有所有链路，可以从以下三类入口开始进行梳理：</p>
<ul>
<li>核心重保流量入口<ul>
<li>用户承诺服务SLI较高，对数据准确性、服务响应时间、可靠度具有明确要求。</li>
<li>业务核心链路，浏览、下单、支付、履约</li>
<li>面向企业级用户</li>
</ul>
</li>
<li>资损事件对应入口<ul>
<li>关联到公司资金收入或者客户资金收入收费服务</li>
</ul>
</li>
<li>大流量入口<ul>
<li>系统TPS&amp;QPS TOP5~10</li>
<li>该类入口虽然不涉及较高SLI与资损要求，但是流量较高，对整体系统负载有较大影响</li>
</ul>
</li>
</ul>
<h3 id="节点分层判断"><a href="#节点分层判断" class="headerlink" title="节点分层判断"></a>节点分层判断</h3><p>对于复杂场景可以做节点分层判断</p>
<p>流量入口就如同线团中的线头，挑出线头后就可按照流量轨迹对链路上的节点(HSF\DB\Tair\HBase等一切外部依赖)按照依赖程度、可用性、可靠性进行初级分层区分。</p>
<ol>
<li>强弱依赖节点判断</li>
</ol>
<ul>
<li>若节点不可用，链路业务逻辑被中断 or 高级别有损(存在一定耐受阈值)，则为业务强依赖；反之为弱依赖。</li>
<li>若节点不可用，链路执行逻辑被中断(return error)，则为系统强依赖；反之为弱依赖。</li>
<li>若节点不可用，系统性能受影响，则为系统强依赖；反之为弱依赖。</li>
<li>按照快速失败设计逻辑，该类节点不应存在，但是在不变更应用代码前提下，如果出现该类节点，应作为强依赖看待。</li>
<li>若节点无感可降级 or 存在业务轻微损伤替换方案，则为弱依赖。</li>
</ul>
<ol start="2">
<li>低可用依赖节点判断</li>
</ol>
<ul>
<li>节点服务日常超时严重</li>
<li>节点对应系统资源不足</li>
</ul>
<ol start="3">
<li>高风险节点判断</li>
</ol>
<ul>
<li>上次大促后，节点存在大版本系统改造</li>
<li>新上线未经历过大促的节点</li>
<li>节点对应系统是否曾经出现高级别故障</li>
<li>节点故障后存在资损风险</li>
</ul>
<h3 id="应产出数据"><a href="#应产出数据" class="headerlink" title="应产出数据"></a>应产出数据</h3><ul>
<li>识别核心接口（流程）调用拓扑图或者时序图（借用分布式链路追踪系统获得调用拓扑图）</li>
<li>调用比</li>
<li>识别资损风险</li>
<li>识别内外部依赖</li>
</ul>
<p>完成该项梳理工作后，我们应该产出以下数据：对应业务域所有核心链路分析，技术&amp;业务强依赖、核心上游、下游系统、资损风险应明确标注。</p>
<h2 id="监控-告警梳理-–-Monitoring"><a href="#监控-告警梳理-–-Monitoring" class="headerlink" title="监控&amp;告警梳理 – Monitoring"></a>监控&amp;告警梳理 – Monitoring</h2><p>站在监控的角度看，我们的系统从上到下一般可以分为三层：业务（Biz）、应用（Application）、系统（System）。系统层为最下层基础，表示操作系统相关状态；应用层为JVM层，涵盖主应用进程与中间件运行状态；业务层为最上层，为业务视角下服务对外运行状态。因此进行大促稳定性监控梳理时，可以先脱离现有监控，先从核心、资损链路开始，按照业务、应用（中间件、JVM、DB）、系统三个层次梳理需要哪些监控，再从根据这些索引找到对应的监控告警，如果不存在，则相应补上；如果存在则检查阈值、时间、告警人是否合理。</p>
<h3 id="监控"><a href="#监控" class="headerlink" title="监控"></a>监控</h3><p>监控系统一般有四项黄金指标：延时（Latency）, 错误（Error）,流量（Traffic）, 饱和度（Situation），各层的关键性监控同样也可以按照这四项指标来进行归类，具体如下：</p>
<p align="center">
  <img src="/images/how-to-monitor.png" width=900 height=500>
  <br/>
</p>


<h3 id="告警"><a href="#告警" class="headerlink" title="告警"></a>告警</h3><p>是不是每项监控都需要告警？答案当然是否定的。建议优先设置Biz层告警，因为Biz层我们对外服务最直观业务表现，最贴切用户感受。Application&amp;System层指标主要用于监控，部分关键&amp;高风险指标可设置告警，用于问题排查定位以及故障提前发现。对于一项告警，我们一般需要关注级别、阈值、通知人等几个点。</p>
<ol>
<li>级别<br>即当前告警被触发时，问题的严重程度，一般来说有几个衡量点：</li>
</ol>
<ul>
<li>是否关联NOC</li>
<li>是否产生严重业务影响</li>
<li>是否产生资损</li>
</ul>
<ol start="2">
<li>阈值</li>
</ol>
<ul>
<li>即一项告警的触发条件&amp;时间，需根据具体场景合理制定。一般遵循以下原则：</li>
<li>不可过于迟钝。一个合理的监控体系中，任何异常发生后都应触发相关告警。</li>
<li>不可过于敏感。过于敏感的阈值会造成频繁告警，从而导致响应人员疲劳应对，无法筛选真实异常。若一个告警频繁出现，一般是两个原因：系统设计不合理 or 阈值设置不合理。</li>
<li>若单一指标无法反馈覆盖整体业务场景，可结合多项指标关联构建。</li>
<li>需符合业务波动曲线，不同时段可设置不同条件&amp;通知策略。</li>
</ul>
<ol start="3">
<li>通知人&amp;方式</li>
</ol>
<ul>
<li>若为业务指标异常(Biz层告警)，通知人应为问题处理人员(开发、运维同学)与业务关注人员(TL、业务同学)的集合，通知方式较为实时，比如电话通知。</li>
<li>若为应用 &amp; 系统层告警，主要用于定位异常原因，通知人设置问题排查处理人员即可，通知方式可考虑钉钉、短信等低干扰方式。</li>
<li>除了关联层次，对于不同级别的告警，通知人范围也可适当扩大，尤其是关联GOC故障的告警指标，应适当放宽范围，通知方式也应更为实时直接</li>
</ul>
<h4 id="应产出数据-1"><a href="#应产出数据-1" class="headerlink" title="应产出数据"></a>应产出数据</h4><p>完成该项梳理工作后，我们应该产出以下数据：</p>
<ol>
<li>系统监控模型，格式同表1</li>
</ol>
<ul>
<li>Biz、Application、System 分别存在哪些待监控点</li>
<li>监控点是否已全部存在指标，仍有哪些待补充</li>
</ul>
<ol start="2">
<li>系统告警模型列表，需包含以下数据</li>
</ol>
<ul>
<li>关联监控指标（链接）</li>
<li>告警关键级别</li>
<li>是否推送GOC</li>
<li>是否产生资损</li>
<li>是否关联故障</li>
<li>是否关联预案</li>
</ul>
<ol start="3">
<li>业务指标大盘，包含Biz层重点监控指标数据</li>
<li>系统&amp;应用指标大盘，包含核心系统关键系统指标，可用于白盒监控定位问题。</li>
</ol>
<h2 id="业务策略-容量规划-Capacity-Planning-容量规划"><a href="#业务策略-容量规划-Capacity-Planning-容量规划" class="headerlink" title="业务策略&amp;容量规划 Capacity Planning - 容量规划"></a>业务策略&amp;容量规划 Capacity Planning - 容量规划</h2><h3 id="业务策略"><a href="#业务策略" class="headerlink" title="业务策略"></a>业务策略</h3><p>不同于高可用系统建设体系，大促稳定性保障体系与面向特定业务活动的针对性保障建设，因此，业务策略与数据是我们进行保障前不可或缺的数据。<br>一般大促业务数据可分为两类，全局业务形态评估以及应急策略&amp;玩法。</p>
<h4 id="全局评估"><a href="#全局评估" class="headerlink" title="全局评估"></a>全局评估</h4><p>该类数据从可以帮助我们进行精准流量评估、峰值预测、大促人力排班等等，一般包含下面几类：</p>
<ul>
<li>业务量预估体量（日常X倍）</li>
<li>预估峰值日期</li>
<li>大促业务时长（XX日-XX日）</li>
<li>业务场景预估流量分配</li>
</ul>
<h4 id="应急策略"><a href="#应急策略" class="headerlink" title="应急策略"></a>应急策略</h4><ul>
<li>该类数据指相较于往年大促活动，本次大促业务变量，可用于应急响应预案与高风险节点评估等，一般包含下面两类：</li>
<li>特殊业务玩法</li>
</ul>
<p>容量规划的本质是追求计算风险最小化和计算成本最小化之间的平衡，只追求任意其一都不是合理的。为了达到这两者的最佳平衡点，需尽量精准计算系统峰值负载流量，再将流量根据单点资源负载上限换算成相应容量，得到最终容量规划模型。</p>
<h3 id="流量模型评估"><a href="#流量模型评估" class="headerlink" title="流量模型评估"></a>流量模型评估</h3><ol>
<li>入口流量</li>
</ol>
<p>对于一次大促，系统峰值入口流量一般由常规业务流量与非常规增量（比如容灾预案&amp;业务营销策略变化带来的流量模型配比变化）叠加拟合而成。</p>
<ul>
<li>常规业务流量一般有两类计算方式：<ul>
<li>历史流量算法：该类算法假设当年大促增幅完全符合历史流量模型，根据当前&amp;历年日常流量，计算整体业务体量同比增量模型；然后根据历年大促-日常对比，计算预估流量环比增量模型；最后二者拟合得到最终评估数据。</li>
<li>由于计算时无需依赖任何业务信息输入，该类算法可用于保障工作初期业务尚未给出业务总量评估时使用，得到初估业务流量。</li>
<li>业务量-流量转化算法(GMV\DAU\订单量)：该类算法一般以业务预估总量（GMV\DAU\订单量）为输入，根据历史大促&amp;日常业务量-流量转化模型（比如经典漏洞模型）换算得到对应子域业务体量评估。- 该种方式强依赖业务总量预估，可在保障工作中后期使用，在初估业务流量基础上纳入业务评估因素考虑。</li>
</ul>
</li>
<li>非常规增量一般指前台业务营销策略变更或系统应急预案执行后流量模型变化造成的增量流量。例如，NA61机房故障时，流量100%切换到NA62后，带来的增量变化.考虑到成本最小化，非常规增量P计算时一般无需与常规业务流量W一起，全量纳入叠加入口流量K，一般会将非常规策略发生概率λ作为权重</li>
</ul>
<ol start="2">
<li>节点流量<br>节点流量由入口流量根据流量分支模型，按比例转化而来。分支流量模型以系统链路为计算基础，遵循以下原则：</li>
</ol>
<ul>
<li>同一入口，不同链路占比流量独立计算。</li>
<li>针对同一链路上同一节点，若存在多次调用，需计算按倍数同比放大（比如DB\Tair等）。</li>
<li>DB写流量重点关注，可能出现热点造成DB HANG死。</li>
</ul>
<h3 id="容量转化"><a href="#容量转化" class="headerlink" title="容量转化"></a>容量转化</h3><p>节点容量是指一个节点在运行过程中，能够<strong>同时处理的最大请求数</strong>。它反映了系统的瞬时负载能力。</p>
<p>1）Little Law衍生法则<br>不同类型资源节点(应用容器、Tair、DB、HBASE等)流量-容量转化比各不相同，但都服从Little Law衍生法则，即：<br>  节点容量&#x3D;节点吞吐率×平均响应时间</p>
<p>2）N + X 冗余原则</p>
<p>在满足目标流量所需要的最小容量基础上，冗余保留X单位冗余能力<br>X与目标成本与资源节点故障概率成正相关，不可用概率越高，X越高<br>对于一般应用容器集群，可考虑X &#x3D; 0.2N</p>
<h3 id="全链路压测-TODO"><a href="#全链路压测-TODO" class="headerlink" title="全链路压测(TODO)"></a>全链路压测(TODO)</h3><ul>
<li>上述法则只能用于容量初估(大促压测前&amp;新依赖)，最终精准系统容量还是需要结合系统周期性压力测试得出。</li>
</ul>
<h3 id="应产出数据-2"><a href="#应产出数据-2" class="headerlink" title="应产出数据"></a>应产出数据</h3><ul>
<li>基于模型评估的入口流量模型 &amp; 集群自身容量转化结果（若为非入口应用，则为限流点梳理）。</li>
<li>基于链路梳理的分支流量模型 &amp; 外部依赖容量转化结果。</li>
</ul>
<h2 id="大促保障"><a href="#大促保障" class="headerlink" title="大促保障"></a>大促保障</h2><h3 id="Incident-Response-紧急-前置预案梳理"><a href="#Incident-Response-紧急-前置预案梳理" class="headerlink" title="Incident Response - 紧急&amp;前置预案梳理"></a>Incident Response - 紧急&amp;前置预案梳理</h3><p>要想在大促高并发流量场景下快速对线上紧急事故进行响应处理，仅仅依赖值班同学临场发挥是远远不够的。争分夺秒的情况下，无法给处理人员留有充足的策略思考空间，而错误的处理决策，往往会导致更为失控严重的业务&amp;系统影响。因此，要想在大促现场快速而正确的响应问题，值班同学需要做的是选择题(Which)，而不是陈述题(What)。而选项的构成，便是我们的业务&amp;系统预案。从执行时机与解决问题属性来划分，预案可分为技术应急预案、技术前置预案、业务应急预案、业务前置预案等四大类。结合之前的链路梳理和业务评估结果，我们可以快速分析出链路中需要的预案，遵循以下原则：</p>
<ul>
<li>技术应急预案：该类预案用于处理系统链路中，某层次节点不可用的情况，例如技术&#x2F;业务强依赖、弱稳定性、高风险等节点不可用等异常场景。</li>
<li>技术前置预案：该类预案用于平衡整体系统风险与单节点服务可用性，通过熔断等策略保障全局服务可靠。例如弱稳定性&amp;弱依赖服务提前降级、与峰值流量时间冲突的离线任务提前暂定等。</li>
<li>业务应急预案：该类预案用于应对业务变更等非系统性异常带来的需应急处理问题，例如业务数据错误（数据正确性敏感节点）、务策略调整（配合业务应急策略）等</li>
<li>业务前置预案：该类预案用于配和业务全局策略进行的前置服务调整（非系统性需求）</li>
</ul>
<h3 id="应产出数据-3"><a href="#应产出数据-3" class="headerlink" title="应产出数据"></a>应产出数据</h3><p>完成该项梳理工作后，我们应该产出以下数据：</p>
<ul>
<li>执行&amp;关闭时间（前置预案）</li>
<li>触发阈值（紧急预案，须关联相关告警）</li>
<li>关联影响（系统&amp;业务）</li>
<li>决策&amp;执行&amp;验证人员</li>
<li>开启验证方式</li>
<li>关闭阈值（紧急预案）</li>
<li>关闭验证方式</li>
</ul>
<p>阶段性产出-全链路作战地图</p>
<p>进行完上述几项保障工作，我们基本可得到全局链路作战地图，包含链路分支流量模型、强弱依赖节点、资损评估、对应预案&amp;处理策略等信息。大促期间可凭借该地图快速从全局视角查看应急事件相关影响，同时也可根据地图反向评估预案、容量等梳理是否完善合理。</p>
<h4 id="Incident-Response-作战手册梳理"><a href="#Incident-Response-作战手册梳理" class="headerlink" title="Incident Response - 作战手册梳理"></a>Incident Response - 作战手册梳理</h4><p>作战手册是整个大促保障的行动依据，贯穿于整个大促生命周期，可从事前、事中、事后三个阶段展开考虑。整体梳理应本着精准化、精细化的原则，理想状态下，即便是对业务、系统不熟悉的轮班同学，凭借手册也能快速响应处理线上问题。<br><strong>事前</strong><br>1）前置检查事项清单</p>
<ul>
<li>大促前必须执行事项checklist,通常包含以下事项：</li>
<li>集群机器重启 or 手动FGC</li>
<li>影子表数据清理</li>
<li>检查上下游机器权限</li>
<li>检查限流值</li>
<li>检查机器开关一致性</li>
<li>检查数据库配置</li>
<li>检查中间件容量、配置(DB\缓存\NoSQL等)</li>
<li>检查监控有效性（业务大盘、技术大盘、核心告警）</li>
<li>每个事项都需包含具体执行人、检查方案、检查结果三列数据<br>2）前置预案</li>
<li>域内所有业务&amp;技术前置预案。</li>
</ul>
<p><strong>事中</strong></p>
<ol>
<li>紧急技术&amp;业务预案<br>需要包含的内容基本同前置预案，差异点如下：</li>
</ol>
<ul>
<li>执行条件&amp;恢复条件：具体触发阈值，对应监控告警项。</li>
<li>通知决策人。</li>
</ul>
<ol start="2">
<li>应急工具&amp;脚本<br>常见故障排查方式、核心告警止血方式(强弱依赖不可用等)，业务相关日志捞取脚本等。</li>
<li>告警&amp;大盘</li>
</ol>
<ul>
<li>应包含业务、系统集群及中间件告警监控梳理结果，核心业务以及系统大盘，对应日志数据源明细等数据：</li>
<li>日志数据源明细：数据源名称、文件位置、样例、切分格式。</li>
<li>业务、系统集群及中间件告警监控梳理结果：关联监控指标（链接）、告警关键级别、是否推送GOC、是否产生资损、是否关联故障、是否关联预案。</li>
<li>核心业务&amp;系统大盘：大盘地址、包含指标明细(含义、是否关联告警、对应日志)。</li>
</ul>
<ol start="4">
<li>上下游机器分组</li>
</ol>
<ul>
<li>应包含核心系统、上下游系统，在不同机房、单元集群分组、应用名，可用于事前-机器权限检查、事中-应急问题排查黑屏处理。</li>
</ul>
<ol start="5">
<li>值班注意事项</li>
</ol>
<ul>
<li>包含每班轮班同学值班必做事项、应急变更流程、核心大盘链接等。</li>
</ul>
<ol start="6">
<li>核心播报指标</li>
</ol>
<ul>
<li>包含核心系统&amp;服务指标(CPU\LOAD\RT)、业务关注指标等，每项指标应明确具体监控地址、采集方式。</li>
</ul>
<ol start="7">
<li>域内&amp;关联域人员通讯录、值班</li>
</ol>
<ul>
<li>包含域内技术、TL、业务方对应排班情况、联系方式(电话)，相关上下游、基础组件(DB、中间件等)对应值班情况。</li>
</ul>
<ol start="8">
<li>值班问题记录</li>
</ol>
<ul>
<li>作战记录，记录工单、业务问题、预案(前置\紧急)（至少包含：时间、问题描述（截图）、影响分析、决策&amp;解决过程等）。值班同学在值班结束前，进行记录。<br><strong>事后</strong></li>
</ul>
<ol>
<li>系统恢复设置事项清单(限流、缩容)<br>一般与事前检查事项清单对应，包含限流阈值调整、集群缩容等大促后恢复操作。</li>
<li>大促问题复盘记录</li>
</ol>
<ul>
<li>应包含大促遇到的核心事件总结梳理。</li>
</ul>
<h3 id="沙盘推演和演练-Incident-Response"><a href="#沙盘推演和演练-Incident-Response" class="headerlink" title="沙盘推演和演练 Incident Response"></a>沙盘推演和演练 Incident Response</h3><p>实战沙盘演练是应急响应方面的最后一项保障工作，以历史真实故障CASE作为应急场景输入，模拟大促期间紧急状况，旨在考验值班同学们对应急问题处理的响应情况。<br>一般来说，一个线上问题从发现到解决，中间需要经历定位&amp;排查&amp;诊断&amp;修复等过程，总体遵循以下几点原则：</p>
<ul>
<li>尽最大可能让系统先恢复服务，同时为根源调查保护现场（机器、日志、水位记录）。</li>
<li>避免盲目搜索，依据白盒监控针对性诊断定位。</li>
<li>有序分工，各司其职，避免一窝蜂失控乱象。</li>
<li>依据现场情况实时评估影响范围，实在无法通过技术手段挽救的情况(例如强依赖不可用)，转化为业务问题思考（影响范围、程度、是否有资损、如何协同业务方）。</li>
<li>沙盘演练旨在检验值班同学故障处理能力，着重关注止血策略、分工安排、问题定位等三个方面：<br>国际化中台双11买家域演练<br>根据故障类型，常见止血策略有以下解决思路：</li>
<li>入口限流：调低对应Provider服务来源限流值</li>
<li>应对突发流量过高导致自身系统、下游强依赖负载被打满。</li>
<li>下游降级：降级对应下游服务</li>
<li>下游弱依赖不可用。</li>
<li>下游业务强依赖经业务同意后降级（业务部分有损）。</li>
<li>单点失败移除：摘除不可用节点</li>
<li>单机水位飙高时，先下线不可用单机服务（无需下线机器，保留现场）。</li>
<li>应对集群单点不可用、性能差。</li>
<li>切换：单元切流或者切换备份</li>
</ul>
<p>应对单库或某单元依赖因为自身原因（宿主机或网络），造成局部流量成功率下跌下跌。<br>Google SRE中，对于紧急事故管理有以下几点要素：</p>
<ul>
<li>嵌套式职责分离，即分确的职能分工安排</li>
<li>控制中心\作战室</li>
<li>实时事故状态文档</li>
<li>明确公开的职责交接</li>
<li>其中嵌套式职责分离，即分确的职能分工安排，达到各司其职，有序处理的效果，一般可分为下列几个角色：<br>事故总控：负责协调分工以及未分配事务兜底工作，掌握全局概要信息，一般为PM&#x2F;TL担任。<br>事务处理团队：事故真正处理人员，可根据具体业务场景&amp;系统特性分为多个小团队。团队内部存在域内负责人，与事故总控人员进行沟通。<br>发言人：事故对外联络人员，负责对事故处理内部成员以及外部关注人员信息做周期性信息同步，同时需要实时维护更新事故文档。<br>规划负责人：负责外部持续性支持工作，比如当大型故障出现，多轮排班轮转时，负责组织职责交接记录</li>
</ul>
<h2 id="资损体系"><a href="#资损体系" class="headerlink" title="资损体系"></a>资损体系</h2><h3 id="定期review资损风险"><a href="#定期review资损风险" class="headerlink" title="定期review资损风险"></a>定期review资损风险</h3><h3 id="事中及时发现"><a href="#事中及时发现" class="headerlink" title="事中及时发现"></a>事中及时发现</h3><p align="center">
  <img src="/images/realtime-verify.webp" width=800 height=600>
  <br/>
  <strong><a href="https://segmentfault.com/a/1190000040286146">【得物技术】浅谈资损防控</a></strong>
  <br/>
</p>

<h3 id="事后复盘和知识沉淀"><a href="#事后复盘和知识沉淀" class="headerlink" title="事后复盘和知识沉淀"></a>事后复盘和知识沉淀</h3><h3 id="参考学习"><a href="#参考学习" class="headerlink" title="参考学习"></a>参考学习</h3><ul>
<li><a href="https://tech.dewu.com/article?id=73">资损防控技术体系简介及实践</a></li>
<li><a href="https://segmentfault.com/a/1190000040286146">浅谈资损防控</a></li>
</ul>
<h2 id="风控体系"><a href="#风控体系" class="headerlink" title="风控体系"></a>风控体系</h2><h2 id="性能优化"><a href="#性能优化" class="headerlink" title="性能优化"></a>性能优化</h2><p align="center">
  <img src="/images/performance.png" width=800 height=800>
  <br/>
</p>

<p>学习资料：</p>
<ul>
<li><a href="https://landing.google.com/sre/books/">https://landing.google.com/sre/books/</a></li>
<li><a href="https://sre.google/sre-book/table-of-contents/">https://sre.google/sre-book/table-of-contents/</a></li>
<li><a href="https://sre.google/workbook/table-of-contents/">https://sre.google/workbook/table-of-contents/</a></li>
<li><a href="https://mp.weixin.qq.com/s/w2tOXR6rcTmUHGsJKJilzg?spm=a2c6h.12873639.article-detail.7.31fc2988tIxeaF">https://mp.weixin.qq.com/s/w2tOXR6rcTmUHGsJKJilzg?spm=a2c6h.12873639.article-detail.7.31fc2988tIxeaF</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" title="Next page" aria-label="Next page" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">wxquare</span>
  </div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/sidebar.js"></script><script src="/js/next-boot.js"></script>

  






  





</body>
</html>
