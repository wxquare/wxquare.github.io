<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.2.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha256-XOqroi11tY4EFQMR9ZYwZWKj5ZXiftSx36RRuC3anlA=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"yoursite.com","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.20.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"always","padding":18,"offset":12},"copycode":{"enable":true,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="电商系统整体架构设计业务流 (business process)         E-commerce process   系统流 (system process)         E-commerce whole process of system   产品架构 (Product Structure&#x2F;组织架构)         E-commerce product structure">
<meta property="og:type" content="article">
<meta property="og:title" content="互联网业务系统 - 电商系统设计">
<meta property="og:url" content="http://yoursite.com/2025/05/01/system-design/13-e-commerce/index.html">
<meta property="og:site_name" content="wxquare&#39;s Blogs">
<meta property="og:description" content="电商系统整体架构设计业务流 (business process)         E-commerce process   系统流 (system process)         E-commerce whole process of system   产品架构 (Product Structure&#x2F;组织架构)         E-commerce product structure">
<meta property="og:locale">
<meta property="og:image" content="http://yoursite.com/images/E-commerce-whole-business-process.webp">
<meta property="og:image" content="http://yoursite.com/images/E-commerce-whole-system-process.webp">
<meta property="og:image" content="http://yoursite.com/images/E-commerce-product-structure.webp">
<meta property="og:image" content="http://yoursite.com/images/application-architecture.png">
<meta property="og:image" content="http://yoursite.com/images/14-e-commerce-tech-architecture-mindmap.png">
<meta property="og:image" content="http://yoursite.com/images/item-info.png">
<meta property="og:image" content="http://yoursite.com/images/product_ER.png">
<meta property="og:image" content="http://yoursite.com/images/order_content.webp">
<meta property="og:image" content="http://yoursite.com/images/order_er.png">
<meta property="og:image" content="http://yoursite.com/images/order_status.png">
<meta property="og:image" content="http://yoursite.com/images/pay_status.png">
<meta property="og:image" content="http://yoursite.com/images/fulfillment_status.png">
<meta property="og:image" content="http://yoursite.com/images/refund_status.png">
<meta property="og:image" content="http://yoursite.com/images/order_pay.png">
<meta property="og:image" content="http://yoursite.com/images/order_fulfillment.png">
<meta property="og:image" content="http://yoursite.com/images/return-refund.png">
<meta property="og:image" content="http://yoursite.com/images/order_final_consistency_activity.png">
<meta property="og:image" content="http://yoursite.com/images/item-info-cache.png">
<meta property="og:image" content="http://yoursite.com/images/master-slave-get-latest-data.png">
<meta property="og:image" content="http://yoursite.com/images/service-reliability-hierarchy.png">
<meta property="og:image" content="http://yoursite.com/images/13-reliability-mindmap.png">
<meta property="og:image" content="http://yoursite.com/images/monitor-system.png">
<meta property="og:image" content="http://yoursite.com/images/11-system-biz-profile.png">
<meta property="og:image" content="http://yoursite.com/images/12-create-order-sequence.png">
<meta property="og:image" content="http://yoursite.com/images/realtime-verify.webp">
<meta property="og:image" content="http://yoursite.com/images/performance.png">
<meta property="article:published_time" content="2025-04-30T16:00:00.000Z">
<meta property="article:modified_time" content="2025-08-26T04:10:31.342Z">
<meta property="article:author" content="wxquare">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://yoursite.com/images/E-commerce-whole-business-process.webp">


<link rel="canonical" href="http://yoursite.com/2025/05/01/system-design/13-e-commerce/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-Hans","comments":true,"permalink":"http://yoursite.com/2025/05/01/system-design/13-e-commerce/","path":"2025/05/01/system-design/13-e-commerce/","title":"互联网业务系统 - 电商系统设计"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>互联网业务系统 - 电商系统设计 | wxquare's Blogs</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">wxquare's Blogs</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li><li class="menu-item menu-item-friends"><a href="/friends" rel="section"><i class="fa fa-user fa-fw"></i>Friends</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%94%B5%E5%95%86%E7%B3%BB%E7%BB%9F%E6%95%B4%E4%BD%93%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1"><span class="nav-number">1.</span> <span class="nav-text">电商系统整体架构设计</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%9A%E5%8A%A1%E6%B5%81-business-process"><span class="nav-number">1.1.</span> <span class="nav-text">业务流 (business process)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%B3%BB%E7%BB%9F%E6%B5%81-system-process"><span class="nav-number">1.2.</span> <span class="nav-text">系统流 (system process)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BA%A7%E5%93%81%E6%9E%B6%E6%9E%84-Product-Structure-%E7%BB%84%E7%BB%87%E6%9E%B6%E6%9E%84"><span class="nav-number">1.3.</span> <span class="nav-text">产品架构 (Product Structure&#x2F;组织架构)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BA%94%E7%94%A8%E6%9E%B6%E6%9E%84"><span class="nav-number">1.4.</span> <span class="nav-text">应用架构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8A%80%E6%9C%AF%E6%9E%B6%E6%9E%84"><span class="nav-number">1.5.</span> <span class="nav-text">技术架构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E6%9E%B6%E6%9E%84"><span class="nav-number">1.6.</span> <span class="nav-text">数据架构</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%95%86%E5%93%81%E7%AE%A1%E7%90%86-Product-Center"><span class="nav-number">2.</span> <span class="nav-text">商品管理 Product Center</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%95%86%E5%93%81%E4%BF%A1%E6%81%AF%E5%8C%85%E6%8B%AC%E5%93%AA%E4%BA%9B%E5%86%85%E5%AE%B9"><span class="nav-number">2.1.</span> <span class="nav-text">商品信息包括哪些内容</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%95%86%E5%93%81%E7%B3%BB%E7%BB%9F%E7%9A%84%E6%BC%94%E8%BF%9B"><span class="nav-number">2.2.</span> <span class="nav-text">商品系统的演进</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BB%80%E4%B9%88%E6%98%AFSPU%E3%80%81SKU"><span class="nav-number">2.3.</span> <span class="nav-text">什么是SPU、SKU</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E5%BA%93%E6%A8%A1%E5%9E%8B"><span class="nav-number">2.4.</span> <span class="nav-text">数据库模型</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%A8%A1%E5%9E%8B%E8%AF%B4%E6%98%8E%EF%BC%9A"><span class="nav-number">2.4.1.</span> <span class="nav-text">模型说明：</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%95%86%E5%93%81%E4%BF%A1%E6%81%AF%E5%BD%95%E5%85%A5JSON%E7%A4%BA%E4%BE%8B"><span class="nav-number">2.4.2.</span> <span class="nav-text">商品信息录入JSON示例</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%AE%9E%E4%BD%93%E5%95%86%E5%93%81"><span class="nav-number">2.4.2.1.</span> <span class="nav-text">实体商品</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%99%9A%E6%8B%9F%E5%95%86%E5%93%81"><span class="nav-number">2.4.2.2.</span> <span class="nav-text">虚拟商品</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%95%86%E5%93%81%E7%9A%84%E4%BB%B7%E6%A0%BC%E5%92%8C%E5%BA%93%E5%AD%98"><span class="nav-number">2.4.3.</span> <span class="nav-text">商品的价格和库存</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%96%B9%E6%A1%881-%E4%BB%B7%E6%A0%BC%E5%92%8C%E5%BA%93%E5%AD%98%E7%9B%B4%E6%8E%A5%E6%94%BE%E5%9C%A8sku%E8%A1%A8%E4%B8%AD-%EF%BC%88%E5%8F%98%E5%8C%96%E5%B0%8F%EF%BC%89"><span class="nav-number">2.4.3.1.</span> <span class="nav-text">方案1. 价格和库存直接放在sku表中 （变化小）</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%96%B9%E6%A1%882-%E4%BB%B7%E6%A0%BC%E5%92%8C%E5%BA%93%E5%AD%98%E5%8D%95%E7%8B%AC%E7%AE%A1%E7%90%86%EF%BC%88%E5%8F%98%E5%8C%96%E5%A4%A7%EF%BC%89"><span class="nav-number">2.4.3.2.</span> <span class="nav-text">方案2. 价格和库存单独管理（变化大）</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%95%86%E5%93%81%E5%BF%AB%E7%85%A7-item-snapshots"><span class="nav-number">2.4.4.</span> <span class="nav-text">商品快照 item_snapshots</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%94%A8%E6%88%B7%E6%93%8D%E4%BD%9C%E6%97%A5%E5%BF%97"><span class="nav-number">2.4.5.</span> <span class="nav-text">用户操作日志</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%95%86%E5%93%81%E7%9A%84%E7%BB%9F%E8%AE%A1%E4%BF%A1%E6%81%AF"><span class="nav-number">2.4.6.</span> <span class="nav-text">商品的统计信息</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BC%93%E5%AD%98%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="nav-number">2.5.</span> <span class="nav-text">缓存的使用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A0%B8%E5%BF%83%E6%B5%81%E7%A8%8B"><span class="nav-number">2.6.</span> <span class="nav-text">核心流程</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#B%E7%AB%AF%EF%BC%9A%E5%95%86%E5%93%81%E5%88%9B%E5%BB%BA%E5%92%8C%E5%8F%91%E5%B8%83%E7%9A%84%E6%B5%81%E7%A8%8B"><span class="nav-number">2.6.1.</span> <span class="nav-text">B端：商品创建和发布的流程</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#C%E7%AB%AF%EF%BC%9A%E5%95%86%E5%93%81%E6%90%9C%E7%B4%A2%E3%80%81%E5%95%86%E5%93%81%E8%AF%A6%E6%83%85"><span class="nav-number">2.6.2.</span> <span class="nav-text">C端：商品搜索、商品详情</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%AE%A2%E5%8D%95%E7%AE%A1%E7%90%86-Order-Center"><span class="nav-number">3.</span> <span class="nav-text">订单管理 Order Center</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%AE%A2%E5%8D%95%E4%B8%AD%E9%9C%80%E8%A6%81%E5%8C%85%E5%90%AB%E5%93%AA%E4%BA%9B%E4%BF%A1%E6%81%AF"><span class="nav-number">3.1.</span> <span class="nav-text">订单中需要包含哪些信息</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B8%B8%E8%A7%81%E7%9A%84%E8%AE%A2%E5%8D%95%E7%B1%BB%E5%9E%8B"><span class="nav-number">3.2.</span> <span class="nav-text">常见的订单类型</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%AE%A2%E5%8D%95%E7%B3%BB%E7%BB%9F%E7%9A%84%E6%BC%94%E8%BF%9B"><span class="nav-number">3.3.</span> <span class="nav-text">订单系统的演进</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B8%B8%E8%A7%81%E7%9A%84%E8%AE%A2%E5%8D%95%E6%A8%A1%E5%9E%8B%E8%AE%BE%E8%AE%A1"><span class="nav-number">3.4.</span> <span class="nav-text">常见的订单模型设计</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%AE%A2%E5%8D%95%E8%A1%A8%EF%BC%88order-tab%EF%BC%89%EF%BC%9A%E8%AE%B0%E5%BD%95%E7%94%A8%E6%88%B7%E7%9A%84%E8%B4%AD%E4%B9%B0%E8%AE%A2%E5%8D%95%E4%BF%A1%E6%81%AF%E3%80%82%E4%B8%BB%E9%94%AE%E4%B8%BA-order-id%E3%80%82"><span class="nav-number">3.4.1.</span> <span class="nav-text">订单表（order_tab）：记录用户的购买订单信息。主键为 order_id。</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%AE%A2%E5%8D%95%E5%95%86%E5%93%81%E8%A1%A8%EF%BC%88order-item-tab%EF%BC%9A%E8%AE%B0%E5%BD%95%E8%AE%A2%E5%8D%95%E4%B8%AD%E5%85%B7%E4%BD%93%E5%95%86%E5%93%81%E7%9A%84%E4%BF%A1%E6%81%AF%E3%80%82%E4%B8%BB%E9%94%AE%E4%B8%BA-order-item-id%E3%80%82"><span class="nav-number">3.4.2.</span> <span class="nav-text">订单商品表（order_item_tab：记录订单中具体商品的信息。主键为 order_item_id。</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%AE%A2%E5%8D%95%E6%94%AF%E4%BB%98%E8%A1%A8%EF%BC%88pay-order-tab%EF%BC%89%EF%BC%9A%E4%B8%BB%E8%A6%81%E7%94%A8%E4%BA%8E%E8%AE%B0%E5%BD%95%E7%94%A8%E6%88%B7%E7%9A%84%E6%94%AF%E4%BB%98%E4%BF%A1%E6%81%AF%E3%80%82%E4%B8%BB%E9%94%AE%E4%B8%BA-pay-order-id%EF%BC%8C%E6%A0%87%E8%AF%86%E5%94%AF%E4%B8%80%E7%9A%84%E6%94%AF%E4%BB%98%E8%AE%A2%E5%8D%95%E3%80%82"><span class="nav-number">3.4.3.</span> <span class="nav-text">订单支付表（pay_order_tab）：主要用于记录用户的支付信息。主键为 pay_order_id，标识唯一的支付订单。</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%80%80%E6%AC%BE%E8%A1%A8%EF%BC%88refund-tab%EF%BC%89%EF%BC%9A%E8%AE%B0%E5%BD%95%E8%AE%A2%E5%8D%95%E6%88%96%E8%AE%A2%E5%8D%95%E9%A1%B9%E7%9A%84%E9%80%80%E6%AC%BE%E4%BF%A1%E6%81%AF%E3%80%82%E4%B8%BB%E9%94%AE%E4%B8%BA-refund-id%E3%80%82"><span class="nav-number">3.4.4.</span> <span class="nav-text">退款表（refund_tab）：记录订单或订单项的退款信息。主键为 refund_id。</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%9E%E4%BD%93%E9%97%B4%E5%85%B3%E7%B3%BB%EF%BC%9A"><span class="nav-number">3.4.5.</span> <span class="nav-text">实体间关系：</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%AE%A2%E5%8D%95%E7%8A%B6%E6%80%81%E6%9C%BA%E8%AE%BE%E8%AE%A1"><span class="nav-number">3.5.</span> <span class="nav-text">订单状态机设计</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Order-%E4%B8%BB%E7%8A%B6%E6%80%81%E6%9C%BA"><span class="nav-number">3.5.1.</span> <span class="nav-text">Order 主状态机</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%94%AF%E4%BB%98%E7%8A%B6%E6%80%81%E6%9C%BA"><span class="nav-number">3.5.2.</span> <span class="nav-text">支付状态机</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%B1%A5%E7%BA%A6%E7%8A%B6%E6%80%81%E6%9C%BA"><span class="nav-number">3.5.3.</span> <span class="nav-text">履约状态机</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%80%80%E8%B4%A7%E9%80%80%E6%AC%BE%E7%8A%B6%E4%BD%93%E6%9C%BA"><span class="nav-number">3.5.4.</span> <span class="nav-text">退货退款状体机</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%BC%82%E5%B8%B8%E5%8D%95%E4%BA%BA%E5%B7%A5%E4%BB%8B%E5%85%A5"><span class="nav-number">3.5.5.</span> <span class="nav-text">异常单人工介入</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%AE%A2%E5%8D%95ID-%E7%94%9F%E6%88%90%E7%AD%96%E7%95%A5"><span class="nav-number">3.6.</span> <span class="nav-text">订单ID 生成策略</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%AE%A2%E5%8D%95%E5%95%86%E5%93%81%E5%BF%AB%E7%85%A7"><span class="nav-number">3.7.</span> <span class="nav-text">订单商品快照</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%96%B9%E6%A1%881-%E7%9B%B4%E6%8E%A5%E4%BD%BF%E7%94%A8%E5%95%86%E5%93%81%E7%B3%BB%E7%BB%9F%E7%9A%84item-snapshot%E3%80%82%EF%BC%88%E7%94%B1%E5%95%86%E5%93%81%E7%B3%BB%E7%BB%9F%E7%BB%B4%E6%8A%A4%E5%BF%AB%E7%85%A7%EF%BC%89"><span class="nav-number">3.7.1.</span> <span class="nav-text">方案1. 直接使用商品系统的item snapshot。（由商品系统维护快照）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%96%B9%E6%A1%882-%E5%88%9B%E5%8D%95%E6%97%B6%E6%8F%90%E4%BE%9B%E5%95%86%E5%93%81%E8%AF%A6%E6%83%85%E4%BF%A1%E6%81%AF%E3%80%82%EF%BC%88%E7%94%B1%E8%AE%A2%E5%8D%95%E7%BB%B4%E6%8A%A4%E5%95%86%E5%93%81%E5%BF%AB%E7%85%A7"><span class="nav-number">3.7.2.</span> <span class="nav-text">方案2. 创单时提供商品详情信息。（由订单维护商品快照)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%96%B9%E6%A1%883-%E5%88%9B%E5%8D%95%E6%97%B6%E6%8F%90%E4%BE%9B%E5%95%86%E5%93%81%E8%AF%A6%E6%83%85%E4%BF%A1%E6%81%AF%E3%80%82%EF%BC%88%E7%94%B1%E8%AE%A2%E5%8D%95%E7%BB%B4%E6%8A%A4%E5%95%86%E5%93%81%E5%BF%AB%E7%85%A7%EF%BC%89-%E5%BF%AB%E7%85%A7%E5%A4%8D%E7%94%A8"><span class="nav-number">3.7.3.</span> <span class="nav-text">方案3. 创单时提供商品详情信息。（由订单维护商品快照）+ 快照复用</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A0%B8%E5%BF%83%E6%B5%81%E7%A8%8B-1"><span class="nav-number">3.8.</span> <span class="nav-text">核心流程</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%AD%A3%E5%B8%B8%E6%B5%81%E7%A8%8B%E5%92%8C%E9%80%86%E5%90%91%E6%B5%81%E7%A8%8B"><span class="nav-number">3.8.1.</span> <span class="nav-text">正常流程和逆向流程</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%9B%E5%8D%95"><span class="nav-number">3.8.2.</span> <span class="nav-text">创单</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%A0%B8%E5%BF%83%E6%AD%A5%E9%AA%A4"><span class="nav-number">3.8.2.1.</span> <span class="nav-text">核心步骤</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%AE%9E%E7%8E%B0%E6%80%9D%E8%B7%AF"><span class="nav-number">3.8.2.2.</span> <span class="nav-text">实现思路</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%94%AF%E4%BB%98"><span class="nav-number">3.8.3.</span> <span class="nav-text">支付</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%94%AF%E4%BB%98%E6%B5%81%E7%A8%8B"><span class="nav-number">3.8.3.1.</span> <span class="nav-text">支付流程</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%94%AF%E4%BB%98%E7%8A%B6%E6%80%81%E7%9A%84%E8%AE%BE%E8%AE%A1"><span class="nav-number">3.8.3.2.</span> <span class="nav-text">支付状态的设计</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%BC%82%E5%B8%B8%E5%92%8C%E8%A1%A5%E5%81%BF%E8%AE%BE%E8%AE%A1"><span class="nav-number">3.8.3.3.</span> <span class="nav-text">异常和补偿设计</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%B1%A5%E7%BA%A6"><span class="nav-number">3.8.4.</span> <span class="nav-text">履约</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%B1%A5%E7%BA%A6%E6%A0%B8%E5%BF%83%E6%B5%81%E7%A8%8B"><span class="nav-number">3.8.4.1.</span> <span class="nav-text">履约核心流程</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%B1%A5%E7%BA%A6%E7%8A%B6%E6%80%81%E6%9C%BA%E7%9A%84%E8%AE%BE%E8%AE%A1"><span class="nav-number">3.8.4.2.</span> <span class="nav-text">履约状态机的设计</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%BC%82%E5%B8%B8%E5%92%8C%E8%A1%A5%E5%81%BF%E7%9A%84%E8%AE%BE%E8%AE%A1"><span class="nav-number">3.8.4.3.</span> <span class="nav-text">异常和补偿的设计</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#return-refund"><span class="nav-number">3.8.5.</span> <span class="nav-text">return &amp; refund</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E4%B8%BB%E8%A6%81%E6%B5%81%E7%A8%8B"><span class="nav-number">3.8.5.1.</span> <span class="nav-text">主要流程</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%BC%82%E5%B8%B8%E5%92%8C%E8%A1%A5%E5%81%BF%E6%9C%BA%E5%88%B6"><span class="nav-number">3.8.5.2.</span> <span class="nav-text">异常和补偿机制</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%AE%A2%E5%8D%95%E8%AF%A6%E6%83%85%E6%9F%A5%E8%AF%A2"><span class="nav-number">3.8.5.3.</span> <span class="nav-text">订单详情查询</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%B3%BB%E7%BB%9F%E6%8C%91%E6%88%98%E5%92%8C%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="nav-number">4.</span> <span class="nav-text">系统挑战和解决方案</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A6%82%E4%BD%95%E7%BB%B4%E6%8A%A4%E8%AE%A2%E5%8D%95%E7%8A%B6%E6%80%81%E7%9A%84%E6%9C%80%E7%BB%88%E4%B8%80%E8%87%B4%E6%80%A7%EF%BC%9F"><span class="nav-number">4.1.</span> <span class="nav-text">如何维护订单状态的最终一致性？</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%B8%8D%E4%B8%80%E8%87%B4%E7%9A%84%E5%8E%9F%E5%9B%A0"><span class="nav-number">4.1.1.</span> <span class="nav-text">不一致的原因</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%8A%B6%E6%80%81%E6%9C%BA"><span class="nav-number">4.1.2.</span> <span class="nav-text">状态机</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%B9%B6%E5%8F%91%E6%9B%B4%E6%96%B0%E6%95%B0%E6%8D%AE%E5%BA%93%E5%89%8D%EF%BC%8C%E8%A6%81%E7%94%A8%E4%B9%90%E8%A7%82%E9%94%81%E6%88%96%E8%80%85%E6%82%B2%E8%A7%82%E9%94%81%EF%BC%8C"><span class="nav-number">4.1.3.</span> <span class="nav-text">并发更新数据库前，要用乐观锁或者悲观锁，</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%B9%82%E7%AD%89%E8%AE%BE%E8%AE%A1%E3%80%82%E6%AF%94%E5%A6%82%E9%87%8D%E5%A4%8D%E6%94%AF%E4%BB%98%E3%80%81%E9%87%8D%E5%A4%8D%E6%89%A3%E5%87%8F%E8%90%A5%E9%94%80%E3%80%81%E9%87%8D%E5%A4%8D%E5%B1%A5%E7%BA%A6%E7%AD%89"><span class="nav-number">4.1.4.</span> <span class="nav-text">幂等设计。比如重复支付、重复扣减营销、重复履约等</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%A1%A5%E5%81%BF%E6%9C%BA%E5%88%B6%E5%85%9C%E5%BA%95"><span class="nav-number">4.1.5.</span> <span class="nav-text">补偿机制兜底</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1"><span class="nav-number">4.1.6.</span> <span class="nav-text">分布式事务</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%BC%82%E5%B8%B8%E5%8D%95%E4%BA%BA%E5%B7%A5%E4%BB%8B%E5%85%A5-1"><span class="nav-number">4.1.7.</span> <span class="nav-text">异常单人工介入</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AF%B9%E8%B4%A6%E6%9C%BA%E5%88%B6"><span class="nav-number">4.1.8.</span> <span class="nav-text">对账机制</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%95%86%E5%93%81%E4%BF%A1%E6%81%AF%E7%BC%93%E5%AD%98%E5%92%8C%E6%95%B0%E6%8D%AE%E4%B8%80%E8%87%B4%E6%80%A7"><span class="nav-number">4.2.</span> <span class="nav-text">商品信息缓存和数据一致性</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%BB%E4%BB%8E%E6%9E%B6%E6%9E%84%E4%B8%AD%E5%A6%82%E4%BD%95%E8%8E%B7%E5%8F%96%E6%9C%80%E6%96%B0%E7%9A%84%E6%95%B0%E6%8D%AE%EF%BC%8C%E9%81%BF%E5%85%8D%E5%9B%A0%E4%B8%BA%E4%B8%BB%E4%BB%8E%E5%BB%B6%E6%97%B6%E5%AF%BC%E8%87%B4%E8%8E%B7%E5%BE%97%E8%84%8F%E6%95%B0%E6%8D%AE"><span class="nav-number">4.3.</span> <span class="nav-text">主从架构中如何获取最新的数据，避免因为主从延时导致获得脏数据</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%981-%E9%87%8D%E5%A4%8D%E4%B8%8B%E5%8D%95%E3%80%81%E6%94%AF%E4%BB%98%E3%80%81%E5%B1%A5%E7%BA%A6%E9%97%AE%E9%A2%98%EF%BC%88%E9%87%8D%E5%A4%8D%E5%92%8C%E5%B9%82%E7%AD%89%E9%97%AE%E9%A2%98"><span class="nav-number">4.4.</span> <span class="nav-text">常见问题1: 重复下单、支付、履约问题（重复和幂等问题)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BF%AB%E7%85%A7%E5%92%8C%E6%93%8D%E4%BD%9C%E6%97%A5%E5%BF%97"><span class="nav-number">4.5.</span> <span class="nav-text">快照和操作日志</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%983-%E5%B9%B6%E5%8F%91%E6%9B%B4%E6%96%B0%E7%9A%84ABA%E9%97%AE%E9%A2%98-%EF%BC%88%E8%AE%A2%E5%8D%95%E8%A1%A8%E7%9A%84version"><span class="nav-number">4.6.</span> <span class="nav-text">常见问题3: 并发更新的ABA问题 （订单表的version)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%A7%92%E6%9D%80%E7%B3%BB%E7%BB%9F%E4%B8%AD%E7%9A%84%E5%BA%93%E5%AD%98%E7%AE%A1%E7%90%86%E5%92%8C%E8%AE%A2%E5%8D%95%E8%93%84%E6%B4%AA"><span class="nav-number">4.7.</span> <span class="nav-text">秒杀系统中的库存管理和订单蓄洪</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%B4%AD%E7%89%A9%E8%BD%A6%E6%A8%A1%E5%9D%97%E7%9A%84%E5%AE%9E%E7%8E%B0%E5%92%8C%E4%BC%98%E5%8C%96"><span class="nav-number">4.8.</span> <span class="nav-text">购物车模块的实现和优化</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%B3%BB%E7%BB%9F%E4%B8%AD%E7%9A%84%E5%88%86%E5%B8%83%E5%BC%8FID%E6%98%AF%E6%80%8E%E4%B9%88%E7%94%9F%E6%88%90%E7%9A%84"><span class="nav-number">4.9.</span> <span class="nav-text">系统中的分布式ID是怎么生成的</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%B3%BB%E7%BB%9F%E7%A8%B3%E5%AE%9A%E6%80%A7%E5%BB%BA%E8%AE%BE"><span class="nav-number">5.</span> <span class="nav-text">系统稳定性建设</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Google-%E7%90%86%E8%AE%BA%EF%BC%9A%E6%80%8E%E6%A0%B7%E7%9A%84%E7%B3%BB%E7%BB%9F%E7%AE%97%E6%98%AF%E7%A8%B3%E5%AE%9A%E9%AB%98%E5%8F%AF%E7%94%A8%E7%9A%84"><span class="nav-number">5.1.</span> <span class="nav-text">Google 理论：怎样的系统算是稳定高可用的</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8F%AF%E8%A7%82%E6%B5%8B%E6%80%A7%E8%AE%BE%E8%AE%A1"><span class="nav-number">5.2.</span> <span class="nav-text">可观测性设计</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%9B%91%E6%8E%A7%E6%8C%87%E6%A0%87-%E5%AE%8C%E5%A4%87%E6%80%A7"><span class="nav-number">5.2.1.</span> <span class="nav-text">监控指标 - 完备性</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%91%8A%E8%AD%A6-%E5%AE%9E%E6%97%B6%E6%80%A7%E5%92%8C%E6%9C%89%E6%95%88%E6%80%A7"><span class="nav-number">5.2.2.</span> <span class="nav-text">告警 - 实时性和有效性</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%97%A5%E5%BF%97%E4%BD%93%E7%B3%BB"><span class="nav-number">5.2.3.</span> <span class="nav-text">日志体系</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%BF%BD%E8%B8%AA%E4%BD%93%E7%B3%BB"><span class="nav-number">5.2.4.</span> <span class="nav-text">追踪体系</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BC%82%E5%B8%B8%E5%BA%94%E6%80%A5%E7%AD%96%E7%95%A5"><span class="nav-number">5.3.</span> <span class="nav-text">异常应急策略</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%99%8D%E7%BA%A7%E7%AD%96%E7%95%A5"><span class="nav-number">5.3.1.</span> <span class="nav-text">降级策略</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%99%90%E6%B5%81%E7%AD%96%E7%95%A5"><span class="nav-number">5.3.2.</span> <span class="nav-text">限流策略</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%86%94%E6%96%AD%E7%AD%96%E7%95%A5"><span class="nav-number">5.3.3.</span> <span class="nav-text">熔断策略</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%A1%A5%E5%81%BF%E7%AD%96%E7%95%A5"><span class="nav-number">5.3.4.</span> <span class="nav-text">补偿策略</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%BB%84%E5%90%88%E7%AD%96%E7%95%A5"><span class="nav-number">5.3.5.</span> <span class="nav-text">组合策略</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%85%B6%E5%AE%83%E4%B8%9A%E5%8A%A1%E7%AD%96%E7%95%A5%EF%BC%9A"><span class="nav-number">5.3.6.</span> <span class="nav-text">其它业务策略：</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%9A%E5%8A%A1%E5%92%8C%E5%AE%B9%E9%87%8F%E8%A7%84%E5%88%92"><span class="nav-number">5.4.</span> <span class="nav-text">业务和容量规划</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%B8%9A%E5%8A%A1%E7%AD%96%E7%95%A5"><span class="nav-number">5.4.1.</span> <span class="nav-text">业务策略</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%B5%81%E9%87%8F%E6%A8%A1%E5%9E%8B%E8%AF%84%E4%BC%B0"><span class="nav-number">5.4.2.</span> <span class="nav-text">流量模型评估</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%B9%E9%87%8F%E8%BD%AC%E5%8C%96"><span class="nav-number">5.4.3.</span> <span class="nav-text">容量转化</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%85%A8%E9%93%BE%E8%B7%AF%E5%8E%8B%E6%B5%8B"><span class="nav-number">5.4.4.</span> <span class="nav-text">全链路压测</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%88%90%E6%9C%AC%E4%BC%98%E5%8C%96"><span class="nav-number">5.4.5.</span> <span class="nav-text">成本优化</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%A0%94%E5%8F%91%E6%B5%81%E7%A8%8B%E8%A7%84%E8%8C%83"><span class="nav-number">5.5.</span> <span class="nav-text">研发流程规范</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%AB%98%E5%8F%AF%E7%94%A8%E7%9A%84%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1"><span class="nav-number">5.6.</span> <span class="nav-text">高可用的架构设计</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%95%B4%E4%BD%93%E6%9E%B6%E6%9E%84"><span class="nav-number">5.6.1.</span> <span class="nav-text">整体架构</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%BA%94%E7%94%A8%E5%B1%82%E6%9E%B6%E6%9E%84"><span class="nav-number">5.6.2.</span> <span class="nav-text">应用层架构</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%B3%BB%E7%BB%9F%E9%93%BE%E8%B7%AF%E6%A2%B3%E7%90%86%E5%92%8C%E7%BB%B4%E6%8A%A4-System-Biz-Profiling"><span class="nav-number">5.6.3.</span> <span class="nav-text">系统链路梳理和维护 System &amp; Biz Profiling</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%B5%84%E6%8D%9F%E9%98%B2%E6%8E%A7%E6%9E%B6%E6%9E%84"><span class="nav-number">5.6.4.</span> <span class="nav-text">资损防控架构</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%AE%9A%E6%9C%9Freview%E8%B5%84%E6%8D%9F%E9%A3%8E%E9%99%A9"><span class="nav-number">5.6.4.1.</span> <span class="nav-text">定期review资损风险</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E4%BA%8B%E4%B8%AD%E5%8F%8A%E6%97%B6%E5%8F%91%E7%8E%B0"><span class="nav-number">5.6.4.2.</span> <span class="nav-text">事中及时发现</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E4%BA%8B%E5%90%8E%E5%A4%8D%E7%9B%98%E5%92%8C%E7%9F%A5%E8%AF%86%E6%B2%89%E6%B7%80"><span class="nav-number">5.6.4.3.</span> <span class="nav-text">事后复盘和知识沉淀</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96"><span class="nav-number">5.7.</span> <span class="nav-text">性能优化</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%85%B6%E5%AE%83%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98"><span class="nav-number">6.</span> <span class="nav-text">其它常见问题</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5%E4%B8%8E%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1"><span class="nav-number">6.1.</span> <span class="nav-text">基础概念与架构设计</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%95%86%E5%93%81%E7%AE%A1%E7%90%86"><span class="nav-number">6.2.</span> <span class="nav-text">商品管理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%AE%A2%E5%8D%95%E7%AE%A1%E7%90%86"><span class="nav-number">6.3.</span> <span class="nav-text">订单管理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%94%A8%E6%88%B7%E4%B8%8E%E8%B4%A6%E6%88%B7%E7%AE%A1%E7%90%86"><span class="nav-number">6.4.</span> <span class="nav-text">用户与账户管理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BA%93%E5%AD%98%E7%AE%A1%E7%90%86"><span class="nav-number">6.5.</span> <span class="nav-text">库存管理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%94%AF%E4%BB%98%E4%B8%8E%E7%BB%93%E7%AE%97"><span class="nav-number">6.6.</span> <span class="nav-text">支付与结算</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%89%A9%E6%B5%81%E4%B8%8E%E4%BE%9B%E5%BA%94%E9%93%BE"><span class="nav-number">6.7.</span> <span class="nav-text">物流与供应链</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%90%A5%E9%94%80%E4%B8%8E%E4%BF%83%E9%94%80"><span class="nav-number">6.8.</span> <span class="nav-text">营销与促销</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E7%BB%9F%E8%AE%A1%E4%B8%8E%E5%88%86%E6%9E%90"><span class="nav-number">6.9.</span> <span class="nav-text">数据统计与分析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%B6%E4%BB%96%E7%BB%BC%E5%90%88%E9%97%AE%E9%A2%98"><span class="nav-number">6.10.</span> <span class="nav-text">其他综合问题</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%82%E8%80%83"><span class="nav-number">7.</span> <span class="nav-text">参考:</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="wxquare"
      src="/images/avatar.jpeg">
  <p class="site-author-name" itemprop="name">wxquare</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">32</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">3</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/yourname" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;yourname" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="/xianguiwang0316@gmail.com" title="E-Mail → xianguiwang0316@gmail.com" rel="noopener me"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2025/05/01/system-design/13-e-commerce/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpeg">
      <meta itemprop="name" content="wxquare">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="wxquare's Blogs">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="互联网业务系统 - 电商系统设计 | wxquare's Blogs">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          互联网业务系统 - 电商系统设计
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2025-05-01 00:00:00" itemprop="dateCreated datePublished" datetime="2025-05-01T00:00:00+08:00">2025-05-01</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-08-26 12:10:31" itemprop="dateModified" datetime="2025-08-26T12:10:31+08:00">2025-08-26</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/" itemprop="url" rel="index"><span itemprop="name">系统设计</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><h2 id="电商系统整体架构设计"><a href="#电商系统整体架构设计" class="headerlink" title="电商系统整体架构设计"></a>电商系统整体架构设计</h2><h3 id="业务流-business-process"><a href="#业务流-business-process" class="headerlink" title="业务流 (business process)"></a>业务流 (business process)</h3><p align="center">
  <img src="/images/E-commerce-whole-business-process.webp" width=800 height=500>
  <br/>
  <strong><a href="https://axureboutique.com/blogs/product-design/understanding-the-structure-of-e-commerce-products">E-commerce process</a></strong>
</p>

<h3 id="系统流-system-process"><a href="#系统流-system-process" class="headerlink" title="系统流 (system process)"></a>系统流 (system process)</h3><p align="center">
  <img src="/images/E-commerce-whole-system-process.webp" width=800 height=500>
  <br/>
  <strong><a href="https://axureboutique.com/blogs/product-design/understanding-the-structure-of-e-commerce-products">E-commerce whole process of system</a></strong>
</p>

<h3 id="产品架构-Product-Structure-组织架构"><a href="#产品架构-Product-Structure-组织架构" class="headerlink" title="产品架构 (Product Structure&#x2F;组织架构)"></a>产品架构 (Product Structure&#x2F;组织架构)</h3><p align="center">
  <img src="/images/E-commerce-product-structure.webp" width=800 height=600>
  <br/>
  <strong><a href="https://axureboutique.com/blogs/product-design/understanding-the-structure-of-e-commerce-products">E-commerce product structure</a></strong>
</p>

<h3 id="应用架构"><a href="#应用架构" class="headerlink" title="应用架构"></a>应用架构</h3><p align="center">
  <img src="/images/application-architecture.png" width=700 height=550>
</p>

<h3 id="技术架构"><a href="#技术架构" class="headerlink" title="技术架构"></a>技术架构</h3><p align="center">
  <img src="/images/14-e-commerce-tech-architecture-mindmap.png" width=700 height=1400>
</p>

<h3 id="数据架构"><a href="#数据架构" class="headerlink" title="数据架构"></a>数据架构</h3><h2 id="商品管理-Product-Center"><a href="#商品管理-Product-Center" class="headerlink" title="商品管理 Product Center"></a>商品管理 Product Center</h2><h3 id="商品信息包括哪些内容"><a href="#商品信息包括哪些内容" class="headerlink" title="商品信息包括哪些内容"></a>商品信息包括哪些内容</h3><p align="center">
  <img src="/images/item-info.png" width=700 height=600>
</p>

<h3 id="商品系统的演进"><a href="#商品系统的演进" class="headerlink" title="商品系统的演进"></a>商品系统的演进</h3><table>
<thead>
<tr>
<th>阶段</th>
<th>主要特征&#x2F;能力</th>
<th>技术架构&#x2F;数据模型</th>
<th>适用场景&#x2F;目标</th>
<th>实现方式简单说明</th>
</tr>
</thead>
<tbody><tr>
<td>初始阶段</td>
<td>- 商品信息简单，字段少<br>- SKU&#x2F;SPU未严格区分<br>- 价格库存直接在商品表<br>- 仅支持基本的增删改查</td>
<td>单表&#x2F;简单表结构</td>
<td>小型电商、业务初期，SKU数量少</td>
<td>单体应用，单表存储，简单业务逻辑，直接数据库操作</td>
</tr>
<tr>
<td>成长阶段</td>
<td>- 引入SPU&#x2F;SKU模型<br>- 属性、类目、品牌等实体独立<br>- 支持多规格商品<br>- 价格库存可拆分为独立表</td>
<td>关系型数据库，ER模型优化</td>
<td>SKU多样化，品类扩展，业务快速增长</td>
<td>关系型数据库，ER模型优化，多表存储，业务逻辑复杂</td>
</tr>
<tr>
<td>成熟阶段</td>
<td>- 商品中台化，支持多业务线&#x2F;多渠道<br>- 属性体系灵活可扩展<br>- 多级类目、标签、图片、描述等丰富<br>- 商品快照、操作日志、版本控制</td>
<td>中台架构，微服务&#x2F;多表&#x2F;NoSQL</td>
<td>大型平台，业务复杂，需支撑多业务场景</td>
<td>分布式服务，插件化&#x2F;配置化流程，状态机驱动，异步消息，灵活数据模型</td>
</tr>
<tr>
<td>未来演进</td>
<td>- 多语言多币种支持<br>- 商品内容多媒体化（视频、3D等）<br>- AI智能标签&#x2F;推荐<br>- 商品数据实时分析与洞察</td>
<td>分布式&#x2F;云原生&#x2F;大数据平台</td>
<td>国际化、智能化、数据驱动的电商生态</td>
<td>云原生架构，AI&#x2F;大数据分析，自动化运维，弹性伸缩，智能路由与风控</td>
</tr>
</tbody></table>
<h3 id="什么是SPU、SKU"><a href="#什么是SPU、SKU" class="headerlink" title="什么是SPU、SKU"></a>什么是SPU、SKU</h3><p>方案一：同时创建多个SKU，并同步生成关联的SPU。整体方案是直接创建SKU，并维护多个不同的属性；该方案适用于大多数C2C综合电商平台（例如，阿里巴巴就是采用这种方式创建商品）。<br>方案二：先创建SPU，再根据SPU创建SKU。整体方案是由平台的主数据团队负责维护SPU，商家（包括自营和POP）根据SPU维护SKU。在创建SKU时，首先选择SPU（SPU中的基本属性由数据团队维护），然后基于SPU维护销售属性和物流属性，最后生成SKU；该方案适用于高度专业化的垂直B2B行业，如汽车、医药等。<br>这两种方案的原因是：垂直B2B平台上的业务（传统行业、年长的商家）操作能力有限，维护产品属性的错误率远高于C2C平台，同时平台对产品结构控制的要求较高。为了避免同一产品被不同商家维护成多个不同的属性（例如，汽车轮胎的胎面宽度、尺寸等属性），平台通常选择专门的数据团队来维护产品的基本属性，即维护SPU。<br>此外，B2B垂直电商的品类较少，SKU数量相对较小，品类标准化程度高，平台统一维护的可行性较高。<br>对于拥有成千上万品类的综合电商平台，依靠平台数据团队的统一维护是不现实的，或者像服装这样非标准化的品类对商品结构化管理的要求较低。因此，综合平台（阿里巴巴和亚马逊）的设计方向与垂直平台有所不同。<br>实际上，即使对于综合平台，不同的品类也会有不同的设计方法。一些品类具有垂直深度，因此也采用平台维护SPU和商家创建SKU的方式</p>
<h3 id="数据库模型"><a href="#数据库模型" class="headerlink" title="数据库模型"></a>数据库模型</h3><ul>
<li>类目category</li>
<li>品牌brand</li>
<li>属性attribute</li>
<li>标签tag</li>
<li>商品主表&#x2F;spu表&#x2F;item表、item_stat 统计表、item属性值表</li>
<li>商品变体表&#x2F;variant表&#x2F;sku表、sku attribute表</li>
<li>其它实体表、其它实体和商品表的关联表</li>
</ul>
<p align="center">
  <img src="/images/product_ER.png" width=700 height=700>
  <br/>
  <strong><a href="https://axureboutique.com/blogs/product-design/build-an-e-commerce-product-center-from-scratch">E-commerce product center</a></strong>
</p>

<h4 id="模型说明："><a href="#模型说明：" class="headerlink" title="模型说明："></a>模型说明：</h4><ul>
<li>商品（item&#x2F;SPU）与商品变体（sku）分离，便于管理不同规格、价格、库存的商品。</li>
<li>属性（attribute）、类目（category）、品牌（brand）等实体独立，便于扩展和维护</li>
<li>商品分类体系如何设计？采用多级分类？分类的动态扩展只需插入新分类，指定其 parent_id，即可动态扩展任意层级</li>
<li>灵活的属性体系。通过 category_attribute 和 spu_attr_value 支持不同类目下的不同属性，适应多样化商品需求。属性值与商品解耦，支持动态扩展</li>
<li>item_stat 单独存储统计信息，便于高并发下的读写优化。</li>
<li>可以方便地增加标签（tag）、图片、描述、规格等字段，适应业务变化</li>
</ul>
<h4 id="商品信息录入JSON示例"><a href="#商品信息录入JSON示例" class="headerlink" title="商品信息录入JSON示例"></a>商品信息录入JSON示例</h4><h5 id="实体商品"><a href="#实体商品" class="headerlink" title="实体商品"></a>实体商品</h5><details>
<summary>1、实体商品男士T恤 JSON 数据</summary>
<pre><code class="json">
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;categoryId&quot;</span><span class="punctuation">:</span> <span class="number">1003001</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;spu&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;经典圆领男士T恤&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;brandId&quot;</span><span class="punctuation">:</span> <span class="number">2001</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;柔软舒适，100%纯棉&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;basicAttributes&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;attributeId&quot;</span><span class="punctuation">:</span> <span class="number">101</span><span class="punctuation">,</span>         <span class="comment">// 品牌</span></span><br><span class="line">      <span class="attr">&quot;attributeName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;品牌&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="string">&quot;NIKE&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;attributeId&quot;</span><span class="punctuation">:</span> <span class="number">102</span><span class="punctuation">,</span>         <span class="comment">// 材质</span></span><br><span class="line">      <span class="attr">&quot;attributeName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;材质&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="string">&quot;棉&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;attributeId&quot;</span><span class="punctuation">:</span> <span class="number">103</span><span class="punctuation">,</span>         <span class="comment">// 产地</span></span><br><span class="line">      <span class="attr">&quot;attributeName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;产地&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="string">&quot;中国&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;attributeId&quot;</span><span class="punctuation">:</span> <span class="number">104</span><span class="punctuation">,</span>         <span class="comment">// 袖型</span></span><br><span class="line">      <span class="attr">&quot;attributeName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;袖型&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="string">&quot;短袖&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;skus&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;skuName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;黑色 L&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;price&quot;</span><span class="punctuation">:</span> <span class="number">79.00</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;stock&quot;</span><span class="punctuation">:</span> <span class="number">100</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;salesAttributes&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;attributeId&quot;</span><span class="punctuation">:</span> <span class="number">201</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;attributeName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;颜色&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="string">&quot;黑色&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;attributeId&quot;</span><span class="punctuation">:</span> <span class="number">202</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;attributeName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;尺码&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="string">&quot;L&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;skuName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;白色 M&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;price&quot;</span><span class="punctuation">:</span> <span class="number">79.00</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;stock&quot;</span><span class="punctuation">:</span> <span class="number">150</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;salesAttributes&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;attributeId&quot;</span><span class="punctuation">:</span> <span class="number">201</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;attributeName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;颜色&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="string">&quot;白色&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;attributeId&quot;</span><span class="punctuation">:</span> <span class="number">202</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;attributeName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;尺码&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="string">&quot;M&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
</code></pre>
</details> 

<h5 id="虚拟商品"><a href="#虚拟商品" class="headerlink" title="虚拟商品"></a>虚拟商品</h5><details>
<summary>2、虚拟商品流量充值 JSON 数据</summary>
<pre><code class="json">
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;categoryId&quot;</span><span class="punctuation">:</span> <span class="number">1005002</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;spu&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;中国移动流量包充值&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;brandId&quot;</span><span class="punctuation">:</span> <span class="number">3001</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;全国通用流量包充值，按需选择，自动到账&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;basicAttributes&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;attributeId&quot;</span><span class="punctuation">:</span> <span class="number">301</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;attributeName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;运营商&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="string">&quot;中国移动&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;attributeId&quot;</span><span class="punctuation">:</span> <span class="number">302</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;attributeName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;适用网络&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="string">&quot;4G/5G&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;skus&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;skuName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;中国移动1GB全国流量包（7天）&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;price&quot;</span><span class="punctuation">:</span> <span class="number">5.00</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;stock&quot;</span><span class="punctuation">:</span> <span class="number">9999</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;salesAttributes&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;attributeId&quot;</span><span class="punctuation">:</span> <span class="number">401</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;attributeName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;流量容量&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1GB&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;attributeId&quot;</span><span class="punctuation">:</span> <span class="number">402</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;attributeName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;有效期&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="string">&quot;7天&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;attributeId&quot;</span><span class="punctuation">:</span> <span class="number">403</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;attributeName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;流量类型&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="string">&quot;全国通用&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;skuName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;中国移动5GB全国流量包（30天）&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;price&quot;</span><span class="punctuation">:</span> <span class="number">20.00</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;stock&quot;</span><span class="punctuation">:</span> <span class="number">9999</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;salesAttributes&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;attributeId&quot;</span><span class="punctuation">:</span> <span class="number">401</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;attributeName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;流量容量&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="string">&quot;5GB&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;attributeId&quot;</span><span class="punctuation">:</span> <span class="number">402</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;attributeName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;有效期&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="string">&quot;30天&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;attributeId&quot;</span><span class="punctuation">:</span> <span class="number">403</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;attributeName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;流量类型&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="string">&quot;全国通用&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;skuName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;中国移动10GB全国流量包（90天）&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;price&quot;</span><span class="punctuation">:</span> <span class="number">38.00</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;stock&quot;</span><span class="punctuation">:</span> <span class="number">9999</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;salesAttributes&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;attributeId&quot;</span><span class="punctuation">:</span> <span class="number">401</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;attributeName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;流量容量&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="string">&quot;10GB&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;attributeId&quot;</span><span class="punctuation">:</span> <span class="number">402</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;attributeName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;有效期&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="string">&quot;90天&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;attributeId&quot;</span><span class="punctuation">:</span> <span class="number">403</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;attributeName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;流量类型&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="string">&quot;全国通用&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
</code></pre>
</details> 

<h4 id="商品的价格和库存"><a href="#商品的价格和库存" class="headerlink" title="商品的价格和库存"></a>商品的价格和库存</h4><h5 id="方案1-价格和库存直接放在sku表中-（变化小）"><a href="#方案1-价格和库存直接放在sku表中-（变化小）" class="headerlink" title="方案1. 价格和库存直接放在sku表中 （变化小）"></a>方案1. 价格和库存直接放在sku表中 （变化小）</h5><p>在这种方案中，SKU（Stock Keeping Unit） 表包含商品的所有信息，包括价格和库存数量。每个 SKU 记录一个独立的商品实例，它有唯一的标识符，直接关联价格和库存。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> sku_tab (</span><br><span class="line">    sku_id <span class="type">INT</span> <span class="keyword">PRIMARY</span> KEY,             <span class="comment">-- SKU ID</span></span><br><span class="line">    product_id <span class="type">INT</span>,                     <span class="comment">-- 商品ID (外键，指向商品表)</span></span><br><span class="line">    sku_name <span class="type">VARCHAR</span>(<span class="number">255</span>),              <span class="comment">-- SKU 名称</span></span><br><span class="line">    original_price <span class="type">DECIMAL</span>(<span class="number">10</span>, <span class="number">2</span>),      <span class="comment">-- 原始价格</span></span><br><span class="line">    price <span class="type">DECIMAL</span>(<span class="number">10</span>, <span class="number">2</span>),               <span class="comment">-- 销售价格</span></span><br><span class="line">    discount_price <span class="type">DECIMAL</span>(<span class="number">10</span>, <span class="number">2</span>),      <span class="comment">-- 折扣价格（如果有）</span></span><br><span class="line">    stock_quantity <span class="type">INT</span>,                 <span class="comment">-- 库存数量</span></span><br><span class="line">    warehouse_id <span class="type">INT</span>,                   <span class="comment">-- 仓库ID（如果有多个仓库）</span></span><br><span class="line">    created_at <span class="type">TIMESTAMP</span>,               <span class="comment">-- 创建时间</span></span><br><span class="line">    updated_at <span class="type">TIMESTAMP</span>                <span class="comment">-- 更新时间</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>优点：</p>
<ul>
<li>简单：所有信息都集中在一个表中，查询和管理都很方便。</li>
<li>查询效率：查询某个商品的价格和库存不需要多表联接，减少了数据库查询的复杂度。</li>
<li>维护方便：商品的所有信息（包括价格和库存）都在一个地方，减少了冗余数据和数据不一致的可能性。</li>
</ul>
<p>缺点：</p>
<ul>
<li>灵活性差：如果价格和库存的管理策略较复杂（如促销、库存管理、动态定价等），这种方式可能不太适用。修改价格或库存时需要直接更新 SKU 表。</li>
<li>扩展性差：对于一些复杂的定价和库存管理需求（如多层次的定价结构、分仓库管理等），直接放在 SKU 表中可能不够灵活。</li>
</ul>
<p>适用场景：</p>
<ul>
<li>商品种类较少，SKU 数量相对固定且不复杂的场景。</li>
<li>价格和库存变动较少，不涉及复杂的促销或动态定价的场景</li>
</ul>
<h5 id="方案2-价格和库存单独管理（变化大）"><a href="#方案2-价格和库存单独管理（变化大）" class="headerlink" title="方案2. 价格和库存单独管理（变化大）"></a>方案2. 价格和库存单独管理（变化大）</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> price_tab (</span><br><span class="line">    price_id <span class="type">INT</span> <span class="keyword">PRIMARY</span> KEY,         <span class="comment">-- 价格ID</span></span><br><span class="line">    sku_id <span class="type">INT</span>,                       <span class="comment">-- SKU ID (外键)</span></span><br><span class="line">    price <span class="type">DECIMAL</span>(<span class="number">10</span>, <span class="number">2</span>),             <span class="comment">-- 商品价格</span></span><br><span class="line">    discount_price <span class="type">DECIMAL</span>(<span class="number">10</span>, <span class="number">2</span>),    <span class="comment">-- 折扣价格</span></span><br><span class="line">    effective_date <span class="type">TIMESTAMP</span>,         <span class="comment">-- 价格生效时间</span></span><br><span class="line">    expiry_date <span class="type">TIMESTAMP</span>,            <span class="comment">-- 价格失效时间</span></span><br><span class="line">    price_type <span class="type">VARCHAR</span>(<span class="number">50</span>),           <span class="comment">-- 价格类型（如标准价、促销价等）</span></span><br><span class="line">    <span class="keyword">FOREIGN</span> KEY (sku_id) <span class="keyword">REFERENCES</span> ProductSKUs(sku_id)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> inventory_tab (</span><br><span class="line">    inventory_id <span class="type">INT</span> <span class="keyword">PRIMARY</span> KEY,     <span class="comment">-- 库存ID</span></span><br><span class="line">    sku_id <span class="type">INT</span>,                        <span class="comment">-- SKU ID (外键)</span></span><br><span class="line">    quantity <span class="type">INT</span>,                      <span class="comment">-- 库存数量</span></span><br><span class="line">    warehouse_id <span class="type">INT</span>,                  <span class="comment">-- 仓库ID（如果有多个仓库）</span></span><br><span class="line">    updated_at <span class="type">TIMESTAMP</span>,              <span class="comment">-- 库存更新时间</span></span><br><span class="line">    <span class="keyword">FOREIGN</span> KEY (sku_id) <span class="keyword">REFERENCES</span> ProductSKUs(sku_id)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p>优点：</p>
<ul>
<li>灵活性高：价格和库存信息可以独立管理，更容易支持多样化的定价策略、促销活动、库存管理等。</li>
<li>可扩展性强：对于需要频繁更新价格、库存、促销等信息的商品，这种方案更容易扩展和适应变化。例如，可以灵活地增加新的价格策略或库存仓库。</li>
<li>数据结构清晰：避免了价格和库存在 SKU 表中的冗余存储，使得数据结构更清晰。</li>
</ul>
<p>缺点：</p>
<ul>
<li>查询复杂：获取某个商品的价格和库存信息时，需要联接多个表，查询效率可能会降低，尤其是在数据量大时。</li>
<li>管理复杂：需要更多的表和关系，增加了维护成本和系统复杂度。</li>
</ul>
<p>适用场景：</p>
<ul>
<li>商品种类繁多，SKU 数量较大，且需要支持动态定价、促销、库存管理等复杂需求的场景。</li>
<li>需要频繁变动价格或库存的商品，且这些信息与 SKU 无法紧密绑定的场景</li>
</ul>
<h4 id="商品快照-item-snapshots"><a href="#商品快照-item-snapshots" class="headerlink" title="商品快照 item_snapshots"></a>商品快照 item_snapshots</h4><ol>
<li>商品编辑时生成快照:</li>
</ol>
<ul>
<li>每次商品信息（如价格、描述、属性等）发生编辑时，生成一个新的商品快照。</li>
<li>将快照信息存储在 item_snapshots 表中，并生成一个唯一的 snapshot_id。</li>
</ul>
<ol start="2">
<li>订单创建时使用快照:<br>在用户下单时，查找当前商品的最新 snapshot_id。<br>在 order_items 表中记录该 snapshot_id，以确保订单项反映下单时的商品状态<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `snapshot_tab` (</span><br><span class="line">  `snapshot_id` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  `snapshot_type` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>, </span><br><span class="line">  `create_time` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span>,</span><br><span class="line">  `data` text <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `entity_id` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`snapshot_id`),</span><br><span class="line">  KEY `idx_entity_id` (`entity_id`)</span><br><span class="line">) </span><br></pre></td></tr></table></figure></li>
</ol>
<h4 id="用户操作日志"><a href="#用户操作日志" class="headerlink" title="用户操作日志"></a>用户操作日志</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> user_operation_logs (</span><br><span class="line">  log_id <span class="type">INT</span> <span class="keyword">PRIMARY</span> KEY AUTO_INCREMENT,  <span class="comment">-- Unique identifier for each log entry</span></span><br><span class="line">  user_id <span class="type">INT</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>,                   <span class="comment">-- ID of the user who made the edit</span></span><br><span class="line">  entity_id <span class="type">INT</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>,                 <span class="comment">-- ID of the entity being edited</span></span><br><span class="line">  entity_type <span class="type">VARCHAR</span>(<span class="number">50</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,       <span class="comment">-- Type of entity (e.g., SPU, SKU, Price, Stock)</span></span><br><span class="line">  operation_type <span class="type">VARCHAR</span>(<span class="number">50</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,    <span class="comment">-- Type of operation (e.g., CREATE, UPDATE, DELETE)</span></span><br><span class="line">  <span class="type">timestamp</span> <span class="type">TIMESTAMP</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span>,  <span class="comment">-- Time of the operation</span></span><br><span class="line">  details TEXT,                           <span class="comment">-- Additional details about the operation</span></span><br><span class="line">  <span class="keyword">FOREIGN</span> KEY (user_id) <span class="keyword">REFERENCES</span> users(id)  <span class="comment">-- Assuming a users table exists</span></span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4;</span><br></pre></td></tr></table></figure>
<h4 id="商品的统计信息"><a href="#商品的统计信息" class="headerlink" title="商品的统计信息"></a>商品的统计信息</h4><h3 id="缓存的使用"><a href="#缓存的使用" class="headerlink" title="缓存的使用"></a>缓存的使用</h3><h3 id="核心流程"><a href="#核心流程" class="headerlink" title="核心流程"></a>核心流程</h3><h4 id="B端：商品创建和发布的流程"><a href="#B端：商品创建和发布的流程" class="headerlink" title="B端：商品创建和发布的流程"></a>B端：商品创建和发布的流程</h4><ul>
<li>批量上传、批量编辑</li>
<li>单个上传、编辑</li>
<li>审核、发布</li>
<li>OpenAPI，支持外部同步API push 商品</li>
<li>auto-sync，自动同步外部商品</li>
</ul>
<h4 id="C端：商品搜索、商品详情"><a href="#C端：商品搜索、商品详情" class="headerlink" title="C端：商品搜索、商品详情"></a>C端：商品搜索、商品详情</h4><ul>
<li>商品搜索<ul>
<li>elastic search 索引构建。获取商品列表(首页索引)</li>
<li>如何处理商品的SEO优化？<details>
<summary>1、item index</summary>
<pre><code class="json">
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">POST /products/_doc/<span class="number">1</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;product_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;123456&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Wireless Bluetooth Headphones&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;High-quality wireless headphones with noise-cancellation.&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;price&quot;</span><span class="punctuation">:</span> <span class="number">99.99</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;stock&quot;</span><span class="punctuation">:</span> <span class="number">50</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;category&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Electronics&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;brand&quot;</span><span class="punctuation">:</span> <span class="string">&quot;SoundMax&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;sku&quot;</span><span class="punctuation">:</span> <span class="string">&quot;SM-123&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;spu&quot;</span><span class="punctuation">:</span> <span class="string">&quot;SPU-456&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;image_urls&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="string">&quot;http://example.com/images/headphones1.jpg&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="string">&quot;http://example.com/images/headphones2.jpg&quot;</span></span><br><span class="line">  <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;ratings&quot;</span><span class="punctuation">:</span> <span class="number">4.5</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;seller_info&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;seller_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;78910&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;seller_name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;BestSeller&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;attributes&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;color&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Black&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Standard&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;material&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Plastic&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;release_date&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2023-01-15&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;location&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;lat&quot;</span><span class="punctuation">:</span> <span class="number">40.7128</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;lon&quot;</span><span class="punctuation">:</span> <span class="number">-74.0060</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;tags&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;headphones&quot;</span><span class="punctuation">,</span> <span class="string">&quot;bluetooth&quot;</span><span class="punctuation">,</span> <span class="string">&quot;wireless&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;promotional_info&quot;</span><span class="punctuation">:</span> <span class="string">&quot;20% off for a limited time&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
</code></pre>
</details></li>
</ul>
</li>
<li>商品推荐<ul>
<li>商品的A&#x2F;B测试如何设计？</li>
<li>如何设计商品的推荐算法？</li>
<li>商品的个性化定制如何实现？</li>
</ul>
</li>
<li>获取商品详情</li>
</ul>
<h2 id="订单管理-Order-Center"><a href="#订单管理-Order-Center" class="headerlink" title="订单管理 Order Center"></a>订单管理 Order Center</h2><p><a href="https://www.woshipm.com/pd/753646.html">订单系统，平台的”生命中轴线”</a></p>
<h3 id="订单中需要包含哪些信息"><a href="#订单中需要包含哪些信息" class="headerlink" title="订单中需要包含哪些信息"></a>订单中需要包含哪些信息</h3><p align="center">
  <img src="/images/order_content.webp" width=800 height=500>
</p>

<h3 id="常见的订单类型"><a href="#常见的订单类型" class="headerlink" title="常见的订单类型"></a>常见的订单类型</h3><ol>
<li><p>实物订单<br>典型场景：电商平台购物（如买衣服、家电）<br>核心特征：<br>需要物流配送，涉及收货地址、运费、物流跟踪<br>需要库存校验与扣减<br>售后流程（退货、换货、退款）复杂<br>订单状态多（待发货、已发货、已收货等）</p>
</li>
<li><p>虚拟订单<br>典型场景：会员卡、电子券、游戏点卡、电影票等<br>核心特征：<br>无物流配送，不需要收货地址和运费<br>通常无需库存（或库存为虚拟库存）<br>订单完成后直接发放虚拟物品或凭证<br>售后流程简单或无售后</p>
</li>
<li><p>预售订单<br>典型场景：新品预售、定金膨胀、众筹等<br>核心特征：<br>订单分为定金和尾款两阶段<br>需校验定金支付、尾款支付的时效<br>可能涉及定金不退、尾款未付订单自动关闭等规则<br>发货时间通常在尾款支付后</p>
</li>
<li><p>O2O订单，外卖订单<br>典型场景：酒店预订<br>核心特征：<br>需选择入住&#x2F;离店日期、房型、入住人信息<br>需对接第三方酒店系统实时查房、锁房<br>取消、变更政策复杂，可能涉及违约金<br>无物流，但有电子凭证或入住确认</p>
</li>
</ol>
<h3 id="订单系统的演进"><a href="#订单系统的演进" class="headerlink" title="订单系统的演进"></a>订单系统的演进</h3><table>
<thead>
<tr>
<th>阶段</th>
<th>主要特征&#x2F;能力</th>
<th>技术架构&#x2F;数据模型</th>
<th>适用场景&#x2F;目标</th>
<th>实现方式简单说明</th>
</tr>
</thead>
<tbody><tr>
<td>初始阶段</td>
<td>- 实现订单基本流转（下单、支付、发货、收货、取消）<br>- 单一订单类型（实物订单）<br>- 订单与商品、用户简单关联</td>
<td>单体应用&#x2F;单表或少量表结构</td>
<td>业务初期，订单量小，流程简单，SKU&#x2F;商家数量有限</td>
<td>单体应用，单表存储，简单业务逻辑，直接数据库操作</td>
</tr>
<tr>
<td>成长阶段（订单中心）</td>
<td>- 支持订单拆单、合单（如多仓发货、合并支付）<br>- 支持多品类订单（如实物+虚拟）<br>- 订单中心化，订单与支付、配送、售后等子系统解耦<br>- 订单与商品快照、操作日志关联</td>
<td>微服务&#x2F;多表&#x2F;订单中心架构</td>
<td>平台型电商，业务扩展，需支持多商家、多类型订单，订单量大幅增长</td>
<td>订单中心服务，微服务拆分，多表关联，服务间接口调用，快照与日志表设计</td>
</tr>
<tr>
<td>成熟期（平台化）</td>
<td>- 支持多样化订单类型（预售、虚拟、O2O、定制、JIT等）<br>- 订单流程可配置&#x2F;插件化&#x2F;工作流引擎&#x2F;状态机框架&#x2F;规则引擎等<br>- 订单状态机、履约、支付、退款等子流程解耦<br>- 支持复杂的促销、分账、履约模式</td>
<td>分布式&#x2F;服务化&#x2F;灵活数据模型</td>
<td>大型&#x2F;综合电商，业务复杂，需快速适应新业务模式和高并发场景</td>
<td>分布式服务，插件化&#x2F;配置化流程，状态机驱动，异步消息，灵活数据模型</td>
</tr>
<tr>
<td>未来智能化</td>
<td>- 订单智能路由与分配（如智能分仓、智能客服）<br>- 实时风控与反欺诈<br>- 订单数据实时分析与洞察<br>- 高可用、弹性伸缩、自动化运维</td>
<td>云原生&#x2F;大数据&#x2F;AI驱动架构</td>
<td>超大规模平台，国际化、智能化、数据驱动，需极致稳定与创新能力</td>
<td>云原生架构，AI&#x2F;大数据分析，自动化运维，弹性伸缩，智能路由与风控</td>
</tr>
</tbody></table>
<h3 id="常见的订单模型设计"><a href="#常见的订单模型设计" class="headerlink" title="常见的订单模型设计"></a>常见的订单模型设计</h3><p align="center">
  <img src="/images/order_er.png" width=800 height=600>
</p>

<h4 id="订单表（order-tab）：记录用户的购买订单信息。主键为-order-id。"><a href="#订单表（order-tab）：记录用户的购买订单信息。主键为-order-id。" class="headerlink" title="订单表（order_tab）：记录用户的购买订单信息。主键为 order_id。"></a>订单表（order_tab）：记录用户的购买订单信息。主键为 order_id。</h4><ul>
<li>pay_order_id：支付订单ID，作为外键关联支付订单。</li>
<li>user_id：用户ID，标识购买订单的用户。</li>
<li>total_amount：订单的总金额。</li>
<li>order_status：订单状态，如已完成、已取消等。</li>
<li>payment_status：支付状态，与支付订单相关。</li>
<li>fulfillment_status：履约状态，表示订单的配送或服务状态。</li>
<li>refund_status：退款状态，用于标识订单是否有退款</li>
</ul>
<h4 id="订单商品表（order-item-tab：记录订单中具体商品的信息。主键为-order-item-id。"><a href="#订单商品表（order-item-tab：记录订单中具体商品的信息。主键为-order-item-id。" class="headerlink" title="订单商品表（order_item_tab：记录订单中具体商品的信息。主键为 order_item_id。"></a>订单商品表（order_item_tab：记录订单中具体商品的信息。主键为 order_item_id。</h4><ul>
<li>order_id：订单ID，作为外键关联订单。</li>
<li>item_id：商品ID，表示订单中的商品。</li>
<li>item_snapshot_id：商品快照ID，记录当时购买时的商品信息快照。</li>
<li>item_status：商品状态，如已发货、退货等。</li>
<li>quantity：购买数量。</li>
<li>price：商品单价。</li>
<li>discount：商品折扣金额</li>
</ul>
<h4 id="订单支付表（pay-order-tab）：主要用于记录用户的支付信息。主键为-pay-order-id，标识唯一的支付订单。"><a href="#订单支付表（pay-order-tab）：主要用于记录用户的支付信息。主键为-pay-order-id，标识唯一的支付订单。" class="headerlink" title="订单支付表（pay_order_tab）：主要用于记录用户的支付信息。主键为 pay_order_id，标识唯一的支付订单。"></a>订单支付表（pay_order_tab）：主要用于记录用户的支付信息。主键为 pay_order_id，标识唯一的支付订单。</h4><ul>
<li>user_id：用户ID，标识支付的用户。</li>
<li>payment_method：支付方式，如信用卡、支付宝等。</li>
<li>payment_status：支付状态，如已支付、未支付等。</li>
<li>pay_amount、cash_amount、coin_amount、voucher_amount：支付金额、现金支付金额、代币支付金额、优惠券使用金额。</li>
<li>时间戳字段包括创建时间、初始化时间和更新时间</li>
</ul>
<h4 id="退款表（refund-tab）：记录订单或订单项的退款信息。主键为-refund-id。"><a href="#退款表（refund-tab）：记录订单或订单项的退款信息。主键为-refund-id。" class="headerlink" title="退款表（refund_tab）：记录订单或订单项的退款信息。主键为 refund_id。"></a>退款表（refund_tab）：记录订单或订单项的退款信息。主键为 refund_id。</h4><ul>
<li>order_id：订单ID，作为外键关联订单。</li>
<li>order_item_id：订单项ID，标识具体商品的退款。</li>
<li>refund_amount：退款金额。</li>
<li>reason：退款原因。</li>
<li>quantity：退款的商品数量。</li>
<li>refund_status：退款状态。</li>
<li>refund_time：退款操作时间。</li>
</ul>
<h4 id="实体间关系："><a href="#实体间关系：" class="headerlink" title="实体间关系："></a>实体间关系：</h4><ul>
<li>支付订单与订单：</li>
<li>一个支付订单可能关联多个购买订单，形成 一对多 关系。<br>例如，用户可以通过一次支付购买多个不同的订单。</li>
<li>订单与订单商品：<br>一个订单可以包含多个订单项，形成 一对多 关系。<br>订单项代表订单中所购买的每个商品的详细信息。</li>
<li>订单与退款：<ul>
<li>一个订单可能包含多个退款，形成 一对多 关系。</li>
<li>退款可以是针对订单整体，也可以针对订单中的某个商品</li>
</ul>
</li>
</ul>
<h3 id="订单状态机设计"><a href="#订单状态机设计" class="headerlink" title="订单状态机设计"></a>订单状态机设计</h3><h4 id="Order-主状态机"><a href="#Order-主状态机" class="headerlink" title="Order 主状态机"></a>Order 主状态机</h4><p align="center">
  <img src="/images/order_status.png" width=500 height=450>
</p>


<h4 id="支付状态机"><a href="#支付状态机" class="headerlink" title="支付状态机"></a>支付状态机</h4><p align="center">
  <img src="/images/pay_status.png" width=700 height=400>
</p>


<h4 id="履约状态机"><a href="#履约状态机" class="headerlink" title="履约状态机"></a>履约状态机</h4><p align="center">
  <img src="/images/fulfillment_status.png" width=500 height=400>
</p>

<h4 id="退货退款状体机"><a href="#退货退款状体机" class="headerlink" title="退货退款状体机"></a>退货退款状体机</h4><p align="center">
  <img src="/images/refund_status.png" width=700 height=1100>
</p>


<h4 id="异常单人工介入"><a href="#异常单人工介入" class="headerlink" title="异常单人工介入"></a>异常单人工介入</h4><ul>
<li>用户发起退款单拒绝</li>
<li>退货失败，订单状态无法流转</li>
<li>退款失败</li>
<li>退营销失败</li>
</ul>
<h3 id="订单ID-生成策略"><a href="#订单ID-生成策略" class="headerlink" title="订单ID 生成策略"></a>订单ID 生成策略</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line">  <span class="comment"># 时间戳 + 机器id + uid % 1000 + 自增序号</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Union</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">OrderNoGenerator</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, machine_id: <span class="built_in">int</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        初始化订单号生成器</span></span><br><span class="line"><span class="string">        :param machine_id: 机器ID (0-999)</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="number">0</span> &lt;= machine_id &lt;= <span class="number">999</span>:</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">&quot;机器ID必须在0-999之间&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        self.machine_id = machine_id</span><br><span class="line">        self.sequence = <span class="number">0</span></span><br><span class="line">        self.last_timestamp = -<span class="number">1</span></span><br><span class="line">        self.lock = threading.Lock()  <span class="comment"># 线程锁，保证线程安全</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_wait_next_second</span>(<span class="params">self, last_timestamp: <span class="built_in">int</span></span>) -&gt; <span class="built_in">int</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        等待下一秒</span></span><br><span class="line"><span class="string">        :param last_timestamp: 上次时间戳</span></span><br><span class="line"><span class="string">        :return: 新的时间戳</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        timestamp = <span class="built_in">int</span>(time.time())</span><br><span class="line">        <span class="keyword">while</span> timestamp &lt;= last_timestamp:</span><br><span class="line">            timestamp = <span class="built_in">int</span>(time.time())</span><br><span class="line">        <span class="keyword">return</span> timestamp</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">generate_order_no</span>(<span class="params">self, user_id: <span class="built_in">int</span></span>) -&gt; <span class="type">Union</span>[<span class="built_in">int</span>, <span class="built_in">str</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        生成订单号</span></span><br><span class="line"><span class="string">        :param user_id: 用户ID</span></span><br><span class="line"><span class="string">        :return: 订单号（整数或字符串形式）</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">with</span> self.lock:  <span class="comment"># 使用线程锁保证线程安全</span></span><br><span class="line">            <span class="comment"># 获取当前时间戳（秒级）</span></span><br><span class="line">            timestamp = <span class="built_in">int</span>(time.time())</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 处理时间回拨</span></span><br><span class="line">            <span class="keyword">if</span> timestamp &lt; self.last_timestamp:</span><br><span class="line">                <span class="keyword">raise</span> RuntimeError(<span class="string">&quot;系统时间回拨，拒绝生成订单号&quot;</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 如果是同一秒，序列号自增</span></span><br><span class="line">            <span class="keyword">if</span> timestamp == self.last_timestamp:</span><br><span class="line">                self.sequence = (self.sequence + <span class="number">1</span>) % <span class="number">1000</span></span><br><span class="line">                <span class="comment"># 如果序列号用完了，等待下一秒</span></span><br><span class="line">                <span class="keyword">if</span> self.sequence == <span class="number">0</span>:</span><br><span class="line">                    timestamp = self._wait_next_second(self.last_timestamp)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="comment"># 不同秒，序列号重置</span></span><br><span class="line">                self.sequence = <span class="number">0</span></span><br><span class="line">            </span><br><span class="line">            self.last_timestamp = timestamp</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 获取用户ID的后3位</span></span><br><span class="line">            user_id_suffix = user_id % <span class="number">1000</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 组装订单号</span></span><br><span class="line">            order_no = (timestamp * <span class="number">1000000000</span> +  <span class="comment"># 时间戳左移9位</span></span><br><span class="line">                       self.machine_id * <span class="number">1000000</span> +  <span class="comment"># 机器ID左移6位</span></span><br><span class="line">                       user_id_suffix * <span class="number">1000</span> +      <span class="comment"># 用户ID左移3位</span></span><br><span class="line">                       self.sequence)               <span class="comment"># 序列号</span></span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> order_no</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">generate_order_no_str</span>(<span class="params">self, user_id: <span class="built_in">int</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        生成字符串形式的订单号</span></span><br><span class="line"><span class="string">        :param user_id: 用户ID</span></span><br><span class="line"><span class="string">        :return: 字符串形式的订单号</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        order_no = self.generate_order_no(user_id)</span><br><span class="line">        <span class="keyword">return</span> <span class="string">f&quot;<span class="subst">&#123;order_no:019d&#125;</span>&quot;</span>  <span class="comment"># 补零到19位</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用示例</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    <span class="comment"># 创建订单号生成器实例</span></span><br><span class="line">    generator = OrderNoGenerator(machine_id=<span class="number">1</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 生成订单号</span></span><br><span class="line">    user_id = <span class="number">12345</span></span><br><span class="line">    order_no = generator.generate_order_no(user_id)</span><br><span class="line">    order_no_str = generator.generate_order_no_str(user_id)</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;整数形式订单号: <span class="subst">&#123;order_no&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;字符串形式订单号: <span class="subst">&#123;order_no_str&#125;</span>&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 测试并发</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">test_concurrent</span>():</span><br><span class="line">        <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>):</span><br><span class="line">            order_no = generator.generate_order_no(user_id)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;并发生成的订单号: <span class="subst">&#123;order_no&#125;</span>&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 创建多个线程测试并发</span></span><br><span class="line">    threads = []</span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):</span><br><span class="line">        t = threading.Thread(target=test_concurrent)</span><br><span class="line">        threads.append(t)</span><br><span class="line">        t.start()</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 等待所有线程完成</span></span><br><span class="line">    <span class="keyword">for</span> t <span class="keyword">in</span> threads:</span><br><span class="line">        t.join()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>

<h3 id="订单商品快照"><a href="#订单商品快照" class="headerlink" title="订单商品快照"></a>订单商品快照</h3><h4 id="方案1-直接使用商品系统的item-snapshot。（由商品系统维护快照）"><a href="#方案1-直接使用商品系统的item-snapshot。（由商品系统维护快照）" class="headerlink" title="方案1. 直接使用商品系统的item snapshot。（由商品系统维护快照）"></a>方案1. 直接使用商品系统的item snapshot。（由商品系统维护快照）</h4><ul>
<li>商品系统负责维护商品快照</li>
<li>订单系统通过引用商品快照ID来关联商品信息</li>
<li>商品信息变更时，商品系统生成新的快照版本<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 商品系统维护的快照表</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> item_snapshot_tab (</span><br><span class="line">    snapshot_id <span class="type">BIGINT</span> <span class="keyword">PRIMARY</span> KEY,</span><br><span class="line">    item_id <span class="type">BIGINT</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    version <span class="type">INT</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    data JSON <span class="keyword">NOT</span> <span class="keyword">NULL</span>,  <span class="comment">-- 存储商品完整信息</span></span><br><span class="line">    created_at <span class="type">TIMESTAMP</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    INDEX idx_item_version (item_id, version)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 订单系统引用快照</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> order_item_tab (</span><br><span class="line">    order_id <span class="type">BIGINT</span>,</span><br><span class="line">    item_id <span class="type">BIGINT</span>,</span><br><span class="line">    snapshot_id <span class="type">BIGINT</span>,  <span class="comment">-- 引用商品快照</span></span><br><span class="line">    quantity <span class="type">INT</span>,</span><br><span class="line">    price <span class="type">DECIMAL</span>(<span class="number">10</span>,<span class="number">2</span>),</span><br><span class="line">    <span class="keyword">FOREIGN</span> KEY (snapshot_id) <span class="keyword">REFERENCES</span> item_snapshot(snapshot_id)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
优点</li>
<li>数据一致性高：商品系统统一管理快照，避免数据不一致</li>
<li>存储效率高：多个订单可以共享同一个快照版本</li>
<li>维护成本低：订单系统不需要关心快照的生成和管理</li>
<li>查询性能好：可以直接通过快照ID获取完整商品信息</li>
</ul>
<p>缺点</p>
<ul>
<li>系统耦合度高：订单系统强依赖商品系统的快照服务</li>
<li>扩展性受限：商品系统需要支持所有订单系统可能需要的商品信息</li>
<li>版本管理复杂：需要处理快照的版本控制和清理</li>
<li>跨系统调用：订单系统需要调用商品系统获取快照信息</li>
</ul>
<h4 id="方案2-创单时提供商品详情信息。（由订单维护商品快照"><a href="#方案2-创单时提供商品详情信息。（由订单维护商品快照" class="headerlink" title="方案2. 创单时提供商品详情信息。（由订单维护商品快照)"></a>方案2. 创单时提供商品详情信息。（由订单维护商品快照)</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> order_item (</span><br><span class="line">    order_id <span class="type">BIGINT</span>,</span><br><span class="line">    item_id <span class="type">BIGINT</span>,</span><br><span class="line">    quantity <span class="type">INT</span>,</span><br><span class="line">    price <span class="type">DECIMAL</span>(<span class="number">10</span>,<span class="number">2</span>),</span><br><span class="line">    snapshot_data JSON <span class="keyword">NOT</span> <span class="keyword">NULL</span>,  <span class="comment">-- 存储下单时的商品信息</span></span><br><span class="line">    <span class="keyword">FOREIGN</span> KEY (order_id, item_id) <span class="keyword">REFERENCES</span> order_item_snapshot(order_id, item_id)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<h4 id="方案3-创单时提供商品详情信息。（由订单维护商品快照）-快照复用"><a href="#方案3-创单时提供商品详情信息。（由订单维护商品快照）-快照复用" class="headerlink" title="方案3. 创单时提供商品详情信息。（由订单维护商品快照）+ 快照复用"></a>方案3. 创单时提供商品详情信息。（由订单维护商品快照）+ 快照复用</h4><p>设计思路：</p>
<ul>
<li>订单系统维护自己的快照表，但增加快照复用机制</li>
<li>使用商品信息的摘要(摘要算法如MD5)作为快照的唯一标识</li>
<li>相同摘要的商品信息共享同一个快照记录</li>
<li>创单时先检查摘要是否存在，存在则复用，不存在则创建新快照</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 订单系统维护的快照表</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> order_item_snapshot (</span><br><span class="line">    snapshot_id <span class="type">BIGINT</span> <span class="keyword">PRIMARY</span> KEY,</span><br><span class="line">    item_id <span class="type">BIGINT</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    item_hash <span class="type">VARCHAR</span>(<span class="number">32</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;商品信息摘要&#x27;</span>,</span><br><span class="line">    snapshot_data JSON <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;存储下单时的商品信息&#x27;</span>,</span><br><span class="line">    created_at <span class="type">TIMESTAMP</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    INDEX idx_item_hash (item_hash),</span><br><span class="line">    INDEX idx_item_id (item_id)</span><br><span class="line">);</span><br><span class="line"><span class="comment">-- 订单商品表</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> order_item (</span><br><span class="line">    order_id <span class="type">BIGINT</span>,</span><br><span class="line">    item_id <span class="type">BIGINT</span>,</span><br><span class="line">    snapshot_id <span class="type">BIGINT</span>,</span><br><span class="line">    quantity <span class="type">INT</span>,</span><br><span class="line">    price <span class="type">DECIMAL</span>(<span class="number">10</span>,<span class="number">2</span>),</span><br><span class="line">    <span class="keyword">FOREIGN</span> KEY (snapshot_id) <span class="keyword">REFERENCES</span> order_item_snapshot(snapshot_id)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p>适用场景：</p>
<ul>
<li>商品模型比较固定，项目初期，团队比较小，能接受系统之间的耦合，可以考虑用1</li>
<li>不同商品差异比较大，商品信息结构复杂，考虑用2</li>
<li>订单量太大，考虑复用快照</li>
</ul>
<h3 id="核心流程-1"><a href="#核心流程-1" class="headerlink" title="核心流程"></a>核心流程</h3><h4 id="正常流程和逆向流程"><a href="#正常流程和逆向流程" class="headerlink" title="正常流程和逆向流程"></a>正常流程和逆向流程</h4><h4 id="创单"><a href="#创单" class="headerlink" title="创单"></a>创单</h4><h5 id="核心步骤"><a href="#核心步骤" class="headerlink" title="核心步骤"></a>核心步骤</h5><ol>
<li>参数校验。用户校验，是否异常用户。</li>
<li>商品与价格校验。校验商品是否存在、是否上架、价格是否有效</li>
<li>库存校验与预占。检查库存是否充足，部分场景下进行库存预占（锁库存）。</li>
<li>营销信息校验。校验优惠券、积分等是否可用，计算优惠金额。</li>
<li>订单金额计算。计算订单总金额、应付金额、各项明细。</li>
<li>生成订单号。生成全局唯一订单号，保证幂等性。</li>
<li>订单数据落库。写入订单主表、订单明细表、扩展表等。</li>
<li>扣减库存、扣减实际库存（有的系统在支付后扣减）。</li>
<li>发送消息&#x2F;异步处理。发送订单创建成功消息，通知库存、物流、营销等系统。</li>
<li>返回下单结果。返回订单号、支付信息等给前端。</li>
</ol>
<h5 id="实现思路"><a href="#实现思路" class="headerlink" title="实现思路"></a>实现思路</h5><ul>
<li>接口定义：通过OrderCreationStep接口定义了每个步骤必须实现的方法</li>
<li>上下文共享：使用OrderCreationContext在步骤间共享数据</li>
<li>步骤独立：每个步骤都是独立的，便于维护和测试</li>
<li>回滚机制：每个步骤都实现了回滚方法</li>
<li>流程管理：通过OrderCreationManager统一管理步骤的执行和回滚</li>
<li>错误处理：统一的错误处理和回滚机制</li>
<li>可扩展性：易于添加新的步骤或修改现有步骤</li>
<li>如何解决不同category 创单差异较大的问题？<ul>
<li>插件化&#x2F;策略模式。将订单处理流程拆分为多个步骤（如校验、支付、通知等）。不同订单类型实现各自的处理逻辑，通过策略模式动态选择。</li>
</ul>
<ol start="2">
<li>订单类型标识。在订单主表中增加订单类型字段，根据类型选择不同的处理流程。</li>
<li>扩展字段。使用JSON或扩展表存储特定订单类型的特殊字段（如酒店的入住日期、机票的航班信息）。</li>
<li>流程引擎。使用流程引擎（如BPMN）定义和管理复杂的订单处理流程，支持动态调整。</li>
</ol>
</li>
</ul>
<details>
<summary>点击查看创单核心逻辑代码实现</summary>
<pre><code class="go">

<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> order</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;context&quot;</span></span><br><span class="line">	<span class="string">&quot;encoding/json&quot;</span></span><br><span class="line">	<span class="string">&quot;errors&quot;</span></span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">	<span class="string">&quot;log&quot;</span></span><br><span class="line">	<span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// OrderType 订单类型</span></span><br><span class="line"><span class="keyword">type</span> OrderType <span class="type">string</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> (</span><br><span class="line">	OrderTypePhysical OrderType = <span class="string">&quot;physical&quot;</span> <span class="comment">// 实物订单</span></span><br><span class="line">	OrderTypeVirtual  OrderType = <span class="string">&quot;virtual&quot;</span>  <span class="comment">// 虚拟订单</span></span><br><span class="line">	OrderTypePresale  OrderType = <span class="string">&quot;presale&quot;</span>  <span class="comment">// 预售订单</span></span><br><span class="line">	OrderTypeHotel    OrderType = <span class="string">&quot;hotel&quot;</span>    <span class="comment">// 酒店订单</span></span><br><span class="line">	OrderTypeTopUp    OrderType = <span class="string">&quot;topup&quot;</span>    <span class="comment">// 充值订单</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// OrderStatus 订单状态</span></span><br><span class="line"><span class="keyword">type</span> OrderStatus <span class="type">string</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> (</span><br><span class="line">	OrderStatusInit     OrderStatus = <span class="string">&quot;init&quot;</span>     <span class="comment">// 初始化</span></span><br><span class="line">	OrderStatusPending  OrderStatus = <span class="string">&quot;pending&quot;</span>  <span class="comment">// 待支付</span></span><br><span class="line">	OrderStatusPaid     OrderStatus = <span class="string">&quot;paid&quot;</span>     <span class="comment">// 已支付</span></span><br><span class="line">	OrderStatusShipping OrderStatus = <span class="string">&quot;shipping&quot;</span> <span class="comment">// 发货中</span></span><br><span class="line">	OrderStatusSuccess  OrderStatus = <span class="string">&quot;success&quot;</span>  <span class="comment">// 成功</span></span><br><span class="line">	OrderStatusFailed   OrderStatus = <span class="string">&quot;failed&quot;</span>   <span class="comment">// 失败</span></span><br><span class="line">	OrderStatusCanceled OrderStatus = <span class="string">&quot;canceled&quot;</span> <span class="comment">// 已取消</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Order 订单基础信息</span></span><br><span class="line"><span class="keyword">type</span> Order <span class="keyword">struct</span> &#123;</span><br><span class="line">	ID        <span class="type">string</span>          <span class="string">`json:&quot;id&quot;`</span></span><br><span class="line">	UserID    <span class="type">string</span>          <span class="string">`json:&quot;user_id&quot;`</span></span><br><span class="line">	Type      OrderType       <span class="string">`json:&quot;type&quot;`</span></span><br><span class="line">	Status    OrderStatus     <span class="string">`json:&quot;status&quot;`</span></span><br><span class="line">	Amount    <span class="type">float64</span>         <span class="string">`json:&quot;amount&quot;`</span></span><br><span class="line">	Detail    json.RawMessage <span class="string">`json:&quot;detail&quot;`</span> <span class="comment">// 不同类型订单的特殊字段</span></span><br><span class="line">	CreatedAt time.Time       <span class="string">`json:&quot;created_at&quot;`</span></span><br><span class="line">	UpdatedAt time.Time       <span class="string">`json:&quot;updated_at&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// OrderCreationContext 创单上下文</span></span><br><span class="line"><span class="keyword">type</span> OrderCreationContext <span class="keyword">struct</span> &#123;</span><br><span class="line">	Ctx                 context.Context</span><br><span class="line">	Order               *Order</span><br><span class="line">	Params              <span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125; <span class="comment">// 创单参数</span></span><br><span class="line">	Cache               <span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125; <span class="comment">// 步骤间共享数据</span></span><br><span class="line">	Errors              []<span class="type">error</span>                <span class="comment">// 错误记录</span></span><br><span class="line">	StepResults         <span class="keyword">map</span>[<span class="type">string</span>]StepResult  <span class="comment">// 每个步骤的执行结果</span></span><br><span class="line">	RollbackFailedSteps []<span class="type">string</span>               <span class="comment">// 记录回滚失败的步骤</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// StepResult 步骤执行结果</span></span><br><span class="line"><span class="keyword">type</span> StepResult <span class="keyword">struct</span> &#123;</span><br><span class="line">	Success        <span class="type">bool</span></span><br><span class="line">	Error          <span class="type">error</span></span><br><span class="line">	Data           <span class="keyword">interface</span>&#123;&#125;</span><br><span class="line">	CompensateData <span class="keyword">interface</span>&#123;&#125; <span class="comment">// 用于补偿的数据</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// OrderCreationStep 创单步骤接口</span></span><br><span class="line"><span class="keyword">type</span> OrderCreationStep <span class="keyword">interface</span> &#123;</span><br><span class="line">	Execute(ctx *OrderCreationContext) <span class="type">error</span></span><br><span class="line">	Rollback(ctx *OrderCreationContext) <span class="type">error</span></span><br><span class="line">	Compensate(ctx *OrderCreationContext) <span class="type">error</span> <span class="comment">// 异步补偿</span></span><br><span class="line">	Name() <span class="type">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 错误定义</span></span><br><span class="line"><span class="keyword">var</span> (</span><br><span class="line">	ErrInvalidParams     = errors.New(<span class="string">&quot;invalid parameters&quot;</span>)</span><br><span class="line">	ErrProductNotFound   = errors.New(<span class="string">&quot;product not found&quot;</span>)</span><br><span class="line">	ErrProductOffline    = errors.New(<span class="string">&quot;product is offline&quot;</span>)</span><br><span class="line">	ErrStockInsufficient = errors.New(<span class="string">&quot;stock insufficient&quot;</span>)</span><br><span class="line">	ErrUserBlocked       = errors.New(<span class="string">&quot;user is blocked&quot;</span>)</span><br><span class="line">	ErrSystemBusy        = errors.New(<span class="string">&quot;system is busy&quot;</span>)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// OrderError 订单错误</span></span><br><span class="line"><span class="keyword">type</span> OrderError <span class="keyword">struct</span> &#123;</span><br><span class="line">	Step    <span class="type">string</span></span><br><span class="line">	Message <span class="type">string</span></span><br><span class="line">	Err     <span class="type">error</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(e *OrderError)</span></span> Error() <span class="type">string</span> &#123;</span><br><span class="line">	<span class="keyword">return</span> fmt.Sprintf(<span class="string">&quot;step: %s, message: %s, error: %v&quot;</span>, e.Step, e.Message, e.Err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 参数校验步骤</span></span><br><span class="line"><span class="keyword">type</span> ParamValidationStep <span class="keyword">struct</span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *ParamValidationStep)</span></span> Execute(ctx *OrderCreationContext) <span class="type">error</span> &#123;</span><br><span class="line">	<span class="comment">// 通用参数校验</span></span><br><span class="line">	<span class="keyword">if</span> ctx.Order.UserID == <span class="string">&quot;&quot;</span> || ctx.Order.Type == <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> &amp;OrderError&#123;Step: s.Name(), Message: <span class="string">&quot;missing required fields&quot;</span>, Err: ErrInvalidParams&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 订单类型特殊参数校验</span></span><br><span class="line">	<span class="keyword">switch</span> ctx.Order.Type &#123;</span><br><span class="line">	<span class="keyword">case</span> OrderTypePhysical:</span><br><span class="line">		<span class="keyword">if</span> addr, ok := ctx.Params[<span class="string">&quot;address&quot;</span>].(<span class="type">string</span>); !ok || addr == <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> &amp;OrderError&#123;Step: s.Name(), Message: <span class="string">&quot;missing address for physical order&quot;</span>, Err: ErrInvalidParams&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	<span class="keyword">case</span> OrderTypeHotel:</span><br><span class="line">		<span class="keyword">if</span> _, ok := ctx.Params[<span class="string">&quot;check_in_date&quot;</span>].(time.Time); !ok &#123;</span><br><span class="line">			<span class="keyword">return</span> &amp;OrderError&#123;Step: s.Name(), Message: <span class="string">&quot;missing check-in date for hotel order&quot;</span>, Err: ErrInvalidParams&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *ParamValidationStep)</span></span> Rollback(ctx *OrderCreationContext) <span class="type">error</span> &#123;</span><br><span class="line">	<span class="comment">// 参数校验步骤无需回滚</span></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *ParamValidationStep)</span></span> Compensate(ctx *OrderCreationContext) <span class="type">error</span> &#123;</span><br><span class="line">	<span class="comment">// 参数校验步骤无需补偿</span></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *ParamValidationStep)</span></span> Name() <span class="type">string</span> &#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="string">&quot;param_validation&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Product 商品信息</span></span><br><span class="line"><span class="keyword">type</span> Product <span class="keyword">struct</span> &#123;</span><br><span class="line">	ID       <span class="type">string</span></span><br><span class="line">	Name     <span class="type">string</span></span><br><span class="line">	Price    <span class="type">float64</span></span><br><span class="line">	IsOnSale <span class="type">bool</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ProductService 商品服务接口</span></span><br><span class="line"><span class="keyword">type</span> ProductService <span class="keyword">interface</span> &#123;</span><br><span class="line">	GetProduct(ctx context.Context, productID <span class="type">string</span>) (*Product, <span class="type">error</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// StockService 库存服务接口</span></span><br><span class="line"><span class="keyword">type</span> StockService <span class="keyword">interface</span> &#123;</span><br><span class="line">	LockStock(ctx context.Context, productID <span class="type">string</span>, quantity <span class="type">int</span>) (<span class="type">string</span>, <span class="type">error</span>)</span><br><span class="line">	UnlockStock(ctx context.Context, lockID <span class="type">string</span>) <span class="type">error</span></span><br><span class="line">	DeductStock(ctx context.Context, productID <span class="type">string</span>, quantity <span class="type">int</span>) <span class="type">error</span></span><br><span class="line">	RevertDeductStock(ctx context.Context, productID <span class="type">string</span>, quantity <span class="type">int</span>) <span class="type">error</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// PromotionService 营销服务接口</span></span><br><span class="line"><span class="keyword">type</span> PromotionService <span class="keyword">interface</span> &#123;</span><br><span class="line">	ValidateCoupon(ctx context.Context, couponCode <span class="type">string</span>, userID <span class="type">string</span>, orderAmount <span class="type">float64</span>) (*Coupon, <span class="type">error</span>)</span><br><span class="line">	UseCoupon(ctx context.Context, couponCode <span class="type">string</span>, userID <span class="type">string</span>, orderID <span class="type">string</span>) <span class="type">error</span></span><br><span class="line">	RevertCouponUsage(ctx context.Context, couponCode <span class="type">string</span>, userID <span class="type">string</span>, orderID <span class="type">string</span>) <span class="type">error</span></span><br><span class="line">	DeductPoints(ctx context.Context, userID <span class="type">string</span>, points <span class="type">int</span>) <span class="type">error</span></span><br><span class="line">	RevertPointsDeduction(ctx context.Context, userID <span class="type">string</span>, points <span class="type">int</span>) <span class="type">error</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Coupon 优惠券信息</span></span><br><span class="line"><span class="keyword">type</span> Coupon <span class="keyword">struct</span> &#123;</span><br><span class="line">	Code       <span class="type">string</span></span><br><span class="line">	Type       <span class="type">string</span></span><br><span class="line">	Amount     <span class="type">float64</span></span><br><span class="line">	Threshold  <span class="type">float64</span></span><br><span class="line">	ExpireTime time.Time</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 商品校验步骤</span></span><br><span class="line"><span class="keyword">type</span> ProductValidationStep <span class="keyword">struct</span> &#123;</span><br><span class="line">	productService ProductService</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *ProductValidationStep)</span></span> Execute(ctx *OrderCreationContext) <span class="type">error</span> &#123;</span><br><span class="line">	productID := ctx.Params[<span class="string">&quot;product_id&quot;</span>].(<span class="type">string</span>)</span><br><span class="line">	product, err := s.productService.GetProduct(ctx.Ctx, productID)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> &amp;OrderError&#123;Step: s.Name(), Message: <span class="string">&quot;failed to get product&quot;</span>, Err: err&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> !product.IsOnSale &#123;</span><br><span class="line">		<span class="keyword">return</span> &amp;OrderError&#123;Step: s.Name(), Message: <span class="string">&quot;product is offline&quot;</span>, Err: ErrProductOffline&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	ctx.Cache[<span class="string">&quot;product&quot;</span>] = product</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *ProductValidationStep)</span></span> Rollback(ctx *OrderCreationContext) <span class="type">error</span> &#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *ProductValidationStep)</span></span> Compensate(ctx *OrderCreationContext) <span class="type">error</span> &#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *ProductValidationStep)</span></span> Name() <span class="type">string</span> &#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="string">&quot;product_validation&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 库存校验步骤</span></span><br><span class="line"><span class="keyword">type</span> StockValidationStep <span class="keyword">struct</span> &#123;</span><br><span class="line">	stockService StockService</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *StockValidationStep)</span></span> Execute(ctx *OrderCreationContext) <span class="type">error</span> &#123;</span><br><span class="line">	<span class="keyword">if</span> ctx.Order.Type == OrderTypeVirtual || ctx.Order.Type == OrderTypeTopUp &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	productID := ctx.Params[<span class="string">&quot;product_id&quot;</span>].(<span class="type">string</span>)</span><br><span class="line">	quantity := ctx.Params[<span class="string">&quot;quantity&quot;</span>].(<span class="type">int</span>)</span><br><span class="line"></span><br><span class="line">	lockID, err := s.stockService.LockStock(ctx.Ctx, productID, quantity)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> &amp;OrderError&#123;Step: s.Name(), Message: <span class="string">&quot;failed to lock stock&quot;</span>, Err: err&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	ctx.Cache[<span class="string">&quot;stock_lock_id&quot;</span>] = lockID</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *StockValidationStep)</span></span> Rollback(ctx *OrderCreationContext) <span class="type">error</span> &#123;</span><br><span class="line">	<span class="keyword">if</span> lockID, ok := ctx.Cache[<span class="string">&quot;stock_lock_id&quot;</span>].(<span class="type">string</span>); ok &#123;</span><br><span class="line">		<span class="keyword">return</span> s.stockService.UnlockStock(ctx.Ctx, lockID)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *StockValidationStep)</span></span> Compensate(ctx *OrderCreationContext) <span class="type">error</span> &#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *StockValidationStep)</span></span> Name() <span class="type">string</span> &#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="string">&quot;stock_validation&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 库存扣减步骤</span></span><br><span class="line"><span class="keyword">type</span> StockDeductionStep <span class="keyword">struct</span> &#123;</span><br><span class="line">	stockService StockService</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *StockDeductionStep)</span></span> Execute(ctx *OrderCreationContext) <span class="type">error</span> &#123;</span><br><span class="line">	<span class="comment">// 虚拟商品和充值订单跳过库存扣减</span></span><br><span class="line">	<span class="keyword">if</span> ctx.Order.Type == OrderTypeVirtual || ctx.Order.Type == OrderTypeTopUp &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	productID := ctx.Params[<span class="string">&quot;product_id&quot;</span>].(<span class="type">string</span>)</span><br><span class="line">	quantity := ctx.Params[<span class="string">&quot;quantity&quot;</span>].(<span class="type">int</span>)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 执行库存扣减</span></span><br><span class="line">	<span class="keyword">if</span> err := s.stockService.DeductStock(ctx.Ctx, productID, quantity); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> &amp;OrderError&#123;</span><br><span class="line">			Step:    s.Name(),</span><br><span class="line">			Message: <span class="string">&quot;failed to deduct stock&quot;</span>,</span><br><span class="line">			Err:     err,</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 记录扣减信息，用于回滚</span></span><br><span class="line">	ctx.Cache[<span class="string">&quot;stock_deducted&quot;</span>] = <span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;&#123;</span><br><span class="line">		<span class="string">&quot;product_id&quot;</span>: productID,</span><br><span class="line">		<span class="string">&quot;quantity&quot;</span>:   quantity,</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *StockDeductionStep)</span></span> Rollback(ctx *OrderCreationContext) <span class="type">error</span> &#123;</span><br><span class="line">	deducted, ok := ctx.Cache[<span class="string">&quot;stock_deducted&quot;</span>].(<span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;)</span><br><span class="line">	<span class="keyword">if</span> !ok &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	productID := deducted[<span class="string">&quot;product_id&quot;</span>].(<span class="type">string</span>)</span><br><span class="line">	quantity := deducted[<span class="string">&quot;quantity&quot;</span>].(<span class="type">int</span>)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> s.stockService.RevertDeductStock(ctx.Ctx, productID, quantity)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *StockDeductionStep)</span></span> Compensate(ctx *OrderCreationContext) <span class="type">error</span> &#123;</span><br><span class="line">	deducted, ok := ctx.Cache[<span class="string">&quot;stock_deducted&quot;</span>].(<span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;)</span><br><span class="line">	<span class="keyword">if</span> !ok &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	productID := deducted[<span class="string">&quot;product_id&quot;</span>].(<span class="type">string</span>)</span><br><span class="line">	quantity := deducted[<span class="string">&quot;quantity&quot;</span>].(<span class="type">int</span>)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 创建补偿消息</span></span><br><span class="line">	compensationMsg := StockCompensationMessage&#123;</span><br><span class="line">		OrderID:   ctx.Order.ID,</span><br><span class="line">		ProductID: productID,</span><br><span class="line">		Quantity:  quantity,</span><br><span class="line">		Timestamp: time.Now(),</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// <span class="doctag">TODO:</span> 实现发送到补偿队列的逻辑</span></span><br><span class="line">	<span class="comment">// return sendToCompensationQueue(&quot;stock_compensation&quot;, compensationMsg)</span></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *StockDeductionStep)</span></span> Name() <span class="type">string</span> &#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="string">&quot;stock_deduction&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 营销活动扣减步骤</span></span><br><span class="line"><span class="keyword">type</span> PromotionDeductionStep <span class="keyword">struct</span> &#123;</span><br><span class="line">	promotionService PromotionService</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *PromotionDeductionStep)</span></span> Execute(ctx *OrderCreationContext) <span class="type">error</span> &#123;</span><br><span class="line">	<span class="comment">// 处理优惠券</span></span><br><span class="line">	<span class="keyword">if</span> couponCode, ok := ctx.Params[<span class="string">&quot;coupon_code&quot;</span>].(<span class="type">string</span>); ok &#123;</span><br><span class="line">		<span class="comment">// 验证优惠券</span></span><br><span class="line">		coupon, err := s.promotionService.ValidateCoupon(</span><br><span class="line">			ctx.Ctx,</span><br><span class="line">			couponCode,</span><br><span class="line">			ctx.Order.UserID,</span><br><span class="line">			ctx.Order.Amount,</span><br><span class="line">		)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> &amp;OrderError&#123;</span><br><span class="line">				Step:    s.Name(),</span><br><span class="line">				Message: <span class="string">&quot;invalid coupon&quot;</span>,</span><br><span class="line">				Err:     err,</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 使用优惠券</span></span><br><span class="line">		<span class="keyword">if</span> err := s.promotionService.UseCoupon(ctx.Ctx, couponCode, ctx.Order.UserID, ctx.Order.ID); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> &amp;OrderError&#123;</span><br><span class="line">				Step:    s.Name(),</span><br><span class="line">				Message: <span class="string">&quot;failed to use coupon&quot;</span>,</span><br><span class="line">				Err:     err,</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 记录优惠券使用信息，用于回滚</span></span><br><span class="line">		ctx.Cache[<span class="string">&quot;used_coupon&quot;</span>] = couponCode</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 更新订单金额</span></span><br><span class="line">		ctx.Order.Amount -= coupon.Amount</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 处理积分抵扣</span></span><br><span class="line">	<span class="keyword">if</span> points, ok := ctx.Params[<span class="string">&quot;use_points&quot;</span>].(<span class="type">int</span>); ok &amp;&amp; points &gt; <span class="number">0</span> &#123;</span><br><span class="line">		<span class="comment">// 扣减积分</span></span><br><span class="line">		<span class="keyword">if</span> err := s.promotionService.DeductPoints(ctx.Ctx, ctx.Order.UserID, points); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> &amp;OrderError&#123;</span><br><span class="line">				Step:    s.Name(),</span><br><span class="line">				Message: <span class="string">&quot;failed to deduct points&quot;</span>,</span><br><span class="line">				Err:     err,</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 记录积分扣减信息，用于回滚</span></span><br><span class="line">		ctx.Cache[<span class="string">&quot;deducted_points&quot;</span>] = points</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 更新订单金额（假设1积分=0.01元）</span></span><br><span class="line">		ctx.Order.Amount -= <span class="type">float64</span>(points) * <span class="number">0.01</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *PromotionDeductionStep)</span></span> Rollback(ctx *OrderCreationContext) <span class="type">error</span> &#123;</span><br><span class="line">	<span class="comment">// 回滚优惠券使用</span></span><br><span class="line">	<span class="keyword">if</span> couponCode, ok := ctx.Cache[<span class="string">&quot;used_coupon&quot;</span>].(<span class="type">string</span>); ok &#123;</span><br><span class="line">		<span class="keyword">if</span> err := s.promotionService.RevertCouponUsage(ctx.Ctx, couponCode, ctx.Order.UserID, ctx.Order.ID); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> err</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 回滚积分扣减</span></span><br><span class="line">	<span class="keyword">if</span> points, ok := ctx.Cache[<span class="string">&quot;deducted_points&quot;</span>].(<span class="type">int</span>); ok &#123;</span><br><span class="line">		<span class="keyword">if</span> err := s.promotionService.RevertPointsDeduction(ctx.Ctx, ctx.Order.UserID, points); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> err</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *PromotionDeductionStep)</span></span> Compensate(ctx *OrderCreationContext) <span class="type">error</span> &#123;</span><br><span class="line">	<span class="comment">// 优惠券补偿</span></span><br><span class="line">	<span class="keyword">if</span> couponCode, ok := ctx.Cache[<span class="string">&quot;used_coupon&quot;</span>].(<span class="type">string</span>); ok &#123;</span><br><span class="line">		<span class="comment">// <span class="doctag">TODO:</span> 实现优惠券补偿逻辑</span></span><br><span class="line">		<span class="comment">// 1. 发送到补偿队列</span></span><br><span class="line">		<span class="comment">// 2. 记录补偿日志</span></span><br><span class="line">		<span class="comment">// 3. 通知运营人员</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 积分补偿</span></span><br><span class="line">	<span class="keyword">if</span> points, ok := ctx.Cache[<span class="string">&quot;deducted_points&quot;</span>].(<span class="type">int</span>); ok &#123;</span><br><span class="line">		<span class="comment">// <span class="doctag">TODO:</span> 实现积分补偿逻辑</span></span><br><span class="line">		<span class="comment">// 1. 发送到补偿队列</span></span><br><span class="line">		<span class="comment">// 2. 记录补偿日志</span></span><br><span class="line">		<span class="comment">// 3. 通知运营人员</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *PromotionDeductionStep)</span></span> Name() <span class="type">string</span> &#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="string">&quot;promotion_deduction&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// OrderFactory 订单工厂</span></span><br><span class="line"><span class="keyword">type</span> OrderFactory <span class="keyword">struct</span> &#123;</span><br><span class="line">	commonSteps []OrderCreationStep</span><br><span class="line">	typeSteps   <span class="keyword">map</span>[OrderType][]OrderCreationStep</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewOrderFactory</span><span class="params">()</span></span> *OrderFactory &#123;</span><br><span class="line">	f := &amp;OrderFactory&#123;</span><br><span class="line">		commonSteps: []OrderCreationStep&#123;</span><br><span class="line">			&amp;ParamValidationStep&#123;&#125;,</span><br><span class="line">			&amp;ProductValidationStep&#123;&#125;,</span><br><span class="line">			&amp;PromotionDeductionStep&#123;&#125;,</span><br><span class="line">		&#125;,</span><br><span class="line">		typeSteps: <span class="built_in">make</span>(<span class="keyword">map</span>[OrderType][]OrderCreationStep),</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 实物订单特有步骤</span></span><br><span class="line">	f.typeSteps[OrderTypePhysical] = []OrderCreationStep&#123;</span><br><span class="line">		&amp;StockValidationStep&#123;&#125;,</span><br><span class="line">		&amp;StockDeductionStep&#123;&#125;,</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 虚拟订单特有步骤</span></span><br><span class="line">	f.typeSteps[OrderTypeVirtual] = []OrderCreationStep&#123;&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 预售订单特有步骤</span></span><br><span class="line">	f.typeSteps[OrderTypePresale] = []OrderCreationStep&#123;</span><br><span class="line">		&amp;StockValidationStep&#123;&#125;,</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 酒店订单特有步骤</span></span><br><span class="line">	f.typeSteps[OrderTypeHotel] = []OrderCreationStep&#123;&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> f</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(f *OrderFactory)</span></span> GetSteps(orderType OrderType) []OrderCreationStep &#123;</span><br><span class="line">	steps := <span class="built_in">make</span>([]OrderCreationStep, <span class="number">0</span>)</span><br><span class="line">	steps = <span class="built_in">append</span>(steps, f.commonSteps...)</span><br><span class="line">	<span class="keyword">if</span> typeSteps, ok := f.typeSteps[orderType]; ok &#123;</span><br><span class="line">		steps = <span class="built_in">append</span>(steps, typeSteps...)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> steps</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Logger 日志接口</span></span><br><span class="line"><span class="keyword">type</span> Logger <span class="keyword">interface</span> &#123;</span><br><span class="line">	Info(msg <span class="type">string</span>, args ...<span class="keyword">interface</span>&#123;&#125;)</span><br><span class="line">	Error(msg <span class="type">string</span>, args ...<span class="keyword">interface</span>&#123;&#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// OrderCreationManager 订单创建管理器</span></span><br><span class="line"><span class="keyword">type</span> OrderCreationManager <span class="keyword">struct</span> &#123;</span><br><span class="line">	factory *OrderFactory</span><br><span class="line">	logger  Logger</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *OrderCreationManager)</span></span> CreateOrder(ctx context.Context, params <span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;) (*Order, <span class="type">error</span>) &#123;</span><br><span class="line">	orderCtx := &amp;OrderCreationContext&#123;</span><br><span class="line">		Ctx:                 ctx,</span><br><span class="line">		Params:              params,</span><br><span class="line">		Cache:               <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;),</span><br><span class="line">		StepResults:         <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="type">string</span>]StepResult),</span><br><span class="line">		RollbackFailedSteps: <span class="built_in">make</span>([]<span class="type">string</span>, <span class="number">0</span>),</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 初始化订单</span></span><br><span class="line">	order := &amp;Order&#123;</span><br><span class="line">		ID:        generateOrderID(),</span><br><span class="line">		UserID:    params[<span class="string">&quot;user_id&quot;</span>].(<span class="type">string</span>),</span><br><span class="line">		Type:      OrderType(params[<span class="string">&quot;type&quot;</span>].(<span class="type">string</span>)),</span><br><span class="line">		Status:    OrderStatusInit,</span><br><span class="line">		CreatedAt: time.Now(),</span><br><span class="line">		UpdatedAt: time.Now(),</span><br><span class="line">	&#125;</span><br><span class="line">	orderCtx.Order = order</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 获取订单类型对应的处理步骤</span></span><br><span class="line">	steps := m.factory.GetSteps(order.Type)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 执行步骤</span></span><br><span class="line">	executedSteps := <span class="built_in">make</span>([]OrderCreationStep, <span class="number">0</span>)</span><br><span class="line">	<span class="keyword">for</span> _, step := <span class="keyword">range</span> steps &#123;</span><br><span class="line">		stepName := step.Name()</span><br><span class="line">		m.logger.Info(<span class="string">&quot;executing step&quot;</span>, <span class="string">&quot;step&quot;</span>, stepName)</span><br><span class="line"></span><br><span class="line">		err := step.Execute(orderCtx)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			m.logger.Error(<span class="string">&quot;step execution failed&quot;</span>, <span class="string">&quot;step&quot;</span>, stepName, <span class="string">&quot;error&quot;</span>, err)</span><br><span class="line"></span><br><span class="line">			orderCtx.Errors = <span class="built_in">append</span>(orderCtx.Errors, err)</span><br><span class="line"></span><br><span class="line">			<span class="comment">// 执行回滚，并记录回滚失败的步骤</span></span><br><span class="line">			m.rollbackSteps(orderCtx, executedSteps)</span><br><span class="line"></span><br><span class="line">			<span class="comment">// 只对回滚失败的步骤进行补偿</span></span><br><span class="line">			<span class="keyword">if</span> <span class="built_in">len</span>(orderCtx.RollbackFailedSteps) &gt; <span class="number">0</span> &#123;</span><br><span class="line">				<span class="keyword">go</span> m.compensateFailedRollbacks(orderCtx)</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		executedSteps = <span class="built_in">append</span>(executedSteps, step)</span><br><span class="line">		m.logger.Info(<span class="string">&quot;step executed successfully&quot;</span>, <span class="string">&quot;step&quot;</span>, stepName)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> order, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 修改回滚逻辑，记录回滚失败的步骤</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *OrderCreationManager)</span></span> rollbackSteps(ctx *OrderCreationContext, steps []OrderCreationStep) &#123;</span><br><span class="line">	<span class="keyword">for</span> i := <span class="built_in">len</span>(steps) - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i-- &#123;</span><br><span class="line">		step := steps[i]</span><br><span class="line">		stepName := step.Name()</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> err := step.Rollback(ctx); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			m.logger.Error(<span class="string">&quot;step rollback failed&quot;</span>, <span class="string">&quot;step&quot;</span>, stepName, <span class="string">&quot;error&quot;</span>, err)</span><br><span class="line">			<span class="comment">// 记录回滚失败的步骤</span></span><br><span class="line">			ctx.RollbackFailedSteps = <span class="built_in">append</span>(ctx.RollbackFailedSteps, stepName)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 新的补偿方法，只处理回滚失败的步骤</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *OrderCreationManager)</span></span> compensateFailedRollbacks(ctx *OrderCreationContext) &#123;</span><br><span class="line">	m.logger.Info(<span class="string">&quot;starting compensation for failed rollbacks&quot;</span>,</span><br><span class="line">		<span class="string">&quot;failed_steps&quot;</span>, ctx.RollbackFailedSteps)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 获取所有步骤的映射</span></span><br><span class="line">	allSteps := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="type">string</span>]OrderCreationStep)</span><br><span class="line">	<span class="keyword">for</span> _, step := <span class="keyword">range</span> m.factory.GetSteps(ctx.Order.Type) &#123;</span><br><span class="line">		allSteps[step.Name()] = step</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 只对回滚失败的步骤进行补偿</span></span><br><span class="line">	<span class="keyword">for</span> _, failedStepName := <span class="keyword">range</span> ctx.RollbackFailedSteps &#123;</span><br><span class="line">		<span class="keyword">if</span> step, ok := allSteps[failedStepName]; ok &#123;</span><br><span class="line">			<span class="keyword">if</span> err := step.Compensate(ctx); err != <span class="literal">nil</span> &#123;</span><br><span class="line">				m.logger.Error(<span class="string">&quot;step compensation failed&quot;</span>,</span><br><span class="line">					<span class="string">&quot;step&quot;</span>, failedStepName,</span><br><span class="line">					<span class="string">&quot;error&quot;</span>, err)</span><br><span class="line"></span><br><span class="line">				<span class="comment">// 补偿失败处理</span></span><br><span class="line">				m.handleCompensationFailure(ctx, failedStepName, err)</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 处理补偿失败的情况</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *OrderCreationManager)</span></span> handleCompensationFailure(ctx *OrderCreationContext, stepName <span class="type">string</span>, err <span class="type">error</span>) &#123;</span><br><span class="line">	<span class="comment">// 创建补偿任务</span></span><br><span class="line">	compensationTask := CompensationTask&#123;</span><br><span class="line">		OrderID:    ctx.Order.ID,</span><br><span class="line">		StepName:   stepName,</span><br><span class="line">		Params:     ctx.Params,</span><br><span class="line">		Cache:      ctx.Cache,</span><br><span class="line">		RetryCount: <span class="number">0</span>,</span><br><span class="line">		MaxRetries: <span class="number">3</span>,</span><br><span class="line">		CreatedAt:  time.Now(),</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 记录错误日志</span></span><br><span class="line">	m.logger.Error(<span class="string">&quot;compensation task created for failed step&quot;</span>,</span><br><span class="line">		<span class="string">&quot;order_id&quot;</span>, compensationTask.OrderID,</span><br><span class="line">		<span class="string">&quot;step&quot;</span>, compensationTask.StepName,</span><br><span class="line">		<span class="string">&quot;error&quot;</span>, err)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// <span class="doctag">TODO:</span> 实现具体的补偿任务处理逻辑</span></span><br><span class="line">	<span class="comment">// 1. 将任务保存到数据库</span></span><br><span class="line">	<span class="comment">// 2. 发送到消息队列</span></span><br><span class="line">	<span class="comment">// 3. 触发告警</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// DefaultLogger 默认日志实现</span></span><br><span class="line"><span class="keyword">type</span> DefaultLogger <span class="keyword">struct</span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewDefaultLogger</span><span class="params">()</span></span> Logger &#123;</span><br><span class="line">	<span class="keyword">return</span> &amp;DefaultLogger&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *DefaultLogger)</span></span> Info(msg <span class="type">string</span>, args ...<span class="keyword">interface</span>&#123;&#125;) &#123;</span><br><span class="line">	log.Printf(<span class="string">&quot;INFO: &quot;</span>+msg, args...)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *DefaultLogger)</span></span> Error(msg <span class="type">string</span>, args ...<span class="keyword">interface</span>&#123;&#125;) &#123;</span><br><span class="line">	log.Printf(<span class="string">&quot;ERROR: &quot;</span>+msg, args...)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 辅助函数</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">generateOrderID</span><span class="params">()</span></span> <span class="type">string</span> &#123;</span><br><span class="line">	<span class="keyword">return</span> fmt.Sprintf(<span class="string">&quot;ORDER_%d&quot;</span>, time.Now().UnixNano())</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// CompensationTask 补偿任务结构</span></span><br><span class="line"><span class="keyword">type</span> CompensationTask <span class="keyword">struct</span> &#123;</span><br><span class="line">	OrderID    <span class="type">string</span></span><br><span class="line">	StepName   <span class="type">string</span></span><br><span class="line">	Params     <span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;</span><br><span class="line">	Cache      <span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;</span><br><span class="line">	RetryCount <span class="type">int</span></span><br><span class="line">	MaxRetries <span class="type">int</span></span><br><span class="line">	CreatedAt  time.Time</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// StockCompensationMessage 库存补偿消息</span></span><br><span class="line"><span class="keyword">type</span> StockCompensationMessage <span class="keyword">struct</span> &#123;</span><br><span class="line">	OrderID   <span class="type">string</span></span><br><span class="line">	ProductID <span class="type">string</span></span><br><span class="line">	Quantity  <span class="type">int</span></span><br><span class="line">	Timestamp time.Time</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p></code></pre></p>
</details>


<h4 id="支付"><a href="#支付" class="headerlink" title="支付"></a>支付</h4><h5 id="支付流程"><a href="#支付流程" class="headerlink" title="支付流程"></a>支付流程</h5><p align="center">
  <img src="/images/order_pay.png" width=800 height=1800>
</p>
1. 支付校验。用户校验，订单状态校验等
2. 营销活动扣减deduction、回滚rollback、补偿compensation.
3. 支付初始化
4. 支付回调
5. 补偿队列
6. OrderBus 订单事件

<h5 id="支付状态的设计"><a href="#支付状态的设计" class="headerlink" title="支付状态的设计"></a>支付状态的设计</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">P0: PAYMENT_NOT_STARTED - 未开始</span><br><span class="line">P1: PAYMENT_PENDING - 支付中,用户点击了pay按钮，等待支付）</span><br><span class="line"></span><br><span class="line">P2: MARKETING_Init - 营销初始化</span><br><span class="line">P3: MARKETING_FAILED - 营销扣减失败</span><br><span class="line">P4: MARKETING_SUCCESS - 营销扣减成功</span><br><span class="line"></span><br><span class="line">P5: PAYMENT_INITIALIZED - 支付初始化</span><br><span class="line">P6: PAYMENT_INITIALIZED_FAILED - 支付初始化失败</span><br><span class="line">P7: PAYMENT_PROCESSING - 支付处理中。（支付系统正在处理支付请求）</span><br><span class="line">P8: PAYMENT_SUCCESS - 支付成功</span><br><span class="line">P9: PAYMENT_FAILED - 支付失败</span><br><span class="line">P10: PAYMENT_CANCELLED - 支付取消</span><br><span class="line">P11: PAYMENT_TIMEOUT - 支付超时</span><br></pre></td></tr></table></figure>
<h5 id="异常和补偿设计"><a href="#异常和补偿设计" class="headerlink" title="异常和补偿设计"></a>异常和补偿设计</h5><p>常见的异常：<br>营销部分：</p>
<ol>
<li>营销扣减补偿操作重复。（营销接口幂等设计）</li>
<li>营销已经扣减了，但是后续步骤失败，需要回滚扣减的操作。（业务代码中需要有rollback操作）</li>
<li>营销已经扣减了，回滚扣减失败。延时队列任务补偿。（回滚失败发送延时队列，任务补偿）</li>
<li>营销已经扣减了，写延时队列失败，任务没有补偿成功。（补偿任务通过扫描异常单进行补偿）</li>
<li>营销已经扣减了，延时队列消息重复，重复回滚。（依赖营销系统的幂等操作）</li>
<li>营销已经扣减了，请求已经发给了营销服务，营销服务已经扣减了，但是回包失败。（请求营销接口之前更新订单状态为P2,针对P2的订单进行补偿）</li>
</ol>
<p>支付部分：</p>
<ol>
<li>重复支付。（支付接口幂等设计）</li>
<li>支付初始化请求支付成功，但是回包失败（重续针对P5的订单进行补偿，查询支付系统是否收单，已经支付结果查询）</li>
<li>支付回调包重复，更新回调结果幂等。</li>
<li>支付回调包丢失，对于P7支付单需要补偿。</li>
</ol>
<h4 id="履约"><a href="#履约" class="headerlink" title="履约"></a>履约</h4><h5 id="履约核心流程"><a href="#履约核心流程" class="headerlink" title="履约核心流程"></a>履约核心流程</h5><p align="center">
  <img src="/images/order_fulfillment.png" width=700 height=1500>
</p>


<h5 id="履约状态机的设计"><a href="#履约状态机的设计" class="headerlink" title="履约状态机的设计"></a>履约状态机的设计</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">F0: FULFILLMENT_NOT_STARTED - 未开始</span><br><span class="line">F1: FULFILLMENT_PENDING - 履约开始</span><br><span class="line">F2: FULFILLMENT_PROCESSING - 履约处理中</span><br><span class="line">F3: FULFILLMENT_FAILED - 履约失败</span><br><span class="line">F4: FULFILLMENT_SUCCESS - 履约成功</span><br><span class="line">F5: FULFILLMENT_CANCELLED - 履约取消</span><br></pre></td></tr></table></figure>

<h5 id="异常和补偿的设计"><a href="#异常和补偿的设计" class="headerlink" title="异常和补偿的设计"></a>异常和补偿的设计</h5><ol>
<li>订阅支付完成的事件O2</li>
<li>在请求fulfillment&#x2F;init履约初始化之前，更新订单状态为F1</li>
<li>fulfillment&#x2F;init 接口的回包丢了。（针对F1订单进行补偿）</li>
<li>fulfillment&#x2F;init 重复请求（幂等设计）</li>
<li>F2订单补偿。（fulfillment&#x2F;callback 丢包，处理失败等）</li>
</ol>
<h4 id="return-refund"><a href="#return-refund" class="headerlink" title="return &amp; refund"></a>return &amp; refund</h4><p align="center">
  <img src="/images/return-refund.png" width=700 height=2000>
</p>

<h5 id="主要流程"><a href="#主要流程" class="headerlink" title="主要流程"></a>主要流程</h5><ol>
<li>订单服务作为协调者。与履约服务、营销服务、支付服务解耦</li>
<li>用 OrderBus 进行事件传递</li>
<li>状体机设计</li>
<li>异常处理</li>
</ol>
<h5 id="异常和补偿机制"><a href="#异常和补偿机制" class="headerlink" title="异常和补偿机制"></a>异常和补偿机制</h5><ol>
<li>退货环节异常</li>
</ol>
<ul>
<li>退货初始化失败：直接发送退款失败事件</li>
<li>退货回调失败：更新状态为 R7，发送失败事件</li>
</ul>
<ol start="2">
<li>营销退款异常</li>
</ol>
<ul>
<li>营销处理失败：更新状态为 R14，发送失败事件</li>
<li>营销处理成功：更新状态为 R13，继续后续流程</li>
</ul>
<ol start="3">
<li>支付退款异常</li>
</ol>
<ul>
<li>支付退款失败：更新状态为 R11，发送失败事件</li>
<li>支付退款成功：更新状态为 R10，发送成功事件</li>
</ul>
<h5 id="订单详情查询"><a href="#订单详情查询" class="headerlink" title="订单详情查询"></a>订单详情查询</h5><h2 id="系统挑战和解决方案"><a href="#系统挑战和解决方案" class="headerlink" title="系统挑战和解决方案"></a>系统挑战和解决方案</h2><h3 id="如何维护订单状态的最终一致性？"><a href="#如何维护订单状态的最终一致性？" class="headerlink" title="如何维护订单状态的最终一致性？"></a>如何维护订单状态的最终一致性？</h3><p align="center">
  <img src="/images/order_final_consistency_activity.png" width=600 height=600>
</p>

<h4 id="不一致的原因"><a href="#不一致的原因" class="headerlink" title="不一致的原因"></a>不一致的原因</h4><ul>
<li>重复请求</li>
<li>丢包。例如，请求发货，对方收单，回包失败。</li>
<li>资源回滚：营销、库存</li>
<li>并发问题</li>
</ul>
<h4 id="状态机"><a href="#状态机" class="headerlink" title="状态机"></a>状态机</h4><ul>
<li>设计层面，严格的状态转换规则 + 状态转换的触发事件</li>
<li>状态转换的原子性。（事务性）</li>
</ul>
<h4 id="并发更新数据库前，要用乐观锁或者悲观锁，"><a href="#并发更新数据库前，要用乐观锁或者悲观锁，" class="headerlink" title="并发更新数据库前，要用乐观锁或者悲观锁，"></a>并发更新数据库前，要用乐观锁或者悲观锁，</h4><ul>
<li>乐观锁：同时在更新时判断版本号是否是之前取出来的版本号，更新成功就结束</li>
<li>悲观锁：先使用select for update进行锁行记录，然后更新</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">UPDATE</span> orders </span><br><span class="line">  <span class="keyword">SET</span> status <span class="operator">=</span> <span class="string">&#x27;NEW_STATUS&#x27;</span>, </span><br><span class="line">      version <span class="operator">=</span> version <span class="operator">+</span> <span class="number">1</span> </span><br><span class="line">  <span class="keyword">WHERE</span> id <span class="operator">=</span> ? <span class="keyword">AND</span> version <span class="operator">=</span> ?</span><br><span class="line"></span><br><span class="line">  <span class="keyword">BEGIN</span>;</span><br><span class="line">  <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> orders <span class="keyword">WHERE</span> id <span class="operator">=</span> ? <span class="keyword">FOR</span> <span class="keyword">UPDATE</span>;</span><br><span class="line">  <span class="keyword">UPDATE</span> orders <span class="keyword">SET</span> status <span class="operator">=</span> <span class="string">&#x27;NEW_STATUS&#x27;</span> <span class="keyword">WHERE</span> id <span class="operator">=</span> ?;</span><br><span class="line">  <span class="keyword">COMMIT</span>;</span><br></pre></td></tr></table></figure>


<h4 id="幂等设计。比如重复支付、重复扣减营销、重复履约等"><a href="#幂等设计。比如重复支付、重复扣减营销、重复履约等" class="headerlink" title="幂等设计。比如重复支付、重复扣减营销、重复履约等"></a>幂等设计。比如重复支付、重复扣减营销、重复履约等</h4><ul>
<li>支付重复支付，支付回调幂等设计。</li>
<li>重复营销扣减，回滚，</li>
<li>重复履约</li>
<li>重复回调</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 使用支付单号作为幂等键</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handlePaymentCallback</span><span class="params">(String paymentId, String status)</span> &#123;</span><br><span class="line">    <span class="comment">// 检查是否已处理</span></span><br><span class="line">    <span class="keyword">if</span> (isProcessed(paymentId)) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 处理支付回调</span></span><br><span class="line">    processPaymentCallback(paymentId, status);</span><br><span class="line">    <span class="comment">// 记录处理状态</span></span><br><span class="line">    markAsProcessed(paymentId);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">   <span class="comment">// 使用订单号+营销资源ID作为幂等键</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">deductMarketingResource</span><span class="params">(String orderId, String resourceId)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (isDeducted(orderId, resourceId)) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 扣减营销资源</span></span><br><span class="line">    deductResource(orderId, resourceId);</span><br><span class="line">    <span class="comment">// 记录扣减状态</span></span><br><span class="line">    markAsDeducted(orderId, resourceId);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="补偿机制兜底"><a href="#补偿机制兜底" class="headerlink" title="补偿机制兜底"></a>补偿机制兜底</h4><ul>
<li>异常回滚。营销扣减回滚</li>
<li>消息队列补偿：补偿队列，重试。（可能丢消息）</li>
<li>定时任务补偿：扫表补偿</li>
<li>依赖方支付查询和幂等设计</li>
</ul>
<h4 id="分布式事务"><a href="#分布式事务" class="headerlink" title="分布式事务"></a>分布式事务</h4><ul>
<li>营销扣减</li>
<li>库存扣减</li>
<li>支付等业务</li>
<li>实现状态转换和业务操作在同一个事务中完成 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">processOrderWithDistributedTransaction</span><span class="params">(Order order)</span> &#123;</span><br><span class="line">     <span class="keyword">try</span> &#123;</span><br><span class="line">         <span class="comment">// 1. 更新订单状态</span></span><br><span class="line">         updateOrderStatus(order);</span><br><span class="line">         <span class="comment">// 2. 扣减库存</span></span><br><span class="line">         deductInventory(order);</span><br><span class="line">         <span class="comment">// 3. 创建物流单</span></span><br><span class="line">         createLogistics(order);</span><br><span class="line">     &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">         <span class="comment">// 触发补偿机制</span></span><br><span class="line">         triggerCompensation(order);</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="异常单人工介入-1"><a href="#异常单人工介入-1" class="headerlink" title="异常单人工介入"></a>异常单人工介入</h4><h4 id="对账机制"><a href="#对账机制" class="headerlink" title="对账机制"></a>对账机制</h4><h3 id="商品信息缓存和数据一致性"><a href="#商品信息缓存和数据一致性" class="headerlink" title="商品信息缓存和数据一致性"></a>商品信息缓存和数据一致性</h3><p align="center">
  <img src="/images/item-info-cache.png" width=600 height=500>
</p>

<h3 id="主从架构中如何获取最新的数据，避免因为主从延时导致获得脏数据"><a href="#主从架构中如何获取最新的数据，避免因为主从延时导致获得脏数据" class="headerlink" title="主从架构中如何获取最新的数据，避免因为主从延时导致获得脏数据"></a>主从架构中如何获取最新的数据，避免因为主从延时导致获得脏数据</h3><p align="center">
  <img src="/images/master-slave-get-latest-data.png" width=500 height=400>
</p>

<table>
<thead>
<tr>
<th><strong>策略</strong></th>
<th><strong>优点</strong></th>
<th><strong>缺点</strong></th>
</tr>
</thead>
<tbody><tr>
<td><strong>1. 直接读取主库</strong></td>
<td>- <strong>一致性:</strong> 始终获取最新的数据。</td>
<td>- <strong>性能:</strong> 增加主库的负载，可能导致性能瓶颈。</td>
</tr>
<tr>
<td></td>
<td>- <strong>简单性:</strong> 实现简单直接，因为它直接查询可信的源。</td>
<td>- <strong>可扩展性:</strong> 主库可能成为瓶颈，限制系统在高读流量下有效扩展的能力。</td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td><strong>2. 使用VersionCache与从库</strong></td>
<td>- <strong>性能:</strong> 分散读取负载到从库，减少主库的压力。</td>
<td>- <strong>复杂性:</strong> 实现更加复杂，需要进行缓存管理并处理潜在的不一致性问题。</td>
</tr>
<tr>
<td></td>
<td>- <strong>可扩展性:</strong> 通过将大部分读取操作卸载到从库，实现更好的扩展性。</td>
<td>- <strong>缓存管理:</strong> 需要进行适当的缓存失效处理和同步，以确保数据的一致性。</td>
</tr>
<tr>
<td></td>
<td>- <strong>一致性:</strong> 通过比较版本并在必要时回退到主库，提供确保最新数据的机制。</td>
<td>- <strong>潜在延迟:</strong> 从库的数据可能仍然存在不同步的可能性，导致数据更新前有轻微延迟。</td>
</tr>
</tbody></table>
<h3 id="常见问题1-重复下单、支付、履约问题（重复和幂等问题"><a href="#常见问题1-重复下单、支付、履约问题（重复和幂等问题" class="headerlink" title="常见问题1: 重复下单、支付、履约问题（重复和幂等问题)"></a>常见问题1: 重复下单、支付、履约问题（重复和幂等问题)</h3><p>场景：</p>
<ol>
<li>下单、去重、DB唯一键兜底。去重逻辑是约定的</li>
<li>支付、checkoutid，唯一键</li>
<li>履约、先获取reference id，再履约</li>
</ol>
<p>解决方案：</p>
<ol>
<li><p>前端方案<br>前端通过js脚本控制，无法解决用户刷新提交的请求。另外也无法解决恶意提交。<br>不建议采用该方案，如果想用，也只是作为一个补充方案。</p>
</li>
<li><p>中间环节去重。根据请求参数中间去重<br>当用户点击购买按钮时，渲染下单页面，展示商品、收货地址、运费、价格等信息，同时页面会埋上 Token 信息，用户提交订单时，后端业务逻辑会校验token，有且匹配才认为是合理请求。</p>
</li>
<li><p>利用数据库自身特性 “主键唯一约束”，在插入订单记录时，带上主键值，如果订单重复，记录插入会失败。<br>操作过程如下：<br>引入一个服务，用于生成一个”全局唯一的订单号”；<br>进入创建订单页面时，前端请求该服务，预生成订单ID；<br>提交订单时，请求参数除了业务参数外，还要带上这个预生成订单ID</p>
</li>
</ol>
<h3 id="快照和操作日志"><a href="#快照和操作日志" class="headerlink" title="快照和操作日志"></a>快照和操作日志</h3><p>为了保证数据的 完整性、可追溯性，写操作需要关注的问题<br>场景：<br>商品信息是可以修改的，当用户下单后，为了更好解决后面可能存在的买卖纠纷，创建订单时会同步保存一份商品详情信息，称之为订单快照</p>
<p>解决方案：<br>同一件商品，会有很多用户会购买，如果热销商品，短时间就会有上万的订单。如果每个订单都创建一份快照，存储成本太高。另外商品信息虽然支持修改，但毕竟是一个低频动作。我们可以理解成，大部分订单的商品快照信息都是一样的，除非下单时用户修改过。<br>如何实时识别修改动作是解决快照成本的关键所在。我们采用摘要比对的方法‍。创建订单时，先检查商品信息摘要是否已经存在，如果不存在，会创建快照记录。订单明细会关联商品的快照主键。</p>
<p>账户余额更新，保证事务<br>用户支付，我们要从买家账户减掉一定金额，再往卖家增加一定金额，为了保证数据的 完整性、可追溯性， 变更余额时，我们通常会同时插入一条 记录流水。</p>
<p>账户流水核心字段： 流水ID、金额、交易双方账户、交易时间戳、订单号。<br>账户流水只能新增，不能修改和删除。流水号必须是自增的。<br>后续，系统对账时，我们只需要对交易流水明细数据做累计即可，如果出现和余额不一致情况，一般以交易流水为准来修复余额数据。<br>更新余额、记录流水 虽属于两个操作，但是要保证要么都成功，要么都失败。要做到事务。<br>当然，如果涉及多个微服务调用，会用到 分布式事务。<br>分布式事务，细想下也很容易理解，就是 将一个大事务拆分为多个本地事务， 本地事务依然借助于数据库自身事务来解决，难点在于解决这个分布式一致性问题，借助重试机制，保证最终一致是我们常用的方案。</p>
<h3 id="常见问题3-并发更新的ABA问题-（订单表的version"><a href="#常见问题3-并发更新的ABA问题-（订单表的version" class="headerlink" title="常见问题3: 并发更新的ABA问题 （订单表的version)"></a>常见问题3: 并发更新的ABA问题 （订单表的version)</h3><p>场景：<br>商家发货，填写运单号，开始填了 123，后来发现填错了，然后又修改为 456。此时，如果就为某种特殊场景埋下错误伏笔，具体我们来看下，过程如下：<br>开始「请求A」发货，调订单服务接口，更新运单号 123，但是响应有点慢，超时了；<br>此时，商家发现运单号填错了，发起了「请求B」，更新运单号为 456 ，订单服务也响应成功了；<br>这时，「请求A」触发了重试，再次调用订单服务，更新运单号 123，订单服务也响应成功了；订单服务最后保存的 运单号 是 123。</p>
<p>是不是犯错了！！！！，那么有什么好的解决方案吗？<br>数据库表引入一个额外字段 version ，每次更新时，判断表中的版本号与请求参数携带的版本号是否一致。这个版本字段可以是时间戳<br>复制<br>update order<br>set logistics_num &#x3D; #{logistics_num} , version &#x3D; #{version} + 1<br>where order_id&#x3D; 1111 and version &#x3D; #{version}</p>
<h3 id="秒杀系统中的库存管理和订单蓄洪"><a href="#秒杀系统中的库存管理和订单蓄洪" class="headerlink" title="秒杀系统中的库存管理和订单蓄洪"></a>秒杀系统中的库存管理和订单蓄洪</h3><p>常见的库存扣减方式有：<br>下单减库存： 即当买家下单后，在商品的总库存中减去买家购买数量。下单减库存是最简单的减库存方式，也是控制最精确的一种，但是有些人下完单可能并不会付款。<br>付款减库存： 即买家下单后，并不立即减库存，而是等到有用户付款后才真正减库存，否则库存一直保留给其他买家。但因为付款时才减库存，如果并发比较高，有可能出现买家下单后付不了款的情况，因为可能商品已经被其他人买走了。<br>预扣库存： 这种方式相对复杂一些，买家下单后，库存为其保留一定的时间（如 30 分钟），超过这个时间，库存将会自动释放，释放后其他买家就可以继续购买。在买家付款前，系统会校验该订单的库存是否还有保留：如果没有保留，则再次尝试预扣；<br>方案一：数据库乐观锁扣减库存<br>通常在扣减库存的场景下使用行级锁，通过数据库引擎本身对记录加锁的控制，保证数据库的更新的安全性，并且通过where语句的条件，保证库存不会被减到 0 以下，也就是能够有效的控制超卖的场景。<br>先查库存<br>然后乐观锁更新：update … set amount &#x3D; amount - 1 where id &#x3D; $id and amount &#x3D; x<br>设置数据库的字段数据为无符号整数，这样减后库存字段值小于零时 SQL 语句会报错<br>方案二：redis 扣减库存，异步同步到DB<br>redis 原子操作扣减库存<br>异步通过MQ消息同步到DB</p>
<h3 id="购物车模块的实现和优化"><a href="#购物车模块的实现和优化" class="headerlink" title="购物车模块的实现和优化"></a>购物车模块的实现和优化</h3><p>技术设计并不是特别复杂，存储的信息也相对有限（用户id、商品id、sku_id、数量、添加时间）。这里特别拿出来单讲主要是用户体验层面要注意几个问题：<br>添加购物车时，后端校验用户未登录，常规思路，引导用户跳转登录页，待登录成功后，再添加购物车。多了一步操作，给用户一种强迫的感觉，体验会比较差。有没有更好的方式？<br>如果细心体验京东、淘宝等大平台，你会发现即使未登录态也可以添加购物车，这到底是怎么实现的？<br>细细琢磨其实原理并不复杂，服务端这边在用户登录态校验时，做了分支路由，当用户未登录时，会创建一个临时Token，作为用户的唯一标识，购物车数据挂载在该Token下，为了避免购物车数据相互影响以及设计的复杂度，这里会有一个临时购物车表。<br>当然，临时购物车表的数据量并不会太大，why？用户不会一直闲着添加购物车玩，当用户登录后，查看自己的购物车，服务端会从请求的cookie里查找购物车Token标识，并查询临时购物车表是否有数据，然后合并到正式购物车表里。<br>临时购物车是不是一定要在服务端存储？未必。<br>有架构师倾向前置存储，将数据存储在浏览器或者 APP LocalStorage， 这部分数据毕竟不是共享的，但是不太好的增加了设计的复杂度。</p>
<p>客户端需要借助本地数据索引，远程请求查完整信息；<br>如果是登录态，还要增加数据合并逻辑；<br>考虑到这两部分数据只是用户标识的差异性，所以作者还是建议统一存到服务端，日后即使业务逻辑变更，只需要改一处就可以了，毕竟自运营系统，良好的可维护性也需要我们非常关注的。</p>
<p>购物车是电商系统的标配功能，暂存用户想要购买的商品。</p>
<ul>
<li>分为添加商品、列表查看、结算下单三个动作。</li>
<li>用户未登录时，将数据存储在浏览器或者 APP LocalStorage。登录后写入后端</li>
<li>后端使用DB，为了性能考虑可以结合redis和DB联合存储</li>
<li>存redis定期同步到DB</li>
<li>前后端联合存储</li>
</ul>
<h3 id="系统中的分布式ID是怎么生成的"><a href="#系统中的分布式ID是怎么生成的" class="headerlink" title="系统中的分布式ID是怎么生成的"></a>系统中的分布式ID是怎么生成的</h3><p>item ID 自增。（100w级别）<br>order id. 时间戳 + 机器ID + uid % 100 + sequence<br>DP唯一ID生成调研说明<br>request 生成方法：时间戳 + 机器mac地址 + sequence</p>
<h2 id="系统稳定性建设"><a href="#系统稳定性建设" class="headerlink" title="系统稳定性建设"></a>系统稳定性建设</h2><h3 id="Google-理论：怎样的系统算是稳定高可用的"><a href="#Google-理论：怎样的系统算是稳定高可用的" class="headerlink" title="Google 理论：怎样的系统算是稳定高可用的"></a>Google 理论：怎样的系统算是稳定高可用的</h3><p>Google SRE中(SRE三部曲[1])有一个层级模型来描述系统可靠性基础和高层次需求(Dickerson’s Hierarchy of Service Reliability)，如下图：</p>
<p align="center">
  <img src="/images/service-reliability-hierarchy.png" width=600 height=500>
  <br/>
</p>


<p>该模型由Google SRE工程师Mikey Dickerson在2013年提出，将系统稳定性需求按照基础程度进行了不同层次的体系化区分，形成稳定性标准金字塔模型:</p>
<ol>
<li><p>金字塔的底座是监控(Monitoring)，这是一个系统对于稳定性最基础的要求，缺少监控的系统，如同蒙上眼睛狂奔的野马，无从谈及可控性，更遑论稳定性。</p>
</li>
<li><p>更上层是应急响应(Incident Response)，从一个问题被监控发现到最终解决，这期间的耗时直接取决于应急响应机制的成熟度。合理的应急策略能保证当故障发生时，所有问题能得到有序且妥善的处理，而不是慌乱成一锅粥。</p>
</li>
<li><p>研发流程规范</p>
</li>
</ol>
<ul>
<li>测试和发布管控(Testing&amp;Release procedures),大大小小的应用都离不开不断的变更与发布,有效的测试与发布策略能保障系统所有新增变量都处于可控稳定区间内，从而达到整体服务终态稳定</li>
<li>事后总结以及根因分析(Postmortem&amp;Root Caue Analysis)，即我们平时谈到的”复盘”，虽然很多人都不太喜欢这项活动，但是不得不承认这是避免我们下次犯同样错误的最有效手段，只有当摸清故障的根因以及对应的缺陷，我们才能对症下药，合理进行规避</li>
</ul>
<ol start="4">
<li><p>容量规划(Capacity Planning)则是针对于这方面变化进行的保障策略。现有系统体量是否足够支撑新的流量需求，整体链路上是否存在不对等的薄弱节点，都是容量规划需要考虑的问题。</p>
</li>
<li><p>高可用性产品设计(Product)与软件研发(Development)，即通过优秀的产品设计与软件设计使系统具备更高的可靠性，构建高可用产品架构体系，从而提升用户体验</p>
</li>
<li><p>除此之外，还需要系统资损防控等</p>
</li>
</ol>
<p>下面也会从六个个方面分别介绍</p>
<p align="center">
  <img src="/images/13-reliability-mindmap.png" width=600 height=900>
  <br/>
</p>


<h3 id="可观测性设计"><a href="#可观测性设计" class="headerlink" title="可观测性设计"></a>可观测性设计</h3><h4 id="监控指标-完备性"><a href="#监控指标-完备性" class="headerlink" title="监控指标 - 完备性"></a>监控指标 - 完备性</h4><p align="center">
  <img src="/images/monitor-system.png" width=600 height=900>
  <br/>
</p>

<table>
<thead>
<tr>
<th>监控类型</th>
<th>监控指标</th>
</tr>
</thead>
<tbody><tr>
<td>业务监控</td>
<td>- 订单量、GMV、转化率等业务KPI<br>- 用户活跃度、留存率等用户指标<br>- 支付成功率、退款率等交易指标<br>- 下单失败率<br>- 支付超时率<br>- 库存不足率</td>
</tr>
<tr>
<td>应用监控</td>
<td>- 接口响应时间(RT)<br>- 接口调用量(QPS)<br>- 接口成功率<br>- 应用JVM指标<br>- 线程池使用情况<br>- 应用日志监控</td>
</tr>
<tr>
<td>系统监控</td>
<td>- 服务器CPU&#x2F;内存&#x2F;磁盘使用率<br>- 网络带宽使用率<br>- 系统负载<br>- 容器资源使用情况<br>- 网关流量&#x2F;延迟&#x2F;错误率</td>
</tr>
<tr>
<td>外部依赖</td>
<td>- RPC调用成功率&#x2F;延迟<br>- 数据库连接池状态&#x2F;慢查询<br>- 缓存命中率&#x2F;延迟<br>- 消息队列积压量&#x2F;消费延迟<br>- 第三方服务调用成功率&#x2F;超时率<br>- 分布式锁获取成功率<br>- 分布式事务状态<br>- CDN服务质量<br>- 对象存储可用性</td>
</tr>
<tr>
<td>其它</td>
<td>- 安全相关指标(登录失败&#x2F;异常IP等)<br>- 业务告警统计&#x2F;处理率<br>- 系统变更记录&#x2F;回滚率<br>- 运维操作审计<br>- 数据备份状态<br>- 证书过期监控<br>- 配置变更记录<br>- 资源成本监控<br>- 服务SLA达标率</td>
</tr>
</tbody></table>
<h4 id="告警-实时性和有效性"><a href="#告警-实时性和有效性" class="headerlink" title="告警 - 实时性和有效性"></a>告警 - 实时性和有效性</h4><p>是不是每项监控都需要告警？答案当然是否定的。建议优先设置Biz层告警，因为Biz层我们对外服务最直观业务表现，最贴切用户感受。Application&amp;System层指标主要用于监控，部分关键&amp;高风险指标可设置告警，用于问题排查定位以及故障提前发现。对于一项告警，我们一般需要关注级别、阈值、通知人等几个点。</p>
<ol>
<li>级别<br>即当前告警被触发时，问题的严重程度，一般来说有几个衡量点：</li>
</ol>
<ul>
<li>是否关联NOC.影响业务指标，事故级别</li>
<li>是否影响核心链路，应用指标异常</li>
<li>是否产生资损</li>
</ul>
<ol start="2">
<li>阈值</li>
</ol>
<ul>
<li>即一项告警的触发条件&amp;时间，需根据具体场景合理制定。一般遵循以下原则：</li>
<li>不可过于迟钝。一个合理的监控体系中，任何异常发生后都应触发相关告警。</li>
<li>不可过于敏感。过于敏感的阈值会造成频繁告警，从而导致响应人员疲劳应对，无法筛选真实异常。若一个告警频繁出现，一般是两个原因：系统设计不合理 or 阈值设置不合理。</li>
<li>若单一指标无法反馈覆盖整体业务场景，可结合多项指标关联构建。</li>
<li>需符合业务波动曲线，不同时段可设置不同条件&amp;通知策略。</li>
<li>定期review 告警指标合理性</li>
</ul>
<ol start="3">
<li>通知人&amp;方式</li>
</ol>
<ul>
<li>若为业务指标异常(Biz层告警)，通知人应为问题处理人员(开发、运维同学)与业务关注人员(TL、业务同学)的集合，通知方式较为实时，比如电话通知。</li>
<li>若为应用 &amp; 系统层告警，主要用于定位异常原因，通知人设置问题排查处理人员即可，通知方式可考虑钉钉、短信等低干扰方式。</li>
<li>除了关联层次，对于不同级别的告警，通知人范围也可适当扩大，尤其是关联GOC故障的告警指标，应适当放宽范围，通知方式也应更为实时直接</li>
</ul>
<h4 id="日志体系"><a href="#日志体系" class="headerlink" title="日志体系"></a>日志体系</h4><ul>
<li>日志收集</li>
<li>日志分析</li>
<li>日志存储</li>
<li>日志检索</li>
</ul>
<h4 id="追踪体系"><a href="#追踪体系" class="headerlink" title="追踪体系"></a>追踪体系</h4><ul>
<li>分布式追踪</li>
<li>性能分析</li>
<li>异常追踪</li>
<li>依赖分析</li>
</ul>
<h3 id="异常应急策略"><a href="#异常应急策略" class="headerlink" title="异常应急策略"></a>异常应急策略</h3><p>常用的应急策略</p>
<ul>
<li>降级策略</li>
<li>限流策略</li>
<li>熔断策略</li>
<li>超时配置化(context 超时配置和传递)</li>
<li>补偿策略</li>
<li>其它业务策略：<ul>
<li>商品暂停销售</li>
<li>营销券暂停发送等</li>
</ul>
</li>
</ul>
<h4 id="降级策略"><a href="#降级策略" class="headerlink" title="降级策略"></a>降级策略</h4><table>
<thead>
<tr>
<th>策略类型</th>
<th>具体场景</th>
<th>实现方式</th>
<th>应用案例</th>
<th>配置建议</th>
</tr>
</thead>
<tbody><tr>
<td>降级策略</td>
<td>服务降级</td>
<td>降级开关</td>
<td>推荐服务返回本地缓存</td>
<td>开关粒度: 接口级<br>降级时长: 5min</td>
</tr>
<tr>
<td></td>
<td>功能降级</td>
<td>业务降级</td>
<td>搜索服务简化召回逻辑</td>
<td>降级优先级配置<br>降级比例配置</td>
</tr>
</tbody></table>
<h4 id="限流策略"><a href="#限流策略" class="headerlink" title="限流策略"></a>限流策略</h4><table>
<thead>
<tr>
<th>策略类型</th>
<th>具体场景</th>
<th>实现方式</th>
<th>应用案例</th>
<th>配置建议</th>
</tr>
</thead>
<tbody><tr>
<td>限流策略</td>
<td>单机接口限流（粗略）</td>
<td>令牌桶&#x2F;漏桶算法</td>
<td>下单接口限制QPS为1000</td>
<td>QPS: 1000<br>突发流量: 1200</td>
</tr>
<tr>
<td></td>
<td>分布式限流(全局限流)</td>
<td>Redis + Lua脚本</td>
<td>秒杀接口全局限限流 \n 用户维度限流</td>
<td>全局QPS: 5000<br>单机QPS: 1000,时间窗口: 1min<br>最大请求数: 5</td>
</tr>
</tbody></table>
<h4 id="熔断策略"><a href="#熔断策略" class="headerlink" title="熔断策略"></a>熔断策略</h4><table>
<thead>
<tr>
<th>策略类型</th>
<th>具体场景</th>
<th>实现方式</th>
<th>应用案例</th>
<th>配置建议</th>
</tr>
</thead>
<tbody><tr>
<td>熔断策略</td>
<td>服务调用熔断</td>
<td>Hystrix-go</td>
<td>外部支付服务调用保护</td>
<td>错误阈值: 50%<br>最小请求数: 20<br>超时时间: 1s</td>
</tr>
<tr>
<td></td>
<td>中间件数据库、缓存熔断</td>
<td>Circuit Breaker</td>
<td>数据库访问保护,缓存访问保护</td>
<td>错误阈值: 30%<br>恢复时间: 5s</td>
</tr>
</tbody></table>
<h4 id="补偿策略"><a href="#补偿策略" class="headerlink" title="补偿策略"></a>补偿策略</h4><table>
<thead>
<tr>
<th>策略类型</th>
<th>具体场景</th>
<th>实现方式</th>
<th>应用案例</th>
<th>配置建议</th>
</tr>
</thead>
<tbody><tr>
<td>补偿机制</td>
<td>状态机补偿</td>
<td>定时任务</td>
<td>订单状态异常修复</td>
<td>执行间隔: 5min<br>重试次数: 3</td>
</tr>
<tr>
<td></td>
<td>数据补偿</td>
<td>人工触发</td>
<td>库存数据不一致修复</td>
<td>补偿任务可回滚<br>补偿日志记录</td>
</tr>
<tr>
<td></td>
<td>业务补偿</td>
<td>消息队列</td>
<td>支付结果异步通知</td>
<td>重试策略配置<br>补偿通知方式</td>
</tr>
<tr>
<td></td>
<td>降级补偿</td>
<td>降级恢复</td>
<td>服务恢复后数据同步</td>
<td>补偿优先级<br>补偿超时时间</td>
</tr>
</tbody></table>
<h4 id="组合策略"><a href="#组合策略" class="headerlink" title="组合策略"></a>组合策略</h4><p>组合策略应用场景</p>
<table>
<thead>
<tr>
<th>业务场景</th>
<th>组合策略</th>
<th>实现方式</th>
<th>配置建议</th>
</tr>
</thead>
<tbody><tr>
<td>秒杀系统</td>
<td>限流 + 熔断 + 降级</td>
<td>1. 入口限流<br>2. 服务熔断<br>3. 降级返回</td>
<td>- 限流: 5000 QPS<br>- 熔断: 50% 错误率<br>- 降级: 返回售罄</td>
</tr>
<tr>
<td>订单系统</td>
<td>限流 + 补偿 + 熔断</td>
<td>1. 用户限流<br>2. 状态补偿<br>3. DB熔断</td>
<td>- 用户限流: 5次&#x2F;分钟<br>- 补偿间隔: 1分钟<br>- DB超时: 1秒</td>
</tr>
<tr>
<td>支付系统</td>
<td>熔断 + 降级 + 补偿</td>
<td>1. 支付熔断<br>2. 降级支付<br>3. 异步补偿</td>
<td>- 熔断阈值: 30%<br>- 降级通道: 备用<br>- 补偿周期: 实时</td>
</tr>
<tr>
<td>库存系统</td>
<td>限流 + 熔断 + 补偿</td>
<td>1. 接口限流<br>2. 缓存熔断<br>3. 数据补偿</td>
<td>- QPS限制: 1000<br>- 熔断恢复: 5s<br>- 补偿策略: 定时</td>
</tr>
</tbody></table>
<h4 id="其它业务策略："><a href="#其它业务策略：" class="headerlink" title="其它业务策略："></a>其它业务策略：</h4><ol>
<li>商品暂停销售</li>
<li>营销券暂停发送等</li>
</ol>
<h3 id="业务和容量规划"><a href="#业务和容量规划" class="headerlink" title="业务和容量规划"></a>业务和容量规划</h3><h4 id="业务策略"><a href="#业务策略" class="headerlink" title="业务策略"></a>业务策略</h4><p>不同于高可用系统建设体系，大促稳定性保障体系与面向特定业务活动的针对性保障建设，因此，业务策略与数据是我们进行保障前不可或缺的数据。<br>一般大促业务数据可分为两类，全局业务形态评估以及应急策略&amp;玩法。</p>
<h4 id="流量模型评估"><a href="#流量模型评估" class="headerlink" title="流量模型评估"></a>流量模型评估</h4><ol>
<li>入口流量<br>对于一次大促，系统峰值入口流量一般由常规业务流量与非常规增量（比如容灾预案&amp;业务营销策略变化带来的流量模型配比变化）叠加拟合而成。</li>
</ol>
<ul>
<li>常规业务流量一般有两类计算方式：<ul>
<li>历史流量算法：该类算法假设当年大促增幅完全符合历史流量模型，根据当前&amp;历年日常流量，计算整体业务体量同比增量模型；然后根据历年大促-日常对比，计算预估流量环比增量模型；最后二者拟合得到最终评估数据。</li>
<li>由于计算时无需依赖任何业务信息输入，该类算法可用于保障工作初期业务尚未给出业务总量评估时使用，得到初估业务流量。</li>
<li>业务量-流量转化算法(GMV\DAU\订单量)：该类算法一般以业务预估总量（GMV\DAU\订单量）为输入，根据历史大促&amp;日常业务量-流量转化模型（比如经典漏洞模型）换算得到对应子域业务体量评估。- 该种方式强依赖业务总量预估，可在保障工作中后期使用，在初估业务流量基础上纳入业务评估因素考虑。</li>
</ul>
</li>
<li>非常规增量一般指前台业务营销策略变更或系统应急预案执行后流量模型变化造成的增量流量。例如，NA61机房故障时，流量100%切换到NA62后，带来的增量变化.考虑到成本最小化，非常规增量P计算时一般无需与常规业务流量W一起，全量纳入叠加入口流量K，一般会将非常规策略发生概率λ作为权重</li>
</ul>
<ol start="2">
<li>节点流量<br>节点流量由入口流量根据流量分支模型，按比例转化而来。分支流量模型以系统链路为计算基础，遵循以下原则：</li>
</ol>
<ul>
<li>同一入口，不同链路占比流量独立计算。</li>
<li>针对同一链路上同一节点，若存在多次调用，需计算按倍数同比放大（比如DB\Tair等）。</li>
<li>DB写流量重点关注，可能出现热点造成DB HANG死。</li>
</ul>
<h4 id="容量转化"><a href="#容量转化" class="headerlink" title="容量转化"></a>容量转化</h4><p>节点容量是指一个节点在运行过程中，能够<strong>同时处理的最大请求数</strong>。它反映了系统的瞬时负载能力。</p>
<p>1）Little Law衍生法则<br>不同类型资源节点(应用容器、Tair、DB、HBASE等)流量-容量转化比各不相同，但都服从Little Law衍生法则，即：<br>  节点容量&#x3D;节点吞吐率×平均响应时间<br>2）N + X 冗余原则</p>
<p>在满足目标流量所需要的最小容量基础上，冗余保留X单位冗余能力<br>X与目标成本与资源节点故障概率成正相关，不可用概率越高，X越高<br>对于一般应用容器集群，可考虑X &#x3D; 0.2N</p>
<h4 id="全链路压测"><a href="#全链路压测" class="headerlink" title="全链路压测"></a>全链路压测</h4><h4 id="成本优化"><a href="#成本优化" class="headerlink" title="成本优化"></a>成本优化</h4><h3 id="研发流程规范"><a href="#研发流程规范" class="headerlink" title="研发流程规范"></a>研发流程规范</h3><ul>
<li>研发</li>
<li>测试</li>
<li>发布</li>
</ul>
<h3 id="高可用的架构设计"><a href="#高可用的架构设计" class="headerlink" title="高可用的架构设计"></a>高可用的架构设计</h3><h4 id="整体架构"><a href="#整体架构" class="headerlink" title="整体架构"></a>整体架构</h4><table>
<thead>
<tr>
<th>架构层面</th>
<th>设计类型</th>
<th>具体措施</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>整体架构和部署</td>
<td>冗余设计</td>
<td>多机房部署</td>
<td>在不同地理位置部署多个机房,避免单点故障</td>
</tr>
<tr>
<td></td>
<td></td>
<td>服务多副本</td>
<td>每个服务部署多个实例,提供故障转移能力</td>
</tr>
<tr>
<td></td>
<td></td>
<td>数据多副本</td>
<td>数据多副本存储,保证数据可靠性</td>
</tr>
<tr>
<td></td>
<td></td>
<td>无状态服务设计</td>
<td>服务无状态化,便于水平扩展</td>
</tr>
<tr>
<td></td>
<td>容灾设计</td>
<td>同城双活</td>
<td>同一城市两个机房同时对外服务</td>
</tr>
<tr>
<td></td>
<td></td>
<td>异地多活</td>
<td>多地机房同时对外服务,就近访问</td>
</tr>
<tr>
<td></td>
<td></td>
<td>机房级容灾</td>
<td>单机房故障时可切换到其他机房</td>
</tr>
<tr>
<td></td>
<td></td>
<td>数据中心容灾</td>
<td>数据中心级别的容灾能力</td>
</tr>
<tr>
<td></td>
<td>灾备演练</td>
<td>演练计划</td>
<td>定期制定灾备演练计划</td>
</tr>
<tr>
<td></td>
<td></td>
<td>演练流程</td>
<td>标准化的演练流程和checklist</td>
</tr>
<tr>
<td></td>
<td></td>
<td>效果评估</td>
<td>对演练结果进行评估和复盘</td>
</tr>
<tr>
<td></td>
<td></td>
<td>持续改进</td>
<td>根据演练反馈持续优化容灾方案</td>
</tr>
<tr>
<td>安全架构</td>
<td>网络安全</td>
<td>防火墙&#x2F;WAF</td>
<td>防御网络攻击,过滤恶意流量</td>
</tr>
<tr>
<td></td>
<td></td>
<td>VPN&#x2F;专线</td>
<td>安全的网络连接方式</td>
</tr>
<tr>
<td></td>
<td>数据安全</td>
<td>加密存储</td>
<td>敏感数据加密存储</td>
</tr>
<tr>
<td></td>
<td></td>
<td>访问控制</td>
<td>严格的数据访问权限控制</td>
</tr>
<tr>
<td></td>
<td>应用安全</td>
<td>身份认证</td>
<td>多因素认证,防止账号盗用</td>
</tr>
<tr>
<td></td>
<td></td>
<td>操作审计</td>
<td>记录关键操作审计日志</td>
</tr>
</tbody></table>
<h4 id="应用层架构"><a href="#应用层架构" class="headerlink" title="应用层架构"></a>应用层架构</h4><table>
<thead>
<tr>
<th>设计类型</th>
<th>具体措施</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>隔离设计</td>
<td>服务隔离</td>
<td>核心服务独立部署,避免互相影响</td>
</tr>
<tr>
<td></td>
<td>数据隔离</td>
<td>按业务领域划分数据存储</td>
</tr>
<tr>
<td></td>
<td>故障隔离</td>
<td>故障隔离机制,防止故障扩散</td>
</tr>
<tr>
<td></td>
<td>资源隔离</td>
<td>CPU&#x2F;内存等资源隔离管理</td>
</tr>
<tr>
<td>水平扩展设计</td>
<td>服务无状态化</td>
<td>服务设计无状态,便于扩容</td>
</tr>
<tr>
<td></td>
<td>数据分片策略</td>
<td>数据分片存储,支持横向扩展</td>
</tr>
<tr>
<td></td>
<td>弹性伸缩</td>
<td>根据负载自动扩缩容</td>
</tr>
<tr>
<td></td>
<td>负载均衡</td>
<td>多实例间的负载分配策略</td>
</tr>
</tbody></table>
<h4 id="系统链路梳理和维护-System-Biz-Profiling"><a href="#系统链路梳理和维护-System-Biz-Profiling" class="headerlink" title="系统链路梳理和维护 System &amp; Biz Profiling"></a>系统链路梳理和维护 System &amp; Biz Profiling</h4><p>系统链路梳理是所有保障工作的基础，它就像对整个应用系统进行一次全面体检。从流量入口开始，按照链路轨迹，逐级分层节点，最终得到系统全局画像与核心保障点。主要包含以下几个方面:</p>
<ol>
<li>入口梳理盘点<br>系统通常有多个流量入口，包括HTTP、RPC、消息等多种来源。建议优先从以下三类重点入口开始梳理:</li>
</ol>
<ul>
<li>核心重保流量入口<ul>
<li>有明确的服务SLI承诺,对数据准确性、响应时间、可靠度有严格要求</li>
<li>业务核心链路(浏览、下单、支付、履约等)</li>
<li>面向企业级用户的服务</li>
</ul>
</li>
<li>资损风险入口<ul>
<li>涉及公司或客户资金收入的收费服务</li>
<li>可能造成资金损失的关键节点</li>
</ul>
</li>
<li>大流量入口<ul>
<li>系统TPS&#x2F;QPS排名前5-10的入口</li>
<li>虽无高SLI要求但流量大,对系统整体负载影响显著</li>
</ul>
</li>
</ul>
<ol start="2">
<li>节点分层分析<br>按照流量轨迹,对链路上的各类节点(HSF、DB、Tair、HBase等外部依赖)进行分层分析:</li>
</ol>
<ul>
<li><p>强弱依赖判定</p>
<ul>
<li>业务强依赖:节点不可用会导致业务中断或严重受损</li>
<li>系统强依赖:节点不可用会导致系统执行中断</li>
<li>性能强依赖:节点不可用会严重影响系统性能</li>
<li>弱依赖:有降级方案或影响较小</li>
</ul>
</li>
<li><p>可用性风险判定</p>
<ul>
<li>日常超时频发的节点</li>
<li>系统资源紧张的节点</li>
<li>历史故障频发的节点</li>
</ul>
</li>
<li><p>高风险节点识别  </p>
<ul>
<li>近期改造过的节点</li>
<li>首次参与大促的新节点</li>
<li>曾出现过高级别故障的节点</li>
<li>可能造成资损的关键节点</li>
</ul>
</li>
</ul>
<ol start="3">
<li>调用关系分析</li>
</ol>
<ul>
<li>绘制核心接口调用拓扑图或时序图</li>
<li>计算各节点间调用比例</li>
<li>分析调用链路上的资损风险点</li>
<li>识别内外部系统依赖关系</li>
</ul>
<ol start="4">
<li><p>系统调用拓扑图(可借助分布式链路追踪系统)，包含QPS、强弱依赖、高风险节点标注</p>
<p align="center">
  <img src="/images/11-system-biz-profile.png" width=800 height=600>
</p>
</li>
<li><p>接口时序图(以创建订单为例)</p>
<p align="center">
  <img src="/images/12-create-order-sequence.png" width=800 height=800>
</p></li>
</ol>
<h4 id="资损防控架构"><a href="#资损防控架构" class="headerlink" title="资损防控架构"></a>资损防控架构</h4><h5 id="定期review资损风险"><a href="#定期review资损风险" class="headerlink" title="定期review资损风险"></a>定期review资损风险</h5><h5 id="事中及时发现"><a href="#事中及时发现" class="headerlink" title="事中及时发现"></a>事中及时发现</h5><p align="center">
  <img src="/images/realtime-verify.webp" width=800 height=600>
  <br/>
  <strong><a href="https://segmentfault.com/a/1190000040286146">【得物技术】浅谈资损防控</a></strong>
  <br/>
</p>

<h5 id="事后复盘和知识沉淀"><a href="#事后复盘和知识沉淀" class="headerlink" title="事后复盘和知识沉淀"></a>事后复盘和知识沉淀</h5><h3 id="性能优化"><a href="#性能优化" class="headerlink" title="性能优化"></a>性能优化</h3><p align="center">
  <img src="/images/performance.png" width=800 height=1000>
  <br/>
</p>

<ol>
<li><p>应用层优化</p>
<ul>
<li>代码优化</li>
<li>JVM调优</li>
<li>线程池优化</li>
<li>连接池优化</li>
</ul>
</li>
<li><p>数据层优化</p>
<ul>
<li>SQL优化</li>
<li>索引优化</li>
<li>分库分表</li>
<li>读写分离</li>
</ul>
</li>
<li><p>缓存优化</p>
<ul>
<li>多级缓存</li>
<li>热点缓存</li>
<li>缓存预热</li>
<li>缓存穿透&#x2F;击穿防护</li>
</ul>
</li>
</ol>
<h2 id="其它常见问题"><a href="#其它常见问题" class="headerlink" title="其它常见问题"></a>其它常见问题</h2><h3 id="基础概念与架构设计"><a href="#基础概念与架构设计" class="headerlink" title="基础概念与架构设计"></a>基础概念与架构设计</h3><ul>
<li>电商后台系统的核心架构设计原则有哪些？</li>
<li>电商后台系统与前端系统的交互方式有哪些？各自的特点是什么？</li>
<li>如何设计电商后台系统的用户权限管理模块？</li>
<li>电商后台系统中，微服务架构和单体架构的适用场景分别是什么？</li>
<li>简述电商后台系统的分层架构设计，各层的主要职责是什么？</li>
<li>如何实现电商后台系统的接口幂等性？</li>
<li>电商后台系统中，分布式 Session 管理有哪些常见方案？</li>
<li>设计电商后台系统时，如何考虑系统的可扩展性和可维护性？</li>
<li>电商后台系统的 API 设计规范应包含哪些内容？</li>
<li>如何设计电商后台系统的异常处理机制？</li>
</ul>
<h3 id="商品管理"><a href="#商品管理" class="headerlink" title="商品管理"></a>商品管理</h3><ul>
<li><p>什么是SPU和SKU？它们之间的关系是什么？</p>
</li>
<li><p>电商系统中的商品分类体系是如何设计的？ category 父子类目</p>
</li>
<li><p>什么是商品属性？如何区分规格属性（Sales Attributes））和非规格属性？属性，会影响商品SKU的属性直接关系到库存和价格，用户购买时需要选择的属性，例如：颜色、尺码、内存容量等。非规格属性（Basic Attributes）：用于描述商品特征，产地、材质、生产日期</p>
</li>
<li><p>商品的生命周期包含哪些状态？</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">创建阶段</span><br><span class="line">DRAFT(0): 草稿状态</span><br><span class="line">PENDING_AUDIT(1): 待审核</span><br><span class="line">AUDIT_REJECTED(2): 审核拒绝</span><br><span class="line">AUDIT_APPROVED(3): 审核通过</span><br><span class="line">销售阶段</span><br><span class="line">ON_SHELF(10): 在售/上架</span><br><span class="line">OFF_SHELF(11): 下架</span><br><span class="line">SOLD_OUT(12): 售罄</span><br><span class="line">特殊状态</span><br><span class="line">FROZEN(20): 冻结（违规/投诉）</span><br><span class="line">DELETED(99): 删除</span><br></pre></td></tr></table></figure>
<p>什么是商品快照？为什么需要商品快照？</p>
</li>
<li><p>商品的 SKU 和 SPU 概念在后台系统中如何体现？两者的关系是怎样的？</p>
</li>
<li><p>电商后台系统中商品的基础信息包括哪些？如何设计商品表的数据库模型？</p>
</li>
<li><p>商品的库存管理和价格管理在后台系统中是如何关联的？</p>
</li>
<li><p>如何处理商品的多规格（如颜色、尺寸、型号等）信息？数据库表结构如何设计？</p>
</li>
<li><p>商品详情页的信息（如描述、图片、参数）在后台系统中如何存储和管理？</p>
</li>
<li><p>商品上下架的逻辑在后台系统中是如何实现的？需要考虑哪些因素（如库存、审核状态等）？</p>
</li>
<li><p>商品的搜索和筛选功能在后台系统中是如何实现的？涉及哪些技术（如全文搜索、数据库索引等）？</p>
</li>
<li><p>新品发布和商品淘汰在后台系统中的处理流程是怎样的？</p>
</li>
<li><p>如何保证商品信息的唯一性和完整性，避免重复录入和数据错误？</p>
</li>
</ul>
<ol>
<li>唯一性保证：<br>使用唯一索引<br>引入商品编码系统<br>查重机制</li>
<li>完整性保证：<br>必填字段验证<br>数据格式校验<br>关联完整性检查<br>业务规则校验</li>
</ol>
<h3 id="订单管理"><a href="#订单管理" class="headerlink" title="订单管理"></a>订单管理</h3><ul>
<li>电商后台系统中订单的主要状态有哪些？状态流转的触发条件和处理逻辑是怎样的？</li>
<li>订单的创建流程在后台系统中是如何处理的？涉及哪些模块（如库存、价格、用户信息等）的交互？</li>
<li>如何实现订单的分单处理（如不同仓库发货、不同店铺订单拆分）？</li>
<li>订单的支付状态如何与支付系统进行同步？后台系统需要处理哪些异常情况？</li>
<li>订单的取消、修改（如收货地址、商品数量）在后台系统中有哪些限制和处理逻辑？</li>
<li>如何计算订单的总价（包括商品价格、运费、优惠活动等）？优惠分摊的逻辑是怎样的？</li>
<li>订单的物流信息在后台系统中如何获取和更新？与物流服务商的接口如何对接？</li>
<li>历史订单的存储和查询在后台系统中如何优化？涉及大量数据时如何提高查询效率？</li>
<li>如何设计订单的反欺诈机制，识别和防范恶意订单？</li>
<li>订单的售后服务（如退货、换货、退款）在后台系统中的处理流程是怎样的？与库存、财务等模块如何交互？</li>
</ul>
<h3 id="用户与账户管理"><a href="#用户与账户管理" class="headerlink" title="用户与账户管理"></a>用户与账户管理</h3><ul>
<li>电商后台系统中用户信息通常包含哪些字段？如何设计用户表的数据库结构？</li>
<li>如何实现用户的注册、登录（包括第三方登录）功能在后台系统中的处理逻辑？</li>
<li>怎样处理用户密码的加密存储和找回功能？</li>
<li>电商后台如何管理用户的收货地址？地址数据的增删改查逻辑是怎样的？</li>
<li>用户账户余额和积分的管理在后台系统中有哪些注意事项？如何保证数据的一致性？</li>
<li>如何实现用户权限的分级管理（如普通用户、VIP 用户、管理员等）？</li>
<li>当用户账户出现异常登录时，后台系统应如何处理和记录？</li>
<li>电商后台如何统计用户的活跃度、留存率等指标？数据来源和计算逻辑是怎样的？</li>
<li>用户信息修改（如手机号、邮箱）时，后台系统需要进行哪些验证和处理？</li>
<li>如何设计用户操作日志的记录和查询功能，以满足审计和问题排查需求？</li>
</ul>
<h3 id="库存管理"><a href="#库存管理" class="headerlink" title="库存管理"></a>库存管理</h3><ul>
<li>电商后台系统中库存管理的主要目标是什么？常见的库存管理策略有哪些？</li>
<li>如何实现库存的实时更新？在高并发场景下如何保证库存数据的一致性？</li>
<li>库存预警机制如何设计？预警的条件（如安全库存、滞销库存等）和通知方式是怎样的？</li>
<li>多仓库库存管理在后台系统中如何实现？库存的分配和调拨逻辑是怎样的？</li>
<li>库存盘点功能在后台系统中的实现步骤是怎样的？如何处理盘点差异？</li>
<li>预售商品的库存管理与普通商品有何不同？后台系统需要特殊处理哪些方面？</li>
<li>如何防止超卖现象的发生？在库存不足时，订单的处理逻辑是怎样的？</li>
<li>库存数据与订单、采购、物流等模块的交互接口是如何设计的？</li>
<li>对于虚拟商品（如电子卡券），库存管理的方式与实物商品有何区别？</li>
<li>如何统计库存的周转率、缺货率等指标？数据来源和计算方法是怎样的？</li>
</ul>
<h3 id="支付与结算"><a href="#支付与结算" class="headerlink" title="支付与结算"></a>支付与结算</h3><ul>
<li>电商后台系统支持哪些支付方式？每种支付方式的对接流程和注意事项是什么？</li>
<li>支付系统与电商后台系统的交互接口应包含哪些关键信息？如何保证支付数据的安全性？</li>
<li>支付过程中的异步通知机制是如何实现的？后台系统如何处理重复通知和通知失败的情况？</li>
<li>如何实现支付订单与业务订单的关联和对账功能？</li>
<li>结算周期和结算规则在后台系统中如何配置和管理？（如供应商结算、平台佣金结算等）</li>
<li>支付过程中的手续费计算和分摊逻辑是怎样的？如何在后台系统中实现？</li>
<li>对于跨境支付，后台系统需要处理哪些特殊问题（如汇率转换、支付合规性等）？</li>
<li>如何设计支付系统的异常处理和回滚机制？</li>
<li>支付成功后，后台系统如何触发后续的业务流程（如订单发货、积分发放等）？</li>
<li>财务对账在后台系统中的实现方式有哪些？如何保证财务数据与业务数据的一致性？</li>
</ul>
<h3 id="物流与供应链"><a href="#物流与供应链" class="headerlink" title="物流与供应链"></a>物流与供应链</h3><ul>
<li>电商后台系统如何与物流服务商（如快递、仓储）进行接口对接？需要获取哪些物流信息？</li>
<li>物流单号的生成和管理在后台系统中是如何实现的？如何避免重复和错误？</li>
<li>发货流程在后台系统中的处理逻辑是怎样的？涉及哪些部门或系统的协作（如仓库、库存、订单等）？</li>
<li>如何实现物流信息的实时追踪和更新？在后台系统中如何展示给用户和客服？</li>
<li>退换货的物流处理在后台系统中有哪些特殊流程？如何与原订单和库存进行关联？</li>
<li>供应链管理在电商后台系统中包括哪些主要功能？如何实现供应商管理、采购管理和库存管理的协同？</li>
<li>如何根据商品的特性和用户地址选择合适的物流方案（如快递类型、运费模板等）？</li>
<li>物流异常（如包裹丢失、破损）在后台系统中的处理流程是怎样的？如何与用户和物流服务商沟通协调？</li>
<li>如何统计物流成本和物流效率（如发货时效、配送成功率等）？数据来源和分析方法是怎样的？</li>
<li>对于海外仓和跨境物流，后台系统需要处理哪些额外的业务逻辑（如清关、关税计算等）？</li>
</ul>
<h3 id="营销与促销"><a href="#营销与促销" class="headerlink" title="营销与促销"></a>营销与促销</h3><ul>
<li>电商后台系统中常见的促销策略有哪些（如满减、打折、优惠券、秒杀、拼团等）？如何设计支持多种促销策略的模块？</li>
<li>优惠券的生成、发放、使用和核销在后台系统中的处理流程是怎样的？</li>
<li>促销活动的时间管理和范围管理（如针对特定用户群体、特定商品、特定时间段）如何实现？</li>
<li>如何避免促销活动中的超卖和优惠叠加错误？后台系统的校验逻辑是怎样的？</li>
<li>秒杀活动在后台系统中如何应对高并发场景？需要进行哪些技术优化？</li>
<li>营销活动的效果评估指标（如转化率、客单价提升、销售额增长等）在后台系统中如何统计和分析？</li>
<li>如何设计推荐系统与后台营销模块的集成，实现个性化的促销推荐？</li>
<li>会员体系（如 VIP 等级、积分兑换）在后台系统中如何与营销活动结合？</li>
<li>促销活动的库存预留和释放逻辑是怎样的？如何与库存管理模块进行交互？</li>
<li>营销费用的预算管理和成本核算在后台系统中如何实现？</li>
</ul>
<h3 id="数据统计与分析"><a href="#数据统计与分析" class="headerlink" title="数据统计与分析"></a>数据统计与分析</h3><ul>
<li>电商后台系统需要统计哪些核心业务指标（如 GMV、UV、PV、转化率、复购率等）？数据采集的方式和频率是怎样的？</li>
<li>如何设计数据报表功能，支持不同角色（如运营、管理层、客服）的个性化报表需求？</li>
<li>数据统计中的维度和指标如何定义和管理？如何实现多维度的交叉分析？</li>
<li>实时数据统计和离线数据统计在后台系统中的实现方式有何不同？各自的适用场景是什么？</li>
<li>如何保证数据统计的准确性和完整性？数据清洗和校验的流程是怎样的？</li>
<li>数据分析结果如何反馈到业务模块（如库存调整、促销策略优化等）？</li>
<li>数据可视化在后台系统中的实现方式有哪些（如图表、仪表盘、数据大屏等）？</li>
<li>对于海量数据的统计分析，后台系统需要进行哪些性能优化（如分布式计算、缓存、索引等）？</li>
<li>如何设计数据权限管理，确保不同用户只能查看和操作其权限范围内的数据？</li>
<li>数据统计分析模块与其他业务模块（如订单、商品、用户等）的数据接口是如何设计的？</li>
</ul>
<h3 id="其他综合问题"><a href="#其他综合问题" class="headerlink" title="其他综合问题"></a>其他综合问题</h3><ul>
<li>电商后台系统在应对大促（如双 11、618）时，需要进行哪些准备工作和技术优化？</li>
<li>如何保障电商后台系统的高可用性和容灾能力？常见的解决方案有哪些？</li>
<li>后台系统的代码维护和版本管理有哪些最佳实践？如何保证多人协作开发的效率和代码质量？</li>
<li>当电商业务拓展到新的领域或增加新的业务模块时，后台系统如何进行适应性改造？</li>
<li>如何处理不同国家和地区的电商业务在后台系统中的差异化需求（如语言、货币、法规等）？</li>
<li>电商后台系统中的日志管理有哪些重要性？如何设计日志的记录、存储和查询功能？</li>
<li>对于第三方服务（如短信验证码、邮件通知、数据分析工具等）的接入，后台系统需要注意哪些问题？</li>
<li>如何评估电商后台系统的性能瓶颈？常见的性能测试工具和方法有哪些？</li>
<li>简述你在以往项目中参与过的电商后台系统开发经验，遇到过哪些挑战，是如何解决的？</li>
<li>对于电商后台系统的未来发展趋势（如智能化、自动化、区块链应用等），你有哪些了解和思考？</li>
</ul>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考:"></a>参考:</h2><ul>
<li><a href="https://www.cnblogs.com/wanglifeng717/p/16214122.html">订单状态机的设计和实现</a></li>
<li><a href="https://axureboutique.com/blogs/product-design/understanding-the-structure-of-e-commerce-products?srsltid=AfmBOorcMDfLRBbuCUYyKtkpkf5Vf8yQUjJSRKR0FzQSI2lvcvMmIK--">Understanding the Structure of E-Commerce Products</a></li>
<li><a href="https://axureboutique.com/blogs/product-design/build-an-e-commerce-product-center-from-scratch">Build an E-Commerce Product Center from Scratch</a></li>
<li><a href="https://sre.google/books/">SRE三部曲</a></li>
<li><a href="https://tech.dewu.com/article?id=73">得物技术 - 浅谈资损防控</a></li>
<li><a href="https://segmentfault.com/a/1190000040286146">浅谈资损防控</a></li>
<li><a href="https://mp.weixin.qq.com/s/w2tOXR6rcTmUHGsJKJilzg">稳定性保障6步走：高可用系统大促作战指南</a></li>
</ul>

    </div>

    
    
    

    <footer class="post-footer">

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2025/04/01/system-design/12-tech-design/" rel="prev" title="互联网系统设计 - 概述和技术方案写作">
                  <i class="fa fa-angle-left"></i> 互联网系统设计 - 概述和技术方案写作
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2025/05/15/system-design/14-system-reliability/" rel="next" title="互联网业务系统 - 稳定性建设">
                  互联网业务系统 - 稳定性建设 <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">wxquare</span>
  </div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/sidebar.js"></script><script src="/js/next-boot.js"></script>

  






  





</body>
</html>
