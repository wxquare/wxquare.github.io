<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.2.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha256-XOqroi11tY4EFQMR9ZYwZWKj5ZXiftSx36RRuC3anlA=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"yoursite.com","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.20.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"always","padding":18,"offset":12},"copycode":{"enable":true,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="一、高并发与流量治理1. 秒杀系统设计核心挑战：瞬时流量巨大、库存超卖、恶意脚本。 架构分层：    层级 策略    客户端&#x2F;CDN 静态资源缓存；按钮置灰+答题验证（削峰防刷）   网关层 令牌桶&#x2F;漏桶限流；黑名单拦截；设备指纹识别   服务层 库存预热到 Redis；MQ 异步扣减 DB 库存；非核心服务降级   防超卖（核心）：  Redis Lua 脚本原子扣减：">
<meta property="og:type" content="article">
<meta property="og:title" content="高频系统设计面试题速查手册">
<meta property="og:url" content="http://yoursite.com/2025/06/25/system-design/17-high-frequency-system-design/index.html">
<meta property="og:site_name" content="wxquare&#39;s Blogs">
<meta property="og:description" content="一、高并发与流量治理1. 秒杀系统设计核心挑战：瞬时流量巨大、库存超卖、恶意脚本。 架构分层：    层级 策略    客户端&#x2F;CDN 静态资源缓存；按钮置灰+答题验证（削峰防刷）   网关层 令牌桶&#x2F;漏桶限流；黑名单拦截；设备指纹识别   服务层 库存预热到 Redis；MQ 异步扣减 DB 库存；非核心服务降级   防超卖（核心）：  Redis Lua 脚本原子扣减：">
<meta property="og:locale">
<meta property="article:published_time" content="2025-06-24T16:00:00.000Z">
<meta property="article:modified_time" content="2026-02-12T15:26:20.935Z">
<meta property="article:author" content="wxquare">
<meta property="article:tag" content="面试">
<meta property="article:tag" content="系统设计">
<meta property="article:tag" content="架构">
<meta property="article:tag" content="高并发">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://yoursite.com/2025/06/25/system-design/17-high-frequency-system-design/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-Hans","comments":true,"permalink":"http://yoursite.com/2025/06/25/system-design/17-high-frequency-system-design/","path":"2025/06/25/system-design/17-high-frequency-system-design/","title":"高频系统设计面试题速查手册"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>高频系统设计面试题速查手册 | wxquare's Blogs</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">wxquare's Blogs</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li><li class="menu-item menu-item-friends"><a href="/friends" rel="section"><i class="fa fa-user fa-fw"></i>Friends</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%80%E3%80%81%E9%AB%98%E5%B9%B6%E5%8F%91%E4%B8%8E%E6%B5%81%E9%87%8F%E6%B2%BB%E7%90%86"><span class="nav-number">1.</span> <span class="nav-text">一、高并发与流量治理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E7%A7%92%E6%9D%80%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1"><span class="nav-number">1.1.</span> <span class="nav-text">1. 秒杀系统设计</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E5%88%86%E5%B8%83%E5%BC%8F%E9%99%90%E6%B5%81"><span class="nav-number">1.2.</span> <span class="nav-text">2. 分布式限流</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E7%83%AD%E7%82%B9%E5%8F%91%E7%8E%B0%E4%B8%8E%E9%9A%94%E7%A6%BB"><span class="nav-number">1.3.</span> <span class="nav-text">3. 热点发现与隔离</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-%E7%86%94%E6%96%AD%E3%80%81%E9%99%8D%E7%BA%A7%E3%80%81%E9%99%90%E6%B5%81%E7%9A%84%E5%8C%BA%E5%88%AB"><span class="nav-number">1.4.</span> <span class="nav-text">4. 熔断、降级、限流的区别</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-AI-Agent-%E9%AB%98%E5%B9%B6%E5%8F%91%E6%9E%B6%E6%9E%84"><span class="nav-number">1.5.</span> <span class="nav-text">5. AI Agent 高并发架构</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%8C%E3%80%81%E6%B5%B7%E9%87%8F%E6%95%B0%E6%8D%AE%E4%B8%8E%E5%AD%98%E5%82%A8"><span class="nav-number">2.</span> <span class="nav-text">二、海量数据与存储</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-40%E4%BA%BF%E6%95%B0%E6%8D%AE%E5%8E%BB%E9%87%8D%EF%BC%881GB-%E5%86%85%E5%AD%98%E9%99%90%E5%88%B6%EF%BC%89"><span class="nav-number">2.1.</span> <span class="nav-text">1. 40亿数据去重（1GB 内存限制）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1%E4%BA%BF%E7%8E%A9%E5%AE%B6%E5%AE%9E%E6%97%B6%E6%8E%92%E8%A1%8C%E6%A6%9C"><span class="nav-number">2.2.</span> <span class="nav-text">2. 1亿玩家实时排行榜</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E6%B5%B7%E9%87%8F%E6%95%B0%E6%8D%AE%E6%8E%92%E5%BA%8F%EF%BC%88100GB-%E6%95%B0%E6%8D%AE%EF%BC%8C8GB-%E5%86%85%E5%AD%98%EF%BC%89"><span class="nav-number">2.3.</span> <span class="nav-text">3. 海量数据排序（100GB 数据，8GB 内存）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-10%E4%BA%BF%E7%94%A8%E6%88%B7%E5%9C%A8%E7%BA%BF%E7%8A%B6%E6%80%81"><span class="nav-number">2.4.</span> <span class="nav-text">4. 10亿用户在线状态</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%89%E3%80%81%E5%85%B8%E5%9E%8B%E4%B8%9A%E5%8A%A1%E5%9C%BA%E6%99%AF%E8%AE%BE%E8%AE%A1"><span class="nav-number">3.</span> <span class="nav-text">三、典型业务场景设计</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E8%AE%A2%E5%8D%95%E8%B6%85%E6%97%B6%E8%87%AA%E5%8A%A8%E5%8F%96%E6%B6%88"><span class="nav-number">3.1.</span> <span class="nav-text">1. 订单超时自动取消</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E5%88%86%E5%B8%83%E5%BC%8F-ID-%E7%94%9F%E6%88%90%E5%99%A8"><span class="nav-number">3.2.</span> <span class="nav-text">2. 分布式 ID 生成器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E7%9F%AD%E9%93%BE%E6%8E%A5%E7%B3%BB%E7%BB%9F"><span class="nav-number">3.3.</span> <span class="nav-text">3. 短链接系统</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-Feed-%E6%B5%81%E7%B3%BB%E7%BB%9F"><span class="nav-number">3.4.</span> <span class="nav-text">4. Feed 流系统</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-%E8%AF%84%E8%AE%BA%E7%B3%BB%E7%BB%9F%EF%BC%88B%E7%AB%99-%E6%8A%96%E9%9F%B3%E7%9B%96%E6%A5%BC%EF%BC%89"><span class="nav-number">3.5.</span> <span class="nav-text">5. 评论系统（B站&#x2F;抖音盖楼）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-%E7%BA%A2%E5%8C%85%E7%AE%97%E6%B3%95"><span class="nav-number">3.6.</span> <span class="nav-text">6. 红包算法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-%E6%94%AF%E4%BB%98%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1"><span class="nav-number">3.7.</span> <span class="nav-text">7. 支付系统设计</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-%E5%BA%93%E5%AD%98%E7%B3%BB%E7%BB%9F%E6%B7%B1%E5%BA%A6%E8%AE%BE%E8%AE%A1"><span class="nav-number">3.8.</span> <span class="nav-text">8. 库存系统深度设计</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Q1%EF%BC%9A%E5%A6%82%E4%BD%95%E8%AE%BE%E8%AE%A1%E4%B8%80%E4%B8%AA%E7%BB%9F%E4%B8%80%E5%BA%93%E5%AD%98%E7%B3%BB%E7%BB%9F%EF%BC%8C%E6%94%AF%E6%8C%81%E7%94%B5%E5%95%86%E3%80%81%E8%99%9A%E6%8B%9F%E5%95%86%E5%93%81%E3%80%81%E6%9C%AC%E5%9C%B0%E7%94%9F%E6%B4%BB%E7%AD%89%E5%A4%9A%E5%93%81%E7%B1%BB%EF%BC%9F"><span class="nav-number">3.8.1.</span> <span class="nav-text">Q1：如何设计一个统一库存系统，支持电商、虚拟商品、本地生活等多品类？</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Q2%EF%BC%9A%E5%88%B8%E7%A0%81%E5%88%B6%E5%BA%93%E5%AD%98%EF%BC%88%E5%A6%82%E7%94%B5%E5%AD%90%E5%88%B8%EF%BC%89%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E9%AB%98%E5%B9%B6%E5%8F%91%E6%89%A3%E5%87%8F%EF%BC%9F"><span class="nav-number">3.8.2.</span> <span class="nav-text">Q2：券码制库存（如电子券）如何实现高并发扣减？</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Q3%EF%BC%9A%E6%95%B0%E9%87%8F%E5%88%B6%E5%BA%93%E5%AD%98%EF%BC%88%E5%A6%82%E8%99%9A%E6%8B%9F%E6%9C%8D%E5%8A%A1%E5%88%B8%EF%BC%89%E5%A6%82%E4%BD%95%E6%94%AF%E6%8C%81%E8%90%A5%E9%94%80%E6%B4%BB%E5%8A%A8%E5%8A%A8%E6%80%81%E5%BA%93%E5%AD%98%EF%BC%9F"><span class="nav-number">3.8.3.</span> <span class="nav-text">Q3：数量制库存（如虚拟服务券）如何支持营销活动动态库存？</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Q4%EF%BC%9A%E4%BE%9B%E5%BA%94%E5%95%86%E7%AE%A1%E7%90%86%E7%9A%84%E5%BA%93%E5%AD%98%EF%BC%88%E5%A6%82%E9%85%92%E5%BA%97%E3%80%81%E6%9C%BA%E7%A5%A8%EF%BC%89%E5%A6%82%E4%BD%95%E5%90%8C%E6%AD%A5%EF%BC%9F"><span class="nav-number">3.8.4.</span> <span class="nav-text">Q4：供应商管理的库存（如酒店、机票）如何同步？</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Q5%EF%BC%9A%E5%A6%82%E4%BD%95%E4%BF%9D%E8%AF%81-Redis-%E4%B8%8E-MySQL-%E5%BA%93%E5%AD%98%E6%95%B0%E6%8D%AE%E4%B8%80%E8%87%B4%E6%80%A7%EF%BC%9F"><span class="nav-number">3.8.5.</span> <span class="nav-text">Q5：如何保证 Redis 与 MySQL 库存数据一致性？</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Q6%EF%BC%9ARedis-%E5%AE%95%E6%9C%BA%E4%BA%86%EF%BC%8C%E5%BA%93%E5%AD%98%E7%B3%BB%E7%BB%9F%E5%A6%82%E4%BD%95%E9%99%8D%E7%BA%A7%EF%BC%9F"><span class="nav-number">3.8.6.</span> <span class="nav-text">Q6：Redis 宕机了，库存系统如何降级？</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Q7%EF%BC%9AGiftcard-%E5%AE%9E%E6%97%B6%E7%94%9F%E6%88%90%E5%8D%A1%E5%AF%86%EF%BC%8C%E4%BE%9B%E5%BA%94%E5%95%86-API-%E8%B6%85%E6%97%B6%E6%80%8E%E4%B9%88%E5%8A%9E%EF%BC%9F"><span class="nav-number">3.8.7.</span> <span class="nav-text">Q7：Giftcard 实时生成卡密，供应商 API 超时怎么办？</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Q8%EF%BC%9A%E6%97%B6%E9%97%B4%E7%BB%B4%E5%BA%A6%E5%BA%93%E5%AD%98%EF%BC%88%E9%85%92%E5%BA%97-%E7%A5%A8%E5%8A%A1%EF%BC%89%E4%B8%8E%E6%99%AE%E9%80%9A%E5%BA%93%E5%AD%98%E6%9C%89%E4%BB%80%E4%B9%88%E4%B8%8D%E5%90%8C%EF%BC%9F"><span class="nav-number">3.8.8.</span> <span class="nav-text">Q8：时间维度库存（酒店&#x2F;票务）与普通库存有什么不同？</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Q9%EF%BC%9A%E5%A6%82%E4%BD%95%E6%94%AF%E6%8C%81%E2%80%9D%E7%A7%92%E6%9D%80%E6%B4%BB%E5%8A%A8%E9%94%81%E5%AE%9A-1000-%E4%BB%B6%E5%BA%93%E5%AD%98%E2%80%9D%EF%BC%9F"><span class="nav-number">3.8.9.</span> <span class="nav-text">Q9：如何支持”秒杀活动锁定 1000 件库存”？</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Q10%EF%BC%9A%E6%96%B0%E6%8E%A5%E5%85%A5%E4%B8%80%E4%B8%AA%E5%93%81%E7%B1%BB%E2%80%9D%E6%BC%94%E5%94%B1%E4%BC%9A%E9%97%A8%E7%A5%A8%E2%80%9D%EF%BC%8C%E5%A6%82%E4%BD%95%E5%BF%AB%E9%80%9F%E6%94%AF%E6%8C%81%EF%BC%9F"><span class="nav-number">3.8.10.</span> <span class="nav-text">Q10：新接入一个品类”演唱会门票”，如何快速支持？</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%9D%A2%E8%AF%95%E8%BF%BD%E9%97%AE%E7%82%B9%EF%BC%88%E9%AB%98%E7%BA%A7%EF%BC%89"><span class="nav-number">3.8.11.</span> <span class="nav-text">面试追问点（高级）</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9B%9B%E3%80%81%E5%88%86%E5%B8%83%E5%BC%8F%E4%B8%80%E8%87%B4%E6%80%A7%E4%B8%8E%E4%BA%8B%E5%8A%A1"><span class="nav-number">4.</span> <span class="nav-text">四、分布式一致性与事务</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1"><span class="nav-number">4.1.</span> <span class="nav-text">1. 分布式事务</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-Redis-%E4%B8%8E-MySQL-%E5%8F%8C%E5%86%99%E4%B8%80%E8%87%B4%E6%80%A7"><span class="nav-number">4.2.</span> <span class="nav-text">2. Redis 与 MySQL 双写一致性</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E6%8E%A5%E5%8F%A3%E5%B9%82%E7%AD%89%E6%80%A7"><span class="nav-number">4.3.</span> <span class="nav-text">3. 接口幂等性</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%94%E3%80%81%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B"><span class="nav-number">5.</span> <span class="nav-text">五、并发编程</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E7%BA%BF%E7%A8%8B%E6%B1%A0%E8%AE%BE%E8%AE%A1"><span class="nav-number">5.1.</span> <span class="nav-text">1. 线程池设计</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E5%BC%82%E6%AD%A5%E5%B9%B6%E8%A1%8C%E4%BC%98%E5%8C%96"><span class="nav-number">5.2.</span> <span class="nav-text">2. 异步并行优化</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%85%AD%E3%80%81%E4%B8%AD%E9%97%B4%E4%BB%B6%E9%80%89%E5%9E%8B%E4%B8%8E%E5%8E%9F%E7%90%86"><span class="nav-number">6.</span> <span class="nav-text">六、中间件选型与原理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E9%80%89%E5%9E%8B"><span class="nav-number">6.1.</span> <span class="nav-text">1. 消息队列选型</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-Redis-%E6%A0%B8%E5%BF%83%E9%97%AE%E9%A2%98"><span class="nav-number">6.2.</span> <span class="nav-text">2. Redis 核心问题</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-MySQL-%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8"><span class="nav-number">6.3.</span> <span class="nav-text">3. MySQL 分库分表</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-Elasticsearch-%E6%9E%B6%E6%9E%84"><span class="nav-number">6.4.</span> <span class="nav-text">4. Elasticsearch 架构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-ClickHouse"><span class="nav-number">6.5.</span> <span class="nav-text">5. ClickHouse</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%83%E3%80%81%E5%AE%89%E5%85%A8"><span class="nav-number">7.</span> <span class="nav-text">七、安全</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E5%AF%86%E7%A0%81%E5%AD%98%E5%82%A8"><span class="nav-number">7.1.</span> <span class="nav-text">1. 密码存储</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E5%B8%B8%E8%A7%81%E6%94%BB%E9%98%B2"><span class="nav-number">7.2.</span> <span class="nav-text">2. 常见攻防</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-HTTPS-%E6%8F%A1%E6%89%8B"><span class="nav-number">7.3.</span> <span class="nav-text">3. HTTPS 握手</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%85%AB%E3%80%81%E5%8F%AF%E8%A7%82%E6%B5%8B%E6%80%A7"><span class="nav-number">8.</span> <span class="nav-text">八、可观测性</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E4%B8%89%E5%A4%A7%E6%94%AF%E6%9F%B1"><span class="nav-number">8.1.</span> <span class="nav-text">1. 三大支柱</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E2%80%9C%E6%8E%A5%E5%8F%A3%E7%AA%81%E7%84%B6%E5%8F%98%E6%85%A2%E2%80%9D%E6%8E%92%E6%9F%A5%E5%A5%97%E8%B7%AF"><span class="nav-number">8.2.</span> <span class="nav-text">2. “接口突然变慢”排查套路</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B9%9D%E3%80%81%E4%BA%91%E5%8E%9F%E7%94%9F%E4%B8%8E%E5%BC%B9%E6%80%A7%E6%9E%B6%E6%9E%84"><span class="nav-number">9.</span> <span class="nav-text">九、云原生与弹性架构</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E6%9C%8D%E5%8A%A1%E7%BD%91%E6%A0%BC-Service-Mesh"><span class="nav-number">9.1.</span> <span class="nav-text">1. 服务网格 (Service Mesh)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E5%BC%B9%E6%80%A7%E4%BC%B8%E7%BC%A9"><span class="nav-number">9.2.</span> <span class="nav-text">2. 弹性伸缩</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-Serverless"><span class="nav-number">9.3.</span> <span class="nav-text">3. Serverless</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8D%81%E3%80%81%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80"><span class="nav-number">10.</span> <span class="nav-text">十、计算机基础</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E4%B8%BA%E4%BB%80%E4%B9%88-0-1-0-2-0-3%EF%BC%9F"><span class="nav-number">10.1.</span> <span class="nav-text">1. 为什么 0.1 + 0.2 !&#x3D; 0.3？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-TCP-%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B%E4%B8%BA%E4%BB%80%E4%B9%88%E4%B8%8D%E8%83%BD%E4%B8%A4%E6%AC%A1%EF%BC%9F"><span class="nav-number">10.2.</span> <span class="nav-text">2. TCP 三次握手为什么不能两次？</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8D%81%E4%B8%80%E3%80%81%E9%9D%A2%E8%AF%95%E7%81%B5%E9%AD%82%E6%8B%B7%E9%97%AE"><span class="nav-number">11.</span> <span class="nav-text">十一、面试灵魂拷问</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%82%E8%80%83"><span class="nav-number">12.</span> <span class="nav-text">参考</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="wxquare"
      src="/images/avatar.jpeg">
  <p class="site-author-name" itemprop="name">wxquare</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">38</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">3</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">18</span>
        <span class="site-state-item-name">tags</span>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/yourname" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;yourname" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="/xianguiwang0316@gmail.com" title="E-Mail → xianguiwang0316@gmail.com" rel="noopener me"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2025/06/25/system-design/17-high-frequency-system-design/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpeg">
      <meta itemprop="name" content="wxquare">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="wxquare's Blogs">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="高频系统设计面试题速查手册 | wxquare's Blogs">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          高频系统设计面试题速查手册
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2025-06-25 00:00:00" itemprop="dateCreated datePublished" datetime="2025-06-25T00:00:00+08:00">2025-06-25</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2026-02-12 23:26:20" itemprop="dateModified" datetime="2026-02-12T23:26:20+08:00">2026-02-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/" itemprop="url" rel="index"><span itemprop="name">系统设计</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><!-- toc -->

<h2 id="一、高并发与流量治理"><a href="#一、高并发与流量治理" class="headerlink" title="一、高并发与流量治理"></a>一、高并发与流量治理</h2><h3 id="1-秒杀系统设计"><a href="#1-秒杀系统设计" class="headerlink" title="1. 秒杀系统设计"></a>1. 秒杀系统设计</h3><p><strong>核心挑战</strong>：瞬时流量巨大、库存超卖、恶意脚本。</p>
<p><strong>架构分层</strong>：</p>
<table>
<thead>
<tr>
<th>层级</th>
<th>策略</th>
</tr>
</thead>
<tbody><tr>
<td><strong>客户端&#x2F;CDN</strong></td>
<td>静态资源缓存；按钮置灰+答题验证（削峰防刷）</td>
</tr>
<tr>
<td><strong>网关层</strong></td>
<td>令牌桶&#x2F;漏桶限流；黑名单拦截；设备指纹识别</td>
</tr>
<tr>
<td><strong>服务层</strong></td>
<td>库存预热到 Redis；MQ 异步扣减 DB 库存；非核心服务降级</td>
</tr>
</tbody></table>
<p><strong>防超卖</strong>（核心）：</p>
<ul>
<li><strong>Redis Lua 脚本</strong>原子扣减：<code>if redis.call(&#39;get&#39;, key) &gt; 0 then redis.call(&#39;decr&#39;, key) ...</code></li>
<li><strong>DB 乐观锁兜底</strong>：<code>UPDATE stock SET num = num - 1 WHERE id = ? AND num &gt; 0</code></li>
</ul>
<p><strong>防黄牛&#x2F;脚本</strong>：</p>
<ul>
<li>滑块验证 &#x2F; 人机识别</li>
<li>设备指纹 + 行为分析（点击间隔、轨迹）</li>
<li>实名认证 + 限购（身份证&#x2F;手机号去重）</li>
</ul>
<hr>
<h3 id="2-分布式限流"><a href="#2-分布式限流" class="headerlink" title="2. 分布式限流"></a>2. 分布式限流</h3><p><strong>算法对比</strong>：</p>
<table>
<thead>
<tr>
<th>算法</th>
<th>优点</th>
<th>缺点</th>
</tr>
</thead>
<tbody><tr>
<td><strong>固定窗口计数器</strong></td>
<td>实现简单</td>
<td>临界突发：窗口交界处可能 2 倍流量</td>
</tr>
<tr>
<td><strong>滑动窗口</strong></td>
<td>解决临界突发</td>
<td>内存开销大（需存每个请求时间戳）</td>
</tr>
<tr>
<td><strong>漏桶</strong></td>
<td>平滑输出</td>
<td>无法应对合理突发</td>
</tr>
<tr>
<td><strong>令牌桶</strong></td>
<td>允许突发</td>
<td>实现稍复杂</td>
</tr>
</tbody></table>
<p><strong>分布式实现</strong>：Redis + Lua（ZSet 滑动窗口 &#x2F; Token Bucket）。</p>
<p><strong>动态限流</strong>：基于 CPU、RT、错误率自适应调整阈值（Sentinel &#x2F; Hystrix）。</p>
<hr>
<h3 id="3-热点发现与隔离"><a href="#3-热点发现与隔离" class="headerlink" title="3. 热点发现与隔离"></a>3. 热点发现与隔离</h3><p><strong>场景</strong>：秒杀商品、热搜词、突发事件导致单个 Key 流量爆炸。</p>
<p><strong>方案</strong>：</p>
<ol>
<li><strong>探测</strong>：实时统计 QPS，自动识别热点 Key。</li>
<li><strong>本地缓存</strong>：热点 Key 复制到 JVM 内存（Caffeine），直接拦截。</li>
<li><strong>分散压力</strong>：Key 后缀加随机值（<code>key_1 ~ key_N</code>），分散到多个 Redis 分片。</li>
<li><strong>隔离</strong>：热点请求走独立线程池 + 独立缓存节点，不影响普通流量。</li>
</ol>
<hr>
<h3 id="4-熔断、降级、限流的区别"><a href="#4-熔断、降级、限流的区别" class="headerlink" title="4. 熔断、降级、限流的区别"></a>4. 熔断、降级、限流的区别</h3><table>
<thead>
<tr>
<th>手段</th>
<th>目标</th>
<th>触发条件</th>
</tr>
</thead>
<tbody><tr>
<td><strong>限流</strong></td>
<td>控制入口流量</td>
<td>QPS 超阈值</td>
</tr>
<tr>
<td><strong>熔断</strong></td>
<td>切断对下游的调用</td>
<td>下游错误率&#x2F;超时率过高</td>
</tr>
<tr>
<td><strong>降级</strong></td>
<td>关闭非核心功能</td>
<td>系统负载高、人工&#x2F;自动触发</td>
</tr>
<tr>
<td><strong>兜底</strong></td>
<td>给用户默认响应</td>
<td>降级后的补偿策略</td>
</tr>
</tbody></table>
<p><strong>口诀</strong>：限流防激增，熔断防雪崩，降级保核心，兜底提体验。</p>
<hr>
<h3 id="5-AI-Agent-高并发架构"><a href="#5-AI-Agent-高并发架构" class="headerlink" title="5. AI Agent 高并发架构"></a>5. AI Agent 高并发架构</h3><p><strong>挑战</strong>：LLM 推理慢（秒级）、显存&#x2F;线程池易耗尽、Token 成本高。</p>
<p><strong>优化策略</strong>：</p>
<ul>
<li><strong>全异步化</strong>：请求 → MQ → Agent 消费 → 结果存储 → 前端 SSE 推送。</li>
<li>**流式输出 (SSE)**：Token 级返回，降低首屏感知延迟。</li>
<li>**语义缓存 (Semantic Cache)**：向量相似度匹配高频问题，直接返回缓存。</li>
<li><strong>成本优化</strong>：模型蒸馏（小模型处理简单请求）；KV Cache 复用；请求批处理 (Batching)。</li>
<li><strong>限流熔断</strong>：严格限制 Agent 调用内部工具接口的频率，防止 AI 攻击内部系统。</li>
</ul>
<hr>
<h2 id="二、海量数据与存储"><a href="#二、海量数据与存储" class="headerlink" title="二、海量数据与存储"></a>二、海量数据与存储</h2><h3 id="1-40亿数据去重（1GB-内存限制）"><a href="#1-40亿数据去重（1GB-内存限制）" class="headerlink" title="1. 40亿数据去重（1GB 内存限制）"></a>1. 40亿数据去重（1GB 内存限制）</h3><p><strong>方案对比</strong>：</p>
<table>
<thead>
<tr>
<th>方案</th>
<th>空间</th>
<th>精确度</th>
<th>支持删除</th>
</tr>
</thead>
<tbody><tr>
<td><strong>Bitmap</strong></td>
<td>40亿 ≈ 500MB</td>
<td>精确</td>
<td>否</td>
</tr>
<tr>
<td><strong>Bloom Filter</strong></td>
<td>极小（几十 MB）</td>
<td>有误判</td>
<td>否（Counting BF 可以，但空间 ×4）</td>
</tr>
<tr>
<td><strong>HyperLogLog</strong></td>
<td>12KB</td>
<td>误差 0.81%</td>
<td>否</td>
</tr>
</tbody></table>
<p><strong>最佳回答</strong>：</p>
<ul>
<li>40亿 QQ 号（unsigned int 范围 0~2^32）→ <strong>Bitmap</strong>，约 512MB 可精确去重。</li>
<li>若内存更紧张或允许少量误判 → <strong>Bloom Filter</strong>。</li>
<li>只需统计基数（不需要知道具体哪些重复）→ <strong>HyperLogLog</strong>。</li>
</ul>
<hr>
<h3 id="2-1亿玩家实时排行榜"><a href="#2-1亿玩家实时排行榜" class="headerlink" title="2. 1亿玩家实时排行榜"></a>2. 1亿玩家实时排行榜</h3><p><strong>Redis ZSet 方案</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ZADD rank 5000 &quot;player_1&quot;</span><br><span class="line">ZREVRANGE rank 0 9  -- Top 10</span><br><span class="line">ZRANK rank &quot;player_1&quot; -- 查排名</span><br></pre></td></tr></table></figure>

<p><strong>陷阱</strong>：ZSet 元素超过千万级 → 大 Key 阻塞主线程。</p>
<p><strong>解决方案（分桶 + 聚合）</strong>：</p>
<ol>
<li>按玩家 ID 模 N 分到 N 个 ZSet：<code>rank_0, rank_1 ... rank_N</code>。</li>
<li>每个桶取 Top K。</li>
<li>应用层归并 N 个桶的 Top K，得到全局 Top K。</li>
</ol>
<p><strong>分页优化</strong>：</p>
<ul>
<li><code>ZRANGE</code> 深分页性能差（O(logN + M)）。</li>
<li><strong>游标分页</strong>：记录上一页最后的 <code>(score, member_id)</code>，下一页从该位置继续查。</li>
<li><strong>快照分页</strong>：定时 dump 排行到 DB，前端查快照。</li>
</ul>
<hr>
<h3 id="3-海量数据排序（100GB-数据，8GB-内存）"><a href="#3-海量数据排序（100GB-数据，8GB-内存）" class="headerlink" title="3. 海量数据排序（100GB 数据，8GB 内存）"></a>3. 海量数据排序（100GB 数据，8GB 内存）</h3><ol>
<li><strong>分块读入</strong>：每次读入 8GB → 内存快排 → 写出有序文件。</li>
<li><strong>多路归并</strong>：用小顶堆同时从 13 个有序文件中取最小值，输出全局有序文件。</li>
<li><strong>分布式</strong>：MapReduce &#x2F; Spark 分布式排序。</li>
</ol>
<hr>
<h3 id="4-10亿用户在线状态"><a href="#4-10亿用户在线状态" class="headerlink" title="4. 10亿用户在线状态"></a>4. 10亿用户在线状态</h3><p><strong>Bitmap</strong>：1 bit 表示 1 个用户的在线&#x2F;离线。1亿用户仅 12MB，10 亿用户约 120MB。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SETBIT online 123456 1   -- 用户123456上线</span><br><span class="line">GETBIT online 123456     -- 查询是否在线</span><br><span class="line">BITCOUNT online          -- 统计在线人数</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="三、典型业务场景设计"><a href="#三、典型业务场景设计" class="headerlink" title="三、典型业务场景设计"></a>三、典型业务场景设计</h2><h3 id="1-订单超时自动取消"><a href="#1-订单超时自动取消" class="headerlink" title="1. 订单超时自动取消"></a>1. 订单超时自动取消</h3><p><strong>场景</strong>：下单 30 分钟未支付自动关闭。</p>
<table>
<thead>
<tr>
<th>方案</th>
<th>优点</th>
<th>缺点</th>
</tr>
</thead>
<tbody><tr>
<td><strong>定时任务扫表</strong></td>
<td>实现简单</td>
<td>数据量大时效率低，延迟高</td>
</tr>
<tr>
<td><strong>Redis 过期监听</strong></td>
<td>简单</td>
<td>不可靠（不保证触发），<strong>不推荐</strong></td>
</tr>
<tr>
<td><strong>Redis ZSet 轮询</strong></td>
<td>精度高</td>
<td>需维护消费者</td>
</tr>
<tr>
<td><strong>RocketMQ 延迟消息</strong></td>
<td>可靠、可扩展</td>
<td>延迟级别有限</td>
</tr>
<tr>
<td><strong>RabbitMQ TTL + DLX</strong></td>
<td>灵活</td>
<td>架构复杂</td>
</tr>
<tr>
<td><strong>时间轮 (Time Wheel)</strong></td>
<td>高吞吐、内存高效</td>
<td>适合固定延迟场景</td>
</tr>
</tbody></table>
<p><strong>最佳回答</strong>：</p>
<ul>
<li><strong>短延迟 + 高吞吐</strong>（如 &lt;5 min）：时间轮。</li>
<li><strong>长延迟 + 高可靠</strong>（如 30 min 关单）：RocketMQ 延迟消息或 Redis ZSet。</li>
<li><strong>千万级订单</strong>：定时任务扫表无法胜任，必须用延迟队列。</li>
</ul>
<hr>
<h3 id="2-分布式-ID-生成器"><a href="#2-分布式-ID-生成器" class="headerlink" title="2. 分布式 ID 生成器"></a>2. 分布式 ID 生成器</h3><table>
<thead>
<tr>
<th>方案</th>
<th>有序性</th>
<th>性能</th>
<th>问题</th>
</tr>
</thead>
<tbody><tr>
<td><strong>UUID</strong></td>
<td>无序</td>
<td>高</td>
<td>太长（128bit），B+ 树索引性能差</td>
</tr>
<tr>
<td><strong>数据库号段</strong></td>
<td>趋势递增</td>
<td>高</td>
<td>批量取号，DB 宕机有号段浪费</td>
</tr>
<tr>
<td><strong>Snowflake</strong></td>
<td>趋势递增</td>
<td>高</td>
<td>依赖时钟，回拨会重复</td>
</tr>
<tr>
<td><strong>Redis INCR</strong></td>
<td>递增</td>
<td>高</td>
<td>持久化风险，单点问题</td>
</tr>
</tbody></table>
<p><strong>Snowflake 结构</strong>：1 位符号 + 41 位时间戳（69 年）+ 10 位机器 ID + 12 位序列号（4096&#x2F;ms）。</p>
<p><strong>容器化环境机器 ID 唯一</strong>：</p>
<ul>
<li>Pod Name &#x2F; IP 哈希取模。</li>
<li>启动时向 Etcd&#x2F;ZooKeeper 注册获取唯一 ID。</li>
<li>Redis INCR 动态分配 workerID。</li>
</ul>
<hr>
<h3 id="3-短链接系统"><a href="#3-短链接系统" class="headerlink" title="3. 短链接系统"></a>3. 短链接系统</h3><p><strong>生成策略</strong>：</p>
<ul>
<li><strong>发号器 + Base62</strong>：分布式 ID → 62 进制编码（a-z, A-Z, 0-9），6 位可表示 $62^6$ ≈ 568 亿。</li>
<li>Hash（MD5&#x2F;Murmur）取前 N 位：简单但需处理冲突。</li>
</ul>
<p><strong>重定向选择</strong>：</p>
<ul>
<li><strong>301 永久重定向</strong>：浏览器缓存，无法统计点击数。</li>
<li><strong>302 临时重定向</strong>：每次经过服务端，可统计 UA、IP、Referer 等点击来源。</li>
</ul>
<p><strong>点击统计</strong>：302 重定向时解析 UA&#x2F;IP&#x2F;渠道 → 异步写入日志 → Flink 聚合 → ClickHouse 存储。</p>
<hr>
<h3 id="4-Feed-流系统"><a href="#4-Feed-流系统" class="headerlink" title="4. Feed 流系统"></a>4. Feed 流系统</h3><table>
<thead>
<tr>
<th>模式</th>
<th>读性能</th>
<th>写性能</th>
<th>适用场景</th>
</tr>
</thead>
<tbody><tr>
<td><strong>推 (Write-fanout)</strong></td>
<td>快</td>
<td>慢（写 N 个粉丝收件箱）</td>
<td>普通用户</td>
</tr>
<tr>
<td><strong>拉 (Read-fanout)</strong></td>
<td>慢（聚合 N 个关注人）</td>
<td>快</td>
<td>大 V</td>
</tr>
<tr>
<td><strong>推拉结合</strong></td>
<td>均衡</td>
<td>均衡</td>
<td><strong>业界主流</strong></td>
</tr>
</tbody></table>
<p><strong>推拉结合策略</strong>：</p>
<ul>
<li>活跃用户 &#x2F; 普通博主：推模式。</li>
<li>大 V &#x2F; 僵尸粉：拉模式。</li>
</ul>
<p><strong>已读去重</strong>：用户维度维护 RoaringBitmap，推送前 <code>if (!bitmap.contains(postId)) push()</code>。</p>
<hr>
<h3 id="5-评论系统（B站-抖音盖楼）"><a href="#5-评论系统（B站-抖音盖楼）" class="headerlink" title="5. 评论系统（B站&#x2F;抖音盖楼）"></a>5. 评论系统（B站&#x2F;抖音盖楼）</h3><p><strong>存储模型对比</strong>：</p>
<table>
<thead>
<tr>
<th>模型</th>
<th>原理</th>
<th>优点</th>
<th>缺点</th>
</tr>
</thead>
<tbody><tr>
<td><strong>邻接表</strong></td>
<td><code>id, parent_id</code></td>
<td>简单</td>
<td>查子树需递归，性能差</td>
</tr>
<tr>
<td><strong>路径枚举</strong></td>
<td><code>id, path=&quot;1/2/5&quot;</code></td>
<td>前缀查询方便</td>
<td>路径长度受限</td>
</tr>
<tr>
<td><strong>闭包表</strong></td>
<td>单独表存所有祖先-后代</td>
<td>查询极快</td>
<td>写入量大</td>
</tr>
</tbody></table>
<p><strong>业界主流（两层结构）</strong>：</p>
<ul>
<li><strong>一级评论</strong>：按热度&#x2F;时间排序（Redis ZSet 或 DB 索引）。</li>
<li><strong>二级回复</strong>：扁平化存储。<code>parent_id</code> 指向一级评论，<code>reply_to_id</code> 指向被回复的人。不做无限嵌套。</li>
</ul>
<p><strong>防灌水</strong>：发言频率限制 → 敏感词过滤（AC 自动机）→ 举报+审核队列 → 新用户评论需审核（信任分体系）。</p>
<hr>
<h3 id="6-红包算法"><a href="#6-红包算法" class="headerlink" title="6. 红包算法"></a>6. 红包算法</h3><p><strong>二倍均值法</strong>：<code>amount = random(1, remain / remain_count * 2)</code>，数学上保证期望恒定。</p>
<p><strong>高并发实现</strong>：</p>
<ul>
<li><strong>预分配</strong>：发红包时一次性算好所有金额，存入 Redis List。</li>
<li><strong>抢红包</strong>：<code>LPOP</code> 原子弹出，天然串行化。</li>
</ul>
<hr>
<h3 id="7-支付系统设计"><a href="#7-支付系统设计" class="headerlink" title="7. 支付系统设计"></a>7. 支付系统设计</h3><p><strong>核心链路</strong>：下单 → 锁库存 → 创建支付单 → 调第三方支付 → 异步回调 → 扣库存 → 发货。</p>
<p><strong>关键设计点</strong>：</p>
<ul>
<li><strong>幂等</strong>：<code>transaction_id</code> 唯一索引，重复回调不重复处理。</li>
<li><strong>签名验签</strong>：防篡改请求金额。</li>
<li><strong>对账系统</strong>：每日与第三方支付平台账单核对，发现差异报警。</li>
<li><strong>事务消息</strong>：RocketMQ 半消息保证扣库存与支付状态一致。</li>
</ul>
<hr>
<h3 id="8-库存系统深度设计"><a href="#8-库存系统深度设计" class="headerlink" title="8. 库存系统深度设计"></a>8. 库存系统深度设计</h3><h4 id="Q1：如何设计一个统一库存系统，支持电商、虚拟商品、本地生活等多品类？"><a href="#Q1：如何设计一个统一库存系统，支持电商、虚拟商品、本地生活等多品类？" class="headerlink" title="Q1：如何设计一个统一库存系统，支持电商、虚拟商品、本地生活等多品类？"></a>Q1：如何设计一个统一库存系统，支持电商、虚拟商品、本地生活等多品类？</h4><p><strong>核心洞察</strong>：不同品类库存差异巨大，需要抽象出通用模型。</p>
<p><strong>两个正交维度分类</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">维度一：谁管库存？</span><br><span class="line">  - 自管理 (SelfManaged)：平台维护（Deal、OPV）</span><br><span class="line">  - 供应商管理 (SupplierManaged)：第三方维护（酒店、机票）</span><br><span class="line">  - 无限库存 (Unlimited)：无需管理（话费充值）</span><br><span class="line"></span><br><span class="line">维度二：库存形态是什么？</span><br><span class="line">  - 券码制 (CodeBased)：每个库存是唯一券码（电子券、Giftcard）</span><br><span class="line">  - 数量制 (QuantityBased)：库存是一个数字（虚拟服务券）</span><br><span class="line">  - 时间维度 (TimeBased)：按日期/时段管理（酒店、票务）</span><br><span class="line">  - 组合型 (BundleBased)：多子项联动扣减（套餐）</span><br></pre></td></tr></table></figure>

<p><strong>品类分类矩阵示例</strong>：</p>
<table>
<thead>
<tr>
<th>品类</th>
<th>管理类型</th>
<th>单元类型</th>
<th>扣减时机</th>
</tr>
</thead>
<tbody><tr>
<td>电子券</td>
<td>Self</td>
<td>Code</td>
<td>下单</td>
</tr>
<tr>
<td>虚拟服务券</td>
<td>Self</td>
<td>Quantity</td>
<td>下单</td>
</tr>
<tr>
<td>酒店</td>
<td>Supplier</td>
<td>Time</td>
<td>支付</td>
</tr>
<tr>
<td>礼品卡(实时生成)</td>
<td>Supplier</td>
<td>Code</td>
<td>支付</td>
</tr>
</tbody></table>
<p><strong>架构设计（策略模式）</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">业务层 (Order Service)</span><br><span class="line">    ↓</span><br><span class="line">库存管理器 (InventoryManager)</span><br><span class="line">    ↓</span><br><span class="line">策略路由器 (根据 inventory_config 选策略)</span><br><span class="line">    ↓</span><br><span class="line">具体策略: SelfManagedStrategy / SupplierManagedStrategy / UnlimitedStrategy</span><br><span class="line">    ↓</span><br><span class="line">存储层: Redis (Hot) + MySQL (Cold) + Kafka (Async)</span><br></pre></td></tr></table></figure>

<p><strong>核心优势</strong>：</p>
<ul>
<li>✅ 新品类接入只需写配置，无需改代码。</li>
<li>✅ 每个策略独立实现，复杂度隔离。</li>
</ul>
<hr>
<h4 id="Q2：券码制库存（如电子券）如何实现高并发扣减？"><a href="#Q2：券码制库存（如电子券）如何实现高并发扣减？" class="headerlink" title="Q2：券码制库存（如电子券）如何实现高并发扣减？"></a>Q2：券码制库存（如电子券）如何实现高并发扣减？</h4><p><strong>Redis 存储结构</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Key:   inventory:code:pool:&#123;itemID&#125;:&#123;skuID&#125;:&#123;batchID&#125;</span><br><span class="line">Type:  LIST</span><br><span class="line">Value: [codeID_1, codeID_2, ...]</span><br><span class="line"></span><br><span class="line">Key:   inventory:code:cursor:&#123;itemID&#125;:&#123;skuID&#125;:&#123;batchID&#125;</span><br><span class="line">Value: &quot;lastCodeID:lockCount&quot;  (补货游标)</span><br><span class="line"></span><br><span class="line">Key:   inventory:empty:&#123;itemID&#125;:&#123;skuID&#125;:&#123;batchID&#125;</span><br><span class="line">TTL:   1h  (库存空标志，避免重复查 DB)</span><br></pre></td></tr></table></figure>

<p><strong>出货流程</strong>（核心）：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">1. 检查库存空标志 → 命中则直接返回缺货</span><br><span class="line">2. Redis LIST 原子出货 (Lua: LRANGE + LTRIM)</span><br><span class="line">3. 如果库存不足 → 补货 (从 MySQL 查 3000 个可用券码 → RPUSH 到 Redis)</span><br><span class="line">4. 更新 MySQL 券码状态: AVAILABLE → BOOKING</span><br><span class="line">5. 同步更新 inventory 表: booking_stock += quantity</span><br><span class="line">6. 发送 Kafka 事件异步记录日志</span><br></pre></td></tr></table></figure>

<p><strong>Lua 脚本（原子性保证）</strong>：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> result = redis.call(<span class="string">&#x27;LRANGE&#x27;</span>, KEYS[<span class="number">1</span>], <span class="number">0</span>, ARGV[<span class="number">1</span>] - <span class="number">1</span>)</span><br><span class="line">redis.call(<span class="string">&#x27;LTRIM&#x27;</span>, KEYS[<span class="number">1</span>], ARGV[<span class="number">1</span>], <span class="number">-1</span>)</span><br><span class="line"><span class="keyword">return</span> result</span><br></pre></td></tr></table></figure>

<p><strong>关键设计</strong>：</p>
<ul>
<li><strong>Lazy Loading</strong>：按需补货，避免一次性加载全量券码到 Redis（节省内存）。</li>
<li><strong>分布式锁</strong>：补货时加锁，防止并发补货导致重复。</li>
<li><strong>库存空标志</strong>：DB 无库存后，1小时内拦截所有请求，避免反复查 DB。</li>
</ul>
<hr>
<h4 id="Q3：数量制库存（如虚拟服务券）如何支持营销活动动态库存？"><a href="#Q3：数量制库存（如虚拟服务券）如何支持营销活动动态库存？" class="headerlink" title="Q3：数量制库存（如虚拟服务券）如何支持营销活动动态库存？"></a>Q3：数量制库存（如虚拟服务券）如何支持营销活动动态库存？</h4><p><strong>Redis HASH 设计</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Key:   inventory:qty:stock:&#123;itemID&#125;:&#123;skuID&#125;</span><br><span class="line">Type:  HASH</span><br><span class="line">Fields:</span><br><span class="line">  &quot;available&quot;   : 10000       # 普通可售库存</span><br><span class="line">  &quot;booking&quot;     : 50          # 预订中</span><br><span class="line">  &quot;issued&quot;      : 5000        # 已售</span><br><span class="line">  &quot;&#123;promotionID&#125;&quot;: 500        # 营销活动独立库存（动态字段）</span><br></pre></td></tr></table></figure>

<p><strong>预订 Lua 脚本（支持营销库存）</strong>：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 1. 获取普通库存和营销库存</span></span><br><span class="line"><span class="keyword">local</span> available = <span class="built_in">tonumber</span>(redis.call(<span class="string">&#x27;HGET&#x27;</span>, key, <span class="string">&#x27;available&#x27;</span>) <span class="keyword">or</span> <span class="number">0</span>)</span><br><span class="line"><span class="keyword">local</span> promo = <span class="built_in">tonumber</span>(redis.call(<span class="string">&#x27;HGET&#x27;</span>, key, promotion_id) <span class="keyword">or</span> <span class="number">0</span>)</span><br><span class="line"><span class="keyword">local</span> total = available + promo</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 2. 检查库存</span></span><br><span class="line"><span class="keyword">if</span> book_num &gt; total <span class="keyword">then</span> <span class="keyword">return</span> <span class="number">-1</span> <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 3. 优先扣营销库存，不足时扣普通库存</span></span><br><span class="line"><span class="keyword">if</span> promo &gt;= book_num <span class="keyword">then</span></span><br><span class="line">    redis.call(<span class="string">&#x27;HINCRBY&#x27;</span>, key, promotion_id, -book_num)</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    redis.call(<span class="string">&#x27;HSET&#x27;</span>, key, promotion_id, <span class="number">0</span>)</span><br><span class="line">    redis.call(<span class="string">&#x27;HINCRBY&#x27;</span>, key, <span class="string">&#x27;available&#x27;</span>, -(book_num - promo))</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 4. 增加预订数</span></span><br><span class="line">redis.call(<span class="string">&#x27;HINCRBY&#x27;</span>, key, <span class="string">&#x27;booking&#x27;</span>, book_num)</span><br></pre></td></tr></table></figure>

<p><strong>亮点</strong>：动态字段设计，无需提前建表，营销活动 ID 直接作为 HASH field。</p>
<hr>
<h4 id="Q4：供应商管理的库存（如酒店、机票）如何同步？"><a href="#Q4：供应商管理的库存（如酒店、机票）如何同步？" class="headerlink" title="Q4：供应商管理的库存（如酒店、机票）如何同步？"></a>Q4：供应商管理的库存（如酒店、机票）如何同步？</h4><p><strong>三种同步策略</strong>：</p>
<table>
<thead>
<tr>
<th>策略</th>
<th>适用场景</th>
<th>实时性</th>
<th>实现</th>
</tr>
</thead>
<tbody><tr>
<td><strong>实时查询</strong></td>
<td>库存变化快（机票）</td>
<td>高</td>
<td>每次请求调 API（30s 缓存）</td>
</tr>
<tr>
<td><strong>定时同步</strong></td>
<td>变化中等（酒店）</td>
<td>中</td>
<td>定时任务每 5 分钟拉取</td>
</tr>
<tr>
<td><strong>Webhook 推送</strong></td>
<td>供应商主动推送</td>
<td>高</td>
<td>接收推送更新本地缓存</td>
</tr>
</tbody></table>
<p><strong>实时查询流程</strong>：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">CheckStock</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="comment">// 1. 查 Redis 缓存（30s TTL）</span></span><br><span class="line">    <span class="keyword">if</span> stock := redis.Get(cacheKey); stock != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> stock  <span class="comment">// 命中缓存</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. 缓存未命中，调供应商 API</span></span><br><span class="line">    stock := supplierAPI.QueryStock(itemID, date)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. 写入 Redis（30s）+ 异步写快照表（用于对账）</span></span><br><span class="line">    redis.Set(cacheKey, stock, <span class="number">30</span>*time.Second)</span><br><span class="line">    <span class="keyword">go</span> saveSnapshot(itemID, stock, <span class="string">&quot;api&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> stock</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>预订时</strong>：调供应商预订接口 → 保存供应商订单号映射 → 更新本地 booking_stock。</p>
<hr>
<h4 id="Q5：如何保证-Redis-与-MySQL-库存数据一致性？"><a href="#Q5：如何保证-Redis-与-MySQL-库存数据一致性？" class="headerlink" title="Q5：如何保证 Redis 与 MySQL 库存数据一致性？"></a>Q5：如何保证 Redis 与 MySQL 库存数据一致性？</h4><p><strong>双写策略</strong>：</p>
<table>
<thead>
<tr>
<th>操作</th>
<th>Redis</th>
<th>MySQL</th>
<th>一致性</th>
</tr>
</thead>
<tbody><tr>
<td>预订 (Book)</td>
<td>同步扣减（Lua）</td>
<td>Kafka 异步更新</td>
<td>最终一致</td>
</tr>
<tr>
<td>支付 (Sell)</td>
<td>同步更新</td>
<td>Kafka 异步更新</td>
<td>最终一致</td>
</tr>
<tr>
<td>营销锁定 (Lock)</td>
<td>同步</td>
<td>同步（DB 事务）</td>
<td>强一致</td>
</tr>
</tbody></table>
<p><strong>核心原则</strong>：</p>
<ul>
<li><strong>Redis 是热路径</strong>：所有高频操作走 Redis（毫秒级响应）。</li>
<li><strong>MySQL 是权威数据源</strong>：故障恢复时以 MySQL 为准。</li>
<li><strong>Kafka 异步持久化</strong>：不阻塞主流程。</li>
</ul>
<p><strong>定时对账（每小时）</strong>：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">redisStock := getRedisAvailable(itemID)</span><br><span class="line">mysqlStock := getMySQLAvailable(itemID)</span><br><span class="line">diff := redisStock - mysqlStock</span><br><span class="line"></span><br><span class="line"><span class="comment">// 校验库存恒等式: total = available + booking + locked + sold</span></span><br><span class="line"><span class="keyword">if</span> mysqlTotal != mysqlAvailable + mysqlBooking + mysqlLocked + mysqlSold &#123;</span><br><span class="line">    alert(<span class="string">&quot;MySQL 数据不一致&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Redis vs MySQL 差异</span></span><br><span class="line"><span class="keyword">if</span> abs(diff) &gt; <span class="number">100</span> || abs(diff) &gt; mysqlStock*<span class="number">0.1</span> &#123;</span><br><span class="line">    alert(<span class="string">&quot;库存差异过大&quot;</span>)</span><br><span class="line">    syncRedisFromMySQL(itemID)  <span class="comment">// 自动修复</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h4 id="Q6：Redis-宕机了，库存系统如何降级？"><a href="#Q6：Redis-宕机了，库存系统如何降级？" class="headerlink" title="Q6：Redis 宕机了，库存系统如何降级？"></a>Q6：Redis 宕机了，库存系统如何降级？</h4><p><strong>降级方案</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Redis 可用</span><br><span class="line">  ↓</span><br><span class="line">正常走 Redis（&lt; 10ms）</span><br><span class="line"></span><br><span class="line">Redis 不可用</span><br><span class="line">  ↓</span><br><span class="line">降级到 MySQL 直接操作（~100ms，性能下降但业务不中断）</span><br><span class="line">  ↓</span><br><span class="line">券码制: SELECT ... FOR UPDATE + UPDATE status</span><br><span class="line">数量制: UPDATE available_stock = available_stock - ? WHERE available_stock &gt;= ?</span><br><span class="line">  ↓</span><br><span class="line">记录降级日志，Redis 恢复后从 MySQL 全量同步</span><br></pre></td></tr></table></figure>

<p><strong>注意</strong>：</p>
<ul>
<li>降级期间性能下降约 10 倍，需配合限流。</li>
<li>MySQL 需提前规划好容量，支持降级时的流量。</li>
</ul>
<hr>
<h4 id="Q7：Giftcard-实时生成卡密，供应商-API-超时怎么办？"><a href="#Q7：Giftcard-实时生成卡密，供应商-API-超时怎么办？" class="headerlink" title="Q7：Giftcard 实时生成卡密，供应商 API 超时怎么办？"></a>Q7：Giftcard 实时生成卡密，供应商 API 超时怎么办？</h4><p><strong>问题</strong>：支付成功后调供应商 API 生成卡密，超时会导致用户等待。</p>
<p><strong>解决方案（异步生成 + 重试补偿）</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">支付成功</span><br><span class="line">  ↓</span><br><span class="line">1. 订单状态更新为&quot;处理中&quot;</span><br><span class="line">  ↓</span><br><span class="line">2. 发送到 MQ 异步队列 (giftcard.generate)</span><br><span class="line">  ↓</span><br><span class="line">3. 用户先看到&quot;卡密生成中，稍后通知&quot;</span><br><span class="line"></span><br><span class="line">异步消费者：</span><br><span class="line">  ↓</span><br><span class="line">调用供应商 API 生成卡密</span><br><span class="line">  ↓</span><br><span class="line">失败？→ 指数退避重试 (1s, 2s, 4s)</span><br><span class="line">  ↓</span><br><span class="line">3 次仍失败？→ 人工补发 + 告警</span><br><span class="line">  ↓</span><br><span class="line">成功：保存卡密 → 推送通知用户</span><br></pre></td></tr></table></figure>

<p><strong>卡密安全</strong>：</p>
<ul>
<li>存储时 AES-256 加密。</li>
<li>管理后台脱敏显示（<code>XXXX-XXXX-XXXX-1234</code>）。</li>
<li>所有访问记录审计日志。</li>
</ul>
<hr>
<h4 id="Q8：时间维度库存（酒店-票务）与普通库存有什么不同？"><a href="#Q8：时间维度库存（酒店-票务）与普通库存有什么不同？" class="headerlink" title="Q8：时间维度库存（酒店&#x2F;票务）与普通库存有什么不同？"></a>Q8：时间维度库存（酒店&#x2F;票务）与普通库存有什么不同？</h4><p><strong>差异</strong>：</p>
<table>
<thead>
<tr>
<th>维度</th>
<th>普通库存</th>
<th>时间维度库存</th>
</tr>
</thead>
<tbody><tr>
<td><strong>库存粒度</strong></td>
<td>SKU 级别</td>
<td>SKU + 日期</td>
</tr>
<tr>
<td><strong>存储</strong></td>
<td>单条记录</td>
<td>每个日期一条记录</td>
</tr>
<tr>
<td><strong>查询</strong></td>
<td>按 item_id + sku_id</td>
<td>按 item_id + sku_id + date</td>
</tr>
<tr>
<td><strong>TTL</strong></td>
<td>永久</td>
<td>Redis 缓存 7 天</td>
</tr>
</tbody></table>
<p><strong>Redis 设计</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Key:   inventory:time:stock:&#123;itemID&#125;:&#123;skuID&#125;:&#123;date&#125;</span><br><span class="line">Type:  HASH</span><br><span class="line">Fields:</span><br><span class="line">  &quot;total&quot;     : 100</span><br><span class="line">  &quot;available&quot; : 80</span><br><span class="line">  &quot;booking&quot;   : 15</span><br><span class="line">  &quot;sold&quot;      : 5</span><br><span class="line">TTL: 7天（历史日期自动过期，节省内存）</span><br></pre></td></tr></table></figure>

<p><strong>挑战</strong>：</p>
<ul>
<li>酒店 1 个月有 30 条记录，查询”未来 7 天房态”需扫描 7 个 Key。</li>
<li>优化：批量 <code>MGET</code> + 并行查询。</li>
</ul>
<hr>
<h4 id="Q9：如何支持”秒杀活动锁定-1000-件库存”？"><a href="#Q9：如何支持”秒杀活动锁定-1000-件库存”？" class="headerlink" title="Q9：如何支持”秒杀活动锁定 1000 件库存”？"></a>Q9：如何支持”秒杀活动锁定 1000 件库存”？</h4><p><strong>场景</strong>：运营配置秒杀活动，需从总库存中锁定 1000 件，活动结束释放。</p>
<p><strong>Lua 脚本（营销锁定）</strong>：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> available = <span class="built_in">tonumber</span>(redis.call(<span class="string">&#x27;HGET&#x27;</span>, key, <span class="string">&#x27;available&#x27;</span>) <span class="keyword">or</span> <span class="number">0</span>)</span><br><span class="line"><span class="keyword">local</span> promo_stock = <span class="built_in">tonumber</span>(redis.call(<span class="string">&#x27;HGET&#x27;</span>, key, promotion_id) <span class="keyword">or</span> <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 检查库存</span></span><br><span class="line"><span class="keyword">if</span> lock_num &gt; available <span class="keyword">then</span> <span class="keyword">return</span> <span class="number">-1</span> <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 从普通库存转移到营销库存</span></span><br><span class="line">redis.call(<span class="string">&#x27;HINCRBY&#x27;</span>, key, <span class="string">&#x27;available&#x27;</span>, -lock_num)</span><br><span class="line">redis.call(<span class="string">&#x27;HSET&#x27;</span>, key, promotion_id, lock_num)</span><br></pre></td></tr></table></figure>

<p><strong>数据库同步</strong>：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">UPDATE</span> inventory </span><br><span class="line"><span class="keyword">SET</span> available_stock <span class="operator">=</span> available_stock <span class="operator">-</span> ?,</span><br><span class="line">    locked_stock <span class="operator">=</span> locked_stock <span class="operator">+</span> ?</span><br><span class="line"><span class="keyword">WHERE</span> item_id <span class="operator">=</span> ?</span><br></pre></td></tr></table></figure>

<p><strong>活动结束解锁</strong>：反向操作，营销库存 → 普通库存。</p>
<hr>
<h4 id="Q10：新接入一个品类”演唱会门票”，如何快速支持？"><a href="#Q10：新接入一个品类”演唱会门票”，如何快速支持？" class="headerlink" title="Q10：新接入一个品类”演唱会门票”，如何快速支持？"></a>Q10：新接入一个品类”演唱会门票”，如何快速支持？</h4><p><strong>三步接入</strong>：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. 评估分类</span></span><br><span class="line"><span class="comment">// 演唱会门票 → 供应商管理 + 时间维度（按场次） + 支付成功扣减</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. 写配置</span></span><br><span class="line">INSERT INTO inventory_config (item_id, management_type, unit_type, deduct_timing, supplier_id, sync_strategy)</span><br><span class="line">VALUES (<span class="number">900001</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">2</span>, <span class="number">700001</span>, <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. 调用统一接口（无需改代码）</span></span><br><span class="line">inventoryManager.BookStock(ctx, &amp;BookStockReq&#123;</span><br><span class="line">    ItemID:       <span class="number">900001</span>,</span><br><span class="line">    SKUID:        <span class="number">0</span>,</span><br><span class="line">    Quantity:     <span class="number">2</span>,</span><br><span class="line">    OrderID:      orderID,</span><br><span class="line">    CalendarDate: <span class="string">&quot;2025-08-15&quot;</span>,  <span class="comment">// 场次日期</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p><strong>亮点</strong>：配置驱动，零代码接入。</p>
<hr>
<h4 id="面试追问点（高级）"><a href="#面试追问点（高级）" class="headerlink" title="面试追问点（高级）"></a>面试追问点（高级）</h4><p><strong>Q：为什么券码制库存不一次性加载全量到 Redis，而是按需补货？</strong></p>
<ul>
<li><strong>内存成本</strong>：百万张券码全量加载需要几百 MB 内存，大部分可能永远用不到。</li>
<li><strong>Lazy Loading</strong>：按需补货，每次补 3000 个，节省内存。</li>
<li><strong>补货游标</strong>：记录上次补到哪个 codeID，避免重复查询。</li>
</ul>
<p><strong>Q：库存对账发现 Redis 比 MySQL 多 500 个，怎么办？</strong></p>
<ul>
<li><strong>可能原因</strong>：<ul>
<li>Kafka 消息积压，MySQL 异步更新延迟。</li>
<li>Redis 补货后，MySQL 更新失败。</li>
<li>存在未完成的预订订单（booking 状态）。</li>
</ul>
</li>
<li><strong>处理</strong>：<ul>
<li>检查 Kafka 消费 lag。</li>
<li>以 <strong>MySQL 为准</strong>，用 MySQL 数据覆盖 Redis（权威数据源原则）。</li>
<li>人工核查异常订单。</li>
</ul>
</li>
</ul>
<p><strong>Q：多平台（Shopee、ShopeePay）如何独立统计库存？</strong></p>
<ul>
<li>Redis HASH 中增加 <code>booking_shopee</code>、<code>booking_shopeepay</code> 字段。</li>
<li>扣减时根据 <code>platform</code> 参数路由到不同字段。</li>
<li>DB 也冗余存储 <code>booking_stock</code> 和 <code>spp_booking_stock</code>。</li>
</ul>
<p><strong>Q：库存扣减后支付失败，如何归还库存？</strong></p>
<ul>
<li><strong>订单超时未支付</strong>：延迟队列（30min）→ 触发 UnbookStock。<ul>
<li>券码制：code status BOOKING → AVAILABLE，RPUSH 回 Redis LIST。</li>
<li>数量制：Redis <code>HINCRBY booking -1, HINCRBY available +1</code>。</li>
</ul>
</li>
<li><strong>支付明确失败</strong>：立即同步释放。</li>
</ul>
<hr>
<hr>
<h2 id="四、分布式一致性与事务"><a href="#四、分布式一致性与事务" class="headerlink" title="四、分布式一致性与事务"></a>四、分布式一致性与事务</h2><h3 id="1-分布式事务"><a href="#1-分布式事务" class="headerlink" title="1. 分布式事务"></a>1. 分布式事务</h3><table>
<thead>
<tr>
<th>方案</th>
<th>一致性</th>
<th>性能</th>
<th>侵入性</th>
<th>适用场景</th>
</tr>
</thead>
<tbody><tr>
<td><strong>2PC (XA)</strong></td>
<td>强一致</td>
<td>差（阻塞）</td>
<td>低</td>
<td>单体拆分初期</td>
</tr>
<tr>
<td><strong>TCC</strong></td>
<td>最终一致</td>
<td>中</td>
<td>高（需写 Try&#x2F;Confirm&#x2F;Cancel）</td>
<td>金融转账</td>
</tr>
<tr>
<td><strong>本地消息表</strong></td>
<td>最终一致</td>
<td>高</td>
<td>中</td>
<td>通用场景</td>
</tr>
<tr>
<td><strong>事务消息 (RocketMQ)</strong></td>
<td>最终一致</td>
<td>高</td>
<td>低</td>
<td>电商下单</td>
</tr>
<tr>
<td><strong>Saga</strong></td>
<td>最终一致</td>
<td>高</td>
<td>中</td>
<td>长事务（跨多个服务）</td>
</tr>
</tbody></table>
<p><strong>TCC 追问：Confirm&#x2F;Cancel 失败怎么办？</strong></p>
<ul>
<li>必须保证幂等 + 重试。</li>
<li>设置最大重试次数，超过后记录悬挂事务，人工补偿。</li>
</ul>
<hr>
<h3 id="2-Redis-与-MySQL-双写一致性"><a href="#2-Redis-与-MySQL-双写一致性" class="headerlink" title="2. Redis 与 MySQL 双写一致性"></a>2. Redis 与 MySQL 双写一致性</h3><table>
<thead>
<tr>
<th>方案</th>
<th>流程</th>
<th>优缺点</th>
</tr>
</thead>
<tbody><tr>
<td><strong>Cache Aside（推荐）</strong></td>
<td>先更新 DB → 再删 Cache</td>
<td>简单，极端并发下有短暂不一致</td>
</tr>
<tr>
<td><strong>延迟双删</strong></td>
<td>删 Cache → 更 DB → sleep → 再删 Cache</td>
<td>减少脏读窗口，sleep 时间难定</td>
</tr>
<tr>
<td><strong>Canal 订阅 Binlog</strong></td>
<td>更 DB → Canal 监听 → 异步删&#x2F;更新 Cache</td>
<td>最终一致性好，架构复杂</td>
</tr>
</tbody></table>
<p><strong>追问：先删缓存再更新 DB 有什么问题？</strong></p>
<ul>
<li>删缓存后，另一个请求读到旧 DB 数据并回填缓存 → 脏数据长期存在。</li>
<li><strong>正确顺序</strong>：先更新 DB，再删缓存。即使删失败，下次读取时缓存 Miss 会加载最新数据。</li>
</ul>
<hr>
<h3 id="3-接口幂等性"><a href="#3-接口幂等性" class="headerlink" title="3. 接口幂等性"></a>3. 接口幂等性</h3><p><strong>场景</strong>：网络抖动重复提交、支付回调重复通知。</p>
<table>
<thead>
<tr>
<th>方案</th>
<th>实现</th>
<th>适用</th>
</tr>
</thead>
<tbody><tr>
<td><strong>数据库唯一索引</strong></td>
<td><code>INSERT IGNORE</code> 或 <code>UNIQUE KEY</code></td>
<td>写操作去重</td>
</tr>
<tr>
<td><strong>Token 机制</strong></td>
<td>请求前获取 Token，提交时 Redis Lua 原子校验+删除</td>
<td>表单防重复提交</td>
</tr>
<tr>
<td><strong>状态机</strong></td>
<td><code>UPDATE SET status=&#39;PAID&#39; WHERE id=? AND status=&#39;UNPAID&#39;</code></td>
<td>状态流转类</td>
</tr>
</tbody></table>
<p><strong>支付回调幂等</strong>：支付平台传唯一 <code>transaction_id</code> → <code>INSERT IGNORE INTO payment_records (txn_id)</code>，已存在则跳过。</p>
<hr>
<h2 id="五、并发编程"><a href="#五、并发编程" class="headerlink" title="五、并发编程"></a>五、并发编程</h2><h3 id="1-线程池设计"><a href="#1-线程池设计" class="headerlink" title="1. 线程池设计"></a>1. 线程池设计</h3><p><strong>线程数设置</strong>：</p>
<ul>
<li><strong>CPU 密集型</strong>：<code>N + 1</code>（N &#x3D; CPU 核数）。</li>
<li><strong>IO 密集型</strong>：<code>N × (1 + Wait/Compute)</code> 或简化为 <code>2N</code>。</li>
</ul>
<p><strong>量化估算</strong>：</p>
<blockquote>
<p>核心接口 RT &#x3D; 500ms，目标 1 万 QPS。<br>单线程 QPS &#x3D; 1000&#x2F;500 &#x3D; 2。<br>单机需线程数 &#x3D; 10000 &#x2F; 2 &#x3D; 5000 → 不现实。<br>→ 需 <strong>多台机器</strong>：如 10 台，每台承担 1000 QPS，每台 500 线程。</p>
</blockquote>
<p><strong>共享 vs 独享</strong>：</p>
<ul>
<li><strong>独享</strong>：核心业务（支付、下单），防止被边缘业务拖垮。</li>
<li><strong>共享</strong>：非核心业务共用 Common 线程池。</li>
</ul>
<p><strong>监控</strong>：暴露 <code>activeCount, queueSize, completedTaskCount</code>，队列 &gt;80% 告警。</p>
<hr>
<h3 id="2-异步并行优化"><a href="#2-异步并行优化" class="headerlink" title="2. 异步并行优化"></a>2. 异步并行优化</h3><p><strong>场景</strong>：接口串行调用 A（用户信息）、B（积分）、C（优惠券），总耗时 T &#x3D; Ta + Tb + Tc。</p>
<p><strong>优化</strong>：<code>CompletableFuture</code> (Java) &#x2F; <code>errgroup</code> (Go) 并行调用，T &#x3D; max(Ta, Tb, Tc)。</p>
<p><strong>风险与应对</strong>：</p>
<ul>
<li>并行度过高 → 下游瞬时压力倍增 → 配合限流和熔断。</li>
<li>部分失败 → 降级返回默认值（如积分返回 0）。</li>
<li>长尾超时 → <code>orTimeout(500ms)</code> 强制超时。</li>
</ul>
<hr>
<h2 id="六、中间件选型与原理"><a href="#六、中间件选型与原理" class="headerlink" title="六、中间件选型与原理"></a>六、中间件选型与原理</h2><h3 id="1-消息队列选型"><a href="#1-消息队列选型" class="headerlink" title="1. 消息队列选型"></a>1. 消息队列选型</h3><table>
<thead>
<tr>
<th>维度</th>
<th>Kafka</th>
<th>RocketMQ</th>
<th>RabbitMQ</th>
</tr>
</thead>
<tbody><tr>
<td><strong>吞吐量</strong></td>
<td>极高（百万级 TPS）</td>
<td>高（十万级）</td>
<td>中（万级）</td>
</tr>
<tr>
<td><strong>延迟</strong></td>
<td>ms 级</td>
<td>ms 级</td>
<td>us 级</td>
</tr>
<tr>
<td><strong>事务消息</strong></td>
<td>不支持</td>
<td>支持</td>
<td>不支持</td>
</tr>
<tr>
<td><strong>延迟队列</strong></td>
<td>不原生</td>
<td>支持</td>
<td>TTL + DLX</td>
</tr>
<tr>
<td><strong>适用场景</strong></td>
<td>日志、大数据</td>
<td>金融、电商</td>
<td>中小规模、复杂路由</td>
</tr>
</tbody></table>
<p><strong>为什么用 MQ？</strong></p>
<ul>
<li><strong>解耦</strong>：上游不需要知道有几个下游消费者。</li>
<li><strong>异步</strong>：主流程快速返回，耗时操作后台处理。</li>
<li><strong>削峰</strong>：MQ 缓冲突发流量，消费者匀速消费，保护 DB。</li>
</ul>
<p><strong>消息不丢失（三环节保障）</strong>：</p>
<ol>
<li><strong>生产者</strong>：同步发送 + 失败重试。</li>
<li><strong>Broker</strong>：同步刷盘 (<code>SYNC_FLUSH</code>) + 主从同步。</li>
<li><strong>消费者</strong>：处理成功后再手动 ACK。</li>
</ol>
<p><strong>消息重复</strong>：消费端做幂等（唯一索引&#x2F;状态机）。</p>
<p><strong>消息积压</strong>：先扩容消费者 → 排查消费阻塞原因 → 必要时跳过非关键消息。</p>
<hr>
<h3 id="2-Redis-核心问题"><a href="#2-Redis-核心问题" class="headerlink" title="2. Redis 核心问题"></a>2. Redis 核心问题</h3><table>
<thead>
<tr>
<th>问题</th>
<th>原因</th>
<th>解决方案</th>
</tr>
</thead>
<tbody><tr>
<td><strong>缓存穿透</strong></td>
<td>查不存在的数据</td>
<td>Bloom Filter &#x2F; 缓存空值</td>
</tr>
<tr>
<td><strong>缓存击穿</strong></td>
<td>热点 Key 过期</td>
<td>互斥锁(Mutex) &#x2F; 逻辑过期</td>
</tr>
<tr>
<td><strong>缓存雪崩</strong></td>
<td>大量 Key 同时过期</td>
<td>随机过期时间 &#x2F; 多级缓存</td>
</tr>
<tr>
<td><strong>Big Key</strong></td>
<td>阻塞主线程</td>
<td>拆分 &#x2F; <code>UNLINK</code> 异步删除</td>
</tr>
</tbody></table>
<p><strong>Key 过期内存释放</strong>：</p>
<ul>
<li><strong>惰性删除</strong>：访问时才检查是否过期。</li>
<li><strong>定期删除</strong>：每秒随机抽取 20 个 Key 检查。</li>
<li><strong>陷阱</strong>：Redis 并非过期立即释放。从库不主动删，等主库发 DEL 命令 → 可能出现”主库内存正常，从库爆满”。</li>
</ul>
<hr>
<h3 id="3-MySQL-分库分表"><a href="#3-MySQL-分库分表" class="headerlink" title="3. MySQL 分库分表"></a>3. MySQL 分库分表</h3><p><strong>拆分策略</strong>：</p>
<ul>
<li><strong>垂直拆分</strong>：按业务拆库（用户库、订单库），按字段拆表（大字段独立）。</li>
<li><strong>水平拆分</strong>：按 <code>Hash(UserID)</code> 或 <code>Range(Time)</code> 分散数据行。</li>
</ul>
<p><strong>核心难题</strong>：</p>
<ul>
<li><strong>分布式 ID</strong>：Snowflake &#x2F; 号段模式。</li>
<li><strong>跨库 Join</strong>：应用层组装，或宽表冗余。</li>
<li><strong>非 Sharding Key 查询</strong>：按 UserID 分片后，商家查订单（MerchantID）怎么办？→ <strong>异构索引表</strong>，另建一套按 MerchantID 分片的表（或同步到 ES）。</li>
<li><strong>在线扩容</strong>：双写迁移 → Canal 同步增量 → 灰度切读 → 切写。</li>
</ul>
<p><strong>索引高频考点</strong>：最左前缀、回表与覆盖索引、索引失效（函数&#x2F;隐式转换&#x2F;<code>!=</code>&#x2F;<code>LIKE &#39;%xx&#39;</code>）、深分页优化（<code>WHERE id &gt; last_id LIMIT 10</code>）。</p>
<hr>
<h3 id="4-Elasticsearch-架构"><a href="#4-Elasticsearch-架构" class="headerlink" title="4. Elasticsearch 架构"></a>4. Elasticsearch 架构</h3><p><strong>日增 1TB 场景设计</strong>：</p>
<ul>
<li><strong>冷热分离</strong>：Hot（SSD，最近 3-7 天）→ Warm&#x2F;Cold（HDD，历史数据）。</li>
<li><strong>分片</strong>：单分片 30-50GB，主分片创建后不可修改。</li>
<li><strong>Rollover</strong>：按时间&#x2F;大小自动滚动创建新索引。</li>
</ul>
<p><strong>查询优化</strong>：</p>
<ul>
<li>避免 <code>wildcard</code>，改用 <code>ngram</code> 分词器。</li>
<li>精确匹配用 <code>keyword</code> 类型。</li>
<li>深分页用 <code>search_after</code> 替代 <code>from + size</code>。</li>
</ul>
<hr>
<h3 id="5-ClickHouse"><a href="#5-ClickHouse" class="headerlink" title="5. ClickHouse"></a>5. ClickHouse</h3><ul>
<li><strong>适用</strong>：日志分析、报表、OLAP 大屏、用户行为分析。</li>
<li><strong>快的原因</strong>：列式存储 + 数据有序 + 向量化执行。</li>
<li><strong>不适合</strong>：高并发单行查询、频繁 UPDATE。</li>
</ul>
<hr>
<h2 id="七、安全"><a href="#七、安全" class="headerlink" title="七、安全"></a>七、安全</h2><h3 id="1-密码存储"><a href="#1-密码存储" class="headerlink" title="1. 密码存储"></a>1. 密码存储</h3><p><strong>问题</strong>：为什么只能重置密码，不能找回原密码？</p>
<p><strong>回答</strong>：密码存储的是 <code>bcrypt(password + salt)</code> 的<strong>不可逆哈希值</strong>。即使数据库泄露，攻击者也无法还原明文。</p>
<ul>
<li><strong>Salt（盐）</strong>：随机字符串，防彩虹表。即使两人密码相同，Hash 也不同。</li>
<li><strong>为什么用 bcrypt 而非 SHA256？</strong> bcrypt 是<strong>慢哈希</strong>，故意设计得慢（可调 cost 参数），暴力破解成本极高。SHA256 太快，GPU 每秒可算数十亿次。</li>
</ul>
<h3 id="2-常见攻防"><a href="#2-常见攻防" class="headerlink" title="2. 常见攻防"></a>2. 常见攻防</h3><table>
<thead>
<tr>
<th>攻击</th>
<th>防御</th>
</tr>
</thead>
<tbody><tr>
<td><strong>XSS</strong></td>
<td>输出转义、CSP 头、HttpOnly Cookie</td>
</tr>
<tr>
<td><strong>CSRF</strong></td>
<td>CSRF Token、SameSite Cookie</td>
</tr>
<tr>
<td><strong>SQL 注入</strong></td>
<td>预编译（<code>#&#123;&#125;</code> 而非 <code>$&#123;&#125;</code>）</td>
</tr>
<tr>
<td><strong>重放攻击</strong></td>
<td>签名 + 时间戳 + nonce + 设备指纹</td>
</tr>
</tbody></table>
<h3 id="3-HTTPS-握手"><a href="#3-HTTPS-握手" class="headerlink" title="3. HTTPS 握手"></a>3. HTTPS 握手</h3><ol>
<li>服务端下发证书（含公钥）。</li>
<li>客户端验证证书合法性。</li>
<li>客户端生成随机对称密钥，用公钥加密传给服务端。</li>
<li>后续通信使用对称加密。</li>
</ol>
<p><strong>一句话</strong>：非对称加密传密钥，对称加密传数据。</p>
<hr>
<h2 id="八、可观测性"><a href="#八、可观测性" class="headerlink" title="八、可观测性"></a>八、可观测性</h2><h3 id="1-三大支柱"><a href="#1-三大支柱" class="headerlink" title="1. 三大支柱"></a>1. 三大支柱</h3><table>
<thead>
<tr>
<th>支柱</th>
<th>工具</th>
<th>核心</th>
</tr>
</thead>
<tbody><tr>
<td><strong>Logging</strong></td>
<td>Filebeat → Kafka → ES → Kibana</td>
<td>结构化 JSON 日志，含 trace_id</td>
</tr>
<tr>
<td><strong>Metrics</strong></td>
<td>Prometheus + Grafana</td>
<td>黄金信号：延迟、流量、错误率、饱和度</td>
</tr>
<tr>
<td><strong>Tracing</strong></td>
<td>Jaeger &#x2F; Zipkin</td>
<td>TraceID 串联全链路</td>
</tr>
</tbody></table>
<h3 id="2-“接口突然变慢”排查套路"><a href="#2-“接口突然变慢”排查套路" class="headerlink" title="2. “接口突然变慢”排查套路"></a>2. “接口突然变慢”排查套路</h3><ol>
<li>**看链路 (Tracing)**：哪一跳耗时突增？</li>
<li>**看指标 (Metrics)**：DB CPU 飙升？MQ 积压？线程池满？</li>
<li>**看日志 (Logging)**：是否有异常堆栈？</li>
<li><strong>对比变更</strong>：最近是否上线&#x2F;扩容&#x2F;配置变更？</li>
</ol>
<p><strong>止血第一</strong>：先回滚或切流量，再定位根因。</p>
<hr>
<h2 id="九、云原生与弹性架构"><a href="#九、云原生与弹性架构" class="headerlink" title="九、云原生与弹性架构"></a>九、云原生与弹性架构</h2><h3 id="1-服务网格-Service-Mesh"><a href="#1-服务网格-Service-Mesh" class="headerlink" title="1. 服务网格 (Service Mesh)"></a>1. 服务网格 (Service Mesh)</h3><ul>
<li>Istio + Envoy Sidecar：实现熔断、限流、灰度发布，<strong>无代码侵入</strong>。</li>
</ul>
<h3 id="2-弹性伸缩"><a href="#2-弹性伸缩" class="headerlink" title="2. 弹性伸缩"></a>2. 弹性伸缩</h3><ul>
<li><strong>HPA</strong>：基于 CPU&#x2F;内存&#x2F;QPS 自动扩缩容。</li>
<li><strong>KEDA</strong>：基于事件驱动（如 MQ 积压量）扩缩容。</li>
</ul>
<h3 id="3-Serverless"><a href="#3-Serverless" class="headerlink" title="3. Serverless"></a>3. Serverless</h3><ul>
<li>适用：突发流量、定时任务、Webhook。</li>
<li>限制：冷启动延迟（秒级）、执行时长上限。</li>
</ul>
<hr>
<h2 id="十、计算机基础"><a href="#十、计算机基础" class="headerlink" title="十、计算机基础"></a>十、计算机基础</h2><h3 id="1-为什么-0-1-0-2-0-3？"><a href="#1-为什么-0-1-0-2-0-3？" class="headerlink" title="1. 为什么 0.1 + 0.2 !&#x3D; 0.3？"></a>1. 为什么 0.1 + 0.2 !&#x3D; 0.3？</h3><ul>
<li><strong>IEEE 754</strong>：二进制无法精确表示 0.1 和 0.2（无限循环小数），相加后精度丢失。</li>
<li><strong>0.1 + 0.1 &#x3D;&#x3D; 0.2</strong>：两次相同的舍入误差在低位恰好抵消。</li>
<li><strong>解决</strong>：金额计算必须用 <code>Decimal</code> 类型（定点数）或转为整数（分）计算。</li>
</ul>
<h3 id="2-TCP-三次握手为什么不能两次？"><a href="#2-TCP-三次握手为什么不能两次？" class="headerlink" title="2. TCP 三次握手为什么不能两次？"></a>2. TCP 三次握手为什么不能两次？</h3><ul>
<li>两次握手无法防止<strong>历史连接初始化</strong>：旧的 SYN 包延迟到达，服务端误建连接，浪费资源。</li>
<li>三次握手确保双方都确认对方的收发能力正常。</li>
</ul>
<hr>
<h2 id="十一、面试灵魂拷问"><a href="#十一、面试灵魂拷问" class="headerlink" title="十一、面试灵魂拷问"></a>十一、面试灵魂拷问</h2><p><strong>Q：系统瓶颈在哪？怎么优化？</strong><br>先定位（DB？Redis？MQ？外部接口？）→ 再给方案（索引&#x2F;分库&#x2F;缓存&#x2F;异步&#x2F;并行&#x2F;批量化）。</p>
<p><strong>Q：流量突增 10 倍怎么扛？</strong><br>限流（挡住超量）→ 扩容（水平加机器）→ 缓存（减少穿透）→ 异步（削峰填谷）→ 降级（保核心）。</p>
<p><strong>Q：线上故障排查流程？</strong><br>止血（回滚&#x2F;切流）→ 看监控 → 看日志 → 看调用链 → 定位根因 → 修复 → 复盘。</p>
<p><strong>Q：分布式系统最难的是什么？</strong><br>网络不可靠、时钟不一致、节点随时会挂。核心矛盾是 <strong>CAP 取舍</strong>：金融选 CP（强一致），互联网选 AP（最终一致）。</p>
<p><strong>Q：方案有什么副作用？</strong><br>面试加分项——主动说出 trade-off。例如：”虽然异步解耦了，但增加了链路追踪的复杂度和排查成本。”</p>
<hr>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a href="https://juejin.cn/column/7566818477114490926">大厂面试真题 - Fox爱分享</a></li>
</ul>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/%E9%9D%A2%E8%AF%95/" rel="tag"># 面试</a>
              <a href="/tags/%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/" rel="tag"># 系统设计</a>
              <a href="/tags/%E6%9E%B6%E6%9E%84/" rel="tag"># 架构</a>
              <a href="/tags/%E9%AB%98%E5%B9%B6%E5%8F%91/" rel="tag"># 高并发</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2025/06/20/system-design/15-clean-code/" rel="prev" title="代码：Pipeline Pattern + Service Layer 模式写复杂业务代码">
                  <i class="fa fa-angle-left"></i> 代码：Pipeline Pattern + Service Layer 模式写复杂业务代码
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2025/06/28/system-design/18-inventory-system-design/" rel="next" title="多品类统一库存系统设计：电商·虚拟商品·本地生活">
                  多品类统一库存系统设计：电商·虚拟商品·本地生活 <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2026</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">wxquare</span>
  </div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/sidebar.js"></script><script src="/js/next-boot.js"></script>

  

  <script class="next-config" data-name="mermaid" type="application/json">{"enable":true,"theme":{"light":"default","dark":"dark"},"js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mermaid/10.9.0/mermaid.min.js","integrity":"sha256-stuqcu2FrjYCXDOytWFA5SoUE/r3nkp6gTglzNSlavU="}}</script>
  <script src="/js/third-party/tags/mermaid.js"></script>





  





</body>
</html>
