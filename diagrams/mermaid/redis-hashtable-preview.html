<h1 id="Redis-Hashtable-结构可视化"><a href="#Redis-Hashtable-结构可视化" class="headerlink" title="Redis Hashtable 结构可视化"></a>Redis Hashtable 结构可视化</h1><h2 id="1-Dict-和-Hashtable-结构"><a href="#1-Dict-和-Hashtable-结构" class="headerlink" title="1. Dict 和 Hashtable 结构"></a>1. Dict 和 Hashtable 结构</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">graph TB</span><br><span class="line">    subgraph dict [&quot;dict 字典结构&quot;]</span><br><span class="line">        dictType[&quot;dictType&lt;br/&gt;类型特定函数&quot;]</span><br><span class="line">        rehashidx[&quot;rehashidx = -1&lt;br/&gt;未在rehash中&quot;]</span><br><span class="line">        </span><br><span class="line">        subgraph ht0 [&quot;ht[0] - 主哈希表&quot;]</span><br><span class="line">            ht0_table[&quot;table 指针数组&quot;]</span><br><span class="line">            ht0_size[&quot;size = 8&quot;]</span><br><span class="line">            ht0_used[&quot;used = 5&quot;]</span><br><span class="line">            </span><br><span class="line">            subgraph ht0_array [&quot;哈希表数组&quot;]</span><br><span class="line">                idx0[&quot;[0] NULL&quot;]</span><br><span class="line">                idx1[&quot;[1] → entry&quot;]</span><br><span class="line">                idx2[&quot;[2] → entry&quot;]</span><br><span class="line">                idx3[&quot;[3] NULL&quot;]</span><br><span class="line">                idx4[&quot;[4] → entry → entry&quot;]</span><br><span class="line">                idx5[&quot;[5] NULL&quot;]</span><br><span class="line">                idx6[&quot;[6] → entry&quot;]</span><br><span class="line">                idx7[&quot;[7] → entry&quot;]</span><br><span class="line">            end</span><br><span class="line">        end</span><br><span class="line">        </span><br><span class="line">        subgraph ht1 [&quot;ht[1] - Rehash用&quot;]</span><br><span class="line">            ht1_table[&quot;table = NULL&lt;br/&gt;未使用&quot;]</span><br><span class="line">        end</span><br><span class="line">    end</span><br><span class="line">    </span><br><span class="line">    subgraph entries [&quot;dictEntry 节点详情 - 拉链法&quot;]</span><br><span class="line">        entry1[&quot;dictEntry&lt;br/&gt;----&lt;br/&gt;key: &#x27;name&#x27;&lt;br/&gt;value: &#x27;iPhone&#x27;&lt;br/&gt;next: NULL&quot;]</span><br><span class="line">        </span><br><span class="line">        entry2[&quot;dictEntry&lt;br/&gt;----&lt;br/&gt;key: &#x27;price&#x27;&lt;br/&gt;value: &#x27;5999&#x27;&lt;br/&gt;next: →&quot;]</span><br><span class="line">        </span><br><span class="line">        entry3[&quot;dictEntry&lt;br/&gt;----&lt;br/&gt;key: &#x27;stock&#x27;&lt;br/&gt;value: &#x27;100&#x27;&lt;br/&gt;next: NULL&quot;]</span><br><span class="line">    end</span><br><span class="line">    </span><br><span class="line">    idx1 -.-&gt; entry1</span><br><span class="line">    idx4 -.-&gt; entry2</span><br><span class="line">    entry2 --&gt; entry3</span><br><span class="line">    </span><br><span class="line">    classDef dictStyle fill:#e1f5fe,stroke:#01579b,stroke-width:2px</span><br><span class="line">    classDef htStyle fill:#fff3e0,stroke:#e65100,stroke-width:2px</span><br><span class="line">    classDef entryStyle fill:#e8f5e9,stroke:#1b5e20,stroke-width:2px</span><br><span class="line">    classDef nullStyle fill:#f5f5f5,stroke:#9e9e9e,stroke-width:1px,stroke-dasharray: 5 5</span><br><span class="line">    </span><br><span class="line">    class dict,dictType,rehashidx dictStyle</span><br><span class="line">    class ht0,ht1,ht0_table,ht0_size,ht0_used,ht1_table htStyle</span><br><span class="line">    class entry1,entry2,entry3 entryStyle</span><br><span class="line">    class idx0,idx3,idx5 nullStyle</span><br></pre></td></tr></table></figure>

<h2 id="2-渐进式-Rehash-过程"><a href="#2-渐进式-Rehash-过程" class="headerlink" title="2. 渐进式 Rehash 过程"></a>2. 渐进式 Rehash 过程</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">graph TB</span><br><span class="line">    subgraph phase1 [&quot;阶段1: 正常状态 - 负载因子 = 5/8 = 0.625&quot;]</span><br><span class="line">        dict1[&quot;dict&lt;br/&gt;rehashidx = -1&quot;]</span><br><span class="line">        ht0_1[&quot;ht[0]&lt;br/&gt;size=8, used=5&quot;]</span><br><span class="line">        ht1_1[&quot;ht[1]&lt;br/&gt;NULL 未使用&quot;]</span><br><span class="line">        </span><br><span class="line">        dict1 --&gt; ht0_1</span><br><span class="line">        dict1 --&gt; ht1_1</span><br><span class="line">    end</span><br><span class="line">    </span><br><span class="line">    subgraph phase2 [&quot;阶段2: 触发扩容 - 负载因子 &gt;= 1&quot;]</span><br><span class="line">        dict2[&quot;dict&lt;br/&gt;rehashidx = -1 → 0&quot;]</span><br><span class="line">        ht0_2[&quot;ht[0]&lt;br/&gt;size=8, used=6&lt;br/&gt;开始迁移&quot;]</span><br><span class="line">        ht1_2[&quot;ht[1]&lt;br/&gt;size=16, used=0&lt;br/&gt;新分配空间&quot;]</span><br><span class="line">        </span><br><span class="line">        dict2 --&gt; ht0_2</span><br><span class="line">        dict2 --&gt; ht1_2</span><br><span class="line">        </span><br><span class="line">        note1[&quot;分配 ht[1] 空间&lt;br/&gt;size = 下一个 2^n&lt;br/&gt;= 16&quot;]</span><br><span class="line">    end</span><br><span class="line">    </span><br><span class="line">    subgraph phase3 [&quot;阶段3: 渐进式 Rehash - 每次操作迁移一个桶&quot;]</span><br><span class="line">        dict3[&quot;dict&lt;br/&gt;rehashidx = 0 → 1 → 2...&quot;]</span><br><span class="line">        </span><br><span class="line">        subgraph migration [&quot;迁移过程&quot;]</span><br><span class="line">            ht0_3[&quot;ht[0]&lt;br/&gt;[0]已空 [1]已空&lt;br/&gt;[2]待迁移&lt;br/&gt;used=4&quot;]</span><br><span class="line">            arrow[&quot;逐个桶迁移 →&quot;]</span><br><span class="line">            ht1_3[&quot;ht[1]&lt;br/&gt;接收数据&lt;br/&gt;used=2&quot;]</span><br><span class="line">        end</span><br><span class="line">        </span><br><span class="line">        dict3 --&gt; ht0_3</span><br><span class="line">        dict3 --&gt; ht1_3</span><br><span class="line">        </span><br><span class="line">        note2[&quot;每次操作时&lt;br/&gt;顺带迁移&lt;br/&gt;rehashidx 位置的桶&quot;]</span><br><span class="line">        note3[&quot;新增操作&lt;br/&gt;直接写 ht[1]&quot;]</span><br><span class="line">        note4[&quot;查询操作&lt;br/&gt;先查 ht[0]&lt;br/&gt;再查 ht[1]&quot;]</span><br><span class="line">    end</span><br><span class="line">    </span><br><span class="line">    subgraph phase4 [&quot;阶段4: 完成 Rehash&quot;]</span><br><span class="line">        dict4[&quot;dict&lt;br/&gt;rehashidx = -1&quot;]</span><br><span class="line">        ht0_4[&quot;ht[0]&lt;br/&gt;← ht[1] 替换&lt;br/&gt;size=16, used=6&quot;]</span><br><span class="line">        ht1_4[&quot;ht[1]&lt;br/&gt;清空&lt;br/&gt;准备下次使用&quot;]</span><br><span class="line">        </span><br><span class="line">        dict4 --&gt; ht0_4</span><br><span class="line">        dict4 --&gt; ht1_4</span><br><span class="line">        </span><br><span class="line">        note5[&quot;释放旧 ht[0]&lt;br/&gt;ht[1] 成为新 ht[0]&lt;br/&gt;创建空白 ht[1]&quot;]</span><br><span class="line">    end</span><br><span class="line">    </span><br><span class="line">    phase1 ==&gt; phase2</span><br><span class="line">    phase2 ==&gt; phase3</span><br><span class="line">    phase3 ==&gt; phase4</span><br><span class="line">    </span><br><span class="line">    subgraph legend [&quot;哈希函数与索引计算&quot;]</span><br><span class="line">        hash_func[&quot;hash = MurmurHash2 key&quot;]</span><br><span class="line">        index_calc[&quot;index = hash &amp; sizemask&lt;br/&gt;sizemask = size - 1&lt;br/&gt;例: hash &amp; 15 = hash % 16&quot;]</span><br><span class="line">        </span><br><span class="line">        hash_func --&gt; index_calc</span><br><span class="line">    end</span><br><span class="line">    </span><br><span class="line">    classDef normalStyle fill:#e8f5e9,stroke:#1b5e20,stroke-width:2px</span><br><span class="line">    classDef rehashStyle fill:#fff3e0,stroke:#e65100,stroke-width:2px</span><br><span class="line">    classDef completeStyle fill:#e1f5fe,stroke:#01579b,stroke-width:2px</span><br><span class="line">    classDef noteStyle fill:#fce4ec,stroke:#880e4f,stroke-width:1px</span><br><span class="line">    </span><br><span class="line">    class dict1,ht0_1,ht1_1 normalStyle</span><br><span class="line">    class dict2,ht0_2,ht1_2,dict3,ht0_3,ht1_3 rehashStyle</span><br><span class="line">    class dict4,ht0_4,ht1_4 completeStyle</span><br><span class="line">    class note1,note2,note3,note4,note5 noteStyle</span><br></pre></td></tr></table></figure>

<h2 id="3-ziplist-vs-hashtable-编码对比"><a href="#3-ziplist-vs-hashtable-编码对比" class="headerlink" title="3. ziplist vs hashtable 编码对比"></a>3. ziplist vs hashtable 编码对比</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line">graph TB</span><br><span class="line">    subgraph decision [&quot;Redis Hash 编码选择&quot;]</span><br><span class="line">        start[&quot;创建 Hash&quot;]</span><br><span class="line">        </span><br><span class="line">        check1&#123;&quot;元素个数 &lt;= 512&lt;br/&gt;且&lt;br/&gt;单个value &lt;= 64字节?&quot;&#125;</span><br><span class="line">        </span><br><span class="line">        ziplist[&quot;使用 ziplist&lt;br/&gt;压缩列表编码&quot;]</span><br><span class="line">        hashtable[&quot;使用 hashtable&lt;br/&gt;哈希表编码&quot;]</span><br><span class="line">        </span><br><span class="line">        start --&gt; check1</span><br><span class="line">        check1 --&gt;|是| ziplist</span><br><span class="line">        check1 --&gt;|否| hashtable</span><br><span class="line">        </span><br><span class="line">        trigger[&quot;后续操作触发转换&quot;]</span><br><span class="line">        convert[&quot;ziplist → hashtable&lt;br/&gt;不可逆转换&quot;]</span><br><span class="line">        </span><br><span class="line">        ziplist --&gt; trigger</span><br><span class="line">        trigger --&gt;|超过阈值| convert</span><br><span class="line">        convert --&gt; hashtable</span><br><span class="line">    end</span><br><span class="line">    </span><br><span class="line">    subgraph ziplist_struct [&quot;ziplist 结构 - 紧凑存储&quot;]</span><br><span class="line">        zl_header[&quot;zlbytes&lt;br/&gt;总字节数&quot;]</span><br><span class="line">        zl_tail[&quot;zltail&lt;br/&gt;尾节点偏移&quot;]</span><br><span class="line">        zl_len[&quot;zllen&lt;br/&gt;节点数量&quot;]</span><br><span class="line">        </span><br><span class="line">        zl_entry1[&quot;field1&lt;br/&gt;&#x27;name&#x27;&quot;]</span><br><span class="line">        zl_value1[&quot;value1&lt;br/&gt;&#x27;iPhone&#x27;&quot;]</span><br><span class="line">        zl_entry2[&quot;field2&lt;br/&gt;&#x27;price&#x27;&quot;]</span><br><span class="line">        zl_value2[&quot;value2&lt;br/&gt;&#x27;5999&#x27;&quot;]</span><br><span class="line">        zl_entry3[&quot;field3&lt;br/&gt;&#x27;stock&#x27;&quot;]</span><br><span class="line">        zl_value3[&quot;value3&lt;br/&gt;&#x27;100&#x27;&quot;]</span><br><span class="line">        </span><br><span class="line">        zl_end[&quot;zlend&lt;br/&gt;0xFF&quot;]</span><br><span class="line">        </span><br><span class="line">        zl_header --&gt; zl_tail --&gt; zl_len</span><br><span class="line">        zl_len --&gt; zl_entry1 --&gt; zl_value1 --&gt; zl_entry2</span><br><span class="line">        zl_value2 --&gt; zl_entry3 --&gt; zl_value3 --&gt; zl_end</span><br><span class="line">    end</span><br><span class="line">    </span><br><span class="line">    subgraph ht_struct [&quot;hashtable 结构 - 快速索引&quot;]</span><br><span class="line">        ht_table[&quot;dictEntry** table&lt;br/&gt;指针数组&quot;]</span><br><span class="line">        </span><br><span class="line">        ht_idx0[&quot;[0] NULL&quot;]</span><br><span class="line">        ht_idx1[&quot;[1] →&quot;]</span><br><span class="line">        ht_idx2[&quot;[2] →&quot;]</span><br><span class="line">        ht_idx3[&quot;[3] NULL&quot;]</span><br><span class="line">        </span><br><span class="line">        ht_entry1[&quot;key: &#x27;name&#x27;&lt;br/&gt;val: &#x27;iPhone&#x27;&lt;br/&gt;next: NULL&quot;]</span><br><span class="line">        ht_entry2[&quot;key: &#x27;price&#x27;&lt;br/&gt;val: &#x27;5999&#x27;&lt;br/&gt;next: →&quot;]</span><br><span class="line">        ht_entry3[&quot;key: &#x27;stock&#x27;&lt;br/&gt;val: &#x27;100&#x27;&lt;br/&gt;next: NULL&quot;]</span><br><span class="line">        </span><br><span class="line">        ht_table --&gt; ht_idx0</span><br><span class="line">        ht_table --&gt; ht_idx1</span><br><span class="line">        ht_table --&gt; ht_idx2</span><br><span class="line">        ht_table --&gt; ht_idx3</span><br><span class="line">        </span><br><span class="line">        ht_idx1 --&gt; ht_entry1</span><br><span class="line">        ht_idx2 --&gt; ht_entry2</span><br><span class="line">        ht_entry2 --&gt; ht_entry3</span><br><span class="line">    end</span><br><span class="line">    </span><br><span class="line">    subgraph comparison [&quot;性能对比&quot;]</span><br><span class="line">        direction LR</span><br><span class="line">        </span><br><span class="line">        subgraph zl_perf [&quot;ziplist&quot;]</span><br><span class="line">            zl_get[&quot;HGET: O(n)&lt;br/&gt;顺序遍历&quot;]</span><br><span class="line">            zl_set[&quot;HSET: O(n)&lt;br/&gt;查找+插入&quot;]</span><br><span class="line">            zl_mem[&quot;内存: 低&lt;br/&gt;连续紧凑&quot;]</span><br><span class="line">            zl_cache[&quot;CPU缓存: 友好&lt;br/&gt;连续访问&quot;]</span><br><span class="line">        end</span><br><span class="line">        </span><br><span class="line">        subgraph ht_perf [&quot;hashtable&quot;]</span><br><span class="line">            ht_get[&quot;HGET: O(1)&lt;br/&gt;哈希定位&quot;]</span><br><span class="line">            ht_set[&quot;HSET: O(1)&lt;br/&gt;直接插入&quot;]</span><br><span class="line">            ht_mem[&quot;内存: 高&lt;br/&gt;指针开销&quot;]</span><br><span class="line">            ht_cache[&quot;CPU缓存: 一般&lt;br/&gt;随机访问&quot;]</span><br><span class="line">        end</span><br><span class="line">    end</span><br><span class="line">    </span><br><span class="line">    subgraph config [&quot;配置参数 redis.conf&quot;]</span><br><span class="line">        param1[&quot;hash-max-ziplist-entries 512&lt;br/&gt;最大元素个数&quot;]</span><br><span class="line">        param2[&quot;hash-max-ziplist-value 64&lt;br/&gt;最大值长度 字节&quot;]</span><br><span class="line">        </span><br><span class="line">        advice[&quot;建议:&lt;br/&gt;小对象用 ziplist 省内存&lt;br/&gt;大对象用 hashtable 保性能&quot;]</span><br><span class="line">    end</span><br><span class="line">    </span><br><span class="line">    classDef zlStyle fill:#e8f5e9,stroke:#1b5e20,stroke-width:2px</span><br><span class="line">    classDef htStyle fill:#e1f5fe,stroke:#01579b,stroke-width:2px</span><br><span class="line">    classDef decisionStyle fill:#fff3e0,stroke:#e65100,stroke-width:2px</span><br><span class="line">    classDef configStyle fill:#fce4ec,stroke:#880e4f,stroke-width:2px</span><br><span class="line">    </span><br><span class="line">    class ziplist,zl_header,zl_entry1,zl_value1,zl_entry2,zl_value2,zl_entry3,zl_value3,zl_end,zl_get,zl_set,zl_mem,zl_cache zlStyle</span><br><span class="line">    class hashtable,ht_table,ht_entry1,ht_entry2,ht_entry3,ht_get,ht_set,ht_mem,ht_cache htStyle</span><br><span class="line">    class start,check1,trigger,convert decisionStyle</span><br><span class="line">    class param1,param2,advice configStyle</span><br></pre></td></tr></table></figure>

