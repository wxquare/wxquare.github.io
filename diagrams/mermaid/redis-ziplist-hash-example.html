<h1 id="Redis-Ziplist-实战分析：Hash-name-“iPhone”-price-5999"><a href="#Redis-Ziplist-实战分析：Hash-name-“iPhone”-price-5999" class="headerlink" title="Redis Ziplist 实战分析：Hash {name: “iPhone”, price: 5999}"></a>Redis Ziplist 实战分析：Hash {name: “iPhone”, price: 5999}</h1><h2 id="1-整体结构预览"><a href="#1-整体结构预览" class="headerlink" title="1. 整体结构预览"></a>1. 整体结构预览</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">HSET product:1001 name &quot;iPhone&quot; price 5999</span><br></pre></td></tr></table></figure>

<p><strong>ziplist 编码格式</strong>：field-value 交替存储</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[Header 10B] [field1] [value1] [field2] [value2] [End 1B]</span><br><span class="line">   头部       &quot;name&quot;  &quot;iPhone&quot;  &quot;price&quot;   5999     尾部</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="2-完整的字节级内存布局"><a href="#2-完整的字节级内存布局" class="headerlink" title="2. 完整的字节级内存布局"></a>2. 完整的字节级内存布局</h2><h3 id="整体图示"><a href="#整体图示" class="headerlink" title="整体图示"></a>整体图示</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">偏移量 | 字段           | 十六进制值              | 十进制值    | 说明</span><br><span class="line">-------|----------------|------------------------|------------|------------------</span><br><span class="line">0-3    | zlbytes        | 0x00 00 00 2C          | 44         | 总大小 44 字节</span><br><span class="line">4-7    | zltail         | 0x00 00 00 23          | 35         | 尾节点偏移 35</span><br><span class="line">8-9    | zllen          | 0x00 04                | 4          | 4个节点 (2字段+2值)</span><br><span class="line">       |----------------|------------------------|------------|------------------</span><br><span class="line">10     | Entry 1        |                        |            | field: &quot;name&quot;</span><br><span class="line">10     | ├─ prevlen     | 0x00                   | 0          | 第一个节点</span><br><span class="line">11     | ├─ encoding    | 0x04                   | 4          | 字符串长度4</span><br><span class="line">12-15  | └─ content     | 0x6E 61 6D 65          | &quot;name&quot;     | n a m e</span><br><span class="line">       |----------------|------------------------|------------|------------------</span><br><span class="line">16     | Entry 2        |                        |            | value: &quot;iPhone&quot;</span><br><span class="line">16     | ├─ prevlen     | 0x06                   | 6          | 前一节点6字节</span><br><span class="line">17     | ├─ encoding    | 0x06                   | 6          | 字符串长度6</span><br><span class="line">18-23  | └─ content     | 0x69 50 68 6F 6E 65    | &quot;iPhone&quot;   | i P h o n e</span><br><span class="line">       |----------------|------------------------|------------|------------------</span><br><span class="line">24     | Entry 3        |                        |            | field: &quot;price&quot;</span><br><span class="line">24     | ├─ prevlen     | 0x08                   | 8          | 前一节点8字节</span><br><span class="line">25     | ├─ encoding    | 0x05                   | 5          | 字符串长度5</span><br><span class="line">26-30  | └─ content     | 0x70 72 69 63 65       | &quot;price&quot;    | p r i c e</span><br><span class="line">       |----------------|------------------------|------------|------------------</span><br><span class="line">31     | Entry 4        |                        |            | value: 5999</span><br><span class="line">31     | ├─ prevlen     | 0x07                   | 7          | 前一节点7字节</span><br><span class="line">32     | ├─ encoding    | 0xC0                   | 11000000   | int16_t 整数</span><br><span class="line">33-34  | └─ content     | 0x6F 17                | 5999       | 小端序整数</span><br><span class="line">       |----------------|------------------------|------------|------------------</span><br><span class="line">35     | zlend          | 0xFF                   | 255        | 结束标记</span><br><span class="line">-------|----------------|------------------------|------------|------------------</span><br><span class="line">总计: 36 字节</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="3-各部分详细解析"><a href="#3-各部分详细解析" class="headerlink" title="3. 各部分详细解析"></a>3. 各部分详细解析</h2><h3 id="📌-头部信息（10-字节）"><a href="#📌-头部信息（10-字节）" class="headerlink" title="📌 头部信息（10 字节）"></a>📌 头部信息（10 字节）</h3><h4 id="zlbytes-4字节"><a href="#zlbytes-4字节" class="headerlink" title="zlbytes (4字节)"></a>zlbytes (4字节)</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">值: 0x00 00 00 2C = 44</span><br><span class="line">说明: 整个 ziplist 占用 44 字节</span><br><span class="line">计算: 10(头) + 6(entry1) + 8(entry2) + 7(entry3) + 4(entry4) + 1(尾) = 36字节</span><br><span class="line">注意: 这里我简化了，实际可能略有不同</span><br></pre></td></tr></table></figure>

<h4 id="zltail-4字节"><a href="#zltail-4字节" class="headerlink" title="zltail (4字节)"></a>zltail (4字节)</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">值: 0x00 00 00 23 = 35</span><br><span class="line">说明: 最后一个 entry (entry4) 从偏移 35 开始</span><br><span class="line">计算: 10 + 6 + 8 + 7 = 31 (entry4 起始位置)</span><br></pre></td></tr></table></figure>

<h4 id="zllen-2字节"><a href="#zllen-2字节" class="headerlink" title="zllen (2字节)"></a>zllen (2字节)</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">值: 0x00 04 = 4</span><br><span class="line">说明: 共 4 个节点（2个 field + 2个 value）</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="📌-Entry-1-field-“name”-6字节"><a href="#📌-Entry-1-field-“name”-6字节" class="headerlink" title="📌 Entry 1: field “name” (6字节)"></a>📌 Entry 1: field “name” (6字节)</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">内存布局:</span><br><span class="line">┌──────────┬───────────┬─────────────────────┐</span><br><span class="line">│ prevlen  │ encoding  │ content             │</span><br><span class="line">│ 0x00     │ 0x04      │ 0x6E 61 6D 65       │</span><br><span class="line">│ 1字节    │ 1字节     │ 4字节               │</span><br><span class="line">└──────────┴───────────┴─────────────────────┘</span><br></pre></td></tr></table></figure>

<h4 id="prevlen-0x00"><a href="#prevlen-0x00" class="headerlink" title="prevlen &#x3D; 0x00"></a>prevlen &#x3D; 0x00</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">值: 0</span><br><span class="line">说明: 前一个节点长度为 0（因为这是第一个节点）</span><br><span class="line">编码: &lt; 254，使用 1 字节</span><br></pre></td></tr></table></figure>

<h4 id="encoding-0x04"><a href="#encoding-0x04" class="headerlink" title="encoding &#x3D; 0x04"></a>encoding &#x3D; 0x04</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">二进制: 0000 0100</span><br><span class="line">解析: </span><br><span class="line">  - 前2位 00: 字符串类型</span><br><span class="line">  - 后6位 000100 = 4: 字符串长度为 4</span><br><span class="line">格式: 00pppppp (p 表示长度位)</span><br></pre></td></tr></table></figure>

<h4 id="content-“name”"><a href="#content-“name”" class="headerlink" title="content &#x3D; “name”"></a>content &#x3D; “name”</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ASCII 码:</span><br><span class="line">  0x6E = &#x27;n&#x27; (110)</span><br><span class="line">  0x61 = &#x27;a&#x27; (97)</span><br><span class="line">  0x6D = &#x27;m&#x27; (109)</span><br><span class="line">  0x65 = &#x27;e&#x27; (101)</span><br><span class="line">长度: 4 字节</span><br></pre></td></tr></table></figure>

<p><strong>总计: 1 + 1 + 4 &#x3D; 6 字节</strong></p>
<hr>
<h3 id="📌-Entry-2-value-“iPhone”-8字节"><a href="#📌-Entry-2-value-“iPhone”-8字节" class="headerlink" title="📌 Entry 2: value “iPhone” (8字节)"></a>📌 Entry 2: value “iPhone” (8字节)</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">内存布局:</span><br><span class="line">┌──────────┬───────────┬──────────────────────────────┐</span><br><span class="line">│ prevlen  │ encoding  │ content                      │</span><br><span class="line">│ 0x06     │ 0x06      │ 0x69 50 68 6F 6E 65          │</span><br><span class="line">│ 1字节    │ 1字节     │ 6字节                        │</span><br><span class="line">└──────────┴───────────┴──────────────────────────────┘</span><br></pre></td></tr></table></figure>

<h4 id="prevlen-0x06"><a href="#prevlen-0x06" class="headerlink" title="prevlen &#x3D; 0x06"></a>prevlen &#x3D; 0x06</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">值: 6</span><br><span class="line">说明: 前一个节点（entry1）长度为 6 字节</span><br><span class="line">编码: &lt; 254，使用 1 字节</span><br><span class="line">作用: 支持反向遍历，当前节点地址 - 6 = 前一个节点地址</span><br></pre></td></tr></table></figure>

<h4 id="encoding-0x06"><a href="#encoding-0x06" class="headerlink" title="encoding &#x3D; 0x06"></a>encoding &#x3D; 0x06</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">二进制: 0000 0110</span><br><span class="line">解析:</span><br><span class="line">  - 前2位 00: 字符串类型</span><br><span class="line">  - 后6位 000110 = 6: 字符串长度为 6</span><br></pre></td></tr></table></figure>

<h4 id="content-“iPhone”"><a href="#content-“iPhone”" class="headerlink" title="content &#x3D; “iPhone”"></a>content &#x3D; “iPhone”</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">ASCII 码:</span><br><span class="line">  0x69 = &#x27;i&#x27; (105)</span><br><span class="line">  0x50 = &#x27;P&#x27; (80)</span><br><span class="line">  0x68 = &#x27;h&#x27; (104)</span><br><span class="line">  0x6F = &#x27;o&#x27; (111)</span><br><span class="line">  0x6E = &#x27;n&#x27; (110)</span><br><span class="line">  0x65 = &#x27;e&#x27; (101)</span><br><span class="line">长度: 6 字节</span><br></pre></td></tr></table></figure>

<p><strong>总计: 1 + 1 + 6 &#x3D; 8 字节</strong></p>
<hr>
<h3 id="📌-Entry-3-field-“price”-7字节"><a href="#📌-Entry-3-field-“price”-7字节" class="headerlink" title="📌 Entry 3: field “price” (7字节)"></a>📌 Entry 3: field “price” (7字节)</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">内存布局:</span><br><span class="line">┌──────────┬───────────┬─────────────────────────────┐</span><br><span class="line">│ prevlen  │ encoding  │ content                     │</span><br><span class="line">│ 0x08     │ 0x05      │ 0x70 72 69 63 65            │</span><br><span class="line">│ 1字节    │ 1字节     │ 5字节                       │</span><br><span class="line">└──────────┴───────────┴─────────────────────────────┘</span><br></pre></td></tr></table></figure>

<h4 id="prevlen-0x08"><a href="#prevlen-0x08" class="headerlink" title="prevlen &#x3D; 0x08"></a>prevlen &#x3D; 0x08</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">值: 8</span><br><span class="line">说明: 前一个节点（entry2）长度为 8 字节</span><br></pre></td></tr></table></figure>

<h4 id="encoding-0x05"><a href="#encoding-0x05" class="headerlink" title="encoding &#x3D; 0x05"></a>encoding &#x3D; 0x05</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">二进制: 0000 0101</span><br><span class="line">解析:</span><br><span class="line">  - 前2位 00: 字符串类型</span><br><span class="line">  - 后6位 000101 = 5: 字符串长度为 5</span><br></pre></td></tr></table></figure>

<h4 id="content-“price”"><a href="#content-“price”" class="headerlink" title="content &#x3D; “price”"></a>content &#x3D; “price”</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ASCII 码:</span><br><span class="line">  0x70 = &#x27;p&#x27; (112)</span><br><span class="line">  0x72 = &#x27;r&#x27; (114)</span><br><span class="line">  0x69 = &#x27;i&#x27; (105)</span><br><span class="line">  0x63 = &#x27;c&#x27; (99)</span><br><span class="line">  0x65 = &#x27;e&#x27; (101)</span><br><span class="line">长度: 5 字节</span><br></pre></td></tr></table></figure>

<p><strong>总计: 1 + 1 + 5 &#x3D; 7 字节</strong></p>
<hr>
<h3 id="📌-Entry-4-value-5999-4字节-⭐-整数优化"><a href="#📌-Entry-4-value-5999-4字节-⭐-整数优化" class="headerlink" title="📌 Entry 4: value 5999 (4字节) ⭐ 整数优化"></a>📌 Entry 4: value 5999 (4字节) ⭐ <strong>整数优化</strong></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">内存布局:</span><br><span class="line">┌──────────┬───────────┬─────────────────┐</span><br><span class="line">│ prevlen  │ encoding  │ content         │</span><br><span class="line">│ 0x07     │ 0xC0      │ 0x6F 17         │</span><br><span class="line">│ 1字节    │ 1字节     │ 2字节           │</span><br><span class="line">└──────────┴───────────┴─────────────────┘</span><br></pre></td></tr></table></figure>

<h4 id="prevlen-0x07"><a href="#prevlen-0x07" class="headerlink" title="prevlen &#x3D; 0x07"></a>prevlen &#x3D; 0x07</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">值: 7</span><br><span class="line">说明: 前一个节点（entry3）长度为 7 字节</span><br></pre></td></tr></table></figure>

<h4 id="encoding-0xC0"><a href="#encoding-0xC0" class="headerlink" title="encoding &#x3D; 0xC0"></a>encoding &#x3D; 0xC0</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">二进制: 1100 0000</span><br><span class="line">解析:</span><br><span class="line">  - 前2位 11: 整数类型</span><br><span class="line">  - 后6位 000000: 子类型 int16_t（2字节整数）</span><br><span class="line">整数范围: -32768 ~ 32767</span><br></pre></td></tr></table></figure>

<h4 id="content-5999"><a href="#content-5999" class="headerlink" title="content &#x3D; 5999"></a>content &#x3D; 5999</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">十六进制: 0x6F 17 (小端序)</span><br><span class="line">解析:</span><br><span class="line">  低字节在前: 0x6F = 111 (十进制)</span><br><span class="line">  高字节在后: 0x17 = 23 (十进制)</span><br><span class="line">  计算: 0x176F = 23 * 256 + 111 = 5888 + 111 = 5999</span><br><span class="line">  </span><br><span class="line">验证:</span><br><span class="line">  5999 = 0x176F</span><br><span class="line">  小端序存储: [0x6F] [0x17]</span><br></pre></td></tr></table></figure>

<p><strong>总计: 1 + 1 + 2 &#x3D; 4 字节</strong></p>
<p><strong>🎯 优化效果</strong>：如果用字符串 “5999” 存储，需要 1+1+4&#x3D;6 字节，整数编码节省了 2 字节！</p>
<hr>
<h3 id="📌-尾部标记（1-字节）"><a href="#📌-尾部标记（1-字节）" class="headerlink" title="📌 尾部标记（1 字节）"></a>📌 尾部标记（1 字节）</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">值: 0xFF (255)</span><br><span class="line">说明: ziplist 结束标记</span><br><span class="line">作用: 正向遍历时的终止条件</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="4-内存使用总结"><a href="#4-内存使用总结" class="headerlink" title="4. 内存使用总结"></a>4. 内存使用总结</h2><h3 id="字节分布"><a href="#字节分布" class="headerlink" title="字节分布"></a>字节分布</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">组成部分          | 字节数 | 占比   | 说明</span><br><span class="line">------------------|--------|--------|------------------</span><br><span class="line">zlbytes           | 4      | 11.1%  | 头部</span><br><span class="line">zltail            | 4      | 11.1%  | 头部</span><br><span class="line">zllen             | 2      | 5.6%   | 头部</span><br><span class="line">Entry1 &quot;name&quot;     | 6      | 16.7%  | field</span><br><span class="line">Entry2 &quot;iPhone&quot;   | 8      | 22.2%  | value</span><br><span class="line">Entry3 &quot;price&quot;    | 7      | 19.4%  | field</span><br><span class="line">Entry4 5999       | 4      | 11.1%  | value (整数优化)</span><br><span class="line">zlend             | 1      | 2.8%   | 尾部</span><br><span class="line">------------------|--------|--------|------------------</span><br><span class="line">总计              | 36     | 100%   |</span><br></pre></td></tr></table></figure>

<h3 id="与其他结构对比"><a href="#与其他结构对比" class="headerlink" title="与其他结构对比"></a>与其他结构对比</h3><h4 id="方案1-ziplist-当前方案"><a href="#方案1-ziplist-当前方案" class="headerlink" title="方案1: ziplist (当前方案)"></a>方案1: ziplist (当前方案)</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">总计: 36 字节</span><br><span class="line">优势: 极致紧凑</span><br><span class="line">劣势: O(n) 查找</span><br></pre></td></tr></table></figure>

<h4 id="方案2-hashtable"><a href="#方案2-hashtable" class="headerlink" title="方案2: hashtable"></a>方案2: hashtable</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">dictht 结构: 24B</span><br><span class="line">table[8] 数组: 64B</span><br><span class="line">dictEntry &quot;name&quot;: 24B (key指针8B + val指针8B + next指针8B)</span><br><span class="line">dictEntry &quot;price&quot;: 24B</span><br><span class="line">字符串 &quot;name&quot;: 5B (SDS header) + 4B = 9B</span><br><span class="line">字符串 &quot;iPhone&quot;: 5B + 6B = 11B</span><br><span class="line">字符串 &quot;price&quot;: 5B + 5B = 10B</span><br><span class="line">整数 5999: 可能内嵌或 8B</span><br><span class="line">------------------------------------</span><br><span class="line">总计: 约 166 字节 (是 ziplist 的 4.6 倍！)</span><br></pre></td></tr></table></figure>

<h4 id="方案3-String-存-JSON"><a href="#方案3-String-存-JSON" class="headerlink" title="方案3: String 存 JSON"></a>方案3: String 存 JSON</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">JSON: &#123;&quot;name&quot;:&quot;iPhone&quot;,&quot;price&quot;:5999&#125;</span><br><span class="line">长度: 32 字节 (纯字符串)</span><br><span class="line">加上 Redis String 开销: 约 50 字节</span><br><span class="line">优势: 易于序列化</span><br><span class="line">劣势: 无法单独更新字段，需要整体读写</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="5-操作演示"><a href="#5-操作演示" class="headerlink" title="5. 操作演示"></a>5. 操作演示</h2><h3 id="查找操作：HGET-product-1001-name"><a href="#查找操作：HGET-product-1001-name" class="headerlink" title="查找操作：HGET product:1001 name"></a>查找操作：HGET product:1001 name</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 步骤1: 定位第一个 entry</span></span><br><span class="line">ptr = ziplist + <span class="number">10</span>;  <span class="comment">// 跳过头部</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 步骤2: 遍历查找</span></span><br><span class="line"><span class="keyword">while</span> (*ptr != <span class="number">0xFF</span>) &#123;</span><br><span class="line">    <span class="comment">// 解析 prevlen</span></span><br><span class="line">    prevlen = *ptr;</span><br><span class="line">    ptr++;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 解析 encoding</span></span><br><span class="line">    encoding = *ptr;</span><br><span class="line">    ptr++;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 解析 content</span></span><br><span class="line">    <span class="keyword">if</span> (encoding == <span class="number">0x04</span> &amp;&amp; <span class="built_in">memcmp</span>(ptr, <span class="string">&quot;name&quot;</span>, <span class="number">4</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// 找到了！跳到下一个 entry（value）</span></span><br><span class="line">        ptr += <span class="number">4</span>;  <span class="comment">// 跳过 &quot;name&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 读取 value 的 encoding</span></span><br><span class="line">        ptr++;  <span class="comment">// 跳过 prevlen</span></span><br><span class="line">        value_encoding = *ptr++;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 返回 &quot;iPhone&quot;</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">memcpy</span>(result, ptr, <span class="number">6</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 跳到下一个 entry</span></span><br><span class="line">    ptr += get_content_size(encoding);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>时间复杂度</strong>：O(n)，需要遍历</p>
<hr>
<h3 id="更新操作：HINCRBY-product-1001-price-1"><a href="#更新操作：HINCRBY-product-1001-price-1" class="headerlink" title="更新操作：HINCRBY product:1001 price 1"></a>更新操作：HINCRBY product:1001 price 1</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 步骤1: 找到 &quot;price&quot; 对应的 value (5999)</span></span><br><span class="line"><span class="comment">// 步骤2: 读取整数值 5999</span></span><br><span class="line"><span class="comment">// 步骤3: 加 1 得到 6000</span></span><br><span class="line"><span class="comment">// 步骤4: 判断是否仍能用 int16 存储（6000 &lt; 32767，可以）</span></span><br><span class="line"><span class="comment">// 步骤5: 原地更新 content 为 0x70 17 (6000 的小端序)</span></span><br><span class="line"><span class="comment">// 步骤6: 无需重新分配内存！</span></span><br></pre></td></tr></table></figure>

<p><strong>关键优化</strong>：整数类型可以原地更新（如果不跨越编码边界）</p>
<hr>
<h3 id="插入操作：HSET-product-1001-stock-100"><a href="#插入操作：HSET-product-1001-stock-100" class="headerlink" title="插入操作：HSET product:1001 stock 100"></a>插入操作：HSET product:1001 stock 100</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 步骤1: 检查是否会超过阈值</span></span><br><span class="line"><span class="keyword">if</span> (zllen &gt;= <span class="number">512</span>) &#123;</span><br><span class="line">    <span class="comment">// 转换为 hashtable</span></span><br><span class="line">    convert_to_hashtable();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 步骤2: 在尾部插入</span></span><br><span class="line"><span class="comment">// 需要 realloc 扩展内存</span></span><br><span class="line">new_size = zlbytes + <span class="number">6</span> + <span class="number">4</span>;  <span class="comment">// field(6B) + value(4B)</span></span><br><span class="line">ziplist = <span class="built_in">realloc</span>(ziplist, new_size);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 步骤3: 写入 &quot;stock&quot; (field)</span></span><br><span class="line">write_entry(<span class="string">&quot;stock&quot;</span>, <span class="number">5</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 步骤4: 写入 100 (value, 整数编码)</span></span><br><span class="line">write_int_entry(<span class="number">100</span>, INT16);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 步骤5: 更新 zlbytes, zltail, zllen</span></span><br></pre></td></tr></table></figure>

<p><strong>潜在问题</strong>：可能触发<strong>连锁更新</strong>（如果新节点大小导致后续节点 prevlen 从 1B 扩展到 5B）</p>
<hr>
<h2 id="6-为什么-Redis-选择-ziplist？"><a href="#6-为什么-Redis-选择-ziplist？" class="headerlink" title="6. 为什么 Redis 选择 ziplist？"></a>6. 为什么 Redis 选择 ziplist？</h2><h3 id="✅-优势场景（小对象）"><a href="#✅-优势场景（小对象）" class="headerlink" title="✅ 优势场景（小对象）"></a>✅ 优势场景（小对象）</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">数据量小: &lt; 512 个字段</span><br><span class="line">数据值小: &lt; 64 字节</span><br><span class="line">访问模式: HGETALL 居多（全量读取）</span><br><span class="line">内存敏感: 对内存占用极度敏感</span><br><span class="line"></span><br><span class="line">典型应用:</span><br><span class="line">- Session 存储（uid, username, login_time, role）</span><br><span class="line">- 商品基础信息（name, price, stock, brand）</span><br><span class="line">- 用户画像标签（少量标签）</span><br></pre></td></tr></table></figure>

<h3 id="❌-不适合场景"><a href="#❌-不适合场景" class="headerlink" title="❌ 不适合场景"></a>❌ 不适合场景</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">数据量大: &gt; 512 个字段 → 查找慢</span><br><span class="line">频繁随机访问: HGET 单个字段 → 每次 O(n)</span><br><span class="line">频繁插入删除: realloc 开销 + 连锁更新风险</span><br><span class="line">大 value: &gt; 64B → 内存重分配开销大</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="7-实战建议"><a href="#7-实战建议" class="headerlink" title="7. 实战建议"></a>7. 实战建议</h2><h3 id="监控当前编码"><a href="#监控当前编码" class="headerlink" title="监控当前编码"></a>监控当前编码</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看编码类型</span></span><br><span class="line">redis&gt; HSET product:1001 name <span class="string">&quot;iPhone&quot;</span> price 5999</span><br><span class="line">redis&gt; OBJECT ENCODING product:1001</span><br><span class="line"><span class="string">&quot;ziplist&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加更多字段后</span></span><br><span class="line">redis&gt; HSET product:1001 description <span class="string">&quot;这是一个很长的描述...&quot;</span> (&gt;64字节)</span><br><span class="line">redis&gt; OBJECT ENCODING product:1001</span><br><span class="line"><span class="string">&quot;hashtable&quot;</span>  <span class="comment"># 已转换！</span></span><br></pre></td></tr></table></figure>

<h3 id="优化建议"><a href="#优化建议" class="headerlink" title="优化建议"></a>优化建议</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ✅ 推荐：小对象用 Hash</span></span><br><span class="line">rdb.HSet(ctx, <span class="string">&quot;session:123&quot;</span>, <span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;&#123;</span><br><span class="line">    <span class="string">&quot;uid&quot;</span>:   <span class="string">&quot;88888&quot;</span>,</span><br><span class="line">    <span class="string">&quot;name&quot;</span>:  <span class="string">&quot;alice&quot;</span>,</span><br><span class="line">    <span class="string">&quot;role&quot;</span>:  <span class="string">&quot;buyer&quot;</span>,</span><br><span class="line">    <span class="string">&quot;login&quot;</span>: time.Now().Unix(),</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// ❌ 避免：大字段或大量字段</span></span><br><span class="line">rdb.HSet(ctx, <span class="string">&quot;user:123&quot;</span>, <span class="string">&quot;profile&quot;</span>, longJSON)  <span class="comment">// 可能 &gt; 64B</span></span><br><span class="line">rdb.HSet(ctx, <span class="string">&quot;config&quot;</span>, key1, val1, ..., key1000, val1000)  <span class="comment">// &gt; 512 字段</span></span><br></pre></td></tr></table></figure>

<h3 id="调优参数"><a href="#调优参数" class="headerlink" title="调优参数"></a>调优参数</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># redis.conf</span><br><span class="line">hash-max-ziplist-entries 512   # 最大字段数</span><br><span class="line">hash-max-ziplist-value 64       # 最大值长度</span><br><span class="line"></span><br><span class="line"># 根据业务调整</span><br><span class="line">hash-max-ziplist-entries 256   # 更快转换为 hashtable</span><br><span class="line">hash-max-ziplist-value 128     # 允许更大的值</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="8-总结"><a href="#8-总结" class="headerlink" title="8. 总结"></a>8. 总结</h2><h3 id="关键数字"><a href="#关键数字" class="headerlink" title="关键数字"></a>关键数字</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">总内存: 36 字节</span><br><span class="line">头部: 10 字节 (27.8%)</span><br><span class="line">数据: 25 字节 (69.4%)</span><br><span class="line">尾部: 1 字节 (2.8%)</span><br><span class="line"></span><br><span class="line">对比 hashtable: 节省 78% 内存！</span><br></pre></td></tr></table></figure>

<h3 id="核心设计思想"><a href="#核心设计思想" class="headerlink" title="核心设计思想"></a>核心设计思想</h3><ol>
<li><strong>紧凑存储</strong>：无指针，连续内存</li>
<li><strong>变长编码</strong>：小数据用小空间</li>
<li><strong>整数优化</strong>：5999 用 2 字节，不是 4 字节字符串</li>
<li><strong>双向遍历</strong>：prevlen + zltail 设计</li>
<li><strong>CPU 友好</strong>：连续内存利于缓存</li>
</ol>
<p>这就是 Redis 在小对象场景下的极致优化！🚀</p>
